<!DOCTYPE html><html class="default" lang="en" data-base=".."><head><meta charset="utf-8"/><meta http-equiv="x-ua-compatible" content="IE=edge"/><title>design/42_connection_services | backtest-kit</title><meta name="description" content="Documentation for backtest-kit"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="stylesheet" href="../assets/style.css"/><link rel="stylesheet" href="../assets/highlight.css"/><script defer src="../assets/main.js"></script><script async src="../assets/icons.js" id="tsd-icons-script"></script><script async src="../assets/search.js" id="tsd-search-script"></script><script async src="../assets/navigation.js" id="tsd-nav-script"></script><script async src="../assets/hierarchy.js" id="tsd-hierarchy-script"></script></head><body><script>document.documentElement.dataset.theme = localStorage.getItem("tsd-theme") || "os";document.body.style.display="none";setTimeout(() => app?app.showPage():document.body.style.removeProperty("display"),500)</script><header class="tsd-page-toolbar"><div class="tsd-toolbar-contents container"><div class="table-cell" id="tsd-search"><div class="field"><label for="tsd-search-field" class="tsd-widget tsd-toolbar-icon search no-caption"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-search"></use></svg></label><input type="text" id="tsd-search-field" aria-label="Search"/></div><div class="field"><div id="tsd-toolbar-links"></div></div><ul class="results"><li class="state loading">Preparing search index...</li><li class="state failure">The search index is not available</li></ul><a href="../index.html" class="title">backtest-kit</a></div><div class="table-cell" id="tsd-widgets"><a href="#" class="tsd-widget tsd-toolbar-icon menu no-caption" data-toggle="menu" aria-label="Menu"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-menu"></use></svg></a></div></div></header><div class="container container-main"><div class="col-content"><div class="tsd-page-title"><ul class="tsd-breadcrumb"><li><a href="../modules.html">backtest-kit</a></li><li><a href="design_42_connection_services.html">design/42_connection_services</a></li></ul></div><div class="tsd-panel tsd-typography"><a id="connection-services" class="tsd-anchor"></a><h1 class="tsd-anchor-link">Connection Services<a href="#connection-services" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h1><p>Connection Services form the factory layer in backtest-kit's service architecture. They create, cache, and manage client implementation instances, routing operations from global services to the appropriate client based on execution context. This layer uses memoization to ensure singleton behavior per unique identifier combination (e.g., <code>symbol:strategyName:backtest</code>), preventing duplicate instantiation and maintaining consistent state across the system.</p>
<p>For information about the client implementations that connection services instantiate, see <a href="design_32_client_implementations.html">Client Implementations</a>. For the global services that delegate to connection services, see <a href="design_45_global_services.html">Global Services</a>.</p>
<a id="architecture-overview" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Architecture Overview<a href="#architecture-overview" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>Connection services sit between the global service layer and client implementations, acting as intelligent routers and instance factories. They inject dependencies into clients and ensure proper initialization before operation execution.</p>
<p><img src="../media/42_Connection_Services_0.svg" alt="Mermaid Diagram"></p>
<ul>
<li><a href="">src/lib/services/connection/StrategyConnectionService.ts:1-325</a></li>
<li><a href="">src/lib/services/connection/PartialConnectionService.ts:1-267</a></li>
</ul>
<a id="factory-pattern-implementation" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Factory Pattern Implementation<a href="#factory-pattern-implementation" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>Connection services implement the factory pattern using <code>memoize()</code> from <code>functools-kit</code>. The factory function is wrapped with memoization, ensuring that repeated calls with the same parameters return the cached instance rather than creating duplicates.</p>
<a id="memoization-function-structure" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Memoization Function Structure<a href="#memoization-function-structure" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Each connection service defines a private <code>get*</code> method that serves as the memoized factory:</p>
<pre><code class="typescript"><span class="hl-4">private</span><span class="hl-1"> </span><span class="hl-4">getStrategy</span><span class="hl-1"> = </span><span class="hl-4">memoize</span><span class="hl-1">&lt;</span><br/><span class="hl-1">  (</span><span class="hl-4">symbol</span><span class="hl-1">: </span><span class="hl-11">string</span><span class="hl-1">, </span><span class="hl-4">strategyName</span><span class="hl-1">: </span><span class="hl-11">StrategyName</span><span class="hl-1">, </span><span class="hl-4">backtest</span><span class="hl-1">: </span><span class="hl-11">boolean</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> </span><span class="hl-4">ClientStrategy</span><br/><span class="hl-1">&gt;(</span><br/><span class="hl-1">  </span><span class="hl-5">// Key generator: converts arguments to unique string</span><br/><span class="hl-1">  ([</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">strategyName</span><span class="hl-1">, </span><span class="hl-4">backtest</span><span class="hl-1">]) </span><span class="hl-7">=&gt;</span><span class="hl-1"> </span><span class="hl-2">`</span><span class="hl-7">${</span><span class="hl-4">symbol</span><span class="hl-7">}</span><span class="hl-2">:</span><span class="hl-7">${</span><span class="hl-4">strategyName</span><span class="hl-7">}</span><span class="hl-2">:</span><span class="hl-7">${</span><span class="hl-4">backtest</span><span class="hl-9"> </span><span class="hl-1">?</span><span class="hl-9"> </span><span class="hl-2">&quot;backtest&quot;</span><span class="hl-9"> </span><span class="hl-1">:</span><span class="hl-9"> </span><span class="hl-2">&quot;live&quot;</span><span class="hl-7">}</span><span class="hl-2">`</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><br/><span class="hl-1">  </span><span class="hl-5">// Factory function: creates new instance</span><br/><span class="hl-1">  (</span><span class="hl-4">symbol</span><span class="hl-1">: </span><span class="hl-11">string</span><span class="hl-1">, </span><span class="hl-4">strategyName</span><span class="hl-1">: </span><span class="hl-11">StrategyName</span><span class="hl-1">, </span><span class="hl-4">backtest</span><span class="hl-1">: </span><span class="hl-11">boolean</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-5">// Read schema configuration</span><br/><span class="hl-1">    </span><span class="hl-7">const</span><span class="hl-1"> { </span><span class="hl-8">getSignal</span><span class="hl-1">, </span><span class="hl-8">interval</span><span class="hl-1">, </span><span class="hl-8">callbacks</span><span class="hl-1">, </span><span class="hl-8">riskName</span><span class="hl-1">, </span><span class="hl-8">riskList</span><span class="hl-1"> } = </span><br/><span class="hl-1">      </span><span class="hl-7">this</span><span class="hl-1">.</span><span class="hl-4">strategySchemaService</span><span class="hl-1">.</span><span class="hl-0">get</span><span class="hl-1">(</span><span class="hl-4">strategyName</span><span class="hl-1">);</span><br/><span class="hl-1">    </span><br/><span class="hl-1">    </span><span class="hl-5">// Create client instance with dependencies</span><br/><span class="hl-1">    </span><span class="hl-3">return</span><span class="hl-1"> </span><span class="hl-7">new</span><span class="hl-1"> </span><span class="hl-0">ClientStrategy</span><span class="hl-1">({</span><br/><span class="hl-1">      </span><span class="hl-4">symbol</span><span class="hl-1">,</span><br/><span class="hl-1">      </span><span class="hl-4">interval</span><span class="hl-1">,</span><br/><span class="hl-1">      </span><span class="hl-4">strategyName</span><span class="hl-1">,</span><br/><span class="hl-1">      </span><span class="hl-4">getSignal</span><span class="hl-1">,</span><br/><span class="hl-1">      </span><span class="hl-4">callbacks</span><span class="hl-1">,</span><br/><span class="hl-1">      </span><span class="hl-4">execution:</span><span class="hl-1"> </span><span class="hl-7">this</span><span class="hl-1">.</span><span class="hl-4">executionContextService</span><span class="hl-1">,</span><br/><span class="hl-1">      </span><span class="hl-4">method:</span><span class="hl-1"> </span><span class="hl-7">this</span><span class="hl-1">.</span><span class="hl-4">methodContextService</span><span class="hl-1">,</span><br/><span class="hl-1">      </span><span class="hl-4">logger:</span><span class="hl-1"> </span><span class="hl-7">this</span><span class="hl-1">.</span><span class="hl-4">loggerService</span><span class="hl-1">,</span><br/><span class="hl-1">      </span><span class="hl-4">exchange:</span><span class="hl-1"> </span><span class="hl-7">this</span><span class="hl-1">.</span><span class="hl-4">exchangeConnectionService</span><span class="hl-1">,</span><br/><span class="hl-1">      </span><span class="hl-4">risk:</span><span class="hl-1"> </span><span class="hl-0">GET_RISK_FN</span><span class="hl-1">({</span><span class="hl-4">riskName</span><span class="hl-1">, </span><span class="hl-4">riskList</span><span class="hl-1">}, </span><span class="hl-4">backtest</span><span class="hl-1">, </span><span class="hl-7">this</span><span class="hl-1">),</span><br/><span class="hl-1">      </span><span class="hl-4">partial:</span><span class="hl-1"> </span><span class="hl-7">this</span><span class="hl-1">.</span><span class="hl-4">partialConnectionService</span><span class="hl-1">,</span><br/><span class="hl-1">    });</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">);</span>
</code><button type="button">Copy</button></pre>

<p><strong>Key Components</strong>:</p>
<ol>
<li><strong>Key Generator</strong>: First parameter defines how to create unique cache keys from function arguments</li>
<li><strong>Factory Function</strong>: Second parameter defines how to construct instances when cache miss occurs</li>
<li><strong>Return Type</strong>: Generic type parameter specifies function signature for type safety</li>
</ol>
<a id="memoization-keys-by-service" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Memoization Keys by Service<a href="#memoization-keys-by-service" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Different connection services use different key formats based on their isolation requirements:</p>
<table>
<thead>
<tr>
<th>Service</th>
<th>Key Format</th>
<th>Rationale</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>StrategyConnectionService</code></td>
<td><code>symbol:strategyName:backtest</code></td>
<td>Strategies are isolated per symbol, name, and execution mode</td>
</tr>
<tr>
<td><code>PartialConnectionService</code></td>
<td><code>signalId:backtest</code></td>
<td>Partial tracking is per signal ID, separate for backtest/live</td>
</tr>
<tr>
<td><code>RiskConnectionService</code></td>
<td><code>riskName:backtest</code></td>
<td>Risk profiles are shared across symbols but separate for backtest/live</td>
</tr>
<tr>
<td><code>ExchangeConnectionService</code></td>
<td><code>exchangeName:backtest</code></td>
<td>Exchanges are shared across symbols but have different behavior in backtest</td>
</tr>
</tbody>
</table>
<p>The <code>backtest</code> flag in keys ensures that live trading and backtesting never share the same client instances, preventing state contamination between execution modes.</p>
<ul>
<li><a href="">src/lib/services/connection/StrategyConnectionService.ts:123-156</a></li>
<li><a href="">src/lib/services/connection/PartialConnectionService.ts:132-143</a></li>
</ul>
<a id="instance-lifecycle-management" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Instance Lifecycle Management<a href="#instance-lifecycle-management" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>Client instances follow a consistent lifecycle managed by their connection service:</p>
<p><img src="../media/42_Connection_Services_1.svg" alt="Mermaid Diagram"></p>
<a id="initialization-pattern" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Initialization Pattern<a href="#initialization-pattern" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>All client instances use the <code>singleshot</code> pattern from <code>functools-kit</code> to ensure initialization happens exactly once:</p>
<pre><code class="typescript"><span class="hl-4">public</span><span class="hl-1"> </span><span class="hl-4">waitForInit</span><span class="hl-1"> = </span><span class="hl-0">singleshot</span><span class="hl-1">(</span><br/><span class="hl-1">  </span><span class="hl-7">async</span><span class="hl-1"> (</span><span class="hl-4">symbol</span><span class="hl-1">: </span><span class="hl-11">string</span><span class="hl-1">, </span><span class="hl-4">strategyName</span><span class="hl-1">: </span><span class="hl-11">string</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-0">WAIT_FOR_INIT_FN</span><span class="hl-1">(</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">strategyName</span><span class="hl-1">, </span><span class="hl-7">this</span><span class="hl-1">)</span><br/><span class="hl-1">);</span>
</code><button type="button">Copy</button></pre>

<p>Connection services call <code>waitForInit()</code> before delegating operations:</p>
<pre><code class="typescript"><span class="hl-4">public</span><span class="hl-1"> </span><span class="hl-4">async</span><span class="hl-1"> </span><span class="hl-0">profit</span><span class="hl-1">(</span><span class="hl-4">symbol</span><span class="hl-1">: </span><span class="hl-4">string</span><span class="hl-1">, </span><span class="hl-4">data</span><span class="hl-1">: </span><span class="hl-4">ISignalRow</span><span class="hl-1">, ...) {</span><br/><span class="hl-1">  </span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">partial</span><span class="hl-1"> = </span><span class="hl-7">this</span><span class="hl-1">.</span><span class="hl-0">getPartial</span><span class="hl-1">(</span><span class="hl-4">data</span><span class="hl-1">.</span><span class="hl-4">id</span><span class="hl-1">, </span><span class="hl-4">backtest</span><span class="hl-1">);</span><br/><span class="hl-1">  </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-4">partial</span><span class="hl-1">.</span><span class="hl-0">waitForInit</span><span class="hl-1">(</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">data</span><span class="hl-1">.</span><span class="hl-4">strategyName</span><span class="hl-1">);  </span><span class="hl-5">// Ensure initialization</span><br/><span class="hl-1">  </span><span class="hl-3">return</span><span class="hl-1"> </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-4">partial</span><span class="hl-1">.</span><span class="hl-0">profit</span><span class="hl-1">(</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">data</span><span class="hl-1">, ...);        </span><span class="hl-5">// Delegate operation</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<p>This pattern guarantees:</p>
<ul>
<li>
<p>Initialization code runs exactly once per instance</p>
</li>
<li>
<p>Concurrent calls wait for the same initialization promise</p>
</li>
<li>
<p>Operations never execute on uninitialized instances</p>
</li>
<li>
<p><a href="">src/lib/services/connection/PartialConnectionService.ts:159-185</a></p>
</li>
<li>
<p><a href="">src/client/ClientPartial.ts:330-332</a></p>
</li>
</ul>
<a id="cache-clearing" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Cache Clearing<a href="#cache-clearing" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Connection services expose <code>clear()</code> methods to remove memoized instances from cache:</p>
<pre><code class="typescript"><span class="hl-4">public</span><span class="hl-1"> </span><span class="hl-0">clear</span><span class="hl-1"> = </span><span class="hl-7">async</span><span class="hl-1"> (</span><span class="hl-4">backtest</span><span class="hl-1">: </span><span class="hl-11">boolean</span><span class="hl-1">, </span><span class="hl-4">ctx</span><span class="hl-1">?: { </span><span class="hl-4">symbol</span><span class="hl-1">: </span><span class="hl-11">string</span><span class="hl-1">; </span><span class="hl-4">strategyName</span><span class="hl-1">: </span><span class="hl-11">StrategyName</span><span class="hl-1"> }) </span><span class="hl-7">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-4">ctx</span><span class="hl-1">) {</span><br/><span class="hl-1">    </span><span class="hl-5">// Clear specific instance</span><br/><span class="hl-1">    </span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">key</span><span class="hl-1"> = </span><span class="hl-2">`</span><span class="hl-7">${</span><span class="hl-4">ctx</span><span class="hl-9">.</span><span class="hl-4">symbol</span><span class="hl-7">}</span><span class="hl-2">:</span><span class="hl-7">${</span><span class="hl-4">ctx</span><span class="hl-9">.</span><span class="hl-4">strategyName</span><span class="hl-7">}</span><span class="hl-2">:</span><span class="hl-7">${</span><span class="hl-4">backtest</span><span class="hl-9"> </span><span class="hl-1">?</span><span class="hl-9"> </span><span class="hl-2">&quot;backtest&quot;</span><span class="hl-9"> </span><span class="hl-1">:</span><span class="hl-9"> </span><span class="hl-2">&quot;live&quot;</span><span class="hl-7">}</span><span class="hl-2">`</span><span class="hl-1">;</span><br/><span class="hl-1">    </span><span class="hl-7">this</span><span class="hl-1">.</span><span class="hl-4">getStrategy</span><span class="hl-1">.</span><span class="hl-0">clear</span><span class="hl-1">(</span><span class="hl-4">key</span><span class="hl-1">);</span><br/><span class="hl-1">  } </span><span class="hl-3">else</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-5">// Clear all instances</span><br/><span class="hl-1">    </span><span class="hl-7">this</span><span class="hl-1">.</span><span class="hl-4">getStrategy</span><span class="hl-1">.</span><span class="hl-0">clear</span><span class="hl-1">();</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">};</span>
</code><button type="button">Copy</button></pre>

<p>Cache clearing is essential for:</p>
<ul>
<li><strong>Resource cleanup</strong>: Releasing memory after backtest completes</li>
<li><strong>State reset</strong>: Ensuring fresh instances for new execution runs</li>
<li><strong>Testing</strong>: Isolating test cases from each other</li>
</ul>
<a id="strategyconnectionservice" class="tsd-anchor"></a><h2 class="tsd-anchor-link">StrategyConnectionService<a href="#strategyconnectionservice" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p><code>StrategyConnectionService</code> manages the lifecycle of <code>ClientStrategy</code> instances, which implement the signal state machine. This is the most complex connection service due to the interdependencies between strategies, exchanges, risks, and partial tracking.</p>
<a id="dependency-injection" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Dependency Injection<a href="#dependency-injection" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>The service injects multiple dependencies into each <code>ClientStrategy</code>:</p>
<p><img src="../media/42_Connection_Services_2.svg" alt="Mermaid Diagram"></p>
<p><strong>Injected Dependencies</strong>:</p>
<ul>
<li><code>execution</code>: <code>ExecutionContextService</code> for temporal isolation (symbol, timestamp, backtest flag)</li>
<li><code>method</code>: <code>MethodContextService</code> for schema selection (strategyName, exchangeName, frameName)</li>
<li><code>logger</code>: <code>LoggerService</code> for logging operations</li>
<li><code>exchange</code>: <code>ExchangeConnectionService</code> for market data (VWAP pricing, candles)</li>
<li><code>risk</code>: <code>IRisk</code> instance (single or merged) for portfolio validation</li>
<li><code>partial</code>: <code>PartialConnectionService</code> for profit/loss milestone tracking</li>
</ul>
<a id="risk-merging-logic" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Risk Merging Logic<a href="#risk-merging-logic" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Strategies can specify risk management in three ways:</p>
<ol>
<li>Single <code>riskName</code>: One risk profile</li>
<li>Array <code>riskList</code>: Multiple risk profiles</li>
<li>Both <code>riskName</code> and <code>riskList</code>: Primary risk + additional profiles</li>
</ol>
<p>The connection service uses <code>GET_RISK_FN</code> to handle all three cases:</p>
<pre><code class="typescript"><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-0">GET_RISK_FN</span><span class="hl-1"> = (</span><span class="hl-4">dto</span><span class="hl-1">: { </span><span class="hl-4">riskName</span><span class="hl-1">: </span><span class="hl-11">RiskName</span><span class="hl-1">; </span><span class="hl-4">riskList</span><span class="hl-1">: </span><span class="hl-11">RiskName</span><span class="hl-1">[] }, </span><span class="hl-4">backtest</span><span class="hl-1">: </span><span class="hl-11">boolean</span><span class="hl-1">, </span><span class="hl-4">self</span><span class="hl-1">: </span><span class="hl-11">StrategyConnectionService</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">hasRiskName</span><span class="hl-1"> = !!</span><span class="hl-4">dto</span><span class="hl-1">.</span><span class="hl-4">riskName</span><span class="hl-1">;</span><br/><span class="hl-1">  </span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">hasRiskList</span><span class="hl-1"> = !!</span><span class="hl-4">dto</span><span class="hl-1">.</span><span class="hl-4">riskList</span><span class="hl-1">?.</span><span class="hl-4">length</span><span class="hl-1">;</span><br/><span class="hl-1">  </span><br/><span class="hl-1">  </span><span class="hl-5">// No risk management</span><br/><span class="hl-1">  </span><span class="hl-3">if</span><span class="hl-1"> (!</span><span class="hl-4">hasRiskName</span><span class="hl-1"> &amp;&amp; !</span><span class="hl-4">hasRiskList</span><span class="hl-1">) {</span><br/><span class="hl-1">    </span><span class="hl-3">return</span><span class="hl-1"> </span><span class="hl-8">NOOP_RISK</span><span class="hl-1">;</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">  </span><br/><span class="hl-1">  </span><span class="hl-5">// Single risk</span><br/><span class="hl-1">  </span><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-4">hasRiskName</span><span class="hl-1"> &amp;&amp; !</span><span class="hl-4">hasRiskList</span><span class="hl-1">) {</span><br/><span class="hl-1">    </span><span class="hl-3">return</span><span class="hl-1"> </span><span class="hl-4">self</span><span class="hl-1">.</span><span class="hl-4">riskConnectionService</span><span class="hl-1">.</span><span class="hl-0">getRisk</span><span class="hl-1">(</span><span class="hl-4">dto</span><span class="hl-1">.</span><span class="hl-4">riskName</span><span class="hl-1">, </span><span class="hl-4">backtest</span><span class="hl-1">);</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">  </span><br/><span class="hl-1">  </span><span class="hl-5">// Multiple risks only</span><br/><span class="hl-1">  </span><span class="hl-3">if</span><span class="hl-1"> (!</span><span class="hl-4">hasRiskName</span><span class="hl-1"> &amp;&amp; </span><span class="hl-4">hasRiskList</span><span class="hl-1">) {</span><br/><span class="hl-1">    </span><span class="hl-3">return</span><span class="hl-1"> </span><span class="hl-7">new</span><span class="hl-1"> </span><span class="hl-0">MergeRisk</span><span class="hl-1">(</span><span class="hl-4">dto</span><span class="hl-1">.</span><span class="hl-4">riskList</span><span class="hl-1">.</span><span class="hl-0">map</span><span class="hl-1">(</span><span class="hl-4">riskName</span><span class="hl-1"> </span><span class="hl-7">=&gt;</span><span class="hl-1"> </span><br/><span class="hl-1">      </span><span class="hl-4">self</span><span class="hl-1">.</span><span class="hl-4">riskConnectionService</span><span class="hl-1">.</span><span class="hl-0">getRisk</span><span class="hl-1">(</span><span class="hl-4">riskName</span><span class="hl-1">, </span><span class="hl-4">backtest</span><span class="hl-1">)</span><br/><span class="hl-1">    ));</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">  </span><br/><span class="hl-1">  </span><span class="hl-5">// Both: merge with riskName first</span><br/><span class="hl-1">  </span><span class="hl-3">return</span><span class="hl-1"> </span><span class="hl-7">new</span><span class="hl-1"> </span><span class="hl-0">MergeRisk</span><span class="hl-1">([</span><br/><span class="hl-1">    </span><span class="hl-4">self</span><span class="hl-1">.</span><span class="hl-4">riskConnectionService</span><span class="hl-1">.</span><span class="hl-0">getRisk</span><span class="hl-1">(</span><span class="hl-4">dto</span><span class="hl-1">.</span><span class="hl-4">riskName</span><span class="hl-1">, </span><span class="hl-4">backtest</span><span class="hl-1">),</span><br/><span class="hl-1">    ...</span><span class="hl-4">dto</span><span class="hl-1">.</span><span class="hl-4">riskList</span><span class="hl-1">.</span><span class="hl-0">map</span><span class="hl-1">(</span><span class="hl-4">riskName</span><span class="hl-1"> </span><span class="hl-7">=&gt;</span><span class="hl-1"> </span><span class="hl-4">self</span><span class="hl-1">.</span><span class="hl-4">riskConnectionService</span><span class="hl-1">.</span><span class="hl-0">getRisk</span><span class="hl-1">(</span><span class="hl-4">riskName</span><span class="hl-1">, </span><span class="hl-4">backtest</span><span class="hl-1">))</span><br/><span class="hl-1">  ]);</span><br/><span class="hl-1">};</span>
</code><button type="button">Copy</button></pre>

<p><code>MergeRisk</code> is a composite risk implementation that validates signals against all child risks sequentially, rejecting if any risk rejects.</p>
<a id="operation-delegation" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Operation Delegation<a href="#operation-delegation" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>The connection service routes strategy operations through a consistent pattern:</p>
<ol>
<li><strong>Retrieve or create instance</strong>: <code>this.getStrategy(symbol, strategyName, backtest)</code></li>
<li><strong>Ensure initialization</strong>: <code>await strategy.waitForInit()</code></li>
<li><strong>Delegate operation</strong>: <code>await strategy.tick(...)</code> or <code>await strategy.backtest(...)</code></li>
<li><strong>Emit events</strong>: Broadcast result to event emitters</li>
</ol>
<pre><code class="typescript"><span class="hl-4">public</span><span class="hl-1"> </span><span class="hl-4">async</span><span class="hl-1"> </span><span class="hl-0">tick</span><span class="hl-1">(</span><span class="hl-4">symbol</span><span class="hl-1">: </span><span class="hl-4">string</span><span class="hl-1">, </span><span class="hl-4">strategyName</span><span class="hl-1">: </span><span class="hl-4">StrategyName</span><span class="hl-1">): </span><span class="hl-11">Promise</span><span class="hl-1">&lt;</span><span class="hl-4">IStrategyTickResult</span><span class="hl-1">&gt; {</span><br/><span class="hl-1">  const </span><span class="hl-4">backtest</span><span class="hl-1"> = </span><span class="hl-7">this</span><span class="hl-1">.</span><span class="hl-4">executionContextService</span><span class="hl-1">.</span><span class="hl-4">context</span><span class="hl-1">.</span><span class="hl-4">backtest</span><span class="hl-1">;</span><br/><span class="hl-1">  const </span><span class="hl-4">strategy</span><span class="hl-1"> = </span><span class="hl-7">this</span><span class="hl-1">.</span><span class="hl-0">getStrategy</span><span class="hl-1">(</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">strategyName</span><span class="hl-1">, </span><span class="hl-4">backtest</span><span class="hl-1">);</span><br/><span class="hl-1">  await strategy.waitForInit();</span><br/><span class="hl-1">  const </span><span class="hl-4">tick</span><span class="hl-1"> = </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-4">strategy</span><span class="hl-1">.</span><span class="hl-0">tick</span><span class="hl-1">(</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">strategyName</span><span class="hl-1">);</span><br/><span class="hl-1">  </span><br/><span class="hl-1">  </span><span class="hl-5">// Emit to appropriate event streams</span><br/><span class="hl-1">  </span><span class="hl-0">if</span><span class="hl-1"> (this.executionContextService.context.backtest) {</span><br/><span class="hl-1">    </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-4">signalBacktestEmitter</span><span class="hl-1">.</span><span class="hl-0">next</span><span class="hl-1">(</span><span class="hl-4">tick</span><span class="hl-1">);</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">  </span><span class="hl-0">if</span><span class="hl-1"> (!this.executionContextService.context.backtest) {</span><br/><span class="hl-1">    </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-4">signalLiveEmitter</span><span class="hl-1">.</span><span class="hl-0">next</span><span class="hl-1">(</span><span class="hl-4">tick</span><span class="hl-1">);</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">  await signalEmitter.next(tick);</span><br/><span class="hl-1">  </span><br/><span class="hl-1">  return tick;</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<a id="utility-methods" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Utility Methods<a href="#utility-methods" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Beyond operation delegation, the service provides utility methods for monitoring and control:</p>
<table>
<thead>
<tr>
<th>Method</th>
<th>Purpose</th>
<th>Returns</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>getPendingSignal()</code></td>
<td>Retrieve currently active signal</td>
<td><code>ISignalRow | null</code></td>
</tr>
<tr>
<td><code>getStopped()</code></td>
<td>Check if strategy has been stopped</td>
<td><code>boolean</code></td>
</tr>
<tr>
<td><code>stop()</code></td>
<td>Set stop flag to prevent new signals</td>
<td><code>void</code></td>
</tr>
<tr>
<td><code>clear()</code></td>
<td>Remove memoized instance from cache</td>
<td><code>void</code></td>
</tr>
</tbody>
</table>
<p>These methods are used by:</p>
<ul>
<li><strong>BacktestUtils/LiveUtils</strong>: For graceful shutdown and status checking</li>
<li><strong>WalkerUtils</strong>: To stop strategies during walker interruption</li>
<li><strong>Testing utilities</strong>: To reset state between test cases</li>
</ul>
<a id="partialconnectionservice" class="tsd-anchor"></a><h2 class="tsd-anchor-link">PartialConnectionService<a href="#partialconnectionservice" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p><code>PartialConnectionService</code> manages <code>ClientPartial</code> instances for tracking profit/loss level milestones (10%, 20%, 30%, etc.). Unlike strategy connections which are keyed by <code>symbol:strategyName</code>, partial connections are keyed by individual <code>signalId</code>.</p>
<a id="per-signal-instance-creation" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Per-Signal Instance Creation<a href="#per-signal-instance-creation" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Each signal gets its own <code>ClientPartial</code> instance to track its profit/loss milestones:</p>
<p><img src="../media/42_Connection_Services_3.svg" alt="Mermaid Diagram"></p>
<p>The per-signal isolation ensures that:</p>
<ul>
<li>Profit/loss levels are tracked independently for each position</li>
<li>Closing one signal doesn't affect others' milestone tracking</li>
<li>State is properly cleaned up when signals complete</li>
</ul>
<a id="event-emission-callbacks" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Event Emission Callbacks<a href="#event-emission-callbacks" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>The connection service provides callback functions that emit events to RxJS subjects:</p>
<pre><code class="typescript"><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-0">COMMIT_PROFIT_FN</span><span class="hl-1"> = </span><span class="hl-7">async</span><span class="hl-1"> (</span><br/><span class="hl-1">  </span><span class="hl-4">symbol</span><span class="hl-1">: </span><span class="hl-11">string</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">strategyName</span><span class="hl-1">: </span><span class="hl-11">string</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">exchangeName</span><span class="hl-1">: </span><span class="hl-11">string</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">data</span><span class="hl-1">: </span><span class="hl-11">ISignalRow</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">currentPrice</span><span class="hl-1">: </span><span class="hl-11">number</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">level</span><span class="hl-1">: </span><span class="hl-11">PartialLevel</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">backtest</span><span class="hl-1">: </span><span class="hl-11">boolean</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">timestamp</span><span class="hl-1">: </span><span class="hl-11">number</span><br/><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-4">partialProfitSubject</span><span class="hl-1">.</span><span class="hl-0">next</span><span class="hl-1">({</span><br/><span class="hl-1">  </span><span class="hl-4">symbol</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">strategyName</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">exchangeName</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">data</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">currentPrice</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">level</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">backtest</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">timestamp</span><span class="hl-1">,</span><br/><span class="hl-1">});</span><br/><br/><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-0">COMMIT_LOSS_FN</span><span class="hl-1"> = </span><span class="hl-7">async</span><span class="hl-1"> (</span><span class="hl-5">/* similar parameters */</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> </span><br/><span class="hl-1">  </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-4">partialLossSubject</span><span class="hl-1">.</span><span class="hl-0">next</span><span class="hl-1">({ </span><span class="hl-5">/* loss event */</span><span class="hl-1"> });</span>
</code><button type="button">Copy</button></pre>

<p>These callbacks are injected into <code>ClientPartial</code> during construction, allowing the client to emit events without direct dependencies on the event system:</p>
<pre><code class="typescript"><span class="hl-3">return</span><span class="hl-1"> </span><span class="hl-7">new</span><span class="hl-1"> </span><span class="hl-0">ClientPartial</span><span class="hl-1">({</span><br/><span class="hl-1">  </span><span class="hl-4">signalId</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">logger:</span><span class="hl-1"> </span><span class="hl-7">this</span><span class="hl-1">.</span><span class="hl-4">loggerService</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">backtest</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">onProfit:</span><span class="hl-1"> </span><span class="hl-8">COMMIT_PROFIT_FN</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">onLoss:</span><span class="hl-1"> </span><span class="hl-8">COMMIT_LOSS_FN</span><span class="hl-1">,</span><br/><span class="hl-1">});</span>
</code><button type="button">Copy</button></pre>

<ul>
<li><a href="">src/lib/services/connection/PartialConnectionService.ts:28-83</a></li>
<li><a href="">src/lib/services/connection/PartialConnectionService.ts:132-143</a></li>
</ul>
<a id="operation-delegation-pattern" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Operation Delegation Pattern<a href="#operation-delegation-pattern" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>The connection service delegates profit/loss operations following the standard pattern:</p>
<pre><code class="typescript"><span class="hl-4">public</span><span class="hl-1"> </span><span class="hl-4">async</span><span class="hl-1"> </span><span class="hl-0">profit</span><span class="hl-1">(</span><br/><span class="hl-1">  </span><span class="hl-4">symbol</span><span class="hl-1">: </span><span class="hl-4">string</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">data</span><span class="hl-1">: </span><span class="hl-4">ISignalRow</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">currentPrice</span><span class="hl-1">: </span><span class="hl-4">number</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">revenuePercent</span><span class="hl-1">: </span><span class="hl-4">number</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">backtest</span><span class="hl-1">: </span><span class="hl-4">boolean</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">when</span><span class="hl-1">: </span><span class="hl-4">Date</span><br/><span class="hl-1">) {</span><br/><span class="hl-1">  </span><span class="hl-7">this</span><span class="hl-1">.</span><span class="hl-4">loggerService</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-2">&quot;partialConnectionService profit&quot;</span><span class="hl-1">, { </span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">data</span><span class="hl-1">, </span><span class="hl-4">currentPrice</span><span class="hl-1">, </span><span class="hl-4">revenuePercent</span><span class="hl-1">, </span><span class="hl-4">backtest</span><span class="hl-1">, </span><span class="hl-4">when</span><span class="hl-1"> });</span><br/><span class="hl-1">  </span><br/><span class="hl-1">  </span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">partial</span><span class="hl-1"> = </span><span class="hl-7">this</span><span class="hl-1">.</span><span class="hl-0">getPartial</span><span class="hl-1">(</span><span class="hl-4">data</span><span class="hl-1">.</span><span class="hl-4">id</span><span class="hl-1">, </span><span class="hl-4">backtest</span><span class="hl-1">);</span><br/><span class="hl-1">  </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-4">partial</span><span class="hl-1">.</span><span class="hl-0">waitForInit</span><span class="hl-1">(</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">data</span><span class="hl-1">.</span><span class="hl-4">strategyName</span><span class="hl-1">);</span><br/><span class="hl-1">  </span><br/><span class="hl-1">  </span><span class="hl-3">return</span><span class="hl-1"> </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-4">partial</span><span class="hl-1">.</span><span class="hl-0">profit</span><span class="hl-1">(</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">data</span><span class="hl-1">, </span><span class="hl-4">currentPrice</span><span class="hl-1">, </span><span class="hl-4">revenuePercent</span><span class="hl-1">, </span><span class="hl-4">backtest</span><span class="hl-1">, </span><span class="hl-4">when</span><span class="hl-1">);</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<p>The same pattern applies to <code>loss()</code> and <code>clear()</code> operations. This consistency makes the connection service layer predictable and easy to understand.</p>
<a id="cleanup-on-signal-close" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Cleanup on Signal Close<a href="#cleanup-on-signal-close" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>When a signal closes, the connection service clears both the client state and the memoized instance:</p>
<pre><code class="typescript"><span class="hl-4">public</span><span class="hl-1"> </span><span class="hl-4">async</span><span class="hl-1"> </span><span class="hl-0">clear</span><span class="hl-1">(</span><span class="hl-4">symbol</span><span class="hl-1">: </span><span class="hl-4">string</span><span class="hl-1">, </span><span class="hl-4">data</span><span class="hl-1">: </span><span class="hl-4">ISignalRow</span><span class="hl-1">, </span><span class="hl-4">priceClose</span><span class="hl-1">: </span><span class="hl-4">number</span><span class="hl-1">, </span><span class="hl-4">backtest</span><span class="hl-1">: </span><span class="hl-4">boolean</span><span class="hl-1">) {</span><br/><span class="hl-1">  </span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">partial</span><span class="hl-1"> = </span><span class="hl-7">this</span><span class="hl-1">.</span><span class="hl-0">getPartial</span><span class="hl-1">(</span><span class="hl-4">data</span><span class="hl-1">.</span><span class="hl-4">id</span><span class="hl-1">, </span><span class="hl-4">backtest</span><span class="hl-1">);</span><br/><span class="hl-1">  </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-4">partial</span><span class="hl-1">.</span><span class="hl-0">waitForInit</span><span class="hl-1">(</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">data</span><span class="hl-1">.</span><span class="hl-4">strategyName</span><span class="hl-1">);</span><br/><span class="hl-1">  </span><br/><span class="hl-1">  </span><span class="hl-5">// Clear client state (removes from _states Map, persists)</span><br/><span class="hl-1">  </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-4">partial</span><span class="hl-1">.</span><span class="hl-0">clear</span><span class="hl-1">(</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">data</span><span class="hl-1">, </span><span class="hl-4">priceClose</span><span class="hl-1">, </span><span class="hl-4">backtest</span><span class="hl-1">);</span><br/><span class="hl-1">  </span><br/><span class="hl-1">  </span><span class="hl-5">// Remove memoized instance to prevent memory leaks</span><br/><span class="hl-1">  </span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">key</span><span class="hl-1"> = </span><span class="hl-2">`</span><span class="hl-7">${</span><span class="hl-4">data</span><span class="hl-9">.</span><span class="hl-4">id</span><span class="hl-7">}</span><span class="hl-2">:</span><span class="hl-7">${</span><span class="hl-4">backtest</span><span class="hl-9"> </span><span class="hl-1">?</span><span class="hl-9"> </span><span class="hl-2">&quot;backtest&quot;</span><span class="hl-9"> </span><span class="hl-1">:</span><span class="hl-9"> </span><span class="hl-2">&quot;live&quot;</span><span class="hl-7">}</span><span class="hl-2">`</span><span class="hl-1">;</span><br/><span class="hl-1">  </span><span class="hl-7">this</span><span class="hl-1">.</span><span class="hl-4">getPartial</span><span class="hl-1">.</span><span class="hl-0">clear</span><span class="hl-1">(</span><span class="hl-4">key</span><span class="hl-1">);</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<p>This two-step cleanup ensures:</p>
<ol>
<li>Persisted state is updated (signal removed from disk file)</li>
<li>In-memory cache entry is released (prevents memory leaks)</li>
</ol>
<a id="integration-with-utility-classes" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Integration with Utility Classes<a href="#integration-with-utility-classes" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>Connection services are primarily accessed through utility classes (<code>Backtest</code>, <code>Live</code>, <code>Walker</code>), which provide user-facing APIs. The utility classes follow a consistent pattern:</p>
<p><img src="../media/42_Connection_Services_4.svg" alt="Mermaid Diagram"></p>
<a id="validation-before-delegation" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Validation Before Delegation<a href="#validation-before-delegation" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Utility classes validate schemas before delegating to connection services:</p>
<pre><code class="typescript"><span class="hl-4">public</span><span class="hl-1"> </span><span class="hl-0">run</span><span class="hl-1"> = (</span><span class="hl-4">symbol</span><span class="hl-1">: </span><span class="hl-11">string</span><span class="hl-1">, </span><span class="hl-4">context</span><span class="hl-1">: { </span><span class="hl-4">strategyName</span><span class="hl-1">: </span><span class="hl-11">string</span><span class="hl-1">; </span><span class="hl-4">exchangeName</span><span class="hl-1">: </span><span class="hl-11">string</span><span class="hl-1">; </span><span class="hl-4">frameName</span><span class="hl-1">: </span><span class="hl-11">string</span><span class="hl-1"> }) </span><span class="hl-7">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-5">// Validate schemas exist</span><br/><span class="hl-1">  </span><span class="hl-4">backtest</span><span class="hl-1">.</span><span class="hl-4">strategyValidationService</span><span class="hl-1">.</span><span class="hl-0">validate</span><span class="hl-1">(</span><span class="hl-4">context</span><span class="hl-1">.</span><span class="hl-4">strategyName</span><span class="hl-1">, </span><span class="hl-2">&quot;BacktestUtils.run&quot;</span><span class="hl-1">);</span><br/><span class="hl-1">  </span><span class="hl-4">backtest</span><span class="hl-1">.</span><span class="hl-4">exchangeValidationService</span><span class="hl-1">.</span><span class="hl-0">validate</span><span class="hl-1">(</span><span class="hl-4">context</span><span class="hl-1">.</span><span class="hl-4">exchangeName</span><span class="hl-1">, </span><span class="hl-2">&quot;BacktestUtils.run&quot;</span><span class="hl-1">);</span><br/><span class="hl-1">  </span><span class="hl-4">backtest</span><span class="hl-1">.</span><span class="hl-4">frameValidationService</span><span class="hl-1">.</span><span class="hl-0">validate</span><span class="hl-1">(</span><span class="hl-4">context</span><span class="hl-1">.</span><span class="hl-4">frameName</span><span class="hl-1">, </span><span class="hl-2">&quot;BacktestUtils.run&quot;</span><span class="hl-1">);</span><br/><span class="hl-1">  </span><br/><span class="hl-1">  </span><span class="hl-5">// Validate associated risks</span><br/><span class="hl-1">  </span><span class="hl-7">const</span><span class="hl-1"> { </span><span class="hl-8">riskName</span><span class="hl-1">, </span><span class="hl-8">riskList</span><span class="hl-1"> } = </span><span class="hl-4">backtest</span><span class="hl-1">.</span><span class="hl-4">strategySchemaService</span><span class="hl-1">.</span><span class="hl-0">get</span><span class="hl-1">(</span><span class="hl-4">context</span><span class="hl-1">.</span><span class="hl-4">strategyName</span><span class="hl-1">);</span><br/><span class="hl-1">  </span><span class="hl-4">riskName</span><span class="hl-1"> &amp;&amp; </span><span class="hl-4">backtest</span><span class="hl-1">.</span><span class="hl-4">riskValidationService</span><span class="hl-1">.</span><span class="hl-0">validate</span><span class="hl-1">(</span><span class="hl-4">riskName</span><span class="hl-1">, </span><span class="hl-2">&quot;BacktestUtils.run&quot;</span><span class="hl-1">);</span><br/><span class="hl-1">  </span><span class="hl-4">riskList</span><span class="hl-1"> &amp;&amp; </span><span class="hl-4">riskList</span><span class="hl-1">.</span><span class="hl-0">forEach</span><span class="hl-1">((</span><span class="hl-4">riskName</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> </span><span class="hl-4">backtest</span><span class="hl-1">.</span><span class="hl-4">riskValidationService</span><span class="hl-1">.</span><span class="hl-0">validate</span><span class="hl-1">(</span><span class="hl-4">riskName</span><span class="hl-1">, </span><span class="hl-2">&quot;BacktestUtils.run&quot;</span><span class="hl-1">));</span><br/><span class="hl-1">  </span><br/><span class="hl-1">  </span><span class="hl-5">// Get instance and delegate</span><br/><span class="hl-1">  </span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">instance</span><span class="hl-1"> = </span><span class="hl-7">this</span><span class="hl-1">.</span><span class="hl-0">_getInstance</span><span class="hl-1">(</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">context</span><span class="hl-1">.</span><span class="hl-4">strategyName</span><span class="hl-1">);</span><br/><span class="hl-1">  </span><span class="hl-3">return</span><span class="hl-1"> </span><span class="hl-4">instance</span><span class="hl-1">.</span><span class="hl-0">run</span><span class="hl-1">(</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">context</span><span class="hl-1">);</span><br/><span class="hl-1">};</span>
</code><button type="button">Copy</button></pre>

<p>This validation layer ensures that:</p>
<ul>
<li>All required schemas are registered before execution</li>
<li>Clear error messages identify missing configurations</li>
<li>Connection services receive only valid schema references</li>
</ul>
<a id="instance-isolation" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Instance Isolation<a href="#instance-isolation" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Both <code>BacktestUtils</code> and <code>LiveUtils</code> use their own memoized <code>getInstance</code> methods to create isolated instances per <code>symbol:strategyName</code> pair:</p>
<pre><code class="typescript"><span class="hl-4">private</span><span class="hl-1"> </span><span class="hl-4">_getInstance</span><span class="hl-1"> = </span><span class="hl-4">memoize</span><span class="hl-1">&lt;</span><br/><span class="hl-1">  (</span><span class="hl-4">symbol</span><span class="hl-1">: </span><span class="hl-11">string</span><span class="hl-1">, </span><span class="hl-4">strategyName</span><span class="hl-1">: </span><span class="hl-11">StrategyName</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> </span><span class="hl-4">BacktestInstance</span><br/><span class="hl-1">&gt;(</span><br/><span class="hl-1">  ([</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">strategyName</span><span class="hl-1">]) </span><span class="hl-7">=&gt;</span><span class="hl-1"> </span><span class="hl-2">`</span><span class="hl-7">${</span><span class="hl-4">symbol</span><span class="hl-7">}</span><span class="hl-2">:</span><span class="hl-7">${</span><span class="hl-4">strategyName</span><span class="hl-7">}</span><span class="hl-2">`</span><span class="hl-1">,</span><br/><span class="hl-1">  (</span><span class="hl-4">symbol</span><span class="hl-1">: </span><span class="hl-11">string</span><span class="hl-1">, </span><span class="hl-4">strategyName</span><span class="hl-1">: </span><span class="hl-11">StrategyName</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> </span><span class="hl-7">new</span><span class="hl-1"> </span><span class="hl-0">BacktestInstance</span><span class="hl-1">(</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">strategyName</span><span class="hl-1">)</span><br/><span class="hl-1">);</span>
</code><button type="button">Copy</button></pre>

<p>This creates a two-level memoization hierarchy:</p>
<ol>
<li><strong>Utility level</strong>: <code>BacktestInstance</code> or <code>LiveInstance</code> per <code>symbol:strategyName</code></li>
<li><strong>Connection level</strong>: <code>ClientStrategy</code> per <code>symbol:strategyName:backtest</code></li>
</ol>
<p>The utility instance delegates to the connection service, which delegates to the client. This separation allows utility instances to track execution state (e.g., <code>_isStopped</code>, <code>_isDone</code>) while connection services manage client instances.</p>
<ul>
<li><a href="">src/classes/Backtest.ts:364-369</a></li>
<li><a href="">src/classes/Live.ts:381-386</a></li>
</ul>
<a id="connection-service-registry" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Connection Service Registry<a href="#connection-service-registry" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>All connection services are registered in the dependency injection container with unique type symbols:</p>
<table>
<thead>
<tr>
<th>Service</th>
<th>TYPES Symbol</th>
<th>Client Type</th>
<th>Memoize Key</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>StrategyConnectionService</code></td>
<td><code>TYPES.strategyConnectionService</code></td>
<td><code>ClientStrategy</code></td>
<td><code>symbol:strategyName:backtest</code></td>
</tr>
<tr>
<td><code>ExchangeConnectionService</code></td>
<td><code>TYPES.exchangeConnectionService</code></td>
<td><code>ClientExchange</code></td>
<td><code>exchangeName:backtest</code></td>
</tr>
<tr>
<td><code>RiskConnectionService</code></td>
<td><code>TYPES.riskConnectionService</code></td>
<td><code>ClientRisk</code></td>
<td><code>riskName:backtest</code></td>
</tr>
<tr>
<td><code>PartialConnectionService</code></td>
<td><code>TYPES.partialConnectionService</code></td>
<td><code>ClientPartial</code></td>
<td><code>signalId:backtest</code></td>
</tr>
<tr>
<td><code>FrameConnectionService</code></td>
<td><code>TYPES.frameConnectionService</code></td>
<td><code>ClientFrame</code></td>
<td><code>frameName</code></td>
</tr>
<tr>
<td><code>SizingConnectionService</code></td>
<td><code>TYPES.sizingConnectionService</code></td>
<td><code>ClientSizing</code></td>
<td><code>sizingName</code></td>
</tr>
<tr>
<td><code>OptimizerConnectionService</code></td>
<td><code>TYPES.optimizerConnectionService</code></td>
<td><code>ClientOptimizer</code></td>
<td><code>optimizerName</code></td>
</tr>
</tbody>
</table>
<p>Services are injected using the <code>inject&lt;T&gt;(TYPES.*)</code> pattern:</p>
<pre><code class="typescript"><span class="hl-3">export</span><span class="hl-1"> </span><span class="hl-7">class</span><span class="hl-1"> </span><span class="hl-11">StrategyConnectionService</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-7">public</span><span class="hl-1"> </span><span class="hl-7">readonly</span><span class="hl-1"> </span><span class="hl-4">loggerService</span><span class="hl-1"> = </span><span class="hl-0">inject</span><span class="hl-1">&lt;</span><span class="hl-11">LoggerService</span><span class="hl-1">&gt;(</span><span class="hl-8">TYPES</span><span class="hl-1">.</span><span class="hl-4">loggerService</span><span class="hl-1">);</span><br/><span class="hl-1">  </span><span class="hl-7">public</span><span class="hl-1"> </span><span class="hl-7">readonly</span><span class="hl-1"> </span><span class="hl-4">exchangeConnectionService</span><span class="hl-1"> = </span><span class="hl-0">inject</span><span class="hl-1">&lt;</span><span class="hl-11">ExchangeConnectionService</span><span class="hl-1">&gt;(</span><span class="hl-8">TYPES</span><span class="hl-1">.</span><span class="hl-4">exchangeConnectionService</span><span class="hl-1">);</span><br/><span class="hl-1">  </span><span class="hl-7">public</span><span class="hl-1"> </span><span class="hl-7">readonly</span><span class="hl-1"> </span><span class="hl-4">riskConnectionService</span><span class="hl-1"> = </span><span class="hl-0">inject</span><span class="hl-1">&lt;</span><span class="hl-11">RiskConnectionService</span><span class="hl-1">&gt;(</span><span class="hl-8">TYPES</span><span class="hl-1">.</span><span class="hl-4">riskConnectionService</span><span class="hl-1">);</span><br/><span class="hl-1">  </span><span class="hl-7">public</span><span class="hl-1"> </span><span class="hl-7">readonly</span><span class="hl-1"> </span><span class="hl-4">partialConnectionService</span><span class="hl-1"> = </span><span class="hl-0">inject</span><span class="hl-1">&lt;</span><span class="hl-11">PartialConnectionService</span><span class="hl-1">&gt;(</span><span class="hl-8">TYPES</span><span class="hl-1">.</span><span class="hl-4">partialConnectionService</span><span class="hl-1">);</span><br/><span class="hl-1">  </span><span class="hl-5">// ...</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

</div></div><div class="col-sidebar"><div class="page-menu"><div class="tsd-navigation settings"><details class="tsd-accordion"><summary class="tsd-accordion-summary"><h3><svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-chevronDown"></use></svg>Settings</h3></summary><div class="tsd-accordion-details"><div class="tsd-filter-visibility"><span class="settings-label">Member Visibility</span><ul id="tsd-filter-options"><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-protected" name="protected"/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Protected</span></label></li><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-inherited" name="inherited" checked/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Inherited</span></label></li><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-external" name="external"/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>External</span></label></li></ul></div><div class="tsd-theme-toggle"><label class="settings-label" for="tsd-theme">Theme</label><select id="tsd-theme"><option value="os">OS</option><option value="light">Light</option><option value="dark">Dark</option></select></div></div></details></div><details open class="tsd-accordion tsd-page-navigation"><summary class="tsd-accordion-summary"><h3><svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-chevronDown"></use></svg>On This Page</h3></summary><div class="tsd-accordion-details"><a href="#connection-services"><span>Connection <wbr/>Services</span></a><ul><li><a href="#architecture-overview"><span>Architecture <wbr/>Overview</span></a></li><li><a href="#factory-pattern-implementation"><span>Factory <wbr/>Pattern <wbr/>Implementation</span></a></li><li><ul><li><a href="#memoization-function-structure"><span>Memoization <wbr/>Function <wbr/>Structure</span></a></li><li><a href="#memoization-keys-by-service"><span>Memoization <wbr/>Keys by <wbr/>Service</span></a></li></ul></li><li><a href="#instance-lifecycle-management"><span>Instance <wbr/>Lifecycle <wbr/>Management</span></a></li><li><ul><li><a href="#initialization-pattern"><span>Initialization <wbr/>Pattern</span></a></li><li><a href="#cache-clearing"><span>Cache <wbr/>Clearing</span></a></li></ul></li><li><a href="#strategyconnectionservice"><span>Strategy<wbr/>Connection<wbr/>Service</span></a></li><li><ul><li><a href="#dependency-injection"><span>Dependency <wbr/>Injection</span></a></li><li><a href="#risk-merging-logic"><span>Risk <wbr/>Merging <wbr/>Logic</span></a></li><li><a href="#operation-delegation"><span>Operation <wbr/>Delegation</span></a></li><li><a href="#utility-methods"><span>Utility <wbr/>Methods</span></a></li></ul></li><li><a href="#partialconnectionservice"><span>Partial<wbr/>Connection<wbr/>Service</span></a></li><li><ul><li><a href="#per-signal-instance-creation"><span>Per-<wbr/>Signal <wbr/>Instance <wbr/>Creation</span></a></li><li><a href="#event-emission-callbacks"><span>Event <wbr/>Emission <wbr/>Callbacks</span></a></li><li><a href="#operation-delegation-pattern"><span>Operation <wbr/>Delegation <wbr/>Pattern</span></a></li><li><a href="#cleanup-on-signal-close"><span>Cleanup on <wbr/>Signal <wbr/>Close</span></a></li></ul></li><li><a href="#integration-with-utility-classes"><span>Integration with <wbr/>Utility <wbr/>Classes</span></a></li><li><ul><li><a href="#validation-before-delegation"><span>Validation <wbr/>Before <wbr/>Delegation</span></a></li><li><a href="#instance-isolation"><span>Instance <wbr/>Isolation</span></a></li></ul></li><li><a href="#connection-service-registry"><span>Connection <wbr/>Service <wbr/>Registry</span></a></li></ul></div></details></div><div class="site-menu"><nav class="tsd-navigation"><a href="../modules.html">backtest-kit</a><ul class="tsd-small-nested-navigation" id="tsd-nav-container"><li>Loading...</li></ul></nav></div></div></div><footer><p class="tsd-generator">Generated using <a href="https://typedoc.org/" target="_blank">TypeDoc</a></p></footer><div class="overlay"></div></body></html>

<!-- Yandex.Metrika counter -->
<script type="text/javascript">
    (function(m,e,t,r,i,k,a){
        m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
        m[i].l=1*new Date();
        for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }}
        k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)
    })(window, document,'script','https://mc.yandex.ru/metrika/tag.js?id=105455585', 'ym');

    ym(105455585, 'init', {ssr:true, webvisor:true, clickmap:true, ecommerce:"dataLayer", accurateTrackBounce:true, trackLinks:true});
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/105455585" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
<!-- /Yandex.Metrika counter -->

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-3MQZEBBDDR"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-3MQZEBBDDR');
</script>
