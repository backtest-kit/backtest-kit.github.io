<!DOCTYPE html><html class="default" lang="en" data-base=".."><head><meta charset="utf-8"/><meta http-equiv="x-ua-compatible" content="IE=edge"/><title>design/15_clientstrategy | backtest-kit</title><meta name="description" content="Documentation for backtest-kit"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="stylesheet" href="../assets/style.css"/><link rel="stylesheet" href="../assets/highlight.css"/><script defer src="../assets/main.js"></script><script async src="../assets/icons.js" id="tsd-icons-script"></script><script async src="../assets/search.js" id="tsd-search-script"></script><script async src="../assets/navigation.js" id="tsd-nav-script"></script><script async src="../assets/hierarchy.js" id="tsd-hierarchy-script"></script></head><body><script>document.documentElement.dataset.theme = localStorage.getItem("tsd-theme") || "os";document.body.style.display="none";setTimeout(() => app?app.showPage():document.body.style.removeProperty("display"),500)</script><header class="tsd-page-toolbar"><div class="tsd-toolbar-contents container"><div class="table-cell" id="tsd-search"><div class="field"><label for="tsd-search-field" class="tsd-widget tsd-toolbar-icon search no-caption"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-search"></use></svg></label><input type="text" id="tsd-search-field" aria-label="Search"/></div><div class="field"><div id="tsd-toolbar-links"></div></div><ul class="results"><li class="state loading">Preparing search index...</li><li class="state failure">The search index is not available</li></ul><a href="../index.html" class="title">backtest-kit</a></div><div class="table-cell" id="tsd-widgets"><a href="#" class="tsd-widget tsd-toolbar-icon menu no-caption" data-toggle="menu" aria-label="Menu"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-menu"></use></svg></a></div></div></header><div class="container container-main"><div class="col-content"><div class="tsd-page-title"><ul class="tsd-breadcrumb"><li><a href="../modules.html">backtest-kit</a></li><li><a href="design_15_clientstrategy.html">design/15_clientstrategy</a></li></ul></div><div class="tsd-panel tsd-typography"><a id="clientstrategy" class="tsd-anchor"></a><h1 class="tsd-anchor-link">ClientStrategy<a href="#clientstrategy" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h1><a id="purpose-and-scope" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Purpose and Scope<a href="#purpose-and-scope" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p><code>ClientStrategy</code> is the core business logic component responsible for managing the complete lifecycle of trading signals. It implements signal generation, validation, state transitions, TP/SL monitoring, crash-safe persistence, and PNL calculation. This class operates in both backtest and live trading modes without dependency injection, making it a pure, testable implementation.</p>
<p>For information about how <code>ClientStrategy</code> is orchestrated within the execution flow, see <a href="design_29_backtest_execution_flow.html">Backtest Execution Flow</a> and <a href="design_33_live_execution_flow.html">Live Execution Flow</a>. For details on the persistence mechanism, see <a href="design_26_signal_persistence.html">Signal Persistence</a>. For PNL calculation specifics, see <a href="design_27_pnl_calculation.html">PnL Calculation</a>.</p>
<hr>
<a id="role-in-system-architecture" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Role in System Architecture<a href="#role-in-system-architecture" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p><code>ClientStrategy</code> sits in the Business Logic Layer and is the highest-importance component in the codebase (importance score 54.04). It is instantiated and managed by <code>StrategyConnectionService</code> and invoked by <code>BacktestLogicPrivateService</code> and <code>LiveLogicPrivateService</code>.</p>
<a id="system-integration-diagram" class="tsd-anchor"></a><h3 class="tsd-anchor-link">System Integration Diagram<a href="#system-integration-diagram" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><img src="../media/15_ClientStrategy_0.svg" alt="Mermaid Diagram"></p>
<hr>
<a id="class-structure-and-constructor" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Class Structure and Constructor<a href="#class-structure-and-constructor" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>The <code>ClientStrategy</code> class implements the <code>IStrategy</code> interface and manages two primary pieces of internal state:</p>
<table>
<thead>
<tr>
<th>Field</th>
<th>Type</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>_pendingSignal</code></td>
<td><code>ISignalRow | null</code></td>
<td>Currently active signal being monitored</td>
</tr>
<tr>
<td><code>_lastSignalTimestamp</code></td>
<td><code>number | null</code></td>
<td>Last time <code>getSignal()</code> was called (for throttling)</td>
</tr>
<tr>
<td><code>params</code></td>
<td><code>IStrategyParams</code></td>
<td>Injected dependencies and configuration</td>
</tr>
</tbody>
</table>
<a id="constructor-parameters" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Constructor Parameters<a href="#constructor-parameters" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><img src="../media/15_ClientStrategy_1.svg" alt="Mermaid Diagram"></p>
<hr>
<a id="signal-lifecycle-state-machine" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Signal Lifecycle State Machine<a href="#signal-lifecycle-state-machine" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p><code>ClientStrategy</code> manages signals through four distinct states, represented by discriminated union types <code>IStrategyTickResult</code>.</p>
<p><img src="../media/15_ClientStrategy_2.svg" alt="Mermaid Diagram"></p>
<hr>
<a id="signal-generation-and-validation" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Signal Generation and Validation<a href="#signal-generation-and-validation" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><a id="throttling-with-interval" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Throttling with Interval<a href="#throttling-with-interval" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Signal generation is throttled at the strategy level to prevent spam. The <code>GET_SIGNAL_FN</code> helper enforces minimum intervals between <code>getSignal()</code> calls:</p>
<p><img src="../media/15_ClientStrategy_3.svg" alt="Mermaid Diagram"></p>
<p><strong>Interval Constants:</strong></p>
<table>
<thead>
<tr>
<th>Interval</th>
<th>Minutes</th>
<th>Milliseconds</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>&quot;1m&quot;</code></td>
<td>1</td>
<td>60,000</td>
</tr>
<tr>
<td><code>&quot;3m&quot;</code></td>
<td>3</td>
<td>180,000</td>
</tr>
<tr>
<td><code>&quot;5m&quot;</code></td>
<td>5</td>
<td>300,000</td>
</tr>
<tr>
<td><code>&quot;15m&quot;</code></td>
<td>15</td>
<td>900,000</td>
</tr>
<tr>
<td><code>&quot;30m&quot;</code></td>
<td>30</td>
<td>1,800,000</td>
</tr>
<tr>
<td><code>&quot;1h&quot;</code></td>
<td>60</td>
<td>3,600,000</td>
</tr>
</tbody>
</table>
<a id="validation-rules" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Validation Rules<a href="#validation-rules" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>The <code>VALIDATE_SIGNAL_FN</code> helper performs comprehensive validation before a signal is accepted:</p>
<a id="price-validation" class="tsd-anchor"></a><h4 class="tsd-anchor-link">Price Validation<a href="#price-validation" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><ul>
<li><code>priceOpen &gt; 0</code></li>
<li><code>priceTakeProfit &gt; 0</code></li>
<li><code>priceStopLoss &gt; 0</code></li>
</ul>
<a id="long-position-logic" class="tsd-anchor"></a><h4 class="tsd-anchor-link">Long Position Logic<a href="#long-position-logic" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><ul>
<li><code>priceTakeProfit &gt; priceOpen</code> (profit is up)</li>
<li><code>priceStopLoss &lt; priceOpen</code> (loss is down)</li>
</ul>
<a id="short-position-logic" class="tsd-anchor"></a><h4 class="tsd-anchor-link">Short Position Logic<a href="#short-position-logic" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><ul>
<li><code>priceTakeProfit &lt; priceOpen</code> (profit is down)</li>
<li><code>priceStopLoss &gt; priceOpen</code> (loss is up)</li>
</ul>
<a id="time-validation" class="tsd-anchor"></a><h4 class="tsd-anchor-link">Time Validation<a href="#time-validation" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><ul>
<li><code>minuteEstimatedTime &gt; 0</code></li>
<li><code>timestamp &gt; 0</code></li>
</ul>
<p><strong>Error Format:</strong></p>
<pre><code><span class="hl-4">Invalid</span><span class="hl-1"> </span><span class="hl-4">signal</span><span class="hl-1"> </span><span class="hl-4">for</span><span class="hl-1"> </span><span class="hl-4">long</span><span class="hl-1"> </span><span class="hl-10">position</span><span class="hl-1">:</span><br/><span class="hl-10">Long</span><span class="hl-1">: </span><span class="hl-0">priceTakeProfit</span><span class="hl-1"> (</span><span class="hl-8">49000</span><span class="hl-1">) </span><span class="hl-4">must</span><span class="hl-1"> </span><span class="hl-4">be</span><span class="hl-1"> &gt; </span><span class="hl-0">priceOpen</span><span class="hl-1"> (</span><span class="hl-8">50000</span><span class="hl-1">)</span><br/><span class="hl-10">Long</span><span class="hl-1">: </span><span class="hl-0">priceStopLoss</span><span class="hl-1"> (</span><span class="hl-8">51000</span><span class="hl-1">) </span><span class="hl-4">must</span><span class="hl-1"> </span><span class="hl-4">be</span><span class="hl-1"> &lt; </span><span class="hl-0">priceOpen</span><span class="hl-1"> (</span><span class="hl-8">50000</span><span class="hl-1">)</span>
</code><button>Copy</button></pre>

<hr>
<a id="live-trading-tick-method" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Live Trading: tick() Method<a href="#live-trading-tick-method" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>The <code>tick()</code> method performs a single iteration of strategy execution. It is called repeatedly by <code>LiveLogicPrivateService</code> (every 1 minute + 1ms) or <code>BacktestLogicPrivateService</code> (for each timestamp in the timeframe).</p>
<a id="tick-execution-flow" class="tsd-anchor"></a><h3 class="tsd-anchor-link">tick() Execution Flow<a href="#tick-execution-flow" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><img src="../media/15_ClientStrategy_4.svg" alt="Mermaid Diagram"></p>
<a id="tpsl-check-logic" class="tsd-anchor"></a><h3 class="tsd-anchor-link">TP/SL Check Logic<a href="#tpsl-check-logic" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>The method checks TP/SL conditions based on position type:</p>
<p><strong>Long Position:</strong></p>
<pre><code class="typescript"><span class="hl-5">// Take profit: price goes up</span><br/><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-4">averagePrice</span><span class="hl-1"> &gt;= </span><span class="hl-4">signal</span><span class="hl-1">.</span><span class="hl-4">priceTakeProfit</span><span class="hl-1">) {</span><br/><span class="hl-1">  </span><span class="hl-4">closeReason</span><span class="hl-1"> = </span><span class="hl-2">&quot;take_profit&quot;</span><span class="hl-1">;</span><br/><span class="hl-1">}</span><br/><span class="hl-5">// Stop loss: price goes down</span><br/><span class="hl-3">else</span><span class="hl-1"> </span><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-4">averagePrice</span><span class="hl-1"> &lt;= </span><span class="hl-4">signal</span><span class="hl-1">.</span><span class="hl-4">priceStopLoss</span><span class="hl-1">) {</span><br/><span class="hl-1">  </span><span class="hl-4">closeReason</span><span class="hl-1"> = </span><span class="hl-2">&quot;stop_loss&quot;</span><span class="hl-1">;</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<p><strong>Short Position:</strong></p>
<pre><code class="typescript"><span class="hl-5">// Take profit: price goes down</span><br/><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-4">averagePrice</span><span class="hl-1"> &lt;= </span><span class="hl-4">signal</span><span class="hl-1">.</span><span class="hl-4">priceTakeProfit</span><span class="hl-1">) {</span><br/><span class="hl-1">  </span><span class="hl-4">closeReason</span><span class="hl-1"> = </span><span class="hl-2">&quot;take_profit&quot;</span><span class="hl-1">;</span><br/><span class="hl-1">}</span><br/><span class="hl-5">// Stop loss: price goes up</span><br/><span class="hl-3">else</span><span class="hl-1"> </span><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-4">averagePrice</span><span class="hl-1"> &gt;= </span><span class="hl-4">signal</span><span class="hl-1">.</span><span class="hl-4">priceStopLoss</span><span class="hl-1">) {</span><br/><span class="hl-1">  </span><span class="hl-4">closeReason</span><span class="hl-1"> = </span><span class="hl-2">&quot;stop_loss&quot;</span><span class="hl-1">;</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<hr>
<a id="backtesting-backtest-method" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Backtesting: backtest() Method<a href="#backtesting-backtest-method" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>The <code>backtest()</code> method performs fast-forward simulation using an array of future candles. Instead of iterating timestamp-by-timestamp, it processes candles directly to find when TP/SL is hit.</p>
<a id="backtest-execution-flow" class="tsd-anchor"></a><h3 class="tsd-anchor-link">backtest() Execution Flow<a href="#backtest-execution-flow" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><img src="../media/15_ClientStrategy_5.svg" alt="Mermaid Diagram"></p>
<a id="vwap-calculation-with-5-candle-window" class="tsd-anchor"></a><h3 class="tsd-anchor-link">VWAP Calculation with 5-Candle Window<a href="#vwap-calculation-with-5-candle-window" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>The method uses a sliding 5-candle window to calculate VWAP at each step. Starting from index 4 ensures sufficient candles for accurate VWAP:</p>
<pre><code class="typescript"><span class="hl-5">// Iterate starting from 5th candle (index 4)</span><br/><span class="hl-3">for</span><span class="hl-1"> (</span><span class="hl-6">let</span><span class="hl-1"> </span><span class="hl-4">i</span><span class="hl-1"> = </span><span class="hl-8">4</span><span class="hl-1">; </span><span class="hl-4">i</span><span class="hl-1"> &lt; </span><span class="hl-4">candles</span><span class="hl-1">.</span><span class="hl-4">length</span><span class="hl-1">; </span><span class="hl-4">i</span><span class="hl-1">++) {</span><br/><span class="hl-1">  </span><span class="hl-5">// Get last 5 candles: [i-4, i-3, i-2, i-1, i]</span><br/><span class="hl-1">  </span><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">recentCandles</span><span class="hl-1"> = </span><span class="hl-4">candles</span><span class="hl-1">.</span><span class="hl-0">slice</span><span class="hl-1">(</span><span class="hl-4">i</span><span class="hl-1"> - </span><span class="hl-8">4</span><span class="hl-1">, </span><span class="hl-4">i</span><span class="hl-1"> + </span><span class="hl-8">1</span><span class="hl-1">);</span><br/><span class="hl-1">  </span><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">averagePrice</span><span class="hl-1"> = </span><span class="hl-0">GET_AVG_PRICE_FN</span><span class="hl-1">(</span><span class="hl-4">recentCandles</span><span class="hl-1">);</span><br/><span class="hl-1">  </span><span class="hl-5">// Check TP/SL...</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<p><strong>Why 5 candles?</strong> This matches the live trading behavior where <code>ClientExchange.getAveragePrice()</code> uses the last 5 1-minute candles for VWAP calculation, ensuring consistency between backtest and live modes.</p>
<hr>
<a id="persistence-integration" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Persistence Integration<a href="#persistence-integration" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p><code>ClientStrategy</code> uses <code>PersistSignalAdapter</code> for crash-safe state management. All signal state changes are persisted atomically before yielding results.</p>
<a id="persistence-flow" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Persistence Flow<a href="#persistence-flow" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><img src="../media/15_ClientStrategy_6.svg" alt="Mermaid Diagram"></p>
<a id="initialization-with-state-recovery" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Initialization with State Recovery<a href="#initialization-with-state-recovery" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>The <code>waitForInit()</code> method loads persisted state on startup:</p>
<p><img src="../media/15_ClientStrategy_7.svg" alt="Mermaid Diagram"></p>
<p><strong>Key Features:</strong></p>
<ul>
<li>Uses <code>singleshot</code> pattern to ensure initialization happens exactly once</li>
<li>Validates that persisted signal matches current exchange/strategy context</li>
<li>Skips persistence entirely in backtest mode for performance</li>
</ul>
<hr>
<a id="callback-system" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Callback System<a href="#callback-system" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p><code>ClientStrategy</code> supports five optional lifecycle callbacks for observability and custom logic injection:</p>
<table>
<thead>
<tr>
<th>Callback</th>
<th>Trigger</th>
<th>Parameters</th>
<th>Use Case</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>onTick</code></td>
<td>Every tick result</td>
<td><code>(symbol, result, backtest)</code></td>
<td>Universal event tracking</td>
</tr>
<tr>
<td><code>onOpen</code></td>
<td>Signal opened</td>
<td><code>(symbol, signal, currentPrice, backtest)</code></td>
<td>Notification on new signal</td>
</tr>
<tr>
<td><code>onActive</code></td>
<td>Signal monitored</td>
<td><code>(symbol, signal, currentPrice, backtest)</code></td>
<td>Real-time position tracking</td>
</tr>
<tr>
<td><code>onIdle</code></td>
<td>No signal</td>
<td><code>(symbol, currentPrice, backtest)</code></td>
<td>Market monitoring when idle</td>
</tr>
<tr>
<td><code>onClose</code></td>
<td>Signal closed</td>
<td><code>(symbol, signal, priceClose, backtest)</code></td>
<td>PNL recording, alerts</td>
</tr>
</tbody>
</table>
<a id="callback-invocation-pattern" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Callback Invocation Pattern<a href="#callback-invocation-pattern" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>All callbacks are invoked synchronously within the tick execution:</p>
<p><img src="../media/15_ClientStrategy_8.svg" alt="Mermaid Diagram"></p>
<p><strong>Important:</strong> All callbacks are invoked even if they return promises, but the execution does not await them. This ensures callbacks don't block the main execution flow.</p>
<hr>
<a id="vwap-calculation" class="tsd-anchor"></a><h2 class="tsd-anchor-link">VWAP Calculation<a href="#vwap-calculation" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>The <code>GET_AVG_PRICE_FN</code> helper calculates Volume-Weighted Average Price using the typical price <code>(high + low + close) / 3</code>:</p>
<a id="vwap-formula" class="tsd-anchor"></a><h3 class="tsd-anchor-link">VWAP Formula<a href="#vwap-formula" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><pre><code><span class="hl-4">typicalPrice</span><span class="hl-1"> = (</span><span class="hl-4">high</span><span class="hl-1"> + </span><span class="hl-4">low</span><span class="hl-1"> + </span><span class="hl-4">close</span><span class="hl-1">) / </span><span class="hl-8">3</span><br/><span class="hl-4">sumPriceVolume</span><span class="hl-1"> = </span><span class="hl-0">Σ</span><span class="hl-1">(</span><span class="hl-4">typicalPrice</span><span class="hl-1"> × </span><span class="hl-4">volume</span><span class="hl-1">) </span><span class="hl-4">for</span><span class="hl-1"> </span><span class="hl-4">all</span><span class="hl-1"> </span><span class="hl-4">candles</span><br/><span class="hl-4">totalVolume</span><span class="hl-1"> = </span><span class="hl-0">Σ</span><span class="hl-1">(</span><span class="hl-4">volume</span><span class="hl-1">) </span><span class="hl-4">for</span><span class="hl-1"> </span><span class="hl-4">all</span><span class="hl-1"> </span><span class="hl-4">candles</span><br/><br/><span class="hl-7">VWAP</span><span class="hl-1"> = </span><span class="hl-4">sumPriceVolume</span><span class="hl-1"> / </span><span class="hl-4">totalVolume</span><br/><br/><span class="hl-4">If</span><span class="hl-1"> </span><span class="hl-4">totalVolume</span><span class="hl-1"> == </span><span class="hl-8">0</span><span class="hl-1">:</span><br/><span class="hl-1">  </span><span class="hl-7">VWAP</span><span class="hl-1"> = </span><span class="hl-4">average</span><span class="hl-1"> </span><span class="hl-4">close</span><span class="hl-1"> </span><span class="hl-4">price</span>
</code><button>Copy</button></pre>

<a id="implementation" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Implementation<a href="#implementation" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><img src="../media/15_ClientStrategy_9.svg" alt="Mermaid Diagram"></p>
<p>This calculation is used in:</p>
<ol>
<li><code>backtest()</code> method - calculates VWAP from 5-candle sliding window</li>
<li>Indirectly via <code>ClientExchange.getAveragePrice()</code> during <code>tick()</code> method</li>
</ol>
<hr>
<a id="performance-considerations" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Performance Considerations<a href="#performance-considerations" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p><code>ClientStrategy</code> implements several optimizations for memory efficiency and execution speed:</p>
<a id="memory-optimization-techniques" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Memory Optimization Techniques<a href="#memory-optimization-techniques" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><table>
<thead>
<tr>
<th>Technique</th>
<th>Implementation</th>
<th>Benefit</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Prototype Methods</strong></td>
<td>All methods defined on prototype</td>
<td>Shared across instances, not duplicated</td>
</tr>
<tr>
<td><strong>Memoized Initialization</strong></td>
<td><code>waitForInit = singleshot(async () =&gt; ...)</code></td>
<td>Init happens exactly once per instance</td>
</tr>
<tr>
<td><strong>Minimal State</strong></td>
<td>Only <code>_pendingSignal</code> and <code>_lastSignalTimestamp</code></td>
<td>~100 bytes per instance</td>
</tr>
<tr>
<td><strong>Streaming Architecture</strong></td>
<td>Results yielded immediately</td>
<td>No result accumulation in memory</td>
</tr>
<tr>
<td><strong>Instance Reuse</strong></td>
<td><code>StrategyConnectionService</code> memoizes instances</td>
<td>One instance per <code>strategyName</code></td>
</tr>
</tbody>
</table>
<a id="backtest-performance" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Backtest Performance<a href="#backtest-performance" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>The <code>backtest()</code> method achieves fast simulation through:</p>
<ol>
<li><strong>Direct Candle Processing:</strong> Iterates through candle array instead of calling <code>tick()</code> repeatedly</li>
<li><strong>Early Termination:</strong> Stops at first TP/SL hit, doesn't process remaining candles</li>
<li><strong>No Network Calls:</strong> Uses pre-fetched candle data, no API requests per candle</li>
<li><strong>VWAP Caching:</strong> Calculates VWAP only when needed, not stored</li>
</ol>
<p><strong>Example:</strong> Backtesting a 60-minute signal requires:</p>
<ul>
<li><code>tick()</code> approach: 60 calls to <code>tick()</code>, 60 VWAP calculations, 60 persistence writes</li>
<li><code>backtest()</code> approach: 1 call to <code>backtest()</code>, ~5-60 VWAP calculations (stops early), 1 persistence write</li>
</ul>
<hr>
<a id="code-entity-reference" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Code Entity Reference<a href="#code-entity-reference" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><a id="primary-classes-and-functions" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Primary Classes and Functions<a href="#primary-classes-and-functions" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><table>
<thead>
<tr>
<th>Entity</th>
<th>Type</th>
<th>Location</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>ClientStrategy</code></td>
<td>class</td>
<td><a href="">src/client/ClientStrategy.ts:194</a></td>
<td>Main strategy implementation</td>
</tr>
<tr>
<td><code>tick()</code></td>
<td>method</td>
<td><a href="">src/client/ClientStrategy.ts:258</a></td>
<td>Single iteration of strategy execution</td>
</tr>
<tr>
<td><code>backtest()</code></td>
<td>method</td>
<td><a href="">src/client/ClientStrategy.ts:485</a></td>
<td>Fast-forward signal simulation</td>
</tr>
<tr>
<td><code>waitForInit()</code></td>
<td>method</td>
<td><a href="">src/client/ClientStrategy.ts:209</a></td>
<td>Load persisted state on startup</td>
</tr>
<tr>
<td><code>setPendingSignal()</code></td>
<td>method</td>
<td><a href="">src/client/ClientStrategy.ts:220</a></td>
<td>Update and persist signal state</td>
</tr>
<tr>
<td><code>GET_SIGNAL_FN</code></td>
<td>function</td>
<td><a href="">src/client/ClientStrategy.ts:90</a></td>
<td>Throttled signal generation wrapper</td>
</tr>
<tr>
<td><code>VALIDATE_SIGNAL_FN</code></td>
<td>function</td>
<td><a href="">src/client/ClientStrategy.ts:28</a></td>
<td>Signal validation with error messages</td>
</tr>
<tr>
<td><code>GET_AVG_PRICE_FN</code></td>
<td>function</td>
<td><a href="">src/client/ClientStrategy.ts:133</a></td>
<td>VWAP calculation from candles</td>
</tr>
<tr>
<td><code>WAIT_FOR_INIT_FN</code></td>
<td>function</td>
<td><a href="">src/client/ClientStrategy.ts:146</a></td>
<td>State recovery logic</td>
</tr>
<tr>
<td><code>INTERVAL_MINUTES</code></td>
<td>constant</td>
<td><a href="">src/client/ClientStrategy.ts:19</a></td>
<td>Interval to minutes mapping</td>
</tr>
</tbody>
</table>
<a id="key-interfaces" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Key Interfaces<a href="#key-interfaces" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><table>
<thead>
<tr>
<th>Interface</th>
<th>Location</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>IStrategy</code></td>
<td><a href="">src/interfaces/Strategy.interface.ts:219</a></td>
<td>Strategy contract with <code>tick()</code> and <code>backtest()</code></td>
</tr>
<tr>
<td><code>IStrategyParams</code></td>
<td><a href="">src/interfaces/Strategy.interface.ts:60</a></td>
<td>Constructor parameters</td>
</tr>
<tr>
<td><code>ISignalRow</code></td>
<td><a href="">src/interfaces/Strategy.interface.ts:43</a></td>
<td>Complete signal with auto-generated ID</td>
</tr>
<tr>
<td><code>ISignalDto</code></td>
<td><a href="">src/interfaces/Strategy.interface.ts:22</a></td>
<td>User-provided signal data</td>
</tr>
<tr>
<td><code>IStrategyTickResult</code></td>
<td><a href="">src/interfaces/Strategy.interface.ts:204</a></td>
<td>Discriminated union of tick results</td>
</tr>
<tr>
<td><code>IStrategyTickResultClosed</code></td>
<td><a href="">src/interfaces/Strategy.interface.ts:181</a></td>
<td>Closed signal with PNL</td>
</tr>
<tr>
<td><code>IStrategyCallbacks</code></td>
<td><a href="">src/interfaces/Strategy.interface.ts:75</a></td>
<td>Lifecycle event handlers</td>
</tr>
</tbody>
</table>
</div></div><div class="col-sidebar"><div class="page-menu"><div class="tsd-navigation settings"><details class="tsd-accordion"><summary class="tsd-accordion-summary"><h3><svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-chevronDown"></use></svg>Settings</h3></summary><div class="tsd-accordion-details"><div class="tsd-filter-visibility"><span class="settings-label">Member Visibility</span><ul id="tsd-filter-options"><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-protected" name="protected"/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Protected</span></label></li><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-inherited" name="inherited" checked/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Inherited</span></label></li><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-external" name="external"/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>External</span></label></li></ul></div><div class="tsd-theme-toggle"><label class="settings-label" for="tsd-theme">Theme</label><select id="tsd-theme"><option value="os">OS</option><option value="light">Light</option><option value="dark">Dark</option></select></div></div></details></div><details open class="tsd-accordion tsd-page-navigation"><summary class="tsd-accordion-summary"><h3><svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-chevronDown"></use></svg>On This Page</h3></summary><div class="tsd-accordion-details"><a href="#clientstrategy"><span>Client<wbr/>Strategy</span></a><ul><li><a href="#purpose-and-scope"><span>Purpose and <wbr/>Scope</span></a></li><li><a href="#role-in-system-architecture"><span>Role in <wbr/>System <wbr/>Architecture</span></a></li><li><ul><li><a href="#system-integration-diagram"><span>System <wbr/>Integration <wbr/>Diagram</span></a></li></ul></li><li><a href="#class-structure-and-constructor"><span>Class <wbr/>Structure and <wbr/>Constructor</span></a></li><li><ul><li><a href="#constructor-parameters"><span>Constructor <wbr/>Parameters</span></a></li></ul></li><li><a href="#signal-lifecycle-state-machine"><span>Signal <wbr/>Lifecycle <wbr/>State <wbr/>Machine</span></a></li><li><a href="#signal-generation-and-validation"><span>Signal <wbr/>Generation and <wbr/>Validation</span></a></li><li><ul><li><a href="#throttling-with-interval"><span>Throttling with <wbr/>Interval</span></a></li><li><a href="#validation-rules"><span>Validation <wbr/>Rules</span></a></li><li><ul><li><a href="#price-validation"><span>Price <wbr/>Validation</span></a></li><li><a href="#long-position-logic"><span>Long <wbr/>Position <wbr/>Logic</span></a></li><li><a href="#short-position-logic"><span>Short <wbr/>Position <wbr/>Logic</span></a></li><li><a href="#time-validation"><span>Time <wbr/>Validation</span></a></li></ul></li></ul></li><li><a href="#live-trading-tick-method"><span>Live <wbr/>Trading: tick() <wbr/>Method</span></a></li><li><ul><li><a href="#tick-execution-flow"><span>tick() <wbr/>Execution <wbr/>Flow</span></a></li><li><a href="#tpsl-check-logic"><span>TP/SL <wbr/>Check <wbr/>Logic</span></a></li></ul></li><li><a href="#backtesting-backtest-method"><span>Backtesting: backtest() <wbr/>Method</span></a></li><li><ul><li><a href="#backtest-execution-flow"><span>backtest() <wbr/>Execution <wbr/>Flow</span></a></li><li><a href="#vwap-calculation-with-5-candle-window"><span>VWAP <wbr/>Calculation with 5-<wbr/>Candle <wbr/>Window</span></a></li></ul></li><li><a href="#persistence-integration"><span>Persistence <wbr/>Integration</span></a></li><li><ul><li><a href="#persistence-flow"><span>Persistence <wbr/>Flow</span></a></li><li><a href="#initialization-with-state-recovery"><span>Initialization with <wbr/>State <wbr/>Recovery</span></a></li></ul></li><li><a href="#callback-system"><span>Callback <wbr/>System</span></a></li><li><ul><li><a href="#callback-invocation-pattern"><span>Callback <wbr/>Invocation <wbr/>Pattern</span></a></li></ul></li><li><a href="#vwap-calculation"><span>VWAP <wbr/>Calculation</span></a></li><li><ul><li><a href="#vwap-formula"><span>VWAP <wbr/>Formula</span></a></li><li><a href="#implementation"><span>Implementation</span></a></li></ul></li><li><a href="#performance-considerations"><span>Performance <wbr/>Considerations</span></a></li><li><ul><li><a href="#memory-optimization-techniques"><span>Memory <wbr/>Optimization <wbr/>Techniques</span></a></li><li><a href="#backtest-performance"><span>Backtest <wbr/>Performance</span></a></li></ul></li><li><a href="#code-entity-reference"><span>Code <wbr/>Entity <wbr/>Reference</span></a></li><li><ul><li><a href="#primary-classes-and-functions"><span>Primary <wbr/>Classes and <wbr/>Functions</span></a></li><li><a href="#key-interfaces"><span>Key <wbr/>Interfaces</span></a></li></ul></li></ul></div></details></div><div class="site-menu"><nav class="tsd-navigation"><a href="../modules.html">backtest-kit</a><ul class="tsd-small-nested-navigation" id="tsd-nav-container"><li>Loading...</li></ul></nav></div></div></div><footer><p class="tsd-generator">Generated using <a href="https://typedoc.org/" target="_blank">TypeDoc</a></p></footer><div class="overlay"></div></body></html>
