<!DOCTYPE html><html class="default" lang="en" data-base=".."><head><meta charset="utf-8"/><meta http-equiv="x-ua-compatible" content="IE=edge"/><title>design/36_partial-profit-and-loss | backtest-kit</title><meta name="description" content="Documentation for backtest-kit"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="stylesheet" href="../assets/style.css"/><link rel="stylesheet" href="../assets/highlight.css"/><script defer src="../assets/main.js"></script><script async src="../assets/icons.js" id="tsd-icons-script"></script><script async src="../assets/search.js" id="tsd-search-script"></script><script async src="../assets/navigation.js" id="tsd-nav-script"></script><script async src="../assets/hierarchy.js" id="tsd-hierarchy-script"></script></head><body><script>document.documentElement.dataset.theme = localStorage.getItem("tsd-theme") || "os";document.body.style.display="none";setTimeout(() => app?app.showPage():document.body.style.removeProperty("display"),500)</script><header class="tsd-page-toolbar"><div class="tsd-toolbar-contents container"><div class="table-cell" id="tsd-search"><div class="field"><label for="tsd-search-field" class="tsd-widget tsd-toolbar-icon search no-caption"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-search"></use></svg></label><input type="text" id="tsd-search-field" aria-label="Search"/></div><div class="field"><div id="tsd-toolbar-links"></div></div><ul class="results"><li class="state loading">Preparing search index...</li><li class="state failure">The search index is not available</li></ul><a href="../index.html" class="title">backtest-kit</a></div><div class="table-cell" id="tsd-widgets"><a href="#" class="tsd-widget tsd-toolbar-icon menu no-caption" data-toggle="menu" aria-label="Menu"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-menu"></use></svg></a></div></div></header><div class="container container-main"><div class="col-content"><div class="tsd-page-title"><ul class="tsd-breadcrumb"><li><a href="../modules.html">backtest-kit</a></li><li><a href="design_36_partial-profit-and-loss.html">design/36_partial-profit-and-loss</a></li></ul></div><div class="tsd-panel tsd-typography"><a id="partial-profit-and-loss" class="tsd-anchor"></a><h1 class="tsd-anchor-link">Partial Profit and Loss<a href="#partial-profit-and-loss" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h1><p>This page documents the partial profit/loss tracking system, which monitors intermediate milestone levels (10%, 20%, 30%, etc.) as trading signals move toward their take profit or stop loss targets. The system emits events when signals reach these thresholds, enabling real-time monitoring and analytics for unrealized gains/losses.</p>
<p>For information about final profit/loss calculation when signals close, see <a href="design_03_signal-lifecycle-and-state-machine.html">Signal Lifecycle and State Machine</a>. For event subscription patterns, see <a href="design_35_event-listeners-and-monitoring.html">Event Listeners and Monitoring</a>.</p>
<hr>
<a id="system-purpose-and-architecture" class="tsd-anchor"></a><h2 class="tsd-anchor-link">System Purpose and Architecture<a href="#system-purpose-and-architecture" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>The partial profit/loss system tracks milestone levels for active signals without closing positions. When a signal's unrealized profit or loss crosses a 10% threshold (10%, 20%, 30%, up to 100%), the system:</p>
<ol>
<li>Emits an event via <code>partialProfitSubject</code> or <code>partialLossSubject</code></li>
<li>Records the milestone in persistent storage for crash recovery</li>
<li>Ensures each level is only reported once per signal (Set-based deduplication)</li>
<li>Provides markdown reports aggregating milestone events</li>
</ol>
<p>This differs from the final PNL calculated when signals close - partial tracking monitors intermediate states during active signal monitoring.</p>
<hr>
<a id="component-architecture" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Component Architecture<a href="#component-architecture" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p><img src="../media/36-partial-profit-and-loss_0.svg" alt="Mermaid Diagram"></p>
<p><strong>Component Flow</strong>: <code>ClientStrategy</code> invokes <code>ClientPartial</code> methods during signal monitoring. <code>ClientPartial</code> maintains in-memory Sets tracking which levels have been reached, persists state via <code>PersistPartialAdapter</code>, and emits events through <code>partialProfitSubject</code>/<code>partialLossSubject</code>. <code>PartialMarkdownService</code> subscribes to these subjects for reporting.</p>
<hr>
<a id="milestone-level-enumeration" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Milestone Level Enumeration<a href="#milestone-level-enumeration" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>The <code>PartialLevel</code> type defines discrete milestone thresholds:</p>
<pre><code class="typescript"><span class="hl-7">type</span><span class="hl-1"> </span><span class="hl-13">PartialLevel</span><span class="hl-1"> = </span><span class="hl-6">10</span><span class="hl-1"> | </span><span class="hl-6">20</span><span class="hl-1"> | </span><span class="hl-6">30</span><span class="hl-1"> | </span><span class="hl-6">40</span><span class="hl-1"> | </span><span class="hl-6">50</span><span class="hl-1"> | </span><span class="hl-6">60</span><span class="hl-1"> | </span><span class="hl-6">70</span><span class="hl-1"> | </span><span class="hl-6">80</span><span class="hl-1"> | </span><span class="hl-6">90</span><span class="hl-1"> | </span><span class="hl-6">100</span><span class="hl-1">;</span>
</code><button type="button">Copy</button></pre>

<p>When a signal's unrealized profit or loss percentage crosses one of these thresholds, the corresponding level is added to the tracking Set and an event is emitted. For example:</p>
<ul>
<li>Signal opens at $50,000</li>
<li>Price moves to $55,500 → 11% profit → <code>profit(symbol, data, 55500, 11.0, false, now)</code> called → Level 10 emitted</li>
<li>Price moves to $61,000 → 22% profit → <code>profit(symbol, data, 61000, 22.0, false, now)</code> called → Level 20 emitted</li>
<li>Level 10 is NOT re-emitted (Set deduplication)</li>
</ul>
<hr>
<a id="ipartial-interface-and-methods" class="tsd-anchor"></a><h2 class="tsd-anchor-link">IPartial Interface and Methods<a href="#ipartial-interface-and-methods" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p><img src="../media/36-partial-profit-and-loss_1.svg" alt="Mermaid Diagram"></p>
<p><strong>Method Contracts</strong>:</p>
<table>
<thead>
<tr>
<th>Method</th>
<th>Parameters</th>
<th>Purpose</th>
<th>Side Effects</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>profit()</code></td>
<td><code>symbol</code>, <code>data: ISignalRow</code>, <code>currentPrice</code>, <code>revenuePercent</code>, <code>backtest</code>, <code>when</code></td>
<td>Process profit state and emit events for new profit levels</td>
<td>Updates <code>_states</code> Map, persists to disk, emits via <code>partialProfitSubject</code></td>
</tr>
<tr>
<td><code>loss()</code></td>
<td><code>symbol</code>, <code>data: ISignalRow</code>, <code>currentPrice</code>, <code>lossPercent</code>, <code>backtest</code>, <code>when</code></td>
<td>Process loss state and emit events for new loss levels</td>
<td>Updates <code>_states</code> Map, persists to disk, emits via <code>partialLossSubject</code></td>
</tr>
<tr>
<td><code>clear()</code></td>
<td><code>symbol</code>, <code>data: ISignalRow</code>, <code>priceClose</code>, <code>backtest</code></td>
<td>Clear partial state when signal closes</td>
<td>Deletes from <code>_states</code> Map, persists updated state, clears memoized instance</td>
</tr>
</tbody>
</table>
<hr>
<a id="state-management-and-persistence" class="tsd-anchor"></a><h2 class="tsd-anchor-link">State Management and Persistence<a href="#state-management-and-persistence" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><a id="ipartialstate-internal-structure" class="tsd-anchor"></a><h3 class="tsd-anchor-link">IPartialState Internal Structure<a href="#ipartialstate-internal-structure" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><pre><code class="typescript"><span class="hl-7">interface</span><span class="hl-1"> </span><span class="hl-13">IPartialState</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-4">profitLevels</span><span class="hl-1">: </span><span class="hl-13">Set</span><span class="hl-1">&lt;</span><span class="hl-13">PartialLevel</span><span class="hl-1">&gt;;  </span><span class="hl-5">// In-memory deduplication</span><br/><span class="hl-1">  </span><span class="hl-4">lossLevels</span><span class="hl-1">: </span><span class="hl-13">Set</span><span class="hl-1">&lt;</span><span class="hl-13">PartialLevel</span><span class="hl-1">&gt;;    </span><span class="hl-5">// In-memory deduplication</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<p>The <code>_states</code> Map in <code>ClientPartial</code> uses signal IDs as keys:</p>
<pre><code><span class="hl-10">_states</span><span class="hl-1">: </span><span class="hl-4">Map</span><span class="hl-1">&lt;</span><span class="hl-4">string</span><span class="hl-1">, </span><span class="hl-4">IPartialState</span><span class="hl-1">&gt;</span><br/><span class="hl-1">  </span><span class="hl-2">&quot;signal-uuid-1&quot;</span><span class="hl-1"> → { </span><span class="hl-10">profitLevels</span><span class="hl-1">: </span><span class="hl-0">Set</span><span class="hl-1">(</span><span class="hl-6">10</span><span class="hl-1">, </span><span class="hl-6">20</span><span class="hl-1">), </span><span class="hl-10">lossLevels</span><span class="hl-1">: </span><span class="hl-0">Set</span><span class="hl-1">() }</span><br/><span class="hl-1">  </span><span class="hl-2">&quot;signal-uuid-2&quot;</span><span class="hl-1"> → { </span><span class="hl-10">profitLevels</span><span class="hl-1">: </span><span class="hl-0">Set</span><span class="hl-1">(), </span><span class="hl-10">lossLevels</span><span class="hl-1">: </span><span class="hl-0">Set</span><span class="hl-1">(</span><span class="hl-6">10</span><span class="hl-1">) }</span>
</code><button>Copy</button></pre>

<a id="serialization-via-ipartialdata" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Serialization via IPartialData<a href="#serialization-via-ipartialdata" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>For persistence to disk, Sets are converted to arrays:</p>
<pre><code class="typescript"><span class="hl-7">interface</span><span class="hl-1"> </span><span class="hl-13">IPartialData</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-4">profitLevels</span><span class="hl-1">: </span><span class="hl-13">PartialLevel</span><span class="hl-1">[];  </span><span class="hl-5">// Serializable form</span><br/><span class="hl-1">  </span><span class="hl-4">lossLevels</span><span class="hl-1">: </span><span class="hl-13">PartialLevel</span><span class="hl-1">[];    </span><span class="hl-5">// Serializable form</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<p><strong>Persistence Pattern</strong>:</p>
<ol>
<li><code>ClientPartial._states</code> (in-memory Map with Sets)</li>
<li>→ Convert Sets to arrays → <code>IPartialData</code></li>
<li>→ <code>PersistPartialAdapter.persist()</code> → Write to <code>./dump/partial/{symbol}_partial.json</code></li>
<li>On crash recovery: <code>waitForInit()</code> loads JSON → Convert arrays to Sets → Restore <code>_states</code></li>
</ol>
<hr>
<a id="integration-with-clientstrategy" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Integration with ClientStrategy<a href="#integration-with-clientstrategy" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p><img src="../media/36-partial-profit-and-loss_2.svg" alt="Mermaid Diagram"></p>
<p><strong>Invocation Points in ClientStrategy</strong>:</p>
<table>
<thead>
<tr>
<th>File Location</th>
<th>Context</th>
<th>Partial Method Called</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="">src/client/ClientStrategy.ts:900-950</a></td>
<td><code>tick()</code> during active signal monitoring</td>
<td><code>profit()</code> or <code>loss()</code> based on <code>revenuePercent</code> sign</td>
</tr>
<tr>
<td><a href="">src/client/ClientStrategy.ts:1100-1200</a></td>
<td><code>backtest()</code> during candle processing</td>
<td><code>profit()</code> or <code>loss()</code> during VWAP checks</td>
</tr>
<tr>
<td><a href="">src/client/ClientStrategy.ts:1050-1080</a></td>
<td>Signal close (TP/SL/time_expired)</td>
<td><code>clear()</code> to remove state</td>
</tr>
</tbody>
</table>
<hr>
<a id="event-emission-contracts" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Event Emission Contracts<a href="#event-emission-contracts" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><a id="partialprofitcontract" class="tsd-anchor"></a><h3 class="tsd-anchor-link">PartialProfitContract<a href="#partialprofitcontract" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><pre><code class="typescript"><span class="hl-7">interface</span><span class="hl-1"> </span><span class="hl-13">PartialProfitContract</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-4">symbol</span><span class="hl-1">: </span><span class="hl-13">string</span><span class="hl-1">;           </span><span class="hl-5">// Trading pair</span><br/><span class="hl-1">  </span><span class="hl-4">data</span><span class="hl-1">: </span><span class="hl-13">ISignalRow</span><span class="hl-1">;         </span><span class="hl-5">// Complete signal data</span><br/><span class="hl-1">  </span><span class="hl-4">currentPrice</span><span class="hl-1">: </span><span class="hl-13">number</span><span class="hl-1">;     </span><span class="hl-5">// Market price when level reached</span><br/><span class="hl-1">  </span><span class="hl-4">level</span><span class="hl-1">: </span><span class="hl-13">PartialLevel</span><span class="hl-1">;      </span><span class="hl-5">// Milestone reached (10, 20, 30, etc)</span><br/><span class="hl-1">  </span><span class="hl-4">backtest</span><span class="hl-1">: </span><span class="hl-13">boolean</span><span class="hl-1">;        </span><span class="hl-5">// Execution mode</span><br/><span class="hl-1">  </span><span class="hl-4">timestamp</span><span class="hl-1">: </span><span class="hl-13">number</span><span class="hl-1">;        </span><span class="hl-5">// Event timestamp in ms</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<p><strong>Emitter</strong>: <code>partialProfitSubject</code> declared at <a href="">src/config/emitters.ts:118</a></p>
<p><strong>Listener Function</strong>: <code>listenPartialProfit(fn)</code> and <code>listenPartialProfitOnce(filterFn, fn)</code> at <a href="">src/function/event.ts:280-320</a></p>
<a id="partiallosscontract" class="tsd-anchor"></a><h3 class="tsd-anchor-link">PartialLossContract<a href="#partiallosscontract" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><pre><code class="typescript"><span class="hl-7">interface</span><span class="hl-1"> </span><span class="hl-13">PartialLossContract</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-4">symbol</span><span class="hl-1">: </span><span class="hl-13">string</span><span class="hl-1">;           </span><span class="hl-5">// Trading pair</span><br/><span class="hl-1">  </span><span class="hl-4">data</span><span class="hl-1">: </span><span class="hl-13">ISignalRow</span><span class="hl-1">;         </span><span class="hl-5">// Complete signal data</span><br/><span class="hl-1">  </span><span class="hl-4">currentPrice</span><span class="hl-1">: </span><span class="hl-13">number</span><span class="hl-1">;     </span><span class="hl-5">// Market price when level reached</span><br/><span class="hl-1">  </span><span class="hl-4">level</span><span class="hl-1">: </span><span class="hl-13">PartialLevel</span><span class="hl-1">;      </span><span class="hl-5">// Milestone reached (10, 20, 30, etc)</span><br/><span class="hl-1">  </span><span class="hl-4">backtest</span><span class="hl-1">: </span><span class="hl-13">boolean</span><span class="hl-1">;        </span><span class="hl-5">// Execution mode</span><br/><span class="hl-1">  </span><span class="hl-4">timestamp</span><span class="hl-1">: </span><span class="hl-13">number</span><span class="hl-1">;        </span><span class="hl-5">// Event timestamp in ms</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<p><strong>Emitter</strong>: <code>partialLossSubject</code> declared at <a href="">src/config/emitters.ts:124</a></p>
<p><strong>Listener Function</strong>: <code>listenPartialLoss(fn)</code> and <code>listenPartialLossOnce(filterFn, fn)</code> at <a href="">src/function/event.ts:330-370</a></p>
<hr>
<a id="partialconnectionservice-factory" class="tsd-anchor"></a><h2 class="tsd-anchor-link">PartialConnectionService Factory<a href="#partialconnectionservice-factory" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>The <code>PartialConnectionService</code> provides memoized <code>ClientPartial</code> instances to avoid creating multiple instances per symbol:</p>
<pre><code class="typescript"><span class="hl-7">class</span><span class="hl-1"> </span><span class="hl-13">PartialConnectionService</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-7">private</span><span class="hl-1"> </span><span class="hl-4">getPartial</span><span class="hl-1"> = </span><span class="hl-0">memoize</span><span class="hl-1">(</span><br/><span class="hl-1">    ([</span><span class="hl-4">symbol</span><span class="hl-1">]) </span><span class="hl-7">=&gt;</span><span class="hl-1"> </span><span class="hl-4">symbol</span><span class="hl-1">,</span><br/><span class="hl-1">    (</span><span class="hl-4">symbol</span><span class="hl-1">: </span><span class="hl-13">string</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> </span><span class="hl-7">new</span><span class="hl-1"> </span><span class="hl-0">ClientPartial</span><span class="hl-1">({</span><br/><span class="hl-1">      </span><span class="hl-4">logger:</span><span class="hl-1"> </span><span class="hl-7">this</span><span class="hl-1">.</span><span class="hl-4">loggerService</span><span class="hl-1">,</span><br/><span class="hl-1">      </span><span class="hl-0">onProfit</span><span class="hl-4">:</span><span class="hl-1"> (</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">data</span><span class="hl-1">, </span><span class="hl-4">price</span><span class="hl-1">, </span><span class="hl-4">level</span><span class="hl-1">, </span><span class="hl-4">backtest</span><span class="hl-1">, </span><span class="hl-4">timestamp</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">        </span><span class="hl-4">partialProfitSubject</span><span class="hl-1">.</span><span class="hl-0">next</span><span class="hl-1">({ </span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">data</span><span class="hl-1">, </span><span class="hl-4">currentPrice:</span><span class="hl-1"> </span><span class="hl-4">price</span><span class="hl-1">, </span><span class="hl-4">level</span><span class="hl-1">, </span><span class="hl-4">backtest</span><span class="hl-1">, </span><span class="hl-4">timestamp</span><span class="hl-1"> });</span><br/><span class="hl-1">      },</span><br/><span class="hl-1">      </span><span class="hl-0">onLoss</span><span class="hl-4">:</span><span class="hl-1"> (</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">data</span><span class="hl-1">, </span><span class="hl-4">price</span><span class="hl-1">, </span><span class="hl-4">level</span><span class="hl-1">, </span><span class="hl-4">backtest</span><span class="hl-1">, </span><span class="hl-4">timestamp</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">        </span><span class="hl-4">partialLossSubject</span><span class="hl-1">.</span><span class="hl-0">next</span><span class="hl-1">({ </span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">data</span><span class="hl-1">, </span><span class="hl-4">currentPrice:</span><span class="hl-1"> </span><span class="hl-4">price</span><span class="hl-1">, </span><span class="hl-4">level</span><span class="hl-1">, </span><span class="hl-4">backtest</span><span class="hl-1">, </span><span class="hl-4">timestamp</span><span class="hl-1"> });</span><br/><span class="hl-1">      }</span><br/><span class="hl-1">    })</span><br/><span class="hl-1">  );</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<p><strong>Memoization Key</strong>: Symbol only (not symbol:strategyName), because partial tracking is per-signal, not per-strategy</p>
<p><strong>Instance Lifecycle</strong>:</p>
<ol>
<li>First call to <code>getPartial(symbol)</code> creates <code>ClientPartial</code> instance</li>
<li>Subsequent calls return cached instance</li>
<li>On <code>clear()</code>, instance is removed from memoization cache via <a href="">src/client/ClientPartial.ts:250-280</a></li>
</ol>
<hr>
<a id="markdown-reporting" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Markdown Reporting<a href="#markdown-reporting" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><a id="partialmarkdownservice-architecture" class="tsd-anchor"></a><h3 class="tsd-anchor-link">PartialMarkdownService Architecture<a href="#partialmarkdownservice-architecture" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><img src="../media/36-partial-profit-and-loss_3.svg" alt="Mermaid Diagram"></p>
<a id="partialstatistics-structure" class="tsd-anchor"></a><h3 class="tsd-anchor-link">PartialStatistics Structure<a href="#partialstatistics-structure" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><pre><code class="typescript"><span class="hl-7">interface</span><span class="hl-1"> </span><span class="hl-13">PartialStatistics</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-4">eventList</span><span class="hl-1">: </span><span class="hl-13">PartialEvent</span><span class="hl-1">[];     </span><span class="hl-5">// All profit/loss milestone events</span><br/><span class="hl-1">  </span><span class="hl-4">totalEvents</span><span class="hl-1">: </span><span class="hl-13">number</span><span class="hl-1">;            </span><span class="hl-5">// Total event count</span><br/><span class="hl-1">  </span><span class="hl-4">totalProfit</span><span class="hl-1">: </span><span class="hl-13">number</span><span class="hl-1">;            </span><span class="hl-5">// Count of profit milestone events</span><br/><span class="hl-1">  </span><span class="hl-4">totalLoss</span><span class="hl-1">: </span><span class="hl-13">number</span><span class="hl-1">;              </span><span class="hl-5">// Count of loss milestone events</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<p><strong>Event Storage Pattern</strong>: Uses memoized <code>ReportStorage</code> instances keyed by <code>symbol:strategyName</code>, with bounded queue (MAX_EVENTS = 250) using FIFO eviction.</p>
<a id="report-table-columns" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Report Table Columns<a href="#report-table-columns" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><table>
<thead>
<tr>
<th>Column</th>
<th>Label</th>
<th>Format</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>action</code></td>
<td>Action</td>
<td>&quot;PROFIT&quot; / &quot;LOSS&quot;</td>
<td>Event type</td>
</tr>
<tr>
<td><code>symbol</code></td>
<td>Symbol</td>
<td>Raw string</td>
<td>Trading pair</td>
</tr>
<tr>
<td><code>strategyName</code></td>
<td>Strategy</td>
<td>Raw string</td>
<td>Strategy identifier</td>
</tr>
<tr>
<td><code>signalId</code></td>
<td>Signal ID</td>
<td>UUID</td>
<td>Signal identifier</td>
</tr>
<tr>
<td><code>position</code></td>
<td>Position</td>
<td>&quot;LONG&quot; / &quot;SHORT&quot;</td>
<td>Trade direction</td>
</tr>
<tr>
<td><code>level</code></td>
<td>Level %</td>
<td>&quot;+10%&quot; / &quot;-20%&quot;</td>
<td>Milestone percentage</td>
</tr>
<tr>
<td><code>currentPrice</code></td>
<td>Current Price</td>
<td>&quot;50000.12345678 USD&quot;</td>
<td>Market price at milestone</td>
</tr>
<tr>
<td><code>timestamp</code></td>
<td>Timestamp</td>
<td>ISO 8601</td>
<td>Event time</td>
</tr>
<tr>
<td><code>mode</code></td>
<td>Mode</td>
<td>&quot;Backtest&quot; / &quot;Live&quot;</td>
<td>Execution mode</td>
</tr>
</tbody>
</table>
<hr>
<a id="usage-examples" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Usage Examples<a href="#usage-examples" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><a id="listening-to-partial-events" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Listening to Partial Events<a href="#listening-to-partial-events" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><pre><code class="typescript"><span class="hl-3">import</span><span class="hl-1"> { </span><span class="hl-4">listenPartialProfit</span><span class="hl-1">, </span><span class="hl-4">listenPartialLoss</span><span class="hl-1"> } </span><span class="hl-3">from</span><span class="hl-1"> </span><span class="hl-2">&#39;backtest-kit&#39;</span><span class="hl-1">;</span><br/><br/><span class="hl-5">// Subscribe to all profit milestones</span><br/><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">unsubProfit</span><span class="hl-1"> = </span><span class="hl-0">listenPartialProfit</span><span class="hl-1">((</span><span class="hl-4">event</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-4">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-2">`</span><span class="hl-7">${</span><span class="hl-4">event</span><span class="hl-9">.</span><span class="hl-4">symbol</span><span class="hl-7">}</span><span class="hl-2"> reached +</span><span class="hl-7">${</span><span class="hl-4">event</span><span class="hl-9">.</span><span class="hl-4">level</span><span class="hl-7">}</span><span class="hl-2">% profit`</span><span class="hl-1">);</span><br/><span class="hl-1">  </span><span class="hl-4">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-2">`Signal ID: </span><span class="hl-7">${</span><span class="hl-4">event</span><span class="hl-9">.</span><span class="hl-4">data</span><span class="hl-9">.</span><span class="hl-4">id</span><span class="hl-7">}</span><span class="hl-2">, Price: </span><span class="hl-7">${</span><span class="hl-4">event</span><span class="hl-9">.</span><span class="hl-4">currentPrice</span><span class="hl-7">}</span><span class="hl-2">`</span><span class="hl-1">);</span><br/><span class="hl-1">});</span><br/><br/><span class="hl-5">// Subscribe to all loss milestones</span><br/><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">unsubLoss</span><span class="hl-1"> = </span><span class="hl-0">listenPartialLoss</span><span class="hl-1">((</span><span class="hl-4">event</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-4">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-2">`</span><span class="hl-7">${</span><span class="hl-4">event</span><span class="hl-9">.</span><span class="hl-4">symbol</span><span class="hl-7">}</span><span class="hl-2"> reached -</span><span class="hl-7">${</span><span class="hl-4">event</span><span class="hl-9">.</span><span class="hl-4">level</span><span class="hl-7">}</span><span class="hl-2">% loss`</span><span class="hl-1">);</span><br/><span class="hl-1">});</span><br/><br/><span class="hl-5">// One-time listener for specific condition</span><br/><span class="hl-0">listenPartialProfitOnce</span><span class="hl-1">(</span><br/><span class="hl-1">  (</span><span class="hl-4">event</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> </span><span class="hl-4">event</span><span class="hl-1">.</span><span class="hl-4">level</span><span class="hl-1"> === </span><span class="hl-6">50</span><span class="hl-1"> &amp;&amp; </span><span class="hl-4">event</span><span class="hl-1">.</span><span class="hl-4">symbol</span><span class="hl-1"> === </span><span class="hl-2">&#39;BTCUSDT&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">  (</span><span class="hl-4">event</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-4">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-2">&#39;BTCUSDT reached 50% profit milestone&#39;</span><span class="hl-1">);</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">);</span>
</code><button type="button">Copy</button></pre>

<a id="generating-partial-reports" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Generating Partial Reports<a href="#generating-partial-reports" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><pre><code class="typescript"><span class="hl-3">import</span><span class="hl-1"> { </span><span class="hl-4">Partial</span><span class="hl-1"> } </span><span class="hl-3">from</span><span class="hl-1"> </span><span class="hl-2">&#39;backtest-kit&#39;</span><span class="hl-1">;</span><br/><br/><span class="hl-5">// Get statistics for symbol-strategy pair</span><br/><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">stats</span><span class="hl-1"> = </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-4">Partial</span><span class="hl-1">.</span><span class="hl-0">getData</span><span class="hl-1">(</span><span class="hl-2">&#39;BTCUSDT&#39;</span><span class="hl-1">, </span><span class="hl-2">&#39;my-strategy&#39;</span><span class="hl-1">);</span><br/><span class="hl-4">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-2">`Total profit events: </span><span class="hl-7">${</span><span class="hl-4">stats</span><span class="hl-9">.</span><span class="hl-4">totalProfit</span><span class="hl-7">}</span><span class="hl-2">`</span><span class="hl-1">);</span><br/><span class="hl-4">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-2">`Total loss events: </span><span class="hl-7">${</span><span class="hl-4">stats</span><span class="hl-9">.</span><span class="hl-4">totalLoss</span><span class="hl-7">}</span><span class="hl-2">`</span><span class="hl-1">);</span><br/><br/><span class="hl-5">// Generate markdown report</span><br/><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">markdown</span><span class="hl-1"> = </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-4">Partial</span><span class="hl-1">.</span><span class="hl-0">getReport</span><span class="hl-1">(</span><span class="hl-2">&#39;BTCUSDT&#39;</span><span class="hl-1">, </span><span class="hl-2">&#39;my-strategy&#39;</span><span class="hl-1">);</span><br/><span class="hl-4">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-4">markdown</span><span class="hl-1">);</span><br/><br/><span class="hl-5">// Save report to disk</span><br/><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-4">Partial</span><span class="hl-1">.</span><span class="hl-0">dump</span><span class="hl-1">(</span><span class="hl-2">&#39;BTCUSDT&#39;</span><span class="hl-1">, </span><span class="hl-2">&#39;my-strategy&#39;</span><span class="hl-1">, </span><span class="hl-2">&#39;./reports/partial&#39;</span><span class="hl-1">);</span><br/><span class="hl-5">// Writes to: ./reports/partial/BTCUSDT_my-strategy.md</span>
</code><button type="button">Copy</button></pre>

<hr>
<a id="strategy-callback-integration" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Strategy Callback Integration<a href="#strategy-callback-integration" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>Strategies can receive partial profit/loss events through callbacks:</p>
<pre><code class="typescript"><span class="hl-3">import</span><span class="hl-1"> { </span><span class="hl-4">addStrategy</span><span class="hl-1"> } </span><span class="hl-3">from</span><span class="hl-1"> </span><span class="hl-2">&#39;backtest-kit&#39;</span><span class="hl-1">;</span><br/><br/><span class="hl-0">addStrategy</span><span class="hl-1">({</span><br/><span class="hl-1">  </span><span class="hl-4">strategyName:</span><span class="hl-1"> </span><span class="hl-2">&#39;my-strategy&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">interval:</span><span class="hl-1"> </span><span class="hl-2">&#39;1m&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-0">getSignal</span><span class="hl-4">:</span><span class="hl-1"> </span><span class="hl-7">async</span><span class="hl-1"> (</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">when</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-5">// Signal generation logic</span><br/><span class="hl-1">    </span><span class="hl-3">return</span><span class="hl-1"> </span><span class="hl-7">null</span><span class="hl-1">;</span><br/><span class="hl-1">  },</span><br/><span class="hl-1">  </span><span class="hl-4">callbacks:</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-0">onPartialProfit</span><span class="hl-4">:</span><span class="hl-1"> (</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">data</span><span class="hl-1">, </span><span class="hl-4">currentPrice</span><span class="hl-1">, </span><span class="hl-4">revenuePercent</span><span class="hl-1">, </span><span class="hl-4">backtest</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">      </span><span class="hl-4">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-2">`Signal </span><span class="hl-7">${</span><span class="hl-4">data</span><span class="hl-9">.</span><span class="hl-4">id</span><span class="hl-7">}</span><span class="hl-2"> has </span><span class="hl-7">${</span><span class="hl-4">revenuePercent</span><span class="hl-7">}</span><span class="hl-2">% profit`</span><span class="hl-1">);</span><br/><span class="hl-1">      </span><span class="hl-4">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-2">`Current price: </span><span class="hl-7">${</span><span class="hl-4">currentPrice</span><span class="hl-7">}</span><span class="hl-2">`</span><span class="hl-1">);</span><br/><span class="hl-1">    },</span><br/><span class="hl-1">    </span><span class="hl-0">onPartialLoss</span><span class="hl-4">:</span><span class="hl-1"> (</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">data</span><span class="hl-1">, </span><span class="hl-4">currentPrice</span><span class="hl-1">, </span><span class="hl-4">lossPercent</span><span class="hl-1">, </span><span class="hl-4">backtest</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">      </span><span class="hl-4">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-2">`Signal </span><span class="hl-7">${</span><span class="hl-4">data</span><span class="hl-9">.</span><span class="hl-4">id</span><span class="hl-7">}</span><span class="hl-2"> has </span><span class="hl-7">${</span><span class="hl-4">lossPercent</span><span class="hl-7">}</span><span class="hl-2">% loss`</span><span class="hl-1">);</span><br/><span class="hl-1">      </span><span class="hl-4">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-2">`Current price: </span><span class="hl-7">${</span><span class="hl-4">currentPrice</span><span class="hl-7">}</span><span class="hl-2">`</span><span class="hl-1">);</span><br/><span class="hl-1">    }</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">});</span>
</code><button type="button">Copy</button></pre>

<p><strong>Callback Timing</strong>: Called from <a href="">src/client/ClientStrategy.ts:920-960</a> during signal monitoring in <code>tick()</code> and <code>backtest()</code> methods, before partial events are emitted to subjects.</p>
<hr>
<a id="persistence-and-crash-recovery" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Persistence and Crash Recovery<a href="#persistence-and-crash-recovery" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><a id="file-structure" class="tsd-anchor"></a><h3 class="tsd-anchor-link">File Structure<a href="#file-structure" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Partial state is persisted to:</p>
<pre><code><span class="hl-1">./</span><span class="hl-4">dump</span><span class="hl-1">/</span><span class="hl-4">partial</span><span class="hl-1">/{</span><span class="hl-4">symbol</span><span class="hl-1">}</span><span class="hl-4">_partial</span><span class="hl-1">.</span><span class="hl-4">json</span>
</code><button>Copy</button></pre>

<p>Example file content:</p>
<pre><code class="json"><span class="hl-1">{</span><br/><span class="hl-1">  </span><span class="hl-11">&quot;signal-uuid-1&quot;</span><span class="hl-1">: {</span><br/><span class="hl-1">    </span><span class="hl-11">&quot;profitLevels&quot;</span><span class="hl-1">: [</span><span class="hl-6">10</span><span class="hl-1">, </span><span class="hl-6">20</span><span class="hl-1">],</span><br/><span class="hl-1">    </span><span class="hl-11">&quot;lossLevels&quot;</span><span class="hl-1">: []</span><br/><span class="hl-1">  },</span><br/><span class="hl-1">  </span><span class="hl-11">&quot;signal-uuid-2&quot;</span><span class="hl-1">: {</span><br/><span class="hl-1">    </span><span class="hl-11">&quot;profitLevels&quot;</span><span class="hl-1">: [],</span><br/><span class="hl-1">    </span><span class="hl-11">&quot;lossLevels&quot;</span><span class="hl-1">: [</span><span class="hl-6">10</span><span class="hl-1">]</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<a id="recovery-flow" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Recovery Flow<a href="#recovery-flow" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><img src="../media/36-partial-profit-and-loss_4.svg" alt="Mermaid Diagram"></p>
<p><strong>Atomic Write Pattern</strong>: <code>PersistPartialAdapter</code> uses the same atomic write mechanism as <code>PersistSignalAdapter</code> - write to temp file, then rename to ensure no corruption on crash.</p>
<hr>
<a id="implementation-details" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Implementation Details<a href="#implementation-details" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><a id="level-detection-algorithm" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Level Detection Algorithm<a href="#level-detection-algorithm" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>The <code>profit()</code> method in <code>ClientPartial</code> implements milestone detection:</p>
<pre><code class="typescript"><span class="hl-5">// Simplified from src/client/ClientPartial.ts:150-200</span><br/><span class="hl-4">async</span><span class="hl-1"> </span><span class="hl-0">profit</span><span class="hl-1">(</span><span class="hl-4">symbol</span><span class="hl-1">: </span><span class="hl-4">string</span><span class="hl-1">, </span><span class="hl-4">data</span><span class="hl-1">: </span><span class="hl-4">ISignalRow</span><span class="hl-1">, </span><span class="hl-4">currentPrice</span><span class="hl-1">: </span><span class="hl-4">number</span><span class="hl-1">, </span><br/><span class="hl-1">             </span><span class="hl-4">revenuePercent</span><span class="hl-1">: </span><span class="hl-4">number</span><span class="hl-1">, </span><span class="hl-4">backtest</span><span class="hl-1">: </span><span class="hl-4">boolean</span><span class="hl-1">, </span><span class="hl-4">when</span><span class="hl-1">: </span><span class="hl-4">Date</span><span class="hl-1">) {</span><br/><span class="hl-1">  </span><br/><span class="hl-1">  </span><span class="hl-5">// Get or create state for this signal</span><br/><span class="hl-1">  </span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">state</span><span class="hl-1"> = </span><span class="hl-7">this</span><span class="hl-1">.</span><span class="hl-4">_states</span><span class="hl-1">.</span><span class="hl-0">get</span><span class="hl-1">(</span><span class="hl-4">data</span><span class="hl-1">.</span><span class="hl-4">id</span><span class="hl-1">) || { </span><br/><span class="hl-1">    </span><span class="hl-4">profitLevels:</span><span class="hl-1"> </span><span class="hl-7">new</span><span class="hl-1"> </span><span class="hl-0">Set</span><span class="hl-1">(), </span><br/><span class="hl-1">    </span><span class="hl-4">lossLevels:</span><span class="hl-1"> </span><span class="hl-7">new</span><span class="hl-1"> </span><span class="hl-0">Set</span><span class="hl-1">() </span><br/><span class="hl-1">  };</span><br/><span class="hl-1">  </span><br/><span class="hl-1">  </span><span class="hl-5">// Determine which levels have been crossed</span><br/><span class="hl-1">  </span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">levelsToEmit</span><span class="hl-1">: </span><span class="hl-13">PartialLevel</span><span class="hl-1">[] = [];</span><br/><span class="hl-1">  </span><span class="hl-3">for</span><span class="hl-1"> (</span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">level</span><span class="hl-1"> </span><span class="hl-7">of</span><span class="hl-1"> [</span><span class="hl-6">10</span><span class="hl-1">, </span><span class="hl-6">20</span><span class="hl-1">, </span><span class="hl-6">30</span><span class="hl-1">, </span><span class="hl-6">40</span><span class="hl-1">, </span><span class="hl-6">50</span><span class="hl-1">, </span><span class="hl-6">60</span><span class="hl-1">, </span><span class="hl-6">70</span><span class="hl-1">, </span><span class="hl-6">80</span><span class="hl-1">, </span><span class="hl-6">90</span><span class="hl-1">, </span><span class="hl-6">100</span><span class="hl-1">]) {</span><br/><span class="hl-1">    </span><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-4">revenuePercent</span><span class="hl-1"> &gt;= </span><span class="hl-4">level</span><span class="hl-1"> &amp;&amp; !</span><span class="hl-4">state</span><span class="hl-1">.</span><span class="hl-4">profitLevels</span><span class="hl-1">.</span><span class="hl-0">has</span><span class="hl-1">(</span><span class="hl-4">level</span><span class="hl-1">)) {</span><br/><span class="hl-1">      </span><span class="hl-4">state</span><span class="hl-1">.</span><span class="hl-4">profitLevels</span><span class="hl-1">.</span><span class="hl-0">add</span><span class="hl-1">(</span><span class="hl-4">level</span><span class="hl-1">);</span><br/><span class="hl-1">      </span><span class="hl-4">levelsToEmit</span><span class="hl-1">.</span><span class="hl-0">push</span><span class="hl-1">(</span><span class="hl-4">level</span><span class="hl-1">);</span><br/><span class="hl-1">    }</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">  </span><br/><span class="hl-1">  </span><span class="hl-5">// Emit events for new levels only</span><br/><span class="hl-1">  </span><span class="hl-3">for</span><span class="hl-1"> (</span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">level</span><span class="hl-1"> </span><span class="hl-7">of</span><span class="hl-1"> </span><span class="hl-4">levelsToEmit</span><span class="hl-1">) {</span><br/><span class="hl-1">    </span><span class="hl-7">this</span><span class="hl-1">.</span><span class="hl-4">params</span><span class="hl-1">.</span><span class="hl-0">onProfit</span><span class="hl-1">(</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">data</span><span class="hl-1">, </span><span class="hl-4">currentPrice</span><span class="hl-1">, </span><span class="hl-4">level</span><span class="hl-1">, </span><span class="hl-4">backtest</span><span class="hl-1">, </span><span class="hl-4">when</span><span class="hl-1">.</span><span class="hl-0">getTime</span><span class="hl-1">());</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">  </span><br/><span class="hl-1">  </span><span class="hl-5">// Persist updated state</span><br/><span class="hl-1">  </span><span class="hl-7">this</span><span class="hl-1">.</span><span class="hl-4">_states</span><span class="hl-1">.</span><span class="hl-0">set</span><span class="hl-1">(</span><span class="hl-4">data</span><span class="hl-1">.</span><span class="hl-4">id</span><span class="hl-1">, </span><span class="hl-4">state</span><span class="hl-1">);</span><br/><span class="hl-1">  </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-7">this</span><span class="hl-1">.</span><span class="hl-0">persist</span><span class="hl-1">(</span><span class="hl-4">symbol</span><span class="hl-1">);</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<p><strong>Key Property</strong>: Once a level is added to the Set, it cannot be re-added, ensuring each milestone is reported exactly once per signal.</p>
<hr>
<a id="performance-considerations" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Performance Considerations<a href="#performance-considerations" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><a id="memoization-strategy" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Memoization Strategy<a href="#memoization-strategy" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><table>
<thead>
<tr>
<th>Service</th>
<th>Memoization Key</th>
<th>Cache Scope</th>
<th>Rationale</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>PartialConnectionService.getPartial()</code></td>
<td><code>symbol</code></td>
<td>Per symbol</td>
<td>Shared across all strategies trading same symbol</td>
</tr>
<tr>
<td><code>PartialMarkdownService.getStorage()</code></td>
<td><code>symbol:strategyName</code></td>
<td>Per symbol-strategy pair</td>
<td>Separate reports for each strategy</td>
</tr>
</tbody>
</table>
<a id="memory-management" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Memory Management<a href="#memory-management" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><ul>
<li><strong>In-Memory State</strong>: <code>_states</code> Map grows with number of active signals, cleared on signal close via <code>clear()</code></li>
<li><strong>Event Storage</strong>: Bounded at MAX_EVENTS = 250 per symbol-strategy pair in <code>PartialMarkdownService</code></li>
<li><strong>Persistence</strong>: JSON file size grows with concurrent active signals, not cumulative signal count</li>
</ul>
<a id="event-emission-overhead" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Event Emission Overhead<a href="#event-emission-overhead" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Partial events are emitted frequently during active signal monitoring (potentially every <code>tick()</code> call when price moves through thresholds). The queued processing pattern in listener functions ensures sequential execution without blocking the main monitoring loop.</p>
</div></div><div class="col-sidebar"><div class="page-menu"><div class="tsd-navigation settings"><details class="tsd-accordion"><summary class="tsd-accordion-summary"><h3><svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-chevronDown"></use></svg>Settings</h3></summary><div class="tsd-accordion-details"><div class="tsd-filter-visibility"><span class="settings-label">Member Visibility</span><ul id="tsd-filter-options"><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-protected" name="protected"/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Protected</span></label></li><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-inherited" name="inherited" checked/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Inherited</span></label></li><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-external" name="external"/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>External</span></label></li></ul></div><div class="tsd-theme-toggle"><label class="settings-label" for="tsd-theme">Theme</label><select id="tsd-theme"><option value="os">OS</option><option value="light">Light</option><option value="dark">Dark</option></select></div></div></details></div><details open class="tsd-accordion tsd-page-navigation"><summary class="tsd-accordion-summary"><h3><svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-chevronDown"></use></svg>On This Page</h3></summary><div class="tsd-accordion-details"><a href="#partial-profit-and-loss"><span>Partial <wbr/>Profit and <wbr/>Loss</span></a><ul><li><a href="#system-purpose-and-architecture"><span>System <wbr/>Purpose and <wbr/>Architecture</span></a></li><li><a href="#component-architecture"><span>Component <wbr/>Architecture</span></a></li><li><a href="#milestone-level-enumeration"><span>Milestone <wbr/>Level <wbr/>Enumeration</span></a></li><li><a href="#ipartial-interface-and-methods"><span>IPartial <wbr/>Interface and <wbr/>Methods</span></a></li><li><a href="#state-management-and-persistence"><span>State <wbr/>Management and <wbr/>Persistence</span></a></li><li><ul><li><a href="#ipartialstate-internal-structure"><span>IPartial<wbr/>State <wbr/>Internal <wbr/>Structure</span></a></li><li><a href="#serialization-via-ipartialdata"><span>Serialization via IPartial<wbr/>Data</span></a></li></ul></li><li><a href="#integration-with-clientstrategy"><span>Integration with <wbr/>Client<wbr/>Strategy</span></a></li><li><a href="#event-emission-contracts"><span>Event <wbr/>Emission <wbr/>Contracts</span></a></li><li><ul><li><a href="#partialprofitcontract"><span>Partial<wbr/>Profit<wbr/>Contract</span></a></li><li><a href="#partiallosscontract"><span>Partial<wbr/>Loss<wbr/>Contract</span></a></li></ul></li><li><a href="#partialconnectionservice-factory"><span>Partial<wbr/>Connection<wbr/>Service <wbr/>Factory</span></a></li><li><a href="#markdown-reporting"><span>Markdown <wbr/>Reporting</span></a></li><li><ul><li><a href="#partialmarkdownservice-architecture"><span>Partial<wbr/>Markdown<wbr/>Service <wbr/>Architecture</span></a></li><li><a href="#partialstatistics-structure"><span>Partial<wbr/>Statistics <wbr/>Structure</span></a></li><li><a href="#report-table-columns"><span>Report <wbr/>Table <wbr/>Columns</span></a></li></ul></li><li><a href="#usage-examples"><span>Usage <wbr/>Examples</span></a></li><li><ul><li><a href="#listening-to-partial-events"><span>Listening to <wbr/>Partial <wbr/>Events</span></a></li><li><a href="#generating-partial-reports"><span>Generating <wbr/>Partial <wbr/>Reports</span></a></li></ul></li><li><a href="#strategy-callback-integration"><span>Strategy <wbr/>Callback <wbr/>Integration</span></a></li><li><a href="#persistence-and-crash-recovery"><span>Persistence and <wbr/>Crash <wbr/>Recovery</span></a></li><li><ul><li><a href="#file-structure"><span>File <wbr/>Structure</span></a></li><li><a href="#recovery-flow"><span>Recovery <wbr/>Flow</span></a></li></ul></li><li><a href="#implementation-details"><span>Implementation <wbr/>Details</span></a></li><li><ul><li><a href="#level-detection-algorithm"><span>Level <wbr/>Detection <wbr/>Algorithm</span></a></li></ul></li><li><a href="#performance-considerations"><span>Performance <wbr/>Considerations</span></a></li><li><ul><li><a href="#memoization-strategy"><span>Memoization <wbr/>Strategy</span></a></li><li><a href="#memory-management"><span>Memory <wbr/>Management</span></a></li><li><a href="#event-emission-overhead"><span>Event <wbr/>Emission <wbr/>Overhead</span></a></li></ul></li></ul></div></details></div><div class="site-menu"><nav class="tsd-navigation"><a href="../modules.html">backtest-kit</a><ul class="tsd-small-nested-navigation" id="tsd-nav-container"><li>Loading...</li></ul></nav></div></div></div><footer><p class="tsd-generator">Generated using <a href="https://typedoc.org/" target="_blank">TypeDoc</a></p></footer><div class="overlay"></div></body></html>

<!-- Yandex.Metrika counter -->
<script type="text/javascript">
    (function(m,e,t,r,i,k,a){
        m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
        m[i].l=1*new Date();
        for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }}
        k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)
    })(window, document,'script','https://mc.yandex.ru/metrika/tag.js?id=105455585', 'ym');

    ym(105455585, 'init', {ssr:true, webvisor:true, clickmap:true, ecommerce:"dataLayer", accurateTrackBounce:true, trackLinks:true});
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/105455585" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
<!-- /Yandex.Metrika counter -->

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-3MQZEBBDDR"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-3MQZEBBDDR');
</script>
