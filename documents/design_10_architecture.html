<!DOCTYPE html><html class="default" lang="en" data-base=".."><head><meta charset="utf-8"/><meta http-equiv="x-ua-compatible" content="IE=edge"/><title>design/10_architecture | backtest-kit</title><meta name="description" content="Documentation for backtest-kit"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="stylesheet" href="../assets/style.css"/><link rel="stylesheet" href="../assets/highlight.css"/><script defer src="../assets/main.js"></script><script async src="../assets/icons.js" id="tsd-icons-script"></script><script async src="../assets/search.js" id="tsd-search-script"></script><script async src="../assets/navigation.js" id="tsd-nav-script"></script><script async src="../assets/hierarchy.js" id="tsd-hierarchy-script"></script></head><body><script>document.documentElement.dataset.theme = localStorage.getItem("tsd-theme") || "os";document.body.style.display="none";setTimeout(() => app?app.showPage():document.body.style.removeProperty("display"),500)</script><header class="tsd-page-toolbar"><div class="tsd-toolbar-contents container"><div class="table-cell" id="tsd-search"><div class="field"><label for="tsd-search-field" class="tsd-widget tsd-toolbar-icon search no-caption"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-search"></use></svg></label><input type="text" id="tsd-search-field" aria-label="Search"/></div><div class="field"><div id="tsd-toolbar-links"></div></div><ul class="results"><li class="state loading">Preparing search index...</li><li class="state failure">The search index is not available</li></ul><a href="../index.html" class="title">backtest-kit</a></div><div class="table-cell" id="tsd-widgets"><a href="#" class="tsd-widget tsd-toolbar-icon menu no-caption" data-toggle="menu" aria-label="Menu"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-menu"></use></svg></a></div></div></header><div class="container container-main"><div class="col-content"><div class="tsd-page-title"><ul class="tsd-breadcrumb"><li><a href="../modules.html">backtest-kit</a></li><li><a href="design_10_architecture.html">design/10_architecture</a></li></ul></div><div class="tsd-panel tsd-typography"><a id="architecture" class="tsd-anchor"></a><h1 class="tsd-anchor-link">Architecture<a href="#architecture" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h1><p>This document describes the overall architecture of backtest-kit, including its layered design, dependency injection system, context propagation mechanisms, and event-driven patterns. The architecture is designed to support three execution modes (Backtest, Live, Walker) while maintaining temporal isolation, crash recovery, and clean separation of concerns.</p>
<p>For detailed information about specific architectural components:</p>
<ul>
<li>Layer-specific responsibilities and interactions, see <a href="design_11_layer_responsibilities.html">Layer Responsibilities</a></li>
<li>Dependency injection container implementation, see <a href="design_12_dependency_injection_system.html">Dependency Injection System</a></li>
<li>Context propagation with AsyncLocalStorage, see <a href="design_13_context_propagation.html">Context Propagation</a></li>
<li>Event emitters and listener functions, see <a href="design_14_event_system.html">Event System</a></li>
</ul>
<a id="system-overview" class="tsd-anchor"></a><h2 class="tsd-anchor-link">System Overview<a href="#system-overview" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>backtest-kit implements a <strong>layered service architecture</strong> with dependency injection and context propagation. The system consists of approximately 50+ services organized into distinct layers, each with specific responsibilities. Services are instantiated lazily via a custom DI container and communicate through well-defined interfaces.</p>
<p>The architecture supports three primary execution modes:</p>
<ul>
<li><strong>Backtest</strong>: Historical simulation with temporal isolation (prevents look-ahead bias)</li>
<li><strong>Live</strong>: Real-time trading with crash-safe persistence (atomic file writes)</li>
<li><strong>Walker</strong>: Strategy comparison with metric-based ranking</li>
</ul>
<a id="architectural-layers" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Architectural Layers<a href="#architectural-layers" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><img src="../media/10_Architecture_0.svg" alt="Mermaid Diagram"></p>
<a id="service-registration-and-resolution" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Service Registration and Resolution<a href="#service-registration-and-resolution" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>The system uses a custom dependency injection container that maps TYPES symbols to service factory functions. All services are registered at module load time and instantiated lazily on first access.</p>
<p><img src="../media/10_Architecture_1.svg" alt="Mermaid Diagram"></p>
<p><strong>Example Registration:</strong></p>
<pre><code class="typescript"><span class="hl-5">// In provide.ts</span><br/><span class="hl-0">provide</span><span class="hl-1">(</span><span class="hl-8">TYPES</span><span class="hl-1">.</span><span class="hl-4">strategySchemaService</span><span class="hl-1">, () </span><span class="hl-7">=&gt;</span><span class="hl-1"> </span><span class="hl-7">new</span><span class="hl-1"> </span><span class="hl-0">StrategySchemaService</span><span class="hl-1">());</span><br/><span class="hl-0">provide</span><span class="hl-1">(</span><span class="hl-8">TYPES</span><span class="hl-1">.</span><span class="hl-4">strategyConnectionService</span><span class="hl-1">, () </span><span class="hl-7">=&gt;</span><span class="hl-1"> </span><span class="hl-7">new</span><span class="hl-1"> </span><span class="hl-0">StrategyConnectionService</span><span class="hl-1">());</span><br/><br/><span class="hl-5">// In index.ts</span><br/><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">strategySchemaService</span><span class="hl-1"> = </span><span class="hl-0">inject</span><span class="hl-1">&lt;</span><span class="hl-11">StrategySchemaService</span><span class="hl-1">&gt;(</span><span class="hl-8">TYPES</span><span class="hl-1">.</span><span class="hl-4">strategySchemaService</span><span class="hl-1">);</span><br/><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">strategyConnectionService</span><span class="hl-1"> = </span><span class="hl-0">inject</span><span class="hl-1">&lt;</span><span class="hl-11">StrategyConnectionService</span><span class="hl-1">&gt;(</span><span class="hl-8">TYPES</span><span class="hl-1">.</span><span class="hl-4">strategyConnectionService</span><span class="hl-1">);</span>
</code><button type="button">Copy</button></pre>

<a id="architectural-patterns" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Architectural Patterns<a href="#architectural-patterns" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><a id="1-layered-service-architecture" class="tsd-anchor"></a><h3 class="tsd-anchor-link">1. Layered Service Architecture<a href="#1-layered-service-architecture" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Each layer has specific responsibilities and communicates only with adjacent layers. This enforces separation of concerns and makes the system easier to test and maintain.</p>
<table>
<thead>
<tr>
<th>Layer</th>
<th>Responsibility</th>
<th>Examples</th>
<th>Communication</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Public API</strong></td>
<td>User-facing functions</td>
<td><code>addStrategy()</code>, <code>listenSignal()</code></td>
<td>Calls Validation + Schema</td>
</tr>
<tr>
<td><strong>Utility Classes</strong></td>
<td>Execution control</td>
<td><code>Backtest</code>, <code>Live</code>, <code>Walker</code></td>
<td>Calls Command Services</td>
</tr>
<tr>
<td><strong>Command</strong></td>
<td>Workflow orchestration</td>
<td><code>BacktestCommandService</code></td>
<td>Calls Logic Public</td>
</tr>
<tr>
<td><strong>Logic Public</strong></td>
<td>API wrappers with validation</td>
<td><code>BacktestLogicPublicService</code></td>
<td>Calls Logic Private</td>
</tr>
<tr>
<td><strong>Logic Private</strong></td>
<td>Internal algorithms</td>
<td><code>BacktestLogicPrivateService</code></td>
<td>Calls Global + Core + Context</td>
</tr>
<tr>
<td><strong>Global</strong></td>
<td>Subsystem facades</td>
<td><code>RiskGlobalService</code></td>
<td>Calls Connection + Validation</td>
</tr>
<tr>
<td><strong>Core</strong></td>
<td>Domain logic</td>
<td><code>StrategyCoreService</code></td>
<td>Calls Connection</td>
</tr>
<tr>
<td><strong>Connection</strong></td>
<td>Factory + Memoization</td>
<td><code>StrategyConnectionService</code></td>
<td>Creates Clients</td>
</tr>
<tr>
<td><strong>Schema</strong></td>
<td>Configuration storage</td>
<td><code>StrategySchemaService</code></td>
<td>ToolRegistry pattern</td>
</tr>
<tr>
<td><strong>Validation</strong></td>
<td>Business rules</td>
<td><code>StrategyValidationService</code></td>
<td>Enforces constraints</td>
</tr>
<tr>
<td><strong>Markdown</strong></td>
<td>Report generation</td>
<td><code>BacktestMarkdownService</code></td>
<td>Subscribes to events</td>
</tr>
<tr>
<td><strong>Client</strong></td>
<td>Business logic execution</td>
<td><code>ClientStrategy</code></td>
<td>Uses Context</td>
</tr>
<tr>
<td><strong>Context</strong></td>
<td>Implicit parameters</td>
<td><code>ExecutionContextService</code></td>
<td>AsyncLocalStorage</td>
</tr>
</tbody>
</table>
<a id="2-factory-pattern-with-memoization" class="tsd-anchor"></a><h3 class="tsd-anchor-link">2. Factory Pattern with Memoization<a href="#2-factory-pattern-with-memoization" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Connection services use factory pattern to create client instances. Memoization ensures proper instance isolation based on composite keys.</p>
<p><img src="../media/10_Architecture_2.svg" alt="Mermaid Diagram"></p>
<p><strong>Key Construction Examples:</strong></p>
<ul>
<li>Backtest strategy: <code>&quot;BTCUSDT:my-strategy:true&quot;</code></li>
<li>Live strategy: <code>&quot;BTCUSDT:my-strategy:false&quot;</code></li>
<li>Different symbols: <code>&quot;ETHUSDT:my-strategy:true&quot;</code> (separate instance)</li>
</ul>
<p>This ensures that:</p>
<ul>
<li>Backtest and live modes use separate instances (prevent state contamination)</li>
<li>Each symbol gets its own instance (parallel execution support)</li>
<li>Multiple strategies can share risk/sizing instances (portfolio-level analysis)</li>
</ul>
<a id="3-context-propagation-with-asynclocalstorage" class="tsd-anchor"></a><h3 class="tsd-anchor-link">3. Context Propagation with AsyncLocalStorage<a href="#3-context-propagation-with-asynclocalstorage" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Two scoped services provide implicit parameter passing without manual threading:</p>
<p><img src="../media/10_Architecture_3.svg" alt="Mermaid Diagram"></p>
<p><strong>ExecutionContextService</strong> provides runtime parameters:</p>
<ul>
<li><code>symbol</code>: Trading pair (e.g., &quot;BTCUSDT&quot;)</li>
<li><code>when</code>: Current timestamp for operations</li>
<li><code>backtest</code>: Boolean flag for mode detection</li>
</ul>
<p><strong>MethodContextService</strong> provides schema selection:</p>
<ul>
<li><code>strategyName</code>: Which strategy to use</li>
<li><code>exchangeName</code>: Which exchange to use</li>
<li><code>frameName</code>: Which frame to use (empty for live)</li>
</ul>
<p>This pattern eliminates the need to pass these parameters explicitly through every function call.</p>
<a id="4-event-driven-architecture-with-rxjs" class="tsd-anchor"></a><h3 class="tsd-anchor-link">4. Event-Driven Architecture with RxJS<a href="#4-event-driven-architecture-with-rxjs" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>The system uses RxJS Subjects as a central event bus for decoupled communication between components.</p>
<p><img src="../media/10_Architecture_4.svg" alt="Mermaid Diagram"></p>
<p><strong>Event Hierarchy:</strong></p>
<ul>
<li><code>signalEmitter</code>: Broadcasts ALL signals (backtest + live)</li>
<li><code>signalBacktestEmitter</code>: Backtest-only signals</li>
<li><code>signalLiveEmitter</code>: Live-only signals</li>
</ul>
<p>This allows subscribers to listen at different granularities without tight coupling to execution logic.</p>
<p><strong>Queued Processing:</strong>
All listener callbacks are wrapped with <code>queued()</code> from functools-kit, ensuring sequential execution even for async handlers. This prevents race conditions in event processing.</p>
<a id="data-flow-backtest-execution" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Data Flow: Backtest Execution<a href="#data-flow-backtest-execution" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>The following diagram shows how data flows through the system during a backtest execution:</p>
<p><img src="../media/10_Architecture_5.svg" alt="Mermaid Diagram"></p>
<p><strong>Key Observations:</strong></p>
<ol>
<li><strong>MethodContextService</strong> wraps the generator to provide schema context</li>
<li><strong>ExecutionContextService</strong> wraps each tick to provide runtime context</li>
<li><strong>Connection Services</strong> provide memoized client instances</li>
<li><strong>ClientStrategy</strong> orchestrates signal logic and emits events</li>
<li><strong>Event emitters</strong> enable parallel data collection (markdown, user callbacks)</li>
</ol>
<a id="design-principles" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Design Principles<a href="#design-principles" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><a id="temporal-isolation" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Temporal Isolation<a href="#temporal-isolation" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><strong>ExecutionContextService</strong> enforces temporal isolation by controlling which timestamp is &quot;current&quot; for all operations. During backtesting, <code>when</code> is set to the candle timestamp being processed. During live trading, <code>when</code> is set to <code>Date.now()</code>.</p>
<p><strong>ClientExchange.getCandles()</strong> uses the context's <code>when</code> value to fetch historical candles:</p>
<ul>
<li>In backtest mode: Fetches candles BEFORE the context timestamp (prevents look-ahead bias)</li>
<li>In live mode: Fetches most recent candles up to <code>Date.now()</code></li>
</ul>
<p>This ensures strategies cannot access &quot;future&quot; data during backtesting, making backtest results realistic.</p>
<a id="crash-safe-persistence" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Crash-Safe Persistence<a href="#crash-safe-persistence" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><strong>PersistBase</strong> abstract class provides atomic file writes using the temp-rename pattern:</p>
<ol>
<li>Write data to temporary file: <code>signal.json.tmp</code></li>
<li>Call <code>fsync()</code> to ensure disk write</li>
<li>Rename temp file to final: <code>signal.json</code></li>
<li>OS guarantees rename is atomic</li>
</ol>
<p>Multiple persistence adapters extend <code>PersistBase</code>:</p>
<ul>
<li><strong>PersistSignalAdapter</strong>: Active signals per symbol/strategy</li>
<li><strong>PersistRiskAdapter</strong>: Portfolio state per risk profile</li>
<li><strong>PersistScheduleAdapter</strong>: Scheduled signals per symbol/strategy</li>
<li><strong>PersistPartialAdapter</strong>: Profit/loss milestone tracking per symbol/strategy</li>
</ul>
<p>Each adapter has separate file paths to prevent cross-contamination. On restart, <code>waitForInit()</code> loads state from disk files.</p>
<a id="type-safe-discriminated-unions" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Type-Safe Discriminated Unions<a href="#type-safe-discriminated-unions" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Signal state machine uses TypeScript discriminated unions for type-safe state handling:</p>
<pre><code class="typescript"><span class="hl-7">type</span><span class="hl-1"> </span><span class="hl-11">IStrategyTickResult</span><span class="hl-1"> = </span><br/><span class="hl-1">  | </span><span class="hl-11">IStrategyTickResultIdle</span><span class="hl-1">       </span><span class="hl-5">// action: &quot;idle&quot;</span><br/><span class="hl-1">  | </span><span class="hl-11">IStrategyTickResultScheduled</span><span class="hl-1">  </span><span class="hl-5">// action: &quot;scheduled&quot;</span><br/><span class="hl-1">  | </span><span class="hl-11">IStrategyTickResultOpened</span><span class="hl-1">     </span><span class="hl-5">// action: &quot;opened&quot;</span><br/><span class="hl-1">  | </span><span class="hl-11">IStrategyTickResultActive</span><span class="hl-1">     </span><span class="hl-5">// action: &quot;active&quot;</span><br/><span class="hl-1">  | </span><span class="hl-11">IStrategyTickResultClosed</span><span class="hl-1">     </span><span class="hl-5">// action: &quot;closed&quot;</span><br/><span class="hl-1">  | </span><span class="hl-11">IStrategyTickResultCancelled</span><span class="hl-1">  </span><span class="hl-5">// action: &quot;cancelled&quot;</span>
</code><button type="button">Copy</button></pre>

<p>Each state has distinct properties. TypeScript narrows the type based on the <code>action</code> discriminator:</p>
<pre><code class="typescript"><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-4">result</span><span class="hl-1">.</span><span class="hl-4">action</span><span class="hl-1"> === </span><span class="hl-2">&quot;closed&quot;</span><span class="hl-1">) {</span><br/><span class="hl-1">  </span><span class="hl-5">// TypeScript knows result is IStrategyTickResultClosed</span><br/><span class="hl-1">  </span><span class="hl-4">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-4">result</span><span class="hl-1">.</span><span class="hl-4">pnl</span><span class="hl-1">.</span><span class="hl-4">pnlPercentage</span><span class="hl-1">);  </span><span class="hl-5">// OK</span><br/><span class="hl-1">  </span><span class="hl-4">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-4">result</span><span class="hl-1">.</span><span class="hl-4">closeReason</span><span class="hl-1">);         </span><span class="hl-5">// OK</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<p>This prevents accessing properties that don't exist in the current state, catching bugs at compile time.</p>
<a id="memoized-service-instantiation" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Memoized Service Instantiation<a href="#memoized-service-instantiation" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Connection services use memoization to ensure singleton behavior per composite key:</p>
<pre><code class="typescript"><span class="hl-5">// StrategyConnectionService.getStrategy() pseudo-code</span><br/><span class="hl-0">getStrategy</span><span class="hl-1">(</span><span class="hl-4">symbol</span><span class="hl-1">: </span><span class="hl-4">string</span><span class="hl-1">, </span><span class="hl-4">strategyName</span><span class="hl-1">: </span><span class="hl-4">string</span><span class="hl-1">, </span><span class="hl-4">backtest</span><span class="hl-1">: </span><span class="hl-4">boolean</span><span class="hl-1">) {</span><br/><span class="hl-1">  </span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">key</span><span class="hl-1"> = </span><span class="hl-2">`</span><span class="hl-7">${</span><span class="hl-4">symbol</span><span class="hl-7">}</span><span class="hl-2">:</span><span class="hl-7">${</span><span class="hl-4">strategyName</span><span class="hl-7">}</span><span class="hl-2">:</span><span class="hl-7">${</span><span class="hl-4">backtest</span><span class="hl-7">}</span><span class="hl-2">`</span><span class="hl-1">;</span><br/><span class="hl-1">  </span><br/><span class="hl-1">  </span><span class="hl-3">if</span><span class="hl-1"> (!</span><span class="hl-7">this</span><span class="hl-1">.</span><span class="hl-4">cache</span><span class="hl-1">.</span><span class="hl-0">has</span><span class="hl-1">(</span><span class="hl-4">key</span><span class="hl-1">)) {</span><br/><span class="hl-1">    </span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">schema</span><span class="hl-1"> = </span><span class="hl-7">this</span><span class="hl-1">.</span><span class="hl-4">schemaService</span><span class="hl-1">.</span><span class="hl-0">retrieve</span><span class="hl-1">(</span><span class="hl-4">strategyName</span><span class="hl-1">);</span><br/><span class="hl-1">    </span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">instance</span><span class="hl-1"> = </span><span class="hl-7">new</span><span class="hl-1"> </span><span class="hl-0">ClientStrategy</span><span class="hl-1">({</span><br/><span class="hl-1">      ...</span><span class="hl-4">schema</span><span class="hl-1">,</span><br/><span class="hl-1">      </span><span class="hl-4">logger:</span><span class="hl-1"> </span><span class="hl-7">this</span><span class="hl-1">.</span><span class="hl-4">logger</span><span class="hl-1">,</span><br/><span class="hl-1">      </span><span class="hl-4">execution:</span><span class="hl-1"> </span><span class="hl-7">this</span><span class="hl-1">.</span><span class="hl-4">executionContextService</span><span class="hl-1">,</span><br/><span class="hl-1">      </span><span class="hl-5">// ... other dependencies</span><br/><span class="hl-1">    });</span><br/><span class="hl-1">    </span><span class="hl-7">this</span><span class="hl-1">.</span><span class="hl-4">cache</span><span class="hl-1">.</span><span class="hl-0">set</span><span class="hl-1">(</span><span class="hl-4">key</span><span class="hl-1">, </span><span class="hl-4">instance</span><span class="hl-1">);</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">  </span><br/><span class="hl-1">  </span><span class="hl-3">return</span><span class="hl-1"> </span><span class="hl-7">this</span><span class="hl-1">.</span><span class="hl-4">cache</span><span class="hl-1">.</span><span class="hl-0">get</span><span class="hl-1">(</span><span class="hl-4">key</span><span class="hl-1">);</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<p>This pattern:</p>
<ul>
<li>Prevents duplicate instantiation (performance)</li>
<li>Maintains state per key (correctness)</li>
<li>Supports parallel execution (isolation)</li>
</ul>
<a id="component-interaction-example-risk-management" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Component Interaction Example: Risk Management<a href="#component-interaction-example-risk-management" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>The following diagram shows how risk management integrates across layers:</p>
<p><img src="../media/10_Architecture_6.svg" alt="Mermaid Diagram"></p>
<p><strong>Key Interactions:</strong></p>
<ol>
<li><strong>Registration</strong>: User calls <code>addRisk()</code> → validates → stores in SchemaService</li>
<li><strong>Instantiation</strong>: ClientStrategy requests ClientRisk → ConnectionService checks cache → creates if needed</li>
<li><strong>State Loading</strong>: ClientRisk calls <code>waitForInit()</code> → PersistRiskAdapter loads from disk</li>
<li><strong>Validation</strong>: ClientRisk runs validation chain → emits event on rejection</li>
<li><strong>State Update</strong>: On signal open/close → ClientRisk updates portfolio state → persists to disk</li>
</ol>
<a id="summary" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Summary<a href="#summary" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>The backtest-kit architecture is characterized by:</p>
<ol>
<li><strong>Layered Services</strong>: Clear separation of concerns across 9+ service layers</li>
<li><strong>Dependency Injection</strong>: Custom DI container with lazy instantiation and memoization</li>
<li><strong>Context Propagation</strong>: AsyncLocalStorage-based implicit parameter passing</li>
<li><strong>Event-Driven</strong>: RxJS Subjects for decoupled communication with queued processing</li>
<li><strong>Factory Pattern</strong>: Connection services with composite key-based memoization</li>
<li><strong>Temporal Isolation</strong>: Context-aware data access prevents look-ahead bias</li>
<li><strong>Crash Recovery</strong>: Atomic file writes enable graceful recovery from failures</li>
<li><strong>Type Safety</strong>: Discriminated unions for compile-time correctness</li>
</ol>
<p>This architecture enables the framework to support complex trading workflows while maintaining testability, extensibility, and reliability. The layered design ensures that changes to one component (e.g., persistence implementation) do not cascade to unrelated components (e.g., signal generation logic).</p>
</div></div><div class="col-sidebar"><div class="page-menu"><div class="tsd-navigation settings"><details class="tsd-accordion"><summary class="tsd-accordion-summary"><h3><svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-chevronDown"></use></svg>Settings</h3></summary><div class="tsd-accordion-details"><div class="tsd-filter-visibility"><span class="settings-label">Member Visibility</span><ul id="tsd-filter-options"><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-protected" name="protected"/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Protected</span></label></li><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-inherited" name="inherited" checked/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Inherited</span></label></li><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-external" name="external"/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>External</span></label></li></ul></div><div class="tsd-theme-toggle"><label class="settings-label" for="tsd-theme">Theme</label><select id="tsd-theme"><option value="os">OS</option><option value="light">Light</option><option value="dark">Dark</option></select></div></div></details></div><details open class="tsd-accordion tsd-page-navigation"><summary class="tsd-accordion-summary"><h3><svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-chevronDown"></use></svg>On This Page</h3></summary><div class="tsd-accordion-details"><a href="#architecture"><span>Architecture</span></a><ul><li><a href="#system-overview"><span>System <wbr/>Overview</span></a></li><li><ul><li><a href="#architectural-layers"><span>Architectural <wbr/>Layers</span></a></li><li><a href="#service-registration-and-resolution"><span>Service <wbr/>Registration and <wbr/>Resolution</span></a></li></ul></li><li><a href="#architectural-patterns"><span>Architectural <wbr/>Patterns</span></a></li><li><ul><li><a href="#1-layered-service-architecture"><span>1. <wbr/>Layered <wbr/>Service <wbr/>Architecture</span></a></li><li><a href="#2-factory-pattern-with-memoization"><span>2. <wbr/>Factory <wbr/>Pattern with <wbr/>Memoization</span></a></li><li><a href="#3-context-propagation-with-asynclocalstorage"><span>3. <wbr/>Context <wbr/>Propagation with <wbr/>Async<wbr/>Local<wbr/>Storage</span></a></li><li><a href="#4-event-driven-architecture-with-rxjs"><span>4. <wbr/>Event-<wbr/>Driven <wbr/>Architecture with <wbr/>RxJS</span></a></li></ul></li><li><a href="#data-flow-backtest-execution"><span>Data <wbr/>Flow: <wbr/>Backtest <wbr/>Execution</span></a></li><li><a href="#design-principles"><span>Design <wbr/>Principles</span></a></li><li><ul><li><a href="#temporal-isolation"><span>Temporal <wbr/>Isolation</span></a></li><li><a href="#crash-safe-persistence"><span>Crash-<wbr/>Safe <wbr/>Persistence</span></a></li><li><a href="#type-safe-discriminated-unions"><span>Type-<wbr/>Safe <wbr/>Discriminated <wbr/>Unions</span></a></li><li><a href="#memoized-service-instantiation"><span>Memoized <wbr/>Service <wbr/>Instantiation</span></a></li></ul></li><li><a href="#component-interaction-example-risk-management"><span>Component <wbr/>Interaction <wbr/>Example: <wbr/>Risk <wbr/>Management</span></a></li><li><a href="#summary"><span>Summary</span></a></li></ul></div></details></div><div class="site-menu"><nav class="tsd-navigation"><a href="../modules.html">backtest-kit</a><ul class="tsd-small-nested-navigation" id="tsd-nav-container"><li>Loading...</li></ul></nav></div></div></div><footer><p class="tsd-generator">Generated using <a href="https://typedoc.org/" target="_blank">TypeDoc</a></p></footer><div class="overlay"></div></body></html>

<!-- Yandex.Metrika counter -->
<script type="text/javascript">
    (function(m,e,t,r,i,k,a){
        m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
        m[i].l=1*new Date();
        for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }}
        k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)
    })(window, document,'script','https://mc.yandex.ru/metrika/tag.js?id=105455585', 'ym');

    ym(105455585, 'init', {ssr:true, webvisor:true, clickmap:true, ecommerce:"dataLayer", accurateTrackBounce:true, trackLinks:true});
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/105455585" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
<!-- /Yandex.Metrika counter -->

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-3MQZEBBDDR"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-3MQZEBBDDR');
</script>
