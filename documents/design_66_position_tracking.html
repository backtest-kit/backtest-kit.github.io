<!DOCTYPE html><html class="default" lang="en" data-base=".."><head><meta charset="utf-8"/><meta http-equiv="x-ua-compatible" content="IE=edge"/><title>design/66_position_tracking | backtest-kit</title><meta name="description" content="Documentation for backtest-kit"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="stylesheet" href="../assets/style.css"/><link rel="stylesheet" href="../assets/highlight.css"/><script defer src="../assets/main.js"></script><script async src="../assets/icons.js" id="tsd-icons-script"></script><script async src="../assets/search.js" id="tsd-search-script"></script><script async src="../assets/navigation.js" id="tsd-nav-script"></script><script async src="../assets/hierarchy.js" id="tsd-hierarchy-script"></script></head><body><script>document.documentElement.dataset.theme = localStorage.getItem("tsd-theme") || "os";document.body.style.display="none";setTimeout(() => app?app.showPage():document.body.style.removeProperty("display"),500)</script><header class="tsd-page-toolbar"><div class="tsd-toolbar-contents container"><div class="table-cell" id="tsd-search"><div class="field"><label for="tsd-search-field" class="tsd-widget tsd-toolbar-icon search no-caption"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-search"></use></svg></label><input type="text" id="tsd-search-field" aria-label="Search"/></div><div class="field"><div id="tsd-toolbar-links"></div></div><ul class="results"><li class="state loading">Preparing search index...</li><li class="state failure">The search index is not available</li></ul><a href="../index.html" class="title">backtest-kit</a></div><div class="table-cell" id="tsd-widgets"><a href="#" class="tsd-widget tsd-toolbar-icon menu no-caption" data-toggle="menu" aria-label="Menu"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-menu"></use></svg></a></div></div></header><div class="container container-main"><div class="col-content"><div class="tsd-page-title"><ul class="tsd-breadcrumb"><li><a href="../modules.html">backtest-kit</a></li><li><a href="design_66_position_tracking.html">design/66_position_tracking</a></li></ul></div><div class="tsd-panel tsd-typography"><a id="position-tracking" class="tsd-anchor"></a><h1 class="tsd-anchor-link">Position Tracking<a href="#position-tracking" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h1><a id="purpose-and-scope" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Purpose and Scope<a href="#purpose-and-scope" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>This document explains how the framework tracks active positions for portfolio-level risk management. Position tracking is implemented by <code>ClientRisk</code> and maintains a real-time registry of all open positions across strategies sharing the same risk profile.</p>
<p>For information about risk profile configuration, see <a href="design_64_risk_profiles.html">Risk Profiles</a>. For information about risk validation logic, see <a href="design_65_risk_validation.html">Risk Validation</a>.</p>
<hr>
<a id="overview" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Overview<a href="#overview" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>Position tracking enables cross-strategy risk analysis by maintaining a shared registry of active positions. Multiple <code>ClientStrategy</code> instances sharing the same <code>riskName</code> contribute to a single position count, allowing portfolio-level limits to be enforced across strategies.</p>
<p>The tracking system provides:</p>
<ul>
<li>Real-time position count for validation functions</li>
<li>Crash-safe persistence for live trading</li>
<li>Isolated position registries per risk profile</li>
<li>Efficient lookup via composite keys</li>
</ul>
<p><img src="../media/66_Position_Tracking_0.svg" alt="Mermaid Diagram"></p>
<p><strong>Diagram: Position Sharing Across Strategies</strong></p>
<hr>
<a id="active-position-map-structure" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Active Position Map Structure<a href="#active-position-map-structure" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>The <code>_activePositions</code> field stores active positions in a <code>Map&lt;string, IRiskActivePosition&gt;</code> where keys follow the pattern <code>${strategyName}:${symbol}</code>.</p>
<a id="map-structure" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Map Structure<a href="#map-structure" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><table>
<thead>
<tr>
<th>Component</th>
<th>Type</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td>Key</td>
<td><code>string</code></td>
<td>Composite identifier: <code>&quot;strategyName:symbol&quot;</code></td>
</tr>
<tr>
<td>Value</td>
<td><code>IRiskActivePosition</code></td>
<td>Position metadata including timestamp</td>
</tr>
</tbody>
</table>
<a id="iriskactiveposition-structure" class="tsd-anchor"></a><h3 class="tsd-anchor-link">IRiskActivePosition Structure<a href="#iriskactiveposition-structure" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><pre><code class="typescript"><span class="hl-6">interface</span><span class="hl-1"> </span><span class="hl-10">IRiskActivePosition</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-4">signal</span><span class="hl-1">: </span><span class="hl-10">ISignalRow</span><span class="hl-1">;         </span><span class="hl-5">// Signal details (stored as null in practice)</span><br/><span class="hl-1">  </span><span class="hl-4">strategyName</span><span class="hl-1">: </span><span class="hl-10">string</span><span class="hl-1">;        </span><span class="hl-5">// Strategy owning the position</span><br/><span class="hl-1">  </span><span class="hl-4">exchangeName</span><span class="hl-1">: </span><span class="hl-10">string</span><span class="hl-1">;        </span><span class="hl-5">// Exchange name (empty string in practice)</span><br/><span class="hl-1">  </span><span class="hl-4">openTimestamp</span><span class="hl-1">: </span><span class="hl-10">number</span><span class="hl-1">;       </span><span class="hl-5">// When position was opened (Date.now())</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<a id="key-generator-function" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Key Generator Function<a href="#key-generator-function" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>The framework uses <code>GET_KEY_FN</code> to generate consistent keys:</p>
<pre><code class="typescript"><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-0">GET_KEY_FN</span><span class="hl-1"> = (</span><span class="hl-4">strategyName</span><span class="hl-1">: </span><span class="hl-10">string</span><span class="hl-1">, </span><span class="hl-4">symbol</span><span class="hl-1">: </span><span class="hl-10">string</span><span class="hl-1">) </span><span class="hl-6">=&gt;</span><br/><span class="hl-1">  </span><span class="hl-2">`</span><span class="hl-6">${</span><span class="hl-4">strategyName</span><span class="hl-6">}</span><span class="hl-2">:</span><span class="hl-6">${</span><span class="hl-4">symbol</span><span class="hl-6">}</span><span class="hl-2">`</span><span class="hl-1">;</span>
</code><button type="button">Copy</button></pre>

<p>This pattern ensures:</p>
<ul>
<li>One position per strategy-symbol pair</li>
<li>Deterministic lookup for <code>removeSignal</code> operations</li>
<li>Collision-free keys across strategies</li>
</ul>
<hr>
<a id="position-lifecycle" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Position Lifecycle<a href="#position-lifecycle" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>Positions are registered when signals open and removed when signals close. The lifecycle is managed through <code>addSignal</code> and <code>removeSignal</code> methods.</p>
<a id="position-registration-flow" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Position Registration Flow<a href="#position-registration-flow" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><img src="../media/66_Position_Tracking_1.svg" alt="Mermaid Diagram"></p>
<p><strong>Diagram: Position Registration Sequence</strong></p>
<a id="addsignal-method" class="tsd-anchor"></a><h3 class="tsd-anchor-link">addSignal Method<a href="#addsignal-method" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>The <code>addSignal</code> method registers a new position when a signal opens:</p>
<p><strong>Key steps:</strong></p>
<ol>
<li>Check if initialization needed (first call after instantiation)</li>
<li>Call <code>waitForInit()</code> if <code>_activePositions === POSITION_NEED_FETCH</code></li>
<li>Generate composite key using <code>GET_KEY_FN(strategyName, symbol)</code></li>
<li>Insert position into map with current timestamp</li>
<li>Persist updated positions to disk via <code>_updatePositions()</code></li>
</ol>
<p><strong>Method signature:</strong></p>
<pre><code class="typescript"><span class="hl-4">public</span><span class="hl-1"> </span><span class="hl-4">async</span><span class="hl-1"> </span><span class="hl-0">addSignal</span><span class="hl-1">(</span><br/><span class="hl-1">  </span><span class="hl-4">symbol</span><span class="hl-1">: </span><span class="hl-4">string</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">context</span><span class="hl-1">: { </span><span class="hl-4">strategyName:</span><span class="hl-1"> </span><span class="hl-4">string</span><span class="hl-1">; </span><span class="hl-4">riskName</span><span class="hl-1">: </span><span class="hl-4">string</span><span class="hl-1"> }</span><br/><span class="hl-1">)</span>
</code><button type="button">Copy</button></pre>

<a id="removesignal-method" class="tsd-anchor"></a><h3 class="tsd-anchor-link">removeSignal Method<a href="#removesignal-method" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>The <code>removeSignal</code> method removes a position when a signal closes:</p>
<p><strong>Key steps:</strong></p>
<ol>
<li>Check if initialization needed</li>
<li>Generate same composite key using <code>GET_KEY_FN(strategyName, symbol)</code></li>
<li>Delete entry from map</li>
<li>Persist updated positions to disk via <code>_updatePositions()</code></li>
</ol>
<p><strong>Method signature:</strong></p>
<pre><code class="typescript"><span class="hl-4">public</span><span class="hl-1"> </span><span class="hl-4">async</span><span class="hl-1"> </span><span class="hl-0">removeSignal</span><span class="hl-1">(</span><br/><span class="hl-1">  </span><span class="hl-4">symbol</span><span class="hl-1">: </span><span class="hl-4">string</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">context</span><span class="hl-1">: { </span><span class="hl-4">strategyName:</span><span class="hl-1"> </span><span class="hl-4">string</span><span class="hl-1">; </span><span class="hl-4">riskName</span><span class="hl-1">: </span><span class="hl-4">string</span><span class="hl-1"> }</span><br/><span class="hl-1">)</span>
</code><button type="button">Copy</button></pre>

<hr>
<a id="lazy-initialization-pattern" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Lazy Initialization Pattern<a href="#lazy-initialization-pattern" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>Position tracking uses lazy initialization to defer persistence loading until first use. This optimization prevents unnecessary disk I/O during backtest mode or when risk profiles are unused.</p>
<a id="initialization-states" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Initialization States<a href="#initialization-states" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><img src="../media/66_Position_Tracking_2.svg" alt="Mermaid Diagram"></p>
<p><strong>Diagram: Lazy Initialization State Machine</strong></p>
<a id="wait_for_init_fn" class="tsd-anchor"></a><h3 class="tsd-anchor-link">WAIT_FOR_INIT_FN<a href="#wait_for_init_fn" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>The initialization function is wrapped with <code>singleshot</code> to ensure it executes exactly once:</p>
<pre><code class="typescript"><span class="hl-3">export</span><span class="hl-1"> </span><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-0">WAIT_FOR_INIT_FN</span><span class="hl-1"> = </span><span class="hl-6">async</span><span class="hl-1"> (</span><span class="hl-4">self</span><span class="hl-1">: </span><span class="hl-10">ClientRisk</span><span class="hl-1">): </span><span class="hl-10">Promise</span><span class="hl-1">&lt;</span><span class="hl-10">void</span><span class="hl-1">&gt; </span><span class="hl-6">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-4">self</span><span class="hl-1">.</span><span class="hl-4">params</span><span class="hl-1">.</span><span class="hl-4">logger</span><span class="hl-1">.</span><span class="hl-0">debug</span><span class="hl-1">(</span><span class="hl-2">&quot;ClientRisk waitForInit&quot;</span><span class="hl-1">);</span><br/><span class="hl-1">  </span><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">persistedPositions</span><span class="hl-1"> = </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-4">PersistRiskAdapter</span><span class="hl-1">.</span><span class="hl-0">readPositionData</span><span class="hl-1">(</span><br/><span class="hl-1">    </span><span class="hl-4">self</span><span class="hl-1">.</span><span class="hl-4">params</span><span class="hl-1">.</span><span class="hl-4">riskName</span><br/><span class="hl-1">  );</span><br/><span class="hl-1">  </span><span class="hl-4">self</span><span class="hl-1">.</span><span class="hl-4">_activePositions</span><span class="hl-1"> = </span><span class="hl-6">new</span><span class="hl-1"> </span><span class="hl-0">Map</span><span class="hl-1">(</span><span class="hl-4">persistedPositions</span><span class="hl-1">);</span><br/><span class="hl-1">};</span>
</code><button type="button">Copy</button></pre>

<p><strong>Key characteristics:</strong></p>
<ul>
<li>Exported for testing purposes</li>
<li>Reads persisted positions from disk</li>
<li>Converts array format to Map for efficient lookup</li>
<li>Wrapped in <code>singleshot</code> at line 88 to prevent duplicate initialization</li>
</ul>
<hr>
<a id="persistence-and-recovery" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Persistence and Recovery<a href="#persistence-and-recovery" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>Position data persists to disk after every <code>addSignal</code> and <code>removeSignal</code> operation. This ensures crash safety in live trading where position state must survive restarts.</p>
<a id="persistence-flow" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Persistence Flow<a href="#persistence-flow" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><img src="../media/66_Position_Tracking_3.svg" alt="Mermaid Diagram"></p>
<p><strong>Diagram: Persistence and Recovery Flow</strong></p>
<a id="_updatepositions-method" class="tsd-anchor"></a><h3 class="tsd-anchor-link">_updatePositions Method<a href="#_updatepositions-method" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>The <code>_updatePositions</code> method coordinates persistence after state changes:</p>
<p><strong>Implementation:</strong></p>
<ol>
<li>Check initialization status</li>
<li>Convert Map to array via <code>Array.from(_activePositions)</code></li>
<li>Call <code>PersistRiskAdapter.writePositionData(array, riskName)</code></li>
<li>Atomic write ensures data integrity</li>
</ol>
<a id="data-format" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Data Format<a href="#data-format" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Position data serializes as an array of tuples:</p>
<pre><code class="typescript"><span class="hl-6">type</span><span class="hl-1"> </span><span class="hl-10">PersistedData</span><span class="hl-1"> = </span><span class="hl-10">Array</span><span class="hl-1">&lt;[</span><span class="hl-10">string</span><span class="hl-1">, </span><span class="hl-10">IRiskActivePosition</span><span class="hl-1">]&gt;;</span><br/><br/><span class="hl-5">// Example:</span><br/><span class="hl-1">[</span><br/><span class="hl-1">  [</span><span class="hl-2">&quot;strategy1:BTCUSDT&quot;</span><span class="hl-1">, {</span><br/><span class="hl-1">    </span><span class="hl-4">signal:</span><span class="hl-1"> </span><span class="hl-6">null</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-4">strategyName:</span><span class="hl-1"> </span><span class="hl-2">&quot;strategy1&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-4">exchangeName:</span><span class="hl-1"> </span><span class="hl-2">&quot;&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-4">openTimestamp:</span><span class="hl-1"> </span><span class="hl-8">1234567890</span><br/><span class="hl-1">  }],</span><br/><span class="hl-1">  [</span><span class="hl-2">&quot;strategy2:ETHUSDT&quot;</span><span class="hl-1">, {</span><br/><span class="hl-1">    </span><span class="hl-4">signal:</span><span class="hl-1"> </span><span class="hl-6">null</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-4">strategyName:</span><span class="hl-1"> </span><span class="hl-2">&quot;strategy2&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-4">exchangeName:</span><span class="hl-1"> </span><span class="hl-2">&quot;&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-4">openTimestamp:</span><span class="hl-1"> </span><span class="hl-8">1234567900</span><br/><span class="hl-1">  }]</span><br/><span class="hl-1">]</span>
</code><button type="button">Copy</button></pre>

<p>This format:</p>
<ul>
<li>Preserves Map structure (key-value pairs)</li>
<li>Serializes to JSON without data loss</li>
<li>Reconstructs via <code>new Map(array)</code></li>
</ul>
<hr>
<a id="position-access-in-validations" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Position Access in Validations<a href="#position-access-in-validations" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>Custom validation functions receive position data through the <code>IRiskValidationPayload</code> interface. The framework builds this payload before executing validations.</p>
<a id="payload-construction" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Payload Construction<a href="#payload-construction" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><img src="../media/66_Position_Tracking_4.svg" alt="Mermaid Diagram"></p>
<p><strong>Diagram: Validation Payload Construction</strong></p>
<a id="checksignal-implementation" class="tsd-anchor"></a><h3 class="tsd-anchor-link">checkSignal Implementation<a href="#checksignal-implementation" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>The <code>checkSignal</code> method builds the validation payload:</p>
<p><strong>Implementation details:</strong></p>
<ol>
<li>Initialize if needed via <code>waitForInit()</code></li>
<li>Cast <code>_activePositions</code> to <code>RiskMap</code> type</li>
<li>Build <code>IRiskValidationPayload</code> with spread operator</li>
<li>Add <code>activePositionCount: riskMap.size</code></li>
<li>Add <code>activePositions: Array.from(riskMap.values())</code></li>
<li>Execute validations with payload</li>
</ol>
<p><strong>Example validation accessing positions:</strong></p>
<pre><code class="typescript"><span class="hl-1">{</span><br/><span class="hl-1">  </span><span class="hl-11">validate</span><span class="hl-1">: ({ </span><span class="hl-4">activePositionCount</span><span class="hl-1">, </span><span class="hl-4">activePositions</span><span class="hl-1"> }) </span><span class="hl-6">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-4">activePositionCount</span><span class="hl-1"> &gt;= </span><span class="hl-8">5</span><span class="hl-1">) {</span><br/><span class="hl-1">      </span><span class="hl-3">throw</span><span class="hl-1"> </span><span class="hl-6">new</span><span class="hl-1"> </span><span class="hl-0">Error</span><span class="hl-1">(</span><span class="hl-2">&quot;Maximum 5 concurrent positions&quot;</span><span class="hl-1">);</span><br/><span class="hl-1">    }</span><br/><span class="hl-1">    </span><br/><span class="hl-1">    </span><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">btcPositions</span><span class="hl-1"> = </span><span class="hl-4">activePositions</span><span class="hl-1">.</span><span class="hl-0">filter</span><span class="hl-1">(</span><br/><span class="hl-1">      </span><span class="hl-4">pos</span><span class="hl-1"> </span><span class="hl-6">=&gt;</span><span class="hl-1"> </span><span class="hl-4">pos</span><span class="hl-1">.</span><span class="hl-4">signal</span><span class="hl-1">.</span><span class="hl-4">symbol</span><span class="hl-1"> === </span><span class="hl-2">&quot;BTCUSDT&quot;</span><br/><span class="hl-1">    );</span><br/><span class="hl-1">    </span><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-4">btcPositions</span><span class="hl-1">.</span><span class="hl-4">length</span><span class="hl-1"> &gt;= </span><span class="hl-8">2</span><span class="hl-1">) {</span><br/><span class="hl-1">      </span><span class="hl-3">throw</span><span class="hl-1"> </span><span class="hl-6">new</span><span class="hl-1"> </span><span class="hl-0">Error</span><span class="hl-1">(</span><span class="hl-2">&quot;Maximum 2 BTC positions&quot;</span><span class="hl-1">);</span><br/><span class="hl-1">    }</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<hr>
<a id="isolation-by-risk-profile" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Isolation by Risk Profile<a href="#isolation-by-risk-profile" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>Each risk profile maintains an isolated position registry. Strategies with different <code>riskName</code> values track positions independently, enabling separate risk policies.</p>
<a id="isolation-mechanism" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Isolation Mechanism<a href="#isolation-mechanism" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><table>
<thead>
<tr>
<th>Component</th>
<th>Isolation Level</th>
<th>Mechanism</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>ClientRisk</code> instance</td>
<td>Per <code>riskName</code></td>
<td>Memoized by <code>RiskConnectionService</code></td>
</tr>
<tr>
<td><code>_activePositions</code> Map</td>
<td>Per instance</td>
<td>Instance field</td>
</tr>
<tr>
<td>Persistence file</td>
<td>Per <code>riskName</code></td>
<td><code>PersistRiskAdapter</code> namespace</td>
</tr>
</tbody>
</table>
<a id="example-multiple-risk-profiles" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Example: Multiple Risk Profiles<a href="#example-multiple-risk-profiles" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><img src="../media/66_Position_Tracking_5.svg" alt="Mermaid Diagram"></p>
<p><strong>Diagram: Position Isolation by Risk Profile</strong></p>
<a id="cross-profile-independence" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Cross-Profile Independence<a href="#cross-profile-independence" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Test case demonstrating isolation:</p>
<p><strong>Scenario:</strong></p>
<ol>
<li>Add 2 positions to <code>test-isolation-1</code></li>
<li>Add 1 position to <code>test-isolation-2</code></li>
<li>Verify each profile reports correct count</li>
</ol>
<p><strong>Result:</strong></p>
<ul>
<li>Profile 1 reports <code>activePositionCount: 2</code></li>
<li>Profile 2 reports <code>activePositionCount: 1</code></li>
<li>No cross-contamination occurs</li>
</ul>
<hr>
<a id="service-layer-integration" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Service Layer Integration<a href="#service-layer-integration" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>Position tracking integrates with the service layer through <code>RiskGlobalService</code> and <code>RiskConnectionService</code>. These services provide validation and routing to the correct <code>ClientRisk</code> instance.</p>
<a id="service-architecture" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Service Architecture<a href="#service-architecture" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><img src="../media/66_Position_Tracking_6.svg" alt="Mermaid Diagram"></p>
<p><strong>Diagram: Position Tracking Service Integration</strong></p>
<a id="method-routing" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Method Routing<a href="#method-routing" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><table>
<thead>
<tr>
<th>Method</th>
<th>Flow</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>addSignal</code></td>
<td><code>RiskGlobalService</code> → <code>RiskConnectionService</code> → <code>ClientRisk</code></td>
<td>Register opened position</td>
</tr>
<tr>
<td><code>removeSignal</code></td>
<td><code>RiskGlobalService</code> → <code>RiskConnectionService</code> → <code>ClientRisk</code></td>
<td>Unregister closed position</td>
</tr>
<tr>
<td><code>checkSignal</code></td>
<td><code>RiskGlobalService</code> → <code>RiskConnectionService</code> → <code>ClientRisk</code></td>
<td>Validate with current positions</td>
</tr>
</tbody>
</table>
<a id="memoization-strategy" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Memoization Strategy<a href="#memoization-strategy" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><code>RiskConnectionService.getRisk</code> uses memoization to cache <code>ClientRisk</code> instances:</p>
<p><strong>Cache key:</strong> <code>riskName</code> string</p>
<p><strong>Benefits:</strong></p>
<ul>
<li>One instance per risk profile</li>
<li>Shared position state across strategies</li>
<li>Efficient instance reuse</li>
</ul>
<hr>
<a id="key-patterns-and-constraints" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Key Patterns and Constraints<a href="#key-patterns-and-constraints" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><a id="composite-key-pattern" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Composite Key Pattern<a href="#composite-key-pattern" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><strong>Format:</strong> <code>${strategyName}:${symbol}</code></p>
<p><strong>Characteristics:</strong></p>
<ul>
<li>Unique per strategy-symbol pair</li>
<li>Allows same symbol across strategies</li>
<li>Deterministic for add/remove operations</li>
</ul>
<p><strong>Example:</strong></p>
<pre><code><span class="hl-11">strategy1</span><span class="hl-1">:</span><span class="hl-7">BTCUSDT</span><span class="hl-1">  → </span><span class="hl-4">Unique</span><span class="hl-1"> </span><span class="hl-4">position</span><br/><span class="hl-11">strategy2</span><span class="hl-1">:</span><span class="hl-7">BTCUSDT</span><span class="hl-1">  → </span><span class="hl-4">Different</span><span class="hl-1"> </span><span class="hl-0">position</span><span class="hl-1"> (</span><span class="hl-4">same</span><span class="hl-1"> </span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">different</span><span class="hl-1"> </span><span class="hl-4">strategy</span><span class="hl-1">)</span><br/><span class="hl-11">strategy1</span><span class="hl-1">:</span><span class="hl-7">ETHUSDT</span><span class="hl-1">  → </span><span class="hl-4">Different</span><span class="hl-1"> </span><span class="hl-0">position</span><span class="hl-1"> (</span><span class="hl-4">same</span><span class="hl-1"> </span><span class="hl-4">strategy</span><span class="hl-1">, </span><span class="hl-4">different</span><span class="hl-1"> </span><span class="hl-4">symbol</span><span class="hl-1">)</span>
</code><button>Copy</button></pre>

<a id="simplified-position-data" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Simplified Position Data<a href="#simplified-position-data" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>The implementation stores minimal metadata in position records:</p>
<p><strong>Fields stored:</strong></p>
<ul>
<li><code>signal: null</code> (not used for position tracking)</li>
<li><code>strategyName: string</code> (for identification)</li>
<li><code>exchangeName: &quot;&quot;</code> (empty string, not used)</li>
<li><code>openTimestamp: number</code> (for duration tracking)</li>
</ul>
<p>This simplification:</p>
<ul>
<li>Reduces memory footprint</li>
<li>Avoids circular references</li>
<li>Focuses on count-based validation</li>
</ul>
<a id="synchronous-state-updates" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Synchronous State Updates<a href="#synchronous-state-updates" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Position map updates occur synchronously in memory, followed by asynchronous persistence:</p>
<p><strong>Pattern:</strong></p>
<pre><code class="typescript"><span class="hl-5">// Synchronous map update</span><br/><span class="hl-4">riskMap</span><span class="hl-1">.</span><span class="hl-0">set</span><span class="hl-1">(</span><span class="hl-4">key</span><span class="hl-1">, </span><span class="hl-4">position</span><span class="hl-1">);</span><br/><br/><span class="hl-5">// Asynchronous persistence (non-blocking)</span><br/><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-6">this</span><span class="hl-1">.</span><span class="hl-0">_updatePositions</span><span class="hl-1">();</span>
</code><button type="button">Copy</button></pre>

<p><strong>Benefits:</strong></p>
<ul>
<li>Immediate availability for subsequent validations</li>
<li>Non-blocking for other operations</li>
<li>Crash-safe through atomic writes</li>
</ul>
</div></div><div class="col-sidebar"><div class="page-menu"><div class="tsd-navigation settings"><details class="tsd-accordion"><summary class="tsd-accordion-summary"><h3><svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-chevronDown"></use></svg>Settings</h3></summary><div class="tsd-accordion-details"><div class="tsd-filter-visibility"><span class="settings-label">Member Visibility</span><ul id="tsd-filter-options"><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-protected" name="protected"/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Protected</span></label></li><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-inherited" name="inherited" checked/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Inherited</span></label></li><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-external" name="external"/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>External</span></label></li></ul></div><div class="tsd-theme-toggle"><label class="settings-label" for="tsd-theme">Theme</label><select id="tsd-theme"><option value="os">OS</option><option value="light">Light</option><option value="dark">Dark</option></select></div></div></details></div><details open class="tsd-accordion tsd-page-navigation"><summary class="tsd-accordion-summary"><h3><svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-chevronDown"></use></svg>On This Page</h3></summary><div class="tsd-accordion-details"><a href="#position-tracking"><span>Position <wbr/>Tracking</span></a><ul><li><a href="#purpose-and-scope"><span>Purpose and <wbr/>Scope</span></a></li><li><a href="#overview"><span>Overview</span></a></li><li><a href="#active-position-map-structure"><span>Active <wbr/>Position <wbr/>Map <wbr/>Structure</span></a></li><li><ul><li><a href="#map-structure"><span>Map <wbr/>Structure</span></a></li><li><a href="#iriskactiveposition-structure"><span>IRisk<wbr/>Active<wbr/>Position <wbr/>Structure</span></a></li><li><a href="#key-generator-function"><span>Key <wbr/>Generator <wbr/>Function</span></a></li></ul></li><li><a href="#position-lifecycle"><span>Position <wbr/>Lifecycle</span></a></li><li><ul><li><a href="#position-registration-flow"><span>Position <wbr/>Registration <wbr/>Flow</span></a></li><li><a href="#addsignal-method"><span>add<wbr/>Signal <wbr/>Method</span></a></li><li><a href="#removesignal-method"><span>remove<wbr/>Signal <wbr/>Method</span></a></li></ul></li><li><a href="#lazy-initialization-pattern"><span>Lazy <wbr/>Initialization <wbr/>Pattern</span></a></li><li><ul><li><a href="#initialization-states"><span>Initialization <wbr/>States</span></a></li><li><a href="#wait_for_init_fn"><span>WAIT_<wbr/>FOR_<wbr/>INIT_<wbr/>FN</span></a></li></ul></li><li><a href="#persistence-and-recovery"><span>Persistence and <wbr/>Recovery</span></a></li><li><ul><li><a href="#persistence-flow"><span>Persistence <wbr/>Flow</span></a></li><li><a href="#_updatepositions-method"><span>_update<wbr/>Positions <wbr/>Method</span></a></li><li><a href="#data-format"><span>Data <wbr/>Format</span></a></li></ul></li><li><a href="#position-access-in-validations"><span>Position <wbr/>Access in <wbr/>Validations</span></a></li><li><ul><li><a href="#payload-construction"><span>Payload <wbr/>Construction</span></a></li><li><a href="#checksignal-implementation"><span>check<wbr/>Signal <wbr/>Implementation</span></a></li></ul></li><li><a href="#isolation-by-risk-profile"><span>Isolation by <wbr/>Risk <wbr/>Profile</span></a></li><li><ul><li><a href="#isolation-mechanism"><span>Isolation <wbr/>Mechanism</span></a></li><li><a href="#example-multiple-risk-profiles"><span>Example: <wbr/>Multiple <wbr/>Risk <wbr/>Profiles</span></a></li><li><a href="#cross-profile-independence"><span>Cross-<wbr/>Profile <wbr/>Independence</span></a></li></ul></li><li><a href="#service-layer-integration"><span>Service <wbr/>Layer <wbr/>Integration</span></a></li><li><ul><li><a href="#service-architecture"><span>Service <wbr/>Architecture</span></a></li><li><a href="#method-routing"><span>Method <wbr/>Routing</span></a></li><li><a href="#memoization-strategy"><span>Memoization <wbr/>Strategy</span></a></li></ul></li><li><a href="#key-patterns-and-constraints"><span>Key <wbr/>Patterns and <wbr/>Constraints</span></a></li><li><ul><li><a href="#composite-key-pattern"><span>Composite <wbr/>Key <wbr/>Pattern</span></a></li><li><a href="#simplified-position-data"><span>Simplified <wbr/>Position <wbr/>Data</span></a></li><li><a href="#synchronous-state-updates"><span>Synchronous <wbr/>State <wbr/>Updates</span></a></li></ul></li></ul></div></details></div><div class="site-menu"><nav class="tsd-navigation"><a href="../modules.html">backtest-kit</a><ul class="tsd-small-nested-navigation" id="tsd-nav-container"><li>Loading...</li></ul></nav></div></div></div><footer><p class="tsd-generator">Generated using <a href="https://typedoc.org/" target="_blank">TypeDoc</a></p></footer><div class="overlay"></div></body></html>

<!-- Yandex.Metrika counter -->
<script type="text/javascript">
    (function(m,e,t,r,i,k,a){
        m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
        m[i].l=1*new Date();
        for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }}
        k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)
    })(window, document,'script','https://mc.yandex.ru/metrika/tag.js?id=105455585', 'ym');

    ym(105455585, 'init', {ssr:true, webvisor:true, clickmap:true, ecommerce:"dataLayer", accurateTrackBounce:true, trackLinks:true});
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/105455585" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
<!-- /Yandex.Metrika counter -->

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-3MQZEBBDDR"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-3MQZEBBDDR');
</script>
