<!DOCTYPE html><html class="default" lang="en" data-base=".."><head><meta charset="utf-8"/><meta http-equiv="x-ua-compatible" content="IE=edge"/><title>design/31_risk-management | backtest-kit</title><meta name="description" content="Documentation for backtest-kit"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="stylesheet" href="../assets/style.css"/><link rel="stylesheet" href="../assets/highlight.css"/><script defer src="../assets/main.js"></script><script async src="../assets/icons.js" id="tsd-icons-script"></script><script async src="../assets/search.js" id="tsd-search-script"></script><script async src="../assets/navigation.js" id="tsd-nav-script"></script><script async src="../assets/hierarchy.js" id="tsd-hierarchy-script"></script></head><body><script>document.documentElement.dataset.theme = localStorage.getItem("tsd-theme") || "os";document.body.style.display="none";setTimeout(() => app?app.showPage():document.body.style.removeProperty("display"),500)</script><header class="tsd-page-toolbar"><div class="tsd-toolbar-contents container"><div class="table-cell" id="tsd-search"><div class="field"><label for="tsd-search-field" class="tsd-widget tsd-toolbar-icon search no-caption"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-search"></use></svg></label><input type="text" id="tsd-search-field" aria-label="Search"/></div><div class="field"><div id="tsd-toolbar-links"></div></div><ul class="results"><li class="state loading">Preparing search index...</li><li class="state failure">The search index is not available</li></ul><a href="../index.html" class="title">backtest-kit</a></div><div class="table-cell" id="tsd-widgets"><a href="#" class="tsd-widget tsd-toolbar-icon menu no-caption" data-toggle="menu" aria-label="Menu"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-menu"></use></svg></a></div></div></header><div class="container container-main"><div class="col-content"><div class="tsd-page-title"><ul class="tsd-breadcrumb"><li><a href="../modules.html">backtest-kit</a></li><li><a href="design_31_risk-management.html">design/31_risk-management</a></li></ul></div><div class="tsd-panel tsd-typography"><a id="risk-management" class="tsd-anchor"></a><h1 class="tsd-anchor-link">Risk Management<a href="#risk-management" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h1><a id="purpose-and-scope" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Purpose and Scope<a href="#purpose-and-scope" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>This document describes the risk management system in Backtest Kit, which validates trading signals before execution and enforces portfolio-wide limits. The risk system operates at two levels: <strong>signal-level validation</strong> (price logic, TP/SL distances, lifetime limits) and <strong>portfolio-level validation</strong> (concurrent position limits, exposure constraints).</p>
<p>For strategy development patterns, see <a href="design_25_strategy-development.html">Strategy Development</a>. For signal lifecycle details, see <a href="design_08_core-concepts.html">Signals &amp; Signal Lifecycle</a>. For position sizing calculations, see <a href="design_31_risk-management.html">Position Sizing</a>.</p>
<a id="risk-management-architecture" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Risk Management Architecture<a href="#risk-management-architecture" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>The risk system integrates into the signal lifecycle as a <strong>pre-execution validation gate</strong>. All signals pass through validation before being scheduled or opened, ensuring that only compliant signals reach the market.</p>
<p><img src="../media/31_risk-management_0.svg" alt="Mermaid Diagram"></p>
<hr>
<a id="risk-schema-definition" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Risk Schema Definition<a href="#risk-schema-definition" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>Risk profiles are defined using <code>IRiskSchema</code> and registered via <code>addRisk()</code>. Each profile contains custom validation logic executed before signals are scheduled or opened.</p>
<a id="iriskschema-interface" class="tsd-anchor"></a><h3 class="tsd-anchor-link">IRiskSchema Interface<a href="#iriskschema-interface" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><pre><code class="typescript"><span class="hl-7">interface</span><span class="hl-1"> </span><span class="hl-13">IRiskSchema</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-4">riskName</span><span class="hl-1">: </span><span class="hl-13">RiskName</span><span class="hl-1">;                               </span><span class="hl-5">// Unique identifier</span><br/><span class="hl-1">  </span><span class="hl-4">note</span><span class="hl-1">?: </span><span class="hl-13">string</span><span class="hl-1">;                                    </span><span class="hl-5">// Documentation</span><br/><span class="hl-1">  </span><span class="hl-4">callbacks</span><span class="hl-1">?: </span><span class="hl-13">Partial</span><span class="hl-1">&lt;</span><span class="hl-13">IRiskCallbacks</span><span class="hl-1">&gt;;              </span><span class="hl-5">// Event handlers</span><br/><span class="hl-1">  </span><span class="hl-4">validations</span><span class="hl-1">: (</span><span class="hl-13">IRiskValidation</span><span class="hl-1"> | </span><span class="hl-13">IRiskValidationFn</span><span class="hl-1">)[]; </span><span class="hl-5">// Validation rules</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<a id="iriskvalidation-structure" class="tsd-anchor"></a><h3 class="tsd-anchor-link">IRiskValidation Structure<a href="#iriskvalidation-structure" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><pre><code class="typescript"><span class="hl-7">interface</span><span class="hl-1"> </span><span class="hl-13">IRiskValidation</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-4">validate</span><span class="hl-1">: </span><span class="hl-13">IRiskValidationFn</span><span class="hl-1">;  </span><span class="hl-5">// Validation function</span><br/><span class="hl-1">  </span><span class="hl-4">note</span><span class="hl-1">?: </span><span class="hl-13">string</span><span class="hl-1">;                 </span><span class="hl-5">// Reason for rejection (logged)</span><br/><span class="hl-1">}</span><br/><br/><span class="hl-7">interface</span><span class="hl-1"> </span><span class="hl-13">IRiskValidationFn</span><span class="hl-1"> {</span><br/><span class="hl-1">  (</span><span class="hl-4">payload</span><span class="hl-1">: </span><span class="hl-13">IRiskValidationPayload</span><span class="hl-1">): </span><span class="hl-13">void</span><span class="hl-1"> | </span><span class="hl-13">Promise</span><span class="hl-1">&lt;</span><span class="hl-13">void</span><span class="hl-1">&gt;;</span><br/><span class="hl-1">  </span><span class="hl-5">// Throws error to reject signal</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<a id="iriskvalidationpayload" class="tsd-anchor"></a><h3 class="tsd-anchor-link">IRiskValidationPayload<a href="#iriskvalidationpayload" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>The validation payload provides complete context for risk decisions:</p>
<table>
<thead>
<tr>
<th>Field</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>symbol</code></td>
<td><code>string</code></td>
<td>Trading pair (e.g., &quot;BTCUSDT&quot;)</td>
</tr>
<tr>
<td><code>pendingSignal</code></td>
<td><code>ISignalDto</code></td>
<td>Signal awaiting validation</td>
</tr>
<tr>
<td><code>strategyName</code></td>
<td><code>StrategyName</code></td>
<td>Source strategy identifier</td>
</tr>
<tr>
<td><code>exchangeName</code></td>
<td><code>ExchangeName</code></td>
<td>Target exchange</td>
</tr>
<tr>
<td><code>currentPrice</code></td>
<td><code>number</code></td>
<td>Current VWAP price</td>
</tr>
<tr>
<td><code>timestamp</code></td>
<td><code>number</code></td>
<td>Validation timestamp (ms)</td>
</tr>
<tr>
<td><code>activePositionCount</code></td>
<td><code>number</code></td>
<td>Total active signals across all strategies</td>
</tr>
<tr>
<td><code>activePositions</code></td>
<td><code>IRiskActivePosition[]</code></td>
<td>Details of active positions</td>
</tr>
</tbody>
</table>
<hr>
<a id="multi-stage-signal-validation-pipeline" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Multi-Stage Signal Validation Pipeline<a href="#multi-stage-signal-validation-pipeline" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>Before risk profile validation, signals pass through a <strong>7-stage validation pipeline</strong> enforced by <code>GLOBAL_CONFIG</code> parameters. This pipeline catches common errors and ensures signals meet minimum quality thresholds.</p>
<p><img src="../media/31_risk-management_1.svg" alt="Mermaid Diagram"></p>
<a id="validation-stage-details" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Validation Stage Details<a href="#validation-stage-details" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><a id="1-price-positivity-check" class="tsd-anchor"></a><h4 class="tsd-anchor-link">1. Price Positivity Check<a href="#1-price-positivity-check" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><p>Ensures all prices are positive, finite numbers:</p>
<pre><code class="typescript"><span class="hl-4">priceOpen</span><span class="hl-1"> &gt; </span><span class="hl-6">0</span><span class="hl-1"> &amp;&amp; </span><span class="hl-0">isFinite</span><span class="hl-1">(</span><span class="hl-4">priceOpen</span><span class="hl-1">)</span><br/><span class="hl-4">priceTakeProfit</span><span class="hl-1"> &gt; </span><span class="hl-6">0</span><span class="hl-1"> &amp;&amp; </span><span class="hl-0">isFinite</span><span class="hl-1">(</span><span class="hl-4">priceTakeProfit</span><span class="hl-1">)</span><br/><span class="hl-4">priceStopLoss</span><span class="hl-1"> &gt; </span><span class="hl-6">0</span><span class="hl-1"> &amp;&amp; </span><span class="hl-0">isFinite</span><span class="hl-1">(</span><span class="hl-4">priceStopLoss</span><span class="hl-1">)</span>
</code><button type="button">Copy</button></pre>

<a id="2-tpsl-logic-validation" class="tsd-anchor"></a><h4 class="tsd-anchor-link">2. TP/SL Logic Validation<a href="#2-tpsl-logic-validation" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><p>Enforces correct price ordering for LONG and SHORT positions:</p>
<table>
<thead>
<tr>
<th>Position</th>
<th>Required Logic</th>
<th>Rationale</th>
</tr>
</thead>
<tbody>
<tr>
<td>LONG</td>
<td><code>priceTakeProfit &gt; priceOpen &gt; priceStopLoss</code></td>
<td>Buy low, sell higher (TP), cut losses (SL)</td>
</tr>
<tr>
<td>SHORT</td>
<td><code>priceStopLoss &gt; priceOpen &gt; priceTakeProfit</code></td>
<td>Sell high, buy lower (TP), cut losses (SL)</td>
</tr>
</tbody>
</table>
<a id="3-minimum-tp-distance-cc_min_takeprofit_distance_percent" class="tsd-anchor"></a><h4 class="tsd-anchor-link">3. Minimum TP Distance (<code>CC_MIN_TAKEPROFIT_DISTANCE_PERCENT</code>)<a href="#3-minimum-tp-distance-cc_min_takeprofit_distance_percent" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><p>Default: <strong>0.5%</strong></p>
<p>Ensures TP is far enough from <code>priceOpen</code> to cover transaction costs:</p>
<ul>
<li>Slippage: ~0.2% (0.1% entry + 0.1% exit)</li>
<li>Fees: 0.2% (0.1% entry + 0.1% exit)</li>
<li>Minimum profit buffer: 0.1%</li>
<li><strong>Total required: 0.5%</strong></li>
</ul>
<p><strong>Example rejection:</strong></p>
<pre><code class="typescript"><span class="hl-5">// priceOpen = 42000, priceTakeProfit = 42010</span><br/><span class="hl-5">// Distance = 0.024% &lt; 0.5% → REJECTED</span><br/><span class="hl-5">// After fees/slippage, this would be a loss!</span>
</code><button type="button">Copy</button></pre>

<a id="4-minimum-sl-distance-cc_min_stoploss_distance_percent" class="tsd-anchor"></a><h4 class="tsd-anchor-link">4. Minimum SL Distance (<code>CC_MIN_STOPLOSS_DISTANCE_PERCENT</code>)<a href="#4-minimum-sl-distance-cc_min_stoploss_distance_percent" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><p>Default: <strong>0.5%</strong></p>
<p>Prevents signals from being immediately stopped out by normal price volatility. SL must be at least 0.5% away from <code>priceOpen</code>.</p>
<a id="5-maximum-sl-distance-cc_max_stoploss_distance_percent" class="tsd-anchor"></a><h4 class="tsd-anchor-link">5. Maximum SL Distance (<code>CC_MAX_STOPLOSS_DISTANCE_PERCENT</code>)<a href="#5-maximum-sl-distance-cc_max_stoploss_distance_percent" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><p>Default: <strong>20%</strong></p>
<p>Caps catastrophic losses from extreme SL values. A single signal cannot risk more than 20% of the position.</p>
<p><strong>Example rejection:</strong></p>
<pre><code class="typescript"><span class="hl-5">// priceOpen = 42000, priceStopLoss = 20000 (LONG)</span><br/><span class="hl-5">// Distance = -52.4% &lt; -20% → REJECTED</span><br/><span class="hl-5">// One signal could lose half the portfolio!</span>
</code><button type="button">Copy</button></pre>

<a id="6-lifetime-limit-cc_max_signal_lifetime_minutes" class="tsd-anchor"></a><h4 class="tsd-anchor-link">6. Lifetime Limit (<code>CC_MAX_SIGNAL_LIFETIME_MINUTES</code>)<a href="#6-lifetime-limit-cc_max_signal_lifetime_minutes" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><p>Default: <strong>1440 minutes (1 day)</strong></p>
<p>Prevents &quot;eternal signals&quot; that block risk limits indefinitely:</p>
<pre><code class="typescript"><span class="hl-5">// minuteEstimatedTime = 50000 minutes (34 days)</span><br/><span class="hl-5">// Exceeds 1440 minute limit → REJECTED</span>
</code><button type="button">Copy</button></pre>

<a id="7-candle-data-anomaly-detection" class="tsd-anchor"></a><h4 class="tsd-anchor-link">7. Candle Data Anomaly Detection<a href="#7-candle-data-anomaly-detection" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><p>Validates that historical candle data contains no anomalous prices (e.g., incomplete candles with near-zero prices from API glitches). Uses <code>CC_GET_CANDLES_PRICE_ANOMALY_THRESHOLD_FACTOR</code> (default: 1000) to detect outliers.</p>
<hr>
<a id="custom-risk-validations" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Custom Risk Validations<a href="#custom-risk-validations" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>After passing <code>GLOBAL_CONFIG</code> checks, signals proceed to <strong>custom risk validations</strong> defined in <code>IRiskSchema</code>. These validations enforce strategy-specific or portfolio-wide constraints.</p>
<a id="basic-risk-profile-example" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Basic Risk Profile Example<a href="#basic-risk-profile-example" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><pre><code class="typescript"><span class="hl-3">import</span><span class="hl-1"> { </span><span class="hl-4">addRisk</span><span class="hl-1"> } </span><span class="hl-3">from</span><span class="hl-1"> </span><span class="hl-2">&#39;backtest-kit&#39;</span><span class="hl-1">;</span><br/><br/><span class="hl-0">addRisk</span><span class="hl-1">({</span><br/><span class="hl-1">  </span><span class="hl-4">riskName:</span><span class="hl-1"> </span><span class="hl-2">&#39;conservative&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">validations:</span><span class="hl-1"> [</span><br/><span class="hl-1">    </span><span class="hl-5">// Minimum 1% TP distance</span><br/><span class="hl-1">    ({ </span><span class="hl-4">pendingSignal</span><span class="hl-1">, </span><span class="hl-4">currentPrice</span><span class="hl-1"> }) </span><span class="hl-7">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">      </span><span class="hl-7">const</span><span class="hl-1"> { </span><span class="hl-8">priceOpen</span><span class="hl-1"> = </span><span class="hl-4">currentPrice</span><span class="hl-1">, </span><span class="hl-8">priceTakeProfit</span><span class="hl-1">, </span><span class="hl-8">position</span><span class="hl-1"> } = </span><span class="hl-4">pendingSignal</span><span class="hl-1">;</span><br/><span class="hl-1">      </span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">tpDistance</span><span class="hl-1"> = </span><span class="hl-4">position</span><span class="hl-1"> === </span><span class="hl-2">&#39;long&#39;</span><span class="hl-1"> </span><br/><span class="hl-1">        ? ((</span><span class="hl-4">priceTakeProfit</span><span class="hl-1"> - </span><span class="hl-4">priceOpen</span><span class="hl-1">) / </span><span class="hl-4">priceOpen</span><span class="hl-1">) * </span><span class="hl-6">100</span><br/><span class="hl-1">        : ((</span><span class="hl-4">priceOpen</span><span class="hl-1"> - </span><span class="hl-4">priceTakeProfit</span><span class="hl-1">) / </span><span class="hl-4">priceOpen</span><span class="hl-1">) * </span><span class="hl-6">100</span><span class="hl-1">;</span><br/><span class="hl-1">      </span><br/><span class="hl-1">      </span><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-4">tpDistance</span><span class="hl-1"> &lt; </span><span class="hl-6">1.0</span><span class="hl-1">) {</span><br/><span class="hl-1">        </span><span class="hl-3">throw</span><span class="hl-1"> </span><span class="hl-7">new</span><span class="hl-1"> </span><span class="hl-0">Error</span><span class="hl-1">(</span><span class="hl-2">`TP too close: </span><span class="hl-7">${</span><span class="hl-4">tpDistance</span><span class="hl-9">.</span><span class="hl-0">toFixed</span><span class="hl-9">(</span><span class="hl-6">2</span><span class="hl-9">)</span><span class="hl-7">}</span><span class="hl-2">%`</span><span class="hl-1">);</span><br/><span class="hl-1">      }</span><br/><span class="hl-1">    },</span><br/><span class="hl-1">    </span><br/><span class="hl-1">    </span><span class="hl-5">// Minimum 2:1 reward/risk ratio</span><br/><span class="hl-1">    {</span><br/><span class="hl-1">      </span><span class="hl-0">validate</span><span class="hl-4">:</span><span class="hl-1"> ({ </span><span class="hl-4">pendingSignal</span><span class="hl-1">, </span><span class="hl-4">currentPrice</span><span class="hl-1"> }) </span><span class="hl-7">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">        </span><span class="hl-7">const</span><span class="hl-1"> { </span><span class="hl-8">priceOpen</span><span class="hl-1"> = </span><span class="hl-4">currentPrice</span><span class="hl-1">, </span><span class="hl-8">priceTakeProfit</span><span class="hl-1">, </span><span class="hl-8">priceStopLoss</span><span class="hl-1">, </span><span class="hl-8">position</span><span class="hl-1"> } = </span><span class="hl-4">pendingSignal</span><span class="hl-1">;</span><br/><span class="hl-1">        </span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">reward</span><span class="hl-1"> = </span><span class="hl-4">position</span><span class="hl-1"> === </span><span class="hl-2">&#39;long&#39;</span><br/><span class="hl-1">          ? </span><span class="hl-4">priceTakeProfit</span><span class="hl-1"> - </span><span class="hl-4">priceOpen</span><br/><span class="hl-1">          : </span><span class="hl-4">priceOpen</span><span class="hl-1"> - </span><span class="hl-4">priceTakeProfit</span><span class="hl-1">;</span><br/><span class="hl-1">        </span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">risk</span><span class="hl-1"> = </span><span class="hl-4">position</span><span class="hl-1"> === </span><span class="hl-2">&#39;long&#39;</span><br/><span class="hl-1">          ? </span><span class="hl-4">priceOpen</span><span class="hl-1"> - </span><span class="hl-4">priceStopLoss</span><br/><span class="hl-1">          : </span><span class="hl-4">priceStopLoss</span><span class="hl-1"> - </span><span class="hl-4">priceOpen</span><span class="hl-1">;</span><br/><span class="hl-1">        </span><br/><span class="hl-1">        </span><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-4">reward</span><span class="hl-1"> / </span><span class="hl-4">risk</span><span class="hl-1"> &lt; </span><span class="hl-6">2.0</span><span class="hl-1">) {</span><br/><span class="hl-1">          </span><span class="hl-3">throw</span><span class="hl-1"> </span><span class="hl-7">new</span><span class="hl-1"> </span><span class="hl-0">Error</span><span class="hl-1">(</span><span class="hl-2">&#39;Poor R/R ratio&#39;</span><span class="hl-1">);</span><br/><span class="hl-1">        }</span><br/><span class="hl-1">      },</span><br/><span class="hl-1">      </span><span class="hl-4">note:</span><span class="hl-1"> </span><span class="hl-2">&#39;Reward/Risk must be at least 2:1&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">    },</span><br/><span class="hl-1">  ],</span><br/><span class="hl-1">});</span>
</code><button type="button">Copy</button></pre>

<a id="attaching-risk-profiles-to-strategies" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Attaching Risk Profiles to Strategies<a href="#attaching-risk-profiles-to-strategies" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Risk profiles are attached to strategies via <code>riskName</code> or <code>riskList</code>:</p>
<pre><code class="typescript"><span class="hl-0">addStrategy</span><span class="hl-1">({</span><br/><span class="hl-1">  </span><span class="hl-4">strategyName:</span><span class="hl-1"> </span><span class="hl-2">&#39;my-strategy&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">interval:</span><span class="hl-1"> </span><span class="hl-2">&#39;5m&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-0">getSignal</span><span class="hl-4">:</span><span class="hl-1"> </span><span class="hl-7">async</span><span class="hl-1"> (</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">when</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> { </span><span class="hl-5">/* ... */</span><span class="hl-1"> },</span><br/><span class="hl-1">  </span><span class="hl-4">riskName:</span><span class="hl-1"> </span><span class="hl-2">&#39;conservative&#39;</span><span class="hl-1">,  </span><span class="hl-5">// Single risk profile</span><br/><span class="hl-1">});</span><br/><br/><span class="hl-0">addStrategy</span><span class="hl-1">({</span><br/><span class="hl-1">  </span><span class="hl-4">strategyName:</span><span class="hl-1"> </span><span class="hl-2">&#39;multi-risk-strategy&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">interval:</span><span class="hl-1"> </span><span class="hl-2">&#39;5m&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-0">getSignal</span><span class="hl-4">:</span><span class="hl-1"> </span><span class="hl-7">async</span><span class="hl-1"> (</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">when</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> { </span><span class="hl-5">/* ... */</span><span class="hl-1"> },</span><br/><span class="hl-1">  </span><span class="hl-4">riskList:</span><span class="hl-1"> [</span><span class="hl-2">&#39;conservative&#39;</span><span class="hl-1">, </span><span class="hl-2">&#39;max-drawdown&#39;</span><span class="hl-1">, </span><span class="hl-2">&#39;time-window&#39;</span><span class="hl-1">],  </span><span class="hl-5">// Multiple profiles</span><br/><span class="hl-1">});</span>
</code><button type="button">Copy</button></pre>

<a id="portfolio-wide-validation-example" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Portfolio-Wide Validation Example<a href="#portfolio-wide-validation-example" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><pre><code class="typescript"><span class="hl-0">addRisk</span><span class="hl-1">({</span><br/><span class="hl-1">  </span><span class="hl-4">riskName:</span><span class="hl-1"> </span><span class="hl-2">&#39;portfolio-limit&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">validations:</span><span class="hl-1"> [</span><br/><span class="hl-1">    </span><span class="hl-5">// Maximum 3 concurrent positions</span><br/><span class="hl-1">    ({ </span><span class="hl-4">activePositionCount</span><span class="hl-1"> }) </span><span class="hl-7">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">      </span><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-4">activePositionCount</span><span class="hl-1"> &gt;= </span><span class="hl-6">3</span><span class="hl-1">) {</span><br/><span class="hl-1">        </span><span class="hl-3">throw</span><span class="hl-1"> </span><span class="hl-7">new</span><span class="hl-1"> </span><span class="hl-0">Error</span><span class="hl-1">(</span><span class="hl-2">`Max positions reached: </span><span class="hl-7">${</span><span class="hl-4">activePositionCount</span><span class="hl-7">}</span><span class="hl-2">/3`</span><span class="hl-1">);</span><br/><span class="hl-1">      }</span><br/><span class="hl-1">    },</span><br/><span class="hl-1">    </span><br/><span class="hl-1">    </span><span class="hl-5">// No new LONG if active SHORT exists on same symbol</span><br/><span class="hl-1">    ({ </span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">pendingSignal</span><span class="hl-1">, </span><span class="hl-4">activePositions</span><span class="hl-1"> }) </span><span class="hl-7">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">      </span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">hasOppositePosition</span><span class="hl-1"> = </span><span class="hl-4">activePositions</span><span class="hl-1">.</span><span class="hl-0">some</span><span class="hl-1">(</span><br/><span class="hl-1">        </span><span class="hl-4">pos</span><span class="hl-1"> </span><span class="hl-7">=&gt;</span><span class="hl-1"> </span><span class="hl-4">pos</span><span class="hl-1">.</span><span class="hl-4">signal</span><span class="hl-1">.</span><span class="hl-4">symbol</span><span class="hl-1"> === </span><span class="hl-4">symbol</span><span class="hl-1"> &amp;&amp; </span><br/><span class="hl-1">               </span><span class="hl-4">pos</span><span class="hl-1">.</span><span class="hl-4">signal</span><span class="hl-1">.</span><span class="hl-4">position</span><span class="hl-1"> !== </span><span class="hl-4">pendingSignal</span><span class="hl-1">.</span><span class="hl-4">position</span><br/><span class="hl-1">      );</span><br/><span class="hl-1">      </span><br/><span class="hl-1">      </span><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-4">hasOppositePosition</span><span class="hl-1">) {</span><br/><span class="hl-1">        </span><span class="hl-3">throw</span><span class="hl-1"> </span><span class="hl-7">new</span><span class="hl-1"> </span><span class="hl-0">Error</span><span class="hl-1">(</span><span class="hl-2">&#39;Cannot open opposite position on same symbol&#39;</span><span class="hl-1">);</span><br/><span class="hl-1">      }</span><br/><span class="hl-1">    },</span><br/><span class="hl-1">  ],</span><br/><span class="hl-1">});</span>
</code><button type="button">Copy</button></pre>

<hr>
<a id="portfolio-wide-risk-tracking" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Portfolio-Wide Risk Tracking<a href="#portfolio-wide-risk-tracking" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p><code>RiskGlobalService</code> maintains a global registry of active positions across all strategies, enabling portfolio-wide risk constraints.</p>
<a id="riskglobalservice-architecture" class="tsd-anchor"></a><h3 class="tsd-anchor-link">RiskGlobalService Architecture<a href="#riskglobalservice-architecture" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><img src="../media/31_risk-management_2.svg" alt="Mermaid Diagram"></p>
<a id="iriskactiveposition-structure" class="tsd-anchor"></a><h3 class="tsd-anchor-link">IRiskActivePosition Structure<a href="#iriskactiveposition-structure" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><pre><code class="typescript"><span class="hl-7">interface</span><span class="hl-1"> </span><span class="hl-13">IRiskActivePosition</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-4">signal</span><span class="hl-1">: </span><span class="hl-13">ISignalRow</span><span class="hl-1">;          </span><span class="hl-5">// Complete signal details</span><br/><span class="hl-1">  </span><span class="hl-4">strategyName</span><span class="hl-1">: </span><span class="hl-13">string</span><span class="hl-1">;        </span><span class="hl-5">// Owning strategy</span><br/><span class="hl-1">  </span><span class="hl-4">exchangeName</span><span class="hl-1">: </span><span class="hl-13">string</span><span class="hl-1">;        </span><span class="hl-5">// Target exchange</span><br/><span class="hl-1">  </span><span class="hl-4">openTimestamp</span><span class="hl-1">: </span><span class="hl-13">number</span><span class="hl-1">;       </span><span class="hl-5">// When position opened (ms)</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<a id="integration-with-clientrisk" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Integration with ClientRisk<a href="#integration-with-clientrisk" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>The <code>ClientRisk</code> class implements risk validation and position tracking:</p>
<pre><code class="typescript"><span class="hl-7">interface</span><span class="hl-1"> </span><span class="hl-13">IRisk</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-0">checkSignal</span><span class="hl-1">(</span><span class="hl-4">params</span><span class="hl-1">: </span><span class="hl-13">IRiskCheckArgs</span><span class="hl-1">): </span><span class="hl-13">Promise</span><span class="hl-1">&lt;</span><span class="hl-13">boolean</span><span class="hl-1">&gt;;</span><br/><span class="hl-1">  </span><span class="hl-0">addSignal</span><span class="hl-1">(</span><span class="hl-4">symbol</span><span class="hl-1">: </span><span class="hl-13">string</span><span class="hl-1">, </span><span class="hl-4">context</span><span class="hl-1">: { </span><span class="hl-4">strategyName</span><span class="hl-1">: </span><span class="hl-13">string</span><span class="hl-1">; </span><span class="hl-4">riskName</span><span class="hl-1">: </span><span class="hl-13">string</span><span class="hl-1"> }): </span><span class="hl-13">Promise</span><span class="hl-1">&lt;</span><span class="hl-13">void</span><span class="hl-1">&gt;;</span><br/><span class="hl-1">  </span><span class="hl-0">removeSignal</span><span class="hl-1">(</span><span class="hl-4">symbol</span><span class="hl-1">: </span><span class="hl-13">string</span><span class="hl-1">, </span><span class="hl-4">context</span><span class="hl-1">: { </span><span class="hl-4">strategyName</span><span class="hl-1">: </span><span class="hl-13">string</span><span class="hl-1">; </span><span class="hl-4">riskName</span><span class="hl-1">: </span><span class="hl-13">string</span><span class="hl-1"> }): </span><span class="hl-13">Promise</span><span class="hl-1">&lt;</span><span class="hl-13">void</span><span class="hl-1">&gt;;</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<table>
<thead>
<tr>
<th>Method</th>
<th>When Called</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>checkSignal()</code></td>
<td>Before scheduling/opening signal</td>
<td>Validates against risk rules</td>
</tr>
<tr>
<td><code>addSignal()</code></td>
<td>When signal opens (priceOpen reached)</td>
<td>Registers active position</td>
</tr>
<tr>
<td><code>removeSignal()</code></td>
<td>When signal closes (TP/SL/time)</td>
<td>Removes active position</td>
</tr>
</tbody>
</table>
<hr>
<a id="mergerisk-for-multiple-risk-profiles" class="tsd-anchor"></a><h2 class="tsd-anchor-link">MergeRisk for Multiple Risk Profiles<a href="#mergerisk-for-multiple-risk-profiles" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>When a strategy specifies <code>riskList</code> instead of <code>riskName</code>, the system uses <code>MergeRisk</code> to combine multiple risk profiles. All validations from all profiles must pass for the signal to be accepted.</p>
<p><img src="../media/31_risk-management_3.svg" alt="Mermaid Diagram"></p>
<p><strong>Example:</strong></p>
<pre><code class="typescript"><span class="hl-0">addStrategy</span><span class="hl-1">({</span><br/><span class="hl-1">  </span><span class="hl-4">strategyName:</span><span class="hl-1"> </span><span class="hl-2">&#39;multi-risk&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">interval:</span><span class="hl-1"> </span><span class="hl-2">&#39;5m&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-0">getSignal</span><span class="hl-4">:</span><span class="hl-1"> </span><span class="hl-7">async</span><span class="hl-1"> (</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">when</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> { </span><span class="hl-5">/* ... */</span><span class="hl-1"> },</span><br/><span class="hl-1">  </span><span class="hl-4">riskList:</span><span class="hl-1"> [</span><span class="hl-2">&#39;conservative&#39;</span><span class="hl-1">, </span><span class="hl-2">&#39;portfolio-limit&#39;</span><span class="hl-1">, </span><span class="hl-2">&#39;trading-hours&#39;</span><span class="hl-1">],</span><br/><span class="hl-1">});</span>
</code><button type="button">Copy</button></pre>

<p>All three profiles (<code>conservative</code>, <code>portfolio-limit</code>, <code>trading-hours</code>) will be validated sequentially. If any validation throws an error, the signal is rejected.</p>
<hr>
<a id="risk-event-monitoring" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Risk Event Monitoring<a href="#risk-event-monitoring" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>The risk system emits events via <code>riskSubject</code> when signals are rejected. This enables real-time monitoring, alerting, and debugging.</p>
<a id="riskcontract-structure" class="tsd-anchor"></a><h3 class="tsd-anchor-link">RiskContract Structure<a href="#riskcontract-structure" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><pre><code class="typescript"><span class="hl-7">interface</span><span class="hl-1"> </span><span class="hl-13">RiskContract</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-4">symbol</span><span class="hl-1">: </span><span class="hl-13">string</span><span class="hl-1">;</span><br/><span class="hl-1">  </span><span class="hl-4">params</span><span class="hl-1">: </span><span class="hl-13">IRiskCheckArgs</span><span class="hl-1">;           </span><span class="hl-5">// Full validation context</span><br/><span class="hl-1">  </span><span class="hl-4">activePositionCount</span><span class="hl-1">: </span><span class="hl-13">number</span><span class="hl-1">;      </span><span class="hl-5">// Portfolio state at rejection</span><br/><span class="hl-1">  </span><span class="hl-4">comment</span><span class="hl-1">: </span><span class="hl-13">string</span><span class="hl-1">;                  </span><span class="hl-5">// Rejection reason (from validation note or &quot;N/A&quot;)</span><br/><span class="hl-1">  </span><span class="hl-4">timestamp</span><span class="hl-1">: </span><span class="hl-13">number</span><span class="hl-1">;                </span><span class="hl-5">// Rejection time (ms)</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<a id="listening-to-risk-rejections" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Listening to Risk Rejections<a href="#listening-to-risk-rejections" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><pre><code class="typescript"><span class="hl-3">import</span><span class="hl-1"> { </span><span class="hl-4">listenRisk</span><span class="hl-1"> } </span><span class="hl-3">from</span><span class="hl-1"> </span><span class="hl-2">&#39;backtest-kit&#39;</span><span class="hl-1">;</span><br/><br/><span class="hl-0">listenRisk</span><span class="hl-1">((</span><span class="hl-4">event</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-4">console</span><span class="hl-1">.</span><span class="hl-0">error</span><span class="hl-1">(</span><span class="hl-2">`Signal rejected on </span><span class="hl-7">${</span><span class="hl-4">event</span><span class="hl-9">.</span><span class="hl-4">symbol</span><span class="hl-7">}</span><span class="hl-2">`</span><span class="hl-1">);</span><br/><span class="hl-1">  </span><span class="hl-4">console</span><span class="hl-1">.</span><span class="hl-0">error</span><span class="hl-1">(</span><span class="hl-2">`Reason: </span><span class="hl-7">${</span><span class="hl-4">event</span><span class="hl-9">.</span><span class="hl-4">comment</span><span class="hl-7">}</span><span class="hl-2">`</span><span class="hl-1">);</span><br/><span class="hl-1">  </span><span class="hl-4">console</span><span class="hl-1">.</span><span class="hl-0">error</span><span class="hl-1">(</span><span class="hl-2">`Active positions: </span><span class="hl-7">${</span><span class="hl-4">event</span><span class="hl-9">.</span><span class="hl-4">activePositionCount</span><span class="hl-7">}</span><span class="hl-2">`</span><span class="hl-1">);</span><br/><span class="hl-1">  </span><span class="hl-4">console</span><span class="hl-1">.</span><span class="hl-0">error</span><span class="hl-1">(</span><span class="hl-2">`Pending signal:`</span><span class="hl-1">, </span><span class="hl-4">event</span><span class="hl-1">.</span><span class="hl-4">params</span><span class="hl-1">.</span><span class="hl-4">pendingSignal</span><span class="hl-1">);</span><br/><span class="hl-1">});</span>
</code><button type="button">Copy</button></pre>

<a id="risk-event-flow" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Risk Event Flow<a href="#risk-event-flow" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><img src="../media/31_risk-management_4.svg" alt="Mermaid Diagram"></p>
<hr>
<a id="global_config-risk-parameters-reference" class="tsd-anchor"></a><h2 class="tsd-anchor-link">GLOBAL_CONFIG Risk Parameters Reference<a href="#global_config-risk-parameters-reference" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><a id="price-validation" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Price Validation<a href="#price-validation" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><table>
<thead>
<tr>
<th>Parameter</th>
<th>Default</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>CC_MIN_TAKEPROFIT_DISTANCE_PERCENT</code></td>
<td>0.5%</td>
<td>Minimum TP distance from <code>priceOpen</code> (covers fees/slippage)</td>
</tr>
<tr>
<td><code>CC_MIN_STOPLOSS_DISTANCE_PERCENT</code></td>
<td>0.5%</td>
<td>Minimum SL distance from <code>priceOpen</code> (volatility buffer)</td>
</tr>
<tr>
<td><code>CC_MAX_STOPLOSS_DISTANCE_PERCENT</code></td>
<td>20%</td>
<td>Maximum SL distance (caps catastrophic losses)</td>
</tr>
<tr>
<td><code>CC_MAX_SIGNAL_LIFETIME_MINUTES</code></td>
<td>1440</td>
<td>Maximum signal duration (prevents eternal signals)</td>
</tr>
</tbody>
</table>
<a id="transaction-costs" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Transaction Costs<a href="#transaction-costs" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><table>
<thead>
<tr>
<th>Parameter</th>
<th>Default</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>CC_PERCENT_FEE</code></td>
<td>0.1%</td>
<td>Fee per transaction (applied 2× for entry+exit)</td>
</tr>
<tr>
<td><code>CC_PERCENT_SLIPPAGE</code></td>
<td>0.1%</td>
<td>Slippage per transaction (applied 2× for entry+exit)</td>
</tr>
</tbody>
</table>
<a id="anomaly-detection" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Anomaly Detection<a href="#anomaly-detection" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><table>
<thead>
<tr>
<th>Parameter</th>
<th>Default</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>CC_GET_CANDLES_PRICE_ANOMALY_THRESHOLD_FACTOR</code></td>
<td>1000</td>
<td>Price deviation factor for anomaly detection</td>
</tr>
<tr>
<td><code>CC_GET_CANDLES_MIN_CANDLES_FOR_MEDIAN</code></td>
<td>5</td>
<td>Minimum candles for median calculation</td>
</tr>
</tbody>
</table>
<a id="scheduled-signal-timeouts" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Scheduled Signal Timeouts<a href="#scheduled-signal-timeouts" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><table>
<thead>
<tr>
<th>Parameter</th>
<th>Default</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>CC_SCHEDULE_AWAIT_MINUTES</code></td>
<td>120</td>
<td>Maximum time to wait for scheduled signal activation</td>
</tr>
</tbody>
</table>
<hr>
<a id="risk-validation-error-handling" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Risk Validation Error Handling<a href="#risk-validation-error-handling" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>When a validation function throws an error, the signal is <strong>immediately rejected</strong> and the system:</p>
<ol>
<li><strong>Logs the rejection</strong> via <code>LoggerService</code></li>
<li><strong>Emits <code>riskSubject</code> event</strong> with rejection details</li>
<li><strong>Calls <code>onRejected</code> callback</strong> (if defined in <code>IRiskCallbacks</code>)</li>
<li><strong>Returns control to strategy</strong> (no signal is scheduled or opened)</li>
<li><strong>Continues execution</strong> (non-fatal, strategy keeps running)</li>
</ol>
<a id="error-propagation" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Error Propagation<a href="#error-propagation" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><img src="../media/31_risk-management_5.svg" alt="Mermaid Diagram"></p>
<p><strong>Important:</strong> Risk validation errors are <strong>non-fatal</strong>. The system continues executing and will attempt to generate new signals on the next tick (subject to <code>interval</code> throttling).</p>
<hr>
<a id="best-practices" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Best Practices<a href="#best-practices" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><a id="1-layered-risk-approach" class="tsd-anchor"></a><h3 class="tsd-anchor-link">1. Layered Risk Approach<a href="#1-layered-risk-approach" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Use multiple risk profiles for defense in depth:</p>
<pre><code class="typescript"><span class="hl-10">riskList</span><span class="hl-1">: [</span><span class="hl-2">&#39;signal-quality&#39;</span><span class="hl-1">, </span><span class="hl-2">&#39;portfolio-limit&#39;</span><span class="hl-1">, </span><span class="hl-2">&#39;market-conditions&#39;</span><span class="hl-1">]</span>
</code><button type="button">Copy</button></pre>

<a id="2-document-validation-logic" class="tsd-anchor"></a><h3 class="tsd-anchor-link">2. Document Validation Logic<a href="#2-document-validation-logic" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Always include <code>note</code> field for rejection transparency:</p>
<pre><code class="typescript"><span class="hl-1">{</span><br/><span class="hl-1">  </span><span class="hl-10">validate</span><span class="hl-1">: (</span><span class="hl-4">payload</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> { </span><span class="hl-5">/* ... */</span><span class="hl-1"> },</span><br/><span class="hl-1">  </span><span class="hl-10">note</span><span class="hl-1">: </span><span class="hl-2">&#39;Maximum 5 concurrent positions allowed&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<a id="3-test-edge-cases" class="tsd-anchor"></a><h3 class="tsd-anchor-link">3. Test Edge Cases<a href="#3-test-edge-cases" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Validate risk logic with extreme inputs:</p>
<ul>
<li>Zero/negative prices → should be caught by stage 1</li>
<li>TP distance = 0.4% → should be caught by stage 3</li>
<li>SL distance = 25% → should be caught by stage 5</li>
<li>Concurrent position limit → test with multiple strategies</li>
</ul>
<a id="4-monitor-risk-rejections" class="tsd-anchor"></a><h3 class="tsd-anchor-link">4. Monitor Risk Rejections<a href="#4-monitor-risk-rejections" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Always attach <code>listenRisk()</code> in production to track why signals are rejected:</p>
<pre><code class="typescript"><span class="hl-0">listenRisk</span><span class="hl-1">((</span><span class="hl-4">event</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-0">logToMonitoring</span><span class="hl-1">(</span><span class="hl-2">&#39;risk_rejection&#39;</span><span class="hl-1">, {</span><br/><span class="hl-1">    </span><span class="hl-4">symbol:</span><span class="hl-1"> </span><span class="hl-4">event</span><span class="hl-1">.</span><span class="hl-4">symbol</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-4">reason:</span><span class="hl-1"> </span><span class="hl-4">event</span><span class="hl-1">.</span><span class="hl-4">comment</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-4">strategy:</span><span class="hl-1"> </span><span class="hl-4">event</span><span class="hl-1">.</span><span class="hl-4">params</span><span class="hl-1">.</span><span class="hl-4">strategyName</span><span class="hl-1">,</span><br/><span class="hl-1">  });</span><br/><span class="hl-1">});</span>
</code><button type="button">Copy</button></pre>

<a id="5-use-appropriate-global_config-values" class="tsd-anchor"></a><h3 class="tsd-anchor-link">5. Use Appropriate GLOBAL_CONFIG Values<a href="#5-use-appropriate-global_config-values" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Adjust validation thresholds based on asset class:</p>
<ul>
<li><strong>Crypto</strong>: Default values (0.5% TP/SL distances)</li>
<li><strong>Forex</strong>: Tighter distances (0.2% might be sufficient)</li>
<li><strong>Stocks</strong>: May need looser SL max (30% instead of 20%)</li>
</ul>
<hr>
<a id="related-documentation" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Related Documentation<a href="#related-documentation" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><ul>
<li><strong><a href="design_25_strategy-development.html">Strategy Development</a></strong>: How to implement <code>getSignal()</code> and configure <code>riskName</code></li>
<li><strong><a href="design_31_risk-management.html">Position Sizing</a></strong>: <code>ISizingSchema</code> for calculating position quantities</li>
<li><strong><a href="design_08_core-concepts.html">Signals &amp; Signal Lifecycle</a></strong>: Full signal state machine including rejection flows</li>
<li><strong><a href="design_52_configuration-reference.html">Configuration Reference</a></strong>: Complete <code>GLOBAL_CONFIG</code> parameter documentation</li>
</ul>
</div></div><div class="col-sidebar"><div class="page-menu"><div class="tsd-navigation settings"><details class="tsd-accordion"><summary class="tsd-accordion-summary"><h3><svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-chevronDown"></use></svg>Settings</h3></summary><div class="tsd-accordion-details"><div class="tsd-filter-visibility"><span class="settings-label">Member Visibility</span><ul id="tsd-filter-options"><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-protected" name="protected"/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Protected</span></label></li><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-inherited" name="inherited" checked/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Inherited</span></label></li><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-external" name="external"/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>External</span></label></li></ul></div><div class="tsd-theme-toggle"><label class="settings-label" for="tsd-theme">Theme</label><select id="tsd-theme"><option value="os">OS</option><option value="light">Light</option><option value="dark">Dark</option></select></div></div></details></div><details open class="tsd-accordion tsd-page-navigation"><summary class="tsd-accordion-summary"><h3><svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-chevronDown"></use></svg>On This Page</h3></summary><div class="tsd-accordion-details"><a href="#risk-management"><span>Risk <wbr/>Management</span></a><ul><li><a href="#purpose-and-scope"><span>Purpose and <wbr/>Scope</span></a></li><li><a href="#risk-management-architecture"><span>Risk <wbr/>Management <wbr/>Architecture</span></a></li><li><a href="#risk-schema-definition"><span>Risk <wbr/>Schema <wbr/>Definition</span></a></li><li><ul><li><a href="#iriskschema-interface"><span>IRisk<wbr/>Schema <wbr/>Interface</span></a></li><li><a href="#iriskvalidation-structure"><span>IRisk<wbr/>Validation <wbr/>Structure</span></a></li><li><a href="#iriskvalidationpayload"><span>IRisk<wbr/>Validation<wbr/>Payload</span></a></li></ul></li><li><a href="#multi-stage-signal-validation-pipeline"><span>Multi-<wbr/>Stage <wbr/>Signal <wbr/>Validation <wbr/>Pipeline</span></a></li><li><ul><li><a href="#validation-stage-details"><span>Validation <wbr/>Stage <wbr/>Details</span></a></li><li><ul><li><a href="#1-price-positivity-check"><span>1. <wbr/>Price <wbr/>Positivity <wbr/>Check</span></a></li><li><a href="#2-tpsl-logic-validation"><span>2. TP/SL <wbr/>Logic <wbr/>Validation</span></a></li><li><a href="#3-minimum-tp-distance-cc_min_takeprofit_distance_percent"><span>3. <wbr/>Minimum TP <wbr/>Distance (CC_<wbr/>MIN_<wbr/>TAKEPROFIT_<wbr/>DISTANCE_<wbr/>PERCENT)</span></a></li><li><a href="#4-minimum-sl-distance-cc_min_stoploss_distance_percent"><span>4. <wbr/>Minimum SL <wbr/>Distance (CC_<wbr/>MIN_<wbr/>STOPLOSS_<wbr/>DISTANCE_<wbr/>PERCENT)</span></a></li><li><a href="#5-maximum-sl-distance-cc_max_stoploss_distance_percent"><span>5. <wbr/>Maximum SL <wbr/>Distance (CC_<wbr/>MAX_<wbr/>STOPLOSS_<wbr/>DISTANCE_<wbr/>PERCENT)</span></a></li><li><a href="#6-lifetime-limit-cc_max_signal_lifetime_minutes"><span>6. <wbr/>Lifetime <wbr/>Limit (CC_<wbr/>MAX_<wbr/>SIGNAL_<wbr/>LIFETIME_<wbr/>MINUTES)</span></a></li><li><a href="#7-candle-data-anomaly-detection"><span>7. <wbr/>Candle <wbr/>Data <wbr/>Anomaly <wbr/>Detection</span></a></li></ul></li></ul></li><li><a href="#custom-risk-validations"><span>Custom <wbr/>Risk <wbr/>Validations</span></a></li><li><ul><li><a href="#basic-risk-profile-example"><span>Basic <wbr/>Risk <wbr/>Profile <wbr/>Example</span></a></li><li><a href="#attaching-risk-profiles-to-strategies"><span>Attaching <wbr/>Risk <wbr/>Profiles to <wbr/>Strategies</span></a></li><li><a href="#portfolio-wide-validation-example"><span>Portfolio-<wbr/>Wide <wbr/>Validation <wbr/>Example</span></a></li></ul></li><li><a href="#portfolio-wide-risk-tracking"><span>Portfolio-<wbr/>Wide <wbr/>Risk <wbr/>Tracking</span></a></li><li><ul><li><a href="#riskglobalservice-architecture"><span>Risk<wbr/>Global<wbr/>Service <wbr/>Architecture</span></a></li><li><a href="#iriskactiveposition-structure"><span>IRisk<wbr/>Active<wbr/>Position <wbr/>Structure</span></a></li><li><a href="#integration-with-clientrisk"><span>Integration with <wbr/>Client<wbr/>Risk</span></a></li></ul></li><li><a href="#mergerisk-for-multiple-risk-profiles"><span>Merge<wbr/>Risk for <wbr/>Multiple <wbr/>Risk <wbr/>Profiles</span></a></li><li><a href="#risk-event-monitoring"><span>Risk <wbr/>Event <wbr/>Monitoring</span></a></li><li><ul><li><a href="#riskcontract-structure"><span>Risk<wbr/>Contract <wbr/>Structure</span></a></li><li><a href="#listening-to-risk-rejections"><span>Listening to <wbr/>Risk <wbr/>Rejections</span></a></li><li><a href="#risk-event-flow"><span>Risk <wbr/>Event <wbr/>Flow</span></a></li></ul></li><li><a href="#global_config-risk-parameters-reference"><span>GLOBAL_<wbr/>CONFIG <wbr/>Risk <wbr/>Parameters <wbr/>Reference</span></a></li><li><ul><li><a href="#price-validation"><span>Price <wbr/>Validation</span></a></li><li><a href="#transaction-costs"><span>Transaction <wbr/>Costs</span></a></li><li><a href="#anomaly-detection"><span>Anomaly <wbr/>Detection</span></a></li><li><a href="#scheduled-signal-timeouts"><span>Scheduled <wbr/>Signal <wbr/>Timeouts</span></a></li></ul></li><li><a href="#risk-validation-error-handling"><span>Risk <wbr/>Validation <wbr/>Error <wbr/>Handling</span></a></li><li><ul><li><a href="#error-propagation"><span>Error <wbr/>Propagation</span></a></li></ul></li><li><a href="#best-practices"><span>Best <wbr/>Practices</span></a></li><li><ul><li><a href="#1-layered-risk-approach"><span>1. <wbr/>Layered <wbr/>Risk <wbr/>Approach</span></a></li><li><a href="#2-document-validation-logic"><span>2. <wbr/>Document <wbr/>Validation <wbr/>Logic</span></a></li><li><a href="#3-test-edge-cases"><span>3. <wbr/>Test <wbr/>Edge <wbr/>Cases</span></a></li><li><a href="#4-monitor-risk-rejections"><span>4. <wbr/>Monitor <wbr/>Risk <wbr/>Rejections</span></a></li><li><a href="#5-use-appropriate-global_config-values"><span>5. <wbr/>Use <wbr/>Appropriate GLOBAL_<wbr/>CONFIG <wbr/>Values</span></a></li></ul></li><li><a href="#related-documentation"><span>Related <wbr/>Documentation</span></a></li></ul></div></details></div><div class="site-menu"><nav class="tsd-navigation"><a href="../modules.html">backtest-kit</a><ul class="tsd-small-nested-navigation" id="tsd-nav-container"><li>Loading...</li></ul></nav></div></div></div><footer><p class="tsd-generator">Generated using <a href="https://typedoc.org/" target="_blank">TypeDoc</a></p></footer><div class="overlay"></div></body></html>

<!-- Yandex.Metrika counter -->
<script type="text/javascript">
    (function(m,e,t,r,i,k,a){
        m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
        m[i].l=1*new Date();
        for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }}
        k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)
    })(window, document,'script','https://mc.yandex.ru/metrika/tag.js?id=105455585', 'ym');

    ym(105455585, 'init', {ssr:true, webvisor:true, clickmap:true, ecommerce:"dataLayer", accurateTrackBounce:true, trackLinks:true});
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/105455585" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
<!-- /Yandex.Metrika counter -->

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-3MQZEBBDDR"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-3MQZEBBDDR');
</script>
