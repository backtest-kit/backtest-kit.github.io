<!DOCTYPE html><html class="default" lang="en" data-base=".."><head><meta charset="utf-8"/><meta http-equiv="x-ua-compatible" content="IE=edge"/><title>design/07_layered-architecture | backtest-kit</title><meta name="description" content="Documentation for backtest-kit"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="stylesheet" href="../assets/style.css"/><link rel="stylesheet" href="../assets/highlight.css"/><script defer src="../assets/main.js"></script><script async src="../assets/icons.js" id="tsd-icons-script"></script><script async src="../assets/search.js" id="tsd-search-script"></script><script async src="../assets/navigation.js" id="tsd-nav-script"></script><script async src="../assets/hierarchy.js" id="tsd-hierarchy-script"></script></head><body><script>document.documentElement.dataset.theme = localStorage.getItem("tsd-theme") || "os";document.body.style.display="none";setTimeout(() => app?app.showPage():document.body.style.removeProperty("display"),500)</script><header class="tsd-page-toolbar"><div class="tsd-toolbar-contents container"><div class="table-cell" id="tsd-search"><div class="field"><label for="tsd-search-field" class="tsd-widget tsd-toolbar-icon search no-caption"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-search"></use></svg></label><input type="text" id="tsd-search-field" aria-label="Search"/></div><div class="field"><div id="tsd-toolbar-links"></div></div><ul class="results"><li class="state loading">Preparing search index...</li><li class="state failure">The search index is not available</li></ul><a href="../index.html" class="title">backtest-kit</a></div><div class="table-cell" id="tsd-widgets"><a href="#" class="tsd-widget tsd-toolbar-icon menu no-caption" data-toggle="menu" aria-label="Menu"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-menu"></use></svg></a></div></div></header><div class="container container-main"><div class="col-content"><div class="tsd-page-title"><ul class="tsd-breadcrumb"><li><a href="../modules.html">backtest-kit</a></li><li><a href="design_07_layered-architecture.html">design/07_layered-architecture</a></li></ul></div><div class="tsd-panel tsd-typography"><a id="layered-architecture" class="tsd-anchor"></a><h1 class="tsd-anchor-link">Layered Architecture<a href="#layered-architecture" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h1><a id="purpose-and-scope" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Purpose and Scope<a href="#purpose-and-scope" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>This document describes the five-layer architecture of backtest-kit, explaining the responsibilities and boundaries of each layer: Public API, Orchestration, Service, Client, and Persistence. Each layer has specific concerns and dependencies flow unidirectionally from top to bottom.</p>
<p>For information about the dependency injection system that wires these layers together, see <a href="design_08_dependency-injection-system.html">Dependency Injection System</a>. For details on individual service categories, see <a href="design_09_service-categories.html">Service Categories</a>. For client implementations, see <a href="design_10_client-layer.html">Client Layer</a>.</p>
<hr>
<a id="architectural-overview" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Architectural Overview<a href="#architectural-overview" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>The framework implements a strict layered architecture with five distinct layers. Each layer has clear responsibilities and dependencies flow downward only—higher layers depend on lower layers, but not vice versa.</p>
<p><img src="../media/07-layered-architecture_0.svg" alt="Mermaid Diagram"></p>
<p>, High-Level System Architecture Diagram 1</p>
<hr>
<a id="layer-1-public-api" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Layer 1: Public API<a href="#layer-1-public-api" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>The Public API Layer provides user-facing functions that serve as the framework's entry points. This layer has no business logic—it delegates immediately to the Orchestration Layer.</p>
<a id="registration-functions" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Registration Functions<a href="#registration-functions" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><table>
<thead>
<tr>
<th>Function</th>
<th>Purpose</th>
<th>Target Service</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>addStrategy()</code></td>
<td>Register trading strategy</td>
<td><code>StrategySchemaService</code></td>
</tr>
<tr>
<td><code>addExchange()</code></td>
<td>Register data source</td>
<td><code>ExchangeSchemaService</code></td>
</tr>
<tr>
<td><code>addFrame()</code></td>
<td>Register timeframe</td>
<td><code>FrameSchemaService</code></td>
</tr>
<tr>
<td><code>addWalker()</code></td>
<td>Register strategy walker</td>
<td><code>WalkerSchemaService</code></td>
</tr>
<tr>
<td><code>addSizing()</code></td>
<td>Register position sizing</td>
<td><code>SizingSchemaService</code></td>
</tr>
<tr>
<td><code>addRisk()</code></td>
<td>Register risk profile</td>
<td><code>RiskSchemaService</code></td>
</tr>
<tr>
<td><code>addOptimizer()</code></td>
<td>Register LLM optimizer</td>
<td><code>OptimizerSchemaService</code></td>
</tr>
</tbody>
</table>
<a id="execution-functions" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Execution Functions<a href="#execution-functions" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><table>
<thead>
<tr>
<th>Function</th>
<th>Purpose</th>
<th>Target Class</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>Backtest.run()</code></td>
<td>Historical simulation</td>
<td><code>BacktestCommandService</code></td>
</tr>
<tr>
<td><code>Live.run()</code></td>
<td>Real-time trading</td>
<td><code>LiveCommandService</code></td>
</tr>
<tr>
<td><code>Walker.run()</code></td>
<td>Strategy comparison</td>
<td><code>WalkerCommandService</code></td>
</tr>
<tr>
<td><code>Optimizer.run()</code></td>
<td>LLM code generation</td>
<td><code>OptimizerGlobalService</code></td>
</tr>
</tbody>
</table>
<a id="event-listeners" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Event Listeners<a href="#event-listeners" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><table>
<thead>
<tr>
<th>Function</th>
<th>Purpose</th>
<th>Event Emitter</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>listenSignal()</code></td>
<td>All signal events</td>
<td><code>signalEmitter</code></td>
</tr>
<tr>
<td><code>listenSignalBacktest()</code></td>
<td>Backtest signals only</td>
<td><code>signalBacktestEmitter</code></td>
</tr>
<tr>
<td><code>listenSignalLive()</code></td>
<td>Live signals only</td>
<td><code>signalLiveEmitter</code></td>
</tr>
<tr>
<td><code>listenError()</code></td>
<td>Recoverable errors</td>
<td><code>errorEmitter</code></td>
</tr>
<tr>
<td><code>listenExit()</code></td>
<td>Fatal errors</td>
<td><code>exitEmitter</code></td>
</tr>
</tbody>
</table>
<hr>
<a id="layer-2-orchestration" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Layer 2: Orchestration<a href="#layer-2-orchestration" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>The Orchestration Layer implements the four execution modes as public classes. Each class validates inputs and delegates to Command Services.</p>
<p><img src="../media/07-layered-architecture_1.svg" alt="Mermaid Diagram"></p>
<a id="execution-patterns" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Execution Patterns<a href="#execution-patterns" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Each orchestration class implements two execution patterns:</p>
<ol>
<li><strong>Synchronous Pattern</strong> (<code>run()</code>) - Returns async generator, caller controls iteration</li>
<li><strong>Background Pattern</strong> (<code>background()</code>) - Runs in background with error emitters</li>
</ol>
<p>The background pattern wraps the generator in error handling and emits completion events via <code>doneBacktestSubject</code>, <code>doneLiveSubject</code>, or <code>doneWalkerSubject</code>.</p>
<hr>
<a id="layer-3-service-layer" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Layer 3: Service Layer<a href="#layer-3-service-layer" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>The Service Layer is the most complex layer, implementing dependency injection with 11 service categories. All services are registered via <a href="">src/lib/core/provide.ts:1-141</a> and aggregated into the <code>backtest</code> singleton at <a href="">src/lib/index.ts:221-234</a>.</p>
<a id="service-aggregation-structure" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Service Aggregation Structure<a href="#service-aggregation-structure" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><img src="../media/07-layered-architecture_2.svg" alt="Mermaid Diagram"></p>
<a id="31-base-services" class="tsd-anchor"></a><h3 class="tsd-anchor-link">3.1 Base Services<a href="#31-base-services" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Provides foundational logging functionality used by all other services.</p>
<table>
<thead>
<tr>
<th>Service</th>
<th>Symbol</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>LoggerService</code></td>
<td><code>TYPES.loggerService</code></td>
<td>Structured logging with context injection</td>
</tr>
</tbody>
</table>
<a id="32-context-services" class="tsd-anchor"></a><h3 class="tsd-anchor-link">3.2 Context Services<a href="#32-context-services" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Manages execution context propagation using <code>di-scoped</code> pattern.</p>
<table>
<thead>
<tr>
<th>Service</th>
<th>Symbol</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>ExecutionContextService</code></td>
<td><code>TYPES.executionContextService</code></td>
<td><code>symbol</code>, <code>when</code>, <code>backtest</code> flag</td>
</tr>
<tr>
<td><code>MethodContextService</code></td>
<td><code>TYPES.methodContextService</code></td>
<td><code>strategyName</code>, <code>exchangeName</code>, <code>frameName</code> routing</td>
</tr>
</tbody>
</table>
<a id="33-schema-services" class="tsd-anchor"></a><h3 class="tsd-anchor-link">3.3 Schema Services<a href="#33-schema-services" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Implements registry pattern for configuration storage using <code>ToolRegistry</code> from <code>functools-kit</code>.</p>
<table>
<thead>
<tr>
<th>Service</th>
<th>Symbol</th>
<th>Stores</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>StrategySchemaService</code></td>
<td><code>TYPES.strategySchemaService</code></td>
<td><code>IStrategySchema</code></td>
</tr>
<tr>
<td><code>ExchangeSchemaService</code></td>
<td><code>TYPES.exchangeSchemaService</code></td>
<td><code>IExchangeSchema</code></td>
</tr>
<tr>
<td><code>FrameSchemaService</code></td>
<td><code>TYPES.frameSchemaService</code></td>
<td><code>IFrameSchema</code></td>
</tr>
<tr>
<td><code>WalkerSchemaService</code></td>
<td><code>TYPES.walkerSchemaService</code></td>
<td><code>IWalkerSchema</code></td>
</tr>
<tr>
<td><code>SizingSchemaService</code></td>
<td><code>TYPES.sizingSchemaService</code></td>
<td><code>ISizingSchema</code></td>
</tr>
<tr>
<td><code>RiskSchemaService</code></td>
<td><code>TYPES.riskSchemaService</code></td>
<td><code>IRiskSchema</code></td>
</tr>
<tr>
<td><code>OptimizerSchemaService</code></td>
<td><code>TYPES.optimizerSchemaService</code></td>
<td><code>IOptimizerSchema</code></td>
</tr>
</tbody>
</table>
<a id="34-validation-services" class="tsd-anchor"></a><h3 class="tsd-anchor-link">3.4 Validation Services<a href="#34-validation-services" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Enforces schema existence and structural validation with memoization for performance.</p>
<table>
<thead>
<tr>
<th>Service</th>
<th>Symbol</th>
<th>Validates</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>StrategyValidationService</code></td>
<td><code>TYPES.strategyValidationService</code></td>
<td>Strategy schema structure</td>
</tr>
<tr>
<td><code>ExchangeValidationService</code></td>
<td><code>TYPES.exchangeValidationService</code></td>
<td>Exchange schema structure</td>
</tr>
<tr>
<td><code>FrameValidationService</code></td>
<td><code>TYPES.frameValidationService</code></td>
<td>Frame date ranges</td>
</tr>
<tr>
<td><code>WalkerValidationService</code></td>
<td><code>TYPES.walkerValidationService</code></td>
<td>Walker strategy lists</td>
</tr>
<tr>
<td><code>SizingValidationService</code></td>
<td><code>TYPES.sizingValidationService</code></td>
<td>Sizing parameters</td>
</tr>
<tr>
<td><code>RiskValidationService</code></td>
<td><code>TYPES.riskValidationService</code></td>
<td>Risk profile existence</td>
</tr>
<tr>
<td><code>OptimizerValidationService</code></td>
<td><code>TYPES.optimizerValidationService</code></td>
<td>Optimizer configuration</td>
</tr>
<tr>
<td><code>ConfigValidationService</code></td>
<td><code>TYPES.configValidationService</code></td>
<td>Global config viability</td>
</tr>
</tbody>
</table>
<a id="35-connection-services" class="tsd-anchor"></a><h3 class="tsd-anchor-link">3.5 Connection Services<a href="#35-connection-services" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Provides memoized client instance factories. Each service caches client instances by unique keys.</p>
<table>
<thead>
<tr>
<th>Service</th>
<th>Symbol</th>
<th>Key Pattern</th>
<th>Creates</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>StrategyConnectionService</code></td>
<td><code>TYPES.strategyConnectionService</code></td>
<td><code>symbol:strategyName</code></td>
<td><code>ClientStrategy</code></td>
</tr>
<tr>
<td><code>ExchangeConnectionService</code></td>
<td><code>TYPES.exchangeConnectionService</code></td>
<td><code>exchangeName</code></td>
<td><code>ClientExchange</code></td>
</tr>
<tr>
<td><code>FrameConnectionService</code></td>
<td><code>TYPES.frameConnectionService</code></td>
<td><code>frameName</code></td>
<td><code>ClientFrame</code></td>
</tr>
<tr>
<td><code>SizingConnectionService</code></td>
<td><code>TYPES.sizingConnectionService</code></td>
<td><code>sizingName</code></td>
<td><code>ClientSizing</code></td>
</tr>
<tr>
<td><code>RiskConnectionService</code></td>
<td><code>TYPES.riskConnectionService</code></td>
<td><code>riskName</code></td>
<td><code>ClientRisk</code></td>
</tr>
<tr>
<td><code>OptimizerConnectionService</code></td>
<td><code>TYPES.optimizerConnectionService</code></td>
<td><code>optimizerName</code></td>
<td><code>ClientOptimizer</code></td>
</tr>
<tr>
<td><code>PartialConnectionService</code></td>
<td><code>TYPES.partialConnectionService</code></td>
<td><code>symbol</code></td>
<td><code>ClientPartial</code></td>
</tr>
</tbody>
</table>
<a id="36-core-services" class="tsd-anchor"></a><h3 class="tsd-anchor-link">3.6 Core Services<a href="#36-core-services" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Implements domain logic for strategy execution, exchange data, and timeframe generation.</p>
<table>
<thead>
<tr>
<th>Service</th>
<th>Symbol</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>StrategyCoreService</code></td>
<td><code>TYPES.strategyCoreService</code></td>
<td><code>tick()</code>, <code>backtest()</code> signal lifecycle</td>
</tr>
<tr>
<td><code>ExchangeCoreService</code></td>
<td><code>TYPES.exchangeCoreService</code></td>
<td><code>getCandles()</code>, VWAP calculation</td>
</tr>
<tr>
<td><code>FrameCoreService</code></td>
<td><code>TYPES.frameCoreService</code></td>
<td><code>getTimeframe()</code> date iteration</td>
</tr>
</tbody>
</table>
<a id="37-global-services" class="tsd-anchor"></a><h3 class="tsd-anchor-link">3.7 Global Services<a href="#37-global-services" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Manages shared state across multiple strategy instances.</p>
<table>
<thead>
<tr>
<th>Service</th>
<th>Symbol</th>
<th>Manages</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>SizingGlobalService</code></td>
<td><code>TYPES.sizingGlobalService</code></td>
<td>Position size calculation</td>
</tr>
<tr>
<td><code>RiskGlobalService</code></td>
<td><code>TYPES.riskGlobalService</code></td>
<td>Active positions tracking</td>
</tr>
<tr>
<td><code>OptimizerGlobalService</code></td>
<td><code>TYPES.optimizerGlobalService</code></td>
<td>LLM orchestration</td>
</tr>
<tr>
<td><code>PartialGlobalService</code></td>
<td><code>TYPES.partialGlobalService</code></td>
<td>P/L milestone tracking</td>
</tr>
</tbody>
</table>
<a id="38-command-services" class="tsd-anchor"></a><h3 class="tsd-anchor-link">3.8 Command Services<a href="#38-command-services" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>High-level orchestrators that validate inputs and delegate to Logic Services.</p>
<table>
<thead>
<tr>
<th>Service</th>
<th>Symbol</th>
<th>Orchestrates</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>BacktestCommandService</code></td>
<td><code>TYPES.backtestCommandService</code></td>
<td>Backtest execution</td>
</tr>
<tr>
<td><code>LiveCommandService</code></td>
<td><code>TYPES.liveCommandService</code></td>
<td>Live execution</td>
</tr>
<tr>
<td><code>WalkerCommandService</code></td>
<td><code>TYPES.walkerCommandService</code></td>
<td>Walker execution</td>
</tr>
</tbody>
</table>
<a id="39-logic-services" class="tsd-anchor"></a><h3 class="tsd-anchor-link">3.9 Logic Services<a href="#39-logic-services" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Implements execution flow as async generators with public/private split. Public services handle context setup, private services implement generator logic.</p>
<table>
<thead>
<tr>
<th>Service</th>
<th>Symbol</th>
<th>Pattern</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>BacktestLogicPublicService</code></td>
<td><code>TYPES.backtestLogicPublicService</code></td>
<td>Context wrapper</td>
</tr>
<tr>
<td><code>BacktestLogicPrivateService</code></td>
<td><code>TYPES.backtestLogicPrivateService</code></td>
<td>Timeframe iteration</td>
</tr>
<tr>
<td><code>LiveLogicPublicService</code></td>
<td><code>TYPES.liveLogicPublicService</code></td>
<td>Context wrapper</td>
</tr>
<tr>
<td><code>LiveLogicPrivateService</code></td>
<td><code>TYPES.liveLogicPrivateService</code></td>
<td>Infinite loop</td>
</tr>
<tr>
<td><code>WalkerLogicPublicService</code></td>
<td><code>TYPES.walkerLogicPublicService</code></td>
<td>Context wrapper</td>
</tr>
<tr>
<td><code>WalkerLogicPrivateService</code></td>
<td><code>TYPES.walkerLogicPrivateService</code></td>
<td>Sequential backtests</td>
</tr>
</tbody>
</table>
<a id="310-markdown-services" class="tsd-anchor"></a><h3 class="tsd-anchor-link">3.10 Markdown Services<a href="#310-markdown-services" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Generates reports by subscribing to event emitters and accumulating data with bounded queues.</p>
<table>
<thead>
<tr>
<th>Service</th>
<th>Symbol</th>
<th>Subscribes To</th>
<th>MAX_EVENTS</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>BacktestMarkdownService</code></td>
<td><code>TYPES.backtestMarkdownService</code></td>
<td><code>signalBacktestEmitter</code></td>
<td>250</td>
</tr>
<tr>
<td><code>LiveMarkdownService</code></td>
<td><code>TYPES.liveMarkdownService</code></td>
<td><code>signalLiveEmitter</code></td>
<td>250</td>
</tr>
<tr>
<td><code>ScheduleMarkdownService</code></td>
<td><code>TYPES.scheduleMarkdownService</code></td>
<td><code>signalEmitter</code></td>
<td>250</td>
</tr>
<tr>
<td><code>PerformanceMarkdownService</code></td>
<td><code>TYPES.performanceMarkdownService</code></td>
<td><code>performanceEmitter</code></td>
<td>10000</td>
</tr>
<tr>
<td><code>WalkerMarkdownService</code></td>
<td><code>TYPES.walkerMarkdownService</code></td>
<td><code>walkerEmitter</code></td>
<td>Unbounded</td>
</tr>
<tr>
<td><code>HeatMarkdownService</code></td>
<td><code>TYPES.heatMarkdownService</code></td>
<td><code>signalEmitter</code></td>
<td>Unbounded</td>
</tr>
<tr>
<td><code>PartialMarkdownService</code></td>
<td><code>TYPES.partialMarkdownService</code></td>
<td><code>partialProfitSubject</code>, <code>partialLossSubject</code></td>
<td>250</td>
</tr>
<tr>
<td><code>OutlineMarkdownService</code></td>
<td><code>TYPES.outlineMarkdownService</code></td>
<td>N/A</td>
<td>N/A</td>
</tr>
<tr>
<td><code>RiskMarkdownService</code></td>
<td><code>TYPES.riskMarkdownService</code></td>
<td><code>riskSubject</code></td>
<td>Unbounded</td>
</tr>
</tbody>
</table>
<a id="311-template-services" class="tsd-anchor"></a><h3 class="tsd-anchor-link">3.11 Template Services<a href="#311-template-services" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Generates code templates for optimizer output.</p>
<table>
<thead>
<tr>
<th>Service</th>
<th>Symbol</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>OptimizerTemplateService</code></td>
<td><code>TYPES.optimizerTemplateService</code></td>
<td>Default code templates</td>
</tr>
</tbody>
</table>
<hr>
<a id="layer-4-client-layer" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Layer 4: Client Layer<a href="#layer-4-client-layer" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>The Client Layer contains pure business logic without dependency injection. Client classes use prototype methods for memory efficiency and are instantiated by Connection Services.</p>
<p><img src="../media/07-layered-architecture_3.svg" alt="Mermaid Diagram"></p>
<a id="client-responsibilities" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Client Responsibilities<a href="#client-responsibilities" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><table>
<thead>
<tr>
<th>Client</th>
<th>Purpose</th>
<th>Key Methods</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>ClientStrategy</code></td>
<td>Signal lifecycle management</td>
<td><code>tick()</code>, <code>backtest()</code>, <code>waitForInit()</code></td>
</tr>
<tr>
<td><code>ClientExchange</code></td>
<td>Data fetching and VWAP</td>
<td><code>getCandles()</code>, <code>getAveragePrice()</code>, <code>getNextCandles()</code></td>
</tr>
<tr>
<td><code>ClientFrame</code></td>
<td>Timeframe generation</td>
<td><code>getTimeframe()</code></td>
</tr>
<tr>
<td><code>ClientRisk</code></td>
<td>Portfolio validation</td>
<td><code>validate()</code>, <code>getActivePositions()</code></td>
</tr>
<tr>
<td><code>ClientSizing</code></td>
<td>Position size calculation</td>
<td><code>calculate()</code></td>
</tr>
<tr>
<td><code>ClientOptimizer</code></td>
<td>LLM integration</td>
<td><code>run()</code>, Template merging</td>
</tr>
<tr>
<td><code>ClientPartial</code></td>
<td>P/L milestone tracking</td>
<td><code>check()</code>, Set-based deduplication</td>
</tr>
</tbody>
</table>
<p>, High-Level System Architecture Diagram 1</p>
<hr>
<a id="layer-5-persistence-layer" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Layer 5: Persistence Layer<a href="#layer-5-persistence-layer" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>The Persistence Layer implements crash-safe state storage using atomic JSON file writes. All persistence adapters extend <code>PersistBase</code> and follow the singleshot initialization pattern.</p>
<p><img src="../media/07-layered-architecture_4.svg" alt="Mermaid Diagram"></p>
<a id="persistence-patterns" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Persistence Patterns<a href="#persistence-patterns" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><ol>
<li><strong>Atomic Writes</strong> - Write to temporary file, then rename to target path</li>
<li><strong>Singleshot Init</strong> - <code>waitForInit()</code> loads persisted state once per instance</li>
<li><strong>Crash Recovery</strong> - Live mode reads persisted signals on startup</li>
<li><strong>Pluggable Adapters</strong> - Extend <code>PersistBase</code> for custom storage backends</li>
</ol>
<a id="file-locations" class="tsd-anchor"></a><h3 class="tsd-anchor-link">File Locations<a href="#file-locations" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><table>
<thead>
<tr>
<th>Adapter</th>
<th>File Pattern</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>PersistSignalAdapter</code></td>
<td><code>./signals/{symbol}_{strategyName}.json</code></td>
<td>Open signal state</td>
</tr>
<tr>
<td><code>PersistScheduleAdapter</code></td>
<td><code>./schedules/{symbol}_{strategyName}.json</code></td>
<td>Scheduled signals</td>
</tr>
<tr>
<td><code>PersistRiskAdapter</code></td>
<td><code>./risk/{riskName}.json</code></td>
<td>Active positions</td>
</tr>
<tr>
<td><code>PersistPartialAdapter</code></td>
<td><code>./partial/{symbol}_{strategyName}.json</code></td>
<td>P/L milestones</td>
</tr>
</tbody>
</table>
<hr>
<a id="layer-interaction-flow" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Layer Interaction Flow<a href="#layer-interaction-flow" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>This diagram shows how a typical Backtest execution flows through all five layers:</p>
<p><img src="../media/07-layered-architecture_5.svg" alt="Mermaid Diagram"></p>
<p>, High-Level System Architecture Diagram 2</p>
<hr>
<a id="dependency-flow" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Dependency Flow<a href="#dependency-flow" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>Dependencies flow strictly downward. This table shows which layers depend on which:</p>
<table>
<thead>
<tr>
<th>Layer</th>
<th>Depends On</th>
<th>Does Not Depend On</th>
</tr>
</thead>
<tbody>
<tr>
<td>Public API</td>
<td>Orchestration</td>
<td>Service, Client, Persistence</td>
</tr>
<tr>
<td>Orchestration</td>
<td>Service (Command)</td>
<td>Client, Persistence</td>
</tr>
<tr>
<td>Service</td>
<td>Service (lower categories), Client, Persistence</td>
<td>Orchestration, Public API</td>
</tr>
<tr>
<td>Client</td>
<td>Persistence</td>
<td>Service, Orchestration, Public API</td>
</tr>
<tr>
<td>Persistence</td>
<td>None</td>
<td>All other layers</td>
</tr>
</tbody>
</table>
<a id="service-category-dependencies" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Service Category Dependencies<a href="#service-category-dependencies" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Within the Service Layer, dependencies flow in this order:</p>
<p><img src="../media/07-layered-architecture_6.svg" alt="Mermaid Diagram"></p>
<p>, High-Level System Architecture Diagram 3</p>
<hr>
<a id="summary" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Summary<a href="#summary" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>The five-layer architecture ensures clear separation of concerns:</p>
<ol>
<li><strong>Public API Layer</strong> - User-facing functions with no business logic</li>
<li><strong>Orchestration Layer</strong> - Execution mode implementations (Backtest, Live, Walker, Optimizer)</li>
<li><strong>Service Layer</strong> - 11 service categories implementing dependency injection</li>
<li><strong>Client Layer</strong> - Pure business logic without DI, memoized by Connection Services</li>
<li><strong>Persistence Layer</strong> - Crash-safe storage with atomic writes</li>
</ol>
<p>This architecture enables:</p>
<ul>
<li><strong>Testability</strong> - Each layer can be tested in isolation</li>
<li><strong>Extensibility</strong> - New execution modes can be added without changing lower layers</li>
<li><strong>Memory Efficiency</strong> - Connection Services memoize client instances</li>
<li><strong>Type Safety</strong> - Discriminated unions and TypeScript throughout</li>
<li><strong>Crash Recovery</strong> - Persistence Layer enables state restoration</li>
</ul>
</div></div><div class="col-sidebar"><div class="page-menu"><div class="tsd-navigation settings"><details class="tsd-accordion"><summary class="tsd-accordion-summary"><h3><svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-chevronDown"></use></svg>Settings</h3></summary><div class="tsd-accordion-details"><div class="tsd-filter-visibility"><span class="settings-label">Member Visibility</span><ul id="tsd-filter-options"><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-protected" name="protected"/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Protected</span></label></li><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-inherited" name="inherited" checked/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Inherited</span></label></li><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-external" name="external"/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>External</span></label></li></ul></div><div class="tsd-theme-toggle"><label class="settings-label" for="tsd-theme">Theme</label><select id="tsd-theme"><option value="os">OS</option><option value="light">Light</option><option value="dark">Dark</option></select></div></div></details></div><details open class="tsd-accordion tsd-page-navigation"><summary class="tsd-accordion-summary"><h3><svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-chevronDown"></use></svg>On This Page</h3></summary><div class="tsd-accordion-details"><a href="#layered-architecture"><span>Layered <wbr/>Architecture</span></a><ul><li><a href="#purpose-and-scope"><span>Purpose and <wbr/>Scope</span></a></li><li><a href="#architectural-overview"><span>Architectural <wbr/>Overview</span></a></li><li><a href="#layer-1-public-api"><span>Layer 1: <wbr/>Public API</span></a></li><li><ul><li><a href="#registration-functions"><span>Registration <wbr/>Functions</span></a></li><li><a href="#execution-functions"><span>Execution <wbr/>Functions</span></a></li><li><a href="#event-listeners"><span>Event <wbr/>Listeners</span></a></li></ul></li><li><a href="#layer-2-orchestration"><span>Layer 2: <wbr/>Orchestration</span></a></li><li><ul><li><a href="#execution-patterns"><span>Execution <wbr/>Patterns</span></a></li></ul></li><li><a href="#layer-3-service-layer"><span>Layer 3: <wbr/>Service <wbr/>Layer</span></a></li><li><ul><li><a href="#service-aggregation-structure"><span>Service <wbr/>Aggregation <wbr/>Structure</span></a></li><li><a href="#31-base-services"><span>3.1 <wbr/>Base <wbr/>Services</span></a></li><li><a href="#32-context-services"><span>3.2 <wbr/>Context <wbr/>Services</span></a></li><li><a href="#33-schema-services"><span>3.3 <wbr/>Schema <wbr/>Services</span></a></li><li><a href="#34-validation-services"><span>3.4 <wbr/>Validation <wbr/>Services</span></a></li><li><a href="#35-connection-services"><span>3.5 <wbr/>Connection <wbr/>Services</span></a></li><li><a href="#36-core-services"><span>3.6 <wbr/>Core <wbr/>Services</span></a></li><li><a href="#37-global-services"><span>3.7 <wbr/>Global <wbr/>Services</span></a></li><li><a href="#38-command-services"><span>3.8 <wbr/>Command <wbr/>Services</span></a></li><li><a href="#39-logic-services"><span>3.9 <wbr/>Logic <wbr/>Services</span></a></li><li><a href="#310-markdown-services"><span>3.10 <wbr/>Markdown <wbr/>Services</span></a></li><li><a href="#311-template-services"><span>3.11 <wbr/>Template <wbr/>Services</span></a></li></ul></li><li><a href="#layer-4-client-layer"><span>Layer 4: <wbr/>Client <wbr/>Layer</span></a></li><li><ul><li><a href="#client-responsibilities"><span>Client <wbr/>Responsibilities</span></a></li></ul></li><li><a href="#layer-5-persistence-layer"><span>Layer 5: <wbr/>Persistence <wbr/>Layer</span></a></li><li><ul><li><a href="#persistence-patterns"><span>Persistence <wbr/>Patterns</span></a></li><li><a href="#file-locations"><span>File <wbr/>Locations</span></a></li></ul></li><li><a href="#layer-interaction-flow"><span>Layer <wbr/>Interaction <wbr/>Flow</span></a></li><li><a href="#dependency-flow"><span>Dependency <wbr/>Flow</span></a></li><li><ul><li><a href="#service-category-dependencies"><span>Service <wbr/>Category <wbr/>Dependencies</span></a></li></ul></li><li><a href="#summary"><span>Summary</span></a></li></ul></div></details></div><div class="site-menu"><nav class="tsd-navigation"><a href="../modules.html">backtest-kit</a><ul class="tsd-small-nested-navigation" id="tsd-nav-container"><li>Loading...</li></ul></nav></div></div></div><footer><p class="tsd-generator">Generated using <a href="https://typedoc.org/" target="_blank">TypeDoc</a></p></footer><div class="overlay"></div></body></html>

<!-- Yandex.Metrika counter -->
<script type="text/javascript">
    (function(m,e,t,r,i,k,a){
        m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
        m[i].l=1*new Date();
        for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }}
        k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)
    })(window, document,'script','https://mc.yandex.ru/metrika/tag.js?id=105455585', 'ym');

    ym(105455585, 'init', {ssr:true, webvisor:true, clickmap:true, ecommerce:"dataLayer", accurateTrackBounce:true, trackLinks:true});
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/105455585" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
<!-- /Yandex.Metrika counter -->

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-3MQZEBBDDR"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-3MQZEBBDDR');
</script>
