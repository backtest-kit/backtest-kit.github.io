<!DOCTYPE html><html class="default" lang="en" data-base=".."><head><meta charset="utf-8"/><meta http-equiv="x-ua-compatible" content="IE=edge"/><title>design/04_architecture | backtest-kit</title><meta name="description" content="Documentation for backtest-kit"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="stylesheet" href="../assets/style.css"/><link rel="stylesheet" href="../assets/highlight.css"/><script defer src="../assets/main.js"></script><script async src="../assets/icons.js" id="tsd-icons-script"></script><script async src="../assets/search.js" id="tsd-search-script"></script><script async src="../assets/navigation.js" id="tsd-nav-script"></script><script async src="../assets/hierarchy.js" id="tsd-hierarchy-script"></script></head><body><script>document.documentElement.dataset.theme = localStorage.getItem("tsd-theme") || "os";document.body.style.display="none";setTimeout(() => app?app.showPage():document.body.style.removeProperty("display"),500)</script><header class="tsd-page-toolbar"><div class="tsd-toolbar-contents container"><div class="table-cell" id="tsd-search"><div class="field"><label for="tsd-search-field" class="tsd-widget tsd-toolbar-icon search no-caption"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-search"></use></svg></label><input type="text" id="tsd-search-field" aria-label="Search"/></div><div class="field"><div id="tsd-toolbar-links"></div></div><ul class="results"><li class="state loading">Preparing search index...</li><li class="state failure">The search index is not available</li></ul><a href="../index.html" class="title">backtest-kit</a></div><div class="table-cell" id="tsd-widgets"><a href="#" class="tsd-widget tsd-toolbar-icon menu no-caption" data-toggle="menu" aria-label="Menu"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-menu"></use></svg></a></div></div></header><div class="container container-main"><div class="col-content"><div class="tsd-page-title"><ul class="tsd-breadcrumb"><li><a href="../modules.html">backtest-kit</a></li><li><a href="design_04_architecture.html">design/04_architecture</a></li></ul></div><div class="tsd-panel tsd-typography"><a id="architecture" class="tsd-anchor"></a><h1 class="tsd-anchor-link">Architecture<a href="#architecture" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h1><p>This document describes the four-layer clean architecture pattern of the backtest-kit framework, including the dependency injection system, service organization, and how components interact across architectural boundaries. It explains how the system maintains separation of concerns through explicit layer boundaries and context propagation mechanisms.</p>
<p>For specific service implementations within each layer, see <a href="design_05_layer_responsibilities.html">Layer Responsibilities</a>. For details on the DI system mechanics, see <a href="design_06_dependency_injection_system.html">Dependency Injection System</a>. For context propagation patterns, see <a href="design_07_context_propagation.html">Context Propagation</a>.</p>
<hr>
<a id="architectural-overview" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Architectural Overview<a href="#architectural-overview" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>The framework implements a <strong>four-layer clean architecture</strong> with strict separation of concerns. Each layer has well-defined responsibilities and communicates through explicit interfaces, enabling testability, modularity, and configuration flexibility.</p>
<p><img src="../media/04_Architecture_0.svg" alt="Mermaid Diagram"></p>
<a id="layer-responsibilities-summary" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Layer Responsibilities Summary<a href="#layer-responsibilities-summary" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><table>
<thead>
<tr>
<th>Layer</th>
<th>Directory</th>
<th>Purpose</th>
<th>Key Characteristics</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Public API</strong></td>
<td><code>src/classes/*</code>, <code>src/function/*</code></td>
<td>User-facing utilities and entry points</td>
<td>No business logic, delegates to services</td>
</tr>
<tr>
<td><strong>Service Orchestration</strong></td>
<td><code>src/lib/services/*</code></td>
<td>Dependency injection, routing, context management</td>
<td>Complex wiring, no domain logic</td>
</tr>
<tr>
<td><strong>Business Logic</strong></td>
<td><code>src/lib/client/*</code></td>
<td>Pure domain logic (strategies, exchanges, frames)</td>
<td>No DI dependencies, highly testable</td>
</tr>
<tr>
<td><strong>Cross-Cutting</strong></td>
<td><code>src/lib/services/base/*</code>, <code>src/classes/Persist.ts</code></td>
<td>Logging, persistence, reporting, context</td>
<td>Injected throughout other layers</td>
</tr>
</tbody>
</table>
<hr>
<a id="dependency-injection-infrastructure" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Dependency Injection Infrastructure<a href="#dependency-injection-infrastructure" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>The framework uses a <strong>symbol-based dependency injection</strong> system built on <code>di-kit</code> for service registration and <code>di-scoped</code> for context propagation. All services are lazily instantiated and registered in a central container.</p>
<a id="di-core-components" class="tsd-anchor"></a><h3 class="tsd-anchor-link">DI Core Components<a href="#di-core-components" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><img src="../media/04_Architecture_1.svg" alt="Mermaid Diagram"></p>
<a id="symbol-registration-pattern" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Symbol Registration Pattern<a href="#symbol-registration-pattern" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>The <code>types.ts</code> file defines unique Symbol identifiers for each service, organized into semantic groups:</p>
<p><a href="">src/lib/core/types.ts:1-57</a></p>
<pre><code class="typescript"><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">baseServices</span><span class="hl-1"> = {</span><br/><span class="hl-1">    </span><span class="hl-4">loggerService:</span><span class="hl-1"> </span><span class="hl-0">Symbol</span><span class="hl-1">(</span><span class="hl-2">&#39;loggerService&#39;</span><span class="hl-1">),</span><br/><span class="hl-1">};</span><br/><br/><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">contextServices</span><span class="hl-1"> = {</span><br/><span class="hl-1">    </span><span class="hl-4">executionContextService:</span><span class="hl-1"> </span><span class="hl-0">Symbol</span><span class="hl-1">(</span><span class="hl-2">&#39;executionContextService&#39;</span><span class="hl-1">),</span><br/><span class="hl-1">    </span><span class="hl-4">methodContextService:</span><span class="hl-1"> </span><span class="hl-0">Symbol</span><span class="hl-1">(</span><span class="hl-2">&#39;methodContextService&#39;</span><span class="hl-1">),</span><br/><span class="hl-1">};</span><br/><br/><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">connectionServices</span><span class="hl-1"> = {</span><br/><span class="hl-1">    </span><span class="hl-4">exchangeConnectionService:</span><span class="hl-1"> </span><span class="hl-0">Symbol</span><span class="hl-1">(</span><span class="hl-2">&#39;exchangeConnectionService&#39;</span><span class="hl-1">),</span><br/><span class="hl-1">    </span><span class="hl-4">strategyConnectionService:</span><span class="hl-1"> </span><span class="hl-0">Symbol</span><span class="hl-1">(</span><span class="hl-2">&#39;strategyConnectionService&#39;</span><span class="hl-1">),</span><br/><span class="hl-1">    </span><span class="hl-4">frameConnectionService:</span><span class="hl-1"> </span><span class="hl-0">Symbol</span><span class="hl-1">(</span><span class="hl-2">&#39;frameConnectionService&#39;</span><span class="hl-1">),</span><br/><span class="hl-1">};</span><br/><span class="hl-5">// ... additional service groups</span>
</code><button type="button">Copy</button></pre>

<p>The <code>provide.ts</code> file registers factory functions for each symbol:</p>
<p><a href="">src/lib/core/provide.ts:24-68</a></p>
<pre><code class="typescript"><span class="hl-1">{</span><br/><span class="hl-1">    </span><span class="hl-0">provide</span><span class="hl-1">(</span><span class="hl-7">TYPES</span><span class="hl-1">.</span><span class="hl-4">loggerService</span><span class="hl-1">, () </span><span class="hl-6">=&gt;</span><span class="hl-1"> </span><span class="hl-6">new</span><span class="hl-1"> </span><span class="hl-0">LoggerService</span><span class="hl-1">());</span><br/><span class="hl-1">}</span><br/><br/><span class="hl-1">{</span><br/><span class="hl-1">    </span><span class="hl-0">provide</span><span class="hl-1">(</span><span class="hl-7">TYPES</span><span class="hl-1">.</span><span class="hl-4">executionContextService</span><span class="hl-1">, () </span><span class="hl-6">=&gt;</span><span class="hl-1"> </span><span class="hl-6">new</span><span class="hl-1"> </span><span class="hl-0">ExecutionContextService</span><span class="hl-1">());</span><br/><span class="hl-1">    </span><span class="hl-0">provide</span><span class="hl-1">(</span><span class="hl-7">TYPES</span><span class="hl-1">.</span><span class="hl-4">methodContextService</span><span class="hl-1">, () </span><span class="hl-6">=&gt;</span><span class="hl-1"> </span><span class="hl-6">new</span><span class="hl-1"> </span><span class="hl-0">MethodContextService</span><span class="hl-1">());</span><br/><span class="hl-1">}</span><br/><br/><span class="hl-1">{</span><br/><span class="hl-1">    </span><span class="hl-0">provide</span><span class="hl-1">(</span><span class="hl-7">TYPES</span><span class="hl-1">.</span><span class="hl-4">exchangeConnectionService</span><span class="hl-1">, () </span><span class="hl-6">=&gt;</span><span class="hl-1"> </span><span class="hl-6">new</span><span class="hl-1"> </span><span class="hl-0">ExchangeConnectionService</span><span class="hl-1">());</span><br/><span class="hl-1">    </span><span class="hl-0">provide</span><span class="hl-1">(</span><span class="hl-7">TYPES</span><span class="hl-1">.</span><span class="hl-4">strategyConnectionService</span><span class="hl-1">, () </span><span class="hl-6">=&gt;</span><span class="hl-1"> </span><span class="hl-6">new</span><span class="hl-1"> </span><span class="hl-0">StrategyConnectionService</span><span class="hl-1">());</span><br/><span class="hl-1">    </span><span class="hl-0">provide</span><span class="hl-1">(</span><span class="hl-7">TYPES</span><span class="hl-1">.</span><span class="hl-4">frameConnectionService</span><span class="hl-1">, () </span><span class="hl-6">=&gt;</span><span class="hl-1"> </span><span class="hl-6">new</span><span class="hl-1"> </span><span class="hl-0">FrameConnectionService</span><span class="hl-1">());</span><br/><span class="hl-1">}</span><br/><span class="hl-5">// ... additional service registrations</span>
</code><button type="button">Copy</button></pre>

<a id="service-aggregator-object" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Service Aggregator Object<a href="#service-aggregator-object" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>The <code>backtest</code> object exported from <a href="">src/lib/index.ts:101-110</a> acts as a <strong>service locator</strong>, aggregating all services into a single importable object. This design allows consumers to import the entire service graph without managing individual dependencies:</p>
<pre><code class="typescript"><span class="hl-3">export</span><span class="hl-1"> </span><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">backtest</span><span class="hl-1"> = {</span><br/><span class="hl-1">  ...</span><span class="hl-4">baseServices</span><span class="hl-1">,</span><br/><span class="hl-1">  ...</span><span class="hl-4">contextServices</span><span class="hl-1">,</span><br/><span class="hl-1">  ...</span><span class="hl-4">connectionServices</span><span class="hl-1">,</span><br/><span class="hl-1">  ...</span><span class="hl-4">schemaServices</span><span class="hl-1">,</span><br/><span class="hl-1">  ...</span><span class="hl-4">globalServices</span><span class="hl-1">,</span><br/><span class="hl-1">  ...</span><span class="hl-4">logicPrivateServices</span><span class="hl-1">,</span><br/><span class="hl-1">  ...</span><span class="hl-4">logicPublicServices</span><span class="hl-1">,</span><br/><span class="hl-1">  ...</span><span class="hl-4">markdownServices</span><span class="hl-1">,</span><br/><span class="hl-1">};</span>
</code><button type="button">Copy</button></pre>

<p>This pattern enables:</p>
<ul>
<li><strong>Centralized access</strong> to all services</li>
<li><strong>Lazy initialization</strong> of service instances</li>
<li><strong>Type-safe injection</strong> via TypeScript inference</li>
<li><strong>Single import point</strong> for framework internals</li>
</ul>
<hr>
<a id="service-organization-taxonomy" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Service Organization Taxonomy<a href="#service-organization-taxonomy" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>Services are organized into <strong>six semantic categories</strong> based on their architectural role. This taxonomy enables clear understanding of each service's purpose and dependencies.</p>
<p><img src="../media/04_Architecture_2.svg" alt="Mermaid Diagram"></p>
<a id="service-category-definitions" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Service Category Definitions<a href="#service-category-definitions" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><table>
<thead>
<tr>
<th>Category</th>
<th>Naming Pattern</th>
<th>Responsibilities</th>
<th>Example</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Base</strong></td>
<td><code>*Service</code></td>
<td>Foundational utilities (logging)</td>
<td><code>LoggerService</code></td>
</tr>
<tr>
<td><strong>Context</strong></td>
<td><code>*ContextService</code></td>
<td>Scoped context propagation</td>
<td><code>ExecutionContextService</code></td>
</tr>
<tr>
<td><strong>Schema</strong></td>
<td><code>*SchemaService</code></td>
<td>Registry of user configurations</td>
<td><code>StrategySchemaService</code></td>
</tr>
<tr>
<td><strong>Connection</strong></td>
<td><code>*ConnectionService</code></td>
<td>Memoized client instance factories</td>
<td><code>StrategyConnectionService</code></td>
</tr>
<tr>
<td><strong>Global</strong></td>
<td><code>*GlobalService</code></td>
<td>Context injection for domain operations</td>
<td><code>StrategyGlobalService</code></td>
</tr>
<tr>
<td><strong>Logic</strong></td>
<td><code>*LogicPublicService</code>, <code>*LogicPrivateService</code></td>
<td>Execution orchestration</td>
<td><code>BacktestLogicPrivateService</code></td>
</tr>
</tbody>
</table>
<hr>
<a id="layer-interaction-patterns" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Layer Interaction Patterns<a href="#layer-interaction-patterns" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>Communication between layers follows strict patterns to maintain architectural boundaries. Each pattern serves a specific purpose in the execution flow.</p>
<a id="configuration-registration-flow" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Configuration Registration Flow<a href="#configuration-registration-flow" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>User configuration flows from Public API to Schema registries without executing business logic:</p>
<p><img src="../media/04_Architecture_3.svg" alt="Mermaid Diagram"></p>
<a id="runtime-instance-creation-flow" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Runtime Instance Creation Flow<a href="#runtime-instance-creation-flow" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>At execution time, Connection services create memoized client instances from registered schemas:</p>
<p><img src="../media/04_Architecture_4.svg" alt="Mermaid Diagram"></p>
<a id="context-propagation-pattern" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Context Propagation Pattern<a href="#context-propagation-pattern" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>ExecutionContextService and MethodContextService use <code>di-scoped</code> to propagate context implicitly without manual parameter passing:</p>
<p><img src="../media/04_Architecture_5.svg" alt="Mermaid Diagram"></p>
<hr>
<a id="context-propagation-mechanism" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Context Propagation Mechanism<a href="#context-propagation-mechanism" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>The framework uses <strong>scoped services</strong> from <code>di-scoped</code> to propagate context without explicit parameter threading. Two context services manage different aspects of execution:</p>
<a id="executioncontextservice" class="tsd-anchor"></a><h3 class="tsd-anchor-link">ExecutionContextService<a href="#executioncontextservice" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Provides <strong>runtime execution parameters</strong> for each operation:</p>
<table>
<thead>
<tr>
<th>Property</th>
<th>Type</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>symbol</code></td>
<td><code>string</code></td>
<td>Trading pair (e.g., &quot;BTCUSDT&quot;)</td>
</tr>
<tr>
<td><code>when</code></td>
<td><code>Date</code></td>
<td>Current timestamp for operation</td>
</tr>
<tr>
<td><code>backtest</code></td>
<td><code>boolean</code></td>
<td>Execution mode (true = backtest, false = live)</td>
</tr>
</tbody>
</table>
<p>Used by <a href="">src/lib/services/global/</a> services to inject context into <code>ClientExchange</code> and <code>ClientStrategy</code> operations.</p>
<a id="methodcontextservice" class="tsd-anchor"></a><h3 class="tsd-anchor-link">MethodContextService<a href="#methodcontextservice" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Provides <strong>schema routing parameters</strong> for dependency resolution:</p>
<table>
<thead>
<tr>
<th>Property</th>
<th>Type</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>strategyName</code></td>
<td><code>string</code></td>
<td>Which strategy schema to use</td>
</tr>
<tr>
<td><code>exchangeName</code></td>
<td><code>string</code></td>
<td>Which exchange schema to use</td>
</tr>
<tr>
<td><code>frameName</code></td>
<td><code>string</code></td>
<td>Which frame schema to use (empty in live mode)</td>
</tr>
</tbody>
</table>
<p>Used by <a href="">src/lib/services/connection/</a> services to retrieve correct client instances via memoized factories.</p>
<a id="scope-boundaries" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Scope Boundaries<a href="#scope-boundaries" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Context scope is established at the <strong>Logic Public Service</strong> layer and flows down through all dependent services:</p>
<p><img src="../media/04_Architecture_6.svg" alt="Mermaid Diagram"></p>
<p>This pattern eliminates the need to pass <code>strategyName</code>, <code>exchangeName</code>, <code>symbol</code>, <code>when</code>, and <code>backtest</code> as parameters through every method call in the service chain.</p>
<hr>
<a id="service-lifecycle-and-instantiation" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Service Lifecycle and Instantiation<a href="#service-lifecycle-and-instantiation" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>Services follow a <strong>lazy instantiation</strong> pattern with memoization to optimize performance and memory usage.</p>
<a id="lifecycle-stages" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Lifecycle Stages<a href="#lifecycle-stages" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><table>
<thead>
<tr>
<th>Stage</th>
<th>When</th>
<th>Responsible Component</th>
<th>Action</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Registration</strong></td>
<td>Application startup</td>
<td><code>provide.ts</code></td>
<td>Factory functions registered with DI container</td>
</tr>
<tr>
<td><strong>Schema Storage</strong></td>
<td>User calls <code>addStrategy()</code>, <code>addExchange()</code>, <code>addFrame()</code></td>
<td>Schema Services</td>
<td>Configuration stored in <code>Map&lt;name, schema&gt;</code></td>
</tr>
<tr>
<td><strong>Service Creation</strong></td>
<td>First <code>inject&lt;T&gt;(symbol)</code> call</td>
<td>DI container</td>
<td>Factory function executed, singleton created</td>
</tr>
<tr>
<td><strong>Client Instantiation</strong></td>
<td>First operation requiring specific schema</td>
<td>Connection Services</td>
<td><code>ClientStrategy</code>/<code>ClientExchange</code>/<code>ClientFrame</code> created and memoized</td>
</tr>
<tr>
<td><strong>Context Injection</strong></td>
<td>Every operation</td>
<td>Global Services</td>
<td>Context propagated via <code>di-scoped</code></td>
</tr>
</tbody>
</table>
<a id="memoization-strategy" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Memoization Strategy<a href="#memoization-strategy" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Connection services use <strong>memoization</strong> to cache client instances by schema name:</p>
<p><img src="../media/04_Architecture_7.svg" alt="Mermaid Diagram"></p>
<p>This ensures:</p>
<ul>
<li><strong>Single instance per schema name</strong> across all operations</li>
<li><strong>No redundant construction overhead</strong> after first use</li>
<li><strong>Stateful client behavior</strong> (e.g., signal persistence in <code>ClientStrategy</code>)</li>
</ul>
<hr>
<a id="public-api-to-business-logic-flow" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Public API to Business Logic Flow<a href="#public-api-to-business-logic-flow" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>The complete execution flow from user-facing API to business logic demonstrates all architectural layers working together:</p>
<p><img src="../media/04_Architecture_8.svg" alt="Mermaid Diagram"></p>
<p><strong>Key Observations:</strong></p>
<ol>
<li><strong>Layer boundaries are explicit</strong> - Each service calls only services in adjacent layers</li>
<li><strong>Context flows implicitly</strong> - No manual parameter passing for <code>strategyName</code>, <code>exchangeName</code>, <code>symbol</code>, <code>when</code>, <code>backtest</code></li>
<li><strong>Business logic is pure</strong> - <code>ClientStrategy</code> and <code>ClientExchange</code> have no knowledge of DI or service infrastructure</li>
<li><strong>Memoization prevents redundancy</strong> - Client instances created once per schema and reused</li>
</ol>
<hr>
<a id="architecture-benefits" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Architecture Benefits<a href="#architecture-benefits" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>This four-layer architecture with dependency injection provides several key advantages:</p>
<table>
<thead>
<tr>
<th>Benefit</th>
<th>Mechanism</th>
<th>Impact</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Testability</strong></td>
<td>Business logic in <code>Client*</code> classes has no DI dependencies</td>
<td>Unit tests can instantiate <code>ClientStrategy</code> directly without mocking framework</td>
</tr>
<tr>
<td><strong>Modularity</strong></td>
<td>Clear layer boundaries with explicit interfaces</td>
<td>Services can be replaced/extended without affecting other layers</td>
</tr>
<tr>
<td><strong>Configurability</strong></td>
<td>Schema registration decoupled from execution</td>
<td>Multiple strategies/exchanges can coexist, selected dynamically via context</td>
</tr>
<tr>
<td><strong>Performance</strong></td>
<td>Memoization in Connection services</td>
<td>No redundant instance creation, minimal overhead</td>
</tr>
<tr>
<td><strong>Maintainability</strong></td>
<td>Consistent service naming and organization</td>
<td>Easy to locate functionality by following naming conventions</td>
</tr>
<tr>
<td><strong>Extensibility</strong></td>
<td>New schemas registered via <code>add*</code> functions</td>
<td>Framework supports custom strategies/exchanges without code changes</td>
</tr>
</tbody>
</table>
</div></div><div class="col-sidebar"><div class="page-menu"><div class="tsd-navigation settings"><details class="tsd-accordion"><summary class="tsd-accordion-summary"><h3><svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-chevronDown"></use></svg>Settings</h3></summary><div class="tsd-accordion-details"><div class="tsd-filter-visibility"><span class="settings-label">Member Visibility</span><ul id="tsd-filter-options"><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-protected" name="protected"/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Protected</span></label></li><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-inherited" name="inherited" checked/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Inherited</span></label></li><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-external" name="external"/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>External</span></label></li></ul></div><div class="tsd-theme-toggle"><label class="settings-label" for="tsd-theme">Theme</label><select id="tsd-theme"><option value="os">OS</option><option value="light">Light</option><option value="dark">Dark</option></select></div></div></details></div><details open class="tsd-accordion tsd-page-navigation"><summary class="tsd-accordion-summary"><h3><svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-chevronDown"></use></svg>On This Page</h3></summary><div class="tsd-accordion-details"><a href="#architecture"><span>Architecture</span></a><ul><li><a href="#architectural-overview"><span>Architectural <wbr/>Overview</span></a></li><li><ul><li><a href="#layer-responsibilities-summary"><span>Layer <wbr/>Responsibilities <wbr/>Summary</span></a></li></ul></li><li><a href="#dependency-injection-infrastructure"><span>Dependency <wbr/>Injection <wbr/>Infrastructure</span></a></li><li><ul><li><a href="#di-core-components"><span>DI <wbr/>Core <wbr/>Components</span></a></li><li><a href="#symbol-registration-pattern"><span>Symbol <wbr/>Registration <wbr/>Pattern</span></a></li><li><a href="#service-aggregator-object"><span>Service <wbr/>Aggregator <wbr/>Object</span></a></li></ul></li><li><a href="#service-organization-taxonomy"><span>Service <wbr/>Organization <wbr/>Taxonomy</span></a></li><li><ul><li><a href="#service-category-definitions"><span>Service <wbr/>Category <wbr/>Definitions</span></a></li></ul></li><li><a href="#layer-interaction-patterns"><span>Layer <wbr/>Interaction <wbr/>Patterns</span></a></li><li><ul><li><a href="#configuration-registration-flow"><span>Configuration <wbr/>Registration <wbr/>Flow</span></a></li><li><a href="#runtime-instance-creation-flow"><span>Runtime <wbr/>Instance <wbr/>Creation <wbr/>Flow</span></a></li><li><a href="#context-propagation-pattern"><span>Context <wbr/>Propagation <wbr/>Pattern</span></a></li></ul></li><li><a href="#context-propagation-mechanism"><span>Context <wbr/>Propagation <wbr/>Mechanism</span></a></li><li><ul><li><a href="#executioncontextservice"><span>Execution<wbr/>Context<wbr/>Service</span></a></li><li><a href="#methodcontextservice"><span>Method<wbr/>Context<wbr/>Service</span></a></li><li><a href="#scope-boundaries"><span>Scope <wbr/>Boundaries</span></a></li></ul></li><li><a href="#service-lifecycle-and-instantiation"><span>Service <wbr/>Lifecycle and <wbr/>Instantiation</span></a></li><li><ul><li><a href="#lifecycle-stages"><span>Lifecycle <wbr/>Stages</span></a></li><li><a href="#memoization-strategy"><span>Memoization <wbr/>Strategy</span></a></li></ul></li><li><a href="#public-api-to-business-logic-flow"><span>Public API to <wbr/>Business <wbr/>Logic <wbr/>Flow</span></a></li><li><a href="#architecture-benefits"><span>Architecture <wbr/>Benefits</span></a></li></ul></div></details></div><div class="site-menu"><nav class="tsd-navigation"><a href="../modules.html">backtest-kit</a><ul class="tsd-small-nested-navigation" id="tsd-nav-container"><li>Loading...</li></ul></nav></div></div></div><footer><p class="tsd-generator">Generated using <a href="https://typedoc.org/" target="_blank">TypeDoc</a></p></footer><div class="overlay"></div></body></html>
