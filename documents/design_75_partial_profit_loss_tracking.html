<!DOCTYPE html><html class="default" lang="en" data-base=".."><head><meta charset="utf-8"/><meta http-equiv="x-ua-compatible" content="IE=edge"/><title>design/75_partial_profit_loss_tracking | backtest-kit</title><meta name="description" content="Documentation for backtest-kit"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="stylesheet" href="../assets/style.css"/><link rel="stylesheet" href="../assets/highlight.css"/><script defer src="../assets/main.js"></script><script async src="../assets/icons.js" id="tsd-icons-script"></script><script async src="../assets/search.js" id="tsd-search-script"></script><script async src="../assets/navigation.js" id="tsd-nav-script"></script><script async src="../assets/hierarchy.js" id="tsd-hierarchy-script"></script></head><body><script>document.documentElement.dataset.theme = localStorage.getItem("tsd-theme") || "os";document.body.style.display="none";setTimeout(() => app?app.showPage():document.body.style.removeProperty("display"),500)</script><header class="tsd-page-toolbar"><div class="tsd-toolbar-contents container"><div class="table-cell" id="tsd-search"><div class="field"><label for="tsd-search-field" class="tsd-widget tsd-toolbar-icon search no-caption"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-search"></use></svg></label><input type="text" id="tsd-search-field" aria-label="Search"/></div><div class="field"><div id="tsd-toolbar-links"></div></div><ul class="results"><li class="state loading">Preparing search index...</li><li class="state failure">The search index is not available</li></ul><a href="../index.html" class="title">backtest-kit</a></div><div class="table-cell" id="tsd-widgets"><a href="#" class="tsd-widget tsd-toolbar-icon menu no-caption" data-toggle="menu" aria-label="Menu"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-menu"></use></svg></a></div></div></header><div class="container container-main"><div class="col-content"><div class="tsd-page-title"><ul class="tsd-breadcrumb"><li><a href="../modules.html">backtest-kit</a></li><li><a href="design_75_partial_profit_loss_tracking.html">design/75_partial_profit_loss_tracking</a></li></ul></div><div class="tsd-panel tsd-typography"><a id="partial-profitloss-tracking" class="tsd-anchor"></a><h1 class="tsd-anchor-link">Partial Profit/Loss Tracking<a href="#partial-profitloss-tracking" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h1><p><strong>Purpose</strong>: This document describes the partial profit/loss tracking system that monitors trading signals and emits events when they reach percentage-based profit or loss milestones (10%, 20%, 30%, etc.). This enables tracking partial take-profit and stop-loss behavior, generating detailed reports, and monitoring strategy performance at granular levels.</p>
<p>For information about overall reporting infrastructure, see <a href="design_71_reporting_and_analytics.html">Reporting and Analytics</a>. For risk management and portfolio constraints, see <a href="design_67_risk_management.html">Risk Management</a>. For signal lifecycle states, see <a href="design_48_signal_lifecycle.html">Signal Lifecycle</a>.</p>
<hr>
<a id="system-overview" class="tsd-anchor"></a><h2 class="tsd-anchor-link">System Overview<a href="#system-overview" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>The partial tracking system monitors active trading signals and emits events when they reach predefined profit or loss levels. Each level (10%, 20%, 30%...100%) is emitted exactly once per signal using Set-based deduplication. The system persists state to disk for crash recovery in live trading mode.</p>
<a id="key-components" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Key Components<a href="#key-components" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><table>
<thead>
<tr>
<th>Component</th>
<th>File</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>ClientPartial</code></td>
<td><a href="">src/client/ClientPartial.ts:1-478</a></td>
<td>Core implementation tracking profit/loss levels per signal</td>
</tr>
<tr>
<td><code>PartialConnectionService</code></td>
<td><a href="">src/lib/services/connection/PartialConnectionService.ts:1-267</a></td>
<td>Factory creating memoized ClientPartial instances</td>
</tr>
<tr>
<td><code>PartialGlobalService</code></td>
<td><a href="">src/lib/services/global/PartialGlobalService.ts:1-205</a></td>
<td>Global service delegating to connection layer</td>
</tr>
<tr>
<td><code>PartialMarkdownService</code></td>
<td><a href="">src/lib/services/markdown/PartialMarkdownService.ts:1-478</a></td>
<td>Accumulates events and generates markdown reports</td>
</tr>
<tr>
<td><code>PersistPartialAdapter</code></td>
<td><a href="">src/classes/Persist.ts:1-600</a></td>
<td>Atomic persistence for partial state</td>
</tr>
</tbody>
</table>
<a id="data-flow" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Data Flow<a href="#data-flow" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><img src="../media/75_Partial_Profit_Loss_Tracking_0.svg" alt="Mermaid Diagram"></p>
<hr>
<a id="profitloss-level-system" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Profit/Loss Level System<a href="#profitloss-level-system" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>The system tracks profit and loss milestones at 10-percentage-point intervals from 10% to 100%. Each level is emitted exactly once per signal to prevent duplicate notifications.</p>
<a id="level-definitions" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Level Definitions<a href="#level-definitions" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><strong>Profit Levels</strong> (positive price movement):</p>
<pre><code class="typescript"><span class="hl-3">const</span><span class="hl-2"> </span><span class="hl-8">PROFIT_LEVELS</span><span class="hl-2">: </span><span class="hl-11">PartialLevel</span><span class="hl-2">[] = [</span><span class="hl-7">10</span><span class="hl-2">, </span><span class="hl-7">20</span><span class="hl-2">, </span><span class="hl-7">30</span><span class="hl-2">, </span><span class="hl-7">40</span><span class="hl-2">, </span><span class="hl-7">50</span><span class="hl-2">, </span><span class="hl-7">60</span><span class="hl-2">, </span><span class="hl-7">70</span><span class="hl-2">, </span><span class="hl-7">80</span><span class="hl-2">, </span><span class="hl-7">90</span><span class="hl-2">, </span><span class="hl-7">100</span><span class="hl-2">];</span>
</code><button type="button">Copy</button></pre>

<p><strong>Loss Levels</strong> (negative price movement):</p>
<pre><code class="typescript"><span class="hl-3">const</span><span class="hl-2"> </span><span class="hl-8">LOSS_LEVELS</span><span class="hl-2">: </span><span class="hl-11">PartialLevel</span><span class="hl-2">[] = [</span><span class="hl-7">10</span><span class="hl-2">, </span><span class="hl-7">20</span><span class="hl-2">, </span><span class="hl-7">30</span><span class="hl-2">, </span><span class="hl-7">40</span><span class="hl-2">, </span><span class="hl-7">50</span><span class="hl-2">, </span><span class="hl-7">60</span><span class="hl-2">, </span><span class="hl-7">70</span><span class="hl-2">, </span><span class="hl-7">80</span><span class="hl-2">, </span><span class="hl-7">90</span><span class="hl-2">, </span><span class="hl-7">100</span><span class="hl-2">];</span>
</code><button type="button">Copy</button></pre>

<p><strong>Note</strong>: Loss levels are stored as absolute values (10, 20, 30) but represent negative percentages (-10%, -20%, -30%).</p>
<a id="state-structure" class="tsd-anchor"></a><h3 class="tsd-anchor-link">State Structure<a href="#state-structure" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>The <code>IPartialState</code> interface uses Sets for O(1) deduplication and lookup:</p>
<pre><code class="typescript"><span class="hl-3">interface</span><span class="hl-2"> </span><span class="hl-11">IPartialState</span><span class="hl-2"> {</span><br/><span class="hl-2">  </span><span class="hl-6">profitLevels</span><span class="hl-2">: </span><span class="hl-11">Set</span><span class="hl-2">&lt;</span><span class="hl-11">PartialLevel</span><span class="hl-2">&gt;;  </span><span class="hl-0">// Reached profit levels</span><br/><span class="hl-2">  </span><span class="hl-6">lossLevels</span><span class="hl-2">: </span><span class="hl-11">Set</span><span class="hl-2">&lt;</span><span class="hl-11">PartialLevel</span><span class="hl-2">&gt;;    </span><span class="hl-0">// Reached loss levels</span><br/><span class="hl-2">}</span>
</code><button type="button">Copy</button></pre>

<p>State is stored in a <code>Map&lt;signalId, IPartialState&gt;</code> within each <code>ClientPartial</code> instance. For persistence, Sets are converted to arrays in <code>IPartialData</code> format.</p>
<hr>
<a id="clientpartial-architecture" class="tsd-anchor"></a><h2 class="tsd-anchor-link">ClientPartial Architecture<a href="#clientpartial-architecture" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p><code>ClientPartial</code> is the core implementation responsible for tracking profit/loss levels for a single signal. Instances are created per signal ID and memoized by <code>PartialConnectionService</code>.</p>
<a id="initialization-pattern" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Initialization Pattern<a href="#initialization-pattern" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><img src="../media/75_Partial_Profit_Loss_Tracking_1.svg" alt="Mermaid Diagram"></p>
<p>The initialization uses a sentinel value <code>NEED_FETCH</code> to ensure <code>waitForInit()</code> is called before operations. The <code>singleshot</code> pattern from <code>functools-kit</code> guarantees initialization happens exactly once per symbol-strategy combination.</p>
<a id="level-detection-logic" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Level Detection Logic<a href="#level-detection-logic" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>The <code>HANDLE_PROFIT_FN</code> and <code>HANDLE_LOSS_FN</code> functions iterate through level arrays and check for newly reached milestones:</p>
<p><strong>Profit Detection</strong> <a href="">src/client/ClientPartial.ts:44-105</a>:</p>
<ol>
<li>Retrieve or create state for signal ID</li>
<li>Iterate through <code>PROFIT_LEVELS</code> array</li>
<li>For each level: check if <code>revenuePercent &gt;= level</code> AND level not in <code>state.profitLevels</code> Set</li>
<li>If new level reached: add to Set, emit event via <code>params.onProfit()</code>, mark for persistence</li>
<li>After all levels processed: call <code>_persistState()</code> if any changes occurred</li>
</ol>
<p><strong>Loss Detection</strong> <a href="">src/client/ClientPartial.ts:122-184</a>:</p>
<ol>
<li>Convert negative <code>lossPercent</code> to absolute value: <code>absLoss = Math.abs(lossPercent)</code></li>
<li>Iterate through <code>LOSS_LEVELS</code> array</li>
<li>For each level: check if <code>absLoss &gt;= level</code> AND level not in <code>state.lossLevels</code> Set</li>
<li>If new level reached: add to Set, emit event via <code>params.onLoss()</code>, mark for persistence</li>
<li>After all levels processed: call <code>_persistState()</code> if any changes occurred</li>
</ol>
<a id="method-flow-diagram" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Method Flow Diagram<a href="#method-flow-diagram" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><img src="../media/75_Partial_Profit_Loss_Tracking_2.svg" alt="Mermaid Diagram"></p>
<hr>
<a id="event-contracts" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Event Contracts<a href="#event-contracts" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><a id="partialprofitcontract" class="tsd-anchor"></a><h3 class="tsd-anchor-link">PartialProfitContract<a href="#partialprofitcontract" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Emitted when a signal reaches a new profit level milestone:</p>
<table>
<thead>
<tr>
<th>Field</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>symbol</code></td>
<td><code>string</code></td>
<td>Trading pair (e.g., &quot;BTCUSDT&quot;)</td>
</tr>
<tr>
<td><code>strategyName</code></td>
<td><code>string</code></td>
<td>Strategy that generated the signal</td>
</tr>
<tr>
<td><code>exchangeName</code></td>
<td><code>string</code></td>
<td>Exchange where signal is executing</td>
</tr>
<tr>
<td><code>data</code></td>
<td><code>ISignalRow</code></td>
<td>Complete signal data (id, position, prices)</td>
</tr>
<tr>
<td><code>currentPrice</code></td>
<td><code>number</code></td>
<td>Market price when level reached</td>
</tr>
<tr>
<td><code>level</code></td>
<td><code>PartialLevel</code></td>
<td>Profit level reached (10, 20...100)</td>
</tr>
<tr>
<td><code>backtest</code></td>
<td><code>boolean</code></td>
<td>True if backtest mode, false if live</td>
</tr>
<tr>
<td><code>timestamp</code></td>
<td><code>number</code></td>
<td>Event time (ms since Unix epoch)</td>
</tr>
</tbody>
</table>
<a id="partiallosscontract" class="tsd-anchor"></a><h3 class="tsd-anchor-link">PartialLossContract<a href="#partiallosscontract" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Emitted when a signal reaches a new loss level milestone:</p>
<table>
<thead>
<tr>
<th>Field</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>symbol</code></td>
<td><code>string</code></td>
<td>Trading pair (e.g., &quot;BTCUSDT&quot;)</td>
</tr>
<tr>
<td><code>strategyName</code></td>
<td><code>string</code></td>
<td>Strategy that generated the signal</td>
</tr>
<tr>
<td><code>exchangeName</code></td>
<td><code>string</code></td>
<td>Exchange where signal is executing</td>
</tr>
<tr>
<td><code>data</code></td>
<td><code>ISignalRow</code></td>
<td>Complete signal data (id, position, prices)</td>
</tr>
<tr>
<td><code>currentPrice</code></td>
<td><code>number</code></td>
<td>Market price when level reached</td>
</tr>
<tr>
<td><code>level</code></td>
<td><code>PartialLevel</code></td>
<td>Loss level reached (10, 20...100 as absolute)</td>
</tr>
<tr>
<td><code>backtest</code></td>
<td><code>boolean</code></td>
<td>True if backtest mode, false if live</td>
</tr>
<tr>
<td><code>timestamp</code></td>
<td><code>number</code></td>
<td>Event time (ms since Unix epoch)</td>
</tr>
</tbody>
</table>
<p><strong>Note</strong>: <code>level</code> is stored as a positive number but represents negative loss. <code>level=20</code> means -20% loss.</p>
<hr>
<a id="persistence-mechanism" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Persistence Mechanism<a href="#persistence-mechanism" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>Partial state is persisted to disk for crash recovery in live trading mode. Backtest mode skips persistence for performance.</p>
<a id="persistence-architecture" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Persistence Architecture<a href="#persistence-architecture" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><img src="../media/75_Partial_Profit_Loss_Tracking_3.svg" alt="Mermaid Diagram"></p>
<a id="persistence-flow" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Persistence Flow<a href="#persistence-flow" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><strong>Write Path</strong> <a href="">src/client/ClientPartial.ts:349-367</a>:</p>
<ol>
<li>Check if backtest mode → skip if true</li>
<li>Convert <code>Map&lt;signalId, IPartialState&gt;</code> to <code>Record&lt;signalId, IPartialData&gt;</code></li>
<li>Convert Sets to arrays: <code>Array.from(state.profitLevels)</code>, <code>Array.from(state.lossLevels)</code></li>
<li>Call <code>PersistPartialAdapter.writePartialData(partialData, symbol, strategyName)</code></li>
<li>Atomic write: tmp file → fsync → rename</li>
</ol>
<p><strong>Read Path</strong> <a href="">src/client/ClientPartial.ts:199-235</a>:</p>
<ol>
<li>Check if backtest mode → skip if true (use empty Map)</li>
<li>Call <code>PersistPartialAdapter.readPartialData(symbol, strategyName)</code></li>
<li>Iterate through returned <code>Record&lt;signalId, IPartialData&gt;</code></li>
<li>Convert arrays to Sets: <code>new Set(data.profitLevels)</code>, <code>new Set(data.lossLevels)</code></li>
<li>Populate <code>_states</code> Map with restored state</li>
</ol>
<a id="file-location" class="tsd-anchor"></a><h3 class="tsd-anchor-link">File Location<a href="#file-location" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Partial state files are stored at:</p>
<pre><code><span class="hl-2">./</span><span class="hl-6">dump</span><span class="hl-2">/</span><span class="hl-6">data</span><span class="hl-2">/</span><span class="hl-6">partial</span><span class="hl-2">/{</span><span class="hl-6">strategy</span><span class="hl-2">}/{</span><span class="hl-6">symbol</span><span class="hl-2">}.</span><span class="hl-6">json</span>
</code><button>Copy</button></pre>

<p><strong>Example</strong>: Strategy &quot;my-strategy&quot; tracking BTCUSDT would create:</p>
<pre><code><span class="hl-2">./</span><span class="hl-6">dump</span><span class="hl-2">/</span><span class="hl-6">data</span><span class="hl-2">/</span><span class="hl-6">partial</span><span class="hl-2">/</span><span class="hl-6">my</span><span class="hl-2">-</span><span class="hl-6">strategy</span><span class="hl-2">/</span><span class="hl-8">BTCUSDT</span><span class="hl-2">.</span><span class="hl-6">json</span>
</code><button>Copy</button></pre>

<hr>
<a id="partialmarkdownservice" class="tsd-anchor"></a><h2 class="tsd-anchor-link">PartialMarkdownService<a href="#partialmarkdownservice" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>The markdown service subscribes to partial profit/loss events and generates reports showing milestone progression.</p>
<a id="event-accumulation" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Event Accumulation<a href="#event-accumulation" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><img src="../media/75_Partial_Profit_Loss_Tracking_4.svg" alt="Mermaid Diagram"></p>
<a id="reportstorage-class" class="tsd-anchor"></a><h3 class="tsd-anchor-link">ReportStorage Class<a href="#reportstorage-class" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>The <code>ReportStorage</code> class <a href="">src/lib/services/markdown/PartialMarkdownService.ts:60-236</a> maintains a bounded queue of partial events:</p>
<p><strong>Methods</strong>:</p>
<ul>
<li><code>addProfitEvent(data, currentPrice, level, backtest, timestamp)</code>: Add profit event to queue</li>
<li><code>addLossEvent(data, currentPrice, level, backtest, timestamp)</code>: Add loss event to queue</li>
<li><code>getData()</code>: Calculate statistics (totalProfit, totalLoss counts)</li>
<li><code>getReport(symbol, strategyName, columns)</code>: Generate markdown table</li>
<li><code>dump(symbol, strategyName, path, columns)</code>: Save report to disk</li>
</ul>
<p><strong>Queue Management</strong>: Uses <code>unshift()</code> to add events at beginning, <code>pop()</code> to remove oldest when exceeding <code>MAX_EVENTS=250</code>.</p>
<a id="report-structure" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Report Structure<a href="#report-structure" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Generated markdown reports include:</p>
<ol>
<li><strong>Header</strong>: <code># Partial Profit/Loss Report: {symbol}:{strategyName}</code></li>
<li><strong>Event Table</strong>: Formatted using configurable <code>ColumnModel&lt;PartialEvent&gt;</code> columns</li>
<li><strong>Statistics</strong>:
<ul>
<li>Total events</li>
<li>Profit events count</li>
<li>Loss events count</li>
</ul>
</li>
</ol>
<p><strong>Default Columns</strong> <a href="">src/config/columns.ts</a>:</p>
<ul>
<li>Timestamp</li>
<li>Action (profit/loss)</li>
<li>Symbol</li>
<li>Signal ID</li>
<li>Position</li>
<li>Current Price</li>
<li>Level reached</li>
<li>Backtest flag</li>
</ul>
<hr>
<a id="integration-points" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Integration Points<a href="#integration-points" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><a id="clientstrategy-integration" class="tsd-anchor"></a><h3 class="tsd-anchor-link">ClientStrategy Integration<a href="#clientstrategy-integration" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><code>ClientStrategy</code> calls partial tracking during signal monitoring <a href="">src/client/ClientStrategy.ts</a>:</p>
<p><strong>Profit Tracking</strong>:</p>
<pre><code class="typescript"><span class="hl-5">if</span><span class="hl-2"> (</span><span class="hl-6">revenuePercent</span><span class="hl-2"> &gt; </span><span class="hl-7">0</span><span class="hl-2">) {</span><br/><span class="hl-2">  </span><span class="hl-5">await</span><span class="hl-2"> </span><span class="hl-3">this</span><span class="hl-2">.</span><span class="hl-6">params</span><span class="hl-2">.</span><span class="hl-6">partial</span><span class="hl-2">.</span><span class="hl-1">profit</span><span class="hl-2">(</span><br/><span class="hl-2">    </span><span class="hl-6">symbol</span><span class="hl-2">,</span><br/><span class="hl-2">    </span><span class="hl-6">signal</span><span class="hl-2">,</span><br/><span class="hl-2">    </span><span class="hl-6">currentPrice</span><span class="hl-2">,</span><br/><span class="hl-2">    </span><span class="hl-6">revenuePercent</span><span class="hl-2">,</span><br/><span class="hl-2">    </span><span class="hl-6">backtest</span><span class="hl-2">,</span><br/><span class="hl-2">    </span><span class="hl-6">when</span><br/><span class="hl-2">  );</span><br/><span class="hl-2">}</span>
</code><button type="button">Copy</button></pre>

<p><strong>Loss Tracking</strong>:</p>
<pre><code class="typescript"><span class="hl-5">if</span><span class="hl-2"> (</span><span class="hl-6">revenuePercent</span><span class="hl-2"> &lt; </span><span class="hl-7">0</span><span class="hl-2">) {</span><br/><span class="hl-2">  </span><span class="hl-5">await</span><span class="hl-2"> </span><span class="hl-3">this</span><span class="hl-2">.</span><span class="hl-6">params</span><span class="hl-2">.</span><span class="hl-6">partial</span><span class="hl-2">.</span><span class="hl-1">loss</span><span class="hl-2">(</span><br/><span class="hl-2">    </span><span class="hl-6">symbol</span><span class="hl-2">,</span><br/><span class="hl-2">    </span><span class="hl-6">signal</span><span class="hl-2">,</span><br/><span class="hl-2">    </span><span class="hl-6">currentPrice</span><span class="hl-2">,</span><br/><span class="hl-2">    </span><span class="hl-6">revenuePercent</span><span class="hl-2">,  </span><span class="hl-0">// Negative value</span><br/><span class="hl-2">    </span><span class="hl-6">backtest</span><span class="hl-2">,</span><br/><span class="hl-2">    </span><span class="hl-6">when</span><br/><span class="hl-2">  );</span><br/><span class="hl-2">}</span>
</code><button type="button">Copy</button></pre>

<p><strong>Cleanup on Close</strong>:</p>
<pre><code class="typescript"><span class="hl-5">await</span><span class="hl-2"> </span><span class="hl-3">this</span><span class="hl-2">.</span><span class="hl-6">params</span><span class="hl-2">.</span><span class="hl-6">partial</span><span class="hl-2">.</span><span class="hl-1">clear</span><span class="hl-2">(</span><span class="hl-6">symbol</span><span class="hl-2">, </span><span class="hl-6">signal</span><span class="hl-2">, </span><span class="hl-6">closePrice</span><span class="hl-2">, </span><span class="hl-6">backtest</span><span class="hl-2">);</span>
</code><button type="button">Copy</button></pre>

<a id="service-layer-hierarchy" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Service Layer Hierarchy<a href="#service-layer-hierarchy" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><img src="../media/75_Partial_Profit_Loss_Tracking_5.svg" alt="Mermaid Diagram"></p>
<p>The hierarchy follows the standard service layer pattern:</p>
<ol>
<li><strong>Global Service</strong>: Entry point with validation and logging</li>
<li><strong>Connection Service</strong>: Factory and instance management</li>
<li><strong>Client Implementation</strong>: Core business logic</li>
</ol>
<hr>
<a id="configuration-and-customization" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Configuration and Customization<a href="#configuration-and-customization" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><a id="column-configuration" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Column Configuration<a href="#column-configuration" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Partial reports use configurable <code>ColumnModel&lt;PartialEvent&gt;</code> interfaces. The default configuration is defined in <code>COLUMN_CONFIG.partial_columns</code> <a href="">src/config/columns.ts</a>.</p>
<p>Custom columns can be provided to override default formatting:</p>
<pre><code class="typescript"><span class="hl-3">const</span><span class="hl-2"> </span><span class="hl-8">customColumns</span><span class="hl-2">: </span><span class="hl-11">ColumnModel</span><span class="hl-2">&lt;</span><span class="hl-11">PartialEvent</span><span class="hl-2">&gt;[] = [</span><br/><span class="hl-2">  {</span><br/><span class="hl-2">    </span><span class="hl-6">key:</span><span class="hl-2"> </span><span class="hl-4">&quot;timestamp&quot;</span><span class="hl-2">,</span><br/><span class="hl-2">    </span><span class="hl-6">label:</span><span class="hl-2"> </span><span class="hl-4">&quot;Time&quot;</span><span class="hl-2">,</span><br/><span class="hl-2">    </span><span class="hl-1">format</span><span class="hl-6">:</span><span class="hl-2"> (</span><span class="hl-6">event</span><span class="hl-2">) </span><span class="hl-3">=&gt;</span><span class="hl-2"> </span><span class="hl-3">new</span><span class="hl-2"> </span><span class="hl-1">Date</span><span class="hl-2">(</span><span class="hl-6">event</span><span class="hl-2">.</span><span class="hl-6">timestamp</span><span class="hl-2">).</span><span class="hl-1">toISOString</span><span class="hl-2">(),</span><br/><span class="hl-2">    </span><span class="hl-1">isVisible</span><span class="hl-6">:</span><span class="hl-2"> () </span><span class="hl-3">=&gt;</span><span class="hl-2"> </span><span class="hl-3">true</span><br/><span class="hl-2">  },</span><br/><span class="hl-2">  {</span><br/><span class="hl-2">    </span><span class="hl-6">key:</span><span class="hl-2"> </span><span class="hl-4">&quot;level&quot;</span><span class="hl-2">,</span><br/><span class="hl-2">    </span><span class="hl-6">label:</span><span class="hl-2"> </span><span class="hl-4">&quot;Level&quot;</span><span class="hl-2">,</span><br/><span class="hl-2">    </span><span class="hl-1">format</span><span class="hl-6">:</span><span class="hl-2"> (</span><span class="hl-6">event</span><span class="hl-2">) </span><span class="hl-3">=&gt;</span><span class="hl-2"> </span><span class="hl-4">`</span><span class="hl-3">${</span><span class="hl-6">event</span><span class="hl-9">.</span><span class="hl-6">level</span><span class="hl-3">}</span><span class="hl-4">%`</span><span class="hl-2">,</span><br/><span class="hl-2">    </span><span class="hl-1">isVisible</span><span class="hl-6">:</span><span class="hl-2"> () </span><span class="hl-3">=&gt;</span><span class="hl-2"> </span><span class="hl-3">true</span><br/><span class="hl-2">  }</span><br/><span class="hl-2">];</span><br/><br/><span class="hl-5">await</span><span class="hl-2"> </span><span class="hl-6">partialMarkdownService</span><span class="hl-2">.</span><span class="hl-1">dump</span><span class="hl-2">(</span><br/><span class="hl-2">  </span><span class="hl-4">&quot;BTCUSDT&quot;</span><span class="hl-2">,</span><br/><span class="hl-2">  </span><span class="hl-4">&quot;my-strategy&quot;</span><span class="hl-2">,</span><br/><span class="hl-2">  </span><span class="hl-4">&quot;./reports&quot;</span><span class="hl-2">,</span><br/><span class="hl-2">  </span><span class="hl-6">customColumns</span><br/><span class="hl-2">);</span>
</code><button type="button">Copy</button></pre>

<a id="persistence-path" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Persistence Path<a href="#persistence-path" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Default persistence path: <code>./dump/data/partial/{strategy}/{symbol}.json</code></p>
<p>The base directory can be customized when creating <code>PersistPartialAdapter</code> instances, though this is typically managed internally by the framework.</p>
<hr>
<a id="usage-examples" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Usage Examples<a href="#usage-examples" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><a id="listening-to-partial-events" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Listening to Partial Events<a href="#listening-to-partial-events" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><strong>Listen to all profit events</strong>:</p>
<pre><code class="typescript"><span class="hl-5">import</span><span class="hl-2"> { </span><span class="hl-6">listenPartialProfit</span><span class="hl-2"> } </span><span class="hl-5">from</span><span class="hl-2"> </span><span class="hl-4">&quot;backtest-kit&quot;</span><span class="hl-2">;</span><br/><br/><span class="hl-1">listenPartialProfit</span><span class="hl-2">((</span><span class="hl-6">event</span><span class="hl-2">) </span><span class="hl-3">=&gt;</span><span class="hl-2"> {</span><br/><span class="hl-2">  </span><span class="hl-6">console</span><span class="hl-2">.</span><span class="hl-1">log</span><span class="hl-2">(</span><span class="hl-4">`Signal </span><span class="hl-3">${</span><span class="hl-6">event</span><span class="hl-9">.</span><span class="hl-6">data</span><span class="hl-9">.</span><span class="hl-6">id</span><span class="hl-3">}</span><span class="hl-4"> reached </span><span class="hl-3">${</span><span class="hl-6">event</span><span class="hl-9">.</span><span class="hl-6">level</span><span class="hl-3">}</span><span class="hl-4">% profit`</span><span class="hl-2">);</span><br/><span class="hl-2">  </span><span class="hl-6">console</span><span class="hl-2">.</span><span class="hl-1">log</span><span class="hl-2">(</span><span class="hl-4">`Symbol: </span><span class="hl-3">${</span><span class="hl-6">event</span><span class="hl-9">.</span><span class="hl-6">symbol</span><span class="hl-3">}</span><span class="hl-4">, Price: </span><span class="hl-3">${</span><span class="hl-6">event</span><span class="hl-9">.</span><span class="hl-6">currentPrice</span><span class="hl-3">}</span><span class="hl-4">`</span><span class="hl-2">);</span><br/><span class="hl-2">  </span><br/><span class="hl-2">  </span><span class="hl-5">if</span><span class="hl-2"> (</span><span class="hl-6">event</span><span class="hl-2">.</span><span class="hl-6">level</span><span class="hl-2"> &gt;= </span><span class="hl-7">50</span><span class="hl-2"> &amp;&amp; !</span><span class="hl-6">event</span><span class="hl-2">.</span><span class="hl-6">backtest</span><span class="hl-2">) {</span><br/><span class="hl-2">    </span><span class="hl-6">console</span><span class="hl-2">.</span><span class="hl-1">log</span><span class="hl-2">(</span><span class="hl-4">&quot;MAJOR PROFIT: Consider partial exit&quot;</span><span class="hl-2">);</span><br/><span class="hl-2">  }</span><br/><span class="hl-2">});</span>
</code><button type="button">Copy</button></pre>

<p><strong>Wait for specific loss level</strong>:</p>
<pre><code class="typescript"><span class="hl-5">import</span><span class="hl-2"> { </span><span class="hl-6">listenPartialLossOnce</span><span class="hl-2"> } </span><span class="hl-5">from</span><span class="hl-2"> </span><span class="hl-4">&quot;backtest-kit&quot;</span><span class="hl-2">;</span><br/><br/><span class="hl-1">listenPartialLossOnce</span><span class="hl-2">(</span><br/><span class="hl-2">  (</span><span class="hl-6">event</span><span class="hl-2">) </span><span class="hl-3">=&gt;</span><span class="hl-2"> </span><span class="hl-6">event</span><span class="hl-2">.</span><span class="hl-6">level</span><span class="hl-2"> === </span><span class="hl-7">30</span><span class="hl-2">,</span><br/><span class="hl-2">  (</span><span class="hl-6">event</span><span class="hl-2">) </span><span class="hl-3">=&gt;</span><span class="hl-2"> {</span><br/><span class="hl-2">    </span><span class="hl-6">console</span><span class="hl-2">.</span><span class="hl-1">warn</span><span class="hl-2">(</span><span class="hl-4">`30% loss reached on </span><span class="hl-3">${</span><span class="hl-6">event</span><span class="hl-9">.</span><span class="hl-6">symbol</span><span class="hl-3">}</span><span class="hl-4">`</span><span class="hl-2">);</span><br/><span class="hl-2">    </span><span class="hl-0">// Trigger alerts or intervention logic</span><br/><span class="hl-2">  }</span><br/><span class="hl-2">);</span>
</code><button type="button">Copy</button></pre>

<a id="generating-reports" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Generating Reports<a href="#generating-reports" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><strong>Programmatic report access</strong>:</p>
<pre><code class="typescript"><span class="hl-5">import</span><span class="hl-2"> { </span><span class="hl-6">PartialMarkdownService</span><span class="hl-2"> } </span><span class="hl-5">from</span><span class="hl-2"> </span><span class="hl-4">&quot;backtest-kit&quot;</span><span class="hl-2">;</span><br/><br/><span class="hl-3">const</span><span class="hl-2"> </span><span class="hl-8">service</span><span class="hl-2"> = </span><span class="hl-3">new</span><span class="hl-2"> </span><span class="hl-1">PartialMarkdownService</span><span class="hl-2">();</span><br/><br/><span class="hl-0">// Get statistics</span><br/><span class="hl-3">const</span><span class="hl-2"> </span><span class="hl-8">stats</span><span class="hl-2"> = </span><span class="hl-5">await</span><span class="hl-2"> </span><span class="hl-6">service</span><span class="hl-2">.</span><span class="hl-1">getData</span><span class="hl-2">(</span><span class="hl-4">&quot;BTCUSDT&quot;</span><span class="hl-2">, </span><span class="hl-4">&quot;my-strategy&quot;</span><span class="hl-2">);</span><br/><span class="hl-6">console</span><span class="hl-2">.</span><span class="hl-1">log</span><span class="hl-2">(</span><span class="hl-4">`Total events: </span><span class="hl-3">${</span><span class="hl-6">stats</span><span class="hl-9">.</span><span class="hl-6">totalEvents</span><span class="hl-3">}</span><span class="hl-4">`</span><span class="hl-2">);</span><br/><span class="hl-6">console</span><span class="hl-2">.</span><span class="hl-1">log</span><span class="hl-2">(</span><span class="hl-4">`Profit events: </span><span class="hl-3">${</span><span class="hl-6">stats</span><span class="hl-9">.</span><span class="hl-6">totalProfit</span><span class="hl-3">}</span><span class="hl-4">`</span><span class="hl-2">);</span><br/><span class="hl-6">console</span><span class="hl-2">.</span><span class="hl-1">log</span><span class="hl-2">(</span><span class="hl-4">`Loss events: </span><span class="hl-3">${</span><span class="hl-6">stats</span><span class="hl-9">.</span><span class="hl-6">totalLoss</span><span class="hl-3">}</span><span class="hl-4">`</span><span class="hl-2">);</span><br/><br/><span class="hl-0">// Generate markdown</span><br/><span class="hl-3">const</span><span class="hl-2"> </span><span class="hl-8">markdown</span><span class="hl-2"> = </span><span class="hl-5">await</span><span class="hl-2"> </span><span class="hl-6">service</span><span class="hl-2">.</span><span class="hl-1">getReport</span><span class="hl-2">(</span><span class="hl-4">&quot;BTCUSDT&quot;</span><span class="hl-2">, </span><span class="hl-4">&quot;my-strategy&quot;</span><span class="hl-2">);</span><br/><span class="hl-6">console</span><span class="hl-2">.</span><span class="hl-1">log</span><span class="hl-2">(</span><span class="hl-6">markdown</span><span class="hl-2">);</span><br/><br/><span class="hl-0">// Save to disk</span><br/><span class="hl-5">await</span><span class="hl-2"> </span><span class="hl-6">service</span><span class="hl-2">.</span><span class="hl-1">dump</span><span class="hl-2">(</span><span class="hl-4">&quot;BTCUSDT&quot;</span><span class="hl-2">, </span><span class="hl-4">&quot;my-strategy&quot;</span><span class="hl-2">, </span><span class="hl-4">&quot;./reports&quot;</span><span class="hl-2">);</span>
</code><button type="button">Copy</button></pre>

<hr>
<a id="performance-considerations" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Performance Considerations<a href="#performance-considerations" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><a id="memory-management" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Memory Management<a href="#memory-management" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><ul>
<li><strong>Memoization</strong>: <code>ClientPartial</code> instances are memoized per signal ID and backtest mode <a href="">src/lib/services/connection/PartialConnectionService.ts:132-143</a></li>
<li><strong>Bounded Queues</strong>: <code>ReportStorage</code> limits events to <code>MAX_EVENTS=250</code> per symbol-strategy pair <a href="">src/lib/services/markdown/PartialMarkdownService.ts:54</a></li>
<li><strong>Cleanup</strong>: <code>clear()</code> removes signal state and memoized instances when signals close <a href="">src/lib/services/connection/PartialConnectionService.ts:246-263</a></li>
</ul>
<a id="backtest-mode-optimization" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Backtest Mode Optimization<a href="#backtest-mode-optimization" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Backtest mode skips all disk I/O operations:</p>
<ul>
<li>No state loading in <code>waitForInit()</code> <a href="">src/client/ClientPartial.ts:214-218</a></li>
<li>No state persistence in <code>_persistState()</code> <a href="">src/client/ClientPartial.ts:350-352</a></li>
</ul>
<p>This prevents unnecessary filesystem operations during historical simulation where crash recovery is not needed.</p>
<a id="set-based-deduplication" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Set-Based Deduplication<a href="#set-based-deduplication" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Using <code>Set&lt;PartialLevel&gt;</code> for state provides:</p>
<ul>
<li><strong>O(1) lookup</strong>: Fast checking if level already emitted</li>
<li><strong>O(1) insertion</strong>: Adding new levels has constant time complexity</li>
<li><strong>Memory efficiency</strong>: Only stores emitted levels (max 10 per signal per profit/loss)</li>
</ul>
<hr>
<a id="error-handling" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Error Handling<a href="#error-handling" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><a id="validation-checks" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Validation Checks<a href="#validation-checks" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>The system enforces several validation rules:</p>
<p><strong>Pre-initialization check</strong> <a href="">src/client/ClientPartial.ts:53-56</a>:</p>
<pre><code class="typescript"><span class="hl-5">if</span><span class="hl-2"> (</span><span class="hl-6">self</span><span class="hl-2">.</span><span class="hl-6">_states</span><span class="hl-2"> === </span><span class="hl-8">NEED_FETCH</span><span class="hl-2">) {</span><br/><span class="hl-2">  </span><span class="hl-5">throw</span><span class="hl-2"> </span><span class="hl-3">new</span><span class="hl-2"> </span><span class="hl-1">Error</span><span class="hl-2">(</span><br/><span class="hl-2">    </span><span class="hl-4">&quot;ClientPartial not initialized. Call waitForInit() before using.&quot;</span><br/><span class="hl-2">  );</span><br/><span class="hl-2">}</span>
</code><button type="button">Copy</button></pre>

<p><strong>Signal ID mismatch</strong> <a href="">src/client/ClientPartial.ts:59-62</a>:</p>
<pre><code class="typescript"><span class="hl-5">if</span><span class="hl-2"> (</span><span class="hl-6">data</span><span class="hl-2">.</span><span class="hl-6">id</span><span class="hl-2"> !== </span><span class="hl-6">self</span><span class="hl-2">.</span><span class="hl-6">params</span><span class="hl-2">.</span><span class="hl-6">signalId</span><span class="hl-2">) {</span><br/><span class="hl-2">  </span><span class="hl-5">throw</span><span class="hl-2"> </span><span class="hl-3">new</span><span class="hl-2"> </span><span class="hl-1">Error</span><span class="hl-2">(</span><br/><span class="hl-2">    </span><span class="hl-4">`Signal ID mismatch: expected </span><span class="hl-3">${</span><span class="hl-6">self</span><span class="hl-9">.</span><span class="hl-6">params</span><span class="hl-9">.</span><span class="hl-6">signalId</span><span class="hl-3">}</span><span class="hl-4">, got </span><span class="hl-3">${</span><span class="hl-6">data</span><span class="hl-9">.</span><span class="hl-6">id</span><span class="hl-3">}</span><span class="hl-4">`</span><br/><span class="hl-2">  );</span><br/><span class="hl-2">}</span>
</code><button type="button">Copy</button></pre>

<p><strong>Strategy validation</strong>: <code>PartialGlobalService</code> validates strategy and risk names before delegation <a href="">src/lib/services/global/PartialGlobalService.ts:83-95</a></p>
<a id="persistence-error-recovery" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Persistence Error Recovery<a href="#persistence-error-recovery" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><code>PersistBase</code> implements retry logic and auto-cleanup:</p>
<ul>
<li><strong>Retry count</strong>: 5 attempts with 1-second delays <a href="">src/classes/Persist.ts:57-58</a></li>
<li><strong>Validation on init</strong>: Reads and validates all JSON files during initialization <a href="">src/classes/Persist.ts:138-152</a></li>
<li><strong>Auto-cleanup</strong>: Removes corrupted files that fail parsing <a href="">src/classes/Persist.ts:143-151</a></li>
</ul>
</div></div><div class="col-sidebar"><div class="page-menu"><div class="tsd-navigation settings"><details class="tsd-accordion"><summary class="tsd-accordion-summary"><h3><svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-chevronDown"></use></svg>Settings</h3></summary><div class="tsd-accordion-details"><div class="tsd-filter-visibility"><span class="settings-label">Member Visibility</span><ul id="tsd-filter-options"><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-protected" name="protected"/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Protected</span></label></li><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-inherited" name="inherited" checked/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Inherited</span></label></li><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-external" name="external"/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>External</span></label></li></ul></div><div class="tsd-theme-toggle"><label class="settings-label" for="tsd-theme">Theme</label><select id="tsd-theme"><option value="os">OS</option><option value="light">Light</option><option value="dark">Dark</option></select></div></div></details></div><details open class="tsd-accordion tsd-page-navigation"><summary class="tsd-accordion-summary"><h3><svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-chevronDown"></use></svg>On This Page</h3></summary><div class="tsd-accordion-details"><a href="#partial-profitloss-tracking"><span>Partial <wbr/>Profit/<wbr/>Loss <wbr/>Tracking</span></a><ul><li><a href="#system-overview"><span>System <wbr/>Overview</span></a></li><li><ul><li><a href="#key-components"><span>Key <wbr/>Components</span></a></li><li><a href="#data-flow"><span>Data <wbr/>Flow</span></a></li></ul></li><li><a href="#profitloss-level-system"><span>Profit/<wbr/>Loss <wbr/>Level <wbr/>System</span></a></li><li><ul><li><a href="#level-definitions"><span>Level <wbr/>Definitions</span></a></li><li><a href="#state-structure"><span>State <wbr/>Structure</span></a></li></ul></li><li><a href="#clientpartial-architecture"><span>Client<wbr/>Partial <wbr/>Architecture</span></a></li><li><ul><li><a href="#initialization-pattern"><span>Initialization <wbr/>Pattern</span></a></li><li><a href="#level-detection-logic"><span>Level <wbr/>Detection <wbr/>Logic</span></a></li><li><a href="#method-flow-diagram"><span>Method <wbr/>Flow <wbr/>Diagram</span></a></li></ul></li><li><a href="#event-contracts"><span>Event <wbr/>Contracts</span></a></li><li><ul><li><a href="#partialprofitcontract"><span>Partial<wbr/>Profit<wbr/>Contract</span></a></li><li><a href="#partiallosscontract"><span>Partial<wbr/>Loss<wbr/>Contract</span></a></li></ul></li><li><a href="#persistence-mechanism"><span>Persistence <wbr/>Mechanism</span></a></li><li><ul><li><a href="#persistence-architecture"><span>Persistence <wbr/>Architecture</span></a></li><li><a href="#persistence-flow"><span>Persistence <wbr/>Flow</span></a></li><li><a href="#file-location"><span>File <wbr/>Location</span></a></li></ul></li><li><a href="#partialmarkdownservice"><span>Partial<wbr/>Markdown<wbr/>Service</span></a></li><li><ul><li><a href="#event-accumulation"><span>Event <wbr/>Accumulation</span></a></li><li><a href="#reportstorage-class"><span>Report<wbr/>Storage <wbr/>Class</span></a></li><li><a href="#report-structure"><span>Report <wbr/>Structure</span></a></li></ul></li><li><a href="#integration-points"><span>Integration <wbr/>Points</span></a></li><li><ul><li><a href="#clientstrategy-integration"><span>Client<wbr/>Strategy <wbr/>Integration</span></a></li><li><a href="#service-layer-hierarchy"><span>Service <wbr/>Layer <wbr/>Hierarchy</span></a></li></ul></li><li><a href="#configuration-and-customization"><span>Configuration and <wbr/>Customization</span></a></li><li><ul><li><a href="#column-configuration"><span>Column <wbr/>Configuration</span></a></li><li><a href="#persistence-path"><span>Persistence <wbr/>Path</span></a></li></ul></li><li><a href="#usage-examples"><span>Usage <wbr/>Examples</span></a></li><li><ul><li><a href="#listening-to-partial-events"><span>Listening to <wbr/>Partial <wbr/>Events</span></a></li><li><a href="#generating-reports"><span>Generating <wbr/>Reports</span></a></li></ul></li><li><a href="#performance-considerations"><span>Performance <wbr/>Considerations</span></a></li><li><ul><li><a href="#memory-management"><span>Memory <wbr/>Management</span></a></li><li><a href="#backtest-mode-optimization"><span>Backtest <wbr/>Mode <wbr/>Optimization</span></a></li><li><a href="#set-based-deduplication"><span>Set-<wbr/>Based <wbr/>Deduplication</span></a></li></ul></li><li><a href="#error-handling"><span>Error <wbr/>Handling</span></a></li><li><ul><li><a href="#validation-checks"><span>Validation <wbr/>Checks</span></a></li><li><a href="#persistence-error-recovery"><span>Persistence <wbr/>Error <wbr/>Recovery</span></a></li></ul></li></ul></div></details></div><div class="site-menu"><nav class="tsd-navigation"><a href="../modules.html">backtest-kit</a><ul class="tsd-small-nested-navigation" id="tsd-nav-container"><li>Loading...</li></ul></nav></div></div></div><footer><p class="tsd-generator">Generated using <a href="https://typedoc.org/" target="_blank">TypeDoc</a></p></footer><div class="overlay"></div></body></html>

<!-- Yandex.Metrika counter -->
<script type="text/javascript">
    (function(m,e,t,r,i,k,a){
        m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
        m[i].l=1*new Date();
        for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }}
        k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)
    })(window, document,'script','https://mc.yandex.ru/metrika/tag.js?id=105455585', 'ym');

    ym(105455585, 'init', {ssr:true, webvisor:true, clickmap:true, ecommerce:"dataLayer", accurateTrackBounce:true, trackLinks:true});
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/105455585" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
<!-- /Yandex.Metrika counter -->

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-3MQZEBBDDR"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-3MQZEBBDDR');
</script>
