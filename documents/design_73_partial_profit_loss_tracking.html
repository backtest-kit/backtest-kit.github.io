<!DOCTYPE html><html class="default" lang="en" data-base=".."><head><meta charset="utf-8"/><meta http-equiv="x-ua-compatible" content="IE=edge"/><title>design/73_partial_profit_loss_tracking | backtest-kit</title><meta name="description" content="Documentation for backtest-kit"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="stylesheet" href="../assets/style.css"/><link rel="stylesheet" href="../assets/highlight.css"/><script defer src="../assets/main.js"></script><script async src="../assets/icons.js" id="tsd-icons-script"></script><script async src="../assets/search.js" id="tsd-search-script"></script><script async src="../assets/navigation.js" id="tsd-nav-script"></script><script async src="../assets/hierarchy.js" id="tsd-hierarchy-script"></script></head><body><script>document.documentElement.dataset.theme = localStorage.getItem("tsd-theme") || "os";document.body.style.display="none";setTimeout(() => app?app.showPage():document.body.style.removeProperty("display"),500)</script><header class="tsd-page-toolbar"><div class="tsd-toolbar-contents container"><div class="table-cell" id="tsd-search"><div class="field"><label for="tsd-search-field" class="tsd-widget tsd-toolbar-icon search no-caption"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-search"></use></svg></label><input type="text" id="tsd-search-field" aria-label="Search"/></div><div class="field"><div id="tsd-toolbar-links"></div></div><ul class="results"><li class="state loading">Preparing search index...</li><li class="state failure">The search index is not available</li></ul><a href="../index.html" class="title">backtest-kit</a></div><div class="table-cell" id="tsd-widgets"><a href="#" class="tsd-widget tsd-toolbar-icon menu no-caption" data-toggle="menu" aria-label="Menu"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-menu"></use></svg></a></div></div></header><div class="container container-main"><div class="col-content"><div class="tsd-page-title"><ul class="tsd-breadcrumb"><li><a href="../modules.html">backtest-kit</a></li><li><a href="design_73_partial_profit_loss_tracking.html">design/73_partial_profit_loss_tracking</a></li></ul></div><div class="tsd-panel tsd-typography"><a id="partial-profitloss-tracking" class="tsd-anchor"></a><h1 class="tsd-anchor-link">Partial Profit/Loss Tracking<a href="#partial-profitloss-tracking" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h1><a id="purpose-and-scope" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Purpose and Scope<a href="#purpose-and-scope" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>This document explains the <strong>Partial Profit/Loss Tracking</strong> system, which monitors unrealized profit and loss milestones during active signal execution. The system tracks when positions reach fixed percentage levels (10%, 20%, 30%, etc.) and emits events for risk management, position scaling strategies, and performance monitoring.</p>
<p>For general signal lifecycle information, see <a href="design_07_signal_lifecycle_overview.html">Signal Lifecycle Overview</a>. For PnL calculation details, see <a href="design_51_pnl_calculation.html">PnL Calculation</a>. For reporting systems, see <a href="design_69_reporting_and_analytics.html">Reporting and Analytics</a>.</p>
<hr>
<a id="system-architecture" class="tsd-anchor"></a><h2 class="tsd-anchor-link">System Architecture<a href="#system-architecture" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>The Partial system operates as an event-driven subsystem that monitors active signals and emits milestone events when unrealized profit or loss reaches predefined thresholds.</p>
<p><img src="../media/73_Partial_Profit_Loss_Tracking_0.svg" alt="Mermaid Diagram"></p>
<hr>
<a id="milestone-levels" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Milestone Levels<a href="#milestone-levels" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>The system tracks unrealized profit/loss at <strong>fixed percentage intervals</strong> from 10% to 100% in 10% increments, plus additional granular levels beyond 100%.</p>
<a id="standard-milestone-levels" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Standard Milestone Levels<a href="#standard-milestone-levels" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><table>
<thead>
<tr>
<th>Level %</th>
<th>Description</th>
<th>Trigger Condition (LONG)</th>
<th>Trigger Condition (SHORT)</th>
</tr>
</thead>
<tbody>
<tr>
<td>10%</td>
<td>First milestone</td>
<td>currentPrice ≥ priceOpen × 1.10</td>
<td>currentPrice ≤ priceOpen × 0.90</td>
</tr>
<tr>
<td>20%</td>
<td>Second milestone</td>
<td>currentPrice ≥ priceOpen × 1.20</td>
<td>currentPrice ≤ priceOpen × 0.80</td>
</tr>
<tr>
<td>30%</td>
<td>Third milestone</td>
<td>currentPrice ≥ priceOpen × 1.30</td>
<td>currentPrice ≤ priceOpen × 0.70</td>
</tr>
<tr>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr>
<td>100%</td>
<td>Double position</td>
<td>currentPrice ≥ priceOpen × 2.00</td>
<td>currentPrice ≤ priceOpen × 0.00</td>
</tr>
</tbody>
</table>
<a id="calculation-logic" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Calculation Logic<a href="#calculation-logic" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>For <strong>LONG positions</strong> (profit when price rises):</p>
<pre><code><span class="hl-4">unrealizedPnlPercent</span><span class="hl-1"> = ((</span><span class="hl-4">currentPrice</span><span class="hl-1"> - </span><span class="hl-4">priceOpen</span><span class="hl-1">) / </span><span class="hl-4">priceOpen</span><span class="hl-1">) × </span><span class="hl-6">100</span>
</code><button>Copy</button></pre>

<p>For <strong>SHORT positions</strong> (profit when price falls):</p>
<pre><code><span class="hl-4">unrealizedPnlPercent</span><span class="hl-1"> = ((</span><span class="hl-4">priceOpen</span><span class="hl-1"> - </span><span class="hl-4">currentPrice</span><span class="hl-1">) / </span><span class="hl-4">priceOpen</span><span class="hl-1">) × </span><span class="hl-6">100</span>
</code><button>Copy</button></pre>

<p><strong>Negative values</strong> indicate losses and trigger <code>onPartialLoss</code> callbacks.</p>
<hr>
<a id="callback-integration" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Callback Integration<a href="#callback-integration" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>Partial tracking integrates with the strategy callback system through two optional callbacks in <code>IStrategyCallbacks</code>.</p>
<a id="callback-signatures" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Callback Signatures<a href="#callback-signatures" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><pre><code class="typescript"><span class="hl-7">interface</span><span class="hl-1"> </span><span class="hl-13">IStrategyCallbacks</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-5">/**</span><br/><span class="hl-5">   * Called when unrealized profit reaches a milestone level.</span><br/><span class="hl-5">   * </span><br/><span class="hl-5">   * </span><span class="hl-7">@param</span><span class="hl-5"> </span><span class="hl-4">symbol</span><span class="hl-5"> - Trading pair symbol</span><br/><span class="hl-5">   * </span><span class="hl-7">@param</span><span class="hl-5"> </span><span class="hl-4">signal</span><span class="hl-5"> - Active signal data</span><br/><span class="hl-5">   * </span><span class="hl-7">@param</span><span class="hl-5"> </span><span class="hl-4">currentPrice</span><span class="hl-5"> - Current market price</span><br/><span class="hl-5">   * </span><span class="hl-7">@param</span><span class="hl-5"> </span><span class="hl-4">revenuePercent</span><span class="hl-5"> - Unrealized profit percentage (positive)</span><br/><span class="hl-5">   * </span><span class="hl-7">@param</span><span class="hl-5"> </span><span class="hl-4">backtest</span><span class="hl-5"> - True if backtest mode, false if live</span><br/><span class="hl-5">   */</span><br/><span class="hl-1">  </span><span class="hl-0">onPartialProfit</span><span class="hl-1">?: (</span><br/><span class="hl-1">    </span><span class="hl-4">symbol</span><span class="hl-1">: </span><span class="hl-13">string</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-4">signal</span><span class="hl-1">: </span><span class="hl-13">ISignal</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-4">currentPrice</span><span class="hl-1">: </span><span class="hl-13">number</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-4">revenuePercent</span><span class="hl-1">: </span><span class="hl-13">number</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-4">backtest</span><span class="hl-1">: </span><span class="hl-13">boolean</span><br/><span class="hl-1">  ) </span><span class="hl-7">=&gt;</span><span class="hl-1"> </span><span class="hl-13">void</span><span class="hl-1">;</span><br/><br/><span class="hl-1">  </span><span class="hl-5">/**</span><br/><span class="hl-5">   * Called when unrealized loss reaches a milestone level.</span><br/><span class="hl-5">   * </span><br/><span class="hl-5">   * </span><span class="hl-7">@param</span><span class="hl-5"> </span><span class="hl-4">symbol</span><span class="hl-5"> - Trading pair symbol</span><br/><span class="hl-5">   * </span><span class="hl-7">@param</span><span class="hl-5"> </span><span class="hl-4">signal</span><span class="hl-5"> - Active signal data</span><br/><span class="hl-5">   * </span><span class="hl-7">@param</span><span class="hl-5"> </span><span class="hl-4">currentPrice</span><span class="hl-5"> - Current market price</span><br/><span class="hl-5">   * </span><span class="hl-7">@param</span><span class="hl-5"> </span><span class="hl-4">revenuePercent</span><span class="hl-5"> - Unrealized loss percentage (negative)</span><br/><span class="hl-5">   * </span><span class="hl-7">@param</span><span class="hl-5"> </span><span class="hl-4">backtest</span><span class="hl-5"> - True if backtest mode, false if live</span><br/><span class="hl-5">   */</span><br/><span class="hl-1">  </span><span class="hl-0">onPartialLoss</span><span class="hl-1">?: (</span><br/><span class="hl-1">    </span><span class="hl-4">symbol</span><span class="hl-1">: </span><span class="hl-13">string</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-4">signal</span><span class="hl-1">: </span><span class="hl-13">ISignal</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-4">currentPrice</span><span class="hl-1">: </span><span class="hl-13">number</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-4">revenuePercent</span><span class="hl-1">: </span><span class="hl-13">number</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-4">backtest</span><span class="hl-1">: </span><span class="hl-13">boolean</span><br/><span class="hl-1">  ) </span><span class="hl-7">=&gt;</span><span class="hl-1"> </span><span class="hl-13">void</span><span class="hl-1">;</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<a id="usage-example" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Usage Example<a href="#usage-example" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><pre><code class="typescript"><span class="hl-0">addStrategy</span><span class="hl-1">({</span><br/><span class="hl-1">  </span><span class="hl-4">strategyName:</span><span class="hl-1"> </span><span class="hl-2">&quot;scalp-strategy&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">interval:</span><span class="hl-1"> </span><span class="hl-2">&quot;5m&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-0">getSignal</span><span class="hl-4">:</span><span class="hl-1"> </span><span class="hl-7">async</span><span class="hl-1"> (</span><span class="hl-4">symbol</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-5">// Signal generation logic</span><br/><span class="hl-1">  },</span><br/><span class="hl-1">  </span><span class="hl-4">callbacks:</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-0">onPartialProfit</span><span class="hl-4">:</span><span class="hl-1"> (</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">signal</span><span class="hl-1">, </span><span class="hl-4">currentPrice</span><span class="hl-1">, </span><span class="hl-4">revenuePercent</span><span class="hl-1">, </span><span class="hl-4">backtest</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">      </span><span class="hl-4">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-2">`[</span><span class="hl-7">${</span><span class="hl-4">backtest</span><span class="hl-9"> </span><span class="hl-1">?</span><span class="hl-9"> </span><span class="hl-2">&quot;BT&quot;</span><span class="hl-9"> </span><span class="hl-1">:</span><span class="hl-9"> </span><span class="hl-2">&quot;LIVE&quot;</span><span class="hl-7">}</span><span class="hl-2">] Profit: </span><span class="hl-7">${</span><span class="hl-4">revenuePercent</span><span class="hl-9">.</span><span class="hl-0">toFixed</span><span class="hl-9">(</span><span class="hl-6">2</span><span class="hl-9">)</span><span class="hl-7">}</span><span class="hl-2">%`</span><span class="hl-1">);</span><br/><span class="hl-1">      </span><br/><span class="hl-1">      </span><span class="hl-5">// Scale out position at 50% profit</span><br/><span class="hl-1">      </span><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-4">revenuePercent</span><span class="hl-1"> &gt;= </span><span class="hl-6">50</span><span class="hl-1">) {</span><br/><span class="hl-1">        </span><span class="hl-4">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-2">`Consider taking partial profit at </span><span class="hl-7">${</span><span class="hl-4">currentPrice</span><span class="hl-7">}</span><span class="hl-2">`</span><span class="hl-1">);</span><br/><span class="hl-1">      }</span><br/><span class="hl-1">    },</span><br/><span class="hl-1">    </span><span class="hl-0">onPartialLoss</span><span class="hl-4">:</span><span class="hl-1"> (</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">signal</span><span class="hl-1">, </span><span class="hl-4">currentPrice</span><span class="hl-1">, </span><span class="hl-4">revenuePercent</span><span class="hl-1">, </span><span class="hl-4">backtest</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">      </span><span class="hl-4">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-2">`[</span><span class="hl-7">${</span><span class="hl-4">backtest</span><span class="hl-9"> </span><span class="hl-1">?</span><span class="hl-9"> </span><span class="hl-2">&quot;BT&quot;</span><span class="hl-9"> </span><span class="hl-1">:</span><span class="hl-9"> </span><span class="hl-2">&quot;LIVE&quot;</span><span class="hl-7">}</span><span class="hl-2">] Loss: </span><span class="hl-7">${</span><span class="hl-4">revenuePercent</span><span class="hl-9">.</span><span class="hl-0">toFixed</span><span class="hl-9">(</span><span class="hl-6">2</span><span class="hl-9">)</span><span class="hl-7">}</span><span class="hl-2">%`</span><span class="hl-1">);</span><br/><span class="hl-1">      </span><br/><span class="hl-1">      </span><span class="hl-5">// Tighten stop loss at -30% unrealized loss</span><br/><span class="hl-1">      </span><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-4">revenuePercent</span><span class="hl-1"> &lt;= -</span><span class="hl-6">30</span><span class="hl-1">) {</span><br/><span class="hl-1">        </span><span class="hl-4">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-2">`Warning: Approaching stop loss at </span><span class="hl-7">${</span><span class="hl-4">currentPrice</span><span class="hl-7">}</span><span class="hl-2">`</span><span class="hl-1">);</span><br/><span class="hl-1">      }</span><br/><span class="hl-1">    },</span><br/><span class="hl-1">  },</span><br/><span class="hl-1">});</span>
</code><button type="button">Copy</button></pre>

<hr>
<a id="event-listener-api" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Event Listener API<a href="#event-listener-api" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>The system provides event listeners for external monitoring without requiring strategy callback registration.</p>
<a id="listener-functions" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Listener Functions<a href="#listener-functions" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><img src="../media/73_Partial_Profit_Loss_Tracking_1.svg" alt="Mermaid Diagram"></p>
<a id="api-reference" class="tsd-anchor"></a><h3 class="tsd-anchor-link">API Reference<a href="#api-reference" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><table>
<thead>
<tr>
<th>Function</th>
<th>Description</th>
<th>Return Value</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>listenPartialProfit(callback)</code></td>
<td>Subscribe to all profit milestone events</td>
<td><code>() =&gt; void</code> (unsubscribe function)</td>
</tr>
<tr>
<td><code>listenPartialProfitOnce(callback)</code></td>
<td>Subscribe to first profit milestone event only</td>
<td><code>() =&gt; void</code> (unsubscribe function)</td>
</tr>
<tr>
<td><code>listenPartialLoss(callback)</code></td>
<td>Subscribe to all loss milestone events</td>
<td><code>() =&gt; void</code> (unsubscribe function)</td>
</tr>
<tr>
<td><code>listenPartialLossOnce(callback)</code></td>
<td>Subscribe to first loss milestone event only</td>
<td><code>() =&gt; void</code> (unsubscribe function)</td>
</tr>
</tbody>
</table>
<a id="event-structure" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Event Structure<a href="#event-structure" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><pre><code class="typescript"><span class="hl-7">interface</span><span class="hl-1"> </span><span class="hl-13">PartialEvent</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-5">/** Event action type */</span><br/><span class="hl-1">  </span><span class="hl-4">action</span><span class="hl-1">: </span><span class="hl-2">&quot;partial-profit&quot;</span><span class="hl-1"> | </span><span class="hl-2">&quot;partial-loss&quot;</span><span class="hl-1">;</span><br/><span class="hl-1">  </span><br/><span class="hl-1">  </span><span class="hl-5">/** Trading pair symbol */</span><br/><span class="hl-1">  </span><span class="hl-4">symbol</span><span class="hl-1">: </span><span class="hl-13">string</span><span class="hl-1">;</span><br/><span class="hl-1">  </span><br/><span class="hl-1">  </span><span class="hl-5">/** Active signal data */</span><br/><span class="hl-1">  </span><span class="hl-4">signal</span><span class="hl-1">: </span><span class="hl-13">ISignal</span><span class="hl-1">;</span><br/><span class="hl-1">  </span><br/><span class="hl-1">  </span><span class="hl-5">/** Current market price */</span><br/><span class="hl-1">  </span><span class="hl-4">currentPrice</span><span class="hl-1">: </span><span class="hl-13">number</span><span class="hl-1">;</span><br/><span class="hl-1">  </span><br/><span class="hl-1">  </span><span class="hl-5">/** Milestone percentage level (10, 20, 30, ...) */</span><br/><span class="hl-1">  </span><span class="hl-4">levelPercent</span><span class="hl-1">: </span><span class="hl-13">number</span><span class="hl-1">;</span><br/><span class="hl-1">  </span><br/><span class="hl-1">  </span><span class="hl-5">/** Unrealized PnL percentage */</span><br/><span class="hl-1">  </span><span class="hl-4">revenuePercent</span><span class="hl-1">: </span><span class="hl-13">number</span><span class="hl-1">;</span><br/><span class="hl-1">  </span><br/><span class="hl-1">  </span><span class="hl-5">/** Timestamp of milestone */</span><br/><span class="hl-1">  </span><span class="hl-4">timestamp</span><span class="hl-1">: </span><span class="hl-13">number</span><span class="hl-1">;</span><br/><span class="hl-1">  </span><br/><span class="hl-1">  </span><span class="hl-5">/** Execution mode */</span><br/><span class="hl-1">  </span><span class="hl-4">backtest</span><span class="hl-1">: </span><span class="hl-13">boolean</span><span class="hl-1">;</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<a id="usage-example-1" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Usage Example<a href="#usage-example-1" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><pre><code class="typescript"><span class="hl-3">import</span><span class="hl-1"> { </span><span class="hl-4">listenPartialProfit</span><span class="hl-1">, </span><span class="hl-4">listenPartialLoss</span><span class="hl-1"> } </span><span class="hl-3">from</span><span class="hl-1"> </span><span class="hl-2">&quot;backtest-kit&quot;</span><span class="hl-1">;</span><br/><br/><span class="hl-5">// Monitor all profit milestones</span><br/><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">unsubscribeProfit</span><span class="hl-1"> = </span><span class="hl-0">listenPartialProfit</span><span class="hl-1">((</span><span class="hl-4">event</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-4">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-2">`Profit milestone: </span><span class="hl-7">${</span><span class="hl-4">event</span><span class="hl-9">.</span><span class="hl-4">levelPercent</span><span class="hl-7">}</span><span class="hl-2">% at $</span><span class="hl-7">${</span><span class="hl-4">event</span><span class="hl-9">.</span><span class="hl-4">currentPrice</span><span class="hl-7">}</span><span class="hl-2">`</span><span class="hl-1">);</span><br/><span class="hl-1">  </span><span class="hl-4">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-2">`Unrealized PnL: </span><span class="hl-7">${</span><span class="hl-4">event</span><span class="hl-9">.</span><span class="hl-4">revenuePercent</span><span class="hl-9">.</span><span class="hl-0">toFixed</span><span class="hl-9">(</span><span class="hl-6">2</span><span class="hl-9">)</span><span class="hl-7">}</span><span class="hl-2">%`</span><span class="hl-1">);</span><br/><span class="hl-1">});</span><br/><br/><span class="hl-5">// Monitor all loss milestones</span><br/><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">unsubscribeLoss</span><span class="hl-1"> = </span><span class="hl-0">listenPartialLoss</span><span class="hl-1">((</span><span class="hl-4">event</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-4">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-2">`Loss milestone: </span><span class="hl-7">${</span><span class="hl-4">event</span><span class="hl-9">.</span><span class="hl-4">levelPercent</span><span class="hl-7">}</span><span class="hl-2">% at $</span><span class="hl-7">${</span><span class="hl-4">event</span><span class="hl-9">.</span><span class="hl-4">currentPrice</span><span class="hl-7">}</span><span class="hl-2">`</span><span class="hl-1">);</span><br/><span class="hl-1">  </span><span class="hl-4">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-2">`Unrealized PnL: </span><span class="hl-7">${</span><span class="hl-4">event</span><span class="hl-9">.</span><span class="hl-4">revenuePercent</span><span class="hl-9">.</span><span class="hl-0">toFixed</span><span class="hl-9">(</span><span class="hl-6">2</span><span class="hl-9">)</span><span class="hl-7">}</span><span class="hl-2">%`</span><span class="hl-1">);</span><br/><span class="hl-1">});</span><br/><br/><span class="hl-5">// Cleanup</span><br/><span class="hl-0">unsubscribeProfit</span><span class="hl-1">();</span><br/><span class="hl-0">unsubscribeLoss</span><span class="hl-1">();</span>
</code><button type="button">Copy</button></pre>

<hr>
<a id="partialmarkdownservice" class="tsd-anchor"></a><h2 class="tsd-anchor-link">PartialMarkdownService<a href="#partialmarkdownservice" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>The <code>PartialMarkdownService</code> accumulates partial profit/loss events and generates statistical reports, following the same architecture pattern as <code>BacktestMarkdownService</code> and <code>LiveMarkdownService</code>.</p>
<a id="service-architecture" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Service Architecture<a href="#service-architecture" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><img src="../media/73_Partial_Profit_Loss_Tracking_2.svg" alt="Mermaid Diagram"></p>
<a id="storage-behavior" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Storage Behavior<a href="#storage-behavior" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>The service maintains a <strong>per-symbol</strong> event queue with a maximum of <strong>250 events</strong> (configurable via <code>MAX_EVENTS</code>). When the queue exceeds capacity, the oldest events are removed (FIFO).</p>
<p><strong>Key characteristics:</strong></p>
<ul>
<li><strong>Memoization</strong>: Each <code>symbol</code> gets its own isolated <code>ReportStorage</code> instance</li>
<li><strong>Event types</strong>: Both profit and loss events stored in chronological order</li>
<li><strong>Queue management</strong>: Automatic trimming when exceeding <code>MAX_EVENTS</code></li>
<li><strong>Statistics</strong>: Real-time calculation without blocking event processing</li>
</ul>
<hr>
<a id="partial-statistics" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Partial Statistics<a href="#partial-statistics" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>The <code>PartialStatistics</code> interface provides comprehensive metrics for analyzing unrealized profit/loss behavior.</p>
<a id="statistics-interface" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Statistics Interface<a href="#statistics-interface" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><pre><code class="typescript"><span class="hl-3">export</span><span class="hl-1"> </span><span class="hl-7">interface</span><span class="hl-1"> </span><span class="hl-13">PartialStatistics</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-5">/** Array of all partial profit/loss events with full details */</span><br/><span class="hl-1">  </span><span class="hl-4">eventList</span><span class="hl-1">: </span><span class="hl-13">PartialEvent</span><span class="hl-1">[];</span><br/><br/><span class="hl-1">  </span><span class="hl-5">/** Total number of all events (profit + loss) */</span><br/><span class="hl-1">  </span><span class="hl-4">totalEvents</span><span class="hl-1">: </span><span class="hl-13">number</span><span class="hl-1">;</span><br/><br/><span class="hl-1">  </span><span class="hl-5">/** Total number of profit milestone events */</span><br/><span class="hl-1">  </span><span class="hl-4">totalProfit</span><span class="hl-1">: </span><span class="hl-13">number</span><span class="hl-1">;</span><br/><br/><span class="hl-1">  </span><span class="hl-5">/** Total number of loss milestone events */</span><br/><span class="hl-1">  </span><span class="hl-4">totalLoss</span><span class="hl-1">: </span><span class="hl-13">number</span><span class="hl-1">;</span><br/><br/><span class="hl-1">  </span><span class="hl-5">/** Profit/loss ratio as percentage (0-100), null if no events */</span><br/><span class="hl-1">  </span><span class="hl-4">profitRatio</span><span class="hl-1">: </span><span class="hl-13">number</span><span class="hl-1"> | </span><span class="hl-13">null</span><span class="hl-1">;</span><br/><br/><span class="hl-1">  </span><span class="hl-5">/** Average profit milestone level (%), null if no profit events */</span><br/><span class="hl-1">  </span><span class="hl-4">avgProfitLevel</span><span class="hl-1">: </span><span class="hl-13">number</span><span class="hl-1"> | </span><span class="hl-13">null</span><span class="hl-1">;</span><br/><br/><span class="hl-1">  </span><span class="hl-5">/** Average loss milestone level (%), null if no loss events */</span><br/><span class="hl-1">  </span><span class="hl-4">avgLossLevel</span><span class="hl-1">: </span><span class="hl-13">number</span><span class="hl-1"> | </span><span class="hl-13">null</span><span class="hl-1">;</span><br/><br/><span class="hl-1">  </span><span class="hl-5">/** Maximum profit level reached (%), null if no profit events */</span><br/><span class="hl-1">  </span><span class="hl-4">maxProfitLevel</span><span class="hl-1">: </span><span class="hl-13">number</span><span class="hl-1"> | </span><span class="hl-13">null</span><span class="hl-1">;</span><br/><br/><span class="hl-1">  </span><span class="hl-5">/** Maximum loss level reached (%), null if no loss events */</span><br/><span class="hl-1">  </span><span class="hl-4">maxLossLevel</span><span class="hl-1">: </span><span class="hl-13">number</span><span class="hl-1"> | </span><span class="hl-13">null</span><span class="hl-1">;</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<a id="calculation-logic-1" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Calculation Logic<a href="#calculation-logic-1" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>The statistics are calculated using safe math operations that protect against <code>NaN</code> and <code>Infinity</code> values:</p>
<pre><code class="typescript"><span class="hl-7">function</span><span class="hl-1"> </span><span class="hl-0">isUnsafe</span><span class="hl-1">(</span><span class="hl-4">value</span><span class="hl-1">: </span><span class="hl-13">number</span><span class="hl-1"> | </span><span class="hl-13">null</span><span class="hl-1">): </span><span class="hl-13">boolean</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-7">typeof</span><span class="hl-1"> </span><span class="hl-4">value</span><span class="hl-1"> !== </span><span class="hl-2">&quot;number&quot;</span><span class="hl-1">) </span><span class="hl-3">return</span><span class="hl-1"> </span><span class="hl-7">true</span><span class="hl-1">;</span><br/><span class="hl-1">  </span><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-0">isNaN</span><span class="hl-1">(</span><span class="hl-4">value</span><span class="hl-1">)) </span><span class="hl-3">return</span><span class="hl-1"> </span><span class="hl-7">true</span><span class="hl-1">;</span><br/><span class="hl-1">  </span><span class="hl-3">if</span><span class="hl-1"> (!</span><span class="hl-0">isFinite</span><span class="hl-1">(</span><span class="hl-4">value</span><span class="hl-1">)) </span><span class="hl-3">return</span><span class="hl-1"> </span><span class="hl-7">true</span><span class="hl-1">;</span><br/><span class="hl-1">  </span><span class="hl-3">return</span><span class="hl-1"> </span><span class="hl-7">false</span><span class="hl-1">;</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<p><strong>All numeric values return <code>null</code> if calculation is unsafe</strong>, ensuring reports never display invalid numbers.</p>
<hr>
<a id="partial-facade-api" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Partial Facade API<a href="#partial-facade-api" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>The <code>Partial</code> facade provides a unified interface for accessing partial profit/loss data and reports, following the same pattern as <code>Backtest</code>, <code>Live</code>, and <code>Schedule</code> facades.</p>
<a id="facade-methods" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Facade Methods<a href="#facade-methods" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><img src="../media/73_Partial_Profit_Loss_Tracking_3.svg" alt="Mermaid Diagram"></p>
<a id="api-reference-1" class="tsd-anchor"></a><h3 class="tsd-anchor-link">API Reference<a href="#api-reference-1" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><a id="partialgetdatasymbol-string-promise" class="tsd-anchor"></a><h4 class="tsd-anchor-link"><code>Partial.getData(symbol: string): Promise&lt;PartialStatistics&gt;</code><a href="#partialgetdatasymbol-string-promise" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><p>Returns statistical data for all partial profit/loss events for the specified symbol.</p>
<p><strong>Parameters:</strong></p>
<ul>
<li><code>symbol</code> - Trading pair symbol (e.g., &quot;BTCUSDT&quot;)</li>
</ul>
<p><strong>Returns:</strong> <code>Promise&lt;PartialStatistics&gt;</code> with metrics and event list</p>
<p><strong>Example:</strong></p>
<pre><code class="typescript"><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">stats</span><span class="hl-1"> = </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-4">Partial</span><span class="hl-1">.</span><span class="hl-0">getData</span><span class="hl-1">(</span><span class="hl-2">&quot;BTCUSDT&quot;</span><span class="hl-1">);</span><br/><br/><span class="hl-4">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-2">`Total events: </span><span class="hl-7">${</span><span class="hl-4">stats</span><span class="hl-9">.</span><span class="hl-4">totalEvents</span><span class="hl-7">}</span><span class="hl-2">`</span><span class="hl-1">);</span><br/><span class="hl-4">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-2">`Profit events: </span><span class="hl-7">${</span><span class="hl-4">stats</span><span class="hl-9">.</span><span class="hl-4">totalProfit</span><span class="hl-7">}</span><span class="hl-2">`</span><span class="hl-1">);</span><br/><span class="hl-4">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-2">`Loss events: </span><span class="hl-7">${</span><span class="hl-4">stats</span><span class="hl-9">.</span><span class="hl-4">totalLoss</span><span class="hl-7">}</span><span class="hl-2">`</span><span class="hl-1">);</span><br/><span class="hl-4">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-2">`Max profit level: </span><span class="hl-7">${</span><span class="hl-4">stats</span><span class="hl-9">.</span><span class="hl-4">maxProfitLevel</span><span class="hl-7">}</span><span class="hl-2">%`</span><span class="hl-1">);</span><br/><br/><span class="hl-5">// Access raw event data</span><br/><span class="hl-4">stats</span><span class="hl-1">.</span><span class="hl-4">eventList</span><span class="hl-1">.</span><span class="hl-0">forEach</span><span class="hl-1">(</span><span class="hl-4">event</span><span class="hl-1"> </span><span class="hl-7">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-4">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-2">`</span><span class="hl-7">${</span><span class="hl-4">event</span><span class="hl-9">.</span><span class="hl-4">action</span><span class="hl-7">}</span><span class="hl-2">: </span><span class="hl-7">${</span><span class="hl-4">event</span><span class="hl-9">.</span><span class="hl-4">levelPercent</span><span class="hl-7">}</span><span class="hl-2">% at $</span><span class="hl-7">${</span><span class="hl-4">event</span><span class="hl-9">.</span><span class="hl-4">currentPrice</span><span class="hl-7">}</span><span class="hl-2">`</span><span class="hl-1">);</span><br/><span class="hl-1">});</span>
</code><button type="button">Copy</button></pre>

<a id="partialgetreportsymbol-string-promise" class="tsd-anchor"></a><h4 class="tsd-anchor-link"><code>Partial.getReport(symbol: string): Promise&lt;string&gt;</code><a href="#partialgetreportsymbol-string-promise" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><p>Generates a markdown report with a table of all partial profit/loss events.</p>
<p><strong>Parameters:</strong></p>
<ul>
<li><code>symbol</code> - Trading pair symbol</li>
</ul>
<p><strong>Returns:</strong> <code>Promise&lt;string&gt;</code> with formatted markdown report</p>
<p><strong>Example:</strong></p>
<pre><code class="typescript"><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">markdown</span><span class="hl-1"> = </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-4">Partial</span><span class="hl-1">.</span><span class="hl-0">getReport</span><span class="hl-1">(</span><span class="hl-2">&quot;BTCUSDT&quot;</span><span class="hl-1">);</span><br/><span class="hl-4">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-4">markdown</span><span class="hl-1">);</span><br/><br/><span class="hl-5">// Output:</span><br/><span class="hl-5">// # Partial Profit/Loss Report: BTCUSDT</span><br/><span class="hl-5">//</span><br/><span class="hl-5">// | Timestamp | Action | Symbol | Level % | Current Price | ...</span><br/><span class="hl-5">// | --- | --- | --- | --- | --- | ...</span><br/><span class="hl-5">// | 2024-01-01T00:05:00Z | PROFIT | BTCUSDT | 10% | 96000.00 USD | ...</span>
</code><button type="button">Copy</button></pre>

<a id="partialdumpsymbol-string-path-string-promise" class="tsd-anchor"></a><h4 class="tsd-anchor-link"><code>Partial.dump(symbol: string, path?: string): Promise&lt;void&gt;</code><a href="#partialdumpsymbol-string-path-string-promise" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><p>Saves the markdown report to disk. Creates the directory if it doesn't exist.</p>
<p><strong>Parameters:</strong></p>
<ul>
<li><code>symbol</code> - Trading pair symbol</li>
<li><code>path</code> - Optional directory path (default: <code>&quot;./dump/partial&quot;</code>)</li>
</ul>
<p><strong>Example:</strong></p>
<pre><code class="typescript"><span class="hl-5">// Save to default path: ./dump/partial/BTCUSDT.md</span><br/><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-4">Partial</span><span class="hl-1">.</span><span class="hl-0">dump</span><span class="hl-1">(</span><span class="hl-2">&quot;BTCUSDT&quot;</span><span class="hl-1">);</span><br/><br/><span class="hl-5">// Save to custom path: ./reports/partial/BTCUSDT.md</span><br/><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-4">Partial</span><span class="hl-1">.</span><span class="hl-0">dump</span><span class="hl-1">(</span><span class="hl-2">&quot;BTCUSDT&quot;</span><span class="hl-1">, </span><span class="hl-2">&quot;./reports/partial&quot;</span><span class="hl-1">);</span>
</code><button type="button">Copy</button></pre>

<hr>
<a id="markdown-report-format" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Markdown Report Format<a href="#markdown-report-format" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>The Partial report follows a consistent table format with detailed event information and summary statistics.</p>
<a id="report-structure" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Report Structure<a href="#report-structure" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><pre><code class="markdown"># Partial Profit/Loss Report: BTCUSDT

| Timestamp | Action | Symbol | Signal ID | Level % | Current Price | Revenue % | Mode |
| --- | --- | --- | --- | --- | --- | --- | --- |
| 2024-01-01T00:05:00Z | PROFIT | BTCUSDT | sig-001 | 10% | 96000.00 USD | +10.21% | BACKTEST |
| 2024-01-01T00:08:00Z | PROFIT | BTCUSDT | sig-001 | 20% | 97000.00 USD | +20.15% | BACKTEST |
| 2024-01-01T00:12:00Z | PROFIT | BTCUSDT | sig-001 | 30% | 98000.00 USD | +30.42% | BACKTEST |

**Total events:** 3
**Profit events:** 3
**Loss events:** 0
**Profit ratio:** 100.00% (higher is better)
**Average profit level:** 20.00%
**Maximum profit level:** 30.00%
</code><button type="button">Copy</button></pre>

<a id="column-definitions" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Column Definitions<a href="#column-definitions" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><table>
<thead>
<tr>
<th>Column</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>Timestamp</td>
<td>ISO 8601 timestamp of milestone detection</td>
</tr>
<tr>
<td>Action</td>
<td>&quot;PROFIT&quot; or &quot;LOSS&quot;</td>
</tr>
<tr>
<td>Symbol</td>
<td>Trading pair symbol</td>
</tr>
<tr>
<td>Signal ID</td>
<td>Unique signal identifier</td>
</tr>
<tr>
<td>Level %</td>
<td>Milestone percentage level (10%, 20%, etc.)</td>
</tr>
<tr>
<td>Current Price</td>
<td>Market price when milestone reached</td>
</tr>
<tr>
<td>Revenue %</td>
<td>Unrealized PnL percentage</td>
</tr>
<tr>
<td>Mode</td>
<td>&quot;BACKTEST&quot; or &quot;LIVE&quot;</td>
</tr>
</tbody>
</table>
<hr>
<a id="integration-with-position-scaling" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Integration with Position Scaling<a href="#integration-with-position-scaling" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>Partial profit/loss tracking enables dynamic position management strategies based on unrealized performance.</p>
<a id="position-scaling-flow" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Position Scaling Flow<a href="#position-scaling-flow" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><img src="../media/73_Partial_Profit_Loss_Tracking_4.svg" alt="Mermaid Diagram"></p>
<a id="example-tiered-exit-strategy" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Example: Tiered Exit Strategy<a href="#example-tiered-exit-strategy" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><pre><code class="typescript"><span class="hl-0">addStrategy</span><span class="hl-1">({</span><br/><span class="hl-1">  </span><span class="hl-4">strategyName:</span><span class="hl-1"> </span><span class="hl-2">&quot;tiered-exit&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">interval:</span><span class="hl-1"> </span><span class="hl-2">&quot;15m&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-0">getSignal</span><span class="hl-4">:</span><span class="hl-1"> </span><span class="hl-7">async</span><span class="hl-1"> (</span><span class="hl-4">symbol</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-5">// Signal generation logic</span><br/><span class="hl-1">  },</span><br/><span class="hl-1">  </span><span class="hl-4">callbacks:</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-0">onPartialProfit</span><span class="hl-4">:</span><span class="hl-1"> (</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">signal</span><span class="hl-1">, </span><span class="hl-4">currentPrice</span><span class="hl-1">, </span><span class="hl-4">revenuePercent</span><span class="hl-1">, </span><span class="hl-4">backtest</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">      </span><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-4">revenuePercent</span><span class="hl-1"> &gt;= </span><span class="hl-6">10</span><span class="hl-1"> &amp;&amp; </span><span class="hl-4">revenuePercent</span><span class="hl-1"> &lt; </span><span class="hl-6">20</span><span class="hl-1">) {</span><br/><span class="hl-1">        </span><span class="hl-5">// First tier: scale out 25% at +10%</span><br/><span class="hl-1">        </span><span class="hl-4">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-2">`[</span><span class="hl-7">${</span><span class="hl-4">symbol</span><span class="hl-7">}</span><span class="hl-2">] Scale out 25% at </span><span class="hl-7">${</span><span class="hl-4">revenuePercent</span><span class="hl-9">.</span><span class="hl-0">toFixed</span><span class="hl-9">(</span><span class="hl-6">2</span><span class="hl-9">)</span><span class="hl-7">}</span><span class="hl-2">%`</span><span class="hl-1">);</span><br/><span class="hl-1">      } </span><span class="hl-3">else</span><span class="hl-1"> </span><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-4">revenuePercent</span><span class="hl-1"> &gt;= </span><span class="hl-6">20</span><span class="hl-1"> &amp;&amp; </span><span class="hl-4">revenuePercent</span><span class="hl-1"> &lt; </span><span class="hl-6">30</span><span class="hl-1">) {</span><br/><span class="hl-1">        </span><span class="hl-5">// Second tier: scale out 25% at +20%</span><br/><span class="hl-1">        </span><span class="hl-4">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-2">`[</span><span class="hl-7">${</span><span class="hl-4">symbol</span><span class="hl-7">}</span><span class="hl-2">] Scale out 25% at </span><span class="hl-7">${</span><span class="hl-4">revenuePercent</span><span class="hl-9">.</span><span class="hl-0">toFixed</span><span class="hl-9">(</span><span class="hl-6">2</span><span class="hl-9">)</span><span class="hl-7">}</span><span class="hl-2">%`</span><span class="hl-1">);</span><br/><span class="hl-1">      } </span><span class="hl-3">else</span><span class="hl-1"> </span><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-4">revenuePercent</span><span class="hl-1"> &gt;= </span><span class="hl-6">30</span><span class="hl-1"> &amp;&amp; </span><span class="hl-4">revenuePercent</span><span class="hl-1"> &lt; </span><span class="hl-6">50</span><span class="hl-1">) {</span><br/><span class="hl-1">        </span><span class="hl-5">// Third tier: move stop loss to breakeven at +30%</span><br/><span class="hl-1">        </span><span class="hl-4">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-2">`[</span><span class="hl-7">${</span><span class="hl-4">symbol</span><span class="hl-7">}</span><span class="hl-2">] Move SL to breakeven at </span><span class="hl-7">${</span><span class="hl-4">revenuePercent</span><span class="hl-9">.</span><span class="hl-0">toFixed</span><span class="hl-9">(</span><span class="hl-6">2</span><span class="hl-9">)</span><span class="hl-7">}</span><span class="hl-2">%`</span><span class="hl-1">);</span><br/><span class="hl-1">      } </span><span class="hl-3">else</span><span class="hl-1"> </span><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-4">revenuePercent</span><span class="hl-1"> &gt;= </span><span class="hl-6">50</span><span class="hl-1">) {</span><br/><span class="hl-1">        </span><span class="hl-5">// Final tier: exit remaining 50% at +50%</span><br/><span class="hl-1">        </span><span class="hl-4">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-2">`[</span><span class="hl-7">${</span><span class="hl-4">symbol</span><span class="hl-7">}</span><span class="hl-2">] Exit remaining position at </span><span class="hl-7">${</span><span class="hl-4">revenuePercent</span><span class="hl-9">.</span><span class="hl-0">toFixed</span><span class="hl-9">(</span><span class="hl-6">2</span><span class="hl-9">)</span><span class="hl-7">}</span><span class="hl-2">%`</span><span class="hl-1">);</span><br/><span class="hl-1">      }</span><br/><span class="hl-1">    },</span><br/><span class="hl-1">    </span><br/><span class="hl-1">    </span><span class="hl-0">onPartialLoss</span><span class="hl-4">:</span><span class="hl-1"> (</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">signal</span><span class="hl-1">, </span><span class="hl-4">currentPrice</span><span class="hl-1">, </span><span class="hl-4">revenuePercent</span><span class="hl-1">, </span><span class="hl-4">backtest</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">      </span><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-4">revenuePercent</span><span class="hl-1"> &lt;= -</span><span class="hl-6">20</span><span class="hl-1">) {</span><br/><span class="hl-1">        </span><span class="hl-5">// Tighten stop loss if unrealized loss exceeds -20%</span><br/><span class="hl-1">        </span><span class="hl-4">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-2">`[</span><span class="hl-7">${</span><span class="hl-4">symbol</span><span class="hl-7">}</span><span class="hl-2">] Warning: approaching stop loss at </span><span class="hl-7">${</span><span class="hl-4">revenuePercent</span><span class="hl-9">.</span><span class="hl-0">toFixed</span><span class="hl-9">(</span><span class="hl-6">2</span><span class="hl-9">)</span><span class="hl-7">}</span><span class="hl-2">%`</span><span class="hl-1">);</span><br/><span class="hl-1">      }</span><br/><span class="hl-1">    },</span><br/><span class="hl-1">  },</span><br/><span class="hl-1">});</span>
</code><button type="button">Copy</button></pre>

<hr>
<a id="persistence-and-crash-recovery" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Persistence and Crash Recovery<a href="#persistence-and-crash-recovery" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>In <strong>live mode</strong>, partial profit/loss events are persisted to disk through <code>PersistPartialAdapter</code> to enable crash recovery and historical analysis.</p>
<a id="persistence-architecture" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Persistence Architecture<a href="#persistence-architecture" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><img src="../media/73_Partial_Profit_Loss_Tracking_5.svg" alt="Mermaid Diagram"></p>
<a id="persistence-behavior" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Persistence Behavior<a href="#persistence-behavior" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><strong>Backtest mode:</strong></p>
<ul>
<li>Events are <strong>not persisted</strong> to disk</li>
<li>All data kept in memory via <code>PartialMarkdownService</code></li>
<li>Cleared after backtest completion</li>
</ul>
<p><strong>Live mode:</strong></p>
<ul>
<li>Events are <strong>atomically written</strong> to disk on each milestone</li>
<li>Files stored in <code>./logs/data/partial/{symbol}/{event-id}.json</code></li>
<li>Enables crash recovery and historical analysis</li>
<li>Custom adapters supported (Redis, MongoDB, PostgreSQL)</li>
</ul>
<hr>
<a id="use-cases" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Use Cases<a href="#use-cases" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>The Partial system serves multiple use cases in trading strategy development and risk management.</p>
<a id="1-position-scaling-strategies" class="tsd-anchor"></a><h3 class="tsd-anchor-link">1. Position Scaling Strategies<a href="#1-position-scaling-strategies" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><strong>Scenario:</strong> Scale out of profitable positions gradually to lock in gains while maintaining upside exposure.</p>
<pre><code class="typescript"><span class="hl-10">callbacks</span><span class="hl-1">: {</span><br/><span class="hl-1">  </span><span class="hl-10">onPartialProfit</span><span class="hl-1">: (</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">signal</span><span class="hl-1">, </span><span class="hl-4">currentPrice</span><span class="hl-1">, </span><span class="hl-4">revenuePercent</span><span class="hl-1">, </span><span class="hl-4">backtest</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-4">revenuePercent</span><span class="hl-1"> &gt;= </span><span class="hl-6">15</span><span class="hl-1">) {</span><br/><span class="hl-1">      </span><span class="hl-5">// Exit 33% at +15%</span><br/><span class="hl-1">      </span><span class="hl-0">closePartialPosition</span><span class="hl-1">(</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-6">0.33</span><span class="hl-1">);</span><br/><span class="hl-1">    }</span><br/><span class="hl-1">    </span><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-4">revenuePercent</span><span class="hl-1"> &gt;= </span><span class="hl-6">30</span><span class="hl-1">) {</span><br/><span class="hl-1">      </span><span class="hl-5">// Exit 33% at +30%</span><br/><span class="hl-1">      </span><span class="hl-0">closePartialPosition</span><span class="hl-1">(</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-6">0.33</span><span class="hl-1">);</span><br/><span class="hl-1">    }</span><br/><span class="hl-1">    </span><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-4">revenuePercent</span><span class="hl-1"> &gt;= </span><span class="hl-6">50</span><span class="hl-1">) {</span><br/><span class="hl-1">      </span><span class="hl-5">// Exit final 34% at +50%</span><br/><span class="hl-1">      </span><span class="hl-0">closePartialPosition</span><span class="hl-1">(</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-6">0.34</span><span class="hl-1">);</span><br/><span class="hl-1">    }</span><br/><span class="hl-1">  },</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<a id="2-dynamic-stop-loss-management" class="tsd-anchor"></a><h3 class="tsd-anchor-link">2. Dynamic Stop Loss Management<a href="#2-dynamic-stop-loss-management" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><strong>Scenario:</strong> Tighten stop loss as profit increases to protect gains.</p>
<pre><code class="typescript"><span class="hl-10">callbacks</span><span class="hl-1">: {</span><br/><span class="hl-1">  </span><span class="hl-10">onPartialProfit</span><span class="hl-1">: (</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">signal</span><span class="hl-1">, </span><span class="hl-4">currentPrice</span><span class="hl-1">, </span><span class="hl-4">revenuePercent</span><span class="hl-1">, </span><span class="hl-4">backtest</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-4">revenuePercent</span><span class="hl-1"> &gt;= </span><span class="hl-6">10</span><span class="hl-1">) {</span><br/><span class="hl-1">      </span><span class="hl-5">// Move stop loss to breakeven at +10%</span><br/><span class="hl-1">      </span><span class="hl-0">updateStopLoss</span><span class="hl-1">(</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">signal</span><span class="hl-1">.</span><span class="hl-4">priceOpen</span><span class="hl-1">);</span><br/><span class="hl-1">    }</span><br/><span class="hl-1">    </span><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-4">revenuePercent</span><span class="hl-1"> &gt;= </span><span class="hl-6">20</span><span class="hl-1">) {</span><br/><span class="hl-1">      </span><span class="hl-5">// Move stop loss to +10% at +20% profit</span><br/><span class="hl-1">      </span><span class="hl-0">updateStopLoss</span><span class="hl-1">(</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">signal</span><span class="hl-1">.</span><span class="hl-4">priceOpen</span><span class="hl-1"> * </span><span class="hl-6">1.10</span><span class="hl-1">);</span><br/><span class="hl-1">    }</span><br/><span class="hl-1">    </span><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-4">revenuePercent</span><span class="hl-1"> &gt;= </span><span class="hl-6">30</span><span class="hl-1">) {</span><br/><span class="hl-1">      </span><span class="hl-5">// Move stop loss to +20% at +30% profit</span><br/><span class="hl-1">      </span><span class="hl-0">updateStopLoss</span><span class="hl-1">(</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">signal</span><span class="hl-1">.</span><span class="hl-4">priceOpen</span><span class="hl-1"> * </span><span class="hl-6">1.20</span><span class="hl-1">);</span><br/><span class="hl-1">    }</span><br/><span class="hl-1">  },</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<a id="3-risk-monitoring-and-alerts" class="tsd-anchor"></a><h3 class="tsd-anchor-link">3. Risk Monitoring and Alerts<a href="#3-risk-monitoring-and-alerts" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><strong>Scenario:</strong> Monitor drawdown and trigger alerts when approaching maximum acceptable loss.</p>
<pre><code class="typescript"><span class="hl-10">callbacks</span><span class="hl-1">: {</span><br/><span class="hl-1">  </span><span class="hl-10">onPartialLoss</span><span class="hl-1">: (</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">signal</span><span class="hl-1">, </span><span class="hl-4">currentPrice</span><span class="hl-1">, </span><span class="hl-4">revenuePercent</span><span class="hl-1">, </span><span class="hl-4">backtest</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-4">revenuePercent</span><span class="hl-1"> &lt;= -</span><span class="hl-6">10</span><span class="hl-1">) {</span><br/><span class="hl-1">      </span><span class="hl-0">sendAlert</span><span class="hl-1">(</span><span class="hl-2">`Warning: </span><span class="hl-7">${</span><span class="hl-4">symbol</span><span class="hl-7">}</span><span class="hl-2"> at -10% unrealized loss`</span><span class="hl-1">);</span><br/><span class="hl-1">    }</span><br/><span class="hl-1">    </span><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-4">revenuePercent</span><span class="hl-1"> &lt;= -</span><span class="hl-6">15</span><span class="hl-1">) {</span><br/><span class="hl-1">      </span><span class="hl-0">sendAlert</span><span class="hl-1">(</span><span class="hl-2">`CRITICAL: </span><span class="hl-7">${</span><span class="hl-4">symbol</span><span class="hl-7">}</span><span class="hl-2"> approaching stop loss at -15%`</span><span class="hl-1">);</span><br/><span class="hl-1">    }</span><br/><span class="hl-1">  },</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<a id="4-performance-analysis" class="tsd-anchor"></a><h3 class="tsd-anchor-link">4. Performance Analysis<a href="#4-performance-analysis" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><strong>Scenario:</strong> Analyze how often positions reach specific profit/loss milestones for strategy optimization.</p>
<pre><code class="typescript"><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">stats</span><span class="hl-1"> = </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-4">Partial</span><span class="hl-1">.</span><span class="hl-0">getData</span><span class="hl-1">(</span><span class="hl-2">&quot;BTCUSDT&quot;</span><span class="hl-1">);</span><br/><br/><span class="hl-4">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-2">`Profit rate: </span><span class="hl-7">${</span><span class="hl-4">stats</span><span class="hl-9">.</span><span class="hl-4">profitRatio</span><span class="hl-7">}</span><span class="hl-2">%`</span><span class="hl-1">);</span><br/><span class="hl-4">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-2">`Average profit milestone: </span><span class="hl-7">${</span><span class="hl-4">stats</span><span class="hl-9">.</span><span class="hl-4">avgProfitLevel</span><span class="hl-7">}</span><span class="hl-2">%`</span><span class="hl-1">);</span><br/><span class="hl-4">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-2">`Maximum profit reached: </span><span class="hl-7">${</span><span class="hl-4">stats</span><span class="hl-9">.</span><span class="hl-4">maxProfitLevel</span><span class="hl-7">}</span><span class="hl-2">%`</span><span class="hl-1">);</span><br/><br/><span class="hl-5">// Optimize take profit targets based on historical milestone data</span><br/><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-4">stats</span><span class="hl-1">.</span><span class="hl-4">avgProfitLevel</span><span class="hl-1"> &lt; </span><span class="hl-6">20</span><span class="hl-1">) {</span><br/><span class="hl-1">  </span><span class="hl-4">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-2">&quot;Strategy rarely reaches +20% - consider lowering TP target&quot;</span><span class="hl-1">);</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<hr>
<a id="long-vs-short-position-behavior" class="tsd-anchor"></a><h2 class="tsd-anchor-link">LONG vs SHORT Position Behavior<a href="#long-vs-short-position-behavior" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>Partial profit/loss tracking behaves differently for LONG and SHORT positions due to inverted profit mechanics.</p>
<a id="long-position-profit-on-price-rise" class="tsd-anchor"></a><h3 class="tsd-anchor-link">LONG Position (Profit on Price Rise)<a href="#long-position-profit-on-price-rise" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><img src="../media/73_Partial_Profit_Loss_Tracking_6.svg" alt="Mermaid Diagram"></p>
<p><strong>Profit triggers:</strong> When <code>currentPrice &gt; priceOpen</code>
<strong>Loss triggers:</strong> When <code>currentPrice &lt; priceOpen</code></p>
<a id="short-position-profit-on-price-fall" class="tsd-anchor"></a><h3 class="tsd-anchor-link">SHORT Position (Profit on Price Fall)<a href="#short-position-profit-on-price-fall" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><img src="../media/73_Partial_Profit_Loss_Tracking_7.svg" alt="Mermaid Diagram"></p>
<p><strong>Profit triggers:</strong> When <code>currentPrice &lt; priceOpen</code>
<strong>Loss triggers:</strong> When <code>currentPrice &gt; priceOpen</code></p>
<a id="comparison-table" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Comparison Table<a href="#comparison-table" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><table>
<thead>
<tr>
<th>Aspect</th>
<th>LONG Position</th>
<th>SHORT Position</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Profit Condition</strong></td>
<td>Price rises above <code>priceOpen</code></td>
<td>Price falls below <code>priceOpen</code></td>
</tr>
<tr>
<td><strong>Loss Condition</strong></td>
<td>Price falls below <code>priceOpen</code></td>
<td>Price rises above <code>priceOpen</code></td>
</tr>
<tr>
<td><strong>10% Profit Price</strong></td>
<td><code>priceOpen × 1.10</code></td>
<td><code>priceOpen × 0.90</code></td>
</tr>
<tr>
<td><strong>10% Loss Price</strong></td>
<td><code>priceOpen × 0.90</code></td>
<td><code>priceOpen × 1.10</code></td>
</tr>
<tr>
<td><strong>PnL Calculation</strong></td>
<td><code>(current - open) / open × 100</code></td>
<td><code>(open - current) / open × 100</code></td>
</tr>
</tbody>
</table>
<hr>
<a id="milestone-detection-algorithm" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Milestone Detection Algorithm<a href="#milestone-detection-algorithm" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>The milestone detection algorithm ensures each level is triggered <strong>exactly once</strong> per signal, preventing duplicate callbacks.</p>
<a id="detection-logic" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Detection Logic<a href="#detection-logic" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><img src="../media/73_Partial_Profit_Loss_Tracking_8.svg" alt="Mermaid Diagram"></p>
<a id="milestone-tracking-state" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Milestone Tracking State<a href="#milestone-tracking-state" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Each active signal maintains a <code>lastMilestoneLevel</code> field to prevent duplicate emissions:</p>
<pre><code class="typescript"><span class="hl-7">interface</span><span class="hl-1"> </span><span class="hl-13">SignalMilestoneState</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-4">signalId</span><span class="hl-1">: </span><span class="hl-13">string</span><span class="hl-1">;</span><br/><span class="hl-1">  </span><span class="hl-4">lastMilestoneLevel</span><span class="hl-1">: </span><span class="hl-13">number</span><span class="hl-1">; </span><span class="hl-5">// Last emitted milestone (0, 10, 20, 30, ...)</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<p><strong>Example progression:</strong></p>
<ol>
<li>Signal opened at $100,000 → <code>lastMilestoneLevel = 0</code></li>
<li>Price reaches $110,000 → Emit 10% profit → <code>lastMilestoneLevel = 10</code></li>
<li>Price reaches $115,000 → No emission (still in 10-20% range)</li>
<li>Price reaches $120,000 → Emit 20% profit → <code>lastMilestoneLevel = 20</code></li>
<li>Price reaches $125,000 → No emission (still in 20-30% range)</li>
</ol>
<hr>
<a id="testing-and-validation" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Testing and Validation<a href="#testing-and-validation" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>The Partial system includes comprehensive test coverage for both LONG and SHORT positions in backtest mode.</p>
<a id="test-coverage" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Test Coverage<a href="#test-coverage" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><table>
<thead>
<tr>
<th>Test</th>
<th>File</th>
<th>Lines</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td>LONG Profit</td>
<td>partial.test.mjs</td>
<td>17-151</td>
<td>Validates profit milestones for LONG with gradual price rise</td>
</tr>
<tr>
<td>LONG Loss</td>
<td>partial.test.mjs</td>
<td>154-297</td>
<td>Validates loss milestones for LONG with gradual price fall</td>
</tr>
<tr>
<td>SHORT Profit</td>
<td>partial.test.mjs</td>
<td>300-424</td>
<td>Validates profit milestones for SHORT with gradual price fall</td>
</tr>
<tr>
<td>SHORT Loss</td>
<td>partial.test.mjs</td>
<td>427-558</td>
<td>Validates loss milestones for SHORT with gradual price rise</td>
</tr>
<tr>
<td>Facade getData</td>
<td>partial.test.mjs</td>
<td>561-676</td>
<td>Tests Partial.getData() returns valid statistics</td>
</tr>
<tr>
<td>Facade getReport</td>
<td>partial.test.mjs</td>
<td>679-795</td>
<td>Tests Partial.getReport() generates markdown</td>
</tr>
<tr>
<td>Empty Symbol</td>
<td>partial.test.mjs</td>
<td>801-818</td>
<td>Tests empty statistics for nonexistent symbol</td>
</tr>
</tbody>
</table>
<a id="test-validation-criteria" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Test Validation Criteria<a href="#test-validation-criteria" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>All tests verify:</p>
<ul>
<li><strong>Callback invocation</strong>: <code>onPartialProfit</code> / <code>onPartialLoss</code> called correctly</li>
<li><strong>Event count</strong>: Minimum expected events emitted (≥5 for gradual movements)</li>
<li><strong>Sign correctness</strong>: Profit events have positive <code>revenuePercent</code>, loss events have negative</li>
<li><strong>Monotonicity</strong>: Revenue percentages increase monotonically for profit/loss sequences</li>
<li><strong>Backtest flag</strong>: All events have <code>backtest=true</code> in backtest mode</li>
<li><strong>Mutual exclusivity</strong>: Profit and loss callbacks never both called for same signal</li>
</ul>
</div></div><div class="col-sidebar"><div class="page-menu"><div class="tsd-navigation settings"><details class="tsd-accordion"><summary class="tsd-accordion-summary"><h3><svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-chevronDown"></use></svg>Settings</h3></summary><div class="tsd-accordion-details"><div class="tsd-filter-visibility"><span class="settings-label">Member Visibility</span><ul id="tsd-filter-options"><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-protected" name="protected"/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Protected</span></label></li><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-inherited" name="inherited" checked/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Inherited</span></label></li><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-external" name="external"/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>External</span></label></li></ul></div><div class="tsd-theme-toggle"><label class="settings-label" for="tsd-theme">Theme</label><select id="tsd-theme"><option value="os">OS</option><option value="light">Light</option><option value="dark">Dark</option></select></div></div></details></div><details open class="tsd-accordion tsd-page-navigation"><summary class="tsd-accordion-summary"><h3><svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-chevronDown"></use></svg>On This Page</h3></summary><div class="tsd-accordion-details"><a href="#partial-profitloss-tracking"><span>Partial <wbr/>Profit/<wbr/>Loss <wbr/>Tracking</span></a><ul><li><a href="#purpose-and-scope"><span>Purpose and <wbr/>Scope</span></a></li><li><a href="#system-architecture"><span>System <wbr/>Architecture</span></a></li><li><a href="#milestone-levels"><span>Milestone <wbr/>Levels</span></a></li><li><ul><li><a href="#standard-milestone-levels"><span>Standard <wbr/>Milestone <wbr/>Levels</span></a></li><li><a href="#calculation-logic"><span>Calculation <wbr/>Logic</span></a></li></ul></li><li><a href="#callback-integration"><span>Callback <wbr/>Integration</span></a></li><li><ul><li><a href="#callback-signatures"><span>Callback <wbr/>Signatures</span></a></li><li><a href="#usage-example"><span>Usage <wbr/>Example</span></a></li></ul></li><li><a href="#event-listener-api"><span>Event <wbr/>Listener API</span></a></li><li><ul><li><a href="#listener-functions"><span>Listener <wbr/>Functions</span></a></li><li><a href="#api-reference"><span>API <wbr/>Reference</span></a></li><li><a href="#event-structure"><span>Event <wbr/>Structure</span></a></li><li><a href="#usage-example-1"><span>Usage <wbr/>Example</span></a></li></ul></li><li><a href="#partialmarkdownservice"><span>Partial<wbr/>Markdown<wbr/>Service</span></a></li><li><ul><li><a href="#service-architecture"><span>Service <wbr/>Architecture</span></a></li><li><a href="#storage-behavior"><span>Storage <wbr/>Behavior</span></a></li></ul></li><li><a href="#partial-statistics"><span>Partial <wbr/>Statistics</span></a></li><li><ul><li><a href="#statistics-interface"><span>Statistics <wbr/>Interface</span></a></li><li><a href="#calculation-logic-1"><span>Calculation <wbr/>Logic</span></a></li></ul></li><li><a href="#partial-facade-api"><span>Partial <wbr/>Facade API</span></a></li><li><ul><li><a href="#facade-methods"><span>Facade <wbr/>Methods</span></a></li><li><a href="#api-reference-1"><span>API <wbr/>Reference</span></a></li><li><ul><li><a href="#partialgetdatasymbol-string-promise"><span>Partial.get<wbr/>Data(symbol: string): <wbr/>Promise&lt;<wbr/>Partial<wbr/>Statistics&gt;</span></a></li><li><a href="#partialgetreportsymbol-string-promise"><span>Partial.get<wbr/>Report(symbol: string): <wbr/>Promise&lt;string&gt;</span></a></li><li><a href="#partialdumpsymbol-string-path-string-promise"><span>Partial.dump(symbol: string, path?: string): <wbr/>Promise&lt;void&gt;</span></a></li></ul></li></ul></li><li><a href="#markdown-report-format"><span>Markdown <wbr/>Report <wbr/>Format</span></a></li><li><ul><li><a href="#report-structure"><span>Report <wbr/>Structure</span></a></li><li><a href="#column-definitions"><span>Column <wbr/>Definitions</span></a></li></ul></li><li><a href="#integration-with-position-scaling"><span>Integration with <wbr/>Position <wbr/>Scaling</span></a></li><li><ul><li><a href="#position-scaling-flow"><span>Position <wbr/>Scaling <wbr/>Flow</span></a></li><li><a href="#example-tiered-exit-strategy"><span>Example: <wbr/>Tiered <wbr/>Exit <wbr/>Strategy</span></a></li></ul></li><li><a href="#persistence-and-crash-recovery"><span>Persistence and <wbr/>Crash <wbr/>Recovery</span></a></li><li><ul><li><a href="#persistence-architecture"><span>Persistence <wbr/>Architecture</span></a></li><li><a href="#persistence-behavior"><span>Persistence <wbr/>Behavior</span></a></li></ul></li><li><a href="#use-cases"><span>Use <wbr/>Cases</span></a></li><li><ul><li><a href="#1-position-scaling-strategies"><span>1. <wbr/>Position <wbr/>Scaling <wbr/>Strategies</span></a></li><li><a href="#2-dynamic-stop-loss-management"><span>2. <wbr/>Dynamic <wbr/>Stop <wbr/>Loss <wbr/>Management</span></a></li><li><a href="#3-risk-monitoring-and-alerts"><span>3. <wbr/>Risk <wbr/>Monitoring and <wbr/>Alerts</span></a></li><li><a href="#4-performance-analysis"><span>4. <wbr/>Performance <wbr/>Analysis</span></a></li></ul></li><li><a href="#long-vs-short-position-behavior"><span>LONG vs SHORT <wbr/>Position <wbr/>Behavior</span></a></li><li><ul><li><a href="#long-position-profit-on-price-rise"><span>LONG <wbr/>Position (<wbr/>Profit on <wbr/>Price <wbr/>Rise)</span></a></li><li><a href="#short-position-profit-on-price-fall"><span>SHORT <wbr/>Position (<wbr/>Profit on <wbr/>Price <wbr/>Fall)</span></a></li><li><a href="#comparison-table"><span>Comparison <wbr/>Table</span></a></li></ul></li><li><a href="#milestone-detection-algorithm"><span>Milestone <wbr/>Detection <wbr/>Algorithm</span></a></li><li><ul><li><a href="#detection-logic"><span>Detection <wbr/>Logic</span></a></li><li><a href="#milestone-tracking-state"><span>Milestone <wbr/>Tracking <wbr/>State</span></a></li></ul></li><li><a href="#testing-and-validation"><span>Testing and <wbr/>Validation</span></a></li><li><ul><li><a href="#test-coverage"><span>Test <wbr/>Coverage</span></a></li><li><a href="#test-validation-criteria"><span>Test <wbr/>Validation <wbr/>Criteria</span></a></li></ul></li></ul></div></details></div><div class="site-menu"><nav class="tsd-navigation"><a href="../modules.html">backtest-kit</a><ul class="tsd-small-nested-navigation" id="tsd-nav-container"><li>Loading...</li></ul></nav></div></div></div><footer><p class="tsd-generator">Generated using <a href="https://typedoc.org/" target="_blank">TypeDoc</a></p></footer><div class="overlay"></div></body></html>

<!-- Yandex.Metrika counter -->
<script type="text/javascript">
    (function(m,e,t,r,i,k,a){
        m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
        m[i].l=1*new Date();
        for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }}
        k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)
    })(window, document,'script','https://mc.yandex.ru/metrika/tag.js?id=105455585', 'ym');

    ym(105455585, 'init', {ssr:true, webvisor:true, clickmap:true, ecommerce:"dataLayer", accurateTrackBounce:true, trackLinks:true});
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/105455585" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
<!-- /Yandex.Metrika counter -->

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-3MQZEBBDDR"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-3MQZEBBDDR');
</script>
