<!DOCTYPE html><html class="default" lang="en" data-base=".."><head><meta charset="utf-8"/><meta http-equiv="x-ua-compatible" content="IE=edge"/><title>design/07_signal_lifecycle_overview | backtest-kit</title><meta name="description" content="Documentation for backtest-kit"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="stylesheet" href="../assets/style.css"/><link rel="stylesheet" href="../assets/highlight.css"/><script defer src="../assets/main.js"></script><script async src="../assets/icons.js" id="tsd-icons-script"></script><script async src="../assets/search.js" id="tsd-search-script"></script><script async src="../assets/navigation.js" id="tsd-nav-script"></script><script async src="../assets/hierarchy.js" id="tsd-hierarchy-script"></script></head><body><script>document.documentElement.dataset.theme = localStorage.getItem("tsd-theme") || "os";document.body.style.display="none";setTimeout(() => app?app.showPage():document.body.style.removeProperty("display"),500)</script><header class="tsd-page-toolbar"><div class="tsd-toolbar-contents container"><div class="table-cell" id="tsd-search"><div class="field"><label for="tsd-search-field" class="tsd-widget tsd-toolbar-icon search no-caption"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-search"></use></svg></label><input type="text" id="tsd-search-field" aria-label="Search"/></div><div class="field"><div id="tsd-toolbar-links"></div></div><ul class="results"><li class="state loading">Preparing search index...</li><li class="state failure">The search index is not available</li></ul><a href="../index.html" class="title">backtest-kit</a></div><div class="table-cell" id="tsd-widgets"><a href="#" class="tsd-widget tsd-toolbar-icon menu no-caption" data-toggle="menu" aria-label="Menu"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-menu"></use></svg></a></div></div></header><div class="container container-main"><div class="col-content"><div class="tsd-page-title"><ul class="tsd-breadcrumb"><li><a href="../modules.html">backtest-kit</a></li><li><a href="design_07_signal_lifecycle_overview.html">design/07_signal_lifecycle_overview</a></li></ul></div><div class="tsd-panel tsd-typography"><a id="signal-lifecycle-overview" class="tsd-anchor"></a><h1 class="tsd-anchor-link">Signal Lifecycle Overview<a href="#signal-lifecycle-overview" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h1><a id="purpose-and-scope" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Purpose and Scope<a href="#purpose-and-scope" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>This page describes the signal state machine and lifecycle management in the backtest-kit framework. A signal represents a single trading position from creation through closure, transitioning through well-defined states. This document covers signal generation, validation, state transitions, persistence, and closure conditions.</p>
<p>For information about how signals are executed in different modes (backtest vs live), see <a href="design_06_execution_modes.html">Execution Modes</a>. For details on component registration and schema definitions, see <a href="design_08_component_registration.html">Component Registration</a>. For deep implementation details of the <code>ClientStrategy</code> class that manages signals, see <a href="design_31_clientstrategy.html">ClientStrategy</a>.</p>
<hr>
<a id="signal-state-machine" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Signal State Machine<a href="#signal-state-machine" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>The signal lifecycle is modeled as a finite state machine with six distinct states. Signals transition between states based on market conditions, time constraints, and risk parameters.</p>
<a id="state-transition-diagram" class="tsd-anchor"></a><h3 class="tsd-anchor-link">State Transition Diagram<a href="#state-transition-diagram" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><img src="../media/07_Signal_Lifecycle_Overview_0.svg" alt="Mermaid Diagram"></p>
<a id="state-descriptions" class="tsd-anchor"></a><h3 class="tsd-anchor-link">State Descriptions<a href="#state-descriptions" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><table>
<thead>
<tr>
<th>State</th>
<th>Discriminator</th>
<th>Signal Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>idle</strong></td>
<td><code>action: &quot;idle&quot;</code></td>
<td><code>null</code></td>
<td>No active signal exists. Strategy can generate new signal on next <code>getSignal()</code> call.</td>
</tr>
<tr>
<td><strong>scheduled</strong></td>
<td><code>action: &quot;scheduled&quot;</code></td>
<td><code>IScheduledSignalRow</code></td>
<td>Signal created with delayed entry. Waiting for market price to reach <code>priceOpen</code>.</td>
</tr>
<tr>
<td><strong>opened</strong></td>
<td><code>action: &quot;opened&quot;</code></td>
<td><code>ISignalRow</code></td>
<td>Signal just created (immediate) or activated (from scheduled). Position tracking begins.</td>
</tr>
<tr>
<td><strong>active</strong></td>
<td><code>action: &quot;active&quot;</code></td>
<td><code>ISignalRow</code></td>
<td>Signal being monitored for TP/SL/time expiration. Continues until close condition met.</td>
</tr>
<tr>
<td><strong>closed</strong></td>
<td><code>action: &quot;closed&quot;</code></td>
<td><code>ISignalRow</code></td>
<td>Final state with PnL calculation. Includes <code>closeReason</code> and <code>closeTimestamp</code>.</td>
</tr>
<tr>
<td><strong>cancelled</strong></td>
<td><code>action: &quot;cancelled&quot;</code></td>
<td><code>IScheduledSignalRow</code></td>
<td>Scheduled signal cancelled before activation. Timeout or StopLoss hit.</td>
</tr>
</tbody>
</table>
<hr>
<a id="signal-data-structures" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Signal Data Structures<a href="#signal-data-structures" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>The framework uses a discriminated union pattern for type-safe signal handling. Three core interfaces represent signals at different lifecycle stages.</p>
<a id="core-signal-interfaces" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Core Signal Interfaces<a href="#core-signal-interfaces" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><img src="../media/07_Signal_Lifecycle_Overview_1.svg" alt="Mermaid Diagram"></p>
<a id="tick-result-discriminated-union" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Tick Result Discriminated Union<a href="#tick-result-discriminated-union" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Each state transition yields a specific tick result type, enabling type-safe handling with TypeScript discriminators:</p>
<table>
<thead>
<tr>
<th>Result Type</th>
<th>Discriminator</th>
<th>Contains</th>
<th>Use Case</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>IStrategyTickResultIdle</code></td>
<td><code>action: &quot;idle&quot;</code></td>
<td><code>signal: null</code></td>
<td>No signal exists, strategy idle</td>
</tr>
<tr>
<td><code>IStrategyTickResultScheduled</code></td>
<td><code>action: &quot;scheduled&quot;</code></td>
<td><code>signal: IScheduledSignalRow</code></td>
<td>Scheduled signal created</td>
</tr>
<tr>
<td><code>IStrategyTickResultOpened</code></td>
<td><code>action: &quot;opened&quot;</code></td>
<td><code>signal: ISignalRow</code></td>
<td>Signal opened/activated</td>
</tr>
<tr>
<td><code>IStrategyTickResultActive</code></td>
<td><code>action: &quot;active&quot;</code></td>
<td><code>signal: ISignalRow</code></td>
<td>Signal monitoring continues</td>
</tr>
<tr>
<td><code>IStrategyTickResultClosed</code></td>
<td><code>action: &quot;closed&quot;</code></td>
<td><code>signal: ISignalRow</code>, <code>pnl</code>, <code>closeReason</code></td>
<td>Signal closed with result</td>
</tr>
<tr>
<td><code>IStrategyTickResultCancelled</code></td>
<td><code>action: &quot;cancelled&quot;</code></td>
<td><code>signal: IScheduledSignalRow</code></td>
<td>Scheduled signal cancelled</td>
</tr>
</tbody>
</table>
<hr>
<a id="signal-generation-and-validation" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Signal Generation and Validation<a href="#signal-generation-and-validation" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>Signal generation occurs via the user-defined <code>getSignal()</code> function, followed by framework-level validation and augmentation.</p>
<a id="signal-generation-flow" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Signal Generation Flow<a href="#signal-generation-flow" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><img src="../media/07_Signal_Lifecycle_Overview_2.svg" alt="Mermaid Diagram"></p>
<a id="validation-rules" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Validation Rules<a href="#validation-rules" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>The <code>VALIDATE_SIGNAL_FN</code> enforces financial safety constraints to prevent invalid signals:</p>
<table>
<thead>
<tr>
<th>Validation Category</th>
<th>Rule</th>
<th>Configuration</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Price Finiteness</strong></td>
<td>All prices must be finite numbers (no NaN/Infinity)</td>
<td>Hard-coded</td>
</tr>
<tr>
<td><strong>Price Positivity</strong></td>
<td>All prices must be &gt; 0</td>
<td>Hard-coded</td>
</tr>
<tr>
<td><strong>Long Position Logic</strong></td>
<td><code>priceTakeProfit &gt; priceOpen &gt; priceStopLoss</code></td>
<td>Hard-coded</td>
</tr>
<tr>
<td><strong>Short Position Logic</strong></td>
<td><code>priceStopLoss &gt; priceOpen &gt; priceTakeProfit</code></td>
<td>Hard-coded</td>
</tr>
<tr>
<td><strong>Minimum TP Distance</strong></td>
<td>TP must cover fees + minimum profit</td>
<td><code>CC_MIN_TAKEPROFIT_DISTANCE_PERCENT</code> (default: 0.3%)</td>
</tr>
<tr>
<td><strong>Maximum SL Distance</strong></td>
<td>SL cannot exceed maximum loss threshold</td>
<td><code>CC_MAX_STOPLOSS_DISTANCE_PERCENT</code> (default: 20%)</td>
</tr>
<tr>
<td><strong>Time Constraints</strong></td>
<td><code>minuteEstimatedTime &gt; 0</code></td>
<td>Hard-coded</td>
</tr>
<tr>
<td><strong>Maximum Lifetime</strong></td>
<td>Signal cannot block risk limits indefinitely</td>
<td><code>CC_MAX_SIGNAL_LIFETIME_MINUTES</code> (default: 1440 min = 1 day)</td>
</tr>
</tbody>
</table>
<a id="signal-augmentation" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Signal Augmentation<a href="#signal-augmentation" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>User-provided <code>ISignalDto</code> is augmented with framework metadata:</p>
<pre><code class="typescript"><span class="hl-5">// User provides (from getSignal):</span><br/><span class="hl-1">{</span><br/><span class="hl-1">  </span><span class="hl-12">position</span><span class="hl-1">: </span><span class="hl-2">&quot;long&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-12">priceTakeProfit</span><span class="hl-1">: </span><span class="hl-8">45000</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-12">priceStopLoss</span><span class="hl-1">: </span><span class="hl-8">43000</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-12">minuteEstimatedTime</span><span class="hl-1">: </span><span class="hl-8">60</span><br/><span class="hl-1">}</span><br/><br/><span class="hl-5">// Framework augments to ISignalRow:</span><br/><span class="hl-1">{</span><br/><span class="hl-1">  </span><span class="hl-12">id</span><span class="hl-1">: </span><span class="hl-2">&quot;uuid-v4-generated&quot;</span><span class="hl-1">,           </span><span class="hl-5">// Auto-generated</span><br/><span class="hl-1">  </span><span class="hl-12">priceOpen</span><span class="hl-1">: </span><span class="hl-8">44000</span><span class="hl-1">,                  </span><span class="hl-5">// currentPrice or user-specified</span><br/><span class="hl-1">  </span><span class="hl-12">exchangeName</span><span class="hl-1">: </span><span class="hl-2">&quot;binance&quot;</span><span class="hl-1">,           </span><span class="hl-5">// From method context</span><br/><span class="hl-1">  </span><span class="hl-12">strategyName</span><span class="hl-1">: </span><span class="hl-2">&quot;momentum-strategy&quot;</span><span class="hl-1">, </span><span class="hl-5">// From method context</span><br/><span class="hl-1">  </span><span class="hl-12">scheduledAt</span><span class="hl-1">: </span><span class="hl-8">1640000000000</span><span class="hl-1">,       </span><span class="hl-5">// Current timestamp</span><br/><span class="hl-1">  </span><span class="hl-12">pendingAt</span><span class="hl-1">: </span><span class="hl-8">1640000000000</span><span class="hl-1">,         </span><span class="hl-5">// Same as scheduledAt initially</span><br/><span class="hl-1">  </span><span class="hl-12">symbol</span><span class="hl-1">: </span><span class="hl-2">&quot;BTCUSDT&quot;</span><span class="hl-1">,                </span><span class="hl-5">// From execution context</span><br/><span class="hl-1">  </span><span class="hl-12">_isScheduled</span><span class="hl-1">: </span><span class="hl-6">false</span><span class="hl-1">,              </span><span class="hl-5">// true if priceOpen specified</span><br/><span class="hl-1">  </span><span class="hl-5">// ... original fields</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<hr>
<a id="state-transitions" class="tsd-anchor"></a><h2 class="tsd-anchor-link">State Transitions<a href="#state-transitions" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><a id="idle-→-scheduled" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Idle → Scheduled<a href="#idle-→-scheduled" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Occurs when <code>getSignal()</code> returns a signal with <code>priceOpen</code> specified. Signal waits for market price to reach entry point.</p>
<p><img src="../media/07_Signal_Lifecycle_Overview_3.svg" alt="Mermaid Diagram"></p>
<p><strong>Key Implementation:</strong> Scheduled signals do NOT perform risk check at creation time. Risk validation occurs during activation when position opens.</p>
<a id="idle-→-opened-immediate" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Idle → Opened (Immediate)<a href="#idle-→-opened-immediate" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Occurs when <code>getSignal()</code> returns a signal without <code>priceOpen</code>. Position opens immediately at current VWAP.</p>
<p><img src="../media/07_Signal_Lifecycle_Overview_4.svg" alt="Mermaid Diagram"></p>
<a id="scheduled-→-opened-activation" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Scheduled → Opened (Activation)<a href="#scheduled-→-opened-activation" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Occurs when market price reaches <code>priceOpen</code> for a scheduled signal. Triggers risk check at activation time. The <code>pendingAt</code> timestamp is updated during activation. Time-based expiration calculates from <code>pendingAt</code>, not <code>scheduledAt</code>.</p>
<a id="scheduled-→-cancelled" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Scheduled → Cancelled<a href="#scheduled-→-cancelled" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Occurs when scheduled signal times out or StopLoss is hit before activation.</p>
<p><strong>Timeout Condition:</strong></p>
<pre><code class="typescript"><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">elapsedTime</span><span class="hl-1"> = </span><span class="hl-4">currentTime</span><span class="hl-1"> - </span><span class="hl-4">scheduled</span><span class="hl-1">.</span><span class="hl-4">scheduledAt</span><span class="hl-1">;</span><br/><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">maxTimeToWait</span><span class="hl-1"> = </span><span class="hl-7">CC_SCHEDULE_AWAIT_MINUTES</span><span class="hl-1"> * </span><span class="hl-8">60</span><span class="hl-1"> * </span><span class="hl-8">1000</span><span class="hl-1">;</span><br/><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-4">elapsedTime</span><span class="hl-1"> &gt;= </span><span class="hl-4">maxTimeToWait</span><span class="hl-1">) {</span><br/><span class="hl-1">  </span><span class="hl-5">// Cancel signal</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<p><strong>StopLoss Condition (Priority over activation):</strong></p>
<ul>
<li>Long: <code>currentPrice &lt;= priceStopLoss</code> → cancel</li>
<li>Short: <code>currentPrice &gt;= priceStopLoss</code> → cancel</li>
</ul>
<a id="openedactive-→-closed" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Opened/Active → Closed<a href="#openedactive-→-closed" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Occurs when signal meets closure condition: TakeProfit hit, StopLoss hit, or time expired.</p>
<p><img src="../media/07_Signal_Lifecycle_Overview_6.svg" alt="Mermaid Diagram"></p>
<p><strong>Critical:</strong> When TakeProfit or StopLoss triggers, the framework uses the <strong>exact TP/SL price</strong> for PnL calculation, not the current VWAP. This ensures deterministic results.</p>
<hr>
<a id="timestamp-management" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Timestamp Management<a href="#timestamp-management" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>Signals track two distinct timestamps for lifecycle management:</p>
<a id="timestamp-definitions" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Timestamp Definitions<a href="#timestamp-definitions" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><table>
<thead>
<tr>
<th>Timestamp</th>
<th>Set During</th>
<th>Purpose</th>
<th>Usage</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>scheduledAt</code></td>
<td>Signal creation</td>
<td>Records when signal was first generated</td>
<td>Timeout calculation for scheduled signals</td>
</tr>
<tr>
<td><code>pendingAt</code></td>
<td>Position activation</td>
<td>Records when position opened at <code>priceOpen</code></td>
<td>Time expiration calculation for active signals</td>
</tr>
</tbody>
</table>
<a id="timestamp-behavior" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Timestamp Behavior<a href="#timestamp-behavior" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><strong>Immediate Signals (no <code>priceOpen</code>):</strong></p>
<pre><code class="typescript"><span class="hl-12">scheduledAt</span><span class="hl-1">: </span><span class="hl-4">currentTime</span><span class="hl-1">,  </span><span class="hl-5">// Set at creation</span><br/><span class="hl-12">pendingAt</span><span class="hl-1">: </span><span class="hl-4">currentTime</span><span class="hl-1">     </span><span class="hl-5">// Same as scheduledAt</span>
</code><button type="button">Copy</button></pre>

<p><strong>Scheduled Signals (with <code>priceOpen</code>):</strong></p>
<pre><code class="typescript"><span class="hl-5">// At creation:</span><br/><span class="hl-12">scheduledAt</span><span class="hl-1">: </span><span class="hl-4">currentTime</span><span class="hl-1">,  </span><span class="hl-5">// Set at creation</span><br/><span class="hl-12">pendingAt</span><span class="hl-1">: </span><span class="hl-4">currentTime</span><span class="hl-1">     </span><span class="hl-5">// Temporarily equals scheduledAt</span><br/><br/><span class="hl-5">// At activation:</span><br/><span class="hl-12">scheduledAt</span><span class="hl-1">: </span><span class="hl-4">unchanged</span><span class="hl-1">,    </span><span class="hl-5">// Original creation time</span><br/><span class="hl-12">pendingAt</span><span class="hl-1">: </span><span class="hl-4">activationTime</span><span class="hl-1">  </span><span class="hl-5">// Updated to activation timestamp</span>
</code><button type="button">Copy</button></pre>

<p><strong>Timeout Calculation:</strong></p>
<ul>
<li><strong>Scheduled signal timeout:</strong> <code>currentTime - scheduledAt &gt;= CC_SCHEDULE_AWAIT_MINUTES * 60 * 1000</code></li>
<li><strong>Active signal expiration:</strong> <code>currentTime - pendingAt &gt;= minuteEstimatedTime * 60 * 1000</code></li>
</ul>
<hr>
<a id="lifecycle-callbacks" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Lifecycle Callbacks<a href="#lifecycle-callbacks" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>Strategies can register callbacks to observe signal state transitions. All callbacks are optional.</p>
<a id="callback-inventory" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Callback Inventory<a href="#callback-inventory" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><img src="../media/07_Signal_Lifecycle_Overview_7.svg" alt="Mermaid Diagram"></p>
<a id="callback-execution-order" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Callback Execution Order<a href="#callback-execution-order" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>For each state transition, callbacks execute in this order:</p>
<ol>
<li><strong>State-specific callback</strong> (e.g., <code>onOpen</code>, <code>onClose</code>)</li>
<li><strong><code>onTick</code> callback</strong> with tick result</li>
</ol>
<p>Example for signal opening:</p>
<pre><code class="typescript"><span class="hl-5">// 1. State-specific callback</span><br/><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-4">callbacks</span><span class="hl-1">.</span><span class="hl-4">onOpen</span><span class="hl-1">) {</span><br/><span class="hl-1">  </span><span class="hl-4">callbacks</span><span class="hl-1">.</span><span class="hl-0">onOpen</span><span class="hl-1">(</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">signal</span><span class="hl-1">, </span><span class="hl-4">currentPrice</span><span class="hl-1">, </span><span class="hl-4">backtest</span><span class="hl-1">);</span><br/><span class="hl-1">}</span><br/><br/><span class="hl-5">// 2. onTick callback</span><br/><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-4">callbacks</span><span class="hl-1">.</span><span class="hl-4">onTick</span><span class="hl-1">) {</span><br/><span class="hl-1">  </span><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">result</span><span class="hl-1">: </span><span class="hl-10">IStrategyTickResultOpened</span><span class="hl-1"> = { </span><span class="hl-4">action:</span><span class="hl-1"> </span><span class="hl-2">&quot;opened&quot;</span><span class="hl-1">, ... };</span><br/><span class="hl-1">  </span><span class="hl-4">callbacks</span><span class="hl-1">.</span><span class="hl-0">onTick</span><span class="hl-1">(</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">result</span><span class="hl-1">, </span><span class="hl-4">backtest</span><span class="hl-1">);</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<hr>
<a id="internal-state-management" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Internal State Management<a href="#internal-state-management" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>The <code>ClientStrategy</code> class maintains internal state for signal tracking:</p>
<a id="state-variables" class="tsd-anchor"></a><h3 class="tsd-anchor-link">State Variables<a href="#state-variables" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><table>
<thead>
<tr>
<th>Variable</th>
<th>Type</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>_pendingSignal</code></td>
<td><code>ISignalRow | null</code></td>
<td>Currently active signal being monitored</td>
</tr>
<tr>
<td><code>_scheduledSignal</code></td>
<td><code>IScheduledSignalRow | null</code></td>
<td>Scheduled signal awaiting activation</td>
</tr>
<tr>
<td><code>_lastSignalTimestamp</code></td>
<td><code>number | null</code></td>
<td>Timestamp of last <code>getSignal()</code> call (for throttling)</td>
</tr>
<tr>
<td><code>_isStopped</code></td>
<td><code>boolean</code></td>
<td>Flag to prevent new signal generation</td>
</tr>
</tbody>
</table>
<a id="mutual-exclusion" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Mutual Exclusion<a href="#mutual-exclusion" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Only one signal can exist per symbol at a time. The framework enforces mutual exclusion:</p>
<ul>
<li><code>_pendingSignal</code> and <code>_scheduledSignal</code> are <strong>never both non-null</strong></li>
<li>Scheduled signal transitions to pending signal on activation</li>
<li>New signals rejected if active signal exists (via risk check)</li>
</ul>
<a id="persistence-live-mode-only" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Persistence (Live Mode Only)<a href="#persistence-live-mode-only" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>In live mode, signals persist to disk atomically for crash recovery:</p>
<pre><code class="typescript"><span class="hl-5">// Persist after every state change</span><br/><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-4">PersistSignalAdapter</span><span class="hl-1">.</span><span class="hl-0">writeSignalData</span><span class="hl-1">(</span><br/><span class="hl-1">  </span><span class="hl-4">strategyName</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">symbol</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">pendingSignal</span><br/><span class="hl-1">);</span><br/><br/><span class="hl-5">// Restore on initialization</span><br/><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">restored</span><span class="hl-1"> = </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-4">PersistSignalAdapter</span><span class="hl-1">.</span><span class="hl-0">readSignalData</span><span class="hl-1">(</span><br/><span class="hl-1">  </span><span class="hl-4">strategyName</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">symbol</span><br/><span class="hl-1">);</span>
</code><button type="button">Copy</button></pre>

<p><strong>File Location:</strong> <code>signal-{strategyName}-{symbol}.json</code></p>
<p><strong>Atomic Write Pattern:</strong> Write to temp file, then rename for crash-safe persistence.</p>
<hr>
<a id="summary" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Summary<a href="#summary" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>The signal lifecycle follows a deterministic state machine with six states: idle, scheduled, opened, active, closed, and cancelled. Signals are generated via user-defined <code>getSignal()</code> functions, validated by framework rules, and monitored through VWAP-based price checks. State transitions trigger lifecycle callbacks for observability. Timestamps (<code>scheduledAt</code> vs <code>pendingAt</code>) enable precise timeout and expiration calculations. In live mode, signals persist atomically to disk for crash recovery.</p>
<p>For implementation details of signal processing within specific execution modes, see <a href="design_51_backtest_execution_flow.html">Backtest Execution Flow</a> and <a href="design_55_live_execution_flow.html">Live Execution Flow</a>.</p>
</div></div><div class="col-sidebar"><div class="page-menu"><div class="tsd-navigation settings"><details class="tsd-accordion"><summary class="tsd-accordion-summary"><h3><svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-chevronDown"></use></svg>Settings</h3></summary><div class="tsd-accordion-details"><div class="tsd-filter-visibility"><span class="settings-label">Member Visibility</span><ul id="tsd-filter-options"><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-protected" name="protected"/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Protected</span></label></li><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-inherited" name="inherited" checked/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Inherited</span></label></li><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-external" name="external"/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>External</span></label></li></ul></div><div class="tsd-theme-toggle"><label class="settings-label" for="tsd-theme">Theme</label><select id="tsd-theme"><option value="os">OS</option><option value="light">Light</option><option value="dark">Dark</option></select></div></div></details></div><details open class="tsd-accordion tsd-page-navigation"><summary class="tsd-accordion-summary"><h3><svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-chevronDown"></use></svg>On This Page</h3></summary><div class="tsd-accordion-details"><a href="#signal-lifecycle-overview"><span>Signal <wbr/>Lifecycle <wbr/>Overview</span></a><ul><li><a href="#purpose-and-scope"><span>Purpose and <wbr/>Scope</span></a></li><li><a href="#signal-state-machine"><span>Signal <wbr/>State <wbr/>Machine</span></a></li><li><ul><li><a href="#state-transition-diagram"><span>State <wbr/>Transition <wbr/>Diagram</span></a></li><li><a href="#state-descriptions"><span>State <wbr/>Descriptions</span></a></li></ul></li><li><a href="#signal-data-structures"><span>Signal <wbr/>Data <wbr/>Structures</span></a></li><li><ul><li><a href="#core-signal-interfaces"><span>Core <wbr/>Signal <wbr/>Interfaces</span></a></li><li><a href="#tick-result-discriminated-union"><span>Tick <wbr/>Result <wbr/>Discriminated <wbr/>Union</span></a></li></ul></li><li><a href="#signal-generation-and-validation"><span>Signal <wbr/>Generation and <wbr/>Validation</span></a></li><li><ul><li><a href="#signal-generation-flow"><span>Signal <wbr/>Generation <wbr/>Flow</span></a></li><li><a href="#validation-rules"><span>Validation <wbr/>Rules</span></a></li><li><a href="#signal-augmentation"><span>Signal <wbr/>Augmentation</span></a></li></ul></li><li><a href="#state-transitions"><span>State <wbr/>Transitions</span></a></li><li><ul><li><a href="#idle-→-scheduled"><span>Idle → <wbr/>Scheduled</span></a></li><li><a href="#idle-→-opened-immediate"><span>Idle → <wbr/>Opened (<wbr/>Immediate)</span></a></li><li><a href="#scheduled-→-opened-activation"><span>Scheduled → <wbr/>Opened (<wbr/>Activation)</span></a></li><li><a href="#scheduled-→-cancelled"><span>Scheduled → <wbr/>Cancelled</span></a></li><li><a href="#openedactive-→-closed"><span>Opened/<wbr/>Active → <wbr/>Closed</span></a></li></ul></li><li><a href="#timestamp-management"><span>Timestamp <wbr/>Management</span></a></li><li><ul><li><a href="#timestamp-definitions"><span>Timestamp <wbr/>Definitions</span></a></li><li><a href="#timestamp-behavior"><span>Timestamp <wbr/>Behavior</span></a></li></ul></li><li><a href="#lifecycle-callbacks"><span>Lifecycle <wbr/>Callbacks</span></a></li><li><ul><li><a href="#callback-inventory"><span>Callback <wbr/>Inventory</span></a></li><li><a href="#callback-execution-order"><span>Callback <wbr/>Execution <wbr/>Order</span></a></li></ul></li><li><a href="#internal-state-management"><span>Internal <wbr/>State <wbr/>Management</span></a></li><li><ul><li><a href="#state-variables"><span>State <wbr/>Variables</span></a></li><li><a href="#mutual-exclusion"><span>Mutual <wbr/>Exclusion</span></a></li><li><a href="#persistence-live-mode-only"><span>Persistence (<wbr/>Live <wbr/>Mode <wbr/>Only)</span></a></li></ul></li><li><a href="#summary"><span>Summary</span></a></li></ul></div></details></div><div class="site-menu"><nav class="tsd-navigation"><a href="../modules.html">backtest-kit</a><ul class="tsd-small-nested-navigation" id="tsd-nav-container"><li>Loading...</li></ul></nav></div></div></div><footer><p class="tsd-generator">Generated using <a href="https://typedoc.org/" target="_blank">TypeDoc</a></p></footer><div class="overlay"></div></body></html>

<!-- Yandex.Metrika counter -->
<script type="text/javascript">
    (function(m,e,t,r,i,k,a){
        m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
        m[i].l=1*new Date();
        for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }}
        k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)
    })(window, document,'script','https://mc.yandex.ru/metrika/tag.js?id=105455585', 'ym');

    ym(105455585, 'init', {ssr:true, webvisor:true, clickmap:true, ecommerce:"dataLayer", accurateTrackBounce:true, trackLinks:true});
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/105455585" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
<!-- /Yandex.Metrika counter -->

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-3MQZEBBDDR"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-3MQZEBBDDR');
</script>
