<!DOCTYPE html><html class="default" lang="en" data-base=".."><head><meta charset="utf-8"/><meta http-equiv="x-ua-compatible" content="IE=edge"/><title>design/23_candle-data-and-vwap | backtest-kit</title><meta name="description" content="Documentation for backtest-kit"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="stylesheet" href="../assets/style.css"/><link rel="stylesheet" href="../assets/highlight.css"/><script defer src="../assets/main.js"></script><script async src="../assets/icons.js" id="tsd-icons-script"></script><script async src="../assets/search.js" id="tsd-search-script"></script><script async src="../assets/navigation.js" id="tsd-nav-script"></script><script async src="../assets/hierarchy.js" id="tsd-hierarchy-script"></script></head><body><script>document.documentElement.dataset.theme = localStorage.getItem("tsd-theme") || "os";document.body.style.display="none";setTimeout(() => app?app.showPage():document.body.style.removeProperty("display"),500)</script><header class="tsd-page-toolbar"><div class="tsd-toolbar-contents container"><div class="table-cell" id="tsd-search"><div class="field"><label for="tsd-search-field" class="tsd-widget tsd-toolbar-icon search no-caption"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-search"></use></svg></label><input type="text" id="tsd-search-field" aria-label="Search"/></div><div class="field"><div id="tsd-toolbar-links"></div></div><ul class="results"><li class="state loading">Preparing search index...</li><li class="state failure">The search index is not available</li></ul><a href="../index.html" class="title">backtest-kit</a></div><div class="table-cell" id="tsd-widgets"><a href="#" class="tsd-widget tsd-toolbar-icon menu no-caption" data-toggle="menu" aria-label="Menu"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-menu"></use></svg></a></div></div></header><div class="container container-main"><div class="col-content"><div class="tsd-page-title"><ul class="tsd-breadcrumb"><li><a href="../modules.html">backtest-kit</a></li><li><a href="design_23_candle-data-and-vwap.html">design/23_candle-data-and-vwap</a></li></ul></div><div class="tsd-panel tsd-typography"><a id="candle-data-and-vwap" class="tsd-anchor"></a><h1 class="tsd-anchor-link">Candle Data and VWAP<a href="#candle-data-and-vwap" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h1><p>This page documents the candlestick data structure (<code>ICandleData</code>), Volume-Weighted Average Price (VWAP) calculation for realistic trade execution pricing, and data quality mechanisms including anomaly detection and retry logic for handling incomplete or failed candle fetches.</p>
<p>For exchange configuration and data source integration, see <a href="design_22_exchange-configuration.html">Exchange Configuration</a>. For timeframe generation and backtest iteration, see <a href="design_24_timeframes-and-frames.html">Timeframes and Frames</a>.</p>
<hr>
<a id="candle-data-structure" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Candle Data Structure<a href="#candle-data-structure" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>All market data in the framework is represented using the <code>ICandleData</code> interface, which contains standard OHLCV (Open-High-Low-Close-Volume) candlestick fields:</p>
<table>
<thead>
<tr>
<th>Field</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>timestamp</code></td>
<td><code>number</code></td>
<td>Unix timestamp in milliseconds when candle opened</td>
</tr>
<tr>
<td><code>open</code></td>
<td><code>number</code></td>
<td>Opening price at candle start</td>
</tr>
<tr>
<td><code>high</code></td>
<td><code>number</code></td>
<td>Highest price during candle period</td>
</tr>
<tr>
<td><code>low</code></td>
<td><code>number</code></td>
<td>Lowest price during candle period</td>
</tr>
<tr>
<td><code>close</code></td>
<td><code>number</code></td>
<td>Closing price at candle end</td>
</tr>
<tr>
<td><code>volume</code></td>
<td><code>number</code></td>
<td>Trading volume during candle period</td>
</tr>
</tbody>
</table>
<p>This structure is used consistently across:</p>
<ul>
<li>Exchange <code>getCandles()</code> implementations (historical data)</li>
<li>Backtest fast-forward processing via <code>getNextCandles()</code></li>
<li>VWAP calculation for realistic entry/exit pricing</li>
</ul>
<hr>
<a id="vwap-calculation" class="tsd-anchor"></a><h2 class="tsd-anchor-link">VWAP Calculation<a href="#vwap-calculation" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><a id="purpose-and-formula" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Purpose and Formula<a href="#purpose-and-formula" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>VWAP (Volume-Weighted Average Price) provides realistic execution pricing by weighting candle prices by their trading volume. This prevents unrealistic backtest results from using simple average or close prices.</p>
<p><strong>Formula:</strong></p>
<pre><code><span class="hl-4">Typical</span><span class="hl-1"> </span><span class="hl-4">Price</span><span class="hl-1"> = (</span><span class="hl-4">High</span><span class="hl-1"> + </span><span class="hl-4">Low</span><span class="hl-1"> + </span><span class="hl-4">Close</span><span class="hl-1">) / </span><span class="hl-6">3</span><br/><span class="hl-8">VWAP</span><span class="hl-1"> = </span><span class="hl-0">Σ</span><span class="hl-1">(</span><span class="hl-4">Typical</span><span class="hl-1"> </span><span class="hl-4">Price</span><span class="hl-1"> × </span><span class="hl-4">Volume</span><span class="hl-1">) / </span><span class="hl-0">Σ</span><span class="hl-1">(</span><span class="hl-4">Volume</span><span class="hl-1">)</span>
</code><button>Copy</button></pre>

<p>The calculation uses the last N candles (configured via <code>CC_AVG_PRICE_CANDLES_COUNT</code>) to smooth short-term volatility while remaining responsive to price movements.</p>
<a id="configuration-parameters" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Configuration Parameters<a href="#configuration-parameters" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><pre><code class="typescript"><span class="hl-10">CC_AVG_PRICE_CANDLES_COUNT</span><span class="hl-1">: </span><span class="hl-6">5</span><span class="hl-1">  </span><span class="hl-5">// Default: 5 1-minute candles</span>
</code><button type="button">Copy</button></pre>

<p>This parameter controls:</p>
<ul>
<li>Number of recent candles to include in VWAP calculation</li>
<li>Sensitivity to price changes (lower = more responsive, higher = more stable)</li>
<li>Minimum data requirement for calculation</li>
</ul>
<p><strong>Typical Usage:</strong></p>
<ul>
<li><code>5 candles</code>: Standard for 1-minute intervals (last 5 minutes)</li>
<li><code>10+ candles</code>: Smoother VWAP for higher timeframes or volatile assets</li>
<li><code>3 candles</code>: More responsive for fast-moving markets (minimum recommended)</li>
</ul>
<hr>
<a id="vwap-calculation-flow" class="tsd-anchor"></a><h2 class="tsd-anchor-link">VWAP Calculation Flow<a href="#vwap-calculation-flow" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p><img src="../media/23-candle-data-and-vwap_0.svg" alt="Mermaid Diagram"></p>
<hr>
<a id="anomaly-detection-for-incomplete-candles" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Anomaly Detection for Incomplete Candles<a href="#anomaly-detection-for-incomplete-candles" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><a id="problem-statement" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Problem Statement<a href="#problem-statement" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Exchange APIs (particularly Binance) occasionally return incomplete candles with anomalously low prices:</p>
<table>
<thead>
<tr>
<th>Normal Candle</th>
<th>Incomplete Candle</th>
<th>Issue</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>open: 42000</code></td>
<td><code>open: 0.1</code></td>
<td>420,000× lower (factor violation)</td>
</tr>
<tr>
<td><code>volume: 100</code></td>
<td><code>volume: 0</code></td>
<td>Zero volume indicator</td>
</tr>
<tr>
<td><code>close: 42050</code></td>
<td><code>close: 0.12</code></td>
<td>Far below market price</td>
</tr>
</tbody>
</table>
<p>These anomalies cause:</p>
<ul>
<li>False signal generation (apparent 99.9% price drops)</li>
<li>Incorrect VWAP calculations</li>
<li>Misleading backtest results</li>
</ul>
<a id="detection-algorithm" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Detection Algorithm<a href="#detection-algorithm" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>The framework implements two-stage anomaly detection:</p>
<p><strong>Stage 1: Calculate Reference Price</strong></p>
<pre><code class="typescript"><span class="hl-5">// If sufficient candles, use median (robust to outliers)</span><br/><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-4">candles</span><span class="hl-1">.</span><span class="hl-4">length</span><span class="hl-1"> &gt;= </span><span class="hl-8">CC_GET_CANDLES_MIN_CANDLES_FOR_MEDIAN</span><span class="hl-1">) {</span><br/><span class="hl-1">  </span><span class="hl-4">referencePrice</span><span class="hl-1"> = </span><span class="hl-0">median</span><span class="hl-1">([</span><span class="hl-4">all</span><span class="hl-1"> </span><span class="hl-8">OHLC</span><span class="hl-1"> </span><span class="hl-4">prices</span><span class="hl-1">])</span><br/><span class="hl-1">} </span><span class="hl-3">else</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-5">// For small datasets, use average (more stable)</span><br/><span class="hl-1">  </span><span class="hl-4">referencePrice</span><span class="hl-1"> = </span><span class="hl-0">average</span><span class="hl-1">([</span><span class="hl-4">all</span><span class="hl-1"> </span><span class="hl-8">OHLC</span><span class="hl-1"> </span><span class="hl-4">prices</span><span class="hl-1">])</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<p><strong>Stage 2: Validate Against Threshold</strong></p>
<pre><code class="typescript"><span class="hl-4">threshold</span><span class="hl-1"> = </span><span class="hl-4">referencePrice</span><span class="hl-1"> / </span><span class="hl-8">CC_GET_CANDLES_PRICE_ANOMALY_THRESHOLD_FACTOR</span><br/><br/><span class="hl-4">for</span><span class="hl-1"> </span><span class="hl-4">each</span><span class="hl-1"> </span><span class="hl-4">price</span><span class="hl-1"> </span><span class="hl-7">in</span><span class="hl-1"> </span><span class="hl-4">candle</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-4">price</span><span class="hl-1"> &lt; </span><span class="hl-4">threshold</span><span class="hl-1">) {</span><br/><span class="hl-1">    </span><span class="hl-3">throw</span><span class="hl-1"> </span><span class="hl-0">Error</span><span class="hl-1">(</span><span class="hl-2">&quot;Anomalously low price detected&quot;</span><span class="hl-1">)</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<a id="configuration-parameters-1" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Configuration Parameters<a href="#configuration-parameters-1" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><table>
<thead>
<tr>
<th>Parameter</th>
<th>Default</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>CC_GET_CANDLES_PRICE_ANOMALY_THRESHOLD_FACTOR</code></td>
<td><code>1000</code></td>
<td>Maximum allowed deviation factor</td>
</tr>
<tr>
<td><code>CC_GET_CANDLES_MIN_CANDLES_FOR_MEDIAN</code></td>
<td><code>5</code></td>
<td>Minimum candles for median calculation</td>
</tr>
</tbody>
</table>
<p><strong>Example:</strong> BTC at $50,000 median</p>
<ul>
<li>Threshold: $50,000 / 1,000 = $50</li>
<li>Catches incomplete candles with prices $0.01-$1 (typical incomplete values)</li>
<li>Allows legitimate price ranges ($45,000-$55,000)</li>
</ul>
<a id="rationale-for-factor-1000" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Rationale for Factor 1000<a href="#rationale-for-factor-1000" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><pre><code><span class="hl-4">Factor</span><span class="hl-1">   | </span><span class="hl-8">BTC</span><span class="hl-1"> </span><span class="hl-4">Threshold</span><span class="hl-1"> | </span><span class="hl-4">Catches</span><span class="hl-1"> </span><span class="hl-4">Anomalies</span><span class="hl-1">? | </span><span class="hl-4">False</span><span class="hl-1"> </span><span class="hl-4">Positives</span><span class="hl-1">?</span><br/><span class="hl-1">---------|---------------|-------------------|------------------</span><br/><span class="hl-6">100</span><span class="hl-1">      | </span><span class="hl-4">$500</span><span class="hl-1">          | ✓ </span><span class="hl-4">Yes</span><span class="hl-1">            | ✗ </span><span class="hl-4">Too</span><span class="hl-1"> </span><span class="hl-4">permissive</span><br/><span class="hl-6">1</span><span class="hl-1">,</span><span class="hl-6">000</span><span class="hl-1">    | </span><span class="hl-4">$50</span><span class="hl-1">           | ✓ </span><span class="hl-4">Yes</span><span class="hl-1">            | ✓ </span><span class="hl-4">Optimal</span><br/><span class="hl-6">10</span><span class="hl-1">,</span><span class="hl-6">000</span><span class="hl-1">   | </span><span class="hl-4">$5</span><span class="hl-1">            | ✓ </span><span class="hl-4">Yes</span><span class="hl-1">            | ✗ </span><span class="hl-4">Too</span><span class="hl-1"> </span><span class="hl-0">strict</span><span class="hl-1"> (</span><span class="hl-4">altcoins</span><span class="hl-1">)</span>
</code><button>Copy</button></pre>

<hr>
<a id="anomaly-detection-flow-diagram" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Anomaly Detection Flow Diagram<a href="#anomaly-detection-flow-diagram" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p><img src="../media/23-candle-data-and-vwap_1.svg" alt="Mermaid Diagram"></p>
<hr>
<a id="retry-logic-for-failed-requests" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Retry Logic for Failed Requests<a href="#retry-logic-for-failed-requests" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><a id="configuration" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Configuration<a href="#configuration" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><pre><code class="typescript"><span class="hl-10">CC_GET_CANDLES_RETRY_COUNT</span><span class="hl-1">: </span><span class="hl-6">3</span><span class="hl-1">       </span><span class="hl-5">// Number of retry attempts</span><br/><span class="hl-10">CC_GET_CANDLES_RETRY_DELAY_MS</span><span class="hl-1">: </span><span class="hl-6">5000</span><span class="hl-1"> </span><span class="hl-5">// Delay between retries (5 seconds)</span>
</code><button type="button">Copy</button></pre>

<a id="retry-scenarios" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Retry Scenarios<a href="#retry-scenarios" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>The framework automatically retries <code>getCandles()</code> calls on:</p>
<ol>
<li><strong>Network failures</strong> (connection timeout, DNS errors)</li>
<li><strong>Exchange API errors</strong> (rate limits, temporary unavailability)</li>
<li><strong>Anomaly detection failures</strong> (incomplete candles rejected)</li>
</ol>
<a id="retry-strategy" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Retry Strategy<a href="#retry-strategy" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><img src="../media/23-candle-data-and-vwap_2.svg" alt="Mermaid Diagram"></p>
<p><strong>Total Time Budget:</strong> <code>3 retries × 5 seconds = 15 seconds</code> (plus request time)</p>
<hr>
<a id="integration-with-strategy-execution" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Integration with Strategy Execution<a href="#integration-with-strategy-execution" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><a id="entry-price-determination" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Entry Price Determination<a href="#entry-price-determination" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>When strategies generate signals, the entry price (<code>priceOpen</code>) is determined based on signal type:</p>
<table>
<thead>
<tr>
<th>Signal Type</th>
<th>Entry Price</th>
<th>Source</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Immediate</strong> (no <code>priceOpen</code>)</td>
<td>Current VWAP</td>
<td><code>getAveragePrice()</code></td>
</tr>
<tr>
<td><strong>Scheduled</strong> (with <code>priceOpen</code>)</td>
<td>User-specified</td>
<td>Signal DTO</td>
</tr>
</tbody>
</table>
<a id="vwap-usage-in-backtest" class="tsd-anchor"></a><h3 class="tsd-anchor-link">VWAP Usage in Backtest<a href="#vwap-usage-in-backtest" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><img src="../media/23-candle-data-and-vwap_3.svg" alt="Mermaid Diagram"></p>
<p><strong>Key Points:</strong></p>
<ul>
<li>VWAP provides realistic execution prices (not optimistic high/low)</li>
<li>Slippage and fees are applied on top of VWAP in PnL calculation</li>
<li>Backtest uses <code>getNextCandles()</code> to simulate future price action for TP/SL checks</li>
</ul>
<hr>
<a id="usage-examples" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Usage Examples<a href="#usage-examples" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><a id="accessing-vwap-in-strategy" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Accessing VWAP in Strategy<a href="#accessing-vwap-in-strategy" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><pre><code class="typescript"><span class="hl-3">import</span><span class="hl-1"> { </span><span class="hl-4">getAveragePrice</span><span class="hl-1"> } </span><span class="hl-3">from</span><span class="hl-1"> </span><span class="hl-2">&#39;backtest-kit&#39;</span><span class="hl-1">;</span><br/><br/><span class="hl-0">addStrategy</span><span class="hl-1">({</span><br/><span class="hl-1">  </span><span class="hl-4">strategyName:</span><span class="hl-1"> </span><span class="hl-2">&#39;vwap-based-strategy&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">interval:</span><span class="hl-1"> </span><span class="hl-2">&#39;5m&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-0">getSignal</span><span class="hl-4">:</span><span class="hl-1"> </span><span class="hl-7">async</span><span class="hl-1"> (</span><span class="hl-4">symbol</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-5">// Get current VWAP (last 5 candles by default)</span><br/><span class="hl-1">    </span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">currentPrice</span><span class="hl-1"> = </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-0">getAveragePrice</span><span class="hl-1">(</span><span class="hl-4">symbol</span><span class="hl-1">);</span><br/><span class="hl-1">    </span><br/><span class="hl-1">    </span><span class="hl-5">// Optional: Get custom candle count via getCandles</span><br/><span class="hl-1">    </span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">candles</span><span class="hl-1"> = </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-0">getCandles</span><span class="hl-1">(</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-2">&#39;1m&#39;</span><span class="hl-1">, </span><span class="hl-6">10</span><span class="hl-1">);</span><br/><span class="hl-1">    </span><br/><span class="hl-1">    </span><span class="hl-3">return</span><span class="hl-1"> {</span><br/><span class="hl-1">      </span><span class="hl-4">position:</span><span class="hl-1"> </span><span class="hl-2">&#39;long&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">      </span><span class="hl-4">priceTakeProfit:</span><span class="hl-1"> </span><span class="hl-4">currentPrice</span><span class="hl-1"> * </span><span class="hl-6">1.02</span><span class="hl-1">,  </span><span class="hl-5">// 2% above VWAP</span><br/><span class="hl-1">      </span><span class="hl-4">priceStopLoss:</span><span class="hl-1"> </span><span class="hl-4">currentPrice</span><span class="hl-1"> * </span><span class="hl-6">0.98</span><span class="hl-1">,    </span><span class="hl-5">// 2% below VWAP</span><br/><span class="hl-1">      </span><span class="hl-4">minuteEstimatedTime:</span><span class="hl-1"> </span><span class="hl-6">60</span><br/><span class="hl-1">    };</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">});</span>
</code><button type="button">Copy</button></pre>

<a id="configuring-vwap-calculation" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Configuring VWAP Calculation<a href="#configuring-vwap-calculation" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><pre><code class="typescript"><span class="hl-3">import</span><span class="hl-1"> { </span><span class="hl-4">setConfig</span><span class="hl-1"> } </span><span class="hl-3">from</span><span class="hl-1"> </span><span class="hl-2">&#39;backtest-kit&#39;</span><span class="hl-1">;</span><br/><br/><span class="hl-5">// Use 10 candles for smoother VWAP (less noise)</span><br/><span class="hl-0">setConfig</span><span class="hl-1">({</span><br/><span class="hl-1">  </span><span class="hl-4">CC_AVG_PRICE_CANDLES_COUNT:</span><span class="hl-1"> </span><span class="hl-6">10</span><br/><span class="hl-1">});</span><br/><br/><span class="hl-5">// Increase retry tolerance for unreliable exchange API</span><br/><span class="hl-0">setConfig</span><span class="hl-1">({</span><br/><span class="hl-1">  </span><span class="hl-4">CC_GET_CANDLES_RETRY_COUNT:</span><span class="hl-1"> </span><span class="hl-6">5</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">CC_GET_CANDLES_RETRY_DELAY_MS:</span><span class="hl-1"> </span><span class="hl-6">3000</span><span class="hl-1">  </span><span class="hl-5">// 3 seconds between retries</span><br/><span class="hl-1">});</span>
</code><button type="button">Copy</button></pre>

<a id="handling-anomaly-detection" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Handling Anomaly Detection<a href="#handling-anomaly-detection" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><pre><code class="typescript"><span class="hl-3">import</span><span class="hl-1"> { </span><span class="hl-4">listenError</span><span class="hl-1"> } </span><span class="hl-3">from</span><span class="hl-1"> </span><span class="hl-2">&#39;backtest-kit&#39;</span><span class="hl-1">;</span><br/><br/><span class="hl-5">// Monitor anomaly detection failures</span><br/><span class="hl-0">listenError</span><span class="hl-1">((</span><span class="hl-4">error</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-4">error</span><span class="hl-1">.</span><span class="hl-4">message</span><span class="hl-1">.</span><span class="hl-0">includes</span><span class="hl-1">(</span><span class="hl-2">&#39;VALIDATE_NO_INCOMPLETE_CANDLES_FN&#39;</span><span class="hl-1">)) {</span><br/><span class="hl-1">    </span><span class="hl-4">console</span><span class="hl-1">.</span><span class="hl-0">error</span><span class="hl-1">(</span><span class="hl-2">&#39;Incomplete candle detected and rejected:&#39;</span><span class="hl-1">, </span><span class="hl-4">error</span><span class="hl-1">);</span><br/><span class="hl-1">    </span><span class="hl-5">// Alert monitoring system, log for debugging</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">});</span>
</code><button type="button">Copy</button></pre>

<hr>
<a id="configuration-summary" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Configuration Summary<a href="#configuration-summary" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><table>
<thead>
<tr>
<th>Parameter</th>
<th>Default</th>
<th>Valid Range</th>
<th>Impact</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>CC_AVG_PRICE_CANDLES_COUNT</code></td>
<td><code>5</code></td>
<td>1-50</td>
<td>Number of candles for VWAP calculation</td>
</tr>
<tr>
<td><code>CC_GET_CANDLES_RETRY_COUNT</code></td>
<td><code>3</code></td>
<td>0-10</td>
<td>Number of retry attempts on failure</td>
</tr>
<tr>
<td><code>CC_GET_CANDLES_RETRY_DELAY_MS</code></td>
<td><code>5000</code></td>
<td>1000-30000</td>
<td>Milliseconds between retries</td>
</tr>
<tr>
<td><code>CC_GET_CANDLES_PRICE_ANOMALY_THRESHOLD_FACTOR</code></td>
<td><code>1000</code></td>
<td>100-10000</td>
<td>Maximum price deviation factor</td>
</tr>
<tr>
<td><code>CC_GET_CANDLES_MIN_CANDLES_FOR_MEDIAN</code></td>
<td><code>5</code></td>
<td>3-20</td>
<td>Minimum candles to use median vs average</td>
</tr>
</tbody>
</table>
<p><strong>Trade-offs:</strong></p>
<ul>
<li><strong>Higher <code>CC_AVG_PRICE_CANDLES_COUNT</code></strong>: Smoother VWAP, less responsive to sudden moves</li>
<li><strong>Higher <code>CC_GET_CANDLES_RETRY_COUNT</code></strong>: More resilient to temporary failures, slower execution on persistent errors</li>
<li><strong>Lower <code>CC_GET_CANDLES_PRICE_ANOMALY_THRESHOLD_FACTOR</code></strong>: Stricter anomaly detection, may reject valid low-cap altcoin prices</li>
</ul>
</div></div><div class="col-sidebar"><div class="page-menu"><div class="tsd-navigation settings"><details class="tsd-accordion"><summary class="tsd-accordion-summary"><h3><svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-chevronDown"></use></svg>Settings</h3></summary><div class="tsd-accordion-details"><div class="tsd-filter-visibility"><span class="settings-label">Member Visibility</span><ul id="tsd-filter-options"><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-protected" name="protected"/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Protected</span></label></li><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-inherited" name="inherited" checked/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Inherited</span></label></li><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-external" name="external"/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>External</span></label></li></ul></div><div class="tsd-theme-toggle"><label class="settings-label" for="tsd-theme">Theme</label><select id="tsd-theme"><option value="os">OS</option><option value="light">Light</option><option value="dark">Dark</option></select></div></div></details></div><details open class="tsd-accordion tsd-page-navigation"><summary class="tsd-accordion-summary"><h3><svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-chevronDown"></use></svg>On This Page</h3></summary><div class="tsd-accordion-details"><a href="#candle-data-and-vwap"><span>Candle <wbr/>Data and VWAP</span></a><ul><li><a href="#candle-data-structure"><span>Candle <wbr/>Data <wbr/>Structure</span></a></li><li><a href="#vwap-calculation"><span>VWAP <wbr/>Calculation</span></a></li><li><ul><li><a href="#purpose-and-formula"><span>Purpose and <wbr/>Formula</span></a></li><li><a href="#configuration-parameters"><span>Configuration <wbr/>Parameters</span></a></li></ul></li><li><a href="#vwap-calculation-flow"><span>VWAP <wbr/>Calculation <wbr/>Flow</span></a></li><li><a href="#anomaly-detection-for-incomplete-candles"><span>Anomaly <wbr/>Detection for <wbr/>Incomplete <wbr/>Candles</span></a></li><li><ul><li><a href="#problem-statement"><span>Problem <wbr/>Statement</span></a></li><li><a href="#detection-algorithm"><span>Detection <wbr/>Algorithm</span></a></li><li><a href="#configuration-parameters-1"><span>Configuration <wbr/>Parameters</span></a></li><li><a href="#rationale-for-factor-1000"><span>Rationale for <wbr/>Factor 1000</span></a></li></ul></li><li><a href="#anomaly-detection-flow-diagram"><span>Anomaly <wbr/>Detection <wbr/>Flow <wbr/>Diagram</span></a></li><li><a href="#retry-logic-for-failed-requests"><span>Retry <wbr/>Logic for <wbr/>Failed <wbr/>Requests</span></a></li><li><ul><li><a href="#configuration"><span>Configuration</span></a></li><li><a href="#retry-scenarios"><span>Retry <wbr/>Scenarios</span></a></li><li><a href="#retry-strategy"><span>Retry <wbr/>Strategy</span></a></li></ul></li><li><a href="#integration-with-strategy-execution"><span>Integration with <wbr/>Strategy <wbr/>Execution</span></a></li><li><ul><li><a href="#entry-price-determination"><span>Entry <wbr/>Price <wbr/>Determination</span></a></li><li><a href="#vwap-usage-in-backtest"><span>VWAP <wbr/>Usage in <wbr/>Backtest</span></a></li></ul></li><li><a href="#usage-examples"><span>Usage <wbr/>Examples</span></a></li><li><ul><li><a href="#accessing-vwap-in-strategy"><span>Accessing VWAP in <wbr/>Strategy</span></a></li><li><a href="#configuring-vwap-calculation"><span>Configuring VWAP <wbr/>Calculation</span></a></li><li><a href="#handling-anomaly-detection"><span>Handling <wbr/>Anomaly <wbr/>Detection</span></a></li></ul></li><li><a href="#configuration-summary"><span>Configuration <wbr/>Summary</span></a></li></ul></div></details></div><div class="site-menu"><nav class="tsd-navigation"><a href="../modules.html">backtest-kit</a><ul class="tsd-small-nested-navigation" id="tsd-nav-container"><li>Loading...</li></ul></nav></div></div></div><footer><p class="tsd-generator">Generated using <a href="https://typedoc.org/" target="_blank">TypeDoc</a></p></footer><div class="overlay"></div></body></html>

<!-- Yandex.Metrika counter -->
<script type="text/javascript">
    (function(m,e,t,r,i,k,a){
        m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
        m[i].l=1*new Date();
        for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }}
        k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)
    })(window, document,'script','https://mc.yandex.ru/metrika/tag.js?id=105455585', 'ym');

    ym(105455585, 'init', {ssr:true, webvisor:true, clickmap:true, ecommerce:"dataLayer", accurateTrackBounce:true, trackLinks:true});
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/105455585" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
<!-- /Yandex.Metrika counter -->

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-3MQZEBBDDR"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-3MQZEBBDDR');
</script>
