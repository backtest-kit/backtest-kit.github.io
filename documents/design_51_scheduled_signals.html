<!DOCTYPE html><html class="default" lang="en" data-base=".."><head><meta charset="utf-8"/><meta http-equiv="x-ua-compatible" content="IE=edge"/><title>design/51_scheduled_signals | backtest-kit</title><meta name="description" content="Documentation for backtest-kit"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="stylesheet" href="../assets/style.css"/><link rel="stylesheet" href="../assets/highlight.css"/><script defer src="../assets/main.js"></script><script async src="../assets/icons.js" id="tsd-icons-script"></script><script async src="../assets/search.js" id="tsd-search-script"></script><script async src="../assets/navigation.js" id="tsd-nav-script"></script><script async src="../assets/hierarchy.js" id="tsd-hierarchy-script"></script></head><body><script>document.documentElement.dataset.theme = localStorage.getItem("tsd-theme") || "os";document.body.style.display="none";setTimeout(() => app?app.showPage():document.body.style.removeProperty("display"),500)</script><header class="tsd-page-toolbar"><div class="tsd-toolbar-contents container"><div class="table-cell" id="tsd-search"><div class="field"><label for="tsd-search-field" class="tsd-widget tsd-toolbar-icon search no-caption"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-search"></use></svg></label><input type="text" id="tsd-search-field" aria-label="Search"/></div><div class="field"><div id="tsd-toolbar-links"></div></div><ul class="results"><li class="state loading">Preparing search index...</li><li class="state failure">The search index is not available</li></ul><a href="../index.html" class="title">backtest-kit</a></div><div class="table-cell" id="tsd-widgets"><a href="#" class="tsd-widget tsd-toolbar-icon menu no-caption" data-toggle="menu" aria-label="Menu"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-menu"></use></svg></a></div></div></header><div class="container container-main"><div class="col-content"><div class="tsd-page-title"><ul class="tsd-breadcrumb"><li><a href="../modules.html">backtest-kit</a></li><li><a href="design_51_scheduled_signals.html">design/51_scheduled_signals</a></li></ul></div><div class="tsd-panel tsd-typography"><a id="scheduled-signals" class="tsd-anchor"></a><h1 class="tsd-anchor-link">Scheduled Signals<a href="#scheduled-signals" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h1><p>Scheduled signals are limit orders that wait for price to reach a specific entry point (<code>priceOpen</code>) before activating. Unlike immediate signals that open at current market price, scheduled signals remain in a &quot;scheduled&quot; state until market conditions satisfy the entry criteria or the signal is cancelled due to timeout or adverse price movement.</p>
<p>For information about the complete signal lifecycle including other states, see <a href="design_49_signal_states.html">Signal States</a>. For signal generation and validation, see <a href="design_50_signal_generation_and_validation.html">Signal Generation and Validation</a>. For persistence of scheduled signals, see <a href="design_52_signal_persistence.html">Signal Persistence</a>.</p>
<hr>
<a id="purpose-and-scope" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Purpose and Scope<a href="#purpose-and-scope" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>Scheduled signals enable strategies to implement <strong>limit order</strong> behavior, where positions open only when price reaches a favorable entry point. This contrasts with market orders that execute immediately at current price.</p>
<p><strong>Key characteristics:</strong></p>
<ul>
<li><strong>Entry delay</strong>: Signal created when <code>priceOpen</code> is specified in <code>ISignalDto</code>, but position opens only when price reaches <code>priceOpen</code></li>
<li><strong>Conditional activation</strong>: Price must reach <code>priceOpen</code> before timeout (<code>CC_SCHEDULE_AWAIT_MINUTES</code>, default 120 minutes)</li>
<li><strong>Pre-activation cancellation</strong>: Signal cancels if <code>priceStopLoss</code> is hit before <code>priceOpen</code> is reached</li>
<li><strong>Dual timestamps</strong>: <code>scheduledAt</code> (creation time) and <code>pendingAt</code> (activation time) track full lifecycle</li>
</ul>
<hr>
<a id="creating-scheduled-signals" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Creating Scheduled Signals<a href="#creating-scheduled-signals" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>A signal becomes scheduled when <code>getSignal()</code> returns an <code>ISignalDto</code> with <code>priceOpen</code> specified. The system determines scheduling based on price conditions at creation time.</p>
<a id="signal-creation-logic" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Signal Creation Logic<a href="#signal-creation-logic" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><pre><code class="typescript"><span class="hl-0">// Immediate signal (opens at current price)</span><br/><span class="hl-5">return</span><span class="hl-2"> {</span><br/><span class="hl-2">  </span><span class="hl-6">position:</span><span class="hl-2"> </span><span class="hl-4">&quot;long&quot;</span><span class="hl-2">,</span><br/><span class="hl-2">  </span><span class="hl-0">// priceOpen omitted - opens immediately</span><br/><span class="hl-2">  </span><span class="hl-6">priceTakeProfit:</span><span class="hl-2"> </span><span class="hl-7">43000</span><span class="hl-2">,</span><br/><span class="hl-2">  </span><span class="hl-6">priceStopLoss:</span><span class="hl-2"> </span><span class="hl-7">41000</span><span class="hl-2">,</span><br/><span class="hl-2">  </span><span class="hl-6">minuteEstimatedTime:</span><span class="hl-2"> </span><span class="hl-7">60</span><br/><span class="hl-2">};</span><br/><br/><span class="hl-0">// Scheduled signal (waits for priceOpen)</span><br/><span class="hl-5">return</span><span class="hl-2"> {</span><br/><span class="hl-2">  </span><span class="hl-6">position:</span><span class="hl-2"> </span><span class="hl-4">&quot;long&quot;</span><span class="hl-2">,</span><br/><span class="hl-2">  </span><span class="hl-6">priceOpen:</span><span class="hl-2"> </span><span class="hl-7">42000</span><span class="hl-2">,  </span><span class="hl-0">// Waits for price to reach 42000</span><br/><span class="hl-2">  </span><span class="hl-6">priceTakeProfit:</span><span class="hl-2"> </span><span class="hl-7">43000</span><span class="hl-2">,</span><br/><span class="hl-2">  </span><span class="hl-6">priceStopLoss:</span><span class="hl-2"> </span><span class="hl-7">41000</span><span class="hl-2">,</span><br/><span class="hl-2">  </span><span class="hl-6">minuteEstimatedTime:</span><span class="hl-2"> </span><span class="hl-7">60</span><br/><span class="hl-2">};</span>
</code><button type="button">Copy</button></pre>

<a id="immediate-activation-check" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Immediate Activation Check<a href="#immediate-activation-check" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>When <code>priceOpen</code> is provided, the system checks if it should activate immediately or wait:</p>
<table>
<thead>
<tr>
<th>Position</th>
<th>Condition for Immediate Activation</th>
<th>Behavior</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>long</code></td>
<td><code>currentPrice &lt;= priceOpen</code></td>
<td>Price already low enough, activate immediately</td>
</tr>
<tr>
<td><code>short</code></td>
<td><code>currentPrice &gt;= priceOpen</code></td>
<td>Price already high enough, activate immediately</td>
</tr>
</tbody>
</table>
<p>If immediate activation conditions are met, the signal transitions directly to &quot;opened&quot; state, skipping the &quot;scheduled&quot; phase.</p>
<hr>
<a id="scheduled-signal-lifecycle" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Scheduled Signal Lifecycle<a href="#scheduled-signal-lifecycle" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p><img src="../media/51_Scheduled_Signals_0.svg" alt="Mermaid Diagram"></p>
<p><strong>Key state transitions:</strong></p>
<ol>
<li><strong>Scheduled → Pending</strong>: Price reaches <code>priceOpen</code> and risk checks pass</li>
<li><strong>Scheduled → Cancelled (Timeout)</strong>: Waiting time exceeds <code>CC_SCHEDULE_AWAIT_MINUTES</code></li>
<li><strong>Scheduled → Cancelled (StopLoss)</strong>: <code>priceStopLoss</code> hit before <code>priceOpen</code> reached</li>
<li><strong>Scheduled → Cancelled (Risk)</strong>: Price reaches <code>priceOpen</code> but risk validation rejects activation</li>
</ol>
<hr>
<a id="activation-logic" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Activation Logic<a href="#activation-logic" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><a id="price-based-activation-conditions" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Price-Based Activation Conditions<a href="#price-based-activation-conditions" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Scheduled signals activate when market price reaches the specified <code>priceOpen</code>. The activation logic differs by position type:</p>
<p><img src="../media/51_Scheduled_Signals_1.svg" alt="Mermaid Diagram"></p>
<a id="activation-priority" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Activation Priority<a href="#activation-priority" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><strong>Critical ordering:</strong> StopLoss check has <strong>priority</strong> over activation check. This prevents opening positions that would immediately lose money.</p>
<pre><code class="typescript"><span class="hl-0">// LONG position checks (from CHECK_SCHEDULED_SIGNAL_PRICE_ACTIVATION_FN)</span><br/><span class="hl-5">if</span><span class="hl-2"> (</span><span class="hl-6">scheduled</span><span class="hl-2">.</span><span class="hl-6">position</span><span class="hl-2"> === </span><span class="hl-4">&quot;long&quot;</span><span class="hl-2">) {</span><br/><span class="hl-2">  </span><span class="hl-0">// 1. Check StopLoss FIRST (cancellation takes priority)</span><br/><span class="hl-2">  </span><span class="hl-5">if</span><span class="hl-2"> (</span><span class="hl-6">currentPrice</span><span class="hl-2"> &lt;= </span><span class="hl-6">scheduled</span><span class="hl-2">.</span><span class="hl-6">priceStopLoss</span><span class="hl-2">) {</span><br/><span class="hl-2">    </span><span class="hl-6">shouldCancel</span><span class="hl-2"> = </span><span class="hl-3">true</span><span class="hl-2">;</span><br/><span class="hl-2">  }</span><br/><span class="hl-2">  </span><span class="hl-0">// 2. Check activation only if StopLoss NOT hit</span><br/><span class="hl-2">  </span><span class="hl-5">else</span><span class="hl-2"> </span><span class="hl-5">if</span><span class="hl-2"> (</span><span class="hl-6">currentPrice</span><span class="hl-2"> &lt;= </span><span class="hl-6">scheduled</span><span class="hl-2">.</span><span class="hl-6">priceOpen</span><span class="hl-2">) {</span><br/><span class="hl-2">    </span><span class="hl-6">shouldActivate</span><span class="hl-2"> = </span><span class="hl-3">true</span><span class="hl-2">;</span><br/><span class="hl-2">  }</span><br/><span class="hl-2">}</span><br/><br/><span class="hl-0">// SHORT position checks</span><br/><span class="hl-5">if</span><span class="hl-2"> (</span><span class="hl-6">scheduled</span><span class="hl-2">.</span><span class="hl-6">position</span><span class="hl-2"> === </span><span class="hl-4">&quot;short&quot;</span><span class="hl-2">) {</span><br/><span class="hl-2">  </span><span class="hl-0">// 1. Check StopLoss FIRST</span><br/><span class="hl-2">  </span><span class="hl-5">if</span><span class="hl-2"> (</span><span class="hl-6">currentPrice</span><span class="hl-2"> &gt;= </span><span class="hl-6">scheduled</span><span class="hl-2">.</span><span class="hl-6">priceStopLoss</span><span class="hl-2">) {</span><br/><span class="hl-2">    </span><span class="hl-6">shouldCancel</span><span class="hl-2"> = </span><span class="hl-3">true</span><span class="hl-2">;</span><br/><span class="hl-2">  }</span><br/><span class="hl-2">  </span><span class="hl-0">// 2. Check activation only if StopLoss NOT hit</span><br/><span class="hl-2">  </span><span class="hl-5">else</span><span class="hl-2"> </span><span class="hl-5">if</span><span class="hl-2"> (</span><span class="hl-6">currentPrice</span><span class="hl-2"> &gt;= </span><span class="hl-6">scheduled</span><span class="hl-2">.</span><span class="hl-6">priceOpen</span><span class="hl-2">) {</span><br/><span class="hl-2">    </span><span class="hl-6">shouldActivate</span><span class="hl-2"> = </span><span class="hl-3">true</span><span class="hl-2">;</span><br/><span class="hl-2">  }</span><br/><span class="hl-2">}</span>
</code><button type="button">Copy</button></pre>

<a id="activation-timestamp-handling" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Activation Timestamp Handling<a href="#activation-timestamp-handling" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>When activation occurs, <code>pendingAt</code> is updated to reflect the actual activation time:</p>
<table>
<thead>
<tr>
<th>Mode</th>
<th>Activation Timestamp</th>
<th>Rationale</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Backtest</strong></td>
<td><code>candle.timestamp + 60000</code></td>
<td>Next candle after activation candle (precise timing)</td>
</tr>
<tr>
<td><strong>Live</strong></td>
<td><code>Date.now()</code></td>
<td>Current time when activation detected (approximate timing)</td>
</tr>
</tbody>
</table>
<hr>
<a id="cancellation-logic" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Cancellation Logic<a href="#cancellation-logic" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>Scheduled signals can be cancelled without opening a position in two scenarios: timeout or pre-activation StopLoss hit.</p>
<a id="timeout-cancellation" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Timeout Cancellation<a href="#timeout-cancellation" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Scheduled signals have a maximum waiting period defined by <code>CC_SCHEDULE_AWAIT_MINUTES</code> (default: 120 minutes). If <code>priceOpen</code> is not reached within this period, the signal is cancelled.</p>
<pre><code class="typescript"><span class="hl-0">// Timeout calculation (from CHECK_SCHEDULED_SIGNAL_TIMEOUT_FN)</span><br/><span class="hl-3">const</span><span class="hl-2"> </span><span class="hl-8">currentTime</span><span class="hl-2"> = </span><span class="hl-6">execution</span><span class="hl-2">.</span><span class="hl-6">context</span><span class="hl-2">.</span><span class="hl-6">when</span><span class="hl-2">.</span><span class="hl-1">getTime</span><span class="hl-2">();</span><br/><span class="hl-3">const</span><span class="hl-2"> </span><span class="hl-8">signalTime</span><span class="hl-2"> = </span><span class="hl-6">scheduled</span><span class="hl-2">.</span><span class="hl-6">scheduledAt</span><span class="hl-2">;</span><br/><span class="hl-3">const</span><span class="hl-2"> </span><span class="hl-8">maxTimeToWait</span><span class="hl-2"> = </span><span class="hl-8">CC_SCHEDULE_AWAIT_MINUTES</span><span class="hl-2"> * </span><span class="hl-7">60</span><span class="hl-2"> * </span><span class="hl-7">1000</span><span class="hl-2">;</span><br/><span class="hl-3">const</span><span class="hl-2"> </span><span class="hl-8">elapsedTime</span><span class="hl-2"> = </span><span class="hl-6">currentTime</span><span class="hl-2"> - </span><span class="hl-6">signalTime</span><span class="hl-2">;</span><br/><br/><span class="hl-5">if</span><span class="hl-2"> (</span><span class="hl-6">elapsedTime</span><span class="hl-2"> &gt;= </span><span class="hl-6">maxTimeToWait</span><span class="hl-2">) {</span><br/><span class="hl-2">  </span><span class="hl-0">// Cancel signal, emit IStrategyTickResultCancelled</span><br/><span class="hl-2">  </span><span class="hl-5">await</span><span class="hl-2"> </span><span class="hl-1">setScheduledSignal</span><span class="hl-2">(</span><span class="hl-3">null</span><span class="hl-2">);</span><br/><span class="hl-2">}</span>
</code><button type="button">Copy</button></pre>

<p><strong>Timeout characteristics:</strong></p>
<ul>
<li><strong>Grace period</strong>: 120 minutes by default, configurable via <code>setConfig()</code></li>
<li><strong>Boundary behavior</strong>: Cancellation occurs when <code>elapsedTime &gt;= maxTimeToWait</code> (inclusive)</li>
<li><strong>No PNL impact</strong>: Cancelled signals do not affect profit/loss calculations</li>
<li><strong>Risk release</strong>: Cancellation frees up risk limits for new signals</li>
</ul>
<a id="stoploss-pre-activation-cancellation" class="tsd-anchor"></a><h3 class="tsd-anchor-link">StopLoss Pre-Activation Cancellation<a href="#stoploss-pre-activation-cancellation" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>If price moves against the position and hits <code>priceStopLoss</code> <strong>before</strong> reaching <code>priceOpen</code>, the scheduled signal is cancelled. This prevents opening positions that are already in a losing state.</p>
<p><img src="../media/51_Scheduled_Signals_2.svg" alt="Mermaid Diagram"></p>
<p><strong>Pre-activation cancellation is critical</strong> because it prevents the following scenario:</p>
<ol>
<li>LONG scheduled at priceOpen=42000, StopLoss=40000</li>
<li>Price drops directly from 45000 to 39000, <strong>skipping priceOpen</strong></li>
<li>Without cancellation: Signal would activate at 42000, immediately close at 40000 (instant loss)</li>
<li>With cancellation: Signal cancelled at 40000, no position opened (no loss)</li>
</ol>
<hr>
<a id="timestamps-and-duration-tracking" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Timestamps and Duration Tracking<a href="#timestamps-and-duration-tracking" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>Scheduled signals maintain two distinct timestamps that track the full lifecycle from creation to activation:</p>
<table>
<thead>
<tr>
<th>Timestamp</th>
<th>Set At</th>
<th>Purpose</th>
<th>Persists After Activation</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>scheduledAt</code></td>
<td>Signal creation in <code>GET_SIGNAL_FN</code></td>
<td>Records when strategy first generated the signal</td>
<td>✅ Yes (unchanged)</td>
</tr>
<tr>
<td><code>pendingAt</code></td>
<td>Initial: equals <code>scheduledAt</code><br/>Final: activation time</td>
<td>Temporary placeholder until activation, then updated to actual activation time</td>
<td>✅ Yes (updated)</td>
</tr>
</tbody>
</table>
<a id="duration-calculations" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Duration Calculations<a href="#duration-calculations" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>The dual-timestamp system enables accurate duration tracking:</p>
<pre><code class="typescript"><span class="hl-0">// Timeout calculation: uses scheduledAt</span><br/><span class="hl-3">const</span><span class="hl-2"> </span><span class="hl-8">waitingTime</span><span class="hl-2"> = </span><span class="hl-6">currentTime</span><span class="hl-2"> - </span><span class="hl-6">scheduledAt</span><span class="hl-2">;</span><br/><span class="hl-5">if</span><span class="hl-2"> (</span><span class="hl-6">waitingTime</span><span class="hl-2"> &gt;= </span><span class="hl-8">CC_SCHEDULE_AWAIT_MINUTES</span><span class="hl-2"> * </span><span class="hl-7">60000</span><span class="hl-2">) {</span><br/><span class="hl-2">  </span><span class="hl-0">// Cancel after 120 minutes of waiting</span><br/><span class="hl-2">}</span><br/><br/><span class="hl-0">// Signal lifetime calculation: uses pendingAt</span><br/><span class="hl-3">const</span><span class="hl-2"> </span><span class="hl-8">activeTime</span><span class="hl-2"> = </span><span class="hl-6">closeTime</span><span class="hl-2"> - </span><span class="hl-6">pendingAt</span><span class="hl-2">;</span><br/><span class="hl-5">if</span><span class="hl-2"> (</span><span class="hl-6">activeTime</span><span class="hl-2"> &gt;= </span><span class="hl-6">minuteEstimatedTime</span><span class="hl-2"> * </span><span class="hl-7">60000</span><span class="hl-2">) {</span><br/><span class="hl-2">  </span><span class="hl-0">// Close by time_expired</span><br/><span class="hl-2">}</span>
</code><button type="button">Copy</button></pre>

<a id="why-two-timestamps-matter" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Why Two Timestamps Matter<a href="#why-two-timestamps-matter" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><strong>Without separate timestamps:</strong></p>
<ul>
<li>Cannot distinguish between &quot;time waiting for activation&quot; and &quot;time in active position&quot;</li>
<li><code>minuteEstimatedTime</code> would include waiting period, causing premature time_expired closures</li>
<li>Backtest statistics would be skewed by activation delays</li>
</ul>
<p><strong>With separate timestamps:</strong></p>
<ul>
<li><code>scheduledAt</code> tracks total signal lifetime (creation → closure)</li>
<li><code>pendingAt</code> tracks active position lifetime (activation → closure)</li>
<li><code>minuteEstimatedTime</code> only counts against <code>pendingAt</code>, not <code>scheduledAt</code></li>
</ul>
<a id="timestamp-update-on-activation" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Timestamp Update on Activation<a href="#timestamp-update-on-activation" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><pre><code class="typescript"><span class="hl-0">// From ACTIVATE_SCHEDULED_SIGNAL_FN</span><br/><span class="hl-3">const</span><span class="hl-2"> </span><span class="hl-8">activationTime</span><span class="hl-2"> = </span><span class="hl-6">activationTimestamp</span><span class="hl-2">;</span><br/><br/><span class="hl-0">// Create activated signal with updated pendingAt</span><br/><span class="hl-3">const</span><span class="hl-2"> </span><span class="hl-8">activatedSignal</span><span class="hl-2">: </span><span class="hl-11">ISignalRow</span><span class="hl-2"> = {</span><br/><span class="hl-2">  ...</span><span class="hl-6">scheduled</span><span class="hl-2">,</span><br/><span class="hl-2">  </span><span class="hl-6">pendingAt:</span><span class="hl-2"> </span><span class="hl-6">activationTime</span><span class="hl-2">,  </span><span class="hl-0">// UPDATED from scheduledAt</span><br/><span class="hl-2">  </span><span class="hl-6">_isScheduled:</span><span class="hl-2"> </span><span class="hl-3">false</span><span class="hl-2">,</span><br/><span class="hl-2">};</span><br/><br/><span class="hl-5">await</span><span class="hl-2"> </span><span class="hl-1">setPendingSignal</span><span class="hl-2">(</span><span class="hl-6">activatedSignal</span><span class="hl-2">);</span>
</code><button type="button">Copy</button></pre>

<hr>
<a id="persistence-and-crash-recovery" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Persistence and Crash Recovery<a href="#persistence-and-crash-recovery" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>Scheduled signals are persisted to disk using <code>PersistScheduleAdapter</code>, enabling crash recovery for live trading. This is separate from <code>PersistSignalAdapter</code> (for active positions).</p>
<a id="persistence-architecture" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Persistence Architecture<a href="#persistence-architecture" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><img src="../media/51_Scheduled_Signals_3.svg" alt="Mermaid Diagram"></p>
<a id="file-structure" class="tsd-anchor"></a><h3 class="tsd-anchor-link">File Structure<a href="#file-structure" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Scheduled signals are stored separately from active signals:</p>
<pre><code><span class="hl-2">./</span><span class="hl-6">dump</span><span class="hl-2">/</span><span class="hl-6">data</span><span class="hl-2">/</span><br/><span class="hl-2">├── </span><span class="hl-6">schedule</span><span class="hl-2">/</span><br/><span class="hl-2">│   ├── </span><span class="hl-6">my</span><span class="hl-2">-</span><span class="hl-6">strategy</span><span class="hl-2">/</span><br/><span class="hl-2">│   │   ├── </span><span class="hl-8">BTCUSDT</span><span class="hl-2">.</span><span class="hl-6">json</span><span class="hl-2">      # </span><span class="hl-6">Scheduled</span><span class="hl-2"> </span><span class="hl-6">signal</span><span class="hl-2"> </span><span class="hl-6">for</span><span class="hl-2"> </span><span class="hl-8">BTCUSDT</span><br/><span class="hl-2">│   │   └── </span><span class="hl-8">ETHUSDT</span><span class="hl-2">.</span><span class="hl-6">json</span><span class="hl-2">      # </span><span class="hl-6">Scheduled</span><span class="hl-2"> </span><span class="hl-6">signal</span><span class="hl-2"> </span><span class="hl-6">for</span><span class="hl-2"> </span><span class="hl-8">ETHUSDT</span><br/><span class="hl-2">│   └── </span><span class="hl-6">another</span><span class="hl-2">-</span><span class="hl-6">strategy</span><span class="hl-2">/</span><br/><span class="hl-2">│       └── </span><span class="hl-8">BTCUSDT</span><span class="hl-2">.</span><span class="hl-6">json</span><br/><span class="hl-2">└── </span><span class="hl-6">signal</span><span class="hl-2">/</span><br/><span class="hl-2">    ├── </span><span class="hl-6">my</span><span class="hl-2">-</span><span class="hl-6">strategy</span><span class="hl-2">/</span><br/><span class="hl-2">    │   └── </span><span class="hl-8">BTCUSDT</span><span class="hl-2">.</span><span class="hl-6">json</span><span class="hl-2">      # </span><span class="hl-6">Active</span><span class="hl-2"> </span><span class="hl-1">position</span><span class="hl-2"> (</span><span class="hl-6">after</span><span class="hl-2"> </span><span class="hl-6">activation</span><span class="hl-2">)</span><br/><span class="hl-2">    └── </span><span class="hl-6">another</span><span class="hl-2">-</span><span class="hl-6">strategy</span><span class="hl-2">/</span><br/><span class="hl-2">        └── </span><span class="hl-8">BTCUSDT</span><span class="hl-2">.</span><span class="hl-6">json</span>
</code><button>Copy</button></pre>

<a id="crash-recovery-flow" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Crash Recovery Flow<a href="#crash-recovery-flow" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><ol>
<li><strong>Live trading running</strong>: Scheduled signal waiting for activation at <code>priceOpen=42000</code></li>
<li><strong>Process crashes</strong>: Signal state is on disk in <code>./dump/data/schedule/my-strategy/BTCUSDT.json</code></li>
<li><strong>Process restarts</strong>: <code>Live.background()</code> called again</li>
<li><strong>Restore scheduled signal</strong>: <code>WAIT_FOR_INIT_FN</code> loads from <code>PersistScheduleAdapter</code></li>
<li><strong>Resume monitoring</strong>: Signal continues waiting for <code>priceOpen=42000</code></li>
<li><strong>Activation</strong>: When price reaches 42000, signal moves to <code>PersistSignalAdapter</code></li>
</ol>
<a id="persistence-implementation-details" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Persistence Implementation Details<a href="#persistence-implementation-details" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><table>
<thead>
<tr>
<th>Operation</th>
<th>Function</th>
<th>File</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>Write scheduled</td>
<td><code>setScheduledSignal(signal)</code></td>
<td><a href="">src/client/ClientStrategy.ts:863-881</a></td>
<td>Atomically write scheduled signal to disk</td>
</tr>
<tr>
<td>Read scheduled</td>
<td><code>readScheduleData()</code></td>
<td><a href="">src/classes/Persist.ts</a></td>
<td>Load scheduled signal on restart</td>
</tr>
<tr>
<td>Delete scheduled</td>
<td><code>setScheduledSignal(null)</code></td>
<td><a href="">src/client/ClientStrategy.ts:863-881</a></td>
<td>Remove scheduled signal after activation/cancellation</td>
</tr>
<tr>
<td>Restore on init</td>
<td><code>WAIT_FOR_INIT_FN</code></td>
<td><a href="">src/client/ClientStrategy.ts:525-551</a></td>
<td>Load scheduled signal from disk on <code>waitForInit()</code></td>
</tr>
</tbody>
</table>
<hr>
<a id="validation-rules" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Validation Rules<a href="#validation-rules" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>Scheduled signals undergo <strong>additional validation</strong> beyond immediate signals because they must remain valid during the waiting period.</p>
<a id="scheduled-specific-validations" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Scheduled-Specific Validations<a href="#scheduled-specific-validations" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><img src="../media/51_Scheduled_Signals_4.svg" alt="Mermaid Diagram"></p>
<a id="critical-validation-position-validity-at-priceopen" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Critical Validation: Position Validity at priceOpen<a href="#critical-validation-position-validity-at-priceopen" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>For LONG positions:</p>
<pre><code class="typescript"><span class="hl-0">// priceOpen must be BETWEEN SL and TP</span><br/><span class="hl-5">if</span><span class="hl-2"> (</span><span class="hl-6">signal</span><span class="hl-2">.</span><span class="hl-6">priceOpen</span><span class="hl-2"> &lt;= </span><span class="hl-6">signal</span><span class="hl-2">.</span><span class="hl-6">priceStopLoss</span><span class="hl-2">) {</span><br/><span class="hl-2">  </span><span class="hl-5">throw</span><span class="hl-2"> </span><span class="hl-3">new</span><span class="hl-2"> </span><span class="hl-1">Error</span><span class="hl-2">(</span><br/><span class="hl-2">    </span><span class="hl-4">`Long scheduled: priceOpen (</span><span class="hl-3">${</span><span class="hl-6">signal</span><span class="hl-9">.</span><span class="hl-6">priceOpen</span><span class="hl-3">}</span><span class="hl-4">) &lt;= priceStopLoss (</span><span class="hl-3">${</span><span class="hl-6">signal</span><span class="hl-9">.</span><span class="hl-6">priceStopLoss</span><span class="hl-3">}</span><span class="hl-4">). `</span><span class="hl-2"> +</span><br/><span class="hl-2">    </span><span class="hl-4">`Signal would be immediately cancelled on activation.`</span><br/><span class="hl-2">  );</span><br/><span class="hl-2">}</span><br/><br/><span class="hl-5">if</span><span class="hl-2"> (</span><span class="hl-6">signal</span><span class="hl-2">.</span><span class="hl-6">priceOpen</span><span class="hl-2"> &gt;= </span><span class="hl-6">signal</span><span class="hl-2">.</span><span class="hl-6">priceTakeProfit</span><span class="hl-2">) {</span><br/><span class="hl-2">  </span><span class="hl-5">throw</span><span class="hl-2"> </span><span class="hl-3">new</span><span class="hl-2"> </span><span class="hl-1">Error</span><span class="hl-2">(</span><br/><span class="hl-2">    </span><span class="hl-4">`Long scheduled: priceOpen (</span><span class="hl-3">${</span><span class="hl-6">signal</span><span class="hl-9">.</span><span class="hl-6">priceOpen</span><span class="hl-3">}</span><span class="hl-4">) &gt;= priceTakeProfit (</span><span class="hl-3">${</span><span class="hl-6">signal</span><span class="hl-9">.</span><span class="hl-6">priceTakeProfit</span><span class="hl-3">}</span><span class="hl-4">). `</span><span class="hl-2"> +</span><br/><span class="hl-2">    </span><span class="hl-4">`Signal would close immediately on activation. This is logically impossible for LONG position.`</span><br/><span class="hl-2">  );</span><br/><span class="hl-2">}</span>
</code><button type="button">Copy</button></pre>

<p>For SHORT positions:</p>
<pre><code class="typescript"><span class="hl-0">// priceOpen must be BETWEEN TP and SL</span><br/><span class="hl-5">if</span><span class="hl-2"> (</span><span class="hl-6">signal</span><span class="hl-2">.</span><span class="hl-6">priceOpen</span><span class="hl-2"> &gt;= </span><span class="hl-6">signal</span><span class="hl-2">.</span><span class="hl-6">priceStopLoss</span><span class="hl-2">) {</span><br/><span class="hl-2">  </span><span class="hl-5">throw</span><span class="hl-2"> </span><span class="hl-3">new</span><span class="hl-2"> </span><span class="hl-1">Error</span><span class="hl-2">(</span><br/><span class="hl-2">    </span><span class="hl-4">`Short scheduled: priceOpen (</span><span class="hl-3">${</span><span class="hl-6">signal</span><span class="hl-9">.</span><span class="hl-6">priceOpen</span><span class="hl-3">}</span><span class="hl-4">) &gt;= priceStopLoss (</span><span class="hl-3">${</span><span class="hl-6">signal</span><span class="hl-9">.</span><span class="hl-6">priceStopLoss</span><span class="hl-3">}</span><span class="hl-4">). `</span><span class="hl-2"> +</span><br/><span class="hl-2">    </span><span class="hl-4">`Signal would be immediately cancelled on activation.`</span><br/><span class="hl-2">  );</span><br/><span class="hl-2">}</span><br/><br/><span class="hl-5">if</span><span class="hl-2"> (</span><span class="hl-6">signal</span><span class="hl-2">.</span><span class="hl-6">priceOpen</span><span class="hl-2"> &lt;= </span><span class="hl-6">signal</span><span class="hl-2">.</span><span class="hl-6">priceTakeProfit</span><span class="hl-2">) {</span><br/><span class="hl-2">  </span><span class="hl-5">throw</span><span class="hl-2"> </span><span class="hl-3">new</span><span class="hl-2"> </span><span class="hl-1">Error</span><span class="hl-2">(</span><br/><span class="hl-2">    </span><span class="hl-4">`Short scheduled: priceOpen (</span><span class="hl-3">${</span><span class="hl-6">signal</span><span class="hl-9">.</span><span class="hl-6">priceOpen</span><span class="hl-3">}</span><span class="hl-4">) &lt;= priceTakeProfit (</span><span class="hl-3">${</span><span class="hl-6">signal</span><span class="hl-9">.</span><span class="hl-6">priceTakeProfit</span><span class="hl-3">}</span><span class="hl-4">). `</span><span class="hl-2"> +</span><br/><span class="hl-2">    </span><span class="hl-4">`Signal would close immediately on activation. This is logically impossible for SHORT position.`</span><br/><span class="hl-2">  );</span><br/><span class="hl-2">}</span>
</code><button type="button">Copy</button></pre>

<a id="validation-error-messages" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Validation Error Messages<a href="#validation-error-messages" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><table>
<thead>
<tr>
<th>Validation</th>
<th>Error Message</th>
<th>Prevention</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>priceOpen</code> not finite</td>
<td><code>priceOpen must be a finite number, got NaN</code></td>
<td>Prevents math errors during price checks</td>
</tr>
<tr>
<td><code>priceOpen &lt;= 0</code></td>
<td><code>priceOpen must be positive, got -100</code></td>
<td>Prevents invalid negative prices</td>
</tr>
<tr>
<td>LONG: <code>priceOpen &lt;= priceStopLoss</code></td>
<td><code>Signal would be immediately cancelled on activation</code></td>
<td>Prevents instant cancellation after activation</td>
</tr>
<tr>
<td>LONG: <code>priceOpen &gt;= priceTakeProfit</code></td>
<td><code>Signal would close immediately on activation</code></td>
<td>Prevents impossible LONG logic</td>
</tr>
<tr>
<td>SHORT: <code>priceOpen &gt;= priceStopLoss</code></td>
<td><code>Signal would be immediately cancelled on activation</code></td>
<td>Prevents instant cancellation after activation</td>
</tr>
<tr>
<td>SHORT: <code>priceOpen &lt;= priceTakeProfit</code></td>
<td><code>Signal would close immediately on activation</code></td>
<td>Prevents impossible SHORT logic</td>
</tr>
</tbody>
</table>
<hr>
<a id="edge-cases-and-critical-behaviors" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Edge Cases and Critical Behaviors<a href="#edge-cases-and-critical-behaviors" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><a id="edge-case-1-activation-and-immediate-closure-on-same-candle" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Edge Case 1: Activation and Immediate Closure on Same Candle<a href="#edge-case-1-activation-and-immediate-closure-on-same-candle" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><strong>Scenario:</strong> Scheduled signal activates AND reaches TP/SL within the same 1-minute candle.</p>
<pre><code><span class="hl-10">Candle</span><span class="hl-2">: </span><span class="hl-6">open</span><span class="hl-2">=</span><span class="hl-7">43000</span><span class="hl-2">, </span><span class="hl-6">high</span><span class="hl-2">=</span><span class="hl-7">43000</span><span class="hl-2">, </span><span class="hl-6">low</span><span class="hl-2">=</span><span class="hl-7">40500</span><span class="hl-2">, </span><span class="hl-6">close</span><span class="hl-2">=</span><span class="hl-7">42500</span><br/><span class="hl-10">LONG</span><span class="hl-2">: </span><span class="hl-6">priceOpen</span><span class="hl-2">=</span><span class="hl-7">41000</span><span class="hl-2">, </span><span class="hl-6">priceTakeProfit</span><span class="hl-2">=</span><span class="hl-7">42000</span><span class="hl-2">, </span><span class="hl-6">priceStopLoss</span><span class="hl-2">=</span><span class="hl-7">39000</span><br/><br/><span class="hl-10">Sequence</span><span class="hl-2">:</span><br/><span class="hl-7">1.</span><span class="hl-2"> </span><span class="hl-6">Low</span><span class="hl-2">=</span><span class="hl-7">40500</span><span class="hl-2"> </span><span class="hl-6">touches</span><span class="hl-2"> </span><span class="hl-6">priceOpen</span><span class="hl-2">=</span><span class="hl-7">41000</span><span class="hl-2"> → </span><span class="hl-6">Signal</span><span class="hl-2"> </span><span class="hl-8">ACTIVATES</span><br/><span class="hl-7">2.</span><span class="hl-2"> </span><span class="hl-6">Close</span><span class="hl-2">=</span><span class="hl-7">42500</span><span class="hl-2"> </span><span class="hl-6">above</span><span class="hl-2"> </span><span class="hl-6">priceTakeProfit</span><span class="hl-2">=</span><span class="hl-7">42000</span><span class="hl-2"> → </span><span class="hl-6">Signal</span><span class="hl-2"> </span><span class="hl-8">CLOSES</span><span class="hl-2"> </span><span class="hl-6">by</span><span class="hl-2"> </span><span class="hl-8">TP</span><br/><span class="hl-7">3.</span><span class="hl-2"> </span><span class="hl-6">Both</span><span class="hl-2"> </span><span class="hl-6">occur</span><span class="hl-2"> </span><span class="hl-6">within</span><span class="hl-2"> </span><span class="hl-6">same</span><span class="hl-2"> </span><span class="hl-6">candle</span><span class="hl-2"> </span><span class="hl-6">timestamp</span>
</code><button>Copy</button></pre>

<p><strong>Behavior:</strong></p>
<ul>
<li>Signal emits <code>IStrategyTickResultOpened</code> (activation)</li>
<li>Signal emits <code>IStrategyTickResultClosed</code> with <code>closeReason=&quot;take_profit&quot;</code> (immediate closure)</li>
<li><code>scheduledAt</code> != <code>pendingAt</code> (different timestamps maintained)</li>
<li>PNL calculated correctly with fees and slippage</li>
</ul>
<a id="edge-case-2-price-crosses-both-tp-and-sl-on-same-candle-after-activation" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Edge Case 2: Price Crosses Both TP and SL on Same Candle (After Activation)<a href="#edge-case-2-price-crosses-both-tp-and-sl-on-same-candle-after-activation" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><strong>Scenario:</strong> Extreme volatility causes candle to cross both TP and SL after activation.</p>
<pre><code><span class="hl-10">LONG</span><span class="hl-2">: </span><span class="hl-6">priceOpen</span><span class="hl-2">=</span><span class="hl-7">42000</span><span class="hl-2">, </span><span class="hl-6">priceTakeProfit</span><span class="hl-2">=</span><span class="hl-7">43000</span><span class="hl-2">, </span><span class="hl-6">priceStopLoss</span><span class="hl-2">=</span><span class="hl-7">41000</span><br/><span class="hl-6">Volatile</span><span class="hl-2"> </span><span class="hl-10">candle</span><span class="hl-2">: </span><span class="hl-6">open</span><span class="hl-2">=</span><span class="hl-7">42000</span><span class="hl-2">, </span><span class="hl-6">high</span><span class="hl-2">=</span><span class="hl-7">43500</span><span class="hl-2">, </span><span class="hl-6">low</span><span class="hl-2">=</span><span class="hl-7">40500</span><span class="hl-2">, </span><span class="hl-6">close</span><span class="hl-2">=</span><span class="hl-7">42000</span><br/><br/><span class="hl-6">Price</span><span class="hl-2"> </span><span class="hl-1">path</span><span class="hl-2"> (</span><span class="hl-6">inferred</span><span class="hl-2">):</span><br/><span class="hl-7">1.</span><span class="hl-2"> </span><span class="hl-6">Opens</span><span class="hl-2"> </span><span class="hl-6">at</span><span class="hl-2"> </span><span class="hl-7">42000</span><span class="hl-2"> (</span><span class="hl-6">position</span><span class="hl-2"> </span><span class="hl-6">active</span><span class="hl-2">)</span><br/><span class="hl-7">2.</span><span class="hl-2"> </span><span class="hl-6">Rises</span><span class="hl-2"> </span><span class="hl-6">to</span><span class="hl-2"> </span><span class="hl-7">43500</span><span class="hl-2"> (</span><span class="hl-6">above</span><span class="hl-2"> </span><span class="hl-8">TP</span><span class="hl-2">=</span><span class="hl-7">43000</span><span class="hl-2">)</span><br/><span class="hl-7">3.</span><span class="hl-2"> </span><span class="hl-6">Falls</span><span class="hl-2"> </span><span class="hl-6">to</span><span class="hl-2"> </span><span class="hl-7">40500</span><span class="hl-2"> (</span><span class="hl-6">below</span><span class="hl-2"> </span><span class="hl-8">SL</span><span class="hl-2">=</span><span class="hl-7">41000</span><span class="hl-2">)</span>
</code><button>Copy</button></pre>

<p><strong>Behavior:</strong></p>
<ul>
<li><strong>TakeProfit has priority</strong>: Signal closes by <code>take_profit</code></li>
<li>Rationale: When both TP and SL are hit, TP is assumed to have occurred first during the candle</li>
<li>This is a conservative assumption favoring profitable outcomes</li>
<li>In backtest mode, this behavior is deterministic</li>
</ul>
<a id="edge-case-3-multiple-scheduled-signals-on-same-symbol" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Edge Case 3: Multiple Scheduled Signals on Same Symbol<a href="#edge-case-3-multiple-scheduled-signals-on-same-symbol" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><strong>Scenario:</strong> Strategy generates multiple scheduled signals before the first activates.</p>
<pre><code><span class="hl-6">Time</span><span class="hl-2"> </span><span class="hl-10">T0</span><span class="hl-2">: </span><span class="hl-6">Signal1</span><span class="hl-2"> </span><span class="hl-1">scheduled</span><span class="hl-2"> (</span><span class="hl-6">priceOpen</span><span class="hl-2">=</span><span class="hl-7">41000</span><span class="hl-2">)</span><br/><span class="hl-6">Time</span><span class="hl-2"> </span><span class="hl-10">T1</span><span class="hl-2">: </span><span class="hl-6">Signal2</span><span class="hl-2"> </span><span class="hl-1">scheduled</span><span class="hl-2"> (</span><span class="hl-6">priceOpen</span><span class="hl-2">=</span><span class="hl-7">40500</span><span class="hl-2">)</span><br/><span class="hl-6">Time</span><span class="hl-2"> </span><span class="hl-10">T2</span><span class="hl-2">: </span><span class="hl-6">Signal3</span><span class="hl-2"> </span><span class="hl-1">scheduled</span><span class="hl-2"> (</span><span class="hl-6">priceOpen</span><span class="hl-2">=</span><span class="hl-7">40000</span><span class="hl-2">)</span>
</code><button>Copy</button></pre>

<p><strong>Behavior:</strong></p>
<ul>
<li><strong>Only one scheduled signal per symbol/strategy</strong>: New scheduled signal <strong>overwrites</strong> previous scheduled signal</li>
<li>Implementation: <code>PersistScheduleAdapter</code> stores single signal per <code>{strategyName, symbol}</code> key</li>
<li>Risk limits prevent multiple simultaneous active positions</li>
<li>Signals must queue: First signal activates → closes → Second signal can activate</li>
</ul>
<p><strong>Critical protection:</strong> Prevents leveraging portfolio beyond risk limits.</p>
<a id="edge-case-4-impossible-limit-order-cancellation" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Edge Case 4: Impossible Limit Order Cancellation<a href="#edge-case-4-impossible-limit-order-cancellation" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><strong>Scenario:</strong> LONG limit order where priceOpen is reached <strong>before</strong> StopLoss.</p>
<pre><code><span class="hl-10">LONG</span><span class="hl-2">: </span><span class="hl-6">priceOpen</span><span class="hl-2">=</span><span class="hl-7">41000</span><span class="hl-2">, </span><span class="hl-6">priceStopLoss</span><span class="hl-2">=</span><span class="hl-7">40000</span><br/><span class="hl-6">Price</span><span class="hl-2"> </span><span class="hl-6">drops</span><span class="hl-2"> </span><span class="hl-6">from</span><span class="hl-2"> </span><span class="hl-7">43000</span><span class="hl-2">:</span><br/><span class="hl-2">- </span><span class="hl-6">At</span><span class="hl-2"> </span><span class="hl-7">41000</span><span class="hl-2">: </span><span class="hl-6">priceOpen</span><span class="hl-2"> </span><span class="hl-6">reached</span><span class="hl-2"> → </span><span class="hl-6">Signal</span><span class="hl-2"> </span><span class="hl-8">ACTIVATES</span><br/><span class="hl-2">- </span><span class="hl-6">At</span><span class="hl-2"> </span><span class="hl-7">40000</span><span class="hl-2">: </span><span class="hl-6">priceStopLoss</span><span class="hl-2"> </span><span class="hl-6">reached</span><span class="hl-2"> → </span><span class="hl-6">Signal</span><span class="hl-2"> </span><span class="hl-8">CLOSES</span><span class="hl-2"> </span><span class="hl-6">by</span><span class="hl-2"> </span><span class="hl-8">SL</span><br/><br/><span class="hl-6">Pre</span><span class="hl-2">-</span><span class="hl-6">activation</span><span class="hl-2"> </span><span class="hl-6">cancellation</span><span class="hl-2"> </span><span class="hl-6">is</span><span class="hl-2"> </span><span class="hl-8">IMPOSSIBLE</span><span class="hl-2"> </span><span class="hl-6">because</span><span class="hl-2"> </span><span class="hl-6">priceOpen</span><span class="hl-2"> </span><span class="hl-6">comes</span><span class="hl-2"> </span><span class="hl-6">first</span><span class="hl-2">.</span>
</code><button>Copy</button></pre>

<p><strong>Behavior:</strong></p>
<ul>
<li>Signal <strong>activates</strong> at priceOpen=41000 (not cancelled)</li>
<li>Signal <strong>closes</strong> by <code>stop_loss</code> immediately after activation</li>
<li>PNL is negative (loss recorded)</li>
<li><strong>This is correct behavior</strong> for limit orders: Entry price reached first, then position lost money</li>
</ul>
<p><strong>Critical distinction:</strong></p>
<ul>
<li><strong>Pre-activation cancellation</strong>: Price skips priceOpen entirely, hits SL first → cancelled, no loss</li>
<li><strong>Post-activation closure</strong>: Price reaches priceOpen first, then hits SL → activated then closed, loss recorded</li>
</ul>
<a id="edge-case-5-timeout-boundary-condition" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Edge Case 5: Timeout Boundary Condition<a href="#edge-case-5-timeout-boundary-condition" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><strong>Scenario:</strong> Scheduled signal reaches exactly <code>CC_SCHEDULE_AWAIT_MINUTES</code> (120 minutes).</p>
<pre><code><span class="hl-10">scheduledAt</span><span class="hl-2">: </span><span class="hl-7">2024</span><span class="hl-2">-</span><span class="hl-7">01</span><span class="hl-2">-</span><span class="hl-7">01</span><span class="hl-2"> </span><span class="hl-7">00</span><span class="hl-2">:</span><span class="hl-7">00</span><span class="hl-2">:</span><span class="hl-7">00</span><br/><span class="hl-10">currentTime</span><span class="hl-2">: </span><span class="hl-7">2024</span><span class="hl-2">-</span><span class="hl-7">01</span><span class="hl-2">-</span><span class="hl-7">01</span><span class="hl-2"> </span><span class="hl-7">02</span><span class="hl-2">:</span><span class="hl-7">00</span><span class="hl-2">:</span><span class="hl-7">00</span><br/><span class="hl-10">elapsedTime</span><span class="hl-2">: </span><span class="hl-7">120</span><span class="hl-2"> </span><span class="hl-6">minutes</span><br/><br/><span class="hl-10">Condition</span><span class="hl-2">: </span><span class="hl-6">elapsedTime</span><span class="hl-2"> &gt;= </span><span class="hl-6">maxTimeToWait</span>
</code><button>Copy</button></pre>

<p><strong>Behavior:</strong></p>
<ul>
<li><strong>Inclusive boundary</strong>: <code>&gt;=</code> means timeout occurs at <strong>exactly</strong> 120 minutes</li>
<li>Signal cancelled with <code>IStrategyTickResultCancelled</code> emitted</li>
<li>Close timestamp equals current time (120 minutes after scheduled)</li>
<li>Risk limits released (position count decremented)</li>
</ul>
<hr>
<a id="code-entity-reference" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Code Entity Reference<a href="#code-entity-reference" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><a id="key-types" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Key Types<a href="#key-types" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><table>
<thead>
<tr>
<th>Type</th>
<th>File</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>IScheduledSignalRow</code></td>
<td><a href="">src/interfaces/Strategy.interface.ts:64-73</a></td>
<td>Scheduled signal row (extends <code>ISignalRow</code> with required <code>priceOpen</code>)</td>
</tr>
<tr>
<td><code>IStrategyTickResultScheduled</code></td>
<td><a href="">types.d.ts:788-807</a></td>
<td>Tick result when signal is in scheduled state</td>
</tr>
<tr>
<td><code>IStrategyTickResultCancelled</code></td>
<td><a href="">types.d.ts:867-895</a></td>
<td>Tick result when scheduled signal is cancelled</td>
</tr>
</tbody>
</table>
<a id="key-functions" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Key Functions<a href="#key-functions" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><table>
<thead>
<tr>
<th>Function</th>
<th>File</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>GET_SIGNAL_FN</code></td>
<td><a href="">src/client/ClientStrategy.ts:332-476</a></td>
<td>Determines if signal should be immediate or scheduled based on <code>priceOpen</code></td>
</tr>
<tr>
<td><code>CHECK_SCHEDULED_SIGNAL_TIMEOUT_FN</code></td>
<td><a href="">src/client/ClientStrategy.ts:554-608</a></td>
<td>Checks if scheduled signal has exceeded timeout limit</td>
</tr>
<tr>
<td><code>CHECK_SCHEDULED_SIGNAL_PRICE_ACTIVATION_FN</code></td>
<td><a href="">src/client/ClientStrategy.ts:610-644</a></td>
<td>Determines if scheduled signal should activate or cancel based on price</td>
</tr>
<tr>
<td><code>CANCEL_SCHEDULED_SIGNAL_BY_STOPLOSS_FN</code></td>
<td><a href="">src/client/ClientStrategy.ts:646-679</a></td>
<td>Cancels scheduled signal when StopLoss hit before activation</td>
</tr>
<tr>
<td><code>ACTIVATE_SCHEDULED_SIGNAL_FN</code></td>
<td><a href="">src/client/ClientStrategy.ts:681-774</a></td>
<td>Activates scheduled signal when priceOpen is reached</td>
</tr>
<tr>
<td><code>setScheduledSignal</code></td>
<td><a href="">src/client/ClientStrategy.ts:863-881</a></td>
<td>Persists scheduled signal to disk via <code>PersistScheduleAdapter</code></td>
</tr>
<tr>
<td><code>WAIT_FOR_INIT_FN</code></td>
<td><a href="">src/client/ClientStrategy.ts:525-551</a></td>
<td>Restores scheduled signal from disk on crash recovery</td>
</tr>
</tbody>
</table>
<a id="key-classes" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Key Classes<a href="#key-classes" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><table>
<thead>
<tr>
<th>Class</th>
<th>File</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>ClientStrategy</code></td>
<td><a href="">src/client/ClientStrategy.ts</a></td>
<td>Implements signal lifecycle including scheduled signal management</td>
</tr>
<tr>
<td><code>PersistScheduleAdapter</code></td>
<td><a href="">src/classes/Persist.ts</a></td>
<td>Persists scheduled signals to <code>./dump/data/schedule/</code> for crash recovery</td>
</tr>
</tbody>
</table>
<a id="configuration-parameters" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Configuration Parameters<a href="#configuration-parameters" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><table>
<thead>
<tr>
<th>Parameter</th>
<th>Default</th>
<th>File</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>CC_SCHEDULE_AWAIT_MINUTES</code></td>
<td><code>120</code></td>
<td><a href="">src/config/params.ts</a></td>
<td>Maximum waiting time for scheduled signal before timeout cancellation</td>
</tr>
<tr>
<td><code>CC_MIN_TAKEPROFIT_DISTANCE_PERCENT</code></td>
<td>Configurable</td>
<td><a href="">src/config/params.ts</a></td>
<td>Minimum distance between priceOpen and priceTakeProfit</td>
</tr>
<tr>
<td><code>CC_MIN_STOPLOSS_DISTANCE_PERCENT</code></td>
<td>Configurable</td>
<td><a href="">src/config/params.ts</a></td>
<td>Minimum distance between priceOpen and priceStopLoss</td>
</tr>
</tbody>
</table>
</div></div><div class="col-sidebar"><div class="page-menu"><div class="tsd-navigation settings"><details class="tsd-accordion"><summary class="tsd-accordion-summary"><h3><svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-chevronDown"></use></svg>Settings</h3></summary><div class="tsd-accordion-details"><div class="tsd-filter-visibility"><span class="settings-label">Member Visibility</span><ul id="tsd-filter-options"><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-protected" name="protected"/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Protected</span></label></li><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-inherited" name="inherited" checked/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Inherited</span></label></li><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-external" name="external"/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>External</span></label></li></ul></div><div class="tsd-theme-toggle"><label class="settings-label" for="tsd-theme">Theme</label><select id="tsd-theme"><option value="os">OS</option><option value="light">Light</option><option value="dark">Dark</option></select></div></div></details></div><details open class="tsd-accordion tsd-page-navigation"><summary class="tsd-accordion-summary"><h3><svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-chevronDown"></use></svg>On This Page</h3></summary><div class="tsd-accordion-details"><a href="#scheduled-signals"><span>Scheduled <wbr/>Signals</span></a><ul><li><a href="#purpose-and-scope"><span>Purpose and <wbr/>Scope</span></a></li><li><a href="#creating-scheduled-signals"><span>Creating <wbr/>Scheduled <wbr/>Signals</span></a></li><li><ul><li><a href="#signal-creation-logic"><span>Signal <wbr/>Creation <wbr/>Logic</span></a></li><li><a href="#immediate-activation-check"><span>Immediate <wbr/>Activation <wbr/>Check</span></a></li></ul></li><li><a href="#scheduled-signal-lifecycle"><span>Scheduled <wbr/>Signal <wbr/>Lifecycle</span></a></li><li><a href="#activation-logic"><span>Activation <wbr/>Logic</span></a></li><li><ul><li><a href="#price-based-activation-conditions"><span>Price-<wbr/>Based <wbr/>Activation <wbr/>Conditions</span></a></li><li><a href="#activation-priority"><span>Activation <wbr/>Priority</span></a></li><li><a href="#activation-timestamp-handling"><span>Activation <wbr/>Timestamp <wbr/>Handling</span></a></li></ul></li><li><a href="#cancellation-logic"><span>Cancellation <wbr/>Logic</span></a></li><li><ul><li><a href="#timeout-cancellation"><span>Timeout <wbr/>Cancellation</span></a></li><li><a href="#stoploss-pre-activation-cancellation"><span>Stop<wbr/>Loss <wbr/>Pre-<wbr/>Activation <wbr/>Cancellation</span></a></li></ul></li><li><a href="#timestamps-and-duration-tracking"><span>Timestamps and <wbr/>Duration <wbr/>Tracking</span></a></li><li><ul><li><a href="#duration-calculations"><span>Duration <wbr/>Calculations</span></a></li><li><a href="#why-two-timestamps-matter"><span>Why <wbr/>Two <wbr/>Timestamps <wbr/>Matter</span></a></li><li><a href="#timestamp-update-on-activation"><span>Timestamp <wbr/>Update on <wbr/>Activation</span></a></li></ul></li><li><a href="#persistence-and-crash-recovery"><span>Persistence and <wbr/>Crash <wbr/>Recovery</span></a></li><li><ul><li><a href="#persistence-architecture"><span>Persistence <wbr/>Architecture</span></a></li><li><a href="#file-structure"><span>File <wbr/>Structure</span></a></li><li><a href="#crash-recovery-flow"><span>Crash <wbr/>Recovery <wbr/>Flow</span></a></li><li><a href="#persistence-implementation-details"><span>Persistence <wbr/>Implementation <wbr/>Details</span></a></li></ul></li><li><a href="#validation-rules"><span>Validation <wbr/>Rules</span></a></li><li><ul><li><a href="#scheduled-specific-validations"><span>Scheduled-<wbr/>Specific <wbr/>Validations</span></a></li><li><a href="#critical-validation-position-validity-at-priceopen"><span>Critical <wbr/>Validation: <wbr/>Position <wbr/>Validity at price<wbr/>Open</span></a></li><li><a href="#validation-error-messages"><span>Validation <wbr/>Error <wbr/>Messages</span></a></li></ul></li><li><a href="#edge-cases-and-critical-behaviors"><span>Edge <wbr/>Cases and <wbr/>Critical <wbr/>Behaviors</span></a></li><li><ul><li><a href="#edge-case-1-activation-and-immediate-closure-on-same-candle"><span>Edge <wbr/>Case 1: <wbr/>Activation and <wbr/>Immediate <wbr/>Closure on <wbr/>Same <wbr/>Candle</span></a></li><li><a href="#edge-case-2-price-crosses-both-tp-and-sl-on-same-candle-after-activation"><span>Edge <wbr/>Case 2: <wbr/>Price <wbr/>Crosses <wbr/>Both TP and SL on <wbr/>Same <wbr/>Candle (<wbr/>After <wbr/>Activation)</span></a></li><li><a href="#edge-case-3-multiple-scheduled-signals-on-same-symbol"><span>Edge <wbr/>Case 3: <wbr/>Multiple <wbr/>Scheduled <wbr/>Signals on <wbr/>Same <wbr/>Symbol</span></a></li><li><a href="#edge-case-4-impossible-limit-order-cancellation"><span>Edge <wbr/>Case 4: <wbr/>Impossible <wbr/>Limit <wbr/>Order <wbr/>Cancellation</span></a></li><li><a href="#edge-case-5-timeout-boundary-condition"><span>Edge <wbr/>Case 5: <wbr/>Timeout <wbr/>Boundary <wbr/>Condition</span></a></li></ul></li><li><a href="#code-entity-reference"><span>Code <wbr/>Entity <wbr/>Reference</span></a></li><li><ul><li><a href="#key-types"><span>Key <wbr/>Types</span></a></li><li><a href="#key-functions"><span>Key <wbr/>Functions</span></a></li><li><a href="#key-classes"><span>Key <wbr/>Classes</span></a></li><li><a href="#configuration-parameters"><span>Configuration <wbr/>Parameters</span></a></li></ul></li></ul></div></details></div><div class="site-menu"><nav class="tsd-navigation"><a href="../modules.html">backtest-kit</a><ul class="tsd-small-nested-navigation" id="tsd-nav-container"><li>Loading...</li></ul></nav></div></div></div><footer><p class="tsd-generator">Generated using <a href="https://typedoc.org/" target="_blank">TypeDoc</a></p></footer><div class="overlay"></div></body></html>

<!-- Yandex.Metrika counter -->
<script type="text/javascript">
    (function(m,e,t,r,i,k,a){
        m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
        m[i].l=1*new Date();
        for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }}
        k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)
    })(window, document,'script','https://mc.yandex.ru/metrika/tag.js?id=105455585', 'ym');

    ym(105455585, 'init', {ssr:true, webvisor:true, clickmap:true, ecommerce:"dataLayer", accurateTrackBounce:true, trackLinks:true});
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/105455585" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
<!-- /Yandex.Metrika counter -->

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-3MQZEBBDDR"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-3MQZEBBDDR');
</script>
