<!DOCTYPE html><html class="default" lang="en" data-base=".."><head><meta charset="utf-8"/><meta http-equiv="x-ua-compatible" content="IE=edge"/><title>design/43_custom_exchange_integration | backtest-kit</title><meta name="description" content="Documentation for backtest-kit"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="stylesheet" href="../assets/style.css"/><link rel="stylesheet" href="../assets/highlight.css"/><script defer src="../assets/main.js"></script><script async src="../assets/icons.js" id="tsd-icons-script"></script><script async src="../assets/search.js" id="tsd-search-script"></script><script async src="../assets/navigation.js" id="tsd-nav-script"></script><script async src="../assets/hierarchy.js" id="tsd-hierarchy-script"></script></head><body><script>document.documentElement.dataset.theme = localStorage.getItem("tsd-theme") || "os";document.body.style.display="none";setTimeout(() => app?app.showPage():document.body.style.removeProperty("display"),500)</script><header class="tsd-page-toolbar"><div class="tsd-toolbar-contents container"><div class="table-cell" id="tsd-search"><div class="field"><label for="tsd-search-field" class="tsd-widget tsd-toolbar-icon search no-caption"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-search"></use></svg></label><input type="text" id="tsd-search-field" aria-label="Search"/></div><div class="field"><div id="tsd-toolbar-links"></div></div><ul class="results"><li class="state loading">Preparing search index...</li><li class="state failure">The search index is not available</li></ul><a href="../index.html" class="title">backtest-kit</a></div><div class="table-cell" id="tsd-widgets"><a href="#" class="tsd-widget tsd-toolbar-icon menu no-caption" data-toggle="menu" aria-label="Menu"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-menu"></use></svg></a></div></div></header><div class="container container-main"><div class="col-content"><div class="tsd-page-title"><ul class="tsd-breadcrumb"><li><a href="../modules.html">backtest-kit</a></li><li><a href="design_43_custom_exchange_integration.html">design/43_custom_exchange_integration</a></li></ul></div><div class="tsd-panel tsd-typography"><a id="custom-exchange-integration" class="tsd-anchor"></a><h1 class="tsd-anchor-link">Custom Exchange Integration<a href="#custom-exchange-integration" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h1><p>This document explains how to implement custom exchange data sources by creating <code>IExchangeSchema</code> implementations. Custom exchanges enable backtesting and live trading with data from any source including REST APIs, databases, CSV files, or WebSocket streams.</p>
<p>For information about using exchange functions (<code>getCandles</code>, <code>getAveragePrice</code>, etc.) in strategies, see <a href="design_12_exchange_functions.html">Exchange Functions</a>. For the internal architecture of exchange services, see <a href="design_19_connection_services.html">Connection Services</a> and <a href="design_21_global_services.html">Global Services</a>.</p>
<hr>
<a id="overview" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Overview<a href="#overview" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>The framework uses a schema-based registration pattern where users provide a configuration object implementing <code>IExchangeSchema</code>. This schema is registered via <code>addExchange()</code> and wrapped by <code>ClientExchange</code> at runtime. The wrapper adds VWAP calculation, execution context integration, and bidirectional candle fetching (backwards for historical data, forwards for backtest simulation).</p>
<hr>
<a id="exchange-integration-architecture" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Exchange Integration Architecture<a href="#exchange-integration-architecture" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p><img src="../media/43_Custom_Exchange_Integration_0.svg" alt="Mermaid Diagram"></p>
<p><strong>Diagram: Exchange integration flow from user schema to runtime instance</strong></p>
<p>This diagram shows how user-provided schemas are registered, cached, and wrapped by <code>ClientExchange</code> to provide enhanced functionality including VWAP calculation and execution context awareness.</p>
<hr>
<a id="iexchangeschema-interface" class="tsd-anchor"></a><h2 class="tsd-anchor-link">IExchangeSchema Interface<a href="#iexchangeschema-interface" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>The <code>IExchangeSchema</code> interface defines the contract for exchange implementations. All methods must be async and handle errors appropriately.</p>
<table>
<thead>
<tr>
<th>Property</th>
<th>Type</th>
<th>Required</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>exchangeName</code></td>
<td><code>ExchangeName</code> (string)</td>
<td>Yes</td>
<td>Unique identifier for this exchange</td>
</tr>
<tr>
<td><code>getCandles</code></td>
<td>Function</td>
<td>Yes</td>
<td>Fetches OHLCV candle data from data source</td>
</tr>
<tr>
<td><code>formatPrice</code></td>
<td>Function</td>
<td>Yes</td>
<td>Formats price values for exchange precision</td>
</tr>
<tr>
<td><code>formatQuantity</code></td>
<td>Function</td>
<td>Yes</td>
<td>Formats quantity values for exchange precision</td>
</tr>
<tr>
<td><code>callbacks</code></td>
<td>Object</td>
<td>No</td>
<td>Optional lifecycle event hooks</td>
</tr>
</tbody>
</table>
<hr>
<a id="implementing-getcandles" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Implementing getCandles<a href="#implementing-getcandles" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>The <code>getCandles</code> method is the core data source function. It must fetch historical OHLCV candles based on the provided parameters.</p>
<a id="method-signature" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Method Signature<a href="#method-signature" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><pre><code class="typescript"><span class="hl-10">getCandles</span><span class="hl-1">: (</span><br/><span class="hl-1">  </span><span class="hl-4">symbol</span><span class="hl-1">: </span><span class="hl-4">string</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">interval</span><span class="hl-1">: </span><span class="hl-4">CandleInterval</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">since</span><span class="hl-1">: </span><span class="hl-4">Date</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">limit</span><span class="hl-1">: </span><span class="hl-4">number</span><br/><span class="hl-1">) </span><span class="hl-6">=&gt;</span><span class="hl-1"> </span><span class="hl-11">Promise</span><span class="hl-1">&lt;</span><span class="hl-4">ICandleData</span><span class="hl-1">[]&gt;</span>
</code><button type="button">Copy</button></pre>

<a id="parameters" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Parameters<a href="#parameters" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><table>
<thead>
<tr>
<th>Parameter</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>symbol</code></td>
<td><code>string</code></td>
<td>Trading pair symbol (e.g., &quot;BTCUSDT&quot;)</td>
</tr>
<tr>
<td><code>interval</code></td>
<td><code>CandleInterval</code></td>
<td>Candle timeframe (&quot;1m&quot;, &quot;3m&quot;, &quot;5m&quot;, &quot;15m&quot;, &quot;30m&quot;, &quot;1h&quot;, &quot;2h&quot;, &quot;4h&quot;, &quot;6h&quot;, &quot;8h&quot;)</td>
</tr>
<tr>
<td><code>since</code></td>
<td><code>Date</code></td>
<td>Start date for candle fetching (inclusive)</td>
</tr>
<tr>
<td><code>limit</code></td>
<td><code>number</code></td>
<td>Maximum number of candles to return</td>
</tr>
</tbody>
</table>
<a id="return-value" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Return Value<a href="#return-value" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Array of <code>ICandleData</code> objects, each containing:</p>
<table>
<thead>
<tr>
<th>Field</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>timestamp</code></td>
<td><code>number</code></td>
<td>Unix timestamp in milliseconds when candle opened</td>
</tr>
<tr>
<td><code>open</code></td>
<td><code>number</code></td>
<td>Opening price at candle start</td>
</tr>
<tr>
<td><code>high</code></td>
<td><code>number</code></td>
<td>Highest price during candle period</td>
</tr>
<tr>
<td><code>low</code></td>
<td><code>number</code></td>
<td>Lowest price during candle period</td>
</tr>
<tr>
<td><code>close</code></td>
<td><code>number</code></td>
<td>Closing price at candle end</td>
</tr>
<tr>
<td><code>volume</code></td>
<td><code>number</code></td>
<td>Trading volume during candle period</td>
</tr>
</tbody>
</table>
<a id="implementation-requirements" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Implementation Requirements<a href="#implementation-requirements" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><ol>
<li><strong>Timestamp Range</strong>: Return candles from <code>since</code> date up to <code>limit</code> candles</li>
<li><strong>Ascending Order</strong>: Candles must be sorted by timestamp (oldest first)</li>
<li><strong>No Gaps</strong>: Avoid missing candles in the sequence when possible</li>
<li><strong>Exact Timestamps</strong>: Candle timestamps should align to interval boundaries</li>
<li><strong>Error Handling</strong>: Throw descriptive errors for failed requests</li>
</ol>
<hr>
<a id="clientexchange-candle-processing" class="tsd-anchor"></a><h2 class="tsd-anchor-link">ClientExchange Candle Processing<a href="#clientexchange-candle-processing" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p><img src="../media/43_Custom_Exchange_Integration_1.svg" alt="Mermaid Diagram"></p>
<p><strong>Diagram: Candle fetching flow showing how ClientExchange wraps user schema</strong></p>
<p><code>ClientExchange</code> automatically calculates the <code>since</code> parameter by subtracting <code>interval * limit</code> from the execution context <code>when</code> timestamp. This allows the user schema to focus solely on data retrieval.</p>
<hr>
<a id="example-rest-api-exchange" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Example: REST API Exchange<a href="#example-rest-api-exchange" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>Below is a conceptual example showing how to implement an exchange that fetches data from a REST API endpoint:</p>
<pre><code class="typescript"><span class="hl-3">import</span><span class="hl-1"> { </span><span class="hl-4">addExchange</span><span class="hl-1">, </span><span class="hl-4">IExchangeSchema</span><span class="hl-1">, </span><span class="hl-4">ICandleData</span><span class="hl-1">, </span><span class="hl-4">CandleInterval</span><span class="hl-1"> } </span><span class="hl-3">from</span><span class="hl-1"> </span><span class="hl-2">&quot;backtest-kit&quot;</span><span class="hl-1">;</span><br/><br/><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">INTERVAL_MAP</span><span class="hl-1">: </span><span class="hl-11">Record</span><span class="hl-1">&lt;</span><span class="hl-11">CandleInterval</span><span class="hl-1">, </span><span class="hl-11">string</span><span class="hl-1">&gt; = {</span><br/><span class="hl-1">  </span><span class="hl-2">&quot;1m&quot;</span><span class="hl-4">:</span><span class="hl-1"> </span><span class="hl-2">&quot;1min&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-2">&quot;5m&quot;</span><span class="hl-4">:</span><span class="hl-1"> </span><span class="hl-2">&quot;5min&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-2">&quot;1h&quot;</span><span class="hl-4">:</span><span class="hl-1"> </span><span class="hl-2">&quot;1hour&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-5">// ... map framework intervals to API intervals</span><br/><span class="hl-1">};</span><br/><br/><span class="hl-0">addExchange</span><span class="hl-1">({</span><br/><span class="hl-1">  </span><span class="hl-4">exchangeName:</span><span class="hl-1"> </span><span class="hl-2">&quot;my-rest-api&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><br/><span class="hl-1">  </span><span class="hl-6">async</span><span class="hl-1"> </span><span class="hl-0">getCandles</span><span class="hl-1">(</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">interval</span><span class="hl-1">, </span><span class="hl-4">since</span><span class="hl-1">, </span><span class="hl-4">limit</span><span class="hl-1">) {</span><br/><span class="hl-1">    </span><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">apiInterval</span><span class="hl-1"> = </span><span class="hl-7">INTERVAL_MAP</span><span class="hl-1">[</span><span class="hl-4">interval</span><span class="hl-1">];</span><br/><span class="hl-1">    </span><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">sinceTs</span><span class="hl-1"> = </span><span class="hl-4">since</span><span class="hl-1">.</span><span class="hl-0">getTime</span><span class="hl-1">();</span><br/><span class="hl-1">    </span><br/><span class="hl-1">    </span><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">response</span><span class="hl-1"> = </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-0">fetch</span><span class="hl-1">(</span><br/><span class="hl-1">      </span><span class="hl-2">`https://api.example.com/candles?symbol=</span><span class="hl-6">${</span><span class="hl-4">symbol</span><span class="hl-6">}</span><span class="hl-2">&amp;interval=</span><span class="hl-6">${</span><span class="hl-4">apiInterval</span><span class="hl-6">}</span><span class="hl-2">&amp;since=</span><span class="hl-6">${</span><span class="hl-4">sinceTs</span><span class="hl-6">}</span><span class="hl-2">&amp;limit=</span><span class="hl-6">${</span><span class="hl-4">limit</span><span class="hl-6">}</span><span class="hl-2">`</span><br/><span class="hl-1">    );</span><br/><span class="hl-1">    </span><br/><span class="hl-1">    </span><span class="hl-3">if</span><span class="hl-1"> (!</span><span class="hl-4">response</span><span class="hl-1">.</span><span class="hl-4">ok</span><span class="hl-1">) {</span><br/><span class="hl-1">      </span><span class="hl-3">throw</span><span class="hl-1"> </span><span class="hl-6">new</span><span class="hl-1"> </span><span class="hl-0">Error</span><span class="hl-1">(</span><span class="hl-2">`API error: </span><span class="hl-6">${</span><span class="hl-4">response</span><span class="hl-9">.</span><span class="hl-4">statusText</span><span class="hl-6">}</span><span class="hl-2">`</span><span class="hl-1">);</span><br/><span class="hl-1">    }</span><br/><span class="hl-1">    </span><br/><span class="hl-1">    </span><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">data</span><span class="hl-1"> = </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-4">response</span><span class="hl-1">.</span><span class="hl-0">json</span><span class="hl-1">();</span><br/><span class="hl-1">    </span><br/><span class="hl-1">    </span><span class="hl-3">return</span><span class="hl-1"> </span><span class="hl-4">data</span><span class="hl-1">.</span><span class="hl-4">candles</span><span class="hl-1">.</span><span class="hl-0">map</span><span class="hl-1">((</span><span class="hl-4">c</span><span class="hl-1">: </span><span class="hl-11">any</span><span class="hl-1">): </span><span class="hl-11">ICandleData</span><span class="hl-1"> </span><span class="hl-6">=&gt;</span><span class="hl-1"> ({</span><br/><span class="hl-1">      </span><span class="hl-4">timestamp:</span><span class="hl-1"> </span><span class="hl-4">c</span><span class="hl-1">.</span><span class="hl-4">time</span><span class="hl-1">,</span><br/><span class="hl-1">      </span><span class="hl-4">open:</span><span class="hl-1"> </span><span class="hl-0">parseFloat</span><span class="hl-1">(</span><span class="hl-4">c</span><span class="hl-1">.</span><span class="hl-4">o</span><span class="hl-1">),</span><br/><span class="hl-1">      </span><span class="hl-4">high:</span><span class="hl-1"> </span><span class="hl-0">parseFloat</span><span class="hl-1">(</span><span class="hl-4">c</span><span class="hl-1">.</span><span class="hl-4">h</span><span class="hl-1">),</span><br/><span class="hl-1">      </span><span class="hl-4">low:</span><span class="hl-1"> </span><span class="hl-0">parseFloat</span><span class="hl-1">(</span><span class="hl-4">c</span><span class="hl-1">.</span><span class="hl-4">l</span><span class="hl-1">),</span><br/><span class="hl-1">      </span><span class="hl-4">close:</span><span class="hl-1"> </span><span class="hl-0">parseFloat</span><span class="hl-1">(</span><span class="hl-4">c</span><span class="hl-1">.</span><span class="hl-4">c</span><span class="hl-1">),</span><br/><span class="hl-1">      </span><span class="hl-4">volume:</span><span class="hl-1"> </span><span class="hl-0">parseFloat</span><span class="hl-1">(</span><span class="hl-4">c</span><span class="hl-1">.</span><span class="hl-4">v</span><span class="hl-1">),</span><br/><span class="hl-1">    }));</span><br/><span class="hl-1">  },</span><br/><span class="hl-1">  </span><br/><span class="hl-1">  </span><span class="hl-6">async</span><span class="hl-1"> </span><span class="hl-0">formatPrice</span><span class="hl-1">(</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">price</span><span class="hl-1">) {</span><br/><span class="hl-1">    </span><span class="hl-3">return</span><span class="hl-1"> </span><span class="hl-4">price</span><span class="hl-1">.</span><span class="hl-0">toFixed</span><span class="hl-1">(</span><span class="hl-8">2</span><span class="hl-1">);</span><br/><span class="hl-1">  },</span><br/><span class="hl-1">  </span><br/><span class="hl-1">  </span><span class="hl-6">async</span><span class="hl-1"> </span><span class="hl-0">formatQuantity</span><span class="hl-1">(</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">quantity</span><span class="hl-1">) {</span><br/><span class="hl-1">    </span><span class="hl-3">return</span><span class="hl-1"> </span><span class="hl-4">quantity</span><span class="hl-1">.</span><span class="hl-0">toFixed</span><span class="hl-1">(</span><span class="hl-8">8</span><span class="hl-1">);</span><br/><span class="hl-1">  },</span><br/><span class="hl-1">});</span>
</code><button type="button">Copy</button></pre>

<hr>
<a id="example-database-exchange" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Example: Database Exchange<a href="#example-database-exchange" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>Conceptual example for fetching candles from a SQL database:</p>
<pre><code class="typescript"><span class="hl-3">import</span><span class="hl-1"> { </span><span class="hl-4">addExchange</span><span class="hl-1"> } </span><span class="hl-3">from</span><span class="hl-1"> </span><span class="hl-2">&quot;backtest-kit&quot;</span><span class="hl-1">;</span><br/><span class="hl-3">import</span><span class="hl-1"> </span><span class="hl-4">Database</span><span class="hl-1"> </span><span class="hl-3">from</span><span class="hl-1"> </span><span class="hl-2">&quot;better-sqlite3&quot;</span><span class="hl-1">;</span><br/><br/><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">db</span><span class="hl-1"> = </span><span class="hl-6">new</span><span class="hl-1"> </span><span class="hl-0">Database</span><span class="hl-1">(</span><span class="hl-2">&quot;market-data.db&quot;</span><span class="hl-1">);</span><br/><br/><span class="hl-0">addExchange</span><span class="hl-1">({</span><br/><span class="hl-1">  </span><span class="hl-4">exchangeName:</span><span class="hl-1"> </span><span class="hl-2">&quot;sqlite-db&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><br/><span class="hl-1">  </span><span class="hl-6">async</span><span class="hl-1"> </span><span class="hl-0">getCandles</span><span class="hl-1">(</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">interval</span><span class="hl-1">, </span><span class="hl-4">since</span><span class="hl-1">, </span><span class="hl-4">limit</span><span class="hl-1">) {</span><br/><span class="hl-1">    </span><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">sinceTs</span><span class="hl-1"> = </span><span class="hl-4">since</span><span class="hl-1">.</span><span class="hl-0">getTime</span><span class="hl-1">();</span><br/><span class="hl-1">    </span><br/><span class="hl-1">    </span><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">rows</span><span class="hl-1"> = </span><span class="hl-4">db</span><br/><span class="hl-1">      .</span><span class="hl-0">prepare</span><span class="hl-1">(</span><br/><span class="hl-1">        </span><span class="hl-2">`SELECT timestamp, open, high, low, close, volume</span><br/><span class="hl-2">         FROM candles</span><br/><span class="hl-2">         WHERE symbol = ? AND interval = ? AND timestamp &gt;= ?</span><br/><span class="hl-2">         ORDER BY timestamp ASC</span><br/><span class="hl-2">         LIMIT ?`</span><br/><span class="hl-1">      )</span><br/><span class="hl-1">      .</span><span class="hl-0">all</span><span class="hl-1">(</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">interval</span><span class="hl-1">, </span><span class="hl-4">sinceTs</span><span class="hl-1">, </span><span class="hl-4">limit</span><span class="hl-1">);</span><br/><span class="hl-1">    </span><br/><span class="hl-1">    </span><span class="hl-3">return</span><span class="hl-1"> </span><span class="hl-4">rows</span><span class="hl-1">.</span><span class="hl-0">map</span><span class="hl-1">((</span><span class="hl-4">row</span><span class="hl-1">: </span><span class="hl-11">any</span><span class="hl-1">) </span><span class="hl-6">=&gt;</span><span class="hl-1"> ({</span><br/><span class="hl-1">      </span><span class="hl-4">timestamp:</span><span class="hl-1"> </span><span class="hl-4">row</span><span class="hl-1">.</span><span class="hl-4">timestamp</span><span class="hl-1">,</span><br/><span class="hl-1">      </span><span class="hl-4">open:</span><span class="hl-1"> </span><span class="hl-4">row</span><span class="hl-1">.</span><span class="hl-4">open</span><span class="hl-1">,</span><br/><span class="hl-1">      </span><span class="hl-4">high:</span><span class="hl-1"> </span><span class="hl-4">row</span><span class="hl-1">.</span><span class="hl-4">high</span><span class="hl-1">,</span><br/><span class="hl-1">      </span><span class="hl-4">low:</span><span class="hl-1"> </span><span class="hl-4">row</span><span class="hl-1">.</span><span class="hl-4">low</span><span class="hl-1">,</span><br/><span class="hl-1">      </span><span class="hl-4">close:</span><span class="hl-1"> </span><span class="hl-4">row</span><span class="hl-1">.</span><span class="hl-4">close</span><span class="hl-1">,</span><br/><span class="hl-1">      </span><span class="hl-4">volume:</span><span class="hl-1"> </span><span class="hl-4">row</span><span class="hl-1">.</span><span class="hl-4">volume</span><span class="hl-1">,</span><br/><span class="hl-1">    }));</span><br/><span class="hl-1">  },</span><br/><span class="hl-1">  </span><br/><span class="hl-1">  </span><span class="hl-6">async</span><span class="hl-1"> </span><span class="hl-0">formatPrice</span><span class="hl-1">(</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">price</span><span class="hl-1">) {</span><br/><span class="hl-1">    </span><span class="hl-5">// Query precision from exchange_info table</span><br/><span class="hl-1">    </span><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">info</span><span class="hl-1"> = </span><span class="hl-4">db</span><br/><span class="hl-1">      .</span><span class="hl-0">prepare</span><span class="hl-1">(</span><span class="hl-2">&quot;SELECT price_precision FROM exchange_info WHERE symbol = ?&quot;</span><span class="hl-1">)</span><br/><span class="hl-1">      .</span><span class="hl-0">get</span><span class="hl-1">(</span><span class="hl-4">symbol</span><span class="hl-1">);</span><br/><span class="hl-1">    </span><span class="hl-3">return</span><span class="hl-1"> </span><span class="hl-4">price</span><span class="hl-1">.</span><span class="hl-0">toFixed</span><span class="hl-1">(</span><span class="hl-4">info</span><span class="hl-1">?.</span><span class="hl-4">price_precision</span><span class="hl-1"> || </span><span class="hl-8">2</span><span class="hl-1">);</span><br/><span class="hl-1">  },</span><br/><span class="hl-1">  </span><br/><span class="hl-1">  </span><span class="hl-6">async</span><span class="hl-1"> </span><span class="hl-0">formatQuantity</span><span class="hl-1">(</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">quantity</span><span class="hl-1">) {</span><br/><span class="hl-1">    </span><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">info</span><span class="hl-1"> = </span><span class="hl-4">db</span><br/><span class="hl-1">      .</span><span class="hl-0">prepare</span><span class="hl-1">(</span><span class="hl-2">&quot;SELECT qty_precision FROM exchange_info WHERE symbol = ?&quot;</span><span class="hl-1">)</span><br/><span class="hl-1">      .</span><span class="hl-0">get</span><span class="hl-1">(</span><span class="hl-4">symbol</span><span class="hl-1">);</span><br/><span class="hl-1">    </span><span class="hl-3">return</span><span class="hl-1"> </span><span class="hl-4">quantity</span><span class="hl-1">.</span><span class="hl-0">toFixed</span><span class="hl-1">(</span><span class="hl-4">info</span><span class="hl-1">?.</span><span class="hl-4">qty_precision</span><span class="hl-1"> || </span><span class="hl-8">8</span><span class="hl-1">);</span><br/><span class="hl-1">  },</span><br/><span class="hl-1">});</span>
</code><button type="button">Copy</button></pre>

<hr>
<a id="example-csv-file-exchange" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Example: CSV File Exchange<a href="#example-csv-file-exchange" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>Conceptual example for reading candles from CSV files:</p>
<pre><code class="typescript"><span class="hl-3">import</span><span class="hl-1"> { </span><span class="hl-4">addExchange</span><span class="hl-1"> } </span><span class="hl-3">from</span><span class="hl-1"> </span><span class="hl-2">&quot;backtest-kit&quot;</span><span class="hl-1">;</span><br/><span class="hl-3">import</span><span class="hl-1"> </span><span class="hl-4">fs</span><span class="hl-1"> </span><span class="hl-3">from</span><span class="hl-1"> </span><span class="hl-2">&quot;fs&quot;</span><span class="hl-1">;</span><br/><span class="hl-3">import</span><span class="hl-1"> { </span><span class="hl-4">parse</span><span class="hl-1"> } </span><span class="hl-3">from</span><span class="hl-1"> </span><span class="hl-2">&quot;csv-parse/sync&quot;</span><span class="hl-1">;</span><br/><br/><span class="hl-0">addExchange</span><span class="hl-1">({</span><br/><span class="hl-1">  </span><span class="hl-4">exchangeName:</span><span class="hl-1"> </span><span class="hl-2">&quot;csv-files&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><br/><span class="hl-1">  </span><span class="hl-6">async</span><span class="hl-1"> </span><span class="hl-0">getCandles</span><span class="hl-1">(</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">interval</span><span class="hl-1">, </span><span class="hl-4">since</span><span class="hl-1">, </span><span class="hl-4">limit</span><span class="hl-1">) {</span><br/><span class="hl-1">    </span><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">filename</span><span class="hl-1"> = </span><span class="hl-2">`./data/</span><span class="hl-6">${</span><span class="hl-4">symbol</span><span class="hl-6">}</span><span class="hl-2">-</span><span class="hl-6">${</span><span class="hl-4">interval</span><span class="hl-6">}</span><span class="hl-2">.csv`</span><span class="hl-1">;</span><br/><span class="hl-1">    </span><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">content</span><span class="hl-1"> = </span><span class="hl-4">fs</span><span class="hl-1">.</span><span class="hl-0">readFileSync</span><span class="hl-1">(</span><span class="hl-4">filename</span><span class="hl-1">, </span><span class="hl-2">&quot;utf-8&quot;</span><span class="hl-1">);</span><br/><span class="hl-1">    </span><br/><span class="hl-1">    </span><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">records</span><span class="hl-1"> = </span><span class="hl-0">parse</span><span class="hl-1">(</span><span class="hl-4">content</span><span class="hl-1">, {</span><br/><span class="hl-1">      </span><span class="hl-4">columns:</span><span class="hl-1"> </span><span class="hl-6">true</span><span class="hl-1">,</span><br/><span class="hl-1">      </span><span class="hl-4">skip_empty_lines:</span><span class="hl-1"> </span><span class="hl-6">true</span><span class="hl-1">,</span><br/><span class="hl-1">    });</span><br/><span class="hl-1">    </span><br/><span class="hl-1">    </span><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">sinceTs</span><span class="hl-1"> = </span><span class="hl-4">since</span><span class="hl-1">.</span><span class="hl-0">getTime</span><span class="hl-1">();</span><br/><span class="hl-1">    </span><br/><span class="hl-1">    </span><span class="hl-3">return</span><span class="hl-1"> </span><span class="hl-4">records</span><br/><span class="hl-1">      .</span><span class="hl-0">map</span><span class="hl-1">((</span><span class="hl-4">row</span><span class="hl-1">: </span><span class="hl-11">any</span><span class="hl-1">) </span><span class="hl-6">=&gt;</span><span class="hl-1"> ({</span><br/><span class="hl-1">        </span><span class="hl-4">timestamp:</span><span class="hl-1"> </span><span class="hl-0">parseInt</span><span class="hl-1">(</span><span class="hl-4">row</span><span class="hl-1">.</span><span class="hl-4">timestamp</span><span class="hl-1">),</span><br/><span class="hl-1">        </span><span class="hl-4">open:</span><span class="hl-1"> </span><span class="hl-0">parseFloat</span><span class="hl-1">(</span><span class="hl-4">row</span><span class="hl-1">.</span><span class="hl-4">open</span><span class="hl-1">),</span><br/><span class="hl-1">        </span><span class="hl-4">high:</span><span class="hl-1"> </span><span class="hl-0">parseFloat</span><span class="hl-1">(</span><span class="hl-4">row</span><span class="hl-1">.</span><span class="hl-4">high</span><span class="hl-1">),</span><br/><span class="hl-1">        </span><span class="hl-4">low:</span><span class="hl-1"> </span><span class="hl-0">parseFloat</span><span class="hl-1">(</span><span class="hl-4">row</span><span class="hl-1">.</span><span class="hl-4">low</span><span class="hl-1">),</span><br/><span class="hl-1">        </span><span class="hl-4">close:</span><span class="hl-1"> </span><span class="hl-0">parseFloat</span><span class="hl-1">(</span><span class="hl-4">row</span><span class="hl-1">.</span><span class="hl-4">close</span><span class="hl-1">),</span><br/><span class="hl-1">        </span><span class="hl-4">volume:</span><span class="hl-1"> </span><span class="hl-0">parseFloat</span><span class="hl-1">(</span><span class="hl-4">row</span><span class="hl-1">.</span><span class="hl-4">volume</span><span class="hl-1">),</span><br/><span class="hl-1">      }))</span><br/><span class="hl-1">      .</span><span class="hl-0">filter</span><span class="hl-1">((</span><span class="hl-4">c</span><span class="hl-1">) </span><span class="hl-6">=&gt;</span><span class="hl-1"> </span><span class="hl-4">c</span><span class="hl-1">.</span><span class="hl-4">timestamp</span><span class="hl-1"> &gt;= </span><span class="hl-4">sinceTs</span><span class="hl-1">)</span><br/><span class="hl-1">      .</span><span class="hl-0">slice</span><span class="hl-1">(</span><span class="hl-8">0</span><span class="hl-1">, </span><span class="hl-4">limit</span><span class="hl-1">);</span><br/><span class="hl-1">  },</span><br/><span class="hl-1">  </span><br/><span class="hl-1">  </span><span class="hl-6">async</span><span class="hl-1"> </span><span class="hl-0">formatPrice</span><span class="hl-1">(</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">price</span><span class="hl-1">) {</span><br/><span class="hl-1">    </span><span class="hl-3">return</span><span class="hl-1"> </span><span class="hl-4">price</span><span class="hl-1">.</span><span class="hl-0">toFixed</span><span class="hl-1">(</span><span class="hl-8">2</span><span class="hl-1">);</span><br/><span class="hl-1">  },</span><br/><span class="hl-1">  </span><br/><span class="hl-1">  </span><span class="hl-6">async</span><span class="hl-1"> </span><span class="hl-0">formatQuantity</span><span class="hl-1">(</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">quantity</span><span class="hl-1">) {</span><br/><span class="hl-1">    </span><span class="hl-3">return</span><span class="hl-1"> </span><span class="hl-4">quantity</span><span class="hl-1">.</span><span class="hl-0">toFixed</span><span class="hl-1">(</span><span class="hl-8">8</span><span class="hl-1">);</span><br/><span class="hl-1">  },</span><br/><span class="hl-1">});</span>
</code><button type="button">Copy</button></pre>

<hr>
<a id="price-and-quantity-formatting" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Price and Quantity Formatting<a href="#price-and-quantity-formatting" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>The <code>formatPrice</code> and <code>formatQuantity</code> methods ensure values are formatted according to exchange-specific precision rules. These are critical for live trading to avoid order rejection due to invalid precision.</p>
<a id="formatprice-implementation" class="tsd-anchor"></a><h3 class="tsd-anchor-link">formatPrice Implementation<a href="#formatprice-implementation" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><pre><code class="typescript"><span class="hl-10">formatPrice</span><span class="hl-1">: (</span><span class="hl-4">symbol</span><span class="hl-1">: </span><span class="hl-11">string</span><span class="hl-1">, </span><span class="hl-4">price</span><span class="hl-1">: </span><span class="hl-11">number</span><span class="hl-1">) </span><span class="hl-6">=&gt;</span><span class="hl-1"> </span><span class="hl-11">Promise</span><span class="hl-1">&lt;</span><span class="hl-4">string</span><span class="hl-1">&gt;</span>
</code><button type="button">Copy</button></pre>

<p><strong>Purpose:</strong> Format price values to exchange-allowed decimal places.</p>
<p><strong>Example implementations:</strong></p>
<ul>
<li>Fixed precision: <code>price.toFixed(2)</code></li>
<li>Dynamic lookup: Query exchange info API or database</li>
<li>Symbol-specific: Different precision per trading pair</li>
</ul>
<a id="formatquantity-implementation" class="tsd-anchor"></a><h3 class="tsd-anchor-link">formatQuantity Implementation<a href="#formatquantity-implementation" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><pre><code class="typescript"><span class="hl-10">formatQuantity</span><span class="hl-1">: (</span><span class="hl-4">symbol</span><span class="hl-1">: </span><span class="hl-11">string</span><span class="hl-1">, </span><span class="hl-4">quantity</span><span class="hl-1">: </span><span class="hl-11">number</span><span class="hl-1">) </span><span class="hl-6">=&gt;</span><span class="hl-1"> </span><span class="hl-11">Promise</span><span class="hl-1">&lt;</span><span class="hl-4">string</span><span class="hl-1">&gt;</span>
</code><button type="button">Copy</button></pre>

<p><strong>Purpose:</strong> Format quantity/amount values to exchange-allowed decimal places.</p>
<p><strong>Example implementations:</strong></p>
<ul>
<li>Fixed precision: <code>quantity.toFixed(8)</code></li>
<li>Minimum quantity enforcement: Ensure above exchange minimums</li>
<li>Lot size alignment: Round to exchange-required step sizes</li>
</ul>
<hr>
<a id="lifecycle-callbacks" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Lifecycle Callbacks<a href="#lifecycle-callbacks" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>The optional <code>callbacks</code> property enables monitoring of exchange operations. Callbacks are invoked after data operations complete successfully.</p>
<a id="iexchangecallbacks-interface" class="tsd-anchor"></a><h3 class="tsd-anchor-link">IExchangeCallbacks Interface<a href="#iexchangecallbacks-interface" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><pre><code class="typescript"><span class="hl-6">interface</span><span class="hl-1"> </span><span class="hl-11">IExchangeCallbacks</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-0">onCandleData</span><span class="hl-1">: (</span><br/><span class="hl-1">    </span><span class="hl-4">symbol</span><span class="hl-1">: </span><span class="hl-11">string</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-4">interval</span><span class="hl-1">: </span><span class="hl-11">CandleInterval</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-4">since</span><span class="hl-1">: </span><span class="hl-11">Date</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-4">limit</span><span class="hl-1">: </span><span class="hl-11">number</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-4">data</span><span class="hl-1">: </span><span class="hl-11">ICandleData</span><span class="hl-1">[]</span><br/><span class="hl-1">  ) </span><span class="hl-6">=&gt;</span><span class="hl-1"> </span><span class="hl-11">void</span><span class="hl-1">;</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<a id="callback-usage" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Callback Usage<a href="#callback-usage" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><pre><code class="typescript"><span class="hl-0">addExchange</span><span class="hl-1">({</span><br/><span class="hl-1">  </span><span class="hl-4">exchangeName:</span><span class="hl-1"> </span><span class="hl-2">&quot;monitored-exchange&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><br/><span class="hl-1">  </span><span class="hl-5">// ... getCandles, formatPrice, formatQuantity implementations</span><br/><span class="hl-1">  </span><br/><span class="hl-1">  </span><span class="hl-4">callbacks:</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-0">onCandleData</span><span class="hl-4">:</span><span class="hl-1"> (</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">interval</span><span class="hl-1">, </span><span class="hl-4">since</span><span class="hl-1">, </span><span class="hl-4">limit</span><span class="hl-1">, </span><span class="hl-4">data</span><span class="hl-1">) </span><span class="hl-6">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">      </span><span class="hl-4">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-2">`Fetched </span><span class="hl-6">${</span><span class="hl-4">data</span><span class="hl-9">.</span><span class="hl-4">length</span><span class="hl-6">}</span><span class="hl-2"> candles for </span><span class="hl-6">${</span><span class="hl-4">symbol</span><span class="hl-6">}</span><span class="hl-2"> </span><span class="hl-6">${</span><span class="hl-4">interval</span><span class="hl-6">}</span><span class="hl-2">`</span><span class="hl-1">);</span><br/><span class="hl-1">      </span><br/><span class="hl-1">      </span><span class="hl-5">// Validate data quality</span><br/><span class="hl-1">      </span><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-4">data</span><span class="hl-1">.</span><span class="hl-4">length</span><span class="hl-1"> &lt; </span><span class="hl-4">limit</span><span class="hl-1"> * </span><span class="hl-8">0.9</span><span class="hl-1">) {</span><br/><span class="hl-1">        </span><span class="hl-4">console</span><span class="hl-1">.</span><span class="hl-0">warn</span><span class="hl-1">(</span><span class="hl-2">`Data quality issue: expected </span><span class="hl-6">${</span><span class="hl-4">limit</span><span class="hl-6">}</span><span class="hl-2">, got </span><span class="hl-6">${</span><span class="hl-4">data</span><span class="hl-9">.</span><span class="hl-4">length</span><span class="hl-6">}</span><span class="hl-2">`</span><span class="hl-1">);</span><br/><span class="hl-1">      }</span><br/><span class="hl-1">      </span><br/><span class="hl-1">      </span><span class="hl-5">// Log to monitoring system</span><br/><span class="hl-1">      </span><span class="hl-4">metrics</span><span class="hl-1">.</span><span class="hl-0">recordCandleFetch</span><span class="hl-1">(</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">interval</span><span class="hl-1">, </span><span class="hl-4">data</span><span class="hl-1">.</span><span class="hl-4">length</span><span class="hl-1">);</span><br/><span class="hl-1">    },</span><br/><span class="hl-1">  },</span><br/><span class="hl-1">});</span>
</code><button type="button">Copy</button></pre>

<p><strong>Use cases:</strong></p>
<ul>
<li>Logging for debugging and auditing</li>
<li>Metrics collection for monitoring</li>
<li>Data quality validation</li>
<li>Cache warming or preloading</li>
</ul>
<hr>
<a id="vwap-calculation-by-clientexchange" class="tsd-anchor"></a><h2 class="tsd-anchor-link">VWAP Calculation by ClientExchange<a href="#vwap-calculation-by-clientexchange" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p><img src="../media/43_Custom_Exchange_Integration_2.svg" alt="Mermaid Diagram"></p>
<p><strong>Diagram: VWAP calculation flow in ClientExchange.getAveragePrice()</strong></p>
<p>The <code>getAveragePrice</code> method is implemented entirely by <code>ClientExchange</code> and does not require user implementation. It automatically fetches the last 5 one-minute candles and calculates the Volume Weighted Average Price (VWAP).</p>
<p>Formula: <code>VWAP = Σ(Typical Price × Volume) / Σ(Volume)</code> where <code>Typical Price = (High + Low + Close) / 3</code></p>
<hr>
<a id="execution-context-integration" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Execution Context Integration<a href="#execution-context-integration" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p><code>ClientExchange</code> automatically integrates with the execution context system to provide time-aware candle fetching. This enables both backtest and live mode operation without schema awareness.</p>
<a id="context-aware-candle-fetching" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Context-Aware Candle Fetching<a href="#context-aware-candle-fetching" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><table>
<thead>
<tr>
<th>Method</th>
<th>Direction</th>
<th>Uses Context</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>getCandles</code></td>
<td>Backwards</td>
<td>Yes</td>
<td>Fetch historical candles ending at <code>context.when</code></td>
</tr>
<tr>
<td><code>getNextCandles</code></td>
<td>Forwards</td>
<td>Yes</td>
<td>Fetch future candles starting at <code>context.when</code> (backtest only)</td>
</tr>
<tr>
<td><code>getAveragePrice</code></td>
<td>Backwards</td>
<td>Yes</td>
<td>Calculate VWAP from recent candles at <code>context.when</code></td>
</tr>
</tbody>
</table>
<a id="time-calculation-logic" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Time Calculation Logic<a href="#time-calculation-logic" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>When <code>getCandles(symbol, &quot;1m&quot;, 100)</code> is called:</p>
<ol>
<li><code>ClientExchange</code> reads <code>context.when</code> from <code>ExecutionContextService</code></li>
<li>Calculates <code>since = context.when - (interval × limit)</code></li>
<li>Calls <code>schema.getCandles(symbol, interval, since, limit)</code></li>
<li>Filters results to range <code>[since, context.when]</code></li>
<li>Returns filtered candles</li>
</ol>
<hr>
<a id="candle-filtering-and-validation" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Candle Filtering and Validation<a href="#candle-filtering-and-validation" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p><code>ClientExchange</code> performs automatic filtering and validation on candles returned by user schemas:</p>
<a id="timestamp-filtering" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Timestamp Filtering<a href="#timestamp-filtering" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><pre><code class="typescript"><span class="hl-5">// From ClientExchange.getCandles</span><br/><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">whenTimestamp</span><span class="hl-1"> = </span><span class="hl-6">this</span><span class="hl-1">.</span><span class="hl-4">params</span><span class="hl-1">.</span><span class="hl-4">execution</span><span class="hl-1">.</span><span class="hl-4">context</span><span class="hl-1">.</span><span class="hl-4">when</span><span class="hl-1">.</span><span class="hl-0">getTime</span><span class="hl-1">();</span><br/><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">sinceTimestamp</span><span class="hl-1"> = </span><span class="hl-4">since</span><span class="hl-1">.</span><span class="hl-0">getTime</span><span class="hl-1">();</span><br/><br/><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">filteredData</span><span class="hl-1"> = </span><span class="hl-4">data</span><span class="hl-1">.</span><span class="hl-0">filter</span><span class="hl-1">(</span><br/><span class="hl-1">  (</span><span class="hl-4">candle</span><span class="hl-1">) </span><span class="hl-6">=&gt;</span><br/><span class="hl-1">    </span><span class="hl-4">candle</span><span class="hl-1">.</span><span class="hl-4">timestamp</span><span class="hl-1"> &gt;= </span><span class="hl-4">sinceTimestamp</span><span class="hl-1"> &amp;&amp; </span><span class="hl-4">candle</span><span class="hl-1">.</span><span class="hl-4">timestamp</span><span class="hl-1"> &lt;= </span><span class="hl-4">whenTimestamp</span><br/><span class="hl-1">);</span>
</code><button type="button">Copy</button></pre>

<p>This ensures only candles within the requested time range are returned, even if the user schema returns extra candles.</p>
<a id="count-validation" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Count Validation<a href="#count-validation" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><pre><code class="typescript"><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-4">filteredData</span><span class="hl-1">.</span><span class="hl-4">length</span><span class="hl-1"> &lt; </span><span class="hl-4">limit</span><span class="hl-1">) {</span><br/><span class="hl-1">  </span><span class="hl-6">this</span><span class="hl-1">.</span><span class="hl-4">params</span><span class="hl-1">.</span><span class="hl-4">logger</span><span class="hl-1">.</span><span class="hl-0">warn</span><span class="hl-1">(</span><br/><span class="hl-1">    </span><span class="hl-2">`ClientExchange Expected </span><span class="hl-6">${</span><span class="hl-4">limit</span><span class="hl-6">}</span><span class="hl-2"> candles, got </span><span class="hl-6">${</span><span class="hl-4">filteredData</span><span class="hl-9">.</span><span class="hl-4">length</span><span class="hl-6">}</span><span class="hl-2">`</span><br/><span class="hl-1">  );</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<p>Logs warnings when fewer candles than requested are returned, indicating potential data gaps or quality issues.</p>
<hr>
<a id="bidirectional-candle-fetching" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Bidirectional Candle Fetching<a href="#bidirectional-candle-fetching" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p><img src="../media/43_Custom_Exchange_Integration_3.svg" alt="Mermaid Diagram"></p>
<p><strong>Diagram: Bidirectional candle fetching in backtest mode</strong></p>
<ul>
<li><strong>Backward fetching</strong> (<code>getCandles</code>): Used by strategies to access historical data for indicators</li>
<li><strong>Forward fetching</strong> (<code>getNextCandles</code>): Used by backtest simulation to get future candles for signal outcome</li>
</ul>
<p>Both methods call the same <code>schema.getCandles()</code> implementation but with different time ranges.</p>
<hr>
<a id="integration-with-framework-services" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Integration with Framework Services<a href="#integration-with-framework-services" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p><img src="../media/43_Custom_Exchange_Integration_4.svg" alt="Mermaid Diagram"></p>
<p><strong>Diagram: How user exchange schema integrates with framework service layers</strong></p>
<p>The framework uses dependency injection to route exchange calls through multiple service layers:</p>
<ol>
<li><strong>SchemaService</strong>: Stores registered schemas by name</li>
<li><strong>ConnectionService</strong>: Creates and caches <code>ClientExchange</code> instances</li>
<li><strong>GlobalService</strong>: Injects execution context before method calls</li>
<li><strong>ClientExchange</strong>: Wraps user schema with enhanced functionality</li>
</ol>
<hr>
<a id="testing-exchange-implementations" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Testing Exchange Implementations<a href="#testing-exchange-implementations" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>When implementing custom exchanges, test the following scenarios:</p>
<a id="data-quality-tests" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Data Quality Tests<a href="#data-quality-tests" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><table>
<thead>
<tr>
<th>Test Case</th>
<th>Validation</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Complete data</strong></td>
<td>All requested candles returned</td>
</tr>
<tr>
<td><strong>Timestamp alignment</strong></td>
<td>Candles align to interval boundaries</td>
</tr>
<tr>
<td><strong>Sequential timestamps</strong></td>
<td>No gaps or duplicates in sequence</td>
</tr>
<tr>
<td><strong>Valid OHLCV</strong></td>
<td><code>low &lt;= open, close &lt;= high</code></td>
</tr>
<tr>
<td><strong>Positive volume</strong></td>
<td>Volume &gt;= 0 for all candles</td>
</tr>
</tbody>
</table>
<a id="edge-case-tests" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Edge Case Tests<a href="#edge-case-tests" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><table>
<thead>
<tr>
<th>Test Case</th>
<th>Expected Behavior</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Empty result</strong></td>
<td>Return <code>[]</code> when no data available</td>
</tr>
<tr>
<td><strong>Partial result</strong></td>
<td>Return available candles (framework logs warning)</td>
</tr>
<tr>
<td><strong>Future date</strong></td>
<td>Return <code>[]</code> for dates beyond current time</td>
</tr>
<tr>
<td><strong>Network error</strong></td>
<td>Throw descriptive error</td>
</tr>
<tr>
<td><strong>Invalid symbol</strong></td>
<td>Throw descriptive error</td>
</tr>
</tbody>
</table>
<a id="performance-considerations" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Performance Considerations<a href="#performance-considerations" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><ul>
<li><strong>Caching</strong>: Consider caching candle data to reduce API calls</li>
<li><strong>Batching</strong>: Fetch multiple symbols/intervals efficiently</li>
<li><strong>Rate limiting</strong>: Implement backoff for API rate limits</li>
<li><strong>Timeout handling</strong>: Set reasonable timeouts for data fetches</li>
</ul>
<hr>
<a id="common-implementation-patterns" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Common Implementation Patterns<a href="#common-implementation-patterns" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><a id="pattern-caching-layer" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Pattern: Caching Layer<a href="#pattern-caching-layer" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><pre><code class="typescript"><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">cache</span><span class="hl-1"> = </span><span class="hl-6">new</span><span class="hl-1"> </span><span class="hl-0">Map</span><span class="hl-1">&lt;</span><span class="hl-11">string</span><span class="hl-1">, </span><span class="hl-11">ICandleData</span><span class="hl-1">[]&gt;();</span><br/><br/><span class="hl-0">addExchange</span><span class="hl-1">({</span><br/><span class="hl-1">  </span><span class="hl-4">exchangeName:</span><span class="hl-1"> </span><span class="hl-2">&quot;cached-exchange&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><br/><span class="hl-1">  </span><span class="hl-6">async</span><span class="hl-1"> </span><span class="hl-0">getCandles</span><span class="hl-1">(</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">interval</span><span class="hl-1">, </span><span class="hl-4">since</span><span class="hl-1">, </span><span class="hl-4">limit</span><span class="hl-1">) {</span><br/><span class="hl-1">    </span><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">cacheKey</span><span class="hl-1"> = </span><span class="hl-2">`</span><span class="hl-6">${</span><span class="hl-4">symbol</span><span class="hl-6">}</span><span class="hl-2">-</span><span class="hl-6">${</span><span class="hl-4">interval</span><span class="hl-6">}</span><span class="hl-2">-</span><span class="hl-6">${</span><span class="hl-4">since</span><span class="hl-9">.</span><span class="hl-0">getTime</span><span class="hl-9">()</span><span class="hl-6">}</span><span class="hl-2">-</span><span class="hl-6">${</span><span class="hl-4">limit</span><span class="hl-6">}</span><span class="hl-2">`</span><span class="hl-1">;</span><br/><span class="hl-1">    </span><br/><span class="hl-1">    </span><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-4">cache</span><span class="hl-1">.</span><span class="hl-0">has</span><span class="hl-1">(</span><span class="hl-4">cacheKey</span><span class="hl-1">)) {</span><br/><span class="hl-1">      </span><span class="hl-3">return</span><span class="hl-1"> </span><span class="hl-4">cache</span><span class="hl-1">.</span><span class="hl-0">get</span><span class="hl-1">(</span><span class="hl-4">cacheKey</span><span class="hl-1">)!;</span><br/><span class="hl-1">    }</span><br/><span class="hl-1">    </span><br/><span class="hl-1">    </span><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">candles</span><span class="hl-1"> = </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-0">fetchFromSource</span><span class="hl-1">(</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">interval</span><span class="hl-1">, </span><span class="hl-4">since</span><span class="hl-1">, </span><span class="hl-4">limit</span><span class="hl-1">);</span><br/><span class="hl-1">    </span><span class="hl-4">cache</span><span class="hl-1">.</span><span class="hl-0">set</span><span class="hl-1">(</span><span class="hl-4">cacheKey</span><span class="hl-1">, </span><span class="hl-4">candles</span><span class="hl-1">);</span><br/><span class="hl-1">    </span><br/><span class="hl-1">    </span><span class="hl-3">return</span><span class="hl-1"> </span><span class="hl-4">candles</span><span class="hl-1">;</span><br/><span class="hl-1">  },</span><br/><span class="hl-1">  </span><br/><span class="hl-1">  </span><span class="hl-5">// ... other methods</span><br/><span class="hl-1">});</span>
</code><button type="button">Copy</button></pre>

<a id="pattern-connection-pooling" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Pattern: Connection Pooling<a href="#pattern-connection-pooling" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><pre><code class="typescript"><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">pool</span><span class="hl-1"> = </span><span class="hl-0">createConnectionPool</span><span class="hl-1">({</span><br/><span class="hl-1">  </span><span class="hl-4">max:</span><span class="hl-1"> </span><span class="hl-8">10</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">min:</span><span class="hl-1"> </span><span class="hl-8">2</span><span class="hl-1">,</span><br/><span class="hl-1">});</span><br/><br/><span class="hl-0">addExchange</span><span class="hl-1">({</span><br/><span class="hl-1">  </span><span class="hl-4">exchangeName:</span><span class="hl-1"> </span><span class="hl-2">&quot;pooled-db&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><br/><span class="hl-1">  </span><span class="hl-6">async</span><span class="hl-1"> </span><span class="hl-0">getCandles</span><span class="hl-1">(</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">interval</span><span class="hl-1">, </span><span class="hl-4">since</span><span class="hl-1">, </span><span class="hl-4">limit</span><span class="hl-1">) {</span><br/><span class="hl-1">    </span><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">connection</span><span class="hl-1"> = </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-4">pool</span><span class="hl-1">.</span><span class="hl-0">acquire</span><span class="hl-1">();</span><br/><span class="hl-1">    </span><span class="hl-3">try</span><span class="hl-1"> {</span><br/><span class="hl-1">      </span><span class="hl-3">return</span><span class="hl-1"> </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-4">connection</span><span class="hl-1">.</span><span class="hl-0">query</span><span class="hl-1">(</span><span class="hl-5">/* ... */</span><span class="hl-1">);</span><br/><span class="hl-1">    } </span><span class="hl-3">finally</span><span class="hl-1"> {</span><br/><span class="hl-1">      </span><span class="hl-4">pool</span><span class="hl-1">.</span><span class="hl-0">release</span><span class="hl-1">(</span><span class="hl-4">connection</span><span class="hl-1">);</span><br/><span class="hl-1">    }</span><br/><span class="hl-1">  },</span><br/><span class="hl-1">  </span><br/><span class="hl-1">  </span><span class="hl-5">// ... other methods</span><br/><span class="hl-1">});</span>
</code><button type="button">Copy</button></pre>

<a id="pattern-retry-logic" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Pattern: Retry Logic<a href="#pattern-retry-logic" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><pre><code class="typescript"><span class="hl-6">async</span><span class="hl-1"> </span><span class="hl-6">function</span><span class="hl-1"> </span><span class="hl-0">fetchWithRetry</span><span class="hl-1">(</span><span class="hl-0">fn</span><span class="hl-1">: () </span><span class="hl-6">=&gt;</span><span class="hl-1"> </span><span class="hl-11">Promise</span><span class="hl-1">&lt;</span><span class="hl-11">any</span><span class="hl-1">&gt;, </span><span class="hl-4">maxRetries</span><span class="hl-1"> = </span><span class="hl-8">3</span><span class="hl-1">) {</span><br/><span class="hl-1">  </span><span class="hl-3">for</span><span class="hl-1"> (</span><span class="hl-6">let</span><span class="hl-1"> </span><span class="hl-4">i</span><span class="hl-1"> = </span><span class="hl-8">0</span><span class="hl-1">; </span><span class="hl-4">i</span><span class="hl-1"> &lt; </span><span class="hl-4">maxRetries</span><span class="hl-1">; </span><span class="hl-4">i</span><span class="hl-1">++) {</span><br/><span class="hl-1">    </span><span class="hl-3">try</span><span class="hl-1"> {</span><br/><span class="hl-1">      </span><span class="hl-3">return</span><span class="hl-1"> </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-0">fn</span><span class="hl-1">();</span><br/><span class="hl-1">    } </span><span class="hl-3">catch</span><span class="hl-1"> (</span><span class="hl-4">error</span><span class="hl-1">) {</span><br/><span class="hl-1">      </span><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-4">i</span><span class="hl-1"> === </span><span class="hl-4">maxRetries</span><span class="hl-1"> - </span><span class="hl-8">1</span><span class="hl-1">) </span><span class="hl-3">throw</span><span class="hl-1"> </span><span class="hl-4">error</span><span class="hl-1">;</span><br/><span class="hl-1">      </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-6">new</span><span class="hl-1"> </span><span class="hl-11">Promise</span><span class="hl-1">(</span><span class="hl-4">resolve</span><span class="hl-1"> </span><span class="hl-6">=&gt;</span><span class="hl-1"> </span><span class="hl-0">setTimeout</span><span class="hl-1">(</span><span class="hl-4">resolve</span><span class="hl-1">, </span><span class="hl-8">1000</span><span class="hl-1"> * (</span><span class="hl-4">i</span><span class="hl-1"> + </span><span class="hl-8">1</span><span class="hl-1">)));</span><br/><span class="hl-1">    }</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">}</span><br/><br/><span class="hl-0">addExchange</span><span class="hl-1">({</span><br/><span class="hl-1">  </span><span class="hl-4">exchangeName:</span><span class="hl-1"> </span><span class="hl-2">&quot;retry-exchange&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><br/><span class="hl-1">  </span><span class="hl-6">async</span><span class="hl-1"> </span><span class="hl-0">getCandles</span><span class="hl-1">(</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">interval</span><span class="hl-1">, </span><span class="hl-4">since</span><span class="hl-1">, </span><span class="hl-4">limit</span><span class="hl-1">) {</span><br/><span class="hl-1">    </span><span class="hl-3">return</span><span class="hl-1"> </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-0">fetchWithRetry</span><span class="hl-1">(() </span><span class="hl-6">=&gt;</span><span class="hl-1"> </span><br/><span class="hl-1">      </span><span class="hl-0">fetch</span><span class="hl-1">(</span><span class="hl-5">/* ... */</span><span class="hl-1">).</span><span class="hl-0">then</span><span class="hl-1">(</span><span class="hl-4">r</span><span class="hl-1"> </span><span class="hl-6">=&gt;</span><span class="hl-1"> </span><span class="hl-4">r</span><span class="hl-1">.</span><span class="hl-0">json</span><span class="hl-1">())</span><br/><span class="hl-1">    );</span><br/><span class="hl-1">  },</span><br/><span class="hl-1">  </span><br/><span class="hl-1">  </span><span class="hl-5">// ... other methods</span><br/><span class="hl-1">});</span>
</code><button type="button">Copy</button></pre>

<hr>
<a id="error-handling-guidelines" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Error Handling Guidelines<a href="#error-handling-guidelines" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>Exchange implementations should throw descriptive errors that help diagnose issues:</p>
<a id="error-message-format" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Error Message Format<a href="#error-message-format" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><pre><code class="typescript"><span class="hl-3">throw</span><span class="hl-1"> </span><span class="hl-6">new</span><span class="hl-1"> </span><span class="hl-0">Error</span><span class="hl-1">(</span><span class="hl-2">`[</span><span class="hl-6">${</span><span class="hl-4">exchangeName</span><span class="hl-6">}</span><span class="hl-2">] </span><span class="hl-6">${</span><span class="hl-4">operation</span><span class="hl-6">}</span><span class="hl-2">: </span><span class="hl-6">${</span><span class="hl-4">reason</span><span class="hl-6">}</span><span class="hl-2">`</span><span class="hl-1">);</span>
</code><button type="button">Copy</button></pre>

<a id="common-error-scenarios" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Common Error Scenarios<a href="#common-error-scenarios" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><table>
<thead>
<tr>
<th>Scenario</th>
<th>Error Message Example</th>
</tr>
</thead>
<tbody>
<tr>
<td>Network failure</td>
<td><code>[binance-api] getCandles: Network request failed</code></td>
</tr>
<tr>
<td>Invalid symbol</td>
<td><code>[database] getCandles: Symbol 'INVALID' not found</code></td>
</tr>
<tr>
<td>Data corruption</td>
<td><code>[csv-files] getCandles: Malformed CSV data</code></td>
</tr>
<tr>
<td>Rate limit</td>
<td><code>[rest-api] getCandles: Rate limit exceeded, retry after 60s</code></td>
</tr>
<tr>
<td>Authentication</td>
<td><code>[exchange-api] getCandles: API key invalid or expired</code></td>
</tr>
</tbody>
</table>
<a id="example-error-handling" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Example Error Handling<a href="#example-error-handling" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><pre><code class="typescript"><span class="hl-0">addExchange</span><span class="hl-1">({</span><br/><span class="hl-1">  </span><span class="hl-4">exchangeName:</span><span class="hl-1"> </span><span class="hl-2">&quot;safe-exchange&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><br/><span class="hl-1">  </span><span class="hl-6">async</span><span class="hl-1"> </span><span class="hl-0">getCandles</span><span class="hl-1">(</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">interval</span><span class="hl-1">, </span><span class="hl-4">since</span><span class="hl-1">, </span><span class="hl-4">limit</span><span class="hl-1">) {</span><br/><span class="hl-1">    </span><span class="hl-3">try</span><span class="hl-1"> {</span><br/><span class="hl-1">      </span><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">response</span><span class="hl-1"> = </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-0">fetch</span><span class="hl-1">(</span><span class="hl-5">/* ... */</span><span class="hl-1">);</span><br/><span class="hl-1">      </span><br/><span class="hl-1">      </span><span class="hl-3">if</span><span class="hl-1"> (!</span><span class="hl-4">response</span><span class="hl-1">.</span><span class="hl-4">ok</span><span class="hl-1">) {</span><br/><span class="hl-1">        </span><span class="hl-3">throw</span><span class="hl-1"> </span><span class="hl-6">new</span><span class="hl-1"> </span><span class="hl-0">Error</span><span class="hl-1">(</span><span class="hl-2">`HTTP </span><span class="hl-6">${</span><span class="hl-4">response</span><span class="hl-9">.</span><span class="hl-4">status</span><span class="hl-6">}</span><span class="hl-2">: </span><span class="hl-6">${</span><span class="hl-4">response</span><span class="hl-9">.</span><span class="hl-4">statusText</span><span class="hl-6">}</span><span class="hl-2">`</span><span class="hl-1">);</span><br/><span class="hl-1">      }</span><br/><span class="hl-1">      </span><br/><span class="hl-1">      </span><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">data</span><span class="hl-1"> = </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-4">response</span><span class="hl-1">.</span><span class="hl-0">json</span><span class="hl-1">();</span><br/><span class="hl-1">      </span><br/><span class="hl-1">      </span><span class="hl-3">if</span><span class="hl-1"> (!</span><span class="hl-4">Array</span><span class="hl-1">.</span><span class="hl-0">isArray</span><span class="hl-1">(</span><span class="hl-4">data</span><span class="hl-1">.</span><span class="hl-4">candles</span><span class="hl-1">)) {</span><br/><span class="hl-1">        </span><span class="hl-3">throw</span><span class="hl-1"> </span><span class="hl-6">new</span><span class="hl-1"> </span><span class="hl-0">Error</span><span class="hl-1">(</span><span class="hl-2">&quot;Invalid response format: missing candles array&quot;</span><span class="hl-1">);</span><br/><span class="hl-1">      }</span><br/><span class="hl-1">      </span><br/><span class="hl-1">      </span><span class="hl-3">return</span><span class="hl-1"> </span><span class="hl-4">data</span><span class="hl-1">.</span><span class="hl-4">candles</span><span class="hl-1">;</span><br/><span class="hl-1">    } </span><span class="hl-3">catch</span><span class="hl-1"> (</span><span class="hl-4">error</span><span class="hl-1">) {</span><br/><span class="hl-1">      </span><span class="hl-3">throw</span><span class="hl-1"> </span><span class="hl-6">new</span><span class="hl-1"> </span><span class="hl-0">Error</span><span class="hl-1">(</span><br/><span class="hl-1">        </span><span class="hl-2">`[safe-exchange] getCandles failed for </span><span class="hl-6">${</span><span class="hl-4">symbol</span><span class="hl-6">}</span><span class="hl-2"> </span><span class="hl-6">${</span><span class="hl-4">interval</span><span class="hl-6">}</span><span class="hl-2">: </span><span class="hl-6">${</span><span class="hl-4">error</span><span class="hl-9">.</span><span class="hl-4">message</span><span class="hl-6">}</span><span class="hl-2">`</span><br/><span class="hl-1">      );</span><br/><span class="hl-1">    }</span><br/><span class="hl-1">  },</span><br/><span class="hl-1">  </span><br/><span class="hl-1">  </span><span class="hl-5">// ... other methods</span><br/><span class="hl-1">});</span>
</code><button type="button">Copy</button></pre>

<hr>
<a id="summary" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Summary<a href="#summary" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>Custom exchange integration requires implementing three core methods (<code>getCandles</code>, <code>formatPrice</code>, <code>formatQuantity</code>) via the <code>IExchangeSchema</code> interface. The framework wraps user schemas with <code>ClientExchange</code> to add VWAP calculation, execution context integration, and bidirectional candle fetching. This design enables backtesting and live trading with any data source while maintaining a clean separation between data retrieval and business logic.</p>
<p><strong>Key implementation requirements:</strong></p>
<ul>
<li>Return candles in ascending timestamp order</li>
<li>Handle errors with descriptive messages</li>
<li>Respect exchange precision in formatting methods</li>
<li>Consider caching and rate limiting for production use</li>
</ul>
</div></div><div class="col-sidebar"><div class="page-menu"><div class="tsd-navigation settings"><details class="tsd-accordion"><summary class="tsd-accordion-summary"><h3><svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-chevronDown"></use></svg>Settings</h3></summary><div class="tsd-accordion-details"><div class="tsd-filter-visibility"><span class="settings-label">Member Visibility</span><ul id="tsd-filter-options"><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-protected" name="protected"/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Protected</span></label></li><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-inherited" name="inherited" checked/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Inherited</span></label></li><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-external" name="external"/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>External</span></label></li></ul></div><div class="tsd-theme-toggle"><label class="settings-label" for="tsd-theme">Theme</label><select id="tsd-theme"><option value="os">OS</option><option value="light">Light</option><option value="dark">Dark</option></select></div></div></details></div><details open class="tsd-accordion tsd-page-navigation"><summary class="tsd-accordion-summary"><h3><svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-chevronDown"></use></svg>On This Page</h3></summary><div class="tsd-accordion-details"><a href="#custom-exchange-integration"><span>Custom <wbr/>Exchange <wbr/>Integration</span></a><ul><li><a href="#overview"><span>Overview</span></a></li><li><a href="#exchange-integration-architecture"><span>Exchange <wbr/>Integration <wbr/>Architecture</span></a></li><li><a href="#iexchangeschema-interface"><span>IExchange<wbr/>Schema <wbr/>Interface</span></a></li><li><a href="#implementing-getcandles"><span>Implementing get<wbr/>Candles</span></a></li><li><ul><li><a href="#method-signature"><span>Method <wbr/>Signature</span></a></li><li><a href="#parameters"><span>Parameters</span></a></li><li><a href="#return-value"><span>Return <wbr/>Value</span></a></li><li><a href="#implementation-requirements"><span>Implementation <wbr/>Requirements</span></a></li></ul></li><li><a href="#clientexchange-candle-processing"><span>Client<wbr/>Exchange <wbr/>Candle <wbr/>Processing</span></a></li><li><a href="#example-rest-api-exchange"><span>Example: REST API <wbr/>Exchange</span></a></li><li><a href="#example-database-exchange"><span>Example: <wbr/>Database <wbr/>Exchange</span></a></li><li><a href="#example-csv-file-exchange"><span>Example: CSV <wbr/>File <wbr/>Exchange</span></a></li><li><a href="#price-and-quantity-formatting"><span>Price and <wbr/>Quantity <wbr/>Formatting</span></a></li><li><ul><li><a href="#formatprice-implementation"><span>format<wbr/>Price <wbr/>Implementation</span></a></li><li><a href="#formatquantity-implementation"><span>format<wbr/>Quantity <wbr/>Implementation</span></a></li></ul></li><li><a href="#lifecycle-callbacks"><span>Lifecycle <wbr/>Callbacks</span></a></li><li><ul><li><a href="#iexchangecallbacks-interface"><span>IExchange<wbr/>Callbacks <wbr/>Interface</span></a></li><li><a href="#callback-usage"><span>Callback <wbr/>Usage</span></a></li></ul></li><li><a href="#vwap-calculation-by-clientexchange"><span>VWAP <wbr/>Calculation by <wbr/>Client<wbr/>Exchange</span></a></li><li><a href="#execution-context-integration"><span>Execution <wbr/>Context <wbr/>Integration</span></a></li><li><ul><li><a href="#context-aware-candle-fetching"><span>Context-<wbr/>Aware <wbr/>Candle <wbr/>Fetching</span></a></li><li><a href="#time-calculation-logic"><span>Time <wbr/>Calculation <wbr/>Logic</span></a></li></ul></li><li><a href="#candle-filtering-and-validation"><span>Candle <wbr/>Filtering and <wbr/>Validation</span></a></li><li><ul><li><a href="#timestamp-filtering"><span>Timestamp <wbr/>Filtering</span></a></li><li><a href="#count-validation"><span>Count <wbr/>Validation</span></a></li></ul></li><li><a href="#bidirectional-candle-fetching"><span>Bidirectional <wbr/>Candle <wbr/>Fetching</span></a></li><li><a href="#integration-with-framework-services"><span>Integration with <wbr/>Framework <wbr/>Services</span></a></li><li><a href="#testing-exchange-implementations"><span>Testing <wbr/>Exchange <wbr/>Implementations</span></a></li><li><ul><li><a href="#data-quality-tests"><span>Data <wbr/>Quality <wbr/>Tests</span></a></li><li><a href="#edge-case-tests"><span>Edge <wbr/>Case <wbr/>Tests</span></a></li><li><a href="#performance-considerations"><span>Performance <wbr/>Considerations</span></a></li></ul></li><li><a href="#common-implementation-patterns"><span>Common <wbr/>Implementation <wbr/>Patterns</span></a></li><li><ul><li><a href="#pattern-caching-layer"><span>Pattern: <wbr/>Caching <wbr/>Layer</span></a></li><li><a href="#pattern-connection-pooling"><span>Pattern: <wbr/>Connection <wbr/>Pooling</span></a></li><li><a href="#pattern-retry-logic"><span>Pattern: <wbr/>Retry <wbr/>Logic</span></a></li></ul></li><li><a href="#error-handling-guidelines"><span>Error <wbr/>Handling <wbr/>Guidelines</span></a></li><li><ul><li><a href="#error-message-format"><span>Error <wbr/>Message <wbr/>Format</span></a></li><li><a href="#common-error-scenarios"><span>Common <wbr/>Error <wbr/>Scenarios</span></a></li><li><a href="#example-error-handling"><span>Example <wbr/>Error <wbr/>Handling</span></a></li></ul></li><li><a href="#summary"><span>Summary</span></a></li></ul></div></details></div><div class="site-menu"><nav class="tsd-navigation"><a href="../modules.html">backtest-kit</a><ul class="tsd-small-nested-navigation" id="tsd-nav-container"><li>Loading...</li></ul></nav></div></div></div><footer><p class="tsd-generator">Generated using <a href="https://typedoc.org/" target="_blank">TypeDoc</a></p></footer><div class="overlay"></div></body></html>

<!-- Yandex.Metrika counter -->
<script type="text/javascript">
    (function(m,e,t,r,i,k,a){
        m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
        m[i].l=1*new Date();
        for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }}
        k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)
    })(window, document,'script','https://mc.yandex.ru/metrika/tag.js?id=105455585', 'ym');

    ym(105455585, 'init', {ssr:true, webvisor:true, clickmap:true, ecommerce:"dataLayer", accurateTrackBounce:true, trackLinks:true});
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/105455585" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
<!-- /Yandex.Metrika counter -->

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-3MQZEBBDDR"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-3MQZEBBDDR');
</script>
