<!DOCTYPE html><html class="default" lang="en" data-base=".."><head><meta charset="utf-8"/><meta http-equiv="x-ua-compatible" content="IE=edge"/><title>design/37_clientsizing | backtest-kit</title><meta name="description" content="Documentation for backtest-kit"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="stylesheet" href="../assets/style.css"/><link rel="stylesheet" href="../assets/highlight.css"/><script defer src="../assets/main.js"></script><script async src="../assets/icons.js" id="tsd-icons-script"></script><script async src="../assets/search.js" id="tsd-search-script"></script><script async src="../assets/navigation.js" id="tsd-nav-script"></script><script async src="../assets/hierarchy.js" id="tsd-hierarchy-script"></script></head><body><script>document.documentElement.dataset.theme = localStorage.getItem("tsd-theme") || "os";document.body.style.display="none";setTimeout(() => app?app.showPage():document.body.style.removeProperty("display"),500)</script><header class="tsd-page-toolbar"><div class="tsd-toolbar-contents container"><div class="table-cell" id="tsd-search"><div class="field"><label for="tsd-search-field" class="tsd-widget tsd-toolbar-icon search no-caption"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-search"></use></svg></label><input type="text" id="tsd-search-field" aria-label="Search"/></div><div class="field"><div id="tsd-toolbar-links"></div></div><ul class="results"><li class="state loading">Preparing search index...</li><li class="state failure">The search index is not available</li></ul><a href="../index.html" class="title">backtest-kit</a></div><div class="table-cell" id="tsd-widgets"><a href="#" class="tsd-widget tsd-toolbar-icon menu no-caption" data-toggle="menu" aria-label="Menu"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-menu"></use></svg></a></div></div></header><div class="container container-main"><div class="col-content"><div class="tsd-page-title"><ul class="tsd-breadcrumb"><li><a href="../modules.html">backtest-kit</a></li><li><a href="design_37_clientsizing.html">design/37_clientsizing</a></li></ul></div><div class="tsd-panel tsd-typography"><a id="clientsizing" class="tsd-anchor"></a><h1 class="tsd-anchor-link">ClientSizing<a href="#clientsizing" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h1><p>ClientSizing implements position size calculation logic for trading signals. It provides three distinct sizing methods: fixed percentage allocation, Kelly criterion optimization, and ATR-based volatility scaling. This class belongs to the Client Classes layer (Layer 4) and operates without dependency injection, accepting all dependencies through constructor parameters.</p>
<p>For information about risk validation and portfolio limits, see <a href="design_36_clientrisk.html">ClientRisk</a>. For strategy-level signal generation, see <a href="design_33_clientstrategy.html">ClientStrategy</a>.</p>
<a id="purpose-and-scope" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Purpose and Scope<a href="#purpose-and-scope" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>ClientSizing calculates the quantity of an asset to trade based on portfolio state and signal parameters. It consumes a sizing schema (registered via <code>addSizing()</code>) and execution context, then returns a formatted position size via the <code>calculatePositionSize()</code> method. The calculation considers:</p>
<ul>
<li>Portfolio balance</li>
<li>Signal parameters (entry price, stop loss)</li>
<li>Historical price data (for ATR calculations)</li>
<li>Risk tolerance parameters from the sizing schema</li>
</ul>
<p>ClientSizing does not validate signals, track positions, or interact with exchanges. These responsibilities belong to ClientStrategy, ClientRisk, and ClientExchange respectively.</p>
<a id="architecture-context" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Architecture Context<a href="#architecture-context" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>ClientSizing sits in the Client Classes layer and is instantiated by SizingConnectionService. The connection service memoizes one ClientSizing instance per sizing schema name.</p>
<p><img src="../media/37_ClientSizing_0.svg" alt="Mermaid Diagram"></p>
<a id="sizing-schema-types" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Sizing Schema Types<a href="#sizing-schema-types" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>ClientSizing supports three sizing methods, each defined by a discriminated union type. The <code>method</code> field serves as the discriminator.</p>
<a id="schema-comparison-table" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Schema Comparison Table<a href="#schema-comparison-table" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><table>
<thead>
<tr>
<th>Method</th>
<th>Discriminator</th>
<th>Key Parameters</th>
<th>Use Case</th>
</tr>
</thead>
<tbody>
<tr>
<td>Fixed Percentage</td>
<td><code>&quot;fixed-percentage&quot;</code></td>
<td><code>percentage</code></td>
<td>Simple constant allocation</td>
</tr>
<tr>
<td>Kelly Criterion</td>
<td><code>&quot;kelly-criterion&quot;</code></td>
<td><code>winRate</code>, <code>avgWinPnl</code>, <code>avgLossPnl</code></td>
<td>Optimal allocation based on edge</td>
</tr>
<tr>
<td>ATR-Based</td>
<td><code>&quot;atr-based&quot;</code></td>
<td><code>atrMultiplier</code>, <code>atrPeriod</code></td>
<td>Volatility-adjusted sizing</td>
</tr>
</tbody>
</table>
<a id="fixed-percentage-method" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Fixed Percentage Method<a href="#fixed-percentage-method" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>Fixed percentage sizing allocates a constant percentage of the portfolio to each trade. This is the simplest method and requires no historical data or performance statistics.</p>
<a id="schema-interface" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Schema Interface<a href="#schema-interface" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>The schema for fixed percentage sizing:</p>
<pre><code class="typescript"><span class="hl-7">interface</span><span class="hl-1"> </span><span class="hl-11">ISizingSchemaFixedPercentage</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-4">sizingName</span><span class="hl-1">: </span><span class="hl-11">string</span><span class="hl-1">;</span><br/><span class="hl-1">  </span><span class="hl-4">method</span><span class="hl-1">: </span><span class="hl-2">&quot;fixed-percentage&quot;</span><span class="hl-1">;</span><br/><span class="hl-1">  </span><span class="hl-4">params</span><span class="hl-1">: {</span><br/><span class="hl-1">    </span><span class="hl-4">percentage</span><span class="hl-1">: </span><span class="hl-11">number</span><span class="hl-1">;  </span><span class="hl-5">// e.g., 0.02 for 2% of portfolio</span><br/><span class="hl-1">  };</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<a id="calculation-parameters" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Calculation Parameters<a href="#calculation-parameters" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>When ClientStrategy calls <code>calculatePositionSize()</code> for a fixed percentage signal:</p>
<pre><code class="typescript"><span class="hl-7">interface</span><span class="hl-1"> </span><span class="hl-11">ISizingCalculateParamsFixedPercentage</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-4">method</span><span class="hl-1">: </span><span class="hl-2">&quot;fixed-percentage&quot;</span><span class="hl-1">;</span><br/><span class="hl-1">  </span><span class="hl-4">params</span><span class="hl-1">: {</span><br/><span class="hl-1">    </span><span class="hl-4">portfolioBalance</span><span class="hl-1">: </span><span class="hl-11">number</span><span class="hl-1">;  </span><span class="hl-5">// Current account balance</span><br/><span class="hl-1">    </span><span class="hl-4">entryPrice</span><span class="hl-1">: </span><span class="hl-11">number</span><span class="hl-1">;        </span><span class="hl-5">// Signal&#39;s priceOpen</span><br/><span class="hl-1">  };</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<a id="calculation-logic" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Calculation Logic<a href="#calculation-logic" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>The position size formula:</p>
<pre><code><span class="hl-4">positionSize</span><span class="hl-1"> = (</span><span class="hl-4">portfolioBalance</span><span class="hl-1"> × </span><span class="hl-4">percentage</span><span class="hl-1">) / </span><span class="hl-4">entryPrice</span>
</code><button>Copy</button></pre>

<p><strong>Example:</strong></p>
<ul>
<li>Portfolio balance: $10,000</li>
<li>Percentage: 2% (0.02)</li>
<li>Entry price: $50,000 (BTC)</li>
<li>Position size: (10,000 × 0.02) / 50,000 = 0.004 BTC</li>
</ul>
<a id="kelly-criterion-method" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Kelly Criterion Method<a href="#kelly-criterion-method" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>Kelly criterion sizing maximizes long-term growth by calculating optimal position size based on historical win rate and average profit/loss ratios.</p>
<a id="schema-interface-1" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Schema Interface<a href="#schema-interface-1" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><pre><code class="typescript"><span class="hl-7">interface</span><span class="hl-1"> </span><span class="hl-11">ISizingSchemaKelly</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-4">sizingName</span><span class="hl-1">: </span><span class="hl-11">string</span><span class="hl-1">;</span><br/><span class="hl-1">  </span><span class="hl-4">method</span><span class="hl-1">: </span><span class="hl-2">&quot;kelly-criterion&quot;</span><span class="hl-1">;</span><br/><span class="hl-1">  </span><span class="hl-4">params</span><span class="hl-1">: {</span><br/><span class="hl-1">    </span><span class="hl-4">winRate</span><span class="hl-1">: </span><span class="hl-11">number</span><span class="hl-1">;      </span><span class="hl-5">// Win rate as decimal (e.g., 0.55 for 55%)</span><br/><span class="hl-1">    </span><span class="hl-4">avgWinPnl</span><span class="hl-1">: </span><span class="hl-11">number</span><span class="hl-1">;    </span><span class="hl-5">// Average winning PNL percentage</span><br/><span class="hl-1">    </span><span class="hl-4">avgLossPnl</span><span class="hl-1">: </span><span class="hl-11">number</span><span class="hl-1">;   </span><span class="hl-5">// Average losing PNL percentage (absolute value)</span><br/><span class="hl-1">  };</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<a id="calculation-parameters-1" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Calculation Parameters<a href="#calculation-parameters-1" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><pre><code class="typescript"><span class="hl-7">interface</span><span class="hl-1"> </span><span class="hl-11">ISizingCalculateParamsKelly</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-4">method</span><span class="hl-1">: </span><span class="hl-2">&quot;kelly-criterion&quot;</span><span class="hl-1">;</span><br/><span class="hl-1">  </span><span class="hl-4">params</span><span class="hl-1">: {</span><br/><span class="hl-1">    </span><span class="hl-4">portfolioBalance</span><span class="hl-1">: </span><span class="hl-11">number</span><span class="hl-1">;</span><br/><span class="hl-1">    </span><span class="hl-4">entryPrice</span><span class="hl-1">: </span><span class="hl-11">number</span><span class="hl-1">;</span><br/><span class="hl-1">  };</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<a id="calculation-logic-1" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Calculation Logic<a href="#calculation-logic-1" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>The Kelly formula:</p>
<pre><code><span class="hl-4">kellyPercentage</span><span class="hl-1"> = (</span><span class="hl-4">winRate</span><span class="hl-1"> × </span><span class="hl-4">avgWinPnl</span><span class="hl-1"> - (</span><span class="hl-6">1</span><span class="hl-1"> - </span><span class="hl-4">winRate</span><span class="hl-1">) × </span><span class="hl-4">avgLossPnl</span><span class="hl-1">) / </span><span class="hl-4">avgWinPnl</span><br/><span class="hl-4">positionSize</span><span class="hl-1"> = (</span><span class="hl-4">portfolioBalance</span><span class="hl-1"> × </span><span class="hl-4">kellyPercentage</span><span class="hl-1">) / </span><span class="hl-4">entryPrice</span>
</code><button>Copy</button></pre>

<p><strong>Example:</strong></p>
<ul>
<li>Win rate: 60% (0.60)</li>
<li>Average win: 5% (0.05)</li>
<li>Average loss: 3% (0.03)</li>
<li>Kelly percentage: (0.60 × 0.05 - 0.40 × 0.03) / 0.05 = 0.36 (36%)</li>
<li>Portfolio balance: $10,000</li>
<li>Entry price: $50,000</li>
<li>Position size: (10,000 × 0.36) / 50,000 = 0.072 BTC</li>
</ul>
<p><strong>Note:</strong> ClientSizing may apply a fractional Kelly (e.g., half-Kelly) to reduce risk.</p>
<a id="atr-based-method" class="tsd-anchor"></a><h2 class="tsd-anchor-link">ATR-Based Method<a href="#atr-based-method" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>ATR (Average True Range) sizing adjusts position size based on market volatility. Higher volatility results in smaller positions, maintaining consistent risk exposure.</p>
<a id="schema-interface-2" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Schema Interface<a href="#schema-interface-2" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><pre><code class="typescript"><span class="hl-7">interface</span><span class="hl-1"> </span><span class="hl-11">ISizingSchemaATR</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-4">sizingName</span><span class="hl-1">: </span><span class="hl-11">string</span><span class="hl-1">;</span><br/><span class="hl-1">  </span><span class="hl-4">method</span><span class="hl-1">: </span><span class="hl-2">&quot;atr-based&quot;</span><span class="hl-1">;</span><br/><span class="hl-1">  </span><span class="hl-4">params</span><span class="hl-1">: {</span><br/><span class="hl-1">    </span><span class="hl-4">atrMultiplier</span><span class="hl-1">: </span><span class="hl-11">number</span><span class="hl-1">;  </span><span class="hl-5">// Multiplier for ATR (e.g., 2.0)</span><br/><span class="hl-1">    </span><span class="hl-4">atrPeriod</span><span class="hl-1">: </span><span class="hl-11">number</span><span class="hl-1">;      </span><span class="hl-5">// Number of periods for ATR calculation (e.g., 14)</span><br/><span class="hl-1">  };</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<a id="calculation-parameters-2" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Calculation Parameters<a href="#calculation-parameters-2" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><pre><code class="typescript"><span class="hl-7">interface</span><span class="hl-1"> </span><span class="hl-11">ISizingCalculateParamsATR</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-4">method</span><span class="hl-1">: </span><span class="hl-2">&quot;atr-based&quot;</span><span class="hl-1">;</span><br/><span class="hl-1">  </span><span class="hl-4">params</span><span class="hl-1">: {</span><br/><span class="hl-1">    </span><span class="hl-4">portfolioBalance</span><span class="hl-1">: </span><span class="hl-11">number</span><span class="hl-1">;</span><br/><span class="hl-1">    </span><span class="hl-4">entryPrice</span><span class="hl-1">: </span><span class="hl-11">number</span><span class="hl-1">;</span><br/><span class="hl-1">    </span><span class="hl-4">stopLoss</span><span class="hl-1">: </span><span class="hl-11">number</span><span class="hl-1">;           </span><span class="hl-5">// Signal&#39;s priceStopLoss</span><br/><span class="hl-1">    </span><span class="hl-4">historicalCandles</span><span class="hl-1">: </span><span class="hl-11">ICandleData</span><span class="hl-1">[];  </span><span class="hl-5">// Candles for ATR calculation</span><br/><span class="hl-1">  };</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<a id="calculation-logic-2" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Calculation Logic<a href="#calculation-logic-2" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>The ATR-based formula:</p>
<pre><code><span class="hl-6">1.</span><span class="hl-1"> </span><span class="hl-4">Calculate</span><span class="hl-1"> </span><span class="hl-8">ATR</span><span class="hl-1"> </span><span class="hl-4">from</span><span class="hl-1"> </span><span class="hl-4">historicalCandles</span><span class="hl-1"> </span><span class="hl-7">using</span><span class="hl-1"> </span><span class="hl-8">atrPeriod</span><br/><span class="hl-6">2.</span><span class="hl-1"> </span><span class="hl-4">stopDistance</span><span class="hl-1"> = |</span><span class="hl-4">entryPrice</span><span class="hl-1"> - </span><span class="hl-4">stopLoss</span><span class="hl-1">|</span><br/><span class="hl-6">3.</span><span class="hl-1"> </span><span class="hl-4">riskPerUnit</span><span class="hl-1"> = </span><span class="hl-4">atrMultiplier</span><span class="hl-1"> × </span><span class="hl-8">ATR</span><br/><span class="hl-6">4.</span><span class="hl-1"> </span><span class="hl-4">positionSize</span><span class="hl-1"> = (</span><span class="hl-4">portfolioBalance</span><span class="hl-1"> × </span><span class="hl-4">riskPercentage</span><span class="hl-1">) / </span><span class="hl-4">riskPerUnit</span>
</code><button>Copy</button></pre>

<p><strong>Example:</strong></p>
<ul>
<li>ATR (14 periods): $500</li>
<li>ATR multiplier: 2.0</li>
<li>Entry price: $50,000</li>
<li>Stop loss: $49,000</li>
<li>Portfolio balance: $10,000</li>
<li>Risk percentage: 2%</li>
<li>Risk per unit: 2.0 × $500 = $1,000</li>
<li>Position size: (10,000 × 0.02) / 1,000 = 0.2 BTC</li>
</ul>
<a id="calculation-flow" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Calculation Flow<a href="#calculation-flow" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>The diagram below shows how ClientSizing integrates into the signal generation flow:</p>
<p><img src="../media/37_ClientSizing_1.svg" alt="Mermaid Diagram"></p>
<a id="isizing-interface" class="tsd-anchor"></a><h2 class="tsd-anchor-link">ISizing Interface<a href="#isizing-interface" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>ClientSizing implements the <code>ISizing</code> interface, which defines the contract for position size calculation:</p>
<pre><code class="typescript"><span class="hl-7">interface</span><span class="hl-1"> </span><span class="hl-11">ISizing</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-0">calculatePositionSize</span><span class="hl-1">(</span><br/><span class="hl-1">    </span><span class="hl-4">params</span><span class="hl-1">: </span><span class="hl-11">ISizingCalculateParams</span><br/><span class="hl-1">  ): </span><span class="hl-11">Promise</span><span class="hl-1">&lt;</span><span class="hl-11">string</span><span class="hl-1">&gt;;</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<a id="parameter-discriminated-union" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Parameter Discriminated Union<a href="#parameter-discriminated-union" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>The <code>ISizingCalculateParams</code> type is a discriminated union matching the sizing method:</p>
<pre><code class="typescript"><span class="hl-7">type</span><span class="hl-1"> </span><span class="hl-11">ISizingCalculateParams</span><span class="hl-1"> = </span><br/><span class="hl-1">  | </span><span class="hl-11">ISizingCalculateParamsFixedPercentage</span><br/><span class="hl-1">  | </span><span class="hl-11">ISizingCalculateParamsKelly</span><br/><span class="hl-1">  | </span><span class="hl-11">ISizingCalculateParamsATR</span><span class="hl-1">;</span>
</code><button type="button">Copy</button></pre>

<p>Each variant contains the <code>method</code> discriminator and method-specific <code>params</code> object.</p>
<a id="return-value" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Return Value<a href="#return-value" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>The <code>calculatePositionSize()</code> method returns a <code>Promise&lt;string&gt;</code> containing the formatted quantity. This string is formatted according to the exchange's precision rules via <code>ClientExchange.formatQuantity()</code>.</p>
<p><strong>Example:</strong></p>
<ul>
<li>Input: <code>{ method: &quot;fixed-percentage&quot;, params: { portfolioBalance: 10000, entryPrice: 50000 } }</code></li>
<li>Schema percentage: 2% (0.02)</li>
<li>Calculated size: 0.004 BTC</li>
<li>Formatted output: <code>&quot;0.004&quot;</code> (8 decimal places for BTC)</li>
</ul>
<a id="schema-registration-and-retrieval" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Schema Registration and Retrieval<a href="#schema-registration-and-retrieval" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>Sizing schemas are registered via the <code>addSizing()</code> function and stored in <code>SizingSchemaService</code>:</p>
<a id="registration-flow" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Registration Flow<a href="#registration-flow" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><img src="../media/37_ClientSizing_2.svg" alt="Mermaid Diagram"></p>
<a id="memoization" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Memoization<a href="#memoization" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>SizingConnectionService memoizes ClientSizing instances:</p>
<ul>
<li>One instance per <code>sizingName</code></li>
<li>Lazy instantiation on first use</li>
<li>Shared across all strategies using the same <code>sizingName</code></li>
</ul>
<a id="integration-with-strategy-schema" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Integration with Strategy Schema<a href="#integration-with-strategy-schema" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>Strategies reference sizing via the optional <code>sizingName</code> field in <code>IStrategySchema</code>:</p>
<pre><code class="typescript"><span class="hl-7">interface</span><span class="hl-1"> </span><span class="hl-11">IStrategySchema</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-4">strategyName</span><span class="hl-1">: </span><span class="hl-11">string</span><span class="hl-1">;</span><br/><span class="hl-1">  </span><span class="hl-5">// ... other fields</span><br/><span class="hl-1">  </span><span class="hl-4">sizingName</span><span class="hl-1">?: </span><span class="hl-11">string</span><span class="hl-1">;  </span><span class="hl-5">// Optional reference to sizing schema</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<p>If <code>sizingName</code> is omitted, ClientStrategy uses a default sizing method (typically fixed percentage at 100% of portfolio).</p>
<a id="context-resolution" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Context Resolution<a href="#context-resolution" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>When ClientStrategy needs to calculate position size:</p>
<ol>
<li>Retrieve sizing schema via <code>methodContext.sizingName</code></li>
<li>Get ClientSizing instance from SizingConnectionService</li>
<li>Build <code>ISizingCalculateParams</code> based on schema method</li>
<li>Call <code>calculatePositionSize()</code> with constructed parameters</li>
<li>Use returned formatted quantity in signal</li>
</ol>
<a id="callbacks-and-lifecycle-events" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Callbacks and Lifecycle Events<a href="#callbacks-and-lifecycle-events" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>Sizing schemas support optional callbacks for tracking calculation events:</p>
<pre><code class="typescript"><span class="hl-7">interface</span><span class="hl-1"> </span><span class="hl-11">ISizingCallbacks</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-0">onCalculate</span><span class="hl-1">?: (</span><br/><span class="hl-1">    </span><span class="hl-4">params</span><span class="hl-1">: </span><span class="hl-11">ISizingCalculateParams</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-4">result</span><span class="hl-1">: </span><span class="hl-11">string</span><br/><span class="hl-1">  ) </span><span class="hl-7">=&gt;</span><span class="hl-1"> </span><span class="hl-11">void</span><span class="hl-1">;</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<p>The <code>onCalculate</code> callback fires after each position size calculation, receiving the input parameters and formatted result. This enables logging, debugging, and custom analytics.</p>
<p><strong>Example usage:</strong></p>
<pre><code class="typescript"><span class="hl-0">addSizing</span><span class="hl-1">({</span><br/><span class="hl-1">  </span><span class="hl-4">sizingName:</span><span class="hl-1"> </span><span class="hl-2">&quot;my-sizing&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">method:</span><span class="hl-1"> </span><span class="hl-2">&quot;kelly-criterion&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">params:</span><span class="hl-1"> { </span><span class="hl-4">winRate:</span><span class="hl-1"> </span><span class="hl-6">0.6</span><span class="hl-1">, </span><span class="hl-4">avgWinPnl:</span><span class="hl-1"> </span><span class="hl-6">0.05</span><span class="hl-1">, </span><span class="hl-4">avgLossPnl:</span><span class="hl-1"> </span><span class="hl-6">0.03</span><span class="hl-1"> },</span><br/><span class="hl-1">  </span><span class="hl-4">callbacks:</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-0">onCalculate</span><span class="hl-4">:</span><span class="hl-1"> (</span><span class="hl-4">params</span><span class="hl-1">, </span><span class="hl-4">result</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">      </span><span class="hl-4">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-2">`Calculated position size: </span><span class="hl-7">${</span><span class="hl-4">result</span><span class="hl-7">}</span><span class="hl-2">`</span><span class="hl-1">);</span><br/><span class="hl-1">    }</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">});</span>
</code><button type="button">Copy</button></pre>

<a id="dependencies-and-parameters" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Dependencies and Parameters<a href="#dependencies-and-parameters" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>ClientSizing constructor accepts parameters conforming to a schema-based interface:</p>
<a id="constructor-parameters-pattern" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Constructor Parameters Pattern<a href="#constructor-parameters-pattern" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><pre><code class="typescript"><span class="hl-7">interface</span><span class="hl-1"> </span><span class="hl-11">ISizingParams</span><span class="hl-1"> </span><span class="hl-7">extends</span><span class="hl-1"> </span><span class="hl-11">ISizingSchema</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-4">logger</span><span class="hl-1">: </span><span class="hl-11">ILogger</span><span class="hl-1">;</span><br/><span class="hl-1">  </span><span class="hl-4">execution</span><span class="hl-1">: </span><span class="hl-11">TExecutionContextService</span><span class="hl-1">;</span><br/><span class="hl-1">  </span><span class="hl-4">exchange</span><span class="hl-1">: </span><span class="hl-11">IExchange</span><span class="hl-1">;</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<p>The parameters combine:</p>
<ul>
<li>The sizing schema (registered via <code>addSizing()</code>)</li>
<li>Logger service for debug output</li>
<li>Execution context service (symbol, when, backtest flag)</li>
<li>Exchange instance for <code>formatQuantity()</code> calls</li>
</ul>
<p><strong>Note:</strong> Unlike other client classes, ClientSizing requires <code>IExchange</code> because it must format the calculated quantity according to exchange-specific precision rules.</p>
<a id="usage-in-execution-modes" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Usage in Execution Modes<a href="#usage-in-execution-modes" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>ClientSizing operates identically in all execution modes (Backtest, Live, Walker):</p>
<a id="backtest-mode" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Backtest Mode<a href="#backtest-mode" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><ul>
<li>Uses historical portfolio balance snapshots</li>
<li>ATR calculations use historical candles from the frame</li>
<li>Position sizes are deterministic and repeatable</li>
</ul>
<a id="live-mode" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Live Mode<a href="#live-mode" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><ul>
<li>Uses current real-time portfolio balance</li>
<li>ATR calculations use recent candles from exchange</li>
<li>Position sizes adjust dynamically to account volatility</li>
</ul>
<a id="walker-mode" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Walker Mode<a href="#walker-mode" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><ul>
<li>Each strategy backtest uses its own sizing calculation</li>
<li>Results are comparable if strategies use the same sizing method</li>
<li>Enables comparison of strategy edge independent of sizing</li>
</ul>
</div></div><div class="col-sidebar"><div class="page-menu"><div class="tsd-navigation settings"><details class="tsd-accordion"><summary class="tsd-accordion-summary"><h3><svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-chevronDown"></use></svg>Settings</h3></summary><div class="tsd-accordion-details"><div class="tsd-filter-visibility"><span class="settings-label">Member Visibility</span><ul id="tsd-filter-options"><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-protected" name="protected"/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Protected</span></label></li><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-inherited" name="inherited" checked/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Inherited</span></label></li><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-external" name="external"/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>External</span></label></li></ul></div><div class="tsd-theme-toggle"><label class="settings-label" for="tsd-theme">Theme</label><select id="tsd-theme"><option value="os">OS</option><option value="light">Light</option><option value="dark">Dark</option></select></div></div></details></div><details open class="tsd-accordion tsd-page-navigation"><summary class="tsd-accordion-summary"><h3><svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-chevronDown"></use></svg>On This Page</h3></summary><div class="tsd-accordion-details"><a href="#clientsizing"><span>Client<wbr/>Sizing</span></a><ul><li><a href="#purpose-and-scope"><span>Purpose and <wbr/>Scope</span></a></li><li><a href="#architecture-context"><span>Architecture <wbr/>Context</span></a></li><li><a href="#sizing-schema-types"><span>Sizing <wbr/>Schema <wbr/>Types</span></a></li><li><ul><li><a href="#schema-comparison-table"><span>Schema <wbr/>Comparison <wbr/>Table</span></a></li></ul></li><li><a href="#fixed-percentage-method"><span>Fixed <wbr/>Percentage <wbr/>Method</span></a></li><li><ul><li><a href="#schema-interface"><span>Schema <wbr/>Interface</span></a></li><li><a href="#calculation-parameters"><span>Calculation <wbr/>Parameters</span></a></li><li><a href="#calculation-logic"><span>Calculation <wbr/>Logic</span></a></li></ul></li><li><a href="#kelly-criterion-method"><span>Kelly <wbr/>Criterion <wbr/>Method</span></a></li><li><ul><li><a href="#schema-interface-1"><span>Schema <wbr/>Interface</span></a></li><li><a href="#calculation-parameters-1"><span>Calculation <wbr/>Parameters</span></a></li><li><a href="#calculation-logic-1"><span>Calculation <wbr/>Logic</span></a></li></ul></li><li><a href="#atr-based-method"><span>ATR-<wbr/>Based <wbr/>Method</span></a></li><li><ul><li><a href="#schema-interface-2"><span>Schema <wbr/>Interface</span></a></li><li><a href="#calculation-parameters-2"><span>Calculation <wbr/>Parameters</span></a></li><li><a href="#calculation-logic-2"><span>Calculation <wbr/>Logic</span></a></li></ul></li><li><a href="#calculation-flow"><span>Calculation <wbr/>Flow</span></a></li><li><a href="#isizing-interface"><span>ISizing <wbr/>Interface</span></a></li><li><ul><li><a href="#parameter-discriminated-union"><span>Parameter <wbr/>Discriminated <wbr/>Union</span></a></li><li><a href="#return-value"><span>Return <wbr/>Value</span></a></li></ul></li><li><a href="#schema-registration-and-retrieval"><span>Schema <wbr/>Registration and <wbr/>Retrieval</span></a></li><li><ul><li><a href="#registration-flow"><span>Registration <wbr/>Flow</span></a></li><li><a href="#memoization"><span>Memoization</span></a></li></ul></li><li><a href="#integration-with-strategy-schema"><span>Integration with <wbr/>Strategy <wbr/>Schema</span></a></li><li><ul><li><a href="#context-resolution"><span>Context <wbr/>Resolution</span></a></li></ul></li><li><a href="#callbacks-and-lifecycle-events"><span>Callbacks and <wbr/>Lifecycle <wbr/>Events</span></a></li><li><a href="#dependencies-and-parameters"><span>Dependencies and <wbr/>Parameters</span></a></li><li><ul><li><a href="#constructor-parameters-pattern"><span>Constructor <wbr/>Parameters <wbr/>Pattern</span></a></li></ul></li><li><a href="#usage-in-execution-modes"><span>Usage in <wbr/>Execution <wbr/>Modes</span></a></li><li><ul><li><a href="#backtest-mode"><span>Backtest <wbr/>Mode</span></a></li><li><a href="#live-mode"><span>Live <wbr/>Mode</span></a></li><li><a href="#walker-mode"><span>Walker <wbr/>Mode</span></a></li></ul></li></ul></div></details></div><div class="site-menu"><nav class="tsd-navigation"><a href="../modules.html">backtest-kit</a><ul class="tsd-small-nested-navigation" id="tsd-nav-container"><li>Loading...</li></ul></nav></div></div></div><footer><p class="tsd-generator">Generated using <a href="https://typedoc.org/" target="_blank">TypeDoc</a></p></footer><div class="overlay"></div></body></html>

<!-- Yandex.Metrika counter -->
<script type="text/javascript">
    (function(m,e,t,r,i,k,a){
        m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
        m[i].l=1*new Date();
        for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }}
        k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)
    })(window, document,'script','https://mc.yandex.ru/metrika/tag.js?id=105455585', 'ym');

    ym(105455585, 'init', {ssr:true, webvisor:true, clickmap:true, ecommerce:"dataLayer", accurateTrackBounce:true, trackLinks:true});
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/105455585" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
<!-- /Yandex.Metrika counter -->

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-3MQZEBBDDR"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-3MQZEBBDDR');
</script>
