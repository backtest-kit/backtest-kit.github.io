<!DOCTYPE html><html class="default" lang="en" data-base=".."><head><meta charset="utf-8"/><meta http-equiv="x-ua-compatible" content="IE=edge"/><title>design/50_crash-recovery-persistence | backtest-kit</title><meta name="description" content="Documentation for backtest-kit"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="stylesheet" href="../assets/style.css"/><link rel="stylesheet" href="../assets/highlight.css"/><script defer src="../assets/main.js"></script><script async src="../assets/icons.js" id="tsd-icons-script"></script><script async src="../assets/search.js" id="tsd-search-script"></script><script async src="../assets/navigation.js" id="tsd-nav-script"></script><script async src="../assets/hierarchy.js" id="tsd-hierarchy-script"></script></head><body><script>document.documentElement.dataset.theme = localStorage.getItem("tsd-theme") || "os";document.body.style.display="none";setTimeout(() => app?app.showPage():document.body.style.removeProperty("display"),500)</script><header class="tsd-page-toolbar"><div class="tsd-toolbar-contents container"><div class="table-cell" id="tsd-search"><div class="field"><label for="tsd-search-field" class="tsd-widget tsd-toolbar-icon search no-caption"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-search"></use></svg></label><input type="text" id="tsd-search-field" aria-label="Search"/></div><div class="field"><div id="tsd-toolbar-links"></div></div><ul class="results"><li class="state loading">Preparing search index...</li><li class="state failure">The search index is not available</li></ul><a href="../index.html" class="title">backtest-kit</a></div><div class="table-cell" id="tsd-widgets"><a href="#" class="tsd-widget tsd-toolbar-icon menu no-caption" data-toggle="menu" aria-label="Menu"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-menu"></use></svg></a></div></div></header><div class="container container-main"><div class="col-content"><div class="tsd-page-title"><ul class="tsd-breadcrumb"><li><a href="../modules.html">backtest-kit</a></li><li><a href="design_50_crash-recovery-persistence.html">design/50_crash-recovery-persistence</a></li></ul></div><div class="tsd-panel tsd-typography"><a id="crash-recovery--persistence" class="tsd-anchor"></a><h1 class="tsd-anchor-link">Crash Recovery &amp; Persistence<a href="#crash-recovery--persistence" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h1><p>This document describes the crash-safe persistence system that enables live trading strategies to survive system crashes, process restarts, and unexpected failures. When a live trading bot restarts, it can seamlessly restore active signals and continue monitoring positions without data loss or duplicate trades.</p>
<p>For information about live trading execution modes, see <a href="design_20_execution-modes.html">Live Trading Mode</a>. For custom adapter implementation details, see <a href="design_46_advanced-features.html">Custom Persistence Backends</a>.</p>
<hr>
<a id="purpose-and-scope" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Purpose and Scope<a href="#purpose-and-scope" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>The persistence system provides <strong>atomic state storage</strong> for live trading operations. It ensures that:</p>
<ul>
<li><strong>Active signals survive crashes</strong>: Opened positions are restored after restart</li>
<li><strong>No duplicate trades</strong>: The system recognizes existing positions and doesn't re-open them</li>
<li><strong>Clean state management</strong>: Closed signals are automatically removed from storage</li>
<li><strong>Pluggable backends</strong>: Default file-based storage can be replaced with Redis, MongoDB, or custom solutions</li>
</ul>
<p><strong>Critical Design Principle</strong>: Only <strong>opened</strong> (active) signals are persisted. Scheduled signals (limit orders waiting for activation) are ephemeral and not saved to storage. This prevents data bloat and ensures the persistence layer only tracks real positions.</p>
<hr>
<a id="persistence-architecture" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Persistence Architecture<a href="#persistence-architecture" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>The framework provides four specialized persistence adapters, each responsible for a different aspect of trading state:</p>
<p><img src="../media/50_crash-recovery-persistence_0.svg" alt="Mermaid Diagram"></p>
<a id="adapter-responsibilities" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Adapter Responsibilities<a href="#adapter-responsibilities" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><table>
<thead>
<tr>
<th>Adapter</th>
<th>Purpose</th>
<th>Persists When</th>
<th>Key Data</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>PersistSignalAdapter</code></td>
<td>Active signal state</td>
<td>Signal opens (not scheduled)</td>
<td><code>ISignalRow</code> with prices, position, timestamps</td>
</tr>
<tr>
<td><code>PersistRiskAdapter</code></td>
<td>Portfolio-wide risk tracking</td>
<td>Risk limits updated</td>
<td>Active signal counts, exposure totals</td>
</tr>
<tr>
<td><code>PersistScheduleAdapter</code></td>
<td>Schedule metadata</td>
<td>Scheduled signals created</td>
<td>Pending order details (ephemeral)</td>
</tr>
<tr>
<td><code>PersistPartialAdapter</code></td>
<td>Profit/loss milestones</td>
<td>Partial levels hit</td>
<td>10%, 20%, 30%+ profit/loss events</td>
</tr>
</tbody>
</table>
<hr>
<a id="persistbase-interface" class="tsd-anchor"></a><h2 class="tsd-anchor-link">PersistBase Interface<a href="#persistbase-interface" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>All persistence adapters implement the <code>PersistBase</code> interface, which defines the contract for crash-safe storage:</p>
<p><img src="../media/50_crash-recovery-persistence_1.svg" alt="Mermaid Diagram"></p>
<a id="method-contracts" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Method Contracts<a href="#method-contracts" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><strong><code>waitForInit(): Promise&lt;void&gt;</code></strong></p>
<ul>
<li>Called once during adapter initialization</li>
<li>Must complete before any read/write operations</li>
<li>Use for connection establishment, file system setup, or authentication</li>
<li>Example: Redis client connection, file directory creation</li>
</ul>
<p><strong><code>readValue(key: string): Promise&lt;T&gt;</code></strong></p>
<ul>
<li>Retrieves persisted value for the given key</li>
<li>Throws error if key doesn't exist</li>
<li>Must return typed data (deserialization handled by implementation)</li>
</ul>
<p><strong><code>hasValue(key: string): Promise&lt;boolean&gt;</code></strong></p>
<ul>
<li>Checks if persisted data exists for the key</li>
<li>Returns <code>true</code> if data exists, <code>false</code> otherwise</li>
<li>Used before <code>readValue()</code> to avoid errors</li>
</ul>
<p><strong><code>writeValue(key: string, value: T): Promise&lt;void&gt;</code></strong></p>
<ul>
<li><strong>Atomic operation</strong>: Saves value to storage</li>
<li>Must be crash-safe (use temp files + rename for file systems)</li>
<li>Should be idempotent (multiple writes produce same result)</li>
</ul>
<p><strong><code>deleteValue(key: string): Promise&lt;void&gt;</code></strong></p>
<ul>
<li>Removes persisted data for the key</li>
<li>Called when signals close</li>
<li>Must be idempotent (safe to call on non-existent keys)</li>
</ul>
<hr>
<a id="signal-persistence-lifecycle" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Signal Persistence Lifecycle<a href="#signal-persistence-lifecycle" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>Signals transition through multiple states, but only <strong>opened</strong> signals are persisted. This diagram shows when persistence operations occur:</p>
<p><img src="../media/50_crash-recovery-persistence_2.svg" alt="Mermaid Diagram"></p>
<a id="key-state-transitions" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Key State Transitions<a href="#key-state-transitions" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><strong>Scheduled → Opened</strong>: <code>writeValue()</code> called</p>
<ul>
<li>Signal transitions from limit order to active position</li>
<li><code>ClientStrategy.setPendingSignal()</code> triggers <code>PersistSignalAdapter.writeSignalData()</code></li>
<li>Data written: <code>{ id, position, priceOpen, priceTakeProfit, priceStopLoss, minuteEstimatedTime, timestamp, symbol, exchangeName, strategyName }</code></li>
</ul>
<p><strong>Active → Closed</strong>: <code>deleteValue()</code> called</p>
<ul>
<li>Position closes via TP, SL, or time expiration</li>
<li><code>ClientStrategy</code> detects close condition and triggers deletion</li>
<li>Storage cleanup ensures no stale data remains</li>
</ul>
<p><strong>Crash During Active</strong>: System restart</p>
<ul>
<li><code>Live.background()</code> starts</li>
<li><code>ClientStrategy.waitForInit()</code> calls <code>PersistSignalAdapter.readSignalData()</code></li>
<li>Signal state restored, monitoring continues from last known state</li>
</ul>
<hr>
<a id="atomic-write-operations" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Atomic Write Operations<a href="#atomic-write-operations" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>Persistence operations must be <strong>atomic</strong> to prevent data corruption during crashes. The default file-based implementation uses a temp-file-and-rename pattern:</p>
<p><img src="../media/50_crash-recovery-persistence_3.svg" alt="Mermaid Diagram"></p>
<a id="why-atomic-writes-matter" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Why Atomic Writes Matter<a href="#why-atomic-writes-matter" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><strong>Problem</strong>: Direct file writes are not atomic</p>
<pre><code><span class="hl-1"># </span><span class="hl-4">Without</span><span class="hl-1"> </span><span class="hl-4">atomicity</span><span class="hl-1"> - </span><span class="hl-8">DANGEROUS</span><br/><span class="hl-0">write_to_file</span><span class="hl-1">(</span><span class="hl-2">&quot;signal.json&quot;</span><span class="hl-1">, </span><span class="hl-4">new_data</span><span class="hl-1">)  # </span><span class="hl-4">Crash</span><span class="hl-1"> </span><span class="hl-4">here</span><span class="hl-1"> = </span><span class="hl-4">corrupted</span><span class="hl-1"> </span><span class="hl-4">file</span>
</code><button>Copy</button></pre>

<p><strong>Solution</strong>: Temp-file-and-rename pattern</p>
<pre><code><span class="hl-1"># </span><span class="hl-4">With</span><span class="hl-1"> </span><span class="hl-4">atomicity</span><span class="hl-1"> - </span><span class="hl-8">SAFE</span><br/><span class="hl-0">write_to_file</span><span class="hl-1">(</span><span class="hl-2">&quot;signal.tmp&quot;</span><span class="hl-1">, </span><span class="hl-4">new_data</span><span class="hl-1">)   # </span><span class="hl-4">Crash</span><span class="hl-1"> </span><span class="hl-4">here</span><span class="hl-1"> = </span><span class="hl-4">old</span><span class="hl-1"> </span><span class="hl-4">data</span><span class="hl-1"> </span><span class="hl-4">still</span><span class="hl-1"> </span><span class="hl-4">exists</span><br/><span class="hl-0">atomic_rename</span><span class="hl-1">(</span><span class="hl-2">&quot;signal.tmp&quot;</span><span class="hl-1">, </span><span class="hl-2">&quot;signal.json&quot;</span><span class="hl-1">)  # </span><span class="hl-4">Atomic</span><span class="hl-1"> </span><span class="hl-8">OS</span><span class="hl-1"> </span><span class="hl-4">operation</span>
</code><button>Copy</button></pre>

<p>The <code>rename()</code> system call is atomic on POSIX systems. Either the old file exists (before rename) or the new file exists (after rename). There's no intermediate state where the file is partially written.</p>
<hr>
<a id="recovery-flow" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Recovery Flow<a href="#recovery-flow" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>When a live trading bot restarts after a crash, the recovery process follows this sequence:</p>
<p><img src="../media/50_crash-recovery-persistence_4.svg" alt="Mermaid Diagram"></p>
<a id="recovery-scenarios" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Recovery Scenarios<a href="#recovery-scenarios" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><strong>Scenario 1: Crash with active LONG signal</strong></p>
<pre><code><span class="hl-4">Before</span><span class="hl-1"> </span><span class="hl-10">crash</span><span class="hl-1">:</span><br/><span class="hl-1">- </span><span class="hl-4">Signal</span><span class="hl-1"> </span><span class="hl-4">opened</span><span class="hl-1"> </span><span class="hl-4">at</span><span class="hl-1"> </span><span class="hl-4">priceOpen</span><span class="hl-1">=</span><span class="hl-6">43000</span><br/><span class="hl-1">- </span><span class="hl-8">TP</span><span class="hl-1">=</span><span class="hl-6">44000</span><span class="hl-1">, </span><span class="hl-8">SL</span><span class="hl-1">=</span><span class="hl-6">42000</span><br/><span class="hl-1">- </span><span class="hl-4">Position</span><span class="hl-1"> </span><span class="hl-4">active</span><span class="hl-1">, </span><span class="hl-4">monitoring</span><br/><br/><span class="hl-4">After</span><span class="hl-1"> </span><span class="hl-10">restart</span><span class="hl-1">:</span><br/><span class="hl-1">- </span><span class="hl-0">readSignalData</span><span class="hl-1">() </span><span class="hl-4">returns</span><span class="hl-1"> </span><span class="hl-4">saved</span><span class="hl-1"> </span><span class="hl-4">state</span><br/><span class="hl-1">- </span><span class="hl-4">Current</span><span class="hl-1"> </span><span class="hl-4">price</span><span class="hl-1"> </span><span class="hl-4">checked</span><span class="hl-1"> </span><span class="hl-4">via</span><span class="hl-1"> </span><span class="hl-8">VWAP</span><br/><span class="hl-1">- </span><span class="hl-4">If</span><span class="hl-1"> </span><span class="hl-4">price</span><span class="hl-1">=</span><span class="hl-6">44500</span><span class="hl-1"> → </span><span class="hl-4">closes</span><span class="hl-1"> </span><span class="hl-4">by</span><span class="hl-1"> </span><span class="hl-8">TP</span><span class="hl-1"> </span><span class="hl-4">immediately</span><br/><span class="hl-1">- </span><span class="hl-4">If</span><span class="hl-1"> </span><span class="hl-4">price</span><span class="hl-1">=</span><span class="hl-6">43500</span><span class="hl-1"> → </span><span class="hl-4">continues</span><span class="hl-1"> </span><span class="hl-4">monitoring</span>
</code><button>Copy</button></pre>

<p><strong>Scenario 2: Crash during scheduled signal</strong></p>
<pre><code><span class="hl-4">Before</span><span class="hl-1"> </span><span class="hl-10">crash</span><span class="hl-1">:</span><br/><span class="hl-1">- </span><span class="hl-4">Signal</span><span class="hl-1"> </span><span class="hl-4">scheduled</span><span class="hl-1">, </span><span class="hl-4">waiting</span><span class="hl-1"> </span><span class="hl-4">for</span><span class="hl-1"> </span><span class="hl-4">priceOpen</span><span class="hl-1">=</span><span class="hl-6">42000</span><br/><span class="hl-1">- </span><span class="hl-4">Current</span><span class="hl-1"> </span><span class="hl-4">price</span><span class="hl-1">=</span><span class="hl-6">43000</span><span class="hl-1"> (</span><span class="hl-4">above</span><span class="hl-1"> </span><span class="hl-4">priceOpen</span><span class="hl-1">)</span><br/><span class="hl-1">- </span><span class="hl-4">Not</span><span class="hl-1"> </span><span class="hl-4">yet</span><span class="hl-1"> </span><span class="hl-0">persisted</span><span class="hl-1"> (</span><span class="hl-4">scheduled</span><span class="hl-1"> ≠ </span><span class="hl-4">opened</span><span class="hl-1">)</span><br/><br/><span class="hl-4">After</span><span class="hl-1"> </span><span class="hl-10">restart</span><span class="hl-1">:</span><br/><span class="hl-1">- </span><span class="hl-0">hasValue</span><span class="hl-1">() </span><span class="hl-4">returns</span><span class="hl-1"> </span><span class="hl-7">false</span><br/><span class="hl-1">- </span><span class="hl-4">No</span><span class="hl-1"> </span><span class="hl-4">restoration</span><span class="hl-1"> </span><span class="hl-4">needed</span><br/><span class="hl-1">- </span><span class="hl-4">Signal</span><span class="hl-1"> </span><span class="hl-0">lost</span><span class="hl-1"> (</span><span class="hl-4">acceptable</span><span class="hl-1">, </span><span class="hl-4">was</span><span class="hl-1"> </span><span class="hl-4">never</span><span class="hl-1"> </span><span class="hl-4">opened</span><span class="hl-1">)</span><br/><span class="hl-1">- </span><span class="hl-0">getSignal</span><span class="hl-1">() </span><span class="hl-4">will</span><span class="hl-1"> </span><span class="hl-4">generate</span><span class="hl-1"> </span><span class="hl-7">new</span><span class="hl-1"> </span><span class="hl-4">signal</span><span class="hl-1"> </span><span class="hl-4">on</span><span class="hl-1"> </span><span class="hl-4">next</span><span class="hl-1"> </span><span class="hl-4">tick</span>
</code><button>Copy</button></pre>

<p><strong>Scenario 3: Multiple strategies per symbol</strong></p>
<pre><code><span class="hl-4">Keys</span><span class="hl-1"> </span><span class="hl-10">stored</span><span class="hl-1">:</span><br/><span class="hl-1">- </span><span class="hl-10">BTCUSDT</span><span class="hl-1">:</span><span class="hl-4">strategy</span><span class="hl-1">-</span><span class="hl-6">1</span><span class="hl-1"> → </span><span class="hl-4">Long</span><span class="hl-1"> </span><span class="hl-4">position</span><br/><span class="hl-1">- </span><span class="hl-10">BTCUSDT</span><span class="hl-1">:</span><span class="hl-4">strategy</span><span class="hl-1">-</span><span class="hl-6">2</span><span class="hl-1"> → </span><span class="hl-4">Short</span><span class="hl-1"> </span><span class="hl-4">position</span><br/><span class="hl-1">- </span><span class="hl-10">ETHUSDT</span><span class="hl-1">:</span><span class="hl-4">strategy</span><span class="hl-1">-</span><span class="hl-6">1</span><span class="hl-1"> → </span><span class="hl-4">Long</span><span class="hl-1"> </span><span class="hl-4">position</span><br/><br/><span class="hl-4">After</span><span class="hl-1"> </span><span class="hl-10">restart</span><span class="hl-1">:</span><br/><span class="hl-1">- </span><span class="hl-4">Each</span><span class="hl-1"> </span><span class="hl-4">ClientStrategy</span><span class="hl-1"> </span><span class="hl-4">instance</span><span class="hl-1"> </span><span class="hl-4">reads</span><span class="hl-1"> </span><span class="hl-4">its</span><span class="hl-1"> </span><span class="hl-4">own</span><span class="hl-1"> </span><span class="hl-4">key</span><br/><span class="hl-1">- </span><span class="hl-4">Positions</span><span class="hl-1"> </span><span class="hl-4">restored</span><span class="hl-1"> </span><span class="hl-4">independently</span><br/><span class="hl-1">- </span><span class="hl-4">No</span><span class="hl-1"> </span><span class="hl-4">collision</span><span class="hl-1"> </span><span class="hl-4">between</span><span class="hl-1"> </span><span class="hl-4">strategies</span>
</code><button>Copy</button></pre>

<hr>
<a id="default-file-based-storage" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Default File-Based Storage<a href="#default-file-based-storage" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>The framework includes a default file-based persistence implementation. It stores data as JSON files in the <code>./persist/</code> directory:</p>
<pre><code><span class="hl-1">.</span><span class="hl-15">/persist/</span><br/><span class="hl-1">├── </span><span class="hl-4">signals</span><span class="hl-1">/</span><br/><span class="hl-1">│   ├── </span><span class="hl-10">BTCUSDT</span><span class="hl-1">:</span><span class="hl-4">my</span><span class="hl-1">-</span><span class="hl-4">strategy</span><span class="hl-1">.</span><span class="hl-4">json</span><br/><span class="hl-1">│   ├── </span><span class="hl-10">ETHUSDT</span><span class="hl-1">:</span><span class="hl-4">my</span><span class="hl-1">-</span><span class="hl-4">strategy</span><span class="hl-1">.</span><span class="hl-4">json</span><br/><span class="hl-1">│   └── </span><span class="hl-10">BTCUSDT</span><span class="hl-1">:</span><span class="hl-4">another</span><span class="hl-1">-</span><span class="hl-4">strategy</span><span class="hl-1">.</span><span class="hl-4">json</span><br/><span class="hl-1">├── </span><span class="hl-4">risks</span><span class="hl-1">/</span><br/><span class="hl-1">│   ├── </span><span class="hl-3">default</span><span class="hl-1">-</span><span class="hl-4">risk</span><span class="hl-1">.</span><span class="hl-4">json</span><br/><span class="hl-1">│   └── </span><span class="hl-4">aggressive</span><span class="hl-1">-</span><span class="hl-4">risk</span><span class="hl-1">.</span><span class="hl-4">json</span><br/><span class="hl-1">├── </span><span class="hl-4">schedules</span><span class="hl-1">/</span><br/><span class="hl-1">│   └── </span><span class="hl-10">BTCUSDT</span><span class="hl-1">:</span><span class="hl-4">my</span><span class="hl-1">-</span><span class="hl-4">strategy</span><span class="hl-1">.</span><span class="hl-4">json</span><br/><span class="hl-1">└── </span><span class="hl-4">partials</span><span class="hl-1">/</span><br/><span class="hl-1">    └── </span><span class="hl-10">BTCUSDT</span><span class="hl-1">:</span><span class="hl-4">my</span><span class="hl-1">-</span><span class="hl-4">strategy</span><span class="hl-1">.</span><span class="hl-4">json</span>
</code><button>Copy</button></pre>

<a id="file-structure-example" class="tsd-anchor"></a><h3 class="tsd-anchor-link">File Structure Example<a href="#file-structure-example" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><strong>Signal persistence file</strong> (<code>./persist/signals/BTCUSDT:my-strategy.json</code>):</p>
<pre><code class="json"><span class="hl-1">{</span><br/><span class="hl-1">  </span><span class="hl-13">&quot;id&quot;</span><span class="hl-1">: </span><span class="hl-2">&quot;signal-uuid-123&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-13">&quot;position&quot;</span><span class="hl-1">: </span><span class="hl-2">&quot;long&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-13">&quot;priceOpen&quot;</span><span class="hl-1">: </span><span class="hl-6">43000</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-13">&quot;priceTakeProfit&quot;</span><span class="hl-1">: </span><span class="hl-6">44000</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-13">&quot;priceStopLoss&quot;</span><span class="hl-1">: </span><span class="hl-6">42000</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-13">&quot;minuteEstimatedTime&quot;</span><span class="hl-1">: </span><span class="hl-6">60</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-13">&quot;timestamp&quot;</span><span class="hl-1">: </span><span class="hl-6">1704067200000</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-13">&quot;symbol&quot;</span><span class="hl-1">: </span><span class="hl-2">&quot;BTCUSDT&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-13">&quot;exchangeName&quot;</span><span class="hl-1">: </span><span class="hl-2">&quot;binance&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-13">&quot;strategyName&quot;</span><span class="hl-1">: </span><span class="hl-2">&quot;my-strategy&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-13">&quot;note&quot;</span><span class="hl-1">: </span><span class="hl-2">&quot;Optional signal note&quot;</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<p><strong>Risk persistence file</strong> (<code>./persist/risks/default-risk.json</code>):</p>
<pre><code class="json"><span class="hl-1">{</span><br/><span class="hl-1">  </span><span class="hl-13">&quot;activeSignals&quot;</span><span class="hl-1">: {</span><br/><span class="hl-1">    </span><span class="hl-13">&quot;BTCUSDT:my-strategy&quot;</span><span class="hl-1">: </span><span class="hl-6">1</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-13">&quot;ETHUSDT:my-strategy&quot;</span><span class="hl-1">: </span><span class="hl-6">1</span><br/><span class="hl-1">  },</span><br/><span class="hl-1">  </span><span class="hl-13">&quot;totalExposure&quot;</span><span class="hl-1">: </span><span class="hl-6">2</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-13">&quot;lastUpdate&quot;</span><span class="hl-1">: </span><span class="hl-6">1704067200000</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<hr>
<a id="testing-persistence" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Testing Persistence<a href="#testing-persistence" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>The test suite includes comprehensive persistence recovery scenarios. Tests verify that signals correctly restore after simulated crashes:</p>
<p><img src="../media/50_crash-recovery-persistence_5.svg" alt="Mermaid Diagram"></p>
<a id="example-test-long-signal-tp-after-restart" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Example Test: LONG Signal TP After Restart<a href="#example-test-long-signal-tp-after-restart" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>This test verifies that a LONG signal correctly closes by TP after the system restarts:</p>
<pre><code class="typescript"><span class="hl-5">// From test/e2e/persist.test.mjs:25-94</span><br/><br/><span class="hl-5">// 1. Mock PersistSignalAdapter to return saved signal</span><br/><span class="hl-4">PersistSignalAdapter</span><span class="hl-1">.</span><span class="hl-0">usePersistSignalAdapter</span><span class="hl-1">(</span><span class="hl-7">class</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-7">async</span><span class="hl-1"> </span><span class="hl-0">readValue</span><span class="hl-1">() {</span><br/><span class="hl-1">    </span><span class="hl-3">return</span><span class="hl-1"> {</span><br/><span class="hl-1">      </span><span class="hl-4">id:</span><span class="hl-1"> </span><span class="hl-2">&quot;persist-long-tp&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">      </span><span class="hl-4">position:</span><span class="hl-1"> </span><span class="hl-2">&quot;long&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">      </span><span class="hl-4">priceOpen:</span><span class="hl-1"> </span><span class="hl-6">43000</span><span class="hl-1">,</span><br/><span class="hl-1">      </span><span class="hl-4">priceTakeProfit:</span><span class="hl-1"> </span><span class="hl-6">44000</span><span class="hl-1">,  </span><span class="hl-5">// Current price will be at TP level</span><br/><span class="hl-1">      </span><span class="hl-4">priceStopLoss:</span><span class="hl-1"> </span><span class="hl-6">42000</span><span class="hl-1">,</span><br/><span class="hl-1">      </span><span class="hl-5">// ... other fields</span><br/><span class="hl-1">    };</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">  </span><span class="hl-7">async</span><span class="hl-1"> </span><span class="hl-0">hasValue</span><span class="hl-1">() { </span><span class="hl-3">return</span><span class="hl-1"> </span><span class="hl-7">true</span><span class="hl-1">; }  </span><span class="hl-5">// Signal exists in storage</span><br/><span class="hl-1">});</span><br/><br/><span class="hl-5">// 2. Configure exchange to return candles at TP level</span><br/><span class="hl-0">addExchange</span><span class="hl-1">({</span><br/><span class="hl-1">  </span><span class="hl-0">getCandles</span><span class="hl-4">:</span><span class="hl-1"> </span><span class="hl-7">async</span><span class="hl-1"> () </span><span class="hl-7">=&gt;</span><span class="hl-1"> [{</span><br/><span class="hl-1">    </span><span class="hl-4">open:</span><span class="hl-1"> </span><span class="hl-6">44000</span><span class="hl-1">,   </span><span class="hl-5">// Price at TP level</span><br/><span class="hl-1">    </span><span class="hl-4">high:</span><span class="hl-1"> </span><span class="hl-6">44100</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-4">low:</span><span class="hl-1"> </span><span class="hl-6">43900</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-4">close:</span><span class="hl-1"> </span><span class="hl-6">44000</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-5">// ...</span><br/><span class="hl-1">  }]</span><br/><span class="hl-1">});</span><br/><br/><span class="hl-5">// 3. Register strategy with onClose callback</span><br/><span class="hl-7">let</span><span class="hl-1"> </span><span class="hl-4">onCloseCalled</span><span class="hl-1"> = </span><span class="hl-7">false</span><span class="hl-1">;</span><br/><span class="hl-0">addStrategy</span><span class="hl-1">({</span><br/><span class="hl-1">  </span><span class="hl-0">getSignal</span><span class="hl-4">:</span><span class="hl-1"> </span><span class="hl-7">async</span><span class="hl-1"> () </span><span class="hl-7">=&gt;</span><span class="hl-1"> </span><span class="hl-7">null</span><span class="hl-1">,  </span><span class="hl-5">// No new signals</span><br/><span class="hl-1">  </span><span class="hl-4">callbacks:</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-0">onClose</span><span class="hl-4">:</span><span class="hl-1"> () </span><span class="hl-7">=&gt;</span><span class="hl-1"> { </span><span class="hl-4">onCloseCalled</span><span class="hl-1"> = </span><span class="hl-7">true</span><span class="hl-1">; }</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">});</span><br/><br/><span class="hl-5">// 4. Start live trading (will restore signal)</span><br/><span class="hl-4">Live</span><span class="hl-1">.</span><span class="hl-0">background</span><span class="hl-1">(</span><span class="hl-2">&quot;BTCUSDT&quot;</span><span class="hl-1">, { </span><span class="hl-4">strategyName</span><span class="hl-1">, </span><span class="hl-4">exchangeName</span><span class="hl-1"> });</span><br/><br/><span class="hl-5">// 5. Verify signal closed by TP after restart</span><br/><span class="hl-5">// onCloseCalled === true</span><br/><span class="hl-5">// closeReason === &quot;take_profit&quot;</span>
</code><button type="button">Copy</button></pre>

<a id="test-coverage-matrix" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Test Coverage Matrix<a href="#test-coverage-matrix" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><table>
<thead>
<tr>
<th>Test</th>
<th>Scenario</th>
<th>Verifies</th>
</tr>
</thead>
<tbody>
<tr>
<td>PERSIST #1</td>
<td>LONG TP after restart</td>
<td>Signal restores, closes by TP, callback fires</td>
</tr>
<tr>
<td>PERSIST #2</td>
<td>LONG SL after restart</td>
<td>Signal restores, closes by SL, negative PNL</td>
</tr>
<tr>
<td>PERSIST #3</td>
<td>SHORT TP after restart</td>
<td>Short position logic, closes by TP</td>
</tr>
<tr>
<td>PERSIST #4</td>
<td>SHORT SL after restart</td>
<td>Short position logic, closes by SL</td>
</tr>
<tr>
<td>PERSIST #5</td>
<td>Time expired after restart</td>
<td>Signal restores, closes by time expiration</td>
</tr>
<tr>
<td>PERSIST #6</td>
<td>No persisted data</td>
<td>hasValue()=false, starts fresh</td>
</tr>
</tbody>
</table>
<hr>
<a id="disabling-persistence-in-tests" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Disabling Persistence in Tests<a href="#disabling-persistence-in-tests" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>For unit tests and backtests, persistence is typically disabled to avoid file system I/O and improve test speed. The test setup provides mock adapters that implement <code>PersistBase</code> but don't actually write to disk:</p>
<pre><code class="typescript"><span class="hl-5">// From test/config/setup.mjs:13-30</span><br/><br/><span class="hl-4">PersistSignalAdapter</span><span class="hl-1">.</span><span class="hl-0">usePersistSignalAdapter</span><span class="hl-1">(</span><span class="hl-7">class</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-7">async</span><span class="hl-1"> </span><span class="hl-0">waitForInit</span><span class="hl-1">() { </span><span class="hl-5">/* no-op */</span><span class="hl-1"> }</span><br/><span class="hl-1">  </span><br/><span class="hl-1">  </span><span class="hl-7">async</span><span class="hl-1"> </span><span class="hl-0">readValue</span><span class="hl-1">() {</span><br/><span class="hl-1">    </span><span class="hl-3">throw</span><span class="hl-1"> </span><span class="hl-7">new</span><span class="hl-1"> </span><span class="hl-0">Error</span><span class="hl-1">(</span><span class="hl-2">&quot;Should not be called in testbed&quot;</span><span class="hl-1">);</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">  </span><br/><span class="hl-1">  </span><span class="hl-7">async</span><span class="hl-1"> </span><span class="hl-0">hasValue</span><span class="hl-1">() {</span><br/><span class="hl-1">    </span><span class="hl-3">return</span><span class="hl-1"> </span><span class="hl-7">false</span><span class="hl-1">;  </span><span class="hl-5">// Always return false in tests</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">  </span><br/><span class="hl-1">  </span><span class="hl-7">async</span><span class="hl-1"> </span><span class="hl-0">writeValue</span><span class="hl-1">() { </span><span class="hl-5">/* no-op */</span><span class="hl-1"> }</span><br/><span class="hl-1">  </span><span class="hl-7">async</span><span class="hl-1"> </span><span class="hl-0">deleteValue</span><span class="hl-1">() { </span><span class="hl-5">/* no-op */</span><span class="hl-1"> }</span><br/><span class="hl-1">});</span>
</code><button type="button">Copy</button></pre>

<p>This approach ensures:</p>
<ul>
<li>Tests run in-memory without disk I/O</li>
<li>No cleanup required after test runs</li>
<li>Faster test execution</li>
<li>No file system side effects</li>
</ul>
<hr>
<a id="integration-points" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Integration Points<a href="#integration-points" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>The persistence system integrates with multiple framework components:</p>
<p><img src="../media/50_crash-recovery-persistence_6.svg" alt="Mermaid Diagram"></p>
<a id="clientstrategy-integration" class="tsd-anchor"></a><h3 class="tsd-anchor-link">ClientStrategy Integration<a href="#clientstrategy-integration" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><strong><code>ClientStrategy.waitForInit()</code></strong> - <code>docs/internals.md:76</code></p>
<ul>
<li>Called once per strategy instance before any tick operations</li>
<li>Triggers <code>PersistSignalAdapter.waitForInit()</code> and <code>hasValue()</code> check</li>
<li>If persisted data exists, calls <code>readSignalData()</code> to restore state</li>
</ul>
<p><strong><code>ClientStrategy.setPendingSignal()</code></strong> - <code>docs/internals.md:77</code></p>
<ul>
<li>Called when signal transitions from scheduled to opened</li>
<li>Triggers <code>PersistSignalAdapter.writeSignalData()</code></li>
<li>Atomic write ensures crash safety</li>
</ul>
<p><strong><code>ClientStrategy.tick()</code></strong> - <code>docs/internals.md:62-67</code></p>
<ul>
<li>Monitors active signals for TP/SL/time conditions</li>
<li>When signal closes, triggers <code>PersistSignalAdapter.deleteSignalData()</code></li>
<li>Cleanup ensures no stale data remains</li>
</ul>
<hr>
<a id="configuration-options" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Configuration Options<a href="#configuration-options" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>Persistence behavior can be configured globally via <code>GLOBAL_CONFIG</code>:</p>
<pre><code class="typescript"><span class="hl-5">// From src/config/params.ts:1-122</span><br/><br/><span class="hl-0">setConfig</span><span class="hl-1">({</span><br/><span class="hl-1">  </span><span class="hl-4">CC_SCHEDULE_AWAIT_MINUTES:</span><span class="hl-1"> </span><span class="hl-6">120</span><span class="hl-1">,  </span><span class="hl-5">// Scheduled signal timeout</span><br/><span class="hl-1">  </span><span class="hl-4">CC_AVG_PRICE_CANDLES_COUNT:</span><span class="hl-1"> </span><span class="hl-6">5</span><span class="hl-1">,   </span><span class="hl-5">// VWAP calculation window</span><br/><span class="hl-1">  </span><span class="hl-5">// ... other config options</span><br/><span class="hl-1">});</span>
</code><button type="button">Copy</button></pre>

<p><strong>Key Configuration Parameters</strong>:</p>
<table>
<thead>
<tr>
<th>Parameter</th>
<th>Default</th>
<th>Impact on Persistence</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>CC_SCHEDULE_AWAIT_MINUTES</code></td>
<td>120</td>
<td>Max time scheduled signals wait before cancellation (not persisted)</td>
</tr>
<tr>
<td><code>CC_MAX_SIGNAL_LIFETIME_MINUTES</code></td>
<td>1440</td>
<td>Max lifetime for persisted signals (auto-close after 1 day)</td>
</tr>
<tr>
<td><code>CC_PERCENT_FEE</code></td>
<td>0.1</td>
<td>Fee applied to PNL calculations (persisted in closed signal data)</td>
</tr>
<tr>
<td><code>CC_PERCENT_SLIPPAGE</code></td>
<td>0.1</td>
<td>Slippage applied to PNL (persisted in closed signal data)</td>
</tr>
</tbody>
</table>
<hr>
<a id="best-practices" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Best Practices<a href="#best-practices" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p><strong>1. Always use atomic writes for custom backends</strong></p>
<pre><code class="typescript"><span class="hl-5">// ✅ GOOD: Atomic writes with temp files</span><br/><span class="hl-4">async</span><span class="hl-1"> </span><span class="hl-0">writeValue</span><span class="hl-1">(</span><span class="hl-4">key</span><span class="hl-1">, </span><span class="hl-4">value</span><span class="hl-1">) {</span><br/><span class="hl-1">  </span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">tmpPath</span><span class="hl-1"> = </span><span class="hl-2">`</span><span class="hl-7">${</span><span class="hl-4">key</span><span class="hl-7">}</span><span class="hl-2">.tmp`</span><span class="hl-1">;</span><br/><span class="hl-1">  </span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">finalPath</span><span class="hl-1"> = </span><span class="hl-2">`</span><span class="hl-7">${</span><span class="hl-4">key</span><span class="hl-7">}</span><span class="hl-2">.json`</span><span class="hl-1">;</span><br/><span class="hl-1">  </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-4">fs</span><span class="hl-1">.</span><span class="hl-0">writeFile</span><span class="hl-1">(</span><span class="hl-4">tmpPath</span><span class="hl-1">, </span><span class="hl-8">JSON</span><span class="hl-1">.</span><span class="hl-0">stringify</span><span class="hl-1">(</span><span class="hl-4">value</span><span class="hl-1">));</span><br/><span class="hl-1">  </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-4">fs</span><span class="hl-1">.</span><span class="hl-0">rename</span><span class="hl-1">(</span><span class="hl-4">tmpPath</span><span class="hl-1">, </span><span class="hl-4">finalPath</span><span class="hl-1">);  </span><span class="hl-5">// Atomic on POSIX</span><br/><span class="hl-1">}</span><br/><br/><span class="hl-5">// ❌ BAD: Direct writes (not crash-safe)</span><br/><span class="hl-4">async</span><span class="hl-1"> </span><span class="hl-0">writeValue</span><span class="hl-1">(</span><span class="hl-4">key</span><span class="hl-1">, </span><span class="hl-4">value</span><span class="hl-1">) {</span><br/><span class="hl-1">  </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-4">fs</span><span class="hl-1">.</span><span class="hl-0">writeFile</span><span class="hl-1">(</span><span class="hl-2">`</span><span class="hl-7">${</span><span class="hl-4">key</span><span class="hl-7">}</span><span class="hl-2">.json`</span><span class="hl-1">, </span><span class="hl-8">JSON</span><span class="hl-1">.</span><span class="hl-0">stringify</span><span class="hl-1">(</span><span class="hl-4">value</span><span class="hl-1">));</span><br/><span class="hl-1">  </span><span class="hl-5">// Crash during write = corrupted file</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<p><strong>2. Implement proper error handling in readValue()</strong></p>
<pre><code class="typescript"><span class="hl-5">// ✅ GOOD: Clear error messages</span><br/><span class="hl-4">async</span><span class="hl-1"> </span><span class="hl-0">readValue</span><span class="hl-1">(</span><span class="hl-4">key</span><span class="hl-1">) {</span><br/><span class="hl-1">  </span><span class="hl-3">if</span><span class="hl-1"> (!</span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-7">this</span><span class="hl-1">.</span><span class="hl-0">hasValue</span><span class="hl-1">(</span><span class="hl-4">key</span><span class="hl-1">)) {</span><br/><span class="hl-1">    </span><span class="hl-3">throw</span><span class="hl-1"> </span><span class="hl-7">new</span><span class="hl-1"> </span><span class="hl-0">Error</span><span class="hl-1">(</span><span class="hl-2">`No persisted data found for key: </span><span class="hl-7">${</span><span class="hl-4">key</span><span class="hl-7">}</span><span class="hl-2">`</span><span class="hl-1">);</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">  </span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">data</span><span class="hl-1"> = </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-4">fs</span><span class="hl-1">.</span><span class="hl-0">readFile</span><span class="hl-1">(</span><span class="hl-2">`</span><span class="hl-7">${</span><span class="hl-4">key</span><span class="hl-7">}</span><span class="hl-2">.json`</span><span class="hl-1">, </span><span class="hl-2">&#39;utf-8&#39;</span><span class="hl-1">);</span><br/><span class="hl-1">  </span><span class="hl-3">return</span><span class="hl-1"> </span><span class="hl-8">JSON</span><span class="hl-1">.</span><span class="hl-0">parse</span><span class="hl-1">(</span><span class="hl-4">data</span><span class="hl-1">);</span><br/><span class="hl-1">}</span><br/><br/><span class="hl-5">// ❌ BAD: Generic errors</span><br/><span class="hl-4">async</span><span class="hl-1"> </span><span class="hl-0">readValue</span><span class="hl-1">(</span><span class="hl-4">key</span><span class="hl-1">) {</span><br/><span class="hl-1">  </span><span class="hl-3">return</span><span class="hl-1"> </span><span class="hl-8">JSON</span><span class="hl-1">.</span><span class="hl-0">parse</span><span class="hl-1">(</span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-4">fs</span><span class="hl-1">.</span><span class="hl-0">readFile</span><span class="hl-1">(</span><span class="hl-2">`</span><span class="hl-7">${</span><span class="hl-4">key</span><span class="hl-7">}</span><span class="hl-2">.json`</span><span class="hl-1">));</span><br/><span class="hl-1">  </span><span class="hl-5">// Crash with unhelpful &quot;ENOENT&quot; error</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<p><strong>3. Make deleteValue() idempotent</strong></p>
<pre><code class="typescript"><span class="hl-5">// ✅ GOOD: Safe to call multiple times</span><br/><span class="hl-4">async</span><span class="hl-1"> </span><span class="hl-0">deleteValue</span><span class="hl-1">(</span><span class="hl-4">key</span><span class="hl-1">) {</span><br/><span class="hl-1">  </span><span class="hl-3">try</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-4">fs</span><span class="hl-1">.</span><span class="hl-0">unlink</span><span class="hl-1">(</span><span class="hl-2">`</span><span class="hl-7">${</span><span class="hl-4">key</span><span class="hl-7">}</span><span class="hl-2">.json`</span><span class="hl-1">);</span><br/><span class="hl-1">  } </span><span class="hl-3">catch</span><span class="hl-1"> (</span><span class="hl-4">err</span><span class="hl-1">) {</span><br/><span class="hl-1">    </span><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-4">err</span><span class="hl-1">.</span><span class="hl-4">code</span><span class="hl-1"> !== </span><span class="hl-2">&#39;ENOENT&#39;</span><span class="hl-1">) </span><span class="hl-3">throw</span><span class="hl-1"> </span><span class="hl-4">err</span><span class="hl-1">;</span><br/><span class="hl-1">    </span><span class="hl-5">// Ignore &quot;file not found&quot; errors</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">}</span><br/><br/><span class="hl-5">// ❌ BAD: Crashes on missing file</span><br/><span class="hl-4">async</span><span class="hl-1"> </span><span class="hl-0">deleteValue</span><span class="hl-1">(</span><span class="hl-4">key</span><span class="hl-1">) {</span><br/><span class="hl-1">  </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-4">fs</span><span class="hl-1">.</span><span class="hl-0">unlink</span><span class="hl-1">(</span><span class="hl-2">`</span><span class="hl-7">${</span><span class="hl-4">key</span><span class="hl-7">}</span><span class="hl-2">.json`</span><span class="hl-1">);</span><br/><span class="hl-1">  </span><span class="hl-5">// Crash if file already deleted</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<p><strong>4. Validate restored data</strong></p>
<pre><code class="typescript"><span class="hl-5">// ✅ GOOD: Schema validation after restore</span><br/><span class="hl-4">async</span><span class="hl-1"> </span><span class="hl-0">readValue</span><span class="hl-1">(</span><span class="hl-4">key</span><span class="hl-1">) {</span><br/><span class="hl-1">  </span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">data</span><span class="hl-1"> = </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-7">this</span><span class="hl-1">.</span><span class="hl-4">storage</span><span class="hl-1">.</span><span class="hl-0">get</span><span class="hl-1">(</span><span class="hl-4">key</span><span class="hl-1">);</span><br/><span class="hl-1">  </span><br/><span class="hl-1">  </span><span class="hl-5">// Validate required fields</span><br/><span class="hl-1">  </span><span class="hl-3">if</span><span class="hl-1"> (!</span><span class="hl-4">data</span><span class="hl-1">.</span><span class="hl-4">position</span><span class="hl-1"> || !</span><span class="hl-4">data</span><span class="hl-1">.</span><span class="hl-4">priceOpen</span><span class="hl-1"> || !</span><span class="hl-4">data</span><span class="hl-1">.</span><span class="hl-4">priceTakeProfit</span><span class="hl-1">) {</span><br/><span class="hl-1">    </span><span class="hl-3">throw</span><span class="hl-1"> </span><span class="hl-7">new</span><span class="hl-1"> </span><span class="hl-0">Error</span><span class="hl-1">(</span><span class="hl-2">`Invalid signal data in storage: </span><span class="hl-7">${</span><span class="hl-4">key</span><span class="hl-7">}</span><span class="hl-2">`</span><span class="hl-1">);</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">  </span><br/><span class="hl-1">  </span><span class="hl-5">// Validate data types</span><br/><span class="hl-1">  </span><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-7">typeof</span><span class="hl-1"> </span><span class="hl-4">data</span><span class="hl-1">.</span><span class="hl-4">priceOpen</span><span class="hl-1"> !== </span><span class="hl-2">&#39;number&#39;</span><span class="hl-1">) {</span><br/><span class="hl-1">    </span><span class="hl-3">throw</span><span class="hl-1"> </span><span class="hl-7">new</span><span class="hl-1"> </span><span class="hl-0">Error</span><span class="hl-1">(</span><span class="hl-2">`Invalid priceOpen type: </span><span class="hl-7">${</span><span class="hl-7">typeof</span><span class="hl-9"> </span><span class="hl-4">data</span><span class="hl-9">.</span><span class="hl-4">priceOpen</span><span class="hl-7">}</span><span class="hl-2">`</span><span class="hl-1">);</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">  </span><br/><span class="hl-1">  </span><span class="hl-3">return</span><span class="hl-1"> </span><span class="hl-4">data</span><span class="hl-1">;</span><br/><span class="hl-1">}</span><br/><br/><span class="hl-5">// ❌ BAD: Blindly trust storage</span><br/><span class="hl-4">async</span><span class="hl-1"> </span><span class="hl-0">readValue</span><span class="hl-1">(</span><span class="hl-4">key</span><span class="hl-1">) {</span><br/><span class="hl-1">  </span><span class="hl-3">return</span><span class="hl-1"> </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-7">this</span><span class="hl-1">.</span><span class="hl-4">storage</span><span class="hl-1">.</span><span class="hl-0">get</span><span class="hl-1">(</span><span class="hl-4">key</span><span class="hl-1">);</span><br/><span class="hl-1">  </span><span class="hl-5">// Corrupted data crashes the system</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<p><strong>5. Test recovery scenarios</strong></p>
<pre><code class="typescript"><span class="hl-5">// ✅ GOOD: Test all close conditions after restart</span><br/><span class="hl-0">test</span><span class="hl-1">(</span><span class="hl-2">&quot;PERSIST: Signal closes by TP after restart&quot;</span><span class="hl-1">, </span><span class="hl-7">async</span><span class="hl-1"> () </span><span class="hl-7">=&gt;</span><span class="hl-1"> { </span><span class="hl-5">/* ... */</span><span class="hl-1"> });</span><br/><span class="hl-0">test</span><span class="hl-1">(</span><span class="hl-2">&quot;PERSIST: Signal closes by SL after restart&quot;</span><span class="hl-1">, </span><span class="hl-7">async</span><span class="hl-1"> () </span><span class="hl-7">=&gt;</span><span class="hl-1"> { </span><span class="hl-5">/* ... */</span><span class="hl-1"> });</span><br/><span class="hl-0">test</span><span class="hl-1">(</span><span class="hl-2">&quot;PERSIST: Signal closes by time after restart&quot;</span><span class="hl-1">, </span><span class="hl-7">async</span><span class="hl-1"> () </span><span class="hl-7">=&gt;</span><span class="hl-1"> { </span><span class="hl-5">/* ... */</span><span class="hl-1"> });</span>
</code><button type="button">Copy</button></pre>

<hr>
<a id="limitations-and-considerations" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Limitations and Considerations<a href="#limitations-and-considerations" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p><strong>1. Scheduled signals are not persisted</strong></p>
<ul>
<li>Limit orders waiting for activation are ephemeral</li>
<li>Lost on crash/restart (acceptable trade-off)</li>
<li>Prevents data bloat for signals that never opened</li>
<li><code>getSignal()</code> will generate new signals after restart</li>
</ul>
<p><strong>2. File-based storage is not distributed</strong></p>
<ul>
<li>Default implementation uses local file system</li>
<li>Cannot share state across multiple processes/servers</li>
<li>For distributed systems, implement Redis or database backend</li>
</ul>
<p><strong>3. Storage keys must be unique</strong></p>
<ul>
<li>Key format: <code>${symbol}:${strategyName}</code></li>
<li>Multiple strategies on same symbol use different keys</li>
<li>Collision prevention is critical</li>
</ul>
<p><strong>4. No transaction support</strong></p>
<ul>
<li>Each adapter operates independently</li>
<li>No atomic multi-adapter writes</li>
<li>Consider distributed transactions for custom backends</li>
</ul>
<p><strong>5. Performance considerations</strong></p>
<ul>
<li>File I/O on every signal open/close</li>
<li>For high-frequency strategies, consider in-memory caching</li>
<li>Redis backend recommended for &lt; 1ms persistence latency</li>
</ul>
<hr>
<a id="summary" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Summary<a href="#summary" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>The persistence system provides <strong>crash-safe state storage</strong> for live trading through:</p>
<ul>
<li><strong>Atomic write operations</strong> prevent data corruption</li>
<li><strong>Selective persistence</strong> (opened signals only) prevents bloat</li>
<li><strong>Pluggable backends</strong> enable Redis, MongoDB, or custom storage</li>
<li><strong>Automatic recovery</strong> restores signals on restart</li>
<li><strong>Clean cleanup</strong> deletes closed signals automatically</li>
</ul>
<p>Key integration points:</p>
<ul>
<li><code>ClientStrategy.waitForInit()</code> - Initialization and restoration</li>
<li><code>ClientStrategy.setPendingSignal()</code> - Write on signal open</li>
<li><code>ClientStrategy.tick()</code> - Delete on signal close</li>
</ul>
<p>For custom backend implementation, see <a href="design_46_advanced-features.html">Custom Persistence Backends</a>.</p>
</div></div><div class="col-sidebar"><div class="page-menu"><div class="tsd-navigation settings"><details class="tsd-accordion"><summary class="tsd-accordion-summary"><h3><svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-chevronDown"></use></svg>Settings</h3></summary><div class="tsd-accordion-details"><div class="tsd-filter-visibility"><span class="settings-label">Member Visibility</span><ul id="tsd-filter-options"><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-protected" name="protected"/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Protected</span></label></li><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-inherited" name="inherited" checked/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Inherited</span></label></li><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-external" name="external"/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>External</span></label></li></ul></div><div class="tsd-theme-toggle"><label class="settings-label" for="tsd-theme">Theme</label><select id="tsd-theme"><option value="os">OS</option><option value="light">Light</option><option value="dark">Dark</option></select></div></div></details></div><details open class="tsd-accordion tsd-page-navigation"><summary class="tsd-accordion-summary"><h3><svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-chevronDown"></use></svg>On This Page</h3></summary><div class="tsd-accordion-details"><a href="#crash-recovery--persistence"><span>Crash <wbr/>Recovery &amp; <wbr/>Persistence</span></a><ul><li><a href="#purpose-and-scope"><span>Purpose and <wbr/>Scope</span></a></li><li><a href="#persistence-architecture"><span>Persistence <wbr/>Architecture</span></a></li><li><ul><li><a href="#adapter-responsibilities"><span>Adapter <wbr/>Responsibilities</span></a></li></ul></li><li><a href="#persistbase-interface"><span>Persist<wbr/>Base <wbr/>Interface</span></a></li><li><ul><li><a href="#method-contracts"><span>Method <wbr/>Contracts</span></a></li></ul></li><li><a href="#signal-persistence-lifecycle"><span>Signal <wbr/>Persistence <wbr/>Lifecycle</span></a></li><li><ul><li><a href="#key-state-transitions"><span>Key <wbr/>State <wbr/>Transitions</span></a></li></ul></li><li><a href="#atomic-write-operations"><span>Atomic <wbr/>Write <wbr/>Operations</span></a></li><li><ul><li><a href="#why-atomic-writes-matter"><span>Why <wbr/>Atomic <wbr/>Writes <wbr/>Matter</span></a></li></ul></li><li><a href="#recovery-flow"><span>Recovery <wbr/>Flow</span></a></li><li><ul><li><a href="#recovery-scenarios"><span>Recovery <wbr/>Scenarios</span></a></li></ul></li><li><a href="#default-file-based-storage"><span>Default <wbr/>File-<wbr/>Based <wbr/>Storage</span></a></li><li><ul><li><a href="#file-structure-example"><span>File <wbr/>Structure <wbr/>Example</span></a></li></ul></li><li><a href="#testing-persistence"><span>Testing <wbr/>Persistence</span></a></li><li><ul><li><a href="#example-test-long-signal-tp-after-restart"><span>Example <wbr/>Test: LONG <wbr/>Signal TP <wbr/>After <wbr/>Restart</span></a></li><li><a href="#test-coverage-matrix"><span>Test <wbr/>Coverage <wbr/>Matrix</span></a></li></ul></li><li><a href="#disabling-persistence-in-tests"><span>Disabling <wbr/>Persistence in <wbr/>Tests</span></a></li><li><a href="#integration-points"><span>Integration <wbr/>Points</span></a></li><li><ul><li><a href="#clientstrategy-integration"><span>Client<wbr/>Strategy <wbr/>Integration</span></a></li></ul></li><li><a href="#configuration-options"><span>Configuration <wbr/>Options</span></a></li><li><a href="#best-practices"><span>Best <wbr/>Practices</span></a></li><li><a href="#limitations-and-considerations"><span>Limitations and <wbr/>Considerations</span></a></li><li><a href="#summary"><span>Summary</span></a></li></ul></div></details></div><div class="site-menu"><nav class="tsd-navigation"><a href="../modules.html">backtest-kit</a><ul class="tsd-small-nested-navigation" id="tsd-nav-container"><li>Loading...</li></ul></nav></div></div></div><footer><p class="tsd-generator">Generated using <a href="https://typedoc.org/" target="_blank">TypeDoc</a></p></footer><div class="overlay"></div></body></html>

<!-- Yandex.Metrika counter -->
<script type="text/javascript">
    (function(m,e,t,r,i,k,a){
        m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
        m[i].l=1*new Date();
        for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }}
        k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)
    })(window, document,'script','https://mc.yandex.ru/metrika/tag.js?id=105455585', 'ym');

    ym(105455585, 'init', {ssr:true, webvisor:true, clickmap:true, ecommerce:"dataLayer", accurateTrackBounce:true, trackLinks:true});
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/105455585" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
<!-- /Yandex.Metrika counter -->

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-3MQZEBBDDR"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-3MQZEBBDDR');
</script>
