<!DOCTYPE html><html class="default" lang="en" data-base=".."><head><meta charset="utf-8"/><meta http-equiv="x-ua-compatible" content="IE=edge"/><title>design/16_client-layer | backtest-kit</title><meta name="description" content="Documentation for backtest-kit"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="stylesheet" href="../assets/style.css"/><link rel="stylesheet" href="../assets/highlight.css"/><script defer src="../assets/main.js"></script><script async src="../assets/icons.js" id="tsd-icons-script"></script><script async src="../assets/search.js" id="tsd-search-script"></script><script async src="../assets/navigation.js" id="tsd-nav-script"></script><script async src="../assets/hierarchy.js" id="tsd-hierarchy-script"></script></head><body><script>document.documentElement.dataset.theme = localStorage.getItem("tsd-theme") || "os";document.body.style.display="none";setTimeout(() => app?app.showPage():document.body.style.removeProperty("display"),500)</script><header class="tsd-page-toolbar"><div class="tsd-toolbar-contents container"><div class="table-cell" id="tsd-search"><div class="field"><label for="tsd-search-field" class="tsd-widget tsd-toolbar-icon search no-caption"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-search"></use></svg></label><input type="text" id="tsd-search-field" aria-label="Search"/></div><div class="field"><div id="tsd-toolbar-links"></div></div><ul class="results"><li class="state loading">Preparing search index...</li><li class="state failure">The search index is not available</li></ul><a href="../index.html" class="title">backtest-kit</a></div><div class="table-cell" id="tsd-widgets"><a href="#" class="tsd-widget tsd-toolbar-icon menu no-caption" data-toggle="menu" aria-label="Menu"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-menu"></use></svg></a></div></div></header><div class="container container-main"><div class="col-content"><div class="tsd-page-title"><ul class="tsd-breadcrumb"><li><a href="../modules.html">backtest-kit</a></li><li><a href="design_16_client-layer.html">design/16_client-layer</a></li></ul></div><div class="tsd-panel tsd-typography"><a id="client-layer" class="tsd-anchor"></a><h1 class="tsd-anchor-link">Client Layer<a href="#client-layer" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h1><a id="purpose-and-scope" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Purpose and Scope<a href="#purpose-and-scope" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>The Client Layer implements pure business logic for trading operations without dependency injection. It consists of five client classes (<code>ClientStrategy</code>, <code>ClientExchange</code>, <code>ClientFrame</code>, <code>ClientRisk</code>, <code>ClientPartial</code>) that execute core functionality like signal generation, data fetching, timeframe calculations, risk validation, and profit/loss tracking. This layer uses prototype methods instead of arrow functions for memory efficiency and is instantiated by Connection Services through memoization.</p>
<p>For information about how these clients are instantiated and routed through dependency injection, see <a href="design_14_architecture-deep-dive.html">Connection Services &amp; Memoization</a>. For event emission and reporting that consumes client outputs, see <a href="design_14_architecture-deep-dive.html">Event System Architecture</a>.</p>
<hr>
<a id="client-layer-architecture" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Client Layer Architecture<a href="#client-layer-architecture" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p><img src="../media/16_client-layer_0.svg" alt="Mermaid Diagram"></p>
<p><strong>Client Layer Design Principles:</strong></p>
<table>
<thead>
<tr>
<th>Principle</th>
<th>Implementation</th>
<th>Benefit</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>No Dependency Injection</strong></td>
<td>Clients receive dependencies via constructor params</td>
<td>Pure functions, easy to test</td>
</tr>
<tr>
<td><strong>Prototype Methods</strong></td>
<td>Methods defined on prototype, not as arrow functions</td>
<td>Shared across instances, reduces memory</td>
</tr>
<tr>
<td><strong>Memoization</strong></td>
<td>Connection Services cache instances by key</td>
<td>Prevents redundant instantiation</td>
</tr>
<tr>
<td><strong>Interface Contracts</strong></td>
<td>Each client implements specific interface</td>
<td>Type safety and clear API boundaries</td>
</tr>
<tr>
<td><strong>Stateful Instances</strong></td>
<td>Each client maintains internal state (e.g., <code>_pendingSignal</code>)</td>
<td>Encapsulates signal lifecycle</td>
</tr>
</tbody>
</table>
<hr>
<a id="clientstrategy-signal-lifecycle-management" class="tsd-anchor"></a><h2 class="tsd-anchor-link">ClientStrategy: Signal Lifecycle Management<a href="#clientstrategy-signal-lifecycle-management" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p><code>ClientStrategy</code> is the core client responsible for managing the complete signal lifecycle from generation through closure. It implements the <code>IStrategy</code> interface and orchestrates signal validation, persistence, TP/SL monitoring, and profit/loss tracking.</p>
<p><img src="../media/16_client-layer_1.svg" alt="Mermaid Diagram"></p>
<p><strong>Key ClientStrategy Features:</strong></p>
<table>
<thead>
<tr>
<th>Feature</th>
<th>Implementation</th>
<th>Location</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Interval Throttling</strong></td>
<td>Checks <code>_lastSignalTimestamp</code> before calling <code>getSignal()</code></td>
<td><code>src/client/ClientStrategy.ts:341-353</code></td>
</tr>
<tr>
<td><strong>Signal Validation</strong></td>
<td><code>VALIDATE_SIGNAL_FN</code> checks TP/SL logic, prices, GLOBAL_CONFIG</td>
<td><code>src/client/ClientStrategy.ts:45-330</code></td>
</tr>
<tr>
<td><strong>Scheduled Signals</strong></td>
<td>Monitors price activation and SL breach before entry</td>
<td><code>src/client/ClientStrategy.ts:610-644</code></td>
</tr>
<tr>
<td><strong>Crash Recovery</strong></td>
<td><code>waitForInit()</code> loads persisted signals from disk</td>
<td><code>src/client/ClientStrategy.ts:491-552</code></td>
</tr>
<tr>
<td><strong>Graceful Shutdown</strong></td>
<td><code>_isStopped</code> prevents new signals, allows active to close</td>
<td><code>src/client/ClientStrategy.ts:336-338</code></td>
</tr>
<tr>
<td><strong>VWAP Pricing</strong></td>
<td>Uses <code>exchange.getAveragePrice()</code> for all entry/exit prices</td>
<td><code>src/client/ClientStrategy.ts:354-356</code></td>
</tr>
</tbody>
</table>
<p><strong>ClientStrategy Constructor Parameters:</strong></p>
<pre><code class="typescript"><span class="hl-7">interface</span><span class="hl-1"> </span><span class="hl-11">IStrategyParams</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-4">symbol</span><span class="hl-1">: </span><span class="hl-11">string</span><span class="hl-1">;                      </span><span class="hl-5">// Trading pair</span><br/><span class="hl-1">    </span><span class="hl-4">interval</span><span class="hl-1">: </span><span class="hl-11">SignalInterval</span><span class="hl-1">;            </span><span class="hl-5">// Throttling interval (1m, 5m, etc)</span><br/><span class="hl-1">    </span><span class="hl-4">strategyName</span><span class="hl-1">: </span><span class="hl-11">StrategyName</span><span class="hl-1">;          </span><span class="hl-5">// Unique identifier</span><br/><span class="hl-1">    </span><span class="hl-0">getSignal</span><span class="hl-1">: (</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">when</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> </span><span class="hl-11">ISignalDto</span><span class="hl-1"> | </span><span class="hl-11">null</span><span class="hl-1">;  </span><span class="hl-5">// User-defined logic</span><br/><span class="hl-1">    </span><span class="hl-4">callbacks</span><span class="hl-1">?: </span><span class="hl-11">Partial</span><span class="hl-1">&lt;</span><span class="hl-11">IStrategyCallbacks</span><span class="hl-1">&gt;;  </span><span class="hl-5">// Lifecycle hooks</span><br/><span class="hl-1">    </span><span class="hl-4">riskName</span><span class="hl-1">: </span><span class="hl-11">RiskName</span><span class="hl-1">;                  </span><span class="hl-5">// Risk profile identifier</span><br/><span class="hl-1">    </span><span class="hl-4">exchange</span><span class="hl-1">: </span><span class="hl-11">IExchange</span><span class="hl-1">;                 </span><span class="hl-5">// Data source client</span><br/><span class="hl-1">    </span><span class="hl-4">risk</span><span class="hl-1">: </span><span class="hl-11">IRisk</span><span class="hl-1">;                         </span><span class="hl-5">// Risk validator client</span><br/><span class="hl-1">    </span><span class="hl-4">partial</span><span class="hl-1">: </span><span class="hl-11">IPartial</span><span class="hl-1">;                   </span><span class="hl-5">// Profit/loss tracker</span><br/><span class="hl-1">    </span><span class="hl-4">logger</span><span class="hl-1">: </span><span class="hl-11">ILogger</span><span class="hl-1">;                     </span><span class="hl-5">// Logging service</span><br/><span class="hl-1">    </span><span class="hl-4">execution</span><span class="hl-1">: </span><span class="hl-11">TExecutionContextService</span><span class="hl-1">; </span><span class="hl-5">// Context propagation</span><br/><span class="hl-1">    </span><span class="hl-4">method</span><span class="hl-1">: </span><span class="hl-11">TMethodContextService</span><span class="hl-1">;       </span><span class="hl-5">// Schema name routing</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<hr>
<a id="clientexchange-data-source-integration" class="tsd-anchor"></a><h2 class="tsd-anchor-link">ClientExchange: Data Source Integration<a href="#clientexchange-data-source-integration" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p><code>ClientExchange</code> implements the <code>IExchange</code> interface to fetch historical candles, calculate VWAP, and format prices/quantities according to exchange precision rules. It wraps the user-provided <code>IExchangeSchema</code> and adds temporal context awareness.</p>
<p><img src="../media/16_client-layer_2.svg" alt="Mermaid Diagram"></p>
<p><strong>VWAP Calculation Logic:</strong></p>
<p>The <code>getAveragePrice()</code> method fetches the last 5 one-minute candles and calculates Volume Weighted Average Price:</p>
<pre><code><span class="hl-4">Typical</span><span class="hl-1"> </span><span class="hl-4">Price</span><span class="hl-1"> = (</span><span class="hl-4">High</span><span class="hl-1"> + </span><span class="hl-4">Low</span><span class="hl-1"> + </span><span class="hl-4">Close</span><span class="hl-1">) / </span><span class="hl-6">3</span><br/><span class="hl-8">VWAP</span><span class="hl-1"> = </span><span class="hl-0">Σ</span><span class="hl-1">(</span><span class="hl-4">Typical</span><span class="hl-1"> </span><span class="hl-4">Price</span><span class="hl-1"> × </span><span class="hl-4">Volume</span><span class="hl-1">) / </span><span class="hl-0">Σ</span><span class="hl-1">(</span><span class="hl-4">Volume</span><span class="hl-1">)</span>
</code><button>Copy</button></pre>

<p>If total volume is zero (illiquid market), falls back to simple average of close prices.</p>
<p><strong>ClientExchange Responsibilities:</strong></p>
<table>
<thead>
<tr>
<th>Responsibility</th>
<th>Method</th>
<th>Implementation</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Historical Data</strong></td>
<td><code>getCandles()</code></td>
<td>Fetches backwards from <code>execution.context.when</code></td>
</tr>
<tr>
<td><strong>Future Data (Backtest)</strong></td>
<td><code>getNextCandles()</code></td>
<td>Fetches forwards from <code>execution.context.when</code></td>
</tr>
<tr>
<td><strong>Realistic Entry/Exit</strong></td>
<td><code>getAveragePrice()</code></td>
<td>VWAP prevents look-ahead bias</td>
</tr>
<tr>
<td><strong>Exchange Precision</strong></td>
<td><code>formatPrice()</code>, <code>formatQuantity()</code></td>
<td>Delegates to user schema</td>
</tr>
<tr>
<td><strong>Anomaly Detection</strong></td>
<td>Validates candle data</td>
<td>Checks for NaN, Infinity, incomplete candles</td>
</tr>
</tbody>
</table>
<hr>
<a id="clientframe-timeframe-generation" class="tsd-anchor"></a><h2 class="tsd-anchor-link">ClientFrame: Timeframe Generation<a href="#clientframe-timeframe-generation" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p><code>ClientFrame</code> implements the <code>IFrame</code> interface to generate arrays of timestamps for backtest iteration. It converts user-defined <code>IFrameSchema</code> (startDate, endDate, interval) into a sequence of <code>Date</code> objects.</p>
<p><img src="../media/16_client-layer_3.svg" alt="Mermaid Diagram"></p>
<p><strong>Frame Interval Types:</strong></p>
<table>
<thead>
<tr>
<th>Interval Type</th>
<th>Values</th>
<th>Use Case</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Minutes</strong></td>
<td><code>1m</code>, <code>3m</code>, <code>5m</code>, <code>15m</code>, <code>30m</code></td>
<td>High-frequency strategies</td>
</tr>
<tr>
<td><strong>Hours</strong></td>
<td><code>1h</code>, <code>2h</code>, <code>4h</code>, <code>6h</code>, <code>8h</code>, <code>12h</code></td>
<td>Swing trading</td>
</tr>
<tr>
<td><strong>Days</strong></td>
<td><code>1d</code>, <code>3d</code></td>
<td>Position trading</td>
</tr>
</tbody>
</table>
<p><strong>ClientFrame Timeframe Generation:</strong></p>
<p>The <code>getTimeframe()</code> method generates timestamps by:</p>
<ol>
<li>Starting at <code>startDate</code></li>
<li>Incrementing by <code>interval</code> milliseconds</li>
<li>Continuing until <code>endDate</code> (inclusive)</li>
<li>Calling <code>callbacks.onTimeframe()</code> with result</li>
</ol>
<p>This deterministic array enables backtest orchestration to iterate through history minute-by-minute (or at configured interval granularity).</p>
<hr>
<a id="clientrisk-portfolio-level-risk-management" class="tsd-anchor"></a><h2 class="tsd-anchor-link">ClientRisk: Portfolio-Level Risk Management<a href="#clientrisk-portfolio-level-risk-management" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p><code>ClientRisk</code> implements the <code>IRisk</code> interface to validate signals before opening positions. It tracks active positions across strategies and enforces user-defined risk rules through custom validation functions.</p>
<p><img src="../media/16_client-layer_4.svg" alt="Mermaid Diagram"></p>
<p><strong>IRiskValidationPayload Structure:</strong></p>
<pre><code class="typescript"><span class="hl-7">interface</span><span class="hl-1"> </span><span class="hl-11">IRiskValidationPayload</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-4">symbol</span><span class="hl-1">: </span><span class="hl-11">string</span><span class="hl-1">;                    </span><span class="hl-5">// Trading pair</span><br/><span class="hl-1">    </span><span class="hl-4">pendingSignal</span><span class="hl-1">: </span><span class="hl-11">ISignalDto</span><span class="hl-1">;         </span><span class="hl-5">// Signal to validate</span><br/><span class="hl-1">    </span><span class="hl-4">strategyName</span><span class="hl-1">: </span><span class="hl-11">StrategyName</span><span class="hl-1">;        </span><span class="hl-5">// Requesting strategy</span><br/><span class="hl-1">    </span><span class="hl-4">exchangeName</span><span class="hl-1">: </span><span class="hl-11">ExchangeName</span><span class="hl-1">;        </span><span class="hl-5">// Exchange identifier</span><br/><span class="hl-1">    </span><span class="hl-4">currentPrice</span><span class="hl-1">: </span><span class="hl-11">number</span><span class="hl-1">;              </span><span class="hl-5">// VWAP price</span><br/><span class="hl-1">    </span><span class="hl-4">timestamp</span><span class="hl-1">: </span><span class="hl-11">number</span><span class="hl-1">;                 </span><span class="hl-5">// Event time</span><br/><span class="hl-1">    </span><span class="hl-4">activePositionCount</span><span class="hl-1">: </span><span class="hl-11">number</span><span class="hl-1">;       </span><span class="hl-5">// Total active positions</span><br/><span class="hl-1">    </span><span class="hl-4">activePositions</span><span class="hl-1">: </span><span class="hl-11">IRiskActivePosition</span><span class="hl-1">[];  </span><span class="hl-5">// Position details</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<p><strong>ClientRisk Validation Flow:</strong></p>
<ol>
<li><strong>Pre-Opening Check</strong>: <code>checkSignal()</code> called before signal creation</li>
<li><strong>Validation Execution</strong>: Each validation function receives <code>IRiskValidationPayload</code></li>
<li><strong>Rejection Handling</strong>: Any thrown error rejects the signal</li>
<li><strong>Position Tracking</strong>: <code>addSignal()</code> after opening, <code>removeSignal()</code> after closing</li>
<li><strong>Event Emission</strong>: Rejected signals emit to <code>riskSubject</code></li>
</ol>
<hr>
<a id="clientpartial-profitloss-milestone-tracking" class="tsd-anchor"></a><h2 class="tsd-anchor-link">ClientPartial: Profit/Loss Milestone Tracking<a href="#clientpartial-profitloss-milestone-tracking" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p><code>ClientPartial</code> implements the <code>IPartial</code> interface to monitor unrealized profit/loss milestones (10%, 20%, 30%, etc) during active signal monitoring. It uses Set-based deduplication to emit each level only once per signal.</p>
<p><img src="../media/16_client-layer_5.svg" alt="Mermaid Diagram"></p>
<p><strong>Partial Level Detection Example:</strong></p>
<pre><code><span class="hl-4">Signal</span><span class="hl-1"> </span><span class="hl-4">opens</span><span class="hl-1"> </span><span class="hl-4">at</span><span class="hl-1"> </span><span class="hl-4">$50</span><span class="hl-1">,</span><span class="hl-6">000</span><br/><br/><span class="hl-4">Price</span><span class="hl-1"> </span><span class="hl-4">rises</span><span class="hl-1"> </span><span class="hl-4">to</span><span class="hl-1"> </span><span class="hl-4">$54</span><span class="hl-1">,</span><span class="hl-6">000</span><span class="hl-1"> → </span><span class="hl-6">8</span><span class="hl-1">% </span><span class="hl-4">profit</span><span class="hl-1"> → </span><span class="hl-4">No</span><span class="hl-1"> </span><span class="hl-0">event</span><span class="hl-1"> (</span><span class="hl-4">below</span><span class="hl-1"> </span><span class="hl-6">10</span><span class="hl-1">%)</span><br/><span class="hl-4">Price</span><span class="hl-1"> </span><span class="hl-4">rises</span><span class="hl-1"> </span><span class="hl-4">to</span><span class="hl-1"> </span><span class="hl-4">$55</span><span class="hl-1">,</span><span class="hl-6">000</span><span class="hl-1"> → </span><span class="hl-6">10</span><span class="hl-1">% </span><span class="hl-4">profit</span><span class="hl-1"> → </span><span class="hl-4">Emit</span><span class="hl-1"> </span><span class="hl-0">partialProfitSubject</span><span class="hl-1"> (</span><span class="hl-4">level</span><span class="hl-1"> </span><span class="hl-6">10</span><span class="hl-1">)</span><br/><span class="hl-4">Price</span><span class="hl-1"> </span><span class="hl-4">rises</span><span class="hl-1"> </span><span class="hl-4">to</span><span class="hl-1"> </span><span class="hl-4">$60</span><span class="hl-1">,</span><span class="hl-6">000</span><span class="hl-1"> → </span><span class="hl-6">20</span><span class="hl-1">% </span><span class="hl-4">profit</span><span class="hl-1"> → </span><span class="hl-4">Emit</span><span class="hl-1"> </span><span class="hl-0">partialProfitSubject</span><span class="hl-1"> (</span><span class="hl-4">level</span><span class="hl-1"> </span><span class="hl-6">20</span><span class="hl-1">)</span><br/><span class="hl-4">Price</span><span class="hl-1"> </span><span class="hl-4">rises</span><span class="hl-1"> </span><span class="hl-4">to</span><span class="hl-1"> </span><span class="hl-4">$59</span><span class="hl-1">,</span><span class="hl-6">000</span><span class="hl-1"> → </span><span class="hl-6">18</span><span class="hl-1">% </span><span class="hl-4">profit</span><span class="hl-1"> → </span><span class="hl-4">No</span><span class="hl-1"> </span><span class="hl-0">event</span><span class="hl-1"> (</span><span class="hl-4">level</span><span class="hl-1"> </span><span class="hl-6">20</span><span class="hl-1"> </span><span class="hl-4">already</span><span class="hl-1"> </span><span class="hl-4">emitted</span><span class="hl-1">)</span><br/><span class="hl-4">Price</span><span class="hl-1"> </span><span class="hl-4">rises</span><span class="hl-1"> </span><span class="hl-4">to</span><span class="hl-1"> </span><span class="hl-4">$65</span><span class="hl-1">,</span><span class="hl-6">000</span><span class="hl-1"> → </span><span class="hl-6">30</span><span class="hl-1">% </span><span class="hl-4">profit</span><span class="hl-1"> → </span><span class="hl-4">Emit</span><span class="hl-1"> </span><span class="hl-0">partialProfitSubject</span><span class="hl-1"> (</span><span class="hl-4">level</span><span class="hl-1"> </span><span class="hl-6">30</span><span class="hl-1">)</span>
</code><button>Copy</button></pre>

<p><strong>ClientPartial State Persistence:</strong></p>
<ul>
<li><strong>In-Memory State</strong>: <code>Map&lt;signalId, IPartialState&gt;</code> with <code>Set&lt;PartialLevel&gt;</code></li>
<li><strong>Disk Persistence</strong>: <code>PersistPartialAdapter</code> serializes Sets to arrays</li>
<li><strong>Crash Recovery</strong>: State restored on <code>waitForInit()</code></li>
</ul>
<hr>
<a id="prototype-methods-pattern-memory-efficiency" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Prototype Methods Pattern: Memory Efficiency<a href="#prototype-methods-pattern-memory-efficiency" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>All client classes use <strong>prototype methods</strong> instead of arrow functions to share method implementations across instances. This reduces memory consumption when many client instances exist (e.g., multiple symbols, strategies, timeframes).</p>
<p><img src="../media/16_client-layer_6.svg" alt="Mermaid Diagram"></p>
<p><strong>Prototype Method Implementation:</strong></p>
<pre><code class="typescript"><span class="hl-7">class</span><span class="hl-1"> </span><span class="hl-11">ClientStrategy</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-7">constructor</span><span class="hl-1">(</span><span class="hl-4">params</span><span class="hl-1">: </span><span class="hl-11">IStrategyParams</span><span class="hl-1">) {</span><br/><span class="hl-1">        </span><span class="hl-7">this</span><span class="hl-1">.</span><span class="hl-4">params</span><span class="hl-1"> = </span><span class="hl-4">params</span><span class="hl-1">;</span><br/><span class="hl-1">        </span><span class="hl-7">this</span><span class="hl-1">.</span><span class="hl-4">_pendingSignal</span><span class="hl-1"> = </span><span class="hl-7">null</span><span class="hl-1">;        </span><span class="hl-5">// Instance-specific state</span><br/><span class="hl-1">        </span><span class="hl-7">this</span><span class="hl-1">.</span><span class="hl-4">_scheduledSignal</span><span class="hl-1"> = </span><span class="hl-7">null</span><span class="hl-1">;      </span><span class="hl-5">// Instance-specific state</span><br/><span class="hl-1">        </span><span class="hl-7">this</span><span class="hl-1">.</span><span class="hl-4">_lastSignalTimestamp</span><span class="hl-1"> = </span><span class="hl-7">null</span><span class="hl-1">;  </span><span class="hl-5">// Instance-specific state</span><br/><span class="hl-1">        </span><span class="hl-7">this</span><span class="hl-1">.</span><span class="hl-4">_isStopped</span><span class="hl-1"> = </span><span class="hl-7">false</span><span class="hl-1">;           </span><span class="hl-5">// Instance-specific state</span><br/><span class="hl-1">    }</span><br/><br/><span class="hl-1">    </span><span class="hl-5">// Prototype method (shared across instances)</span><br/><span class="hl-1">    </span><span class="hl-0">tick</span><span class="hl-1">(</span><span class="hl-4">symbol</span><span class="hl-1">: </span><span class="hl-11">string</span><span class="hl-1">, </span><span class="hl-4">strategyName</span><span class="hl-1">: </span><span class="hl-11">StrategyName</span><span class="hl-1">): </span><span class="hl-11">Promise</span><span class="hl-1">&lt;</span><span class="hl-11">IStrategyTickResult</span><span class="hl-1">&gt; {</span><br/><span class="hl-1">        </span><span class="hl-5">// Implementation uses &#39;this&#39; to access instance state</span><br/><span class="hl-1">    }</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<p><strong>Memory Efficiency Comparison:</strong></p>
<table>
<thead>
<tr>
<th>Approach</th>
<th>Memory per Instance</th>
<th>Total for 100 Instances</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Arrow Functions</strong></td>
<td>~50KB (each method copy)</td>
<td>~5MB</td>
</tr>
<tr>
<td><strong>Prototype Methods</strong></td>
<td>~1KB (state only)</td>
<td>~100KB</td>
</tr>
<tr>
<td><strong>Savings</strong></td>
<td>98% reduction</td>
<td>98% reduction</td>
</tr>
</tbody>
</table>
<hr>
<a id="client-instantiation--memoization" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Client Instantiation &amp; Memoization<a href="#client-instantiation--memoization" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>Connection Services create client instances using <strong>memoization</strong> to prevent redundant instantiation. Each client is cached by a unique key (e.g., <code>symbol:strategyName</code> for <code>ClientStrategy</code>).</p>
<p><img src="../media/16_client-layer_7.svg" alt="Mermaid Diagram"></p>
<p><strong>Memoization Keys by Client:</strong></p>
<table>
<thead>
<tr>
<th>Client</th>
<th>Memoization Key</th>
<th>Example</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>ClientStrategy</strong></td>
<td><code>${symbol}:${strategyName}</code></td>
<td><code>&quot;BTCUSDT:my-strategy&quot;</code></td>
</tr>
<tr>
<td><strong>ClientExchange</strong></td>
<td><code>${exchangeName}</code></td>
<td><code>&quot;binance&quot;</code></td>
</tr>
<tr>
<td><strong>ClientFrame</strong></td>
<td><code>${frameName}</code></td>
<td><code>&quot;1d-backtest&quot;</code></td>
</tr>
<tr>
<td><strong>ClientRisk</strong></td>
<td><code>${riskName}</code></td>
<td><code>&quot;max-positions&quot;</code></td>
</tr>
<tr>
<td><strong>ClientPartial</strong></td>
<td>Singleton (no key)</td>
<td>Single instance</td>
</tr>
</tbody>
</table>
<p><strong>StrategyConnectionService.getStrategy() Implementation:</strong></p>
<pre><code class="typescript"><span class="hl-4">private</span><span class="hl-1"> </span><span class="hl-4">getStrategy</span><span class="hl-1"> = </span><span class="hl-0">memoize</span><span class="hl-1">(</span><br/><span class="hl-1">    ([</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">strategyName</span><span class="hl-1">]) </span><span class="hl-7">=&gt;</span><span class="hl-1"> </span><span class="hl-2">`</span><span class="hl-7">${</span><span class="hl-4">symbol</span><span class="hl-7">}</span><span class="hl-2">:</span><span class="hl-7">${</span><span class="hl-4">strategyName</span><span class="hl-7">}</span><span class="hl-2">`</span><span class="hl-1">,  </span><span class="hl-5">// Key function</span><br/><span class="hl-1">    (</span><span class="hl-4">symbol</span><span class="hl-1">: </span><span class="hl-11">string</span><span class="hl-1">, </span><span class="hl-4">strategyName</span><span class="hl-1">: </span><span class="hl-11">StrategyName</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> {         </span><span class="hl-5">// Factory function</span><br/><span class="hl-1">        </span><span class="hl-7">const</span><span class="hl-1"> {</span><br/><span class="hl-1">            </span><span class="hl-8">riskName</span><span class="hl-1"> = </span><span class="hl-2">&quot;&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">            </span><span class="hl-8">riskList</span><span class="hl-1"> = [],</span><br/><span class="hl-1">            </span><span class="hl-8">getSignal</span><span class="hl-1">,</span><br/><span class="hl-1">            </span><span class="hl-8">interval</span><span class="hl-1">,</span><br/><span class="hl-1">            </span><span class="hl-8">callbacks</span><span class="hl-1">,</span><br/><span class="hl-1">        } = </span><span class="hl-7">this</span><span class="hl-1">.</span><span class="hl-4">strategySchemaService</span><span class="hl-1">.</span><span class="hl-0">get</span><span class="hl-1">(</span><span class="hl-4">strategyName</span><span class="hl-1">);</span><br/><span class="hl-1">        </span><span class="hl-3">return</span><span class="hl-1"> </span><span class="hl-7">new</span><span class="hl-1"> </span><span class="hl-0">ClientStrategy</span><span class="hl-1">({</span><br/><span class="hl-1">            </span><span class="hl-4">symbol</span><span class="hl-1">,</span><br/><span class="hl-1">            </span><span class="hl-4">interval</span><span class="hl-1">,</span><br/><span class="hl-1">            </span><span class="hl-4">execution:</span><span class="hl-1"> </span><span class="hl-7">this</span><span class="hl-1">.</span><span class="hl-4">executionContextService</span><span class="hl-1">,</span><br/><span class="hl-1">            </span><span class="hl-4">method:</span><span class="hl-1"> </span><span class="hl-7">this</span><span class="hl-1">.</span><span class="hl-4">methodContextService</span><span class="hl-1">,</span><br/><span class="hl-1">            </span><span class="hl-4">logger:</span><span class="hl-1"> </span><span class="hl-7">this</span><span class="hl-1">.</span><span class="hl-4">loggerService</span><span class="hl-1">,</span><br/><span class="hl-1">            </span><span class="hl-4">partial:</span><span class="hl-1"> </span><span class="hl-7">this</span><span class="hl-1">.</span><span class="hl-4">partialConnectionService</span><span class="hl-1">,</span><br/><span class="hl-1">            </span><span class="hl-4">exchange:</span><span class="hl-1"> </span><span class="hl-7">this</span><span class="hl-1">.</span><span class="hl-4">exchangeConnectionService</span><span class="hl-1">,</span><br/><span class="hl-1">            </span><span class="hl-4">risk:</span><span class="hl-1"> </span><span class="hl-0">GET_RISK_FN</span><span class="hl-1">({ </span><span class="hl-4">riskName</span><span class="hl-1">, </span><span class="hl-4">riskList</span><span class="hl-1"> }, </span><span class="hl-7">this</span><span class="hl-1">),</span><br/><span class="hl-1">            </span><span class="hl-4">riskName</span><span class="hl-1">,</span><br/><span class="hl-1">            </span><span class="hl-4">strategyName</span><span class="hl-1">,</span><br/><span class="hl-1">            </span><span class="hl-4">getSignal</span><span class="hl-1">,</span><br/><span class="hl-1">            </span><span class="hl-4">callbacks</span><span class="hl-1">,</span><br/><span class="hl-1">        });</span><br/><span class="hl-1">    }</span><br/><span class="hl-1">);</span>
</code><button type="button">Copy</button></pre>

<p><strong>Cache Clearing:</strong></p>
<p>Connection Services expose a <code>clear()</code> method to invalidate cached instances:</p>
<ul>
<li><code>clear()</code> - Clear all cached instances</li>
<li><code>clear({ symbol, strategyName })</code> - Clear specific instance</li>
</ul>
<p>This is useful for resetting state during testing or releasing resources.</p>
<hr>
<a id="client-layer-summary" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Client Layer Summary<a href="#client-layer-summary" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><table>
<thead>
<tr>
<th>Client Class</th>
<th>Interface</th>
<th>Primary Responsibility</th>
<th>State Management</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>ClientStrategy</strong></td>
<td><code>IStrategy</code></td>
<td>Signal lifecycle (generate → monitor → close)</td>
<td><code>_pendingSignal</code>, <code>_scheduledSignal</code>, <code>_lastSignalTimestamp</code>, <code>_isStopped</code></td>
</tr>
<tr>
<td><strong>ClientExchange</strong></td>
<td><code>IExchange</code></td>
<td>Data fetching, VWAP calculation, precision formatting</td>
<td>Stateless (delegates to user schema)</td>
</tr>
<tr>
<td><strong>ClientFrame</strong></td>
<td><code>IFrame</code></td>
<td>Timeframe generation for backtest iteration</td>
<td>Stateless (pure calculation)</td>
</tr>
<tr>
<td><strong>ClientRisk</strong></td>
<td><code>IRisk</code></td>
<td>Pre-opening validation, active position tracking</td>
<td><code>Map&lt;symbol, IRiskActivePosition[]&gt;</code></td>
</tr>
<tr>
<td><strong>ClientPartial</strong></td>
<td><code>IPartial</code></td>
<td>Profit/loss milestone detection and emission</td>
<td><code>Map&lt;signalId, IPartialState&gt;</code></td>
</tr>
</tbody>
</table>
<p>The Client Layer follows a <strong>pure business logic</strong> pattern:</p>
<ul>
<li>No dependency injection (receives dependencies via constructor)</li>
<li>Prototype methods for memory efficiency</li>
<li>Memoized instantiation via Connection Services</li>
<li>Clear interface contracts for type safety</li>
<li>Stateful instances encapsulate domain logic</li>
</ul>
<p>This design separates concerns between orchestration (Service Layer) and execution (Client Layer), enabling testability, maintainability, and memory-optimized performance.</p>
</div></div><div class="col-sidebar"><div class="page-menu"><div class="tsd-navigation settings"><details class="tsd-accordion"><summary class="tsd-accordion-summary"><h3><svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-chevronDown"></use></svg>Settings</h3></summary><div class="tsd-accordion-details"><div class="tsd-filter-visibility"><span class="settings-label">Member Visibility</span><ul id="tsd-filter-options"><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-protected" name="protected"/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Protected</span></label></li><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-inherited" name="inherited" checked/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Inherited</span></label></li><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-external" name="external"/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>External</span></label></li></ul></div><div class="tsd-theme-toggle"><label class="settings-label" for="tsd-theme">Theme</label><select id="tsd-theme"><option value="os">OS</option><option value="light">Light</option><option value="dark">Dark</option></select></div></div></details></div><details open class="tsd-accordion tsd-page-navigation"><summary class="tsd-accordion-summary"><h3><svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-chevronDown"></use></svg>On This Page</h3></summary><div class="tsd-accordion-details"><a href="#client-layer"><span>Client <wbr/>Layer</span></a><ul><li><a href="#purpose-and-scope"><span>Purpose and <wbr/>Scope</span></a></li><li><a href="#client-layer-architecture"><span>Client <wbr/>Layer <wbr/>Architecture</span></a></li><li><a href="#clientstrategy-signal-lifecycle-management"><span>Client<wbr/>Strategy: <wbr/>Signal <wbr/>Lifecycle <wbr/>Management</span></a></li><li><a href="#clientexchange-data-source-integration"><span>Client<wbr/>Exchange: <wbr/>Data <wbr/>Source <wbr/>Integration</span></a></li><li><a href="#clientframe-timeframe-generation"><span>Client<wbr/>Frame: <wbr/>Timeframe <wbr/>Generation</span></a></li><li><a href="#clientrisk-portfolio-level-risk-management"><span>Client<wbr/>Risk: <wbr/>Portfolio-<wbr/>Level <wbr/>Risk <wbr/>Management</span></a></li><li><a href="#clientpartial-profitloss-milestone-tracking"><span>Client<wbr/>Partial: <wbr/>Profit/<wbr/>Loss <wbr/>Milestone <wbr/>Tracking</span></a></li><li><a href="#prototype-methods-pattern-memory-efficiency"><span>Prototype <wbr/>Methods <wbr/>Pattern: <wbr/>Memory <wbr/>Efficiency</span></a></li><li><a href="#client-instantiation--memoization"><span>Client <wbr/>Instantiation &amp; <wbr/>Memoization</span></a></li><li><a href="#client-layer-summary"><span>Client <wbr/>Layer <wbr/>Summary</span></a></li></ul></div></details></div><div class="site-menu"><nav class="tsd-navigation"><a href="../modules.html">backtest-kit</a><ul class="tsd-small-nested-navigation" id="tsd-nav-container"><li>Loading...</li></ul></nav></div></div></div><footer><p class="tsd-generator">Generated using <a href="https://typedoc.org/" target="_blank">TypeDoc</a></p></footer><div class="overlay"></div></body></html>

<!-- Yandex.Metrika counter -->
<script type="text/javascript">
    (function(m,e,t,r,i,k,a){
        m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
        m[i].l=1*new Date();
        for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }}
        k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)
    })(window, document,'script','https://mc.yandex.ru/metrika/tag.js?id=105455585', 'ym');

    ym(105455585, 'init', {ssr:true, webvisor:true, clickmap:true, ecommerce:"dataLayer", accurateTrackBounce:true, trackLinks:true});
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/105455585" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
<!-- /Yandex.Metrika counter -->

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-3MQZEBBDDR"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-3MQZEBBDDR');
</script>
