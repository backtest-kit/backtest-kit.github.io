<!DOCTYPE html><html class="default" lang="en" data-base=".."><head><meta charset="utf-8"/><meta http-equiv="x-ua-compatible" content="IE=edge"/><title>design/15_position-sizing | backtest-kit</title><meta name="description" content="Documentation for backtest-kit"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="stylesheet" href="../assets/style.css"/><link rel="stylesheet" href="../assets/highlight.css"/><script defer src="../assets/main.js"></script><script async src="../assets/icons.js" id="tsd-icons-script"></script><script async src="../assets/search.js" id="tsd-search-script"></script><script async src="../assets/navigation.js" id="tsd-nav-script"></script><script async src="../assets/hierarchy.js" id="tsd-hierarchy-script"></script></head><body><script>document.documentElement.dataset.theme = localStorage.getItem("tsd-theme") || "os";document.body.style.display="none";setTimeout(() => app?app.showPage():document.body.style.removeProperty("display"),500)</script><header class="tsd-page-toolbar"><div class="tsd-toolbar-contents container"><div class="table-cell" id="tsd-search"><div class="field"><label for="tsd-search-field" class="tsd-widget tsd-toolbar-icon search no-caption"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-search"></use></svg></label><input type="text" id="tsd-search-field" aria-label="Search"/></div><div class="field"><div id="tsd-toolbar-links"></div></div><ul class="results"><li class="state loading">Preparing search index...</li><li class="state failure">The search index is not available</li></ul><a href="../index.html" class="title">backtest-kit</a></div><div class="table-cell" id="tsd-widgets"><a href="#" class="tsd-widget tsd-toolbar-icon menu no-caption" data-toggle="menu" aria-label="Menu"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-menu"></use></svg></a></div></div></header><div class="container container-main"><div class="col-content"><div class="tsd-page-title"><ul class="tsd-breadcrumb"><li><a href="../modules.html">backtest-kit</a></li><li><a href="design_15_position-sizing.html">design/15_position-sizing</a></li></ul></div><div class="tsd-panel tsd-typography"><a id="position-sizing" class="tsd-anchor"></a><h1 class="tsd-anchor-link">Position Sizing<a href="#position-sizing" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h1><p>Position sizing determines how much capital to allocate to each trading signal. This page documents the position sizing system, including the three built-in sizing methods (fixed-percentage, Kelly Criterion, ATR-based), schema registration, calculation flow, and service architecture.</p>
<p>For information about risk management and portfolio-level position limits, see <a href="design_14_risk-management.html">Risk Management</a>. For strategy configuration that uses position sizing, see <a href="design_12_defining-strategies.html">Defining Strategies</a>.</p>
<hr>
<a id="purpose-and-scope" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Purpose and Scope<a href="#purpose-and-scope" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>The position sizing system calculates the quantity of an asset to trade based on:</p>
<ul>
<li>Account balance</li>
<li>Risk tolerance</li>
<li>Market volatility (for ATR-based sizing)</li>
<li>Historical performance (for Kelly Criterion)</li>
<li>Price levels (for fixed-percentage sizing)</li>
</ul>
<p>Position sizing is configured via <code>ISizingSchema</code> and registered using <code>addSizing()</code>. Each sizing configuration defines a calculation method and constraints (min/max position size, max position percentage). The framework provides three built-in methods as a discriminated union based on the <code>method</code> field.</p>
<hr>
<a id="position-sizing-methods" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Position Sizing Methods<a href="#position-sizing-methods" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>The framework provides three position sizing methods, each suited for different risk management philosophies:</p>
<a id="method-comparison" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Method Comparison<a href="#method-comparison" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><table>
<thead>
<tr>
<th>Method</th>
<th>Description</th>
<th>Formula</th>
<th>Best For</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>fixed-percentage</code></td>
<td>Risk fixed % of account per trade</td>
<td><code>(Balance × Risk%) / (Entry - StopLoss)</code></td>
<td>Conservative, consistent risk</td>
</tr>
<tr>
<td><code>kelly-criterion</code></td>
<td>Optimal sizing based on edge</td>
<td><code>Balance × Kelly% × Multiplier</code></td>
<td>Statistical edge exploitation</td>
</tr>
<tr>
<td><code>atr-based</code></td>
<td>Volatility-adjusted sizing</td>
<td><code>(Balance × Risk%) / (ATR × Multiplier)</code></td>
<td>Adapting to market conditions</td>
</tr>
</tbody>
</table>
<a id="fixed-percentage-sizing" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Fixed Percentage Sizing<a href="#fixed-percentage-sizing" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Risks a fixed percentage of account balance per trade. Position size is calculated based on the distance between entry price and stop loss.</p>
<p><strong>Formula:</strong></p>
<pre><code><span class="hl-4">Position</span><span class="hl-1"> </span><span class="hl-4">Size</span><span class="hl-1"> = (</span><span class="hl-4">Account</span><span class="hl-1"> </span><span class="hl-4">Balance</span><span class="hl-1"> × </span><span class="hl-4">Risk</span><span class="hl-1"> %) / (</span><span class="hl-4">Entry</span><span class="hl-1"> </span><span class="hl-4">Price</span><span class="hl-1"> - </span><span class="hl-4">Stop</span><span class="hl-1"> </span><span class="hl-4">Loss</span><span class="hl-1"> </span><span class="hl-4">Price</span><span class="hl-1">)</span>
</code><button>Copy</button></pre>

<p><strong>Parameters:</strong></p>
<ul>
<li><code>riskPercentage</code>: Percentage of account to risk (e.g., <code>1</code> = 1%)</li>
<li><code>maxPositionPercentage</code>: Optional cap on position size</li>
<li><code>minPositionSize</code> / <code>maxPositionSize</code>: Optional absolute constraints</li>
</ul>
<p><strong>Example:</strong></p>
<pre><code><span class="hl-10">Account</span><span class="hl-1">: </span><span class="hl-4">$10</span><span class="hl-1">,</span><span class="hl-6">000</span><br/><span class="hl-10">Risk</span><span class="hl-1">: </span><span class="hl-6">1</span><span class="hl-1">%</span><br/><span class="hl-10">Entry</span><span class="hl-1">: </span><span class="hl-4">$50</span><span class="hl-1">,</span><span class="hl-6">000</span><br/><span class="hl-4">Stop</span><span class="hl-1"> </span><span class="hl-10">Loss</span><span class="hl-1">: </span><span class="hl-4">$49</span><span class="hl-1">,</span><span class="hl-6">000</span><br/><span class="hl-4">Position</span><span class="hl-1"> </span><span class="hl-4">Size</span><span class="hl-1"> = (</span><span class="hl-4">$10</span><span class="hl-1">,</span><span class="hl-6">000</span><span class="hl-1"> × </span><span class="hl-6">0.01</span><span class="hl-1">) / (</span><span class="hl-4">$50</span><span class="hl-1">,</span><span class="hl-6">000</span><span class="hl-1"> - </span><span class="hl-4">$49</span><span class="hl-1">,</span><span class="hl-6">000</span><span class="hl-1">) = </span><span class="hl-6">0.1</span><span class="hl-1"> </span><span class="hl-8">BTC</span>
</code><button>Copy</button></pre>

<a id="kelly-criterion-sizing" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Kelly Criterion Sizing<a href="#kelly-criterion-sizing" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Calculates optimal position size based on historical win rate and risk/reward ratio. Uses a multiplier (typically 0.25 for quarter-Kelly) to reduce variance.</p>
<p><strong>Formula:</strong></p>
<pre><code><span class="hl-4">Kelly</span><span class="hl-1"> % = (</span><span class="hl-4">Win</span><span class="hl-1"> </span><span class="hl-4">Rate</span><span class="hl-1"> × </span><span class="hl-4">Win</span><span class="hl-1"> </span><span class="hl-4">Size</span><span class="hl-1"> - </span><span class="hl-4">Loss</span><span class="hl-1"> </span><span class="hl-4">Rate</span><span class="hl-1"> × </span><span class="hl-4">Loss</span><span class="hl-1"> </span><span class="hl-4">Size</span><span class="hl-1">) / </span><span class="hl-4">Win</span><span class="hl-1"> </span><span class="hl-4">Size</span><br/><span class="hl-4">Position</span><span class="hl-1"> </span><span class="hl-4">Size</span><span class="hl-1"> = </span><span class="hl-4">Account</span><span class="hl-1"> </span><span class="hl-4">Balance</span><span class="hl-1"> × </span><span class="hl-4">Kelly</span><span class="hl-1"> % × </span><span class="hl-4">Kelly</span><span class="hl-1"> </span><span class="hl-4">Multiplier</span>
</code><button>Copy</button></pre>

<p><strong>Parameters:</strong></p>
<ul>
<li><code>kellyMultiplier</code>: Conservative multiplier (default: <code>0.25</code> for quarter-Kelly)</li>
<li><code>maxPositionPercentage</code>: Optional cap on position size</li>
<li><code>minPositionSize</code> / <code>maxPositionSize</code>: Optional absolute constraints</li>
</ul>
<p><strong>Calculation requires:</strong></p>
<ul>
<li><code>winRate</code>: Historical win rate (0.0-1.0)</li>
<li><code>averageWin</code>: Average win size multiplier</li>
<li><code>averageLoss</code>: Average loss size multiplier</li>
</ul>
<p><strong>Example:</strong></p>
<pre><code><span class="hl-10">Account</span><span class="hl-1">: </span><span class="hl-4">$10</span><span class="hl-1">,</span><span class="hl-6">000</span><br/><span class="hl-4">Win</span><span class="hl-1"> </span><span class="hl-10">Rate</span><span class="hl-1">: </span><span class="hl-6">60</span><span class="hl-1">% (</span><span class="hl-6">0.6</span><span class="hl-1">)</span><br/><span class="hl-4">Average</span><span class="hl-1"> </span><span class="hl-10">Win</span><span class="hl-1">: 1.5</span><span class="hl-4">x</span><br/><span class="hl-4">Average</span><span class="hl-1"> </span><span class="hl-10">Loss</span><span class="hl-1">: 1.0</span><span class="hl-4">x</span><br/><span class="hl-4">Kelly</span><span class="hl-1"> </span><span class="hl-10">Multiplier</span><span class="hl-1">: </span><span class="hl-6">0.25</span><span class="hl-1"> (</span><span class="hl-4">quarter</span><span class="hl-1">-</span><span class="hl-4">Kelly</span><span class="hl-1">)</span><br/><br/><span class="hl-4">Kelly</span><span class="hl-1"> % = (</span><span class="hl-6">0.6</span><span class="hl-1"> × </span><span class="hl-6">1.5</span><span class="hl-1"> - </span><span class="hl-6">0.4</span><span class="hl-1"> × </span><span class="hl-6">1.0</span><span class="hl-1">) / </span><span class="hl-6">1.5</span><span class="hl-1"> = </span><span class="hl-6">0.333</span><br/><span class="hl-4">Position</span><span class="hl-1"> = </span><span class="hl-4">$10</span><span class="hl-1">,</span><span class="hl-6">000</span><span class="hl-1"> × </span><span class="hl-6">0.333</span><span class="hl-1"> × </span><span class="hl-6">0.25</span><span class="hl-1"> = </span><span class="hl-4">$833</span>
</code><button>Copy</button></pre>

<a id="atr-based-sizing" class="tsd-anchor"></a><h3 class="tsd-anchor-link">ATR-Based Sizing<a href="#atr-based-sizing" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Sizes positions based on Average True Range (volatility indicator). Higher volatility results in smaller positions, lower volatility in larger positions.</p>
<p><strong>Formula:</strong></p>
<pre><code><span class="hl-4">Position</span><span class="hl-1"> </span><span class="hl-4">Size</span><span class="hl-1"> = (</span><span class="hl-4">Account</span><span class="hl-1"> </span><span class="hl-4">Balance</span><span class="hl-1"> × </span><span class="hl-4">Risk</span><span class="hl-1"> %) / (</span><span class="hl-8">ATR</span><span class="hl-1"> × </span><span class="hl-8">ATR</span><span class="hl-1"> </span><span class="hl-4">Multiplier</span><span class="hl-1">)</span>
</code><button>Copy</button></pre>

<p><strong>Parameters:</strong></p>
<ul>
<li><code>riskPercentage</code>: Percentage of account to risk per trade</li>
<li><code>atrMultiplier</code>: Stop loss distance in ATRs (default: <code>2</code>)</li>
<li><code>maxPositionPercentage</code>: Optional cap on position size</li>
<li><code>minPositionSize</code> / <code>maxPositionSize</code>: Optional absolute constraints</li>
</ul>
<p><strong>Example:</strong></p>
<pre><code><span class="hl-10">Account</span><span class="hl-1">: </span><span class="hl-4">$10</span><span class="hl-1">,</span><span class="hl-6">000</span><br/><span class="hl-10">Risk</span><span class="hl-1">: </span><span class="hl-6">2</span><span class="hl-1">%</span><br/><span class="hl-10">ATR</span><span class="hl-1">: </span><span class="hl-4">$500</span><br/><span class="hl-8">ATR</span><span class="hl-1"> </span><span class="hl-10">Multiplier</span><span class="hl-1">: </span><span class="hl-6">2</span><span class="hl-1">× (</span><span class="hl-4">stop</span><span class="hl-1"> </span><span class="hl-4">loss</span><span class="hl-1"> </span><span class="hl-4">at</span><span class="hl-1"> </span><span class="hl-6">2</span><span class="hl-1">× </span><span class="hl-8">ATR</span><span class="hl-1">)</span><br/><br/><span class="hl-4">Position</span><span class="hl-1"> </span><span class="hl-4">Size</span><span class="hl-1"> = (</span><span class="hl-4">$10</span><span class="hl-1">,</span><span class="hl-6">000</span><span class="hl-1"> × </span><span class="hl-6">0.02</span><span class="hl-1">) / (</span><span class="hl-4">$500</span><span class="hl-1"> × </span><span class="hl-6">2</span><span class="hl-1">) = </span><span class="hl-6">0.2</span><span class="hl-1"> </span><span class="hl-8">BTC</span>
</code><button>Copy</button></pre>

<hr>
<a id="schema-definition-and-registration" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Schema Definition and Registration<a href="#schema-definition-and-registration" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><a id="isizingschema-discriminated-union" class="tsd-anchor"></a><h3 class="tsd-anchor-link">ISizingSchema Discriminated Union<a href="#isizingschema-discriminated-union" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>The sizing schema uses a discriminated union based on the <code>method</code> field. TypeScript enforces type safety, ensuring only valid parameters are provided for each method.</p>
<p><img src="../media/15-position-sizing_0.svg" alt="Mermaid Diagram"></p>
<a id="registration-with-addsizing" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Registration with addSizing()<a href="#registration-with-addsizing" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Sizing configurations are registered via <code>addSizing()</code>, which validates the schema and stores it in <code>SizingSchemaService</code>.</p>
<p><strong>Function Signature:</strong></p>
<pre><code class="typescript"><span class="hl-7">function</span><span class="hl-1"> </span><span class="hl-0">addSizing</span><span class="hl-1">(</span><span class="hl-4">sizingSchema</span><span class="hl-1">: </span><span class="hl-13">ISizingSchema</span><span class="hl-1">): </span><span class="hl-13">void</span>
</code><button type="button">Copy</button></pre>

<p><strong>Validation Steps:</strong></p>
<ol>
<li><code>SizingValidationService.addSizing()</code> validates schema structure</li>
<li><code>SizingSchemaService.register()</code> stores configuration for retrieval</li>
</ol>
<p><strong>Example Registrations:</strong></p>
<pre><code class="typescript"><span class="hl-5">// Fixed percentage: Risk 1% per trade</span><br/><span class="hl-0">addSizing</span><span class="hl-1">({</span><br/><span class="hl-1">  </span><span class="hl-4">sizingName:</span><span class="hl-1"> </span><span class="hl-2">&quot;conservative&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">method:</span><span class="hl-1"> </span><span class="hl-2">&quot;fixed-percentage&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">riskPercentage:</span><span class="hl-1"> </span><span class="hl-6">1</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">maxPositionPercentage:</span><span class="hl-1"> </span><span class="hl-6">10</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">minPositionSize:</span><span class="hl-1"> </span><span class="hl-6">0.001</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">callbacks:</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-0">onCalculate</span><span class="hl-4">:</span><span class="hl-1"> (</span><span class="hl-4">quantity</span><span class="hl-1">, </span><span class="hl-4">params</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">      </span><span class="hl-4">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-2">`Conservative sizing: </span><span class="hl-7">${</span><span class="hl-4">quantity</span><span class="hl-7">}</span><span class="hl-2">`</span><span class="hl-1">);</span><br/><span class="hl-1">    }</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">});</span><br/><br/><span class="hl-5">// Kelly Criterion: Quarter-Kelly with 20% max position</span><br/><span class="hl-0">addSizing</span><span class="hl-1">({</span><br/><span class="hl-1">  </span><span class="hl-4">sizingName:</span><span class="hl-1"> </span><span class="hl-2">&quot;kelly-optimal&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">method:</span><span class="hl-1"> </span><span class="hl-2">&quot;kelly-criterion&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">kellyMultiplier:</span><span class="hl-1"> </span><span class="hl-6">0.25</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">maxPositionPercentage:</span><span class="hl-1"> </span><span class="hl-6">20</span><span class="hl-1">,</span><br/><span class="hl-1">});</span><br/><br/><span class="hl-5">// ATR-based: 2% risk with 2× ATR stop</span><br/><span class="hl-0">addSizing</span><span class="hl-1">({</span><br/><span class="hl-1">  </span><span class="hl-4">sizingName:</span><span class="hl-1"> </span><span class="hl-2">&quot;atr-dynamic&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">method:</span><span class="hl-1"> </span><span class="hl-2">&quot;atr-based&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">riskPercentage:</span><span class="hl-1"> </span><span class="hl-6">2</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">atrMultiplier:</span><span class="hl-1"> </span><span class="hl-6">2</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">maxPositionSize:</span><span class="hl-1"> </span><span class="hl-6">1.0</span><span class="hl-1">,</span><br/><span class="hl-1">});</span>
</code><button type="button">Copy</button></pre>

<hr>
<a id="calculation-parameters" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Calculation Parameters<a href="#calculation-parameters" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><a id="isizingcalculateparams" class="tsd-anchor"></a><h3 class="tsd-anchor-link">ISizingCalculateParams<a href="#isizingcalculateparams" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>The <code>calculate()</code> method accepts <code>ISizingCalculateParams</code>, which contains:</p>
<ul>
<li><code>symbol</code>: Trading pair (e.g., <code>&quot;BTCUSDT&quot;</code>)</li>
<li><code>accountBalance</code>: Current account balance in quote currency</li>
<li><code>params</code>: Method-specific parameters (discriminated union)</li>
</ul>
<a id="method-specific-parameters" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Method-Specific Parameters<a href="#method-specific-parameters" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Each sizing method requires different calculation inputs:</p>
<a id="fixed-percentage-parameters" class="tsd-anchor"></a><h4 class="tsd-anchor-link">Fixed Percentage Parameters<a href="#fixed-percentage-parameters" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><pre><code class="typescript"><span class="hl-7">interface</span><span class="hl-1"> </span><span class="hl-13">ISizingCalculateParamsFixedPercentage</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-4">method</span><span class="hl-1">: </span><span class="hl-2">&quot;fixed-percentage&quot;</span><span class="hl-1">;</span><br/><span class="hl-1">  </span><span class="hl-4">entryPrice</span><span class="hl-1">: </span><span class="hl-13">number</span><span class="hl-1">;      </span><span class="hl-5">// Entry price for position</span><br/><span class="hl-1">  </span><span class="hl-4">stopLossPrice</span><span class="hl-1">: </span><span class="hl-13">number</span><span class="hl-1">;   </span><span class="hl-5">// Stop loss price</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<p><strong>Used for:</strong> Risk-per-trade calculation based on price distance</p>
<a id="kelly-criterion-parameters" class="tsd-anchor"></a><h4 class="tsd-anchor-link">Kelly Criterion Parameters<a href="#kelly-criterion-parameters" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><pre><code class="typescript"><span class="hl-7">interface</span><span class="hl-1"> </span><span class="hl-13">ISizingCalculateParamsKelly</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-4">method</span><span class="hl-1">: </span><span class="hl-2">&quot;kelly-criterion&quot;</span><span class="hl-1">;</span><br/><span class="hl-1">  </span><span class="hl-4">winRate</span><span class="hl-1">: </span><span class="hl-13">number</span><span class="hl-1">;         </span><span class="hl-5">// Historical win rate (0.0-1.0)</span><br/><span class="hl-1">  </span><span class="hl-4">averageWin</span><span class="hl-1">: </span><span class="hl-13">number</span><span class="hl-1">;      </span><span class="hl-5">// Average win multiplier</span><br/><span class="hl-1">  </span><span class="hl-4">averageLoss</span><span class="hl-1">: </span><span class="hl-13">number</span><span class="hl-1">;     </span><span class="hl-5">// Average loss multiplier</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<p><strong>Used for:</strong> Statistical edge-based sizing</p>
<a id="atr-based-parameters" class="tsd-anchor"></a><h4 class="tsd-anchor-link">ATR-Based Parameters<a href="#atr-based-parameters" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><pre><code class="typescript"><span class="hl-7">interface</span><span class="hl-1"> </span><span class="hl-13">ISizingCalculateParamsATR</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-4">method</span><span class="hl-1">: </span><span class="hl-2">&quot;atr-based&quot;</span><span class="hl-1">;</span><br/><span class="hl-1">  </span><span class="hl-4">atr</span><span class="hl-1">: </span><span class="hl-13">number</span><span class="hl-1">;             </span><span class="hl-5">// Current Average True Range</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<p><strong>Used for:</strong> Volatility-adjusted sizing</p>
<hr>
<a id="service-architecture" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Service Architecture<a href="#service-architecture" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><a id="position-sizing-service-dependencies" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Position Sizing Service Dependencies<a href="#position-sizing-service-dependencies" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><img src="../media/15-position-sizing_1.svg" alt="Mermaid Diagram"></p>
<a id="memoization-in-sizingconnectionservice" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Memoization in SizingConnectionService<a href="#memoization-in-sizingconnectionservice" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><code>SizingConnectionService</code> caches <code>ClientSizing</code> instances by <code>sizingName</code> to avoid redundant instantiation:</p>
<p><strong>Memoization Key:</strong></p>
<pre><code><span class="hl-0">sizingName</span><span class="hl-1"> (</span><span class="hl-4">e</span><span class="hl-1">.</span><span class="hl-4">g</span><span class="hl-1">., </span><span class="hl-2">&quot;conservative&quot;</span><span class="hl-1">, </span><span class="hl-2">&quot;kelly-optimal&quot;</span><span class="hl-1">)</span>
</code><button>Copy</button></pre>

<p><strong>Cache Behavior:</strong></p>
<ul>
<li>First call creates new <code>ClientSizing</code> instance</li>
<li>Subsequent calls with same <code>sizingName</code> return cached instance</li>
<li>Each instance reads configuration from <code>SizingSchemaService</code></li>
</ul>
<hr>
<a id="calculation-flow" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Calculation Flow<a href="#calculation-flow" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><a id="position-size-calculation-sequence" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Position Size Calculation Sequence<a href="#position-size-calculation-sequence" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><img src="../media/15-position-sizing_2.svg" alt="Mermaid Diagram"></p>
<a id="constraint-application" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Constraint Application<a href="#constraint-application" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>After calculating the base position size, <code>ClientSizing</code> applies constraints in this order:</p>
<ol>
<li>
<p><strong>Max Position Percentage:</strong></p>
<pre><code class="typescript"><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-4">maxPositionPercentage</span><span class="hl-1">) {</span><br/><span class="hl-1">  </span><span class="hl-4">maxAllowed</span><span class="hl-1"> = </span><span class="hl-4">accountBalance</span><span class="hl-1"> * (</span><span class="hl-4">maxPositionPercentage</span><span class="hl-1"> / </span><span class="hl-6">100</span><span class="hl-1">);</span><br/><span class="hl-1">  </span><span class="hl-4">quantity</span><span class="hl-1"> = </span><span class="hl-4">Math</span><span class="hl-1">.</span><span class="hl-0">min</span><span class="hl-1">(</span><span class="hl-4">quantity</span><span class="hl-1">, </span><span class="hl-4">maxAllowed</span><span class="hl-1">);</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

</li>
<li>
<p><strong>Min Position Size:</strong></p>
<pre><code class="typescript"><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-4">minPositionSize</span><span class="hl-1"> &amp;&amp; </span><span class="hl-4">quantity</span><span class="hl-1"> &lt; </span><span class="hl-4">minPositionSize</span><span class="hl-1">) {</span><br/><span class="hl-1">  </span><span class="hl-4">quantity</span><span class="hl-1"> = </span><span class="hl-4">minPositionSize</span><span class="hl-1">;</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

</li>
<li>
<p><strong>Max Position Size:</strong></p>
<pre><code class="typescript"><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-4">maxPositionSize</span><span class="hl-1"> &amp;&amp; </span><span class="hl-4">quantity</span><span class="hl-1"> &gt; </span><span class="hl-4">maxPositionSize</span><span class="hl-1">) {</span><br/><span class="hl-1">  </span><span class="hl-4">quantity</span><span class="hl-1"> = </span><span class="hl-4">maxPositionSize</span><span class="hl-1">;</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

</li>
</ol>
<hr>
<a id="integration-with-strategy-system" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Integration with Strategy System<a href="#integration-with-strategy-system" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><a id="strategy-schema-configuration" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Strategy Schema Configuration<a href="#strategy-schema-configuration" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Strategies can optionally reference a sizing configuration:</p>
<pre><code class="typescript"><span class="hl-7">interface</span><span class="hl-1"> </span><span class="hl-13">IStrategySchema</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-4">strategyName</span><span class="hl-1">: </span><span class="hl-13">StrategyName</span><span class="hl-1">;</span><br/><span class="hl-1">  </span><span class="hl-4">interval</span><span class="hl-1">: </span><span class="hl-13">SignalInterval</span><span class="hl-1">;</span><br/><span class="hl-1">  </span><span class="hl-0">getSignal</span><span class="hl-1">: (</span><span class="hl-4">symbol</span><span class="hl-1">: </span><span class="hl-13">string</span><span class="hl-1">, </span><span class="hl-4">when</span><span class="hl-1">: </span><span class="hl-13">Date</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> </span><span class="hl-13">Promise</span><span class="hl-1">&lt;</span><span class="hl-13">ISignalDto</span><span class="hl-1"> | </span><span class="hl-13">null</span><span class="hl-1">&gt;;</span><br/><span class="hl-1">  </span><br/><span class="hl-1">  </span><span class="hl-5">// Optional sizing configuration</span><br/><span class="hl-1">  </span><span class="hl-4">sizingName</span><span class="hl-1">?: </span><span class="hl-13">SizingName</span><span class="hl-1">;</span><br/><span class="hl-1">  </span><br/><span class="hl-1">  </span><span class="hl-5">// Alternative: multiple sizing configs</span><br/><span class="hl-1">  </span><span class="hl-4">sizingList</span><span class="hl-1">?: </span><span class="hl-13">SizingName</span><span class="hl-1">[];</span><br/><span class="hl-1">  </span><br/><span class="hl-1">  </span><span class="hl-5">// Other fields...</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<p><strong>Usage Pattern:</strong></p>
<ul>
<li>If <code>sizingName</code> is specified, strategy uses that sizing config</li>
<li>If <code>sizingList</code> is specified, strategy can select from multiple configs</li>
<li>If neither specified, strategy must calculate position size manually</li>
</ul>
<a id="position-size-calculation-in-strategy" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Position Size Calculation in Strategy<a href="#position-size-calculation-in-strategy" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Strategies typically calculate position size during signal generation or validation:</p>
<pre><code class="typescript"><span class="hl-5">// In getSignal callback</span><br/><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">sizing</span><span class="hl-1"> = </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-4">PositionSize</span><span class="hl-1">.</span><span class="hl-0">calculate</span><span class="hl-1">(</span><br/><span class="hl-1">  </span><span class="hl-4">symbol</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-2">&quot;conservative&quot;</span><span class="hl-1">, </span><span class="hl-5">// sizingName</span><br/><span class="hl-1">  </span><span class="hl-4">accountBalance</span><span class="hl-1">,</span><br/><span class="hl-1">  {</span><br/><span class="hl-1">    </span><span class="hl-4">method:</span><span class="hl-1"> </span><span class="hl-2">&quot;fixed-percentage&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-4">entryPrice:</span><span class="hl-1"> </span><span class="hl-6">50000</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-4">stopLossPrice:</span><span class="hl-1"> </span><span class="hl-6">49000</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">);</span><br/><br/><span class="hl-5">// Return signal with calculated quantity</span><br/><span class="hl-3">return</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-4">position:</span><span class="hl-1"> </span><span class="hl-2">&quot;long&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">priceOpen:</span><span class="hl-1"> </span><span class="hl-6">50000</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">priceTakeProfit:</span><span class="hl-1"> </span><span class="hl-6">51000</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">priceStopLoss:</span><span class="hl-1"> </span><span class="hl-6">49000</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">minuteEstimatedTime:</span><span class="hl-1"> </span><span class="hl-6">60</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">quantity:</span><span class="hl-1"> </span><span class="hl-4">sizing</span><span class="hl-1">  </span><span class="hl-5">// Use calculated quantity</span><br/><span class="hl-1">};</span>
</code><button type="button">Copy</button></pre>

<hr>
<a id="positionsize-class-api" class="tsd-anchor"></a><h2 class="tsd-anchor-link">PositionSize Class API<a href="#positionsize-class-api" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><a id="public-methods" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Public Methods<a href="#public-methods" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>The <code>PositionSize</code> class provides a high-level API for position size calculation:</p>
<p><strong>Method Signature:</strong></p>
<pre><code class="typescript"><span class="hl-7">class</span><span class="hl-1"> </span><span class="hl-13">PositionSize</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-7">static</span><span class="hl-1"> </span><span class="hl-0">calculate</span><span class="hl-1">(</span><br/><span class="hl-1">    </span><span class="hl-4">symbol</span><span class="hl-1">: </span><span class="hl-13">string</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-4">sizingName</span><span class="hl-1">: </span><span class="hl-13">SizingName</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-4">accountBalance</span><span class="hl-1">: </span><span class="hl-13">number</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-4">params</span><span class="hl-1">: </span><span class="hl-13">ISizingCalculateParamsFixedPercentage</span><span class="hl-1"> | </span><br/><span class="hl-1">           </span><span class="hl-13">ISizingCalculateParamsKelly</span><span class="hl-1"> | </span><br/><span class="hl-1">           </span><span class="hl-13">ISizingCalculateParamsATR</span><br/><span class="hl-1">  ): </span><span class="hl-13">Promise</span><span class="hl-1">&lt;</span><span class="hl-13">number</span><span class="hl-1">&gt;</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<p><strong>Parameters:</strong></p>
<ul>
<li><code>symbol</code>: Trading pair (e.g., <code>&quot;BTCUSDT&quot;</code>)</li>
<li><code>sizingName</code>: Registered sizing configuration name</li>
<li><code>accountBalance</code>: Current account balance in quote currency</li>
<li><code>params</code>: Method-specific calculation parameters</li>
</ul>
<p><strong>Returns:</strong> Calculated position size in base currency units</p>
<p><strong>Example Usage:</strong></p>
<pre><code class="typescript"><span class="hl-3">import</span><span class="hl-1"> { </span><span class="hl-4">PositionSize</span><span class="hl-1">, </span><span class="hl-4">addSizing</span><span class="hl-1"> } </span><span class="hl-3">from</span><span class="hl-1"> </span><span class="hl-2">&quot;backtest-kit&quot;</span><span class="hl-1">;</span><br/><br/><span class="hl-5">// Register sizing configuration</span><br/><span class="hl-0">addSizing</span><span class="hl-1">({</span><br/><span class="hl-1">  </span><span class="hl-4">sizingName:</span><span class="hl-1"> </span><span class="hl-2">&quot;my-sizing&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">method:</span><span class="hl-1"> </span><span class="hl-2">&quot;fixed-percentage&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">riskPercentage:</span><span class="hl-1"> </span><span class="hl-6">1</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">maxPositionPercentage:</span><span class="hl-1"> </span><span class="hl-6">10</span><br/><span class="hl-1">});</span><br/><br/><span class="hl-5">// Calculate position size</span><br/><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">quantity</span><span class="hl-1"> = </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-4">PositionSize</span><span class="hl-1">.</span><span class="hl-0">calculate</span><span class="hl-1">(</span><br/><span class="hl-1">  </span><span class="hl-2">&quot;BTCUSDT&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-2">&quot;my-sizing&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-6">10000</span><span class="hl-1">, </span><span class="hl-5">// $10,000 account</span><br/><span class="hl-1">  {</span><br/><span class="hl-1">    </span><span class="hl-4">method:</span><span class="hl-1"> </span><span class="hl-2">&quot;fixed-percentage&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-4">entryPrice:</span><span class="hl-1"> </span><span class="hl-6">50000</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-4">stopLossPrice:</span><span class="hl-1"> </span><span class="hl-6">49000</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">);</span><br/><br/><span class="hl-4">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-2">`Position size: </span><span class="hl-7">${</span><span class="hl-4">quantity</span><span class="hl-7">}</span><span class="hl-2"> BTC`</span><span class="hl-1">);</span><br/><span class="hl-5">// Position size: 0.1 BTC</span>
</code><button type="button">Copy</button></pre>

<hr>
<a id="complete-example" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Complete Example<a href="#complete-example" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><a id="full-position-sizing-configuration" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Full Position Sizing Configuration<a href="#full-position-sizing-configuration" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><pre><code class="typescript"><span class="hl-3">import</span><span class="hl-1"> { </span><br/><span class="hl-1">  </span><span class="hl-4">addSizing</span><span class="hl-1">, </span><br/><span class="hl-1">  </span><span class="hl-4">addStrategy</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">PositionSize</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">ISizingCalculateParams</span><span class="hl-1"> </span><br/><span class="hl-1">} </span><span class="hl-3">from</span><span class="hl-1"> </span><span class="hl-2">&quot;backtest-kit&quot;</span><span class="hl-1">;</span><br/><br/><span class="hl-5">// 1. Register multiple sizing configurations</span><br/><span class="hl-0">addSizing</span><span class="hl-1">({</span><br/><span class="hl-1">  </span><span class="hl-4">sizingName:</span><span class="hl-1"> </span><span class="hl-2">&quot;conservative&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">method:</span><span class="hl-1"> </span><span class="hl-2">&quot;fixed-percentage&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">riskPercentage:</span><span class="hl-1"> </span><span class="hl-6">1</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">maxPositionPercentage:</span><span class="hl-1"> </span><span class="hl-6">5</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">minPositionSize:</span><span class="hl-1"> </span><span class="hl-6">0.001</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">callbacks:</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-0">onCalculate</span><span class="hl-4">:</span><span class="hl-1"> (</span><span class="hl-4">quantity</span><span class="hl-1">, </span><span class="hl-4">params</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">      </span><span class="hl-4">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-2">`[Conservative] Size: </span><span class="hl-7">${</span><span class="hl-4">quantity</span><span class="hl-7">}</span><span class="hl-2"> for </span><span class="hl-7">${</span><span class="hl-4">params</span><span class="hl-9">.</span><span class="hl-4">symbol</span><span class="hl-7">}</span><span class="hl-2">`</span><span class="hl-1">);</span><br/><span class="hl-1">    }</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">});</span><br/><br/><span class="hl-0">addSizing</span><span class="hl-1">({</span><br/><span class="hl-1">  </span><span class="hl-4">sizingName:</span><span class="hl-1"> </span><span class="hl-2">&quot;aggressive-kelly&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">method:</span><span class="hl-1"> </span><span class="hl-2">&quot;kelly-criterion&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">kellyMultiplier:</span><span class="hl-1"> </span><span class="hl-6">0.5</span><span class="hl-1">, </span><span class="hl-5">// Half-Kelly (more aggressive than quarter-Kelly)</span><br/><span class="hl-1">  </span><span class="hl-4">maxPositionPercentage:</span><span class="hl-1"> </span><span class="hl-6">25</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">callbacks:</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-0">onCalculate</span><span class="hl-4">:</span><span class="hl-1"> (</span><span class="hl-4">quantity</span><span class="hl-1">, </span><span class="hl-4">params</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">      </span><span class="hl-4">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-2">`[Kelly] Size: </span><span class="hl-7">${</span><span class="hl-4">quantity</span><span class="hl-7">}</span><span class="hl-2">`</span><span class="hl-1">);</span><br/><span class="hl-1">    }</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">});</span><br/><br/><span class="hl-0">addSizing</span><span class="hl-1">({</span><br/><span class="hl-1">  </span><span class="hl-4">sizingName:</span><span class="hl-1"> </span><span class="hl-2">&quot;volatility-adjusted&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">method:</span><span class="hl-1"> </span><span class="hl-2">&quot;atr-based&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">riskPercentage:</span><span class="hl-1"> </span><span class="hl-6">2</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">atrMultiplier:</span><span class="hl-1"> </span><span class="hl-6">1.5</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">maxPositionSize:</span><span class="hl-1"> </span><span class="hl-6">0.5</span><span class="hl-1">,</span><br/><span class="hl-1">});</span><br/><br/><span class="hl-5">// 2. Use in strategy</span><br/><span class="hl-0">addStrategy</span><span class="hl-1">({</span><br/><span class="hl-1">  </span><span class="hl-4">strategyName:</span><span class="hl-1"> </span><span class="hl-2">&quot;my-strategy&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">interval:</span><span class="hl-1"> </span><span class="hl-2">&quot;5m&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">sizingName:</span><span class="hl-1"> </span><span class="hl-2">&quot;conservative&quot;</span><span class="hl-1">, </span><span class="hl-5">// Reference sizing config</span><br/><span class="hl-1">  </span><br/><span class="hl-1">  </span><span class="hl-0">getSignal</span><span class="hl-4">:</span><span class="hl-1"> </span><span class="hl-7">async</span><span class="hl-1"> (</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">when</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-5">// Fetch data for decision making</span><br/><span class="hl-1">    </span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">candles</span><span class="hl-1"> = </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-0">getCandles</span><span class="hl-1">(</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-2">&quot;1h&quot;</span><span class="hl-1">, </span><span class="hl-6">100</span><span class="hl-1">);</span><br/><span class="hl-1">    </span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">atr</span><span class="hl-1"> = </span><span class="hl-0">calculateATR</span><span class="hl-1">(</span><span class="hl-4">candles</span><span class="hl-1">);</span><br/><span class="hl-1">    </span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">entryPrice</span><span class="hl-1"> = </span><span class="hl-4">candles</span><span class="hl-1">[</span><span class="hl-4">candles</span><span class="hl-1">.</span><span class="hl-4">length</span><span class="hl-1"> - </span><span class="hl-6">1</span><span class="hl-1">].</span><span class="hl-4">close</span><span class="hl-1">;</span><br/><span class="hl-1">    </span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">stopLossPrice</span><span class="hl-1"> = </span><span class="hl-4">entryPrice</span><span class="hl-1"> - (</span><span class="hl-4">atr</span><span class="hl-1"> * </span><span class="hl-6">2</span><span class="hl-1">);</span><br/><span class="hl-1">    </span><br/><span class="hl-1">    </span><span class="hl-5">// Calculate position size</span><br/><span class="hl-1">    </span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">accountBalance</span><span class="hl-1"> = </span><span class="hl-6">10000</span><span class="hl-1">;</span><br/><span class="hl-1">    </span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">quantity</span><span class="hl-1"> = </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-4">PositionSize</span><span class="hl-1">.</span><span class="hl-0">calculate</span><span class="hl-1">(</span><br/><span class="hl-1">      </span><span class="hl-4">symbol</span><span class="hl-1">,</span><br/><span class="hl-1">      </span><span class="hl-2">&quot;conservative&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">      </span><span class="hl-4">accountBalance</span><span class="hl-1">,</span><br/><span class="hl-1">      {</span><br/><span class="hl-1">        </span><span class="hl-4">method:</span><span class="hl-1"> </span><span class="hl-2">&quot;fixed-percentage&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">        </span><span class="hl-4">entryPrice</span><span class="hl-1">,</span><br/><span class="hl-1">        </span><span class="hl-4">stopLossPrice</span><br/><span class="hl-1">      }</span><br/><span class="hl-1">    );</span><br/><span class="hl-1">    </span><br/><span class="hl-1">    </span><span class="hl-5">// Generate signal with calculated size</span><br/><span class="hl-1">    </span><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-0">shouldEnterLong</span><span class="hl-1">(</span><span class="hl-4">candles</span><span class="hl-1">)) {</span><br/><span class="hl-1">      </span><span class="hl-3">return</span><span class="hl-1"> {</span><br/><span class="hl-1">        </span><span class="hl-4">position:</span><span class="hl-1"> </span><span class="hl-2">&quot;long&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">        </span><span class="hl-4">priceOpen:</span><span class="hl-1"> </span><span class="hl-4">entryPrice</span><span class="hl-1">,</span><br/><span class="hl-1">        </span><span class="hl-4">priceTakeProfit:</span><span class="hl-1"> </span><span class="hl-4">entryPrice</span><span class="hl-1"> + (</span><span class="hl-4">atr</span><span class="hl-1"> * </span><span class="hl-6">3</span><span class="hl-1">),</span><br/><span class="hl-1">        </span><span class="hl-4">priceStopLoss:</span><span class="hl-1"> </span><span class="hl-4">stopLossPrice</span><span class="hl-1">,</span><br/><span class="hl-1">        </span><span class="hl-4">minuteEstimatedTime:</span><span class="hl-1"> </span><span class="hl-6">60</span><span class="hl-1">,</span><br/><span class="hl-1">        </span><span class="hl-4">quantity</span><span class="hl-1">, </span><span class="hl-5">// Use calculated quantity</span><br/><span class="hl-1">        </span><span class="hl-4">note:</span><span class="hl-1"> </span><span class="hl-2">`ATR: </span><span class="hl-7">${</span><span class="hl-4">atr</span><span class="hl-7">}</span><span class="hl-2">, Quantity: </span><span class="hl-7">${</span><span class="hl-4">quantity</span><span class="hl-7">}</span><span class="hl-2">`</span><br/><span class="hl-1">      };</span><br/><span class="hl-1">    }</span><br/><span class="hl-1">    </span><br/><span class="hl-1">    </span><span class="hl-3">return</span><span class="hl-1"> </span><span class="hl-7">null</span><span class="hl-1">;</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">});</span><br/><br/><span class="hl-5">// 3. Alternative: Calculate at runtime without strategy reference</span><br/><span class="hl-7">async</span><span class="hl-1"> </span><span class="hl-7">function</span><span class="hl-1"> </span><span class="hl-0">calculatePositionForTrade</span><span class="hl-1">(</span><br/><span class="hl-1">  </span><span class="hl-4">symbol</span><span class="hl-1">: </span><span class="hl-13">string</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">accountBalance</span><span class="hl-1">: </span><span class="hl-13">number</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">historicalStats</span><span class="hl-1">: { </span><span class="hl-4">winRate</span><span class="hl-1">: </span><span class="hl-13">number</span><span class="hl-1">, </span><span class="hl-4">avgWin</span><span class="hl-1">: </span><span class="hl-13">number</span><span class="hl-1">, </span><span class="hl-4">avgLoss</span><span class="hl-1">: </span><span class="hl-13">number</span><span class="hl-1"> }</span><br/><span class="hl-1">) {</span><br/><span class="hl-1">  </span><span class="hl-5">// Use Kelly Criterion for sizing</span><br/><span class="hl-1">  </span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">quantity</span><span class="hl-1"> = </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-4">PositionSize</span><span class="hl-1">.</span><span class="hl-0">calculate</span><span class="hl-1">(</span><br/><span class="hl-1">    </span><span class="hl-4">symbol</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-2">&quot;aggressive-kelly&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-4">accountBalance</span><span class="hl-1">,</span><br/><span class="hl-1">    {</span><br/><span class="hl-1">      </span><span class="hl-4">method:</span><span class="hl-1"> </span><span class="hl-2">&quot;kelly-criterion&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">      </span><span class="hl-4">winRate:</span><span class="hl-1"> </span><span class="hl-4">historicalStats</span><span class="hl-1">.</span><span class="hl-4">winRate</span><span class="hl-1">,</span><br/><span class="hl-1">      </span><span class="hl-4">averageWin:</span><span class="hl-1"> </span><span class="hl-4">historicalStats</span><span class="hl-1">.</span><span class="hl-4">avgWin</span><span class="hl-1">,</span><br/><span class="hl-1">      </span><span class="hl-4">averageLoss:</span><span class="hl-1"> </span><span class="hl-4">historicalStats</span><span class="hl-1">.</span><span class="hl-4">avgLoss</span><br/><span class="hl-1">    }</span><br/><span class="hl-1">  );</span><br/><span class="hl-1">  </span><br/><span class="hl-1">  </span><span class="hl-3">return</span><span class="hl-1"> </span><span class="hl-4">quantity</span><span class="hl-1">;</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<hr>
<a id="summary" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Summary<a href="#summary" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>The position sizing system provides three calculation methods through a discriminated union interface:</p>
<table>
<thead>
<tr>
<th>Component</th>
<th>Purpose</th>
<th>Key Files</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>ISizingSchema</code></td>
<td>Schema definition (discriminated union)</td>
<td><a href="">types.d.ts:849-949</a></td>
</tr>
<tr>
<td><code>addSizing()</code></td>
<td>Registration function</td>
<td><a href="">src/function/add.ts:256-268</a></td>
</tr>
<tr>
<td><code>SizingValidationService</code></td>
<td>Schema validation</td>
<td><a href="">src/lib/core/types.ts:78</a></td>
</tr>
<tr>
<td><code>SizingSchemaService</code></td>
<td>Configuration storage</td>
<td><a href="">src/lib/core/types.ts:25</a></td>
</tr>
<tr>
<td><code>SizingConnectionService</code></td>
<td>Memoized client factory</td>
<td><a href="">src/lib/core/types.ts:14</a></td>
</tr>
<tr>
<td><code>ClientSizing</code></td>
<td>Calculation implementation</td>
<td>Referenced in architecture</td>
</tr>
<tr>
<td><code>SizingGlobalService</code></td>
<td>Orchestration with context</td>
<td><a href="">src/lib/core/types.ts:37</a></td>
</tr>
<tr>
<td><code>PositionSize</code></td>
<td>Public API class</td>
<td><a href="">src/index.ts:184</a></td>
</tr>
</tbody>
</table>
<p><strong>Key Features:</strong></p>
<ul>
<li>Three sizing methods: fixed-percentage, kelly-criterion, atr-based</li>
<li>Discriminated union ensures type-safe parameter passing</li>
<li>Constraint application (min/max size, max position %)</li>
<li>Memoized client instances by <code>sizingName</code></li>
<li>Optional callbacks for calculation events</li>
<li>Integration with strategy system via <code>sizingName</code> field</li>
</ul>
</div></div><div class="col-sidebar"><div class="page-menu"><div class="tsd-navigation settings"><details class="tsd-accordion"><summary class="tsd-accordion-summary"><h3><svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-chevronDown"></use></svg>Settings</h3></summary><div class="tsd-accordion-details"><div class="tsd-filter-visibility"><span class="settings-label">Member Visibility</span><ul id="tsd-filter-options"><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-protected" name="protected"/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Protected</span></label></li><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-inherited" name="inherited" checked/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Inherited</span></label></li><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-external" name="external"/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>External</span></label></li></ul></div><div class="tsd-theme-toggle"><label class="settings-label" for="tsd-theme">Theme</label><select id="tsd-theme"><option value="os">OS</option><option value="light">Light</option><option value="dark">Dark</option></select></div></div></details></div><details open class="tsd-accordion tsd-page-navigation"><summary class="tsd-accordion-summary"><h3><svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-chevronDown"></use></svg>On This Page</h3></summary><div class="tsd-accordion-details"><a href="#position-sizing"><span>Position <wbr/>Sizing</span></a><ul><li><a href="#purpose-and-scope"><span>Purpose and <wbr/>Scope</span></a></li><li><a href="#position-sizing-methods"><span>Position <wbr/>Sizing <wbr/>Methods</span></a></li><li><ul><li><a href="#method-comparison"><span>Method <wbr/>Comparison</span></a></li><li><a href="#fixed-percentage-sizing"><span>Fixed <wbr/>Percentage <wbr/>Sizing</span></a></li><li><a href="#kelly-criterion-sizing"><span>Kelly <wbr/>Criterion <wbr/>Sizing</span></a></li><li><a href="#atr-based-sizing"><span>ATR-<wbr/>Based <wbr/>Sizing</span></a></li></ul></li><li><a href="#schema-definition-and-registration"><span>Schema <wbr/>Definition and <wbr/>Registration</span></a></li><li><ul><li><a href="#isizingschema-discriminated-union"><span>ISizing<wbr/>Schema <wbr/>Discriminated <wbr/>Union</span></a></li><li><a href="#registration-with-addsizing"><span>Registration with add<wbr/>Sizing()</span></a></li></ul></li><li><a href="#calculation-parameters"><span>Calculation <wbr/>Parameters</span></a></li><li><ul><li><a href="#isizingcalculateparams"><span>ISizing<wbr/>Calculate<wbr/>Params</span></a></li><li><a href="#method-specific-parameters"><span>Method-<wbr/>Specific <wbr/>Parameters</span></a></li><li><ul><li><a href="#fixed-percentage-parameters"><span>Fixed <wbr/>Percentage <wbr/>Parameters</span></a></li><li><a href="#kelly-criterion-parameters"><span>Kelly <wbr/>Criterion <wbr/>Parameters</span></a></li><li><a href="#atr-based-parameters"><span>ATR-<wbr/>Based <wbr/>Parameters</span></a></li></ul></li></ul></li><li><a href="#service-architecture"><span>Service <wbr/>Architecture</span></a></li><li><ul><li><a href="#position-sizing-service-dependencies"><span>Position <wbr/>Sizing <wbr/>Service <wbr/>Dependencies</span></a></li><li><a href="#memoization-in-sizingconnectionservice"><span>Memoization in <wbr/>Sizing<wbr/>Connection<wbr/>Service</span></a></li></ul></li><li><a href="#calculation-flow"><span>Calculation <wbr/>Flow</span></a></li><li><ul><li><a href="#position-size-calculation-sequence"><span>Position <wbr/>Size <wbr/>Calculation <wbr/>Sequence</span></a></li><li><a href="#constraint-application"><span>Constraint <wbr/>Application</span></a></li></ul></li><li><a href="#integration-with-strategy-system"><span>Integration with <wbr/>Strategy <wbr/>System</span></a></li><li><ul><li><a href="#strategy-schema-configuration"><span>Strategy <wbr/>Schema <wbr/>Configuration</span></a></li><li><a href="#position-size-calculation-in-strategy"><span>Position <wbr/>Size <wbr/>Calculation in <wbr/>Strategy</span></a></li></ul></li><li><a href="#positionsize-class-api"><span>Position<wbr/>Size <wbr/>Class API</span></a></li><li><ul><li><a href="#public-methods"><span>Public <wbr/>Methods</span></a></li></ul></li><li><a href="#complete-example"><span>Complete <wbr/>Example</span></a></li><li><ul><li><a href="#full-position-sizing-configuration"><span>Full <wbr/>Position <wbr/>Sizing <wbr/>Configuration</span></a></li></ul></li><li><a href="#summary"><span>Summary</span></a></li></ul></div></details></div><div class="site-menu"><nav class="tsd-navigation"><a href="../modules.html">backtest-kit</a><ul class="tsd-small-nested-navigation" id="tsd-nav-container"><li>Loading...</li></ul></nav></div></div></div><footer><p class="tsd-generator">Generated using <a href="https://typedoc.org/" target="_blank">TypeDoc</a></p></footer><div class="overlay"></div></body></html>

<!-- Yandex.Metrika counter -->
<script type="text/javascript">
    (function(m,e,t,r,i,k,a){
        m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
        m[i].l=1*new Date();
        for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }}
        k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)
    })(window, document,'script','https://mc.yandex.ru/metrika/tag.js?id=105455585', 'ym');

    ym(105455585, 'init', {ssr:true, webvisor:true, clickmap:true, ecommerce:"dataLayer", accurateTrackBounce:true, trackLinks:true});
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/105455585" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
<!-- /Yandex.Metrika counter -->

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-3MQZEBBDDR"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-3MQZEBBDDR');
</script>
