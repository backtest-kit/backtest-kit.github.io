<!DOCTYPE html><html class="default" lang="en" data-base=".."><head><meta charset="utf-8"/><meta http-equiv="x-ua-compatible" content="IE=edge"/><title>design/14_core_business_logic | backtest-kit</title><meta name="description" content="Documentation for backtest-kit"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="stylesheet" href="../assets/style.css"/><link rel="stylesheet" href="../assets/highlight.css"/><script defer src="../assets/main.js"></script><script async src="../assets/icons.js" id="tsd-icons-script"></script><script async src="../assets/search.js" id="tsd-search-script"></script><script async src="../assets/navigation.js" id="tsd-nav-script"></script><script async src="../assets/hierarchy.js" id="tsd-hierarchy-script"></script></head><body><script>document.documentElement.dataset.theme = localStorage.getItem("tsd-theme") || "os";document.body.style.display="none";setTimeout(() => app?app.showPage():document.body.style.removeProperty("display"),500)</script><header class="tsd-page-toolbar"><div class="tsd-toolbar-contents container"><div class="table-cell" id="tsd-search"><div class="field"><label for="tsd-search-field" class="tsd-widget tsd-toolbar-icon search no-caption"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-search"></use></svg></label><input type="text" id="tsd-search-field" aria-label="Search"/></div><div class="field"><div id="tsd-toolbar-links"></div></div><ul class="results"><li class="state loading">Preparing search index...</li><li class="state failure">The search index is not available</li></ul><a href="../index.html" class="title">backtest-kit</a></div><div class="table-cell" id="tsd-widgets"><a href="#" class="tsd-widget tsd-toolbar-icon menu no-caption" data-toggle="menu" aria-label="Menu"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-menu"></use></svg></a></div></div></header><div class="container container-main"><div class="col-content"><div class="tsd-page-title"><ul class="tsd-breadcrumb"><li><a href="../modules.html">backtest-kit</a></li><li><a href="design_14_core_business_logic.html">design/14_core_business_logic</a></li></ul></div><div class="tsd-panel tsd-typography"><a id="core-business-logic" class="tsd-anchor"></a><h1 class="tsd-anchor-link">Core Business Logic<a href="#core-business-logic" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h1><a id="purpose-and-scope" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Purpose and Scope<a href="#purpose-and-scope" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>This document describes the <strong>Business Logic Layer</strong> of the backtest-kit framework, which contains pure TypeScript implementations of trading system functionality without dependency injection concerns. These client classes (<a href="">src/client/</a>) implement the core algorithms for signal lifecycle management, market data processing, and timeframe generation.</p>
<p>For information about how these clients are instantiated and managed through dependency injection, see <a href="design_18_service_layer.html">Service Layer</a>. For details on the service orchestration that invokes these clients, see <a href="design_04_architecture.html">Architecture</a>. For the public API that end users interact with, see <a href="design_08_public_api_reference.html">Public API Reference</a>.</p>
<hr>
<a id="overview-of-business-logic-layer" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Overview of Business Logic Layer<a href="#overview-of-business-logic-layer" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>The Business Logic Layer consists of three client implementations that encapsulate domain logic:</p>
<table>
<thead>
<tr>
<th>Client Class</th>
<th>Primary Responsibility</th>
<th>Key Methods</th>
<th>Importance</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>ClientStrategy</code></td>
<td>Signal lifecycle, validation, PnL calculation</td>
<td><code>tick()</code>, <code>backtest()</code>, <code>setPendingSignal()</code></td>
<td>33.84</td>
</tr>
<tr>
<td><code>ClientExchange</code></td>
<td>Market data fetching, VWAP calculation</td>
<td><code>getCandles()</code>, <code>getAveragePrice()</code>, <code>getNextCandles()</code></td>
<td>12.54</td>
</tr>
<tr>
<td><code>ClientFrame</code></td>
<td>Timeframe generation for backtesting</td>
<td><code>getTimeframe()</code></td>
<td>3.04</td>
</tr>
</tbody>
</table>
<p>These classes are designed with <strong>prototype function patterns</strong> for memory efficiency and implement interfaces defined in <a href="">src/interfaces/</a> for type safety. They receive dependencies through constructor parameters but do not use the DI container directly, making them pure and testable.</p>
<hr>
<a id="business-logic-architecture" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Business Logic Architecture<a href="#business-logic-architecture" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><img src="../media/14_Core_Business_Logic_0.svg" alt="Mermaid Diagram"></p>
<hr>
<a id="clientstrategy-signal-lifecycle-management" class="tsd-anchor"></a><h2 class="tsd-anchor-link">ClientStrategy: Signal Lifecycle Management<a href="#clientstrategy-signal-lifecycle-management" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p><code>ClientStrategy</code> is the central orchestrator of trading signal logic, implementing the complete lifecycle from signal generation through validation, monitoring, and closure with PnL calculation.</p>
<a id="class-structure" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Class Structure<a href="#class-structure" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><img src="../media/14_Core_Business_Logic_1.svg" alt="Mermaid Diagram"></p>
<a id="signal-interval-throttling" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Signal Interval Throttling<a href="#signal-interval-throttling" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>The framework enforces minimum intervals between <code>getSignal()</code> calls to prevent excessive API requests and ensure strategies respect temporal boundaries:</p>
<table>
<thead>
<tr>
<th><code>SignalInterval</code></th>
<th>Minutes</th>
<th>Use Case</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>&quot;1m&quot;</code></td>
<td>1</td>
<td>High-frequency scalping</td>
</tr>
<tr>
<td><code>&quot;3m&quot;</code></td>
<td>3</td>
<td>Short-term momentum</td>
</tr>
<tr>
<td><code>&quot;5m&quot;</code></td>
<td>5</td>
<td>Standard short-term trading</td>
</tr>
<tr>
<td><code>&quot;15m&quot;</code></td>
<td>15</td>
<td>Medium-term swing trading</td>
</tr>
<tr>
<td><code>&quot;30m&quot;</code></td>
<td>30</td>
<td>Position trading</td>
</tr>
<tr>
<td><code>&quot;1h&quot;</code></td>
<td>60</td>
<td>Long-term position trading</td>
</tr>
</tbody>
</table>
<p>Throttling logic: <a href="">src/client/ClientStrategy.ts:94-106</a></p>
<hr>
<a id="signal-validation" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Signal Validation<a href="#signal-validation" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>The <code>VALIDATE_SIGNAL_FN</code> performs comprehensive validation of signal parameters before persistence or execution. Validation occurs at <a href="">src/client/ClientStrategy.ts:28-88</a>:</p>
<p><strong>Validation Rules:</strong></p>
<ol>
<li><strong>Price Positivity</strong> - All prices must be &gt; 0</li>
<li><strong>Long Position Logic</strong> - <code>priceTakeProfit &gt; priceOpen</code> and <code>priceStopLoss &lt; priceOpen</code></li>
<li><strong>Short Position Logic</strong> - <code>priceTakeProfit &lt; priceOpen</code> and <code>priceStopLoss &gt; priceOpen</code></li>
<li><strong>Time Parameters</strong> - <code>minuteEstimatedTime &gt; 0</code> and <code>timestamp &gt; 0</code></li>
</ol>
<p><img src="../media/14_Core_Business_Logic_2.svg" alt="Mermaid Diagram"></p>
<hr>
<a id="tick-execution-flow" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Tick Execution Flow<a href="#tick-execution-flow" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>The <code>tick()</code> method implements the main execution loop for signal monitoring. It returns a discriminated union type <code>IStrategyTickResult</code> with four possible states:</p>
<ul>
<li><strong>Idle State</strong> (<a href="">src/client/ClientStrategy.ts:294-322</a>): No signal exists, returns current VWAP</li>
<li><strong>Opened State</strong> (<a href="">src/client/ClientStrategy.ts:265-292</a>): New signal validated and persisted</li>
<li><strong>Active State</strong> (<a href="">src/client/ClientStrategy.ts:437-463</a>): Signal being monitored, not yielded in live mode</li>
<li><strong>Closed State</strong> (<a href="">src/client/ClientStrategy.ts:374-435</a>): Signal completed with PnL calculation</li>
</ul>
<hr>
<a id="backtest-fast-forward-simulation" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Backtest Fast-Forward Simulation<a href="#backtest-fast-forward-simulation" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>The <code>backtest()</code> method simulates signal outcomes using historical candle data without iterating through every timestamp. This is a critical performance optimization for backtesting:</p>
<p><img src="../media/14_Core_Business_Logic_4.svg" alt="Mermaid Diagram"></p>
<p><strong>Key Implementation Details:</strong></p>
<ul>
<li><strong>VWAP Window</strong>: Uses sliding window of 5 candles (<a href="">src/client/ClientStrategy.ts:512-516</a>)</li>
<li><strong>Start Index</strong>: Begins at index 4 to ensure 5 candles available (<a href="">src/client/ClientStrategy.ts:512</a>)</li>
<li><strong>Long Position</strong>: Checks if <code>averagePrice &gt;= priceTakeProfit</code> or <code>averagePrice &lt;= priceStopLoss</code> (<a href="">src/client/ClientStrategy.ts:521-528</a>)</li>
<li><strong>Short Position</strong>: Checks if <code>averagePrice &lt;= priceTakeProfit</code> or <code>averagePrice &gt;= priceStopLoss</code> (<a href="">src/client/ClientStrategy.ts:533-540</a>)</li>
<li><strong>Time Expiration</strong>: If no TP/SL hit, uses last 5 candles VWAP (<a href="">src/client/ClientStrategy.ts:601-606</a>)</li>
</ul>
<hr>
<a id="crash-safe-persistence-integration" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Crash-Safe Persistence Integration<a href="#crash-safe-persistence-integration" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><code>ClientStrategy</code> integrates with <code>PersistSignalAdapter</code> to ensure signal state survives process crashes in live trading mode:</p>
<table>
<thead>
<tr>
<th>Operation</th>
<th>Method</th>
<th>Persistence Behavior</th>
</tr>
</thead>
<tbody>
<tr>
<td>Initialize</td>
<td><code>waitForInit()</code></td>
<td>Reads persisted signal from disk (<a href="">src/client/ClientStrategy.ts:151-164</a>)</td>
</tr>
<tr>
<td>Signal Opened</td>
<td><code>setPendingSignal(signal)</code></td>
<td>Atomic write before yielding result (<a href="">src/client/ClientStrategy.ts:228-232</a>)</td>
</tr>
<tr>
<td>Signal Closed</td>
<td><code>setPendingSignal(null)</code></td>
<td>Atomic write to clear state (<a href="">src/client/ClientStrategy.ts:228-232</a>)</td>
</tr>
<tr>
<td>Backtest Mode</td>
<td>All operations</td>
<td>Persistence skipped (<a href="">src/client/ClientStrategy.ts:225-227</a>)</td>
</tr>
</tbody>
</table>
<p><strong>Singleshot Pattern</strong>: <code>waitForInit()</code> uses <code>singleshot</code> from <code>functools-kit</code> to ensure initialization happens exactly once (<a href="">src/client/ClientStrategy.ts:209</a>).</p>
<hr>
<a id="clientexchange-market-data-provider" class="tsd-anchor"></a><h2 class="tsd-anchor-link">ClientExchange: Market Data Provider<a href="#clientexchange-market-data-provider" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p><code>ClientExchange</code> abstracts market data access, providing historical and future candle fetching, VWAP calculation, and price/quantity formatting.</p>
<a id="candle-interval-mapping" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Candle Interval Mapping<a href="#candle-interval-mapping" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><img src="../media/14_Core_Business_Logic_5.svg" alt="Mermaid Diagram"></p>
<hr>
<a id="historical-candle-fetching" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Historical Candle Fetching<a href="#historical-candle-fetching" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>The <code>getCandles()</code> method fetches historical candles <strong>backwards</strong> from the execution context time:</p>
<p><strong>Algorithm:</strong></p>
<ol>
<li>Calculate time adjustment: <code>adjust = (interval_minutes * limit) - interval_minutes</code></li>
<li>Compute <code>since = execution.context.when - adjust</code></li>
<li>Call user-provided <code>getCandles(symbol, interval, since, limit)</code></li>
<li>Filter results to strict range: <code>sinceTimestamp &lt;= candle.timestamp &lt;= whenTimestamp</code></li>
<li>Warn if fewer than requested candles returned</li>
</ol>
<p><img src="../media/14_Core_Business_Logic_6.svg" alt="Mermaid Diagram"></p>
<p><strong>Implementation:</strong> <a href="">src/client/ClientExchange.ts:57-101</a></p>
<hr>
<a id="future-candle-fetching-backtest-only" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Future Candle Fetching (Backtest Only)<a href="#future-candle-fetching-backtest-only" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>The <code>getNextCandles()</code> method fetches candles <strong>forwards</strong> from execution context time. This is used in backtest mode to get future candles for signal simulation:</p>
<p><strong>Safety Check:</strong> Returns empty array if requested <code>endTime &gt; Date.now()</code> to prevent fetching unavailable data (<a href="">src/client/ClientExchange.ts:132-134</a>).</p>
<p><strong>Algorithm:</strong></p>
<ol>
<li><code>since = execution.context.when</code> (current timestamp)</li>
<li><code>endTime = since + (limit * interval_minutes * 60 * 1000)</code></li>
<li>If <code>endTime &gt; Date.now()</code>, return <code>[]</code></li>
<li>Call user-provided <code>getCandles(symbol, interval, since, limit)</code></li>
<li>Filter: <code>sinceTimestamp &lt;= candle.timestamp &lt;= endTime</code></li>
</ol>
<p><strong>Implementation:</strong> <a href="">src/client/ClientExchange.ts:113-157</a></p>
<hr>
<a id="vwap-calculation" class="tsd-anchor"></a><h3 class="tsd-anchor-link">VWAP Calculation<a href="#vwap-calculation" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><code>getAveragePrice()</code> calculates Volume Weighted Average Price using the last 5 one-minute candles:</p>
<p><strong>Formula:</strong></p>
<pre><code><span class="hl-4">Typical</span><span class="hl-1"> </span><span class="hl-4">Price</span><span class="hl-1"> = (</span><span class="hl-4">high</span><span class="hl-1"> + </span><span class="hl-4">low</span><span class="hl-1"> + </span><span class="hl-4">close</span><span class="hl-1">) / </span><span class="hl-8">3</span><br/><span class="hl-7">VWAP</span><span class="hl-1"> = </span><span class="hl-0">Σ</span><span class="hl-1">(</span><span class="hl-4">typical_price</span><span class="hl-1"> × </span><span class="hl-4">volume</span><span class="hl-1">) / </span><span class="hl-0">Σ</span><span class="hl-1">(</span><span class="hl-4">volume</span><span class="hl-1">)</span><br/><br/><span class="hl-0">Fallback</span><span class="hl-1"> (</span><span class="hl-4">if</span><span class="hl-1"> </span><span class="hl-4">total</span><span class="hl-1"> </span><span class="hl-4">volume</span><span class="hl-1"> = </span><span class="hl-8">0</span><span class="hl-1">):</span><br/><span class="hl-4">Simple</span><span class="hl-1"> </span><span class="hl-4">Average</span><span class="hl-1"> = </span><span class="hl-0">Σ</span><span class="hl-1">(</span><span class="hl-4">close</span><span class="hl-1">) / </span><span class="hl-4">count</span>
</code><button>Copy</button></pre>

<p><strong>Implementation Steps:</strong></p>
<ol>
<li>Fetch last 5 candles with <code>getCandles(symbol, &quot;1m&quot;, 5)</code></li>
<li>Calculate typical price for each candle: <code>(high + low + close) / 3</code></li>
<li>Sum <code>typical_price * volume</code> across all candles</li>
<li>Sum total volume</li>
<li>Return <code>sum_price_volume / total_volume</code></li>
<li>If total volume is zero, return simple average of close prices</li>
</ol>
<p><strong>Code:</strong> <a href="">src/client/ClientExchange.ts:172-203</a></p>
<hr>
<a id="clientframe-timeframe-generation" class="tsd-anchor"></a><h2 class="tsd-anchor-link">ClientFrame: Timeframe Generation<a href="#clientframe-timeframe-generation" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p><code>ClientFrame</code> generates arrays of <code>Date</code> objects representing tick timestamps for backtest iteration.</p>
<a id="timeframe-generation-algorithm" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Timeframe Generation Algorithm<a href="#timeframe-generation-algorithm" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><img src="../media/14_Core_Business_Logic_7.svg" alt="Mermaid Diagram"></p>
<p><strong>Example:</strong></p>
<ul>
<li><code>startDate</code>: <code>2024-01-01T00:00:00Z</code></li>
<li><code>endDate</code>: <code>2024-01-01T01:00:00Z</code></li>
<li><code>interval</code>: <code>&quot;15m&quot;</code></li>
<li><strong>Result</strong>: <code>[00:00, 00:15, 00:30, 00:45, 01:00]</code> (5 timestamps)</li>
</ul>
<p><strong>Implementation:</strong> <a href="">src/client/ClientFrame.ts:37-62</a></p>
<p><strong>Singleshot Caching:</strong> The <code>getTimeframe()</code> method is wrapped with <code>singleshot</code> to cache results and prevent redundant generation (<a href="">src/client/ClientFrame.ts:86-89</a>).</p>
<hr>
<a id="pnl-calculation-with-fees-and-slippage" class="tsd-anchor"></a><h2 class="tsd-anchor-link">PnL Calculation with Fees and Slippage<a href="#pnl-calculation-with-fees-and-slippage" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>The <code>toProfitLossDto</code> helper calculates realistic profit/loss including market impact simulation:</p>
<a id="constants" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Constants<a href="#constants" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><table>
<thead>
<tr>
<th>Constant</th>
<th>Value</th>
<th>Applied When</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>PERCENT_SLIPPAGE</code></td>
<td>0.1%</td>
<td>Entry and exit (worse execution)</td>
</tr>
<tr>
<td><code>PERCENT_FEE</code></td>
<td>0.1%</td>
<td>Entry and exit (total 0.2%)</td>
</tr>
</tbody>
</table>
<hr>
<a id="slippage-application-logic" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Slippage Application Logic<a href="#slippage-application-logic" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><img src="../media/14_Core_Business_Logic_8.svg" alt="Mermaid Diagram"></p>
<p><strong>Rationale:</strong></p>
<ul>
<li><strong>Long positions</strong>: Buy at higher price (slippage hurts entry), sell at lower price (slippage hurts exit)</li>
<li><strong>Short positions</strong>: Sell at lower price (slippage hurts entry), buy at higher price (slippage hurts exit)</li>
<li><strong>Fees</strong>: Applied twice (0.1% entry + 0.1% exit = 0.2% total)</li>
</ul>
<p><strong>Implementation:</strong> <a href="">src/helpers/toProfitLossDto.ts:44-90</a></p>
<hr>
<a id="business-logic-integration-points" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Business Logic Integration Points<a href="#business-logic-integration-points" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>The Business Logic Layer integrates with the rest of the system through well-defined interfaces:</p>
<table>
<thead>
<tr>
<th>Integration Point</th>
<th>Interface</th>
<th>Provided By</th>
<th>Used By</th>
</tr>
</thead>
<tbody>
<tr>
<td>Signal Generation</td>
<td><code>getSignal(symbol)</code></td>
<td>User strategy implementation</td>
<td><code>ClientStrategy</code></td>
</tr>
<tr>
<td>Candle Data</td>
<td><code>getCandles(symbol, interval, since, limit)</code></td>
<td>User exchange implementation</td>
<td><code>ClientExchange</code></td>
</tr>
<tr>
<td>Price Formatting</td>
<td><code>formatPrice(symbol, price)</code></td>
<td>User exchange implementation</td>
<td><code>ClientExchange</code></td>
</tr>
<tr>
<td>Quantity Formatting</td>
<td><code>formatQuantity(symbol, quantity)</code></td>
<td>User exchange implementation</td>
<td><code>ClientExchange</code></td>
</tr>
<tr>
<td>Logging</td>
<td><code>ILogger</code></td>
<td>DI container</td>
<td>All clients</td>
</tr>
<tr>
<td>Execution Context</td>
<td><code>ExecutionContextService</code></td>
<td>DI container</td>
<td>All clients</td>
</tr>
<tr>
<td>Method Context</td>
<td><code>MethodContextService</code></td>
<td>DI container</td>
<td><code>ClientStrategy</code></td>
</tr>
</tbody>
</table>
<hr>
<a id="memory-efficiency-patterns" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Memory Efficiency Patterns<a href="#memory-efficiency-patterns" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>All client classes use <strong>prototype function patterns</strong> to minimize memory overhead:</p>
<p><strong>Pattern Example from ClientStrategy:</strong></p>
<pre><code class="typescript"><span class="hl-5">// Private function declared outside class</span><br/><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">GET_SIGNAL_FN</span><span class="hl-1"> = </span><span class="hl-0">trycatch</span><span class="hl-1">(</span><br/><span class="hl-1">  </span><span class="hl-6">async</span><span class="hl-1"> (</span><span class="hl-4">self</span><span class="hl-1">: </span><span class="hl-10">ClientStrategy</span><span class="hl-1">): </span><span class="hl-10">Promise</span><span class="hl-1">&lt;</span><span class="hl-10">ISignalRow</span><span class="hl-1"> | </span><span class="hl-10">null</span><span class="hl-1">&gt; </span><span class="hl-6">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-5">// Implementation uses &#39;self&#39; instead of &#39;this&#39;</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">);</span><br/><br/><span class="hl-5">// Public method delegates to private function</span><br/><span class="hl-4">public</span><span class="hl-1"> </span><span class="hl-4">async</span><span class="hl-1"> </span><span class="hl-0">tick</span><span class="hl-1">(): </span><span class="hl-10">Promise</span><span class="hl-1">&lt;</span><span class="hl-4">IStrategyTickResult</span><span class="hl-1">&gt; {</span><br/><span class="hl-1">  const </span><span class="hl-4">pendingSignal</span><span class="hl-1"> = </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-0">GET_SIGNAL_FN</span><span class="hl-1">(</span><span class="hl-6">this</span><span class="hl-1">);</span><br/><span class="hl-1">  </span><span class="hl-5">// ...</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<p><strong>Benefits:</strong></p>
<ul>
<li>Function defined once in prototype, not per instance</li>
<li>Reduces memory when many strategy/exchange instances exist</li>
<li>Maintains clean separation between public API and implementation</li>
</ul>
</div></div><div class="col-sidebar"><div class="page-menu"><div class="tsd-navigation settings"><details class="tsd-accordion"><summary class="tsd-accordion-summary"><h3><svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-chevronDown"></use></svg>Settings</h3></summary><div class="tsd-accordion-details"><div class="tsd-filter-visibility"><span class="settings-label">Member Visibility</span><ul id="tsd-filter-options"><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-protected" name="protected"/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Protected</span></label></li><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-inherited" name="inherited" checked/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Inherited</span></label></li><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-external" name="external"/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>External</span></label></li></ul></div><div class="tsd-theme-toggle"><label class="settings-label" for="tsd-theme">Theme</label><select id="tsd-theme"><option value="os">OS</option><option value="light">Light</option><option value="dark">Dark</option></select></div></div></details></div><details open class="tsd-accordion tsd-page-navigation"><summary class="tsd-accordion-summary"><h3><svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-chevronDown"></use></svg>On This Page</h3></summary><div class="tsd-accordion-details"><a href="#core-business-logic"><span>Core <wbr/>Business <wbr/>Logic</span></a><ul><li><a href="#purpose-and-scope"><span>Purpose and <wbr/>Scope</span></a></li><li><a href="#overview-of-business-logic-layer"><span>Overview of <wbr/>Business <wbr/>Logic <wbr/>Layer</span></a></li><li><ul><li><a href="#business-logic-architecture"><span>Business <wbr/>Logic <wbr/>Architecture</span></a></li></ul></li><li><a href="#clientstrategy-signal-lifecycle-management"><span>Client<wbr/>Strategy: <wbr/>Signal <wbr/>Lifecycle <wbr/>Management</span></a></li><li><ul><li><a href="#class-structure"><span>Class <wbr/>Structure</span></a></li><li><a href="#signal-interval-throttling"><span>Signal <wbr/>Interval <wbr/>Throttling</span></a></li><li><a href="#signal-validation"><span>Signal <wbr/>Validation</span></a></li><li><a href="#tick-execution-flow"><span>Tick <wbr/>Execution <wbr/>Flow</span></a></li><li><a href="#backtest-fast-forward-simulation"><span>Backtest <wbr/>Fast-<wbr/>Forward <wbr/>Simulation</span></a></li><li><a href="#crash-safe-persistence-integration"><span>Crash-<wbr/>Safe <wbr/>Persistence <wbr/>Integration</span></a></li></ul></li><li><a href="#clientexchange-market-data-provider"><span>Client<wbr/>Exchange: <wbr/>Market <wbr/>Data <wbr/>Provider</span></a></li><li><ul><li><a href="#candle-interval-mapping"><span>Candle <wbr/>Interval <wbr/>Mapping</span></a></li><li><a href="#historical-candle-fetching"><span>Historical <wbr/>Candle <wbr/>Fetching</span></a></li><li><a href="#future-candle-fetching-backtest-only"><span>Future <wbr/>Candle <wbr/>Fetching (<wbr/>Backtest <wbr/>Only)</span></a></li><li><a href="#vwap-calculation"><span>VWAP <wbr/>Calculation</span></a></li></ul></li><li><a href="#clientframe-timeframe-generation"><span>Client<wbr/>Frame: <wbr/>Timeframe <wbr/>Generation</span></a></li><li><ul><li><a href="#timeframe-generation-algorithm"><span>Timeframe <wbr/>Generation <wbr/>Algorithm</span></a></li></ul></li><li><a href="#pnl-calculation-with-fees-and-slippage"><span>Pn<wbr/>L <wbr/>Calculation with <wbr/>Fees and <wbr/>Slippage</span></a></li><li><ul><li><a href="#constants"><span>Constants</span></a></li><li><a href="#slippage-application-logic"><span>Slippage <wbr/>Application <wbr/>Logic</span></a></li></ul></li><li><a href="#business-logic-integration-points"><span>Business <wbr/>Logic <wbr/>Integration <wbr/>Points</span></a></li><li><a href="#memory-efficiency-patterns"><span>Memory <wbr/>Efficiency <wbr/>Patterns</span></a></li></ul></div></details></div><div class="site-menu"><nav class="tsd-navigation"><a href="../modules.html">backtest-kit</a><ul class="tsd-small-nested-navigation" id="tsd-nav-container"><li>Loading...</li></ul></nav></div></div></div><footer><p class="tsd-generator">Generated using <a href="https://typedoc.org/" target="_blank">TypeDoc</a></p></footer><div class="overlay"></div></body></html>

<!-- Yandex.Metrika counter -->
<script type="text/javascript">
    (function(m,e,t,r,i,k,a){
        m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
        m[i].l=1*new Date();
        for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }}
        k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)
    })(window, document,'script','https://mc.yandex.ru/metrika/tag.js?id=105455585', 'ym');

    ym(105455585, 'init', {ssr:true, webvisor:true, clickmap:true, ecommerce:"dataLayer", accurateTrackBounce:true, trackLinks:true});
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/105455585" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
<!-- /Yandex.Metrika counter -->

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-3MQZEBBDDR"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-3MQZEBBDDR');
</script>
