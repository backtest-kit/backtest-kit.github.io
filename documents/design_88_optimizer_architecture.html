<!DOCTYPE html><html class="default" lang="en" data-base=".."><head><meta charset="utf-8"/><meta http-equiv="x-ua-compatible" content="IE=edge"/><title>design/88_optimizer_architecture | backtest-kit</title><meta name="description" content="Documentation for backtest-kit"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="stylesheet" href="../assets/style.css"/><link rel="stylesheet" href="../assets/highlight.css"/><script defer src="../assets/main.js"></script><script async src="../assets/icons.js" id="tsd-icons-script"></script><script async src="../assets/search.js" id="tsd-search-script"></script><script async src="../assets/navigation.js" id="tsd-nav-script"></script><script async src="../assets/hierarchy.js" id="tsd-hierarchy-script"></script></head><body><script>document.documentElement.dataset.theme = localStorage.getItem("tsd-theme") || "os";document.body.style.display="none";setTimeout(() => app?app.showPage():document.body.style.removeProperty("display"),500)</script><header class="tsd-page-toolbar"><div class="tsd-toolbar-contents container"><div class="table-cell" id="tsd-search"><div class="field"><label for="tsd-search-field" class="tsd-widget tsd-toolbar-icon search no-caption"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-search"></use></svg></label><input type="text" id="tsd-search-field" aria-label="Search"/></div><div class="field"><div id="tsd-toolbar-links"></div></div><ul class="results"><li class="state loading">Preparing search index...</li><li class="state failure">The search index is not available</li></ul><a href="../index.html" class="title">backtest-kit</a></div><div class="table-cell" id="tsd-widgets"><a href="#" class="tsd-widget tsd-toolbar-icon menu no-caption" data-toggle="menu" aria-label="Menu"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-menu"></use></svg></a></div></div></header><div class="container container-main"><div class="col-content"><div class="tsd-page-title"><ul class="tsd-breadcrumb"><li><a href="../modules.html">backtest-kit</a></li><li><a href="design_88_optimizer_architecture.html">design/88_optimizer_architecture</a></li></ul></div><div class="tsd-panel tsd-typography"><a id="optimizer-architecture" class="tsd-anchor"></a><h1 class="tsd-anchor-link">Optimizer Architecture<a href="#optimizer-architecture" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h1><a id="purpose-and-scope" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Purpose and Scope<a href="#purpose-and-scope" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>This page documents the architecture of the Optimizer system, which generates AI-powered trading strategies through LLM integration. It covers the core components (<code>ClientOptimizer</code>, <code>OptimizerConnectionService</code>, <code>OptimizerTemplateService</code>), their relationships, the template merging pattern, and the execution flow of the three main operations: <code>getData</code>, <code>getCode</code>, and <code>dump</code>.</p>
<p>For details on data collection and pagination, see <a href="design_89_data_collection_pipeline.html">Data Collection Pipeline</a>. For LLM integration specifics, see <a href="design_90_llm_integration.html">LLM Integration</a>. For code generation details, see <a href="design_91_strategy_code_generation.html">Strategy Code Generation</a>. For training/testing range configuration, see <a href="design_92_training_vs_testing_ranges.html">Training vs Testing Ranges</a>.</p>
<a id="component-overview" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Component Overview<a href="#component-overview" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>The Optimizer system consists of four primary components organized in a layered architecture:</p>
<p><img src="../media/88_Optimizer_Architecture_0.svg" alt="Mermaid Diagram"></p>
<a id="core-components" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Core Components<a href="#core-components" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><a id="clientoptimizer" class="tsd-anchor"></a><h3 class="tsd-anchor-link">ClientOptimizer<a href="#clientoptimizer" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><code>ClientOptimizer</code> is the main client class that performs optimizer operations. It accepts <code>IOptimizerParams</code> (which extends <code>IOptimizerSchema</code> with logger and complete template) and an <code>onProgress</code> callback for progress emission.</p>
<p><strong>Constructor Parameters:</strong></p>
<ul>
<li><code>params: IOptimizerParams</code> - Configuration with resolved dependencies</li>
<li><code>onProgress: (progress: ProgressOptimizerContract) =&gt; void</code> - Progress event emitter</li>
</ul>
<p><strong>Public Methods:</strong></p>
<table>
<thead>
<tr>
<th>Method</th>
<th>Parameters</th>
<th>Return Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>getData</code></td>
<td><code>symbol: string</code></td>
<td><code>Promise&lt;IOptimizerStrategy[]&gt;</code></td>
<td>Fetches data from all sources and generates strategy metadata</td>
</tr>
<tr>
<td><code>getCode</code></td>
<td><code>symbol: string</code></td>
<td><code>Promise&lt;string&gt;</code></td>
<td>Generates complete executable strategy code</td>
</tr>
<tr>
<td><code>dump</code></td>
<td><code>symbol: string, path?: string</code></td>
<td><code>Promise&lt;void&gt;</code></td>
<td>Generates and saves strategy code to file</td>
</tr>
</tbody>
</table>
<p><strong>Key Implementation Details:</strong></p>
<p>The class delegates to three internal functions for its operations:</p>
<ul>
<li><code>GET_STRATEGY_DATA_FN</code> - Handles data collection and LLM conversation building <a href="">src/client/ClientOptimizer.ts:99-215</a></li>
<li><code>GET_STRATEGY_CODE_FN</code> - Handles code assembly from templates <a href="">src/client/ClientOptimizer.ts:225-350</a></li>
<li><code>GET_STRATEGY_DUMP_FN</code> - Handles file system operations <a href="">src/client/ClientOptimizer.ts:360-384</a></li>
</ul>
<a id="optimizerconnectionservice" class="tsd-anchor"></a><h3 class="tsd-anchor-link">OptimizerConnectionService<a href="#optimizerconnectionservice" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><code>OptimizerConnectionService</code> serves as the service layer between the public API and <code>ClientOptimizer</code>. It handles dependency injection, template merging, and instance caching.</p>
<p><strong>Injected Dependencies:</strong></p>
<ul>
<li><code>LoggerService</code> - For debug and info logging</li>
<li><code>OptimizerSchemaService</code> - For retrieving registered optimizer schemas</li>
<li><code>OptimizerTemplateService</code> - For default template implementations</li>
</ul>
<p><strong>Key Method: <code>getOptimizer</code></strong></p>
<p>The <code>getOptimizer</code> method is memoized by <code>optimizerName</code> to ensure only one <code>ClientOptimizer</code> instance exists per optimizer configuration:</p>
<pre><code class="typescript"><span class="hl-4">public</span><span class="hl-1"> </span><span class="hl-4">getOptimizer</span><span class="hl-1"> = </span><span class="hl-0">memoize</span><span class="hl-1">(</span><br/><span class="hl-1">  ([</span><span class="hl-4">optimizerName</span><span class="hl-1">]) </span><span class="hl-6">=&gt;</span><span class="hl-1"> </span><span class="hl-2">`</span><span class="hl-6">${</span><span class="hl-4">optimizerName</span><span class="hl-6">}</span><span class="hl-2">`</span><span class="hl-1">,</span><br/><span class="hl-1">  (</span><span class="hl-4">optimizerName</span><span class="hl-1">: </span><span class="hl-10">OptimizerName</span><span class="hl-1">) </span><span class="hl-6">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-5">// Retrieve schema and merge templates</span><br/><span class="hl-1">    </span><span class="hl-5">// Return new ClientOptimizer instance</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">);</span>
</code><button type="button">Copy</button></pre>

<p>This method performs three critical operations:</p>
<ol>
<li>Retrieves the schema from <code>OptimizerSchemaService</code> <a href="">src/lib/services/connection/OptimizerConnectionService.ts:62-69</a></li>
<li>Merges custom templates with defaults from <code>OptimizerTemplateService</code> <a href="">src/lib/services/connection/OptimizerConnectionService.ts:72-97</a></li>
<li>Instantiates <code>ClientOptimizer</code> with resolved dependencies <a href="">src/lib/services/connection/OptimizerConnectionService.ts:99-112</a></li>
</ol>
<p><strong>Delegation Methods:</strong></p>
<p>The service exposes three methods that delegate to the cached <code>ClientOptimizer</code> instance:</p>
<table>
<thead>
<tr>
<th>Method</th>
<th>Delegates To</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>getData(symbol, optimizerName)</code></td>
<td><code>optimizer.getData(symbol)</code></td>
<td>Returns strategy metadata</td>
</tr>
<tr>
<td><code>getCode(symbol, optimizerName)</code></td>
<td><code>optimizer.getCode(symbol)</code></td>
<td>Returns generated code</td>
</tr>
<tr>
<td><code>dump(symbol, optimizerName, path?)</code></td>
<td><code>optimizer.dump(symbol, path)</code></td>
<td>Saves code to file</td>
</tr>
</tbody>
</table>
<a id="optimizertemplateservice" class="tsd-anchor"></a><h3 class="tsd-anchor-link">OptimizerTemplateService<a href="#optimizertemplateservice" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><code>OptimizerTemplateService</code> implements the <code>IOptimizerTemplate</code> interface, providing default code generation templates for all 11 required methods:</p>
<p><strong>Template Methods:</strong></p>
<table>
<thead>
<tr>
<th>Method</th>
<th>Return Type</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>getTopBanner</code></td>
<td><code>string</code></td>
<td>Imports and constants (shebang, ollama, ccxt, backtest-kit)</td>
</tr>
<tr>
<td><code>getUserMessage</code></td>
<td><code>string</code></td>
<td>Default user message format for LLM conversations</td>
</tr>
<tr>
<td><code>getAssistantMessage</code></td>
<td><code>string</code></td>
<td>Default assistant acknowledgment message</td>
</tr>
<tr>
<td><code>getWalkerTemplate</code></td>
<td><code>string</code></td>
<td><code>addWalker()</code> configuration code</td>
</tr>
<tr>
<td><code>getStrategyTemplate</code></td>
<td><code>string</code></td>
<td><code>addStrategy()</code> with <code>getSignal()</code> function and LLM integration</td>
</tr>
<tr>
<td><code>getExchangeTemplate</code></td>
<td><code>string</code></td>
<td><code>addExchange()</code> with CCXT Binance integration</td>
</tr>
<tr>
<td><code>getFrameTemplate</code></td>
<td><code>string</code></td>
<td><code>addFrame()</code> timeframe configuration</td>
</tr>
<tr>
<td><code>getLauncherTemplate</code></td>
<td><code>string</code></td>
<td><code>Walker.background()</code> with event listeners</td>
</tr>
<tr>
<td><code>getTextTemplate</code></td>
<td><code>string</code></td>
<td><code>text()</code> helper for LLM text generation</td>
</tr>
<tr>
<td><code>getJsonTemplate</code></td>
<td><code>string</code></td>
<td><code>json()</code> helper for structured signal output</td>
</tr>
<tr>
<td><code>getJsonDumpTemplate</code></td>
<td><code>string</code></td>
<td><code>dumpJson()</code> helper for debug logging</td>
</tr>
</tbody>
</table>
<p>All methods accept relevant parameters (symbol, name, dates, etc.) and return generated code as strings. The service uses escape functions to prevent code injection from user-provided values.</p>
<a id="optimizerschemaservice" class="tsd-anchor"></a><h3 class="tsd-anchor-link">OptimizerSchemaService<a href="#optimizerschemaservice" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><code>OptimizerSchemaService</code> is a standard schema service that maintains a registry mapping <code>optimizerName</code> to <code>IOptimizerSchema</code>. It follows the same pattern as other schema services in the codebase (<code>StrategySchemaService</code>, <code>ExchangeSchemaService</code>, etc.).</p>
<p>For schema service architecture details, see <a href="design_55_fast-forward_simulation.html">Schema Services</a>.</p>
<a id="template-merging-pattern" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Template Merging Pattern<a href="#template-merging-pattern" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>The template merging pattern allows users to override specific template methods while falling back to defaults for unspecified methods. This provides flexibility without requiring complete reimplementation.</p>
<p><img src="../media/88_Optimizer_Architecture_1.svg" alt="Mermaid Diagram"></p>
<p><strong>Implementation Example:</strong></p>
<p><a href="">src/lib/services/connection/OptimizerConnectionService.ts:62-97</a></p>
<pre><code class="typescript"><span class="hl-6">const</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-7">getPrompt</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-7">rangeTest</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-7">rangeTrain</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-7">source</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">template</span><span class="hl-1">: </span><span class="hl-7">rawTemplate</span><span class="hl-1"> = {},  </span><span class="hl-5">// Partial user overrides</span><br/><span class="hl-1">  </span><span class="hl-7">callbacks</span><span class="hl-1">,</span><br/><span class="hl-1">} = </span><span class="hl-6">this</span><span class="hl-1">.</span><span class="hl-4">optimizerSchemaService</span><span class="hl-1">.</span><span class="hl-0">get</span><span class="hl-1">(</span><span class="hl-4">optimizerName</span><span class="hl-1">);</span><br/><br/><span class="hl-5">// Merge with defaults</span><br/><span class="hl-6">const</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-7">getAssistantMessage</span><span class="hl-1"> = </span><span class="hl-6">this</span><span class="hl-1">.</span><span class="hl-4">optimizerTemplateService</span><span class="hl-1">.</span><span class="hl-4">getAssistantMessage</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-7">getExchangeTemplate</span><span class="hl-1"> = </span><span class="hl-6">this</span><span class="hl-1">.</span><span class="hl-4">optimizerTemplateService</span><span class="hl-1">.</span><span class="hl-4">getExchangeTemplate</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-5">// ... 9 more methods</span><br/><span class="hl-1">} = </span><span class="hl-4">rawTemplate</span><span class="hl-1">;</span><br/><br/><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">template</span><span class="hl-1">: </span><span class="hl-10">IOptimizerTemplate</span><span class="hl-1"> = {</span><br/><span class="hl-1">  </span><span class="hl-4">getAssistantMessage</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">getExchangeTemplate</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-5">// ... complete object with all 11 methods</span><br/><span class="hl-1">};</span>
</code><button type="button">Copy</button></pre>

<p>This pattern ensures:</p>
<ol>
<li>Users only specify overrides for methods they want to customize</li>
<li>All methods are guaranteed to have implementations</li>
<li>Type safety is maintained through <code>IOptimizerTemplate</code> interface</li>
<li>No runtime errors from missing template methods</li>
</ol>
<a id="execution-flow" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Execution Flow<a href="#execution-flow" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><a id="getdata-method-flow" class="tsd-anchor"></a><h3 class="tsd-anchor-link">getData Method Flow<a href="#getdata-method-flow" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>The <code>getData</code> method collects data from all configured sources and builds LLM conversation histories for strategy generation.</p>
<p><img src="../media/88_Optimizer_Architecture_2.svg" alt="Mermaid Diagram"></p>
<p><strong>Key Steps:</strong></p>
<ol>
<li><strong>Progress Initialization</strong>: Calculate <code>totalSources = rangeTrain.length * source.length</code> <a href="">src/client/ClientOptimizer.ts:101-102</a></li>
<li><strong>Range Iteration</strong>: For each training range, create a fresh <code>messageList</code> <a href="">src/client/ClientOptimizer.ts:104-105</a></li>
<li><strong>Source Processing</strong>: For each source, emit progress, paginate data, format messages <a href="">src/client/ClientOptimizer.ts:107-186</a></li>
<li><strong>Pagination</strong>: Use <code>iterateDocuments</code> from <code>functools-kit</code> with <code>distinctDocuments</code> for deduplication <a href="">src/client/ClientOptimizer.ts:70-88</a></li>
<li><strong>Message Formatting</strong>: Call user/assistant formatters, append to conversation history <a href="">src/client/ClientOptimizer.ts:132-145</a></li>
<li><strong>Strategy Generation</strong>: Call <code>getPrompt()</code> with complete message history <a href="">src/client/ClientOptimizer.ts:196</a></li>
<li><strong>Callback Execution</strong>: Invoke <code>onData</code> callback if provided <a href="">src/client/ClientOptimizer.ts:210-212</a></li>
</ol>
<a id="getcode-method-flow" class="tsd-anchor"></a><h3 class="tsd-anchor-link">getCode Method Flow<a href="#getcode-method-flow" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>The <code>getCode</code> method assembles executable strategy code from 11 template sections in a specific order.</p>
<p><img src="../media/88_Optimizer_Architecture_3.svg" alt="Mermaid Diagram"></p>
<p><strong>Section Assembly Order:</strong></p>
<p>The code generation follows a strict 11-section sequence defined in <a href="">src/client/ClientOptimizer.ts:225-350</a>:</p>
<table>
<thead>
<tr>
<th>Section</th>
<th>Lines</th>
<th>Template Method</th>
<th>Output</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>233-236</td>
<td><code>getTopBanner</code></td>
<td>Shebang, imports (ollama, ccxt, backtest-kit), WARN_KB constant</td>
</tr>
<tr>
<td>2</td>
<td>239-242</td>
<td><code>getJsonDumpTemplate</code></td>
<td><code>dumpJson(resultId, history, result)</code> debug function</td>
</tr>
<tr>
<td>3</td>
<td>245-248</td>
<td><code>getTextTemplate</code></td>
<td><code>text(messages)</code> LLM text helper with deepseek-v3.1</td>
</tr>
<tr>
<td>4</td>
<td>250-253</td>
<td><code>getJsonTemplate</code></td>
<td><code>json(messages)</code> LLM structured output helper</td>
</tr>
<tr>
<td>5</td>
<td>256-264</td>
<td><code>getExchangeTemplate</code></td>
<td><code>addExchange()</code> with CCXT Binance</td>
</tr>
<tr>
<td>6</td>
<td>267-282</td>
<td><code>getFrameTemplate</code> (loop)</td>
<td><code>addFrame()</code> for each training range</td>
</tr>
<tr>
<td>7</td>
<td>285-297</td>
<td><code>getFrameTemplate</code></td>
<td><code>addFrame()</code> for testing range</td>
</tr>
<tr>
<td>8</td>
<td>300-314</td>
<td><code>getStrategyTemplate</code> (loop)</td>
<td><code>addStrategy()</code> for each generated strategy</td>
</tr>
<tr>
<td>9</td>
<td>317-332</td>
<td><code>getWalkerTemplate</code></td>
<td><code>addWalker()</code> configuration</td>
</tr>
<tr>
<td>10</td>
<td>335-341</td>
<td><code>getLauncherTemplate</code></td>
<td><code>Walker.background()</code> + event listeners</td>
</tr>
<tr>
<td>11</td>
<td>-</td>
<td>-</td>
<td>Final join with newlines</td>
</tr>
</tbody>
</table>
<p><strong>Naming Convention:</strong></p>
<p>Generated code uses a random prefix to avoid naming collisions:</p>
<ul>
<li>Exchange: <code>{prefix}_exchange</code></li>
<li>Training frames: <code>{prefix}_train_frame-1</code>, <code>{prefix}_train_frame-2</code>, ...</li>
<li>Test frame: <code>{prefix}_test_frame</code></li>
<li>Strategies: <code>{prefix}_strategy-1</code>, <code>{prefix}_strategy-2</code>, ...</li>
<li>Walker: <code>{prefix}_walker</code></li>
</ul>
<p>The prefix is generated via <code>CREATE_PREFIX_FN()</code> using base36 encoding <a href="">src/client/ClientOptimizer.ts:22</a>.</p>
<a id="dump-method-flow" class="tsd-anchor"></a><h3 class="tsd-anchor-link">dump Method Flow<a href="#dump-method-flow" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>The <code>dump</code> method saves generated code to the file system with error handling and callbacks.</p>
<p><img src="../media/88_Optimizer_Architecture_4.svg" alt="Mermaid Diagram"></p>
<p><strong>File Path Construction:</strong></p>
<p>The dump method constructs file paths using the following pattern <a href="">src/client/ClientOptimizer.ts:367-373</a>:</p>
<pre><code class="typescript"><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">dir</span><span class="hl-1"> = </span><span class="hl-0">join</span><span class="hl-1">(</span><span class="hl-4">process</span><span class="hl-1">.</span><span class="hl-0">cwd</span><span class="hl-1">(), </span><span class="hl-4">path</span><span class="hl-1">);</span><br/><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-0">mkdir</span><span class="hl-1">(</span><span class="hl-4">dir</span><span class="hl-1">, { </span><span class="hl-4">recursive:</span><span class="hl-1"> </span><span class="hl-6">true</span><span class="hl-1"> });</span><br/><br/><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">filename</span><span class="hl-1"> = </span><span class="hl-2">`</span><span class="hl-6">${</span><span class="hl-4">self</span><span class="hl-9">.</span><span class="hl-4">params</span><span class="hl-9">.</span><span class="hl-4">optimizerName</span><span class="hl-6">}</span><span class="hl-2">_</span><span class="hl-6">${</span><span class="hl-4">symbol</span><span class="hl-6">}</span><span class="hl-2">.mjs`</span><span class="hl-1">;</span><br/><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">filepath</span><span class="hl-1"> = </span><span class="hl-0">join</span><span class="hl-1">(</span><span class="hl-4">dir</span><span class="hl-1">, </span><span class="hl-4">filename</span><span class="hl-1">);</span>
</code><button type="button">Copy</button></pre>

<p><strong>Example Output:</strong> If <code>optimizerName = &quot;trend_analyzer&quot;</code> and <code>symbol = &quot;BTCUSDT&quot;</code>, with <code>path = &quot;./strategies&quot;</code>, the file would be saved to:</p>
<pre><code><span class="hl-1">{</span><span class="hl-4">cwd</span><span class="hl-1">}/</span><span class="hl-4">strategies</span><span class="hl-1">/</span><span class="hl-4">trend_analyzer_BTCUSDT</span><span class="hl-1">.</span><span class="hl-4">mjs</span>
</code><button>Copy</button></pre>

<p><strong>Error Handling:</strong></p>
<p>The dump operation includes comprehensive error handling:</p>
<ol>
<li>Directory creation with <code>recursive: true</code> flag (creates parent directories if needed)</li>
<li>Try-catch wrapper around file write operation</li>
<li>Logger warning on failure with error details</li>
<li>Error re-throw to allow upstream handling</li>
</ol>
<p><strong>Callbacks:</strong></p>
<p>The dump method supports an optional <code>onDump</code> callback that executes after successful file write <a href="">src/client/ClientOptimizer.ts:377-379</a>:</p>
<pre><code class="typescript"><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-4">self</span><span class="hl-1">.</span><span class="hl-4">params</span><span class="hl-1">.</span><span class="hl-4">callbacks</span><span class="hl-1">?.</span><span class="hl-4">onDump</span><span class="hl-1">) {</span><br/><span class="hl-1">  </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-4">self</span><span class="hl-1">.</span><span class="hl-4">params</span><span class="hl-1">.</span><span class="hl-4">callbacks</span><span class="hl-1">.</span><span class="hl-0">onDump</span><span class="hl-1">(</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">filepath</span><span class="hl-1">);</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<p>This enables custom post-processing such as:</p>
<ul>
<li>Notification systems</li>
<li>File permission adjustment</li>
<li>Git commit automation</li>
<li>Remote file upload</li>
</ul>
<a id="dependency-injection-and-service-registration" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Dependency Injection and Service Registration<a href="#dependency-injection-and-service-registration" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>The Optimizer system integrates with the broader dependency injection architecture through standard TYPES symbols and service registration.</p>
<p><strong>TYPES Symbols:</strong></p>
<p>The following symbols identify Optimizer-related services in the dependency injection container:</p>
<ul>
<li><code>TYPES.optimizerSchemaService</code> - Schema registry service</li>
<li><code>TYPES.optimizerConnectionService</code> - Connection service with memoized client instances</li>
<li><code>TYPES.optimizerTemplateService</code> - Default template implementation</li>
</ul>
<p><strong>Service Composition:</strong></p>
<p><img src="../media/88_Optimizer_Architecture_5.svg" alt="Mermaid Diagram"></p>
<p>The Optimizer services follow the same dependency injection pattern as other framework components. For comprehensive coverage of the DI system, see <a href="design_11_dependency_injection_system.html">Dependency Injection System</a>.</p>
</div></div><div class="col-sidebar"><div class="page-menu"><div class="tsd-navigation settings"><details class="tsd-accordion"><summary class="tsd-accordion-summary"><h3><svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-chevronDown"></use></svg>Settings</h3></summary><div class="tsd-accordion-details"><div class="tsd-filter-visibility"><span class="settings-label">Member Visibility</span><ul id="tsd-filter-options"><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-protected" name="protected"/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Protected</span></label></li><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-inherited" name="inherited" checked/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Inherited</span></label></li><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-external" name="external"/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>External</span></label></li></ul></div><div class="tsd-theme-toggle"><label class="settings-label" for="tsd-theme">Theme</label><select id="tsd-theme"><option value="os">OS</option><option value="light">Light</option><option value="dark">Dark</option></select></div></div></details></div><details open class="tsd-accordion tsd-page-navigation"><summary class="tsd-accordion-summary"><h3><svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-chevronDown"></use></svg>On This Page</h3></summary><div class="tsd-accordion-details"><a href="#optimizer-architecture"><span>Optimizer <wbr/>Architecture</span></a><ul><li><a href="#purpose-and-scope"><span>Purpose and <wbr/>Scope</span></a></li><li><a href="#component-overview"><span>Component <wbr/>Overview</span></a></li><li><a href="#core-components"><span>Core <wbr/>Components</span></a></li><li><ul><li><a href="#clientoptimizer"><span>Client<wbr/>Optimizer</span></a></li><li><a href="#optimizerconnectionservice"><span>Optimizer<wbr/>Connection<wbr/>Service</span></a></li><li><a href="#optimizertemplateservice"><span>Optimizer<wbr/>Template<wbr/>Service</span></a></li><li><a href="#optimizerschemaservice"><span>Optimizer<wbr/>Schema<wbr/>Service</span></a></li></ul></li><li><a href="#template-merging-pattern"><span>Template <wbr/>Merging <wbr/>Pattern</span></a></li><li><a href="#execution-flow"><span>Execution <wbr/>Flow</span></a></li><li><ul><li><a href="#getdata-method-flow"><span>get<wbr/>Data <wbr/>Method <wbr/>Flow</span></a></li><li><a href="#getcode-method-flow"><span>get<wbr/>Code <wbr/>Method <wbr/>Flow</span></a></li><li><a href="#dump-method-flow"><span>dump <wbr/>Method <wbr/>Flow</span></a></li></ul></li><li><a href="#dependency-injection-and-service-registration"><span>Dependency <wbr/>Injection and <wbr/>Service <wbr/>Registration</span></a></li></ul></div></details></div><div class="site-menu"><nav class="tsd-navigation"><a href="../modules.html">backtest-kit</a><ul class="tsd-small-nested-navigation" id="tsd-nav-container"><li>Loading...</li></ul></nav></div></div></div><footer><p class="tsd-generator">Generated using <a href="https://typedoc.org/" target="_blank">TypeDoc</a></p></footer><div class="overlay"></div></body></html>

<!-- Yandex.Metrika counter -->
<script type="text/javascript">
    (function(m,e,t,r,i,k,a){
        m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
        m[i].l=1*new Date();
        for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }}
        k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)
    })(window, document,'script','https://mc.yandex.ru/metrika/tag.js?id=105455585', 'ym');

    ym(105455585, 'init', {ssr:true, webvisor:true, clickmap:true, ecommerce:"dataLayer", accurateTrackBounce:true, trackLinks:true});
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/105455585" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
<!-- /Yandex.Metrika counter -->

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-3MQZEBBDDR"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-3MQZEBBDDR');
</script>
