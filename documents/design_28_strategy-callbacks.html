<!DOCTYPE html><html class="default" lang="en" data-base=".."><head><meta charset="utf-8"/><meta http-equiv="x-ua-compatible" content="IE=edge"/><title>design/28_strategy-callbacks | backtest-kit</title><meta name="description" content="Documentation for backtest-kit"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="stylesheet" href="../assets/style.css"/><link rel="stylesheet" href="../assets/highlight.css"/><script defer src="../assets/main.js"></script><script async src="../assets/icons.js" id="tsd-icons-script"></script><script async src="../assets/search.js" id="tsd-search-script"></script><script async src="../assets/navigation.js" id="tsd-nav-script"></script><script async src="../assets/hierarchy.js" id="tsd-hierarchy-script"></script></head><body><script>document.documentElement.dataset.theme = localStorage.getItem("tsd-theme") || "os";document.body.style.display="none";setTimeout(() => app?app.showPage():document.body.style.removeProperty("display"),500)</script><header class="tsd-page-toolbar"><div class="tsd-toolbar-contents container"><div class="table-cell" id="tsd-search"><div class="field"><label for="tsd-search-field" class="tsd-widget tsd-toolbar-icon search no-caption"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-search"></use></svg></label><input type="text" id="tsd-search-field" aria-label="Search"/></div><div class="field"><div id="tsd-toolbar-links"></div></div><ul class="results"><li class="state loading">Preparing search index...</li><li class="state failure">The search index is not available</li></ul><a href="../index.html" class="title">backtest-kit</a></div><div class="table-cell" id="tsd-widgets"><a href="#" class="tsd-widget tsd-toolbar-icon menu no-caption" data-toggle="menu" aria-label="Menu"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-menu"></use></svg></a></div></div></header><div class="container container-main"><div class="col-content"><div class="tsd-page-title"><ul class="tsd-breadcrumb"><li><a href="../modules.html">backtest-kit</a></li><li><a href="design_28_strategy-callbacks.html">design/28_strategy-callbacks</a></li></ul></div><div class="tsd-panel tsd-typography"><a id="strategy-callbacks" class="tsd-anchor"></a><h1 class="tsd-anchor-link">Strategy Callbacks<a href="#strategy-callbacks" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h1><p>This page documents the <code>IStrategyCallbacks</code> interface and its lifecycle hooks for monitoring and responding to signal state changes. Strategy callbacks provide optional event handlers that execute synchronously during strategy execution, enabling custom logging, notifications, and state management. For information about the broader signal lifecycle and state machine, see <a href="design_08_core-concepts.html">Signals &amp; Signal Lifecycle</a>. For details on the asynchronous event system that complements callbacks, see <a href="design_40_reporting-monitoring.html">Event Listeners</a>.</p>
<hr>
<a id="overview" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Overview<a href="#overview" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>The <code>IStrategyCallbacks</code> interface defines 10 optional lifecycle hooks that fire during signal state transitions. Callbacks are registered via the <code>callbacks</code> field in <code>IStrategySchema</code> when calling <code>addStrategy()</code>. Unlike the global event emitter system, callbacks are strategy-specific and execute inline during signal processing.</p>
<p><strong>Key Characteristics:</strong></p>
<ul>
<li>Optionalâ€”all callbacks default to no-op if not provided</li>
<li>Synchronous execution within the strategy tick cycle</li>
<li>Scoped to the specific strategy instance</li>
<li>Receives both backtest and live mode events</li>
</ul>
<hr>
<a id="istrategycallbacks-interface-structure" class="tsd-anchor"></a><h2 class="tsd-anchor-link">IStrategyCallbacks Interface Structure<a href="#istrategycallbacks-interface-structure" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p><img src="../media/28_strategy-callbacks_0.svg" alt="Mermaid Diagram"></p>
<hr>
<a id="callback-lifecycle-hooks" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Callback Lifecycle Hooks<a href="#callback-lifecycle-hooks" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><a id="ontick" class="tsd-anchor"></a><h3 class="tsd-anchor-link">onTick<a href="#ontick" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Called on every tick with the complete tick result, regardless of signal state. This is the most frequently invoked callback and executes before any other callbacks in the same tick.</p>
<p><strong>Signature:</strong></p>
<pre><code class="typescript"><span class="hl-10">onTick</span><span class="hl-1">: (</span><span class="hl-4">symbol</span><span class="hl-1">: </span><span class="hl-13">string</span><span class="hl-1">, </span><span class="hl-4">result</span><span class="hl-1">: </span><span class="hl-13">IStrategyTickResult</span><span class="hl-1">, </span><span class="hl-4">backtest</span><span class="hl-1">: </span><span class="hl-13">boolean</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> </span><span class="hl-7">void</span>
</code><button type="button">Copy</button></pre>

<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Parameter</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>symbol</code></td>
<td><code>string</code></td>
<td>Trading pair (e.g., &quot;BTCUSDT&quot;)</td>
</tr>
<tr>
<td><code>result</code></td>
<td><code>IStrategyTickResult</code></td>
<td>Discriminated union of tick results</td>
</tr>
<tr>
<td><code>backtest</code></td>
<td><code>boolean</code></td>
<td><code>true</code> for backtest mode, <code>false</code> for live</td>
</tr>
</tbody>
</table>
<p><strong>Use Cases:</strong></p>
<ul>
<li>Comprehensive tick-by-tick logging</li>
<li>Custom metrics collection</li>
<li>Real-time monitoring dashboards</li>
</ul>
<p><strong>Invocation Points:</strong></p>
<ul>
<li><code>src/client/ClientStrategy.ts:599-606</code> - After scheduled signal timeout cancellation</li>
<li><code>src/client/ClientStrategy.ts:765-772</code> - After scheduled signal activation</li>
<li><code>src/client/ClientStrategy.ts:792-799</code> - During scheduled signal monitoring</li>
</ul>
<hr>
<a id="onopen" class="tsd-anchor"></a><h3 class="tsd-anchor-link">onOpen<a href="#onopen" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Called immediately after a signal is validated, persisted, and becomes active. This hook fires <strong>after</strong> risk validation passes but <strong>before</strong> the signal enters active monitoring.</p>
<p><strong>Signature:</strong></p>
<pre><code class="typescript"><span class="hl-10">onOpen</span><span class="hl-1">: (</span><span class="hl-4">symbol</span><span class="hl-1">: </span><span class="hl-13">string</span><span class="hl-1">, </span><span class="hl-4">data</span><span class="hl-1">: </span><span class="hl-13">ISignalRow</span><span class="hl-1">, </span><span class="hl-4">currentPrice</span><span class="hl-1">: </span><span class="hl-13">number</span><span class="hl-1">, </span><span class="hl-4">backtest</span><span class="hl-1">: </span><span class="hl-13">boolean</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> </span><span class="hl-7">void</span>
</code><button type="button">Copy</button></pre>

<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Parameter</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>symbol</code></td>
<td><code>string</code></td>
<td>Trading pair</td>
</tr>
<tr>
<td><code>data</code></td>
<td><code>ISignalRow</code></td>
<td>Complete signal with generated ID</td>
</tr>
<tr>
<td><code>currentPrice</code></td>
<td><code>number</code></td>
<td>VWAP price at signal open</td>
</tr>
<tr>
<td><code>backtest</code></td>
<td><code>boolean</code></td>
<td>Execution mode flag</td>
</tr>
</tbody>
</table>
<p><strong>Use Cases:</strong></p>
<ul>
<li>Send trade entry notifications</li>
<li>Log position opening to external systems</li>
<li>Update portfolio tracking</li>
</ul>
<p><strong>Invocation Points:</strong></p>
<ul>
<li><code>src/client/ClientStrategy.ts:747-754</code> - After scheduled signal activation</li>
<li><code>src/client/ClientStrategy.ts:862-869</code> - After immediate signal creation</li>
</ul>
<hr>
<a id="onactive" class="tsd-anchor"></a><h3 class="tsd-anchor-link">onActive<a href="#onactive" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Called during each tick while a signal is being monitored (TP/SL checks). This callback executes repeatedly until the signal closes.</p>
<p><strong>Signature:</strong></p>
<pre><code class="typescript"><span class="hl-10">onActive</span><span class="hl-1">: (</span><span class="hl-4">symbol</span><span class="hl-1">: </span><span class="hl-13">string</span><span class="hl-1">, </span><span class="hl-4">data</span><span class="hl-1">: </span><span class="hl-13">ISignalRow</span><span class="hl-1">, </span><span class="hl-4">currentPrice</span><span class="hl-1">: </span><span class="hl-13">number</span><span class="hl-1">, </span><span class="hl-4">backtest</span><span class="hl-1">: </span><span class="hl-13">boolean</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> </span><span class="hl-7">void</span>
</code><button type="button">Copy</button></pre>

<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Parameter</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>symbol</code></td>
<td><code>string</code></td>
<td>Trading pair</td>
</tr>
<tr>
<td><code>data</code></td>
<td><code>ISignalRow</code></td>
<td>Active signal being monitored</td>
</tr>
<tr>
<td><code>currentPrice</code></td>
<td><code>number</code></td>
<td>Current VWAP price</td>
</tr>
<tr>
<td><code>backtest</code></td>
<td><code>boolean</code></td>
<td>Execution mode flag</td>
</tr>
</tbody>
</table>
<p><strong>Use Cases:</strong></p>
<ul>
<li>Track unrealized PNL changes</li>
<li>Monitor distance to TP/SL</li>
<li>Update live dashboards with active position status</li>
</ul>
<p><strong>Invocation Points:</strong></p>
<ul>
<li><code>src/client/ClientStrategy.ts:512-522</code> - During crash recovery initialization</li>
<li><code>src/client/ClientStrategy.ts:906-916</code> - During active signal monitoring in tick()</li>
</ul>
<hr>
<a id="onidle" class="tsd-anchor"></a><h3 class="tsd-anchor-link">onIdle<a href="#onidle" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Called when no active or scheduled signal exists for the strategy-symbol pair. This indicates the strategy is waiting to generate a new signal.</p>
<p><strong>Signature:</strong></p>
<pre><code class="typescript"><span class="hl-10">onIdle</span><span class="hl-1">: (</span><span class="hl-4">symbol</span><span class="hl-1">: </span><span class="hl-13">string</span><span class="hl-1">, </span><span class="hl-4">currentPrice</span><span class="hl-1">: </span><span class="hl-13">number</span><span class="hl-1">, </span><span class="hl-4">backtest</span><span class="hl-1">: </span><span class="hl-13">boolean</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> </span><span class="hl-7">void</span>
</code><button type="button">Copy</button></pre>

<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Parameter</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>symbol</code></td>
<td><code>string</code></td>
<td>Trading pair</td>
</tr>
<tr>
<td><code>currentPrice</code></td>
<td><code>number</code></td>
<td>Current VWAP price</td>
</tr>
<tr>
<td><code>backtest</code></td>
<td><code>boolean</code></td>
<td>Execution mode flag</td>
</tr>
</tbody>
</table>
<p><strong>Use Cases:</strong></p>
<ul>
<li>Log idle state for monitoring</li>
<li>Track strategy inactivity periods</li>
<li>Trigger alerts if idle too long</li>
</ul>
<p><strong>Invocation Points:</strong></p>
<ul>
<li><code>src/client/ClientStrategy.ts:924-936</code> - When no signal exists during tick()</li>
</ul>
<hr>
<a id="onclose" class="tsd-anchor"></a><h3 class="tsd-anchor-link">onClose<a href="#onclose" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Called when a signal completes (take profit, stop loss, or time expiration). This is the final lifecycle hook for a successful signal.</p>
<p><strong>Signature:</strong></p>
<pre><code class="typescript"><span class="hl-10">onClose</span><span class="hl-1">: (</span><span class="hl-4">symbol</span><span class="hl-1">: </span><span class="hl-13">string</span><span class="hl-1">, </span><span class="hl-4">data</span><span class="hl-1">: </span><span class="hl-13">ISignalRow</span><span class="hl-1">, </span><span class="hl-4">priceClose</span><span class="hl-1">: </span><span class="hl-13">number</span><span class="hl-1">, </span><span class="hl-4">backtest</span><span class="hl-1">: </span><span class="hl-13">boolean</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> </span><span class="hl-7">void</span>
</code><button type="button">Copy</button></pre>

<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Parameter</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>symbol</code></td>
<td><code>string</code></td>
<td>Trading pair</td>
</tr>
<tr>
<td><code>data</code></td>
<td><code>ISignalRow</code></td>
<td>Closed signal with full history</td>
</tr>
<tr>
<td><code>priceClose</code></td>
<td><code>number</code></td>
<td>Final exit price (VWAP)</td>
</tr>
<tr>
<td><code>backtest</code></td>
<td><code>boolean</code></td>
<td>Execution mode flag</td>
</tr>
</tbody>
</table>
<p><strong>Use Cases:</strong></p>
<ul>
<li>Send trade exit notifications</li>
<li>Calculate and log realized PNL</li>
<li>Update external tracking systems</li>
</ul>
<p><strong>Invocation Points:</strong></p>
<ul>
<li><code>src/client/ClientStrategy.ts:988-998</code> - After signal closes via TP/SL/time</li>
</ul>
<hr>
<a id="onschedule" class="tsd-anchor"></a><h3 class="tsd-anchor-link">onSchedule<a href="#onschedule" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Called when a scheduled signal (limit order) is created. This occurs when <code>getSignal</code> returns a signal with <code>priceOpen</code> specified and the current price has not yet reached the entry level.</p>
<p><strong>Signature:</strong></p>
<pre><code class="typescript"><span class="hl-10">onSchedule</span><span class="hl-1">: (</span><span class="hl-4">symbol</span><span class="hl-1">: </span><span class="hl-13">string</span><span class="hl-1">, </span><span class="hl-4">data</span><span class="hl-1">: </span><span class="hl-13">IScheduledSignalRow</span><span class="hl-1">, </span><span class="hl-4">currentPrice</span><span class="hl-1">: </span><span class="hl-13">number</span><span class="hl-1">, </span><span class="hl-4">backtest</span><span class="hl-1">: </span><span class="hl-13">boolean</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> </span><span class="hl-7">void</span>
</code><button type="button">Copy</button></pre>

<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Parameter</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>symbol</code></td>
<td><code>string</code></td>
<td>Trading pair</td>
</tr>
<tr>
<td><code>data</code></td>
<td><code>IScheduledSignalRow</code></td>
<td>Scheduled signal awaiting activation</td>
</tr>
<tr>
<td><code>currentPrice</code></td>
<td><code>number</code></td>
<td>Current VWAP price</td>
</tr>
<tr>
<td><code>backtest</code></td>
<td><code>boolean</code></td>
<td>Execution mode flag</td>
</tr>
</tbody>
</table>
<p><strong>Use Cases:</strong></p>
<ul>
<li>Log pending limit orders</li>
<li>Track scheduled signal lifetime</li>
<li>Monitor price distance to activation</li>
</ul>
<p><strong>Invocation Points:</strong></p>
<ul>
<li><code>src/client/ClientStrategy.ts:540-550</code> - During crash recovery for persisted scheduled signals</li>
<li><code>src/client/ClientStrategy.ts:827-837</code> - After scheduled signal creation</li>
</ul>
<hr>
<a id="oncancel" class="tsd-anchor"></a><h3 class="tsd-anchor-link">onCancel<a href="#oncancel" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Called when a scheduled signal is cancelled without opening a position. Cancellation occurs when the signal times out or the stop loss is hit before activation.</p>
<p><strong>Signature:</strong></p>
<pre><code class="typescript"><span class="hl-10">onCancel</span><span class="hl-1">: (</span><span class="hl-4">symbol</span><span class="hl-1">: </span><span class="hl-13">string</span><span class="hl-1">, </span><span class="hl-4">data</span><span class="hl-1">: </span><span class="hl-13">IScheduledSignalRow</span><span class="hl-1">, </span><span class="hl-4">currentPrice</span><span class="hl-1">: </span><span class="hl-13">number</span><span class="hl-1">, </span><span class="hl-4">backtest</span><span class="hl-1">: </span><span class="hl-13">boolean</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> </span><span class="hl-7">void</span>
</code><button type="button">Copy</button></pre>

<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Parameter</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>symbol</code></td>
<td><code>string</code></td>
<td>Trading pair</td>
</tr>
<tr>
<td><code>data</code></td>
<td><code>IScheduledSignalRow</code></td>
<td>Cancelled scheduled signal</td>
</tr>
<tr>
<td><code>currentPrice</code></td>
<td><code>number</code></td>
<td>Current VWAP price</td>
</tr>
<tr>
<td><code>backtest</code></td>
<td><code>boolean</code></td>
<td>Execution mode flag</td>
</tr>
</tbody>
</table>
<p><strong>Use Cases:</strong></p>
<ul>
<li>Log failed limit orders</li>
<li>Track cancellation reasons (timeout vs SL)</li>
<li>Analyze scheduled signal success rate</li>
</ul>
<p><strong>Invocation Points:</strong></p>
<ul>
<li><code>src/client/ClientStrategy.ts:580-587</code> - After scheduled signal timeout</li>
<li>Implicitly during scheduled signal SL breach (before activation)</li>
</ul>
<hr>
<a id="onwrite" class="tsd-anchor"></a><h3 class="tsd-anchor-link">onWrite<a href="#onwrite" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Called whenever a signal is written to persistence storage. This is primarily used for testing and debugging persistence logic. In backtest mode, this callback is typically not invoked since signals are not persisted.</p>
<p><strong>Signature:</strong></p>
<pre><code class="typescript"><span class="hl-10">onWrite</span><span class="hl-1">: (</span><span class="hl-4">symbol</span><span class="hl-1">: </span><span class="hl-13">string</span><span class="hl-1">, </span><span class="hl-4">data</span><span class="hl-1">: </span><span class="hl-13">ISignalRow</span><span class="hl-1"> | </span><span class="hl-13">null</span><span class="hl-1">, </span><span class="hl-4">backtest</span><span class="hl-1">: </span><span class="hl-13">boolean</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> </span><span class="hl-7">void</span>
</code><button type="button">Copy</button></pre>

<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Parameter</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>symbol</code></td>
<td><code>string</code></td>
<td>Trading pair</td>
</tr>
<tr>
<td><code>data</code></td>
<td><code>ISignalRow | null</code></td>
<td>Signal being written, or <code>null</code> for deletion</td>
</tr>
<tr>
<td><code>backtest</code></td>
<td><code>boolean</code></td>
<td>Execution mode flag</td>
</tr>
</tbody>
</table>
<p><strong>Use Cases:</strong></p>
<ul>
<li>Test persistence adapter behavior</li>
<li>Debug signal serialization issues</li>
<li>Audit persistence operations</li>
</ul>
<p><strong>Invocation Points:</strong></p>
<ul>
<li><code>src/client/ClientStrategy.ts:1029-1053</code> - In <code>setPendingSignal</code> method</li>
<li><code>src/client/ClientStrategy.ts:1055-1079</code> - In <code>setScheduledSignal</code> method</li>
</ul>
<hr>
<a id="onpartialprofit" class="tsd-anchor"></a><h3 class="tsd-anchor-link">onPartialProfit<a href="#onpartialprofit" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Called when a signal reaches a profit milestone (10%, 20%, 30%, etc.) without hitting take profit. This enables tracking of unrealized gains during position monitoring.</p>
<p><strong>Signature:</strong></p>
<pre><code class="typescript"><span class="hl-10">onPartialProfit</span><span class="hl-1">: (</span><span class="hl-4">symbol</span><span class="hl-1">: </span><span class="hl-13">string</span><span class="hl-1">, </span><span class="hl-4">data</span><span class="hl-1">: </span><span class="hl-13">ISignalRow</span><span class="hl-1">, </span><span class="hl-4">currentPrice</span><span class="hl-1">: </span><span class="hl-13">number</span><span class="hl-1">, </span><span class="hl-4">revenuePercent</span><span class="hl-1">: </span><span class="hl-13">number</span><span class="hl-1">, </span><span class="hl-4">backtest</span><span class="hl-1">: </span><span class="hl-13">boolean</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> </span><span class="hl-7">void</span>
</code><button type="button">Copy</button></pre>

<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Parameter</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>symbol</code></td>
<td><code>string</code></td>
<td>Trading pair</td>
</tr>
<tr>
<td><code>data</code></td>
<td><code>ISignalRow</code></td>
<td>Active signal in profit</td>
</tr>
<tr>
<td><code>currentPrice</code></td>
<td><code>number</code></td>
<td>Current VWAP price</td>
</tr>
<tr>
<td><code>revenuePercent</code></td>
<td><code>number</code></td>
<td>Current profit percentage (positive value)</td>
</tr>
<tr>
<td><code>backtest</code></td>
<td><code>boolean</code></td>
<td>Execution mode flag</td>
</tr>
</tbody>
</table>
<p><strong>Use Cases:</strong></p>
<ul>
<li>Send profit milestone notifications</li>
<li>Track trailing profit behavior</li>
<li>Analyze optimal exit timing</li>
</ul>
<p><strong>Invocation Points:</strong></p>
<ul>
<li>Via <code>ClientPartial.profit()</code> method during signal monitoring</li>
<li>Only emits when crossing 10%, 20%, 30%... thresholds (deduplication via Set)</li>
</ul>
<hr>
<a id="onpartialloss" class="tsd-anchor"></a><h3 class="tsd-anchor-link">onPartialLoss<a href="#onpartialloss" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Called when a signal reaches a loss milestone (10%, 20%, 30%, etc.) without hitting stop loss. This enables tracking of unrealized losses during position monitoring.</p>
<p><strong>Signature:</strong></p>
<pre><code class="typescript"><span class="hl-10">onPartialLoss</span><span class="hl-1">: (</span><span class="hl-4">symbol</span><span class="hl-1">: </span><span class="hl-13">string</span><span class="hl-1">, </span><span class="hl-4">data</span><span class="hl-1">: </span><span class="hl-13">ISignalRow</span><span class="hl-1">, </span><span class="hl-4">currentPrice</span><span class="hl-1">: </span><span class="hl-13">number</span><span class="hl-1">, </span><span class="hl-4">lossPercent</span><span class="hl-1">: </span><span class="hl-13">number</span><span class="hl-1">, </span><span class="hl-4">backtest</span><span class="hl-1">: </span><span class="hl-13">boolean</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> </span><span class="hl-7">void</span>
</code><button type="button">Copy</button></pre>

<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Parameter</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>symbol</code></td>
<td><code>string</code></td>
<td>Trading pair</td>
</tr>
<tr>
<td><code>data</code></td>
<td><code>ISignalRow</code></td>
<td>Active signal in loss</td>
</tr>
<tr>
<td><code>currentPrice</code></td>
<td><code>number</code></td>
<td>Current VWAP price</td>
</tr>
<tr>
<td><code>lossPercent</code></td>
<td><code>number</code></td>
<td>Current loss percentage (negative value)</td>
</tr>
<tr>
<td><code>backtest</code></td>
<td><code>boolean</code></td>
<td>Execution mode flag</td>
</tr>
</tbody>
</table>
<p><strong>Use Cases:</strong></p>
<ul>
<li>Send loss milestone alerts</li>
<li>Monitor drawdown risk</li>
<li>Trigger emergency exit logic</li>
</ul>
<p><strong>Invocation Points:</strong></p>
<ul>
<li>Via <code>ClientPartial.loss()</code> method during signal monitoring</li>
<li>Only emits when crossing -10%, -20%, -30%... thresholds (deduplication via Set)</li>
</ul>
<hr>
<a id="callback-invocation-flow" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Callback Invocation Flow<a href="#callback-invocation-flow" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>The following diagram shows the execution order of callbacks during different signal lifecycle transitions:</p>
<p><img src="../media/28_strategy-callbacks_1.svg" alt="Mermaid Diagram"></p>
<hr>
<a id="callbacks-vs-event-emitters" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Callbacks vs Event Emitters<a href="#callbacks-vs-event-emitters" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>Backtest Kit provides two parallel mechanisms for observing strategy behavior: <strong>callbacks</strong> (synchronous, strategy-scoped) and <strong>event emitters</strong> (asynchronous, global).</p>
<p><strong>Comparison Table:</strong></p>
<table>
<thead>
<tr>
<th>Feature</th>
<th>Callbacks (<code>IStrategyCallbacks</code>)</th>
<th>Event Emitters (<code>listenSignal*</code>)</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Scope</strong></td>
<td>Per-strategy</td>
<td>Global (all strategies)</td>
</tr>
<tr>
<td><strong>Execution</strong></td>
<td>Synchronous</td>
<td>Asynchronous (queued)</td>
</tr>
<tr>
<td><strong>Registration</strong></td>
<td>Via <code>addStrategy({ callbacks })</code></td>
<td>Via <code>listenSignal()</code> functions</td>
</tr>
<tr>
<td><strong>Filtering</strong></td>
<td>Strategy-specific by default</td>
<td>Manual filtering required</td>
</tr>
<tr>
<td><strong>Backtest Support</strong></td>
<td>Yes</td>
<td>Yes</td>
</tr>
<tr>
<td><strong>Live Support</strong></td>
<td>Yes</td>
<td>Yes</td>
</tr>
<tr>
<td><strong>Performance</strong></td>
<td>Inline (no queue overhead)</td>
<td>Queued (prevents concurrent execution)</td>
</tr>
</tbody>
</table>
<p><strong>When to Use Callbacks:</strong></p>
<ul>
<li>Strategy-specific logging or metrics</li>
<li>Inline validation or decision-making</li>
<li>Testing specific strategy behavior</li>
</ul>
<p><strong>When to Use Event Emitters:</strong></p>
<ul>
<li>Cross-strategy monitoring</li>
<li>External system integration (webhooks, databases)</li>
<li>Decoupled application architecture</li>
</ul>
<p><strong>Example: Hybrid Approach</strong></p>
<pre><code class="typescript"><span class="hl-0">addStrategy</span><span class="hl-1">({</span><br/><span class="hl-1">  </span><span class="hl-4">strategyName:</span><span class="hl-1"> </span><span class="hl-2">&#39;my-strategy&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">interval:</span><span class="hl-1"> </span><span class="hl-2">&#39;5m&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-0">getSignal</span><span class="hl-4">:</span><span class="hl-1"> </span><span class="hl-7">async</span><span class="hl-1"> (</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">when</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> { </span><span class="hl-5">/* ... */</span><span class="hl-1"> },</span><br/><span class="hl-1">  </span><span class="hl-4">callbacks:</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-5">// Strategy-specific inline logging</span><br/><span class="hl-1">    </span><span class="hl-0">onOpen</span><span class="hl-4">:</span><span class="hl-1"> (</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">data</span><span class="hl-1">, </span><span class="hl-4">price</span><span class="hl-1">, </span><span class="hl-4">backtest</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">      </span><span class="hl-4">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-2">`[</span><span class="hl-7">${</span><span class="hl-4">data</span><span class="hl-9">.</span><span class="hl-4">strategyName</span><span class="hl-7">}</span><span class="hl-2">] Opened at </span><span class="hl-7">${</span><span class="hl-4">price</span><span class="hl-7">}</span><span class="hl-2">`</span><span class="hl-1">);</span><br/><span class="hl-1">    },</span><br/><span class="hl-1">    </span><span class="hl-0">onClose</span><span class="hl-4">:</span><span class="hl-1"> (</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">data</span><span class="hl-1">, </span><span class="hl-4">priceClose</span><span class="hl-1">, </span><span class="hl-4">backtest</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">      </span><span class="hl-4">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-2">`[</span><span class="hl-7">${</span><span class="hl-4">data</span><span class="hl-9">.</span><span class="hl-4">strategyName</span><span class="hl-7">}</span><span class="hl-2">] Closed at </span><span class="hl-7">${</span><span class="hl-4">priceClose</span><span class="hl-7">}</span><span class="hl-2">`</span><span class="hl-1">);</span><br/><span class="hl-1">    }</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">});</span><br/><br/><span class="hl-5">// Global cross-strategy monitoring</span><br/><span class="hl-0">listenSignal</span><span class="hl-1">((</span><span class="hl-4">event</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-4">event</span><span class="hl-1">.</span><span class="hl-4">action</span><span class="hl-1"> === </span><span class="hl-2">&#39;closed&#39;</span><span class="hl-1">) {</span><br/><span class="hl-1">    </span><span class="hl-5">// Send to external monitoring service</span><br/><span class="hl-1">    </span><span class="hl-0">sendToDatadog</span><span class="hl-1">({</span><br/><span class="hl-1">      </span><span class="hl-4">metric:</span><span class="hl-1"> </span><span class="hl-2">&#39;signal.closed&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">      </span><span class="hl-4">strategy:</span><span class="hl-1"> </span><span class="hl-4">event</span><span class="hl-1">.</span><span class="hl-4">strategyName</span><span class="hl-1">,</span><br/><span class="hl-1">      </span><span class="hl-4">pnl:</span><span class="hl-1"> </span><span class="hl-4">event</span><span class="hl-1">.</span><span class="hl-4">pnl</span><span class="hl-1">.</span><span class="hl-4">pnlPercentage</span><br/><span class="hl-1">    });</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">});</span>
</code><button type="button">Copy</button></pre>

<hr>
<a id="integration-with-strategyconnectionservice" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Integration with StrategyConnectionService<a href="#integration-with-strategyconnectionservice" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>The <code>StrategyConnectionService</code> acts as a router between the public API and individual <code>ClientStrategy</code> instances. Callbacks are passed through this routing layer and stored in the <code>ClientStrategy</code> instance.</p>
<p><img src="../media/28_strategy-callbacks_2.svg" alt="Mermaid Diagram"></p>
<p><strong>Key Implementation Details:</strong></p>
<ol>
<li>
<p><strong>Storage:</strong> Callbacks are stored in <code>IStrategyParams.callbacks</code> field <code>src/interfaces/Strategy.interface.ts:79-94</code></p>
</li>
<li>
<p><strong>Invocation Pattern:</strong> All callbacks use optional chaining to avoid errors if not provided:</p>
<pre><code class="typescript"><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-4">self</span><span class="hl-1">.</span><span class="hl-4">params</span><span class="hl-1">.</span><span class="hl-4">callbacks</span><span class="hl-1">?.</span><span class="hl-4">onOpen</span><span class="hl-1">) {</span><br/><span class="hl-1">  </span><span class="hl-4">self</span><span class="hl-1">.</span><span class="hl-4">params</span><span class="hl-1">.</span><span class="hl-4">callbacks</span><span class="hl-1">.</span><span class="hl-0">onOpen</span><span class="hl-1">(</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">data</span><span class="hl-1">, </span><span class="hl-4">currentPrice</span><span class="hl-1">, </span><span class="hl-4">backtest</span><span class="hl-1">);</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<p><code>src/client/ClientStrategy.ts:747-754</code></p>
</li>
<li>
<p><strong>Context Propagation:</strong> The <code>backtest</code> flag propagates from <code>ExecutionContextService</code> to callbacks, enabling mode-specific logic</p>
</li>
</ol>
<hr>
<a id="common-usage-patterns" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Common Usage Patterns<a href="#common-usage-patterns" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><a id="pattern-1-trade-execution-logging" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Pattern 1: Trade Execution Logging<a href="#pattern-1-trade-execution-logging" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><pre><code class="typescript"><span class="hl-0">addStrategy</span><span class="hl-1">({</span><br/><span class="hl-1">  </span><span class="hl-4">strategyName:</span><span class="hl-1"> </span><span class="hl-2">&#39;rsi-strategy&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">interval:</span><span class="hl-1"> </span><span class="hl-2">&#39;5m&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-0">getSignal</span><span class="hl-4">:</span><span class="hl-1"> </span><span class="hl-7">async</span><span class="hl-1"> (</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">when</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> { </span><span class="hl-5">/* ... */</span><span class="hl-1"> },</span><br/><span class="hl-1">  </span><span class="hl-4">callbacks:</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-0">onOpen</span><span class="hl-4">:</span><span class="hl-1"> (</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">data</span><span class="hl-1">, </span><span class="hl-4">price</span><span class="hl-1">, </span><span class="hl-4">backtest</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">      </span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">mode</span><span class="hl-1"> = </span><span class="hl-4">backtest</span><span class="hl-1"> ? </span><span class="hl-2">&#39;[BACKTEST]&#39;</span><span class="hl-1"> : </span><span class="hl-2">&#39;[LIVE]&#39;</span><span class="hl-1">;</span><br/><span class="hl-1">      </span><span class="hl-4">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-2">`</span><span class="hl-7">${</span><span class="hl-4">mode</span><span class="hl-7">}</span><span class="hl-2"> </span><span class="hl-7">${</span><span class="hl-4">symbol</span><span class="hl-7">}</span><span class="hl-2"> </span><span class="hl-7">${</span><span class="hl-4">data</span><span class="hl-9">.</span><span class="hl-4">position</span><span class="hl-7">}</span><span class="hl-2"> OPEN @ </span><span class="hl-7">${</span><span class="hl-4">price</span><span class="hl-7">}</span><span class="hl-2">`</span><span class="hl-1">);</span><br/><span class="hl-1">      </span><span class="hl-4">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-2">`  TP: </span><span class="hl-7">${</span><span class="hl-4">data</span><span class="hl-9">.</span><span class="hl-4">priceTakeProfit</span><span class="hl-7">}</span><span class="hl-2">, SL: </span><span class="hl-7">${</span><span class="hl-4">data</span><span class="hl-9">.</span><span class="hl-4">priceStopLoss</span><span class="hl-7">}</span><span class="hl-2">`</span><span class="hl-1">);</span><br/><span class="hl-1">    },</span><br/><span class="hl-1">    </span><span class="hl-0">onClose</span><span class="hl-4">:</span><span class="hl-1"> (</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">data</span><span class="hl-1">, </span><span class="hl-4">priceClose</span><span class="hl-1">, </span><span class="hl-4">backtest</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">      </span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">pnl</span><span class="hl-1"> = </span><span class="hl-0">calculatePnl</span><span class="hl-1">(</span><span class="hl-4">data</span><span class="hl-1">, </span><span class="hl-4">priceClose</span><span class="hl-1">);</span><br/><span class="hl-1">      </span><span class="hl-4">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-2">`</span><span class="hl-7">${</span><span class="hl-4">symbol</span><span class="hl-7">}</span><span class="hl-2"> CLOSE @ </span><span class="hl-7">${</span><span class="hl-4">priceClose</span><span class="hl-7">}</span><span class="hl-2"> | PNL: </span><span class="hl-7">${</span><span class="hl-4">pnl</span><span class="hl-7">}</span><span class="hl-2">%`</span><span class="hl-1">);</span><br/><span class="hl-1">    }</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">});</span>
</code><button type="button">Copy</button></pre>

<a id="pattern-2-unrealized-pnl-tracking" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Pattern 2: Unrealized PNL Tracking<a href="#pattern-2-unrealized-pnl-tracking" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><pre><code class="typescript"><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">unrealizedPnL</span><span class="hl-1"> = </span><span class="hl-7">new</span><span class="hl-1"> </span><span class="hl-0">Map</span><span class="hl-1">&lt;</span><span class="hl-13">string</span><span class="hl-1">, </span><span class="hl-13">number</span><span class="hl-1">&gt;();</span><br/><br/><span class="hl-0">addStrategy</span><span class="hl-1">({</span><br/><span class="hl-1">  </span><span class="hl-4">strategyName:</span><span class="hl-1"> </span><span class="hl-2">&#39;momentum-strategy&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">interval:</span><span class="hl-1"> </span><span class="hl-2">&#39;15m&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-0">getSignal</span><span class="hl-4">:</span><span class="hl-1"> </span><span class="hl-7">async</span><span class="hl-1"> (</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">when</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> { </span><span class="hl-5">/* ... */</span><span class="hl-1"> },</span><br/><span class="hl-1">  </span><span class="hl-4">callbacks:</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-0">onOpen</span><span class="hl-4">:</span><span class="hl-1"> (</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">data</span><span class="hl-1">, </span><span class="hl-4">price</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">      </span><span class="hl-4">unrealizedPnL</span><span class="hl-1">.</span><span class="hl-0">set</span><span class="hl-1">(</span><span class="hl-4">data</span><span class="hl-1">.</span><span class="hl-4">id</span><span class="hl-1">, </span><span class="hl-6">0</span><span class="hl-1">);</span><br/><span class="hl-1">    },</span><br/><span class="hl-1">    </span><span class="hl-0">onPartialProfit</span><span class="hl-4">:</span><span class="hl-1"> (</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">data</span><span class="hl-1">, </span><span class="hl-4">price</span><span class="hl-1">, </span><span class="hl-4">revenuePercent</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">      </span><span class="hl-4">unrealizedPnL</span><span class="hl-1">.</span><span class="hl-0">set</span><span class="hl-1">(</span><span class="hl-4">data</span><span class="hl-1">.</span><span class="hl-4">id</span><span class="hl-1">, </span><span class="hl-4">revenuePercent</span><span class="hl-1">);</span><br/><span class="hl-1">      </span><span class="hl-4">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-2">`Signal </span><span class="hl-7">${</span><span class="hl-4">data</span><span class="hl-9">.</span><span class="hl-4">id</span><span class="hl-7">}</span><span class="hl-2">: Unrealized +</span><span class="hl-7">${</span><span class="hl-4">revenuePercent</span><span class="hl-7">}</span><span class="hl-2">%`</span><span class="hl-1">);</span><br/><span class="hl-1">    },</span><br/><span class="hl-1">    </span><span class="hl-0">onPartialLoss</span><span class="hl-4">:</span><span class="hl-1"> (</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">data</span><span class="hl-1">, </span><span class="hl-4">price</span><span class="hl-1">, </span><span class="hl-4">lossPercent</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">      </span><span class="hl-4">unrealizedPnL</span><span class="hl-1">.</span><span class="hl-0">set</span><span class="hl-1">(</span><span class="hl-4">data</span><span class="hl-1">.</span><span class="hl-4">id</span><span class="hl-1">, </span><span class="hl-4">lossPercent</span><span class="hl-1">);</span><br/><span class="hl-1">      </span><span class="hl-4">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-2">`Signal </span><span class="hl-7">${</span><span class="hl-4">data</span><span class="hl-9">.</span><span class="hl-4">id</span><span class="hl-7">}</span><span class="hl-2">: Unrealized </span><span class="hl-7">${</span><span class="hl-4">lossPercent</span><span class="hl-7">}</span><span class="hl-2">%`</span><span class="hl-1">);</span><br/><span class="hl-1">    },</span><br/><span class="hl-1">    </span><span class="hl-0">onClose</span><span class="hl-4">:</span><span class="hl-1"> (</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">data</span><span class="hl-1">, </span><span class="hl-4">priceClose</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">      </span><span class="hl-4">unrealizedPnL</span><span class="hl-1">.</span><span class="hl-0">delete</span><span class="hl-1">(</span><span class="hl-4">data</span><span class="hl-1">.</span><span class="hl-4">id</span><span class="hl-1">);</span><br/><span class="hl-1">    }</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">});</span>
</code><button type="button">Copy</button></pre>

<a id="pattern-3-scheduled-signal-monitoring" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Pattern 3: Scheduled Signal Monitoring<a href="#pattern-3-scheduled-signal-monitoring" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><pre><code class="typescript"><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">scheduledSignals</span><span class="hl-1"> = </span><span class="hl-7">new</span><span class="hl-1"> </span><span class="hl-0">Map</span><span class="hl-1">&lt;</span><span class="hl-13">string</span><span class="hl-1">, </span><span class="hl-13">Date</span><span class="hl-1">&gt;();</span><br/><br/><span class="hl-0">addStrategy</span><span class="hl-1">({</span><br/><span class="hl-1">  </span><span class="hl-4">strategyName:</span><span class="hl-1"> </span><span class="hl-2">&#39;breakout-strategy&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">interval:</span><span class="hl-1"> </span><span class="hl-2">&#39;30m&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-0">getSignal</span><span class="hl-4">:</span><span class="hl-1"> </span><span class="hl-7">async</span><span class="hl-1"> (</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">when</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> { </span><span class="hl-5">/* ... */</span><span class="hl-1"> },</span><br/><span class="hl-1">  </span><span class="hl-4">callbacks:</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-0">onSchedule</span><span class="hl-4">:</span><span class="hl-1"> (</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">data</span><span class="hl-1">, </span><span class="hl-4">currentPrice</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">      </span><span class="hl-4">scheduledSignals</span><span class="hl-1">.</span><span class="hl-0">set</span><span class="hl-1">(</span><span class="hl-4">data</span><span class="hl-1">.</span><span class="hl-4">id</span><span class="hl-1">, </span><span class="hl-7">new</span><span class="hl-1"> </span><span class="hl-0">Date</span><span class="hl-1">(</span><span class="hl-4">data</span><span class="hl-1">.</span><span class="hl-4">scheduledAt</span><span class="hl-1">));</span><br/><span class="hl-1">      </span><span class="hl-4">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-2">`Scheduled </span><span class="hl-7">${</span><span class="hl-4">data</span><span class="hl-9">.</span><span class="hl-4">position</span><span class="hl-7">}</span><span class="hl-2"> @ </span><span class="hl-7">${</span><span class="hl-4">data</span><span class="hl-9">.</span><span class="hl-4">priceOpen</span><span class="hl-7">}</span><span class="hl-2">`</span><span class="hl-1">);</span><br/><span class="hl-1">      </span><span class="hl-4">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-2">`Current price: </span><span class="hl-7">${</span><span class="hl-4">currentPrice</span><span class="hl-7">}</span><span class="hl-2">, waiting for entry...`</span><span class="hl-1">);</span><br/><span class="hl-1">    },</span><br/><span class="hl-1">    </span><span class="hl-0">onOpen</span><span class="hl-4">:</span><span class="hl-1"> (</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">data</span><span class="hl-1">, </span><span class="hl-4">price</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">      </span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">scheduledTime</span><span class="hl-1"> = </span><span class="hl-4">scheduledSignals</span><span class="hl-1">.</span><span class="hl-0">get</span><span class="hl-1">(</span><span class="hl-4">data</span><span class="hl-1">.</span><span class="hl-4">id</span><span class="hl-1">);</span><br/><span class="hl-1">      </span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">waitTime</span><span class="hl-1"> = </span><span class="hl-4">Date</span><span class="hl-1">.</span><span class="hl-0">now</span><span class="hl-1">() - </span><span class="hl-4">scheduledTime</span><span class="hl-1">.</span><span class="hl-0">getTime</span><span class="hl-1">();</span><br/><span class="hl-1">      </span><span class="hl-4">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-2">`Signal activated after </span><span class="hl-7">${</span><span class="hl-4">waitTime</span><span class="hl-7">}</span><span class="hl-2">ms wait`</span><span class="hl-1">);</span><br/><span class="hl-1">      </span><span class="hl-4">scheduledSignals</span><span class="hl-1">.</span><span class="hl-0">delete</span><span class="hl-1">(</span><span class="hl-4">data</span><span class="hl-1">.</span><span class="hl-4">id</span><span class="hl-1">);</span><br/><span class="hl-1">    },</span><br/><span class="hl-1">    </span><span class="hl-0">onCancel</span><span class="hl-4">:</span><span class="hl-1"> (</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">data</span><span class="hl-1">, </span><span class="hl-4">currentPrice</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">      </span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">scheduledTime</span><span class="hl-1"> = </span><span class="hl-4">scheduledSignals</span><span class="hl-1">.</span><span class="hl-0">get</span><span class="hl-1">(</span><span class="hl-4">data</span><span class="hl-1">.</span><span class="hl-4">id</span><span class="hl-1">);</span><br/><span class="hl-1">      </span><span class="hl-4">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-2">`Signal cancelled before activation`</span><span class="hl-1">);</span><br/><span class="hl-1">      </span><span class="hl-4">scheduledSignals</span><span class="hl-1">.</span><span class="hl-0">delete</span><span class="hl-1">(</span><span class="hl-4">data</span><span class="hl-1">.</span><span class="hl-4">id</span><span class="hl-1">);</span><br/><span class="hl-1">    }</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">});</span>
</code><button type="button">Copy</button></pre>

<a id="pattern-4-conditional-backtest-vs-live-behavior" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Pattern 4: Conditional Backtest vs Live Behavior<a href="#pattern-4-conditional-backtest-vs-live-behavior" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><pre><code class="typescript"><span class="hl-0">addStrategy</span><span class="hl-1">({</span><br/><span class="hl-1">  </span><span class="hl-4">strategyName:</span><span class="hl-1"> </span><span class="hl-2">&#39;adaptive-strategy&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">interval:</span><span class="hl-1"> </span><span class="hl-2">&#39;5m&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-0">getSignal</span><span class="hl-4">:</span><span class="hl-1"> </span><span class="hl-7">async</span><span class="hl-1"> (</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">when</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> { </span><span class="hl-5">/* ... */</span><span class="hl-1"> },</span><br/><span class="hl-1">  </span><span class="hl-4">callbacks:</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-0">onOpen</span><span class="hl-4">:</span><span class="hl-1"> (</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">data</span><span class="hl-1">, </span><span class="hl-4">price</span><span class="hl-1">, </span><span class="hl-4">backtest</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">      </span><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-4">backtest</span><span class="hl-1">) {</span><br/><span class="hl-1">        </span><span class="hl-5">// Backtest: just log</span><br/><span class="hl-1">        </span><span class="hl-4">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-2">`Backtest signal opened: </span><span class="hl-7">${</span><span class="hl-4">data</span><span class="hl-9">.</span><span class="hl-4">id</span><span class="hl-7">}</span><span class="hl-2">`</span><span class="hl-1">);</span><br/><span class="hl-1">      } </span><span class="hl-3">else</span><span class="hl-1"> {</span><br/><span class="hl-1">        </span><span class="hl-5">// Live: send webhook notification</span><br/><span class="hl-1">        </span><span class="hl-0">fetch</span><span class="hl-1">(</span><span class="hl-2">&#39;https://api.example.com/webhooks/signal-opened&#39;</span><span class="hl-1">, {</span><br/><span class="hl-1">          </span><span class="hl-4">method:</span><span class="hl-1"> </span><span class="hl-2">&#39;POST&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">          </span><span class="hl-4">body:</span><span class="hl-1"> </span><span class="hl-8">JSON</span><span class="hl-1">.</span><span class="hl-0">stringify</span><span class="hl-1">({ </span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">price</span><span class="hl-1">, </span><span class="hl-4">position:</span><span class="hl-1"> </span><span class="hl-4">data</span><span class="hl-1">.</span><span class="hl-4">position</span><span class="hl-1"> })</span><br/><span class="hl-1">        });</span><br/><span class="hl-1">      }</span><br/><span class="hl-1">    }</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">});</span>
</code><button type="button">Copy</button></pre>

<hr>
<a id="thread-safety-and-execution-order" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Thread Safety and Execution Order<a href="#thread-safety-and-execution-order" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>Callbacks execute synchronously within the strategy tick cycle, ensuring deterministic ordering:</p>
<ol>
<li><strong>Signal state change</strong> (e.g., idle â†’ opened)</li>
<li><strong>State-specific callback</strong> (e.g., <code>onOpen</code>)</li>
<li><strong>Always execute <code>onTick</code></strong> with full result</li>
<li><strong>Return tick result</strong> to caller</li>
</ol>
<p>This ordering guarantee enables callbacks to safely modify external state before <code>onTick</code> executes. However, note that callbacks should not throw exceptionsâ€”uncaught errors will be caught by <code>trycatch</code> wrapper and logged via <code>errorEmitter</code>.</p>
<p><strong>Exception Handling:</strong></p>
<pre><code class="typescript"><span class="hl-5">// From ClientStrategy.ts GET_SIGNAL_FN wrapper</span><br/><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">GET_SIGNAL_FN</span><span class="hl-1"> = </span><span class="hl-0">trycatch</span><span class="hl-1">(</span><br/><span class="hl-1">  </span><span class="hl-7">async</span><span class="hl-1"> (</span><span class="hl-4">self</span><span class="hl-1">: </span><span class="hl-13">ClientStrategy</span><span class="hl-1">): </span><span class="hl-13">Promise</span><span class="hl-1">&lt;</span><span class="hl-13">ISignalRow</span><span class="hl-1"> | </span><span class="hl-13">null</span><span class="hl-1">&gt; </span><span class="hl-7">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-5">// ... signal generation logic</span><br/><span class="hl-1">  },</span><br/><span class="hl-1">  {</span><br/><span class="hl-1">    </span><span class="hl-4">defaultValue:</span><span class="hl-1"> </span><span class="hl-7">null</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-0">fallback</span><span class="hl-4">:</span><span class="hl-1"> (</span><span class="hl-4">error</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">      </span><span class="hl-4">backtest</span><span class="hl-1">.</span><span class="hl-4">loggerService</span><span class="hl-1">.</span><span class="hl-0">warn</span><span class="hl-1">(</span><span class="hl-2">&quot;ClientStrategy exception thrown&quot;</span><span class="hl-1">, {</span><br/><span class="hl-1">        </span><span class="hl-4">error:</span><span class="hl-1"> </span><span class="hl-0">errorData</span><span class="hl-1">(</span><span class="hl-4">error</span><span class="hl-1">),</span><br/><span class="hl-1">        </span><span class="hl-4">message:</span><span class="hl-1"> </span><span class="hl-0">getErrorMessage</span><span class="hl-1">(</span><span class="hl-4">error</span><span class="hl-1">)</span><br/><span class="hl-1">      });</span><br/><span class="hl-1">      </span><span class="hl-4">errorEmitter</span><span class="hl-1">.</span><span class="hl-0">next</span><span class="hl-1">(</span><span class="hl-4">error</span><span class="hl-1">);</span><br/><span class="hl-1">    }</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">);</span>
</code><button type="button">Copy</button></pre>

<p><code>src/client/ClientStrategy.ts:332-476</code></p>
<hr>
<a id="debugging-and-testing-callbacks" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Debugging and Testing Callbacks<a href="#debugging-and-testing-callbacks" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><a id="using-onwrite-for-persistence-testing" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Using onWrite for Persistence Testing<a href="#using-onwrite-for-persistence-testing" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>The <code>onWrite</code> callback is specifically designed for testing persistence behavior:</p>
<pre><code class="typescript"><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">writeLog</span><span class="hl-1">: </span><span class="hl-13">Array</span><span class="hl-1">&lt;{ </span><span class="hl-4">symbol</span><span class="hl-1">: </span><span class="hl-13">string</span><span class="hl-1">, </span><span class="hl-4">data</span><span class="hl-1">: </span><span class="hl-13">ISignalRow</span><span class="hl-1"> | </span><span class="hl-13">null</span><span class="hl-1"> }&gt; = [];</span><br/><br/><span class="hl-0">addStrategy</span><span class="hl-1">({</span><br/><span class="hl-1">  </span><span class="hl-4">strategyName:</span><span class="hl-1"> </span><span class="hl-2">&#39;test-strategy&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">interval:</span><span class="hl-1"> </span><span class="hl-2">&#39;1m&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-0">getSignal</span><span class="hl-4">:</span><span class="hl-1"> </span><span class="hl-7">async</span><span class="hl-1"> (</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">when</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> { </span><span class="hl-5">/* ... */</span><span class="hl-1"> },</span><br/><span class="hl-1">  </span><span class="hl-4">callbacks:</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-0">onWrite</span><span class="hl-4">:</span><span class="hl-1"> (</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">data</span><span class="hl-1">, </span><span class="hl-4">backtest</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">      </span><span class="hl-4">writeLog</span><span class="hl-1">.</span><span class="hl-0">push</span><span class="hl-1">({ </span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">data</span><span class="hl-1"> });</span><br/><span class="hl-1">      </span><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-4">data</span><span class="hl-1"> === </span><span class="hl-7">null</span><span class="hl-1">) {</span><br/><span class="hl-1">        </span><span class="hl-4">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-2">`Signal deleted from persistence: </span><span class="hl-7">${</span><span class="hl-4">symbol</span><span class="hl-7">}</span><span class="hl-2">`</span><span class="hl-1">);</span><br/><span class="hl-1">      } </span><span class="hl-3">else</span><span class="hl-1"> {</span><br/><span class="hl-1">        </span><span class="hl-4">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-2">`Signal written to persistence: </span><span class="hl-7">${</span><span class="hl-4">data</span><span class="hl-9">.</span><span class="hl-4">id</span><span class="hl-7">}</span><span class="hl-2">`</span><span class="hl-1">);</span><br/><span class="hl-1">      }</span><br/><span class="hl-1">    }</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">});</span><br/><br/><span class="hl-5">// After test execution, inspect writeLog</span><br/><span class="hl-4">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-2">`Total writes: </span><span class="hl-7">${</span><span class="hl-4">writeLog</span><span class="hl-9">.</span><span class="hl-4">length</span><span class="hl-7">}</span><span class="hl-2">`</span><span class="hl-1">);</span><br/><span class="hl-4">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-2">`Deletes: </span><span class="hl-7">${</span><span class="hl-4">writeLog</span><span class="hl-9">.</span><span class="hl-0">filter</span><span class="hl-9">(</span><span class="hl-4">w</span><span class="hl-9"> </span><span class="hl-7">=&gt;</span><span class="hl-9"> </span><span class="hl-4">w</span><span class="hl-9">.</span><span class="hl-4">data</span><span class="hl-9"> </span><span class="hl-1">===</span><span class="hl-9"> </span><span class="hl-7">null</span><span class="hl-9">).</span><span class="hl-4">length</span><span class="hl-7">}</span><span class="hl-2">`</span><span class="hl-1">);</span>
</code><button type="button">Copy</button></pre>

<a id="ontick-for-comprehensive-state-logging" class="tsd-anchor"></a><h3 class="tsd-anchor-link">onTick for Comprehensive State Logging<a href="#ontick-for-comprehensive-state-logging" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Since <code>onTick</code> executes on every tick regardless of state, it's ideal for comprehensive logging:</p>
<pre><code class="typescript"><span class="hl-0">addStrategy</span><span class="hl-1">({</span><br/><span class="hl-1">  </span><span class="hl-4">strategyName:</span><span class="hl-1"> </span><span class="hl-2">&#39;debug-strategy&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">interval:</span><span class="hl-1"> </span><span class="hl-2">&#39;1m&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-0">getSignal</span><span class="hl-4">:</span><span class="hl-1"> </span><span class="hl-7">async</span><span class="hl-1"> (</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">when</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> { </span><span class="hl-5">/* ... */</span><span class="hl-1"> },</span><br/><span class="hl-1">  </span><span class="hl-4">callbacks:</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-0">onTick</span><span class="hl-4">:</span><span class="hl-1"> (</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">result</span><span class="hl-1">, </span><span class="hl-4">backtest</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">      </span><span class="hl-4">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-2">`[</span><span class="hl-7">${</span><span class="hl-7">new</span><span class="hl-9"> </span><span class="hl-0">Date</span><span class="hl-9">().</span><span class="hl-0">toISOString</span><span class="hl-9">()</span><span class="hl-7">}</span><span class="hl-2">] </span><span class="hl-7">${</span><span class="hl-4">symbol</span><span class="hl-7">}</span><span class="hl-2"> </span><span class="hl-7">${</span><span class="hl-4">result</span><span class="hl-9">.</span><span class="hl-4">action</span><span class="hl-7">}</span><span class="hl-2">`</span><span class="hl-1">);</span><br/><span class="hl-1">      </span><br/><span class="hl-1">      </span><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-4">result</span><span class="hl-1">.</span><span class="hl-4">action</span><span class="hl-1"> === </span><span class="hl-2">&#39;active&#39;</span><span class="hl-1">) {</span><br/><span class="hl-1">        </span><span class="hl-4">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-2">`  Progress: TP=</span><span class="hl-7">${</span><span class="hl-4">result</span><span class="hl-9">.</span><span class="hl-4">percentTp</span><span class="hl-7">}</span><span class="hl-2">%, SL=</span><span class="hl-7">${</span><span class="hl-4">result</span><span class="hl-9">.</span><span class="hl-4">percentSl</span><span class="hl-7">}</span><span class="hl-2">%`</span><span class="hl-1">);</span><br/><span class="hl-1">      }</span><br/><span class="hl-1">      </span><br/><span class="hl-1">      </span><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-4">result</span><span class="hl-1">.</span><span class="hl-4">action</span><span class="hl-1"> === </span><span class="hl-2">&#39;closed&#39;</span><span class="hl-1">) {</span><br/><span class="hl-1">        </span><span class="hl-4">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-2">`  Reason: </span><span class="hl-7">${</span><span class="hl-4">result</span><span class="hl-9">.</span><span class="hl-4">closeReason</span><span class="hl-7">}</span><span class="hl-2">, PNL: </span><span class="hl-7">${</span><span class="hl-4">result</span><span class="hl-9">.</span><span class="hl-4">pnl</span><span class="hl-9">.</span><span class="hl-4">pnlPercentage</span><span class="hl-7">}</span><span class="hl-2">%`</span><span class="hl-1">);</span><br/><span class="hl-1">      }</span><br/><span class="hl-1">    }</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">});</span>
</code><button type="button">Copy</button></pre>

<hr>
<a id="performance-considerations" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Performance Considerations<a href="#performance-considerations" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>Callbacks execute inline during the tick cycle, so expensive operations can impact strategy performance:</p>
<p><strong>Best Practices:</strong></p>
<ul>
<li>Keep callbacks lightweight</li>
<li>Delegate heavy operations to external queues</li>
<li>Avoid synchronous I/O in callbacks</li>
<li>Use <code>backtest</code> flag to skip expensive operations during backtests</li>
</ul>
<p><strong>Performance-Conscious Example:</strong></p>
<pre><code class="typescript"><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">notificationQueue</span><span class="hl-1">: </span><span class="hl-13">Array</span><span class="hl-1">&lt;</span><span class="hl-13">any</span><span class="hl-1">&gt; = [];</span><br/><br/><span class="hl-0">addStrategy</span><span class="hl-1">({</span><br/><span class="hl-1">  </span><span class="hl-4">strategyName:</span><span class="hl-1"> </span><span class="hl-2">&#39;efficient-strategy&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">interval:</span><span class="hl-1"> </span><span class="hl-2">&#39;5m&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-0">getSignal</span><span class="hl-4">:</span><span class="hl-1"> </span><span class="hl-7">async</span><span class="hl-1"> (</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">when</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> { </span><span class="hl-5">/* ... */</span><span class="hl-1"> },</span><br/><span class="hl-1">  </span><span class="hl-4">callbacks:</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-0">onOpen</span><span class="hl-4">:</span><span class="hl-1"> (</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">data</span><span class="hl-1">, </span><span class="hl-4">price</span><span class="hl-1">, </span><span class="hl-4">backtest</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">      </span><span class="hl-5">// Fast: push to in-memory queue</span><br/><span class="hl-1">      </span><span class="hl-3">if</span><span class="hl-1"> (!</span><span class="hl-4">backtest</span><span class="hl-1">) {</span><br/><span class="hl-1">        </span><span class="hl-4">notificationQueue</span><span class="hl-1">.</span><span class="hl-0">push</span><span class="hl-1">({ </span><span class="hl-4">type:</span><span class="hl-1"> </span><span class="hl-2">&#39;open&#39;</span><span class="hl-1">, </span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">price</span><span class="hl-1"> });</span><br/><span class="hl-1">      }</span><br/><span class="hl-1">      </span><span class="hl-5">// Slow operation deferred to background worker</span><br/><span class="hl-1">      </span><span class="hl-5">// setImmediate(() =&gt; sendToExternalAPI(data));</span><br/><span class="hl-1">    }</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">});</span><br/><br/><span class="hl-5">// Background worker processes queue</span><br/><span class="hl-0">setInterval</span><span class="hl-1">(() </span><span class="hl-7">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-4">notificationQueue</span><span class="hl-1">.</span><span class="hl-4">length</span><span class="hl-1"> &gt; </span><span class="hl-6">0</span><span class="hl-1">) {</span><br/><span class="hl-1">    </span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">batch</span><span class="hl-1"> = </span><span class="hl-4">notificationQueue</span><span class="hl-1">.</span><span class="hl-0">splice</span><span class="hl-1">(</span><span class="hl-6">0</span><span class="hl-1">, </span><span class="hl-6">10</span><span class="hl-1">);</span><br/><span class="hl-1">    </span><span class="hl-0">sendBatchNotifications</span><span class="hl-1">(</span><span class="hl-4">batch</span><span class="hl-1">); </span><span class="hl-5">// Async, non-blocking</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">}, </span><span class="hl-6">1000</span><span class="hl-1">);</span>
</code><button type="button">Copy</button></pre>

</div></div><div class="col-sidebar"><div class="page-menu"><div class="tsd-navigation settings"><details class="tsd-accordion"><summary class="tsd-accordion-summary"><h3><svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-chevronDown"></use></svg>Settings</h3></summary><div class="tsd-accordion-details"><div class="tsd-filter-visibility"><span class="settings-label">Member Visibility</span><ul id="tsd-filter-options"><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-protected" name="protected"/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Protected</span></label></li><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-inherited" name="inherited" checked/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Inherited</span></label></li><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-external" name="external"/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>External</span></label></li></ul></div><div class="tsd-theme-toggle"><label class="settings-label" for="tsd-theme">Theme</label><select id="tsd-theme"><option value="os">OS</option><option value="light">Light</option><option value="dark">Dark</option></select></div></div></details></div><details open class="tsd-accordion tsd-page-navigation"><summary class="tsd-accordion-summary"><h3><svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-chevronDown"></use></svg>On This Page</h3></summary><div class="tsd-accordion-details"><a href="#strategy-callbacks"><span>Strategy <wbr/>Callbacks</span></a><ul><li><a href="#overview"><span>Overview</span></a></li><li><a href="#istrategycallbacks-interface-structure"><span>IStrategy<wbr/>Callbacks <wbr/>Interface <wbr/>Structure</span></a></li><li><a href="#callback-lifecycle-hooks"><span>Callback <wbr/>Lifecycle <wbr/>Hooks</span></a></li><li><ul><li><a href="#ontick"><span>on<wbr/>Tick</span></a></li><li><a href="#onopen"><span>on<wbr/>Open</span></a></li><li><a href="#onactive"><span>on<wbr/>Active</span></a></li><li><a href="#onidle"><span>on<wbr/>Idle</span></a></li><li><a href="#onclose"><span>on<wbr/>Close</span></a></li><li><a href="#onschedule"><span>on<wbr/>Schedule</span></a></li><li><a href="#oncancel"><span>on<wbr/>Cancel</span></a></li><li><a href="#onwrite"><span>on<wbr/>Write</span></a></li><li><a href="#onpartialprofit"><span>on<wbr/>Partial<wbr/>Profit</span></a></li><li><a href="#onpartialloss"><span>on<wbr/>Partial<wbr/>Loss</span></a></li></ul></li><li><a href="#callback-invocation-flow"><span>Callback <wbr/>Invocation <wbr/>Flow</span></a></li><li><a href="#callbacks-vs-event-emitters"><span>Callbacks vs <wbr/>Event <wbr/>Emitters</span></a></li><li><a href="#integration-with-strategyconnectionservice"><span>Integration with <wbr/>Strategy<wbr/>Connection<wbr/>Service</span></a></li><li><a href="#common-usage-patterns"><span>Common <wbr/>Usage <wbr/>Patterns</span></a></li><li><ul><li><a href="#pattern-1-trade-execution-logging"><span>Pattern 1: <wbr/>Trade <wbr/>Execution <wbr/>Logging</span></a></li><li><a href="#pattern-2-unrealized-pnl-tracking"><span>Pattern 2: <wbr/>Unrealized PNL <wbr/>Tracking</span></a></li><li><a href="#pattern-3-scheduled-signal-monitoring"><span>Pattern 3: <wbr/>Scheduled <wbr/>Signal <wbr/>Monitoring</span></a></li><li><a href="#pattern-4-conditional-backtest-vs-live-behavior"><span>Pattern 4: <wbr/>Conditional <wbr/>Backtest vs <wbr/>Live <wbr/>Behavior</span></a></li></ul></li><li><a href="#thread-safety-and-execution-order"><span>Thread <wbr/>Safety and <wbr/>Execution <wbr/>Order</span></a></li><li><a href="#debugging-and-testing-callbacks"><span>Debugging and <wbr/>Testing <wbr/>Callbacks</span></a></li><li><ul><li><a href="#using-onwrite-for-persistence-testing"><span>Using on<wbr/>Write for <wbr/>Persistence <wbr/>Testing</span></a></li><li><a href="#ontick-for-comprehensive-state-logging"><span>on<wbr/>Tick for <wbr/>Comprehensive <wbr/>State <wbr/>Logging</span></a></li></ul></li><li><a href="#performance-considerations"><span>Performance <wbr/>Considerations</span></a></li></ul></div></details></div><div class="site-menu"><nav class="tsd-navigation"><a href="../modules.html">backtest-kit</a><ul class="tsd-small-nested-navigation" id="tsd-nav-container"><li>Loading...</li></ul></nav></div></div></div><footer><p class="tsd-generator">Generated using <a href="https://typedoc.org/" target="_blank">TypeDoc</a></p></footer><div class="overlay"></div></body></html>

<!-- Yandex.Metrika counter -->
<script type="text/javascript">
    (function(m,e,t,r,i,k,a){
        m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
        m[i].l=1*new Date();
        for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }}
        k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)
    })(window, document,'script','https://mc.yandex.ru/metrika/tag.js?id=105455585', 'ym');

    ym(105455585, 'init', {ssr:true, webvisor:true, clickmap:true, ecommerce:"dataLayer", accurateTrackBounce:true, trackLinks:true});
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/105455585" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
<!-- /Yandex.Metrika counter -->

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-3MQZEBBDDR"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-3MQZEBBDDR');
</script>
