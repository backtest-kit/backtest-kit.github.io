<!DOCTYPE html><html class="default" lang="en" data-base=".."><head><meta charset="utf-8"/><meta http-equiv="x-ua-compatible" content="IE=edge"/><title>design/21_data-and-exchanges | backtest-kit</title><meta name="description" content="Documentation for backtest-kit"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="stylesheet" href="../assets/style.css"/><link rel="stylesheet" href="../assets/highlight.css"/><script defer src="../assets/main.js"></script><script async src="../assets/icons.js" id="tsd-icons-script"></script><script async src="../assets/search.js" id="tsd-search-script"></script><script async src="../assets/navigation.js" id="tsd-nav-script"></script><script async src="../assets/hierarchy.js" id="tsd-hierarchy-script"></script></head><body><script>document.documentElement.dataset.theme = localStorage.getItem("tsd-theme") || "os";document.body.style.display="none";setTimeout(() => app?app.showPage():document.body.style.removeProperty("display"),500)</script><header class="tsd-page-toolbar"><div class="tsd-toolbar-contents container"><div class="table-cell" id="tsd-search"><div class="field"><label for="tsd-search-field" class="tsd-widget tsd-toolbar-icon search no-caption"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-search"></use></svg></label><input type="text" id="tsd-search-field" aria-label="Search"/></div><div class="field"><div id="tsd-toolbar-links"></div></div><ul class="results"><li class="state loading">Preparing search index...</li><li class="state failure">The search index is not available</li></ul><a href="../index.html" class="title">backtest-kit</a></div><div class="table-cell" id="tsd-widgets"><a href="#" class="tsd-widget tsd-toolbar-icon menu no-caption" data-toggle="menu" aria-label="Menu"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-menu"></use></svg></a></div></div></header><div class="container container-main"><div class="col-content"><div class="tsd-page-title"><ul class="tsd-breadcrumb"><li><a href="../modules.html">backtest-kit</a></li><li><a href="design_21_data-and-exchanges.html">design/21_data-and-exchanges</a></li></ul></div><div class="tsd-panel tsd-typography"><a id="data-and-exchanges" class="tsd-anchor"></a><h1 class="tsd-anchor-link">Data and Exchanges<a href="#data-and-exchanges" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h1><p>This page documents how the backtest-kit framework integrates with external data sources, fetches historical market data, calculates price metrics like VWAP, and manages timeframes for backtesting. It covers the Exchange system (data source abstraction), Frame system (timeframe generation), and the candle data structures used throughout the framework.</p>
<p><strong>Scope</strong>: This page focuses on data acquisition and time management. For strategy execution logic, see <a href="design_11_strategy-system.html">Strategy System</a>. For execution mode details (how Backtest/Live modes consume this data), see <a href="design_16_execution-modes-detailed.html">Execution Modes (Detailed)</a>.</p>
<hr>
<a id="exchange-system-architecture" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Exchange System Architecture<a href="#exchange-system-architecture" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>The Exchange system provides an abstraction layer for fetching historical candle data from any source (CCXT, custom APIs, databases). The framework uses a three-tier architecture for exchange operations:</p>
<p><img src="../media/21-data-and-exchanges_0.svg" alt="Mermaid Diagram"></p>
<p><strong>Key Components</strong>:</p>
<table>
<thead>
<tr>
<th>Component</th>
<th>File Path</th>
<th>Responsibility</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>IExchangeSchema</code></td>
<td><a href="">types.d.ts:327-363</a></td>
<td>Schema interface for exchange registration</td>
</tr>
<tr>
<td><code>ExchangeSchemaService</code></td>
<td><a href="">src/lib/services/schema/ExchangeSchemaService.ts</a></td>
<td>ToolRegistry for storing exchange schemas</td>
</tr>
<tr>
<td><code>ExchangeValidationService</code></td>
<td><a href="">src/lib/services/validation/ExchangeValidationService.ts</a></td>
<td>Validates exchange schema structure</td>
</tr>
<tr>
<td><code>ExchangeConnectionService</code></td>
<td><a href="">src/lib/services/connection/ExchangeConnectionService.ts</a></td>
<td>Memoized factory for <code>ClientExchange</code> instances</td>
</tr>
<tr>
<td><code>ClientExchange</code></td>
<td><a href="">src/lib/client/ClientExchange.ts</a></td>
<td>Business logic for candle fetching and VWAP</td>
</tr>
<tr>
<td><code>ExchangeCoreService</code></td>
<td><a href="">src/lib/services/core/ExchangeCoreService.ts</a></td>
<td>High-level orchestration of exchange operations</td>
</tr>
</tbody>
</table>
<p>, <a href="">src/index.ts:1-195</a>, Diagram 1 from high-level architecture</p>
<hr>
<a id="exchange-configuration" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Exchange Configuration<a href="#exchange-configuration" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><a id="iexchangeschema-structure" class="tsd-anchor"></a><h3 class="tsd-anchor-link">IExchangeSchema Structure<a href="#iexchangeschema-structure" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Exchanges are registered via <code>addExchange()</code> with a schema defining four required callbacks:</p>
<p><img src="../media/21-data-and-exchanges_1.svg" alt="Mermaid Diagram"></p>
<p><strong>Schema Definition</strong> (<a href="">types.d.ts:327-363</a>):</p>
<pre><code class="typescript"><span class="hl-7">interface</span><span class="hl-1"> </span><span class="hl-13">IExchangeSchema</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-4">exchangeName</span><span class="hl-1">: </span><span class="hl-13">ExchangeName</span><span class="hl-1">;  </span><span class="hl-5">// Unique identifier</span><br/><span class="hl-1">    </span><span class="hl-4">note</span><span class="hl-1">?: </span><span class="hl-13">string</span><span class="hl-1">;               </span><span class="hl-5">// Documentation</span><br/><span class="hl-1">    </span><br/><span class="hl-1">    </span><span class="hl-5">// Fetch candles from data source</span><br/><span class="hl-1">    </span><span class="hl-0">getCandles</span><span class="hl-1">: (</span><br/><span class="hl-1">        </span><span class="hl-4">symbol</span><span class="hl-1">: </span><span class="hl-13">string</span><span class="hl-1">,</span><br/><span class="hl-1">        </span><span class="hl-4">interval</span><span class="hl-1">: </span><span class="hl-13">CandleInterval</span><span class="hl-1">,  </span><span class="hl-5">// &quot;1m&quot; | &quot;3m&quot; | &quot;5m&quot; | ... | &quot;8h&quot;</span><br/><span class="hl-1">        </span><span class="hl-4">since</span><span class="hl-1">: </span><span class="hl-13">Date</span><span class="hl-1">,</span><br/><span class="hl-1">        </span><span class="hl-4">limit</span><span class="hl-1">: </span><span class="hl-13">number</span><br/><span class="hl-1">    ) </span><span class="hl-7">=&gt;</span><span class="hl-1"> </span><span class="hl-13">Promise</span><span class="hl-1">&lt;</span><span class="hl-13">ICandleData</span><span class="hl-1">[]&gt;;</span><br/><span class="hl-1">    </span><br/><span class="hl-1">    </span><span class="hl-5">// Format values per exchange precision</span><br/><span class="hl-1">    </span><span class="hl-0">formatQuantity</span><span class="hl-1">: (</span><span class="hl-4">symbol</span><span class="hl-1">: </span><span class="hl-13">string</span><span class="hl-1">, </span><span class="hl-4">quantity</span><span class="hl-1">: </span><span class="hl-13">number</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> </span><span class="hl-13">Promise</span><span class="hl-1">&lt;</span><span class="hl-13">string</span><span class="hl-1">&gt;;</span><br/><span class="hl-1">    </span><span class="hl-0">formatPrice</span><span class="hl-1">: (</span><span class="hl-4">symbol</span><span class="hl-1">: </span><span class="hl-13">string</span><span class="hl-1">, </span><span class="hl-4">price</span><span class="hl-1">: </span><span class="hl-13">number</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> </span><span class="hl-13">Promise</span><span class="hl-1">&lt;</span><span class="hl-13">string</span><span class="hl-1">&gt;;</span><br/><span class="hl-1">    </span><br/><span class="hl-1">    </span><span class="hl-5">// Optional lifecycle callback</span><br/><span class="hl-1">    </span><span class="hl-4">callbacks</span><span class="hl-1">?: </span><span class="hl-13">Partial</span><span class="hl-1">&lt;</span><span class="hl-13">IExchangeCallbacks</span><span class="hl-1">&gt;;</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<a id="registration-example" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Registration Example<a href="#registration-example" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><pre><code class="typescript"><span class="hl-3">import</span><span class="hl-1"> </span><span class="hl-4">ccxt</span><span class="hl-1"> </span><span class="hl-3">from</span><span class="hl-1"> </span><span class="hl-2">&#39;ccxt&#39;</span><span class="hl-1">;</span><br/><span class="hl-3">import</span><span class="hl-1"> { </span><span class="hl-4">addExchange</span><span class="hl-1"> } </span><span class="hl-3">from</span><span class="hl-1"> </span><span class="hl-2">&#39;backtest-kit&#39;</span><span class="hl-1">;</span><br/><br/><span class="hl-0">addExchange</span><span class="hl-1">({</span><br/><span class="hl-1">    </span><span class="hl-4">exchangeName:</span><span class="hl-1"> </span><span class="hl-2">&#39;binance&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-4">note:</span><span class="hl-1"> </span><span class="hl-2">&#39;CCXT-based Binance integration&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><br/><span class="hl-1">    </span><span class="hl-0">getCandles</span><span class="hl-4">:</span><span class="hl-1"> </span><span class="hl-7">async</span><span class="hl-1"> (</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">interval</span><span class="hl-1">, </span><span class="hl-4">since</span><span class="hl-1">, </span><span class="hl-4">limit</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">        </span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">exchange</span><span class="hl-1"> = </span><span class="hl-7">new</span><span class="hl-1"> </span><span class="hl-4">ccxt</span><span class="hl-1">.</span><span class="hl-0">binance</span><span class="hl-1">();</span><br/><span class="hl-1">        </span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">ohlcv</span><span class="hl-1"> = </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-4">exchange</span><span class="hl-1">.</span><span class="hl-0">fetchOHLCV</span><span class="hl-1">(</span><br/><span class="hl-1">            </span><span class="hl-4">symbol</span><span class="hl-1">,</span><br/><span class="hl-1">            </span><span class="hl-4">interval</span><span class="hl-1">,</span><br/><span class="hl-1">            </span><span class="hl-4">since</span><span class="hl-1">.</span><span class="hl-0">getTime</span><span class="hl-1">(),</span><br/><span class="hl-1">            </span><span class="hl-4">limit</span><br/><span class="hl-1">        );</span><br/><span class="hl-1">        </span><br/><span class="hl-1">        </span><span class="hl-3">return</span><span class="hl-1"> </span><span class="hl-4">ohlcv</span><span class="hl-1">.</span><span class="hl-0">map</span><span class="hl-1">(([</span><span class="hl-4">timestamp</span><span class="hl-1">, </span><span class="hl-4">open</span><span class="hl-1">, </span><span class="hl-4">high</span><span class="hl-1">, </span><span class="hl-4">low</span><span class="hl-1">, </span><span class="hl-4">close</span><span class="hl-1">, </span><span class="hl-4">volume</span><span class="hl-1">]) </span><span class="hl-7">=&gt;</span><span class="hl-1"> ({</span><br/><span class="hl-1">            </span><span class="hl-4">timestamp</span><span class="hl-1">, </span><span class="hl-4">open</span><span class="hl-1">, </span><span class="hl-4">high</span><span class="hl-1">, </span><span class="hl-4">low</span><span class="hl-1">, </span><span class="hl-4">close</span><span class="hl-1">, </span><span class="hl-4">volume</span><br/><span class="hl-1">        }));</span><br/><span class="hl-1">    },</span><br/><span class="hl-1">    </span><br/><span class="hl-1">    </span><span class="hl-0">formatPrice</span><span class="hl-4">:</span><span class="hl-1"> </span><span class="hl-7">async</span><span class="hl-1"> (</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">price</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">        </span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">exchange</span><span class="hl-1"> = </span><span class="hl-7">new</span><span class="hl-1"> </span><span class="hl-4">ccxt</span><span class="hl-1">.</span><span class="hl-0">binance</span><span class="hl-1">();</span><br/><span class="hl-1">        </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-4">exchange</span><span class="hl-1">.</span><span class="hl-0">loadMarkets</span><span class="hl-1">();</span><br/><span class="hl-1">        </span><span class="hl-3">return</span><span class="hl-1"> </span><span class="hl-4">exchange</span><span class="hl-1">.</span><span class="hl-0">priceToPrecision</span><span class="hl-1">(</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">price</span><span class="hl-1">);</span><br/><span class="hl-1">    },</span><br/><span class="hl-1">    </span><br/><span class="hl-1">    </span><span class="hl-0">formatQuantity</span><span class="hl-4">:</span><span class="hl-1"> </span><span class="hl-7">async</span><span class="hl-1"> (</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">quantity</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">        </span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">exchange</span><span class="hl-1"> = </span><span class="hl-7">new</span><span class="hl-1"> </span><span class="hl-4">ccxt</span><span class="hl-1">.</span><span class="hl-0">binance</span><span class="hl-1">();</span><br/><span class="hl-1">        </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-4">exchange</span><span class="hl-1">.</span><span class="hl-0">loadMarkets</span><span class="hl-1">();</span><br/><span class="hl-1">        </span><span class="hl-3">return</span><span class="hl-1"> </span><span class="hl-4">exchange</span><span class="hl-1">.</span><span class="hl-0">amountToPrecision</span><span class="hl-1">(</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">quantity</span><span class="hl-1">);</span><br/><span class="hl-1">    },</span><br/><span class="hl-1">    </span><br/><span class="hl-1">    </span><span class="hl-4">callbacks:</span><span class="hl-1"> {</span><br/><span class="hl-1">        </span><span class="hl-0">onCandleData</span><span class="hl-4">:</span><span class="hl-1"> (</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">interval</span><span class="hl-1">, </span><span class="hl-4">since</span><span class="hl-1">, </span><span class="hl-4">limit</span><span class="hl-1">, </span><span class="hl-4">data</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">            </span><span class="hl-4">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-2">`Fetched </span><span class="hl-7">${</span><span class="hl-4">data</span><span class="hl-9">.</span><span class="hl-4">length</span><span class="hl-7">}</span><span class="hl-2"> candles for </span><span class="hl-7">${</span><span class="hl-4">symbol</span><span class="hl-7">}</span><span class="hl-2">`</span><span class="hl-1">);</span><br/><span class="hl-1">        }</span><br/><span class="hl-1">    }</span><br/><span class="hl-1">});</span>
</code><button type="button">Copy</button></pre>

<a id="validation-rules" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Validation Rules<a href="#validation-rules" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><code>ExchangeValidationService</code> enforces:</p>
<ul>
<li><code>exchangeName</code> must be non-empty string</li>
<li><code>getCandles</code> must be a function</li>
<li><code>formatPrice</code> must be a function</li>
<li><code>formatQuantity</code> must be a function</li>
<li>Exchange name must not already exist (checked during registration)</li>
</ul>
<hr>
<a id="candle-data-and-vwap" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Candle Data and VWAP<a href="#candle-data-and-vwap" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><a id="icandledata-structure" class="tsd-anchor"></a><h3 class="tsd-anchor-link">ICandleData Structure<a href="#icandledata-structure" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>The framework uses a standard OHLCV candle structure:</p>
<pre><code class="typescript"><span class="hl-7">interface</span><span class="hl-1"> </span><span class="hl-13">ICandleData</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-4">timestamp</span><span class="hl-1">: </span><span class="hl-13">number</span><span class="hl-1">;  </span><span class="hl-5">// Unix timestamp in milliseconds</span><br/><span class="hl-1">    </span><span class="hl-4">open</span><span class="hl-1">: </span><span class="hl-13">number</span><span class="hl-1">;       </span><span class="hl-5">// Opening price</span><br/><span class="hl-1">    </span><span class="hl-4">high</span><span class="hl-1">: </span><span class="hl-13">number</span><span class="hl-1">;       </span><span class="hl-5">// Highest price</span><br/><span class="hl-1">    </span><span class="hl-4">low</span><span class="hl-1">: </span><span class="hl-13">number</span><span class="hl-1">;        </span><span class="hl-5">// Lowest price</span><br/><span class="hl-1">    </span><span class="hl-4">close</span><span class="hl-1">: </span><span class="hl-13">number</span><span class="hl-1">;      </span><span class="hl-5">// Closing price</span><br/><span class="hl-1">    </span><span class="hl-4">volume</span><span class="hl-1">: </span><span class="hl-13">number</span><span class="hl-1">;     </span><span class="hl-5">// Trading volume</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<a id="vwap-calculation" class="tsd-anchor"></a><h3 class="tsd-anchor-link">VWAP Calculation<a href="#vwap-calculation" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><code>ClientExchange.getAveragePrice()</code> calculates Volume-Weighted Average Price (VWAP) using the last N 1-minute candles, where N is configured via <code>CC_AVG_PRICE_CANDLES_COUNT</code> (default: 5).</p>
<p><img src="../media/21-data-and-exchanges_2.svg" alt="Mermaid Diagram"></p>
<p><strong>Implementation Details</strong>:</p>
<ol>
<li><strong>Fetching</strong>: Calls <code>getCandles(symbol, &quot;1m&quot;, limit)</code> where limit = <code>CC_AVG_PRICE_CANDLES_COUNT</code></li>
<li><strong>Anomaly Detection</strong>: Validates candles using <code>VALIDATE_NO_INCOMPLETE_CANDLES_FN</code> to detect incomplete candles from exchange APIs (e.g., Binance returning prices near $0 for incomplete candles)</li>
<li><strong>Typical Price</strong>: For each candle, calculates <code>(high + low + close) / 3</code></li>
<li><strong>VWAP</strong>: <code>Σ(typicalPrice × volume) / Σ(volume)</code></li>
<li><strong>Retry Logic</strong>: On failure, retries up to <code>CC_GET_CANDLES_RETRY_COUNT</code> times with <code>CC_GET_CANDLES_RETRY_DELAY_MS</code> delay</li>
</ol>
<p><strong>Configuration Parameters</strong> (<a href="">src/config/params.ts:1-122</a>):</p>
<table>
<thead>
<tr>
<th>Parameter</th>
<th>Default</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>CC_AVG_PRICE_CANDLES_COUNT</code></td>
<td>5</td>
<td>Number of 1m candles for VWAP</td>
</tr>
<tr>
<td><code>CC_GET_CANDLES_RETRY_COUNT</code></td>
<td>3</td>
<td>Max retries for failed fetches</td>
</tr>
<tr>
<td><code>CC_GET_CANDLES_RETRY_DELAY_MS</code></td>
<td>5000</td>
<td>Delay between retries (ms)</td>
</tr>
<tr>
<td><code>CC_GET_CANDLES_PRICE_ANOMALY_THRESHOLD_FACTOR</code></td>
<td>1000</td>
<td>Anomaly detection threshold</td>
</tr>
<tr>
<td><code>CC_GET_CANDLES_MIN_CANDLES_FOR_MEDIAN</code></td>
<td>5</td>
<td>Min candles for median vs average</td>
</tr>
</tbody>
</table>
<a id="price-anomaly-detection" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Price Anomaly Detection<a href="#price-anomaly-detection" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><code>VALIDATE_NO_INCOMPLETE_CANDLES_FN</code> protects against incomplete candles from exchange APIs:</p>
<p><strong>Algorithm</strong> (<a href="">src/lib/client/ClientExchange.ts</a>):</p>
<ol>
<li>Extract all price points (OHLC) from candles</li>
<li>Calculate reference price:
<ul>
<li>If <code>candles.length &gt;= CC_GET_CANDLES_MIN_CANDLES_FOR_MEDIAN</code>: use median</li>
<li>Else: use simple average</li>
</ul>
</li>
<li>For each price, check: <code>price &lt; referencePrice / CC_GET_CANDLES_PRICE_ANOMALY_THRESHOLD_FACTOR</code></li>
<li>If anomaly detected, throw error</li>
</ol>
<p><strong>Example</strong>: BTC at $50,000 median → threshold $50. Catches incomplete candles with prices like $0.01-$1.</p>
<hr>
<a id="clientexchange-methods" class="tsd-anchor"></a><h2 class="tsd-anchor-link">ClientExchange Methods<a href="#clientexchange-methods" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p><code>ClientExchange</code> implements the <code>IExchange</code> interface with four primary methods:</p>
<p><img src="../media/21-data-and-exchanges_3.svg" alt="Mermaid Diagram"></p>
<a id="getcandles-vs-getnextcandles" class="tsd-anchor"></a><h3 class="tsd-anchor-link">getCandles vs getNextCandles<a href="#getcandles-vs-getnextcandles" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><table>
<thead>
<tr>
<th>Method</th>
<th>Direction</th>
<th>Use Case</th>
<th>Context</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>getCandles</code></td>
<td>Backwards from <code>when</code></td>
<td>Indicator calculation, VWAP</td>
<td>Backtest + Live</td>
</tr>
<tr>
<td><code>getNextCandles</code></td>
<td>Forward from <code>when</code></td>
<td>Fast candle processing</td>
<td>Backtest only</td>
</tr>
</tbody>
</table>
<p><strong>Implementation</strong> (<a href="">src/lib/client/ClientExchange.ts</a>):</p>
<ul>
<li>Both methods call the user-provided <code>IExchangeSchema.getCandles</code> callback</li>
<li><code>getCandles</code>: <code>since = when - (limit * interval)</code></li>
<li><code>getNextCandles</code>: <code>since = when</code></li>
<li><code>ExecutionContext.when</code> is injected via <code>ExecutionContextService</code> (see <a href="design_06_system-architecture.html">System Architecture</a>)</li>
</ul>
<hr>
<a id="timeframes-and-frames" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Timeframes and Frames<a href="#timeframes-and-frames" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>The Frame system generates timestamp arrays for backtest iteration. Each frame defines a date range and interval for generating tick timestamps.</p>
<p><img src="../media/21-data-and-exchanges_4.svg" alt="Mermaid Diagram"></p>
<a id="iframeschema-structure" class="tsd-anchor"></a><h3 class="tsd-anchor-link">IFrameSchema Structure<a href="#iframeschema-structure" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><pre><code class="typescript"><span class="hl-7">interface</span><span class="hl-1"> </span><span class="hl-13">IFrameSchema</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-4">frameName</span><span class="hl-1">: </span><span class="hl-13">FrameName</span><span class="hl-1">;       </span><span class="hl-5">// Unique identifier</span><br/><span class="hl-1">    </span><span class="hl-4">note</span><span class="hl-1">?: </span><span class="hl-13">string</span><span class="hl-1">;              </span><span class="hl-5">// Documentation</span><br/><span class="hl-1">    </span><span class="hl-4">interval</span><span class="hl-1">: </span><span class="hl-13">FrameInterval</span><span class="hl-1">;    </span><span class="hl-5">// Timestamp granularity</span><br/><span class="hl-1">    </span><span class="hl-4">startDate</span><span class="hl-1">: </span><span class="hl-13">Date</span><span class="hl-1">;            </span><span class="hl-5">// Backtest start (inclusive)</span><br/><span class="hl-1">    </span><span class="hl-4">endDate</span><span class="hl-1">: </span><span class="hl-13">Date</span><span class="hl-1">;              </span><span class="hl-5">// Backtest end (inclusive)</span><br/><span class="hl-1">    </span><span class="hl-4">callbacks</span><span class="hl-1">?: </span><span class="hl-13">Partial</span><span class="hl-1">&lt;</span><span class="hl-13">IFrameCallbacks</span><span class="hl-1">&gt;;  </span><span class="hl-5">// onTimeframe event</span><br/><span class="hl-1">}</span><br/><br/><span class="hl-7">type</span><span class="hl-1"> </span><span class="hl-13">FrameInterval</span><span class="hl-1"> = </span><br/><span class="hl-1">    | </span><span class="hl-2">&quot;1m&quot;</span><span class="hl-1"> | </span><span class="hl-2">&quot;3m&quot;</span><span class="hl-1"> | </span><span class="hl-2">&quot;5m&quot;</span><span class="hl-1"> | </span><span class="hl-2">&quot;15m&quot;</span><span class="hl-1"> | </span><span class="hl-2">&quot;30m&quot;</span><span class="hl-1">      </span><span class="hl-5">// Minutes</span><br/><span class="hl-1">    | </span><span class="hl-2">&quot;1h&quot;</span><span class="hl-1"> | </span><span class="hl-2">&quot;2h&quot;</span><span class="hl-1"> | </span><span class="hl-2">&quot;4h&quot;</span><span class="hl-1"> | </span><span class="hl-2">&quot;6h&quot;</span><span class="hl-1"> | </span><span class="hl-2">&quot;8h&quot;</span><span class="hl-1"> | </span><span class="hl-2">&quot;12h&quot;</span><span class="hl-1"> </span><span class="hl-5">// Hours</span><br/><span class="hl-1">    | </span><span class="hl-2">&quot;1d&quot;</span><span class="hl-1"> | </span><span class="hl-2">&quot;3d&quot;</span><span class="hl-1">;                             </span><span class="hl-5">// Days</span>
</code><button type="button">Copy</button></pre>

<a id="timeframe-generation-algorithm" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Timeframe Generation Algorithm<a href="#timeframe-generation-algorithm" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><code>ClientFrame.getTimeframe()</code> generates an array of <code>Date</code> objects:</p>
<p><strong>Implementation</strong> (<a href="">src/lib/client/ClientFrame.ts</a>):</p>
<pre><code class="typescript"><span class="hl-6">1.</span><span class="hl-1"> </span><span class="hl-4">Parse</span><span class="hl-1"> </span><span class="hl-4">interval</span><span class="hl-1"> </span><span class="hl-4">to</span><span class="hl-1"> </span><span class="hl-0">milliseconds</span><span class="hl-1"> (</span><span class="hl-4">e</span><span class="hl-1">.</span><span class="hl-4">g</span><span class="hl-1">., </span><span class="hl-2">&quot;1m&quot;</span><span class="hl-1"> → 60000</span><span class="hl-4">ms</span><span class="hl-1">)</span><br/><span class="hl-6">2.</span><span class="hl-1"> </span><span class="hl-4">current</span><span class="hl-1"> = </span><span class="hl-4">startDate</span><br/><span class="hl-6">3.</span><span class="hl-1"> </span><span class="hl-4">timestamps</span><span class="hl-1"> = []</span><br/><span class="hl-6">4.</span><span class="hl-1"> </span><span class="hl-3">while</span><span class="hl-1"> (</span><span class="hl-4">current</span><span class="hl-1"> &lt;= </span><span class="hl-4">endDate</span><span class="hl-1">):</span><br/><span class="hl-1">       </span><span class="hl-4">timestamps</span><span class="hl-1">.</span><span class="hl-0">push</span><span class="hl-1">(</span><span class="hl-7">new</span><span class="hl-1"> </span><span class="hl-0">Date</span><span class="hl-1">(</span><span class="hl-4">current</span><span class="hl-1">))</span><br/><span class="hl-1">       </span><span class="hl-4">current</span><span class="hl-1"> += </span><span class="hl-4">interval_ms</span><br/><span class="hl-6">5.</span><span class="hl-1"> </span><span class="hl-3">return</span><span class="hl-1"> </span><span class="hl-4">timestamps</span>
</code><button type="button">Copy</button></pre>

<p><strong>Example</strong>: <code>interval=&quot;1m&quot;</code>, <code>startDate=&quot;2024-01-01T00:00:00Z&quot;</code>, <code>endDate=&quot;2024-01-01T01:00:00Z&quot;</code></p>
<ul>
<li>Generates 61 timestamps: 00:00, 00:01, 00:02, ..., 01:00</li>
</ul>
<a id="frame-registration-example" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Frame Registration Example<a href="#frame-registration-example" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><pre><code class="typescript"><span class="hl-3">import</span><span class="hl-1"> { </span><span class="hl-4">addFrame</span><span class="hl-1"> } </span><span class="hl-3">from</span><span class="hl-1"> </span><span class="hl-2">&#39;backtest-kit&#39;</span><span class="hl-1">;</span><br/><br/><span class="hl-0">addFrame</span><span class="hl-1">({</span><br/><span class="hl-1">    </span><span class="hl-4">frameName:</span><span class="hl-1"> </span><span class="hl-2">&#39;30d-backtest&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-4">note:</span><span class="hl-1"> </span><span class="hl-2">&#39;January 2024 full month&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-4">interval:</span><span class="hl-1"> </span><span class="hl-2">&#39;1m&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-4">startDate:</span><span class="hl-1"> </span><span class="hl-7">new</span><span class="hl-1"> </span><span class="hl-0">Date</span><span class="hl-1">(</span><span class="hl-2">&#39;2024-01-01T00:00:00Z&#39;</span><span class="hl-1">),</span><br/><span class="hl-1">    </span><span class="hl-4">endDate:</span><span class="hl-1"> </span><span class="hl-7">new</span><span class="hl-1"> </span><span class="hl-0">Date</span><span class="hl-1">(</span><span class="hl-2">&#39;2024-01-31T23:59:59Z&#39;</span><span class="hl-1">),</span><br/><span class="hl-1">    </span><span class="hl-4">callbacks:</span><span class="hl-1"> {</span><br/><span class="hl-1">        </span><span class="hl-0">onTimeframe</span><span class="hl-4">:</span><span class="hl-1"> (</span><span class="hl-4">timeframe</span><span class="hl-1">, </span><span class="hl-4">startDate</span><span class="hl-1">, </span><span class="hl-4">endDate</span><span class="hl-1">, </span><span class="hl-4">interval</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">            </span><span class="hl-4">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-2">`Generated </span><span class="hl-7">${</span><span class="hl-4">timeframe</span><span class="hl-9">.</span><span class="hl-4">length</span><span class="hl-7">}</span><span class="hl-2"> timestamps`</span><span class="hl-1">);</span><br/><span class="hl-1">            </span><span class="hl-4">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-2">`Range: </span><span class="hl-7">${</span><span class="hl-4">startDate</span><span class="hl-7">}</span><span class="hl-2"> to </span><span class="hl-7">${</span><span class="hl-4">endDate</span><span class="hl-7">}</span><span class="hl-2">`</span><span class="hl-1">);</span><br/><span class="hl-1">            </span><span class="hl-4">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-2">`Interval: </span><span class="hl-7">${</span><span class="hl-4">interval</span><span class="hl-7">}</span><span class="hl-2">`</span><span class="hl-1">);</span><br/><span class="hl-1">        }</span><br/><span class="hl-1">    }</span><br/><span class="hl-1">});</span>
</code><button type="button">Copy</button></pre>

<a id="validation-rules-1" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Validation Rules<a href="#validation-rules-1" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><code>FrameValidationService</code> enforces:</p>
<ul>
<li><code>frameName</code> must be non-empty string</li>
<li><code>interval</code> must be valid <code>FrameInterval</code> type</li>
<li><code>startDate</code> must be valid Date</li>
<li><code>endDate</code> must be valid Date</li>
<li><code>endDate</code> must be greater than <code>startDate</code></li>
</ul>
<hr>
<a id="exchange-and-frame-integration-flow" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Exchange and Frame Integration Flow<a href="#exchange-and-frame-integration-flow" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>The following diagram shows how Exchange and Frame components integrate during backtest execution:</p>
<p><img src="../media/21-data-and-exchanges_5.svg" alt="Mermaid Diagram"></p>
<p><strong>Execution Context Injection</strong>:</p>
<ul>
<li><code>BacktestLogicPrivateService</code> sets <code>ExecutionContextService.when = timestamp</code> before each <code>tick()</code> call</li>
<li><code>ClientExchange.getCandles()</code> reads <code>ExecutionContext.when</code> to calculate <code>since</code> parameter</li>
<li>This ensures all operations are scoped to the current backtest timestamp</li>
</ul>
<hr>
<a id="exchange-data-flow-and-caching" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Exchange Data Flow and Caching<a href="#exchange-data-flow-and-caching" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p><img src="../media/21-data-and-exchanges_6.svg" alt="Mermaid Diagram"></p>
<p><strong>Memoization Strategy</strong> (<a href="">src/lib/services/connection/ExchangeConnectionService.ts</a>):</p>
<ul>
<li><code>ClientExchange</code> instances are cached by <code>exchangeName</code></li>
<li>Cache key: <code>exchangeName</code> (string)</li>
<li>Cache invalidation: None (instances live for application lifetime)</li>
<li>Benefit: Avoids repeated schema lookups and instance creation</li>
</ul>
<hr>
<a id="configuration-parameters-summary" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Configuration Parameters Summary<a href="#configuration-parameters-summary" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>All exchange and candle-related parameters are configurable via <code>setConfig()</code>:</p>
<table>
<thead>
<tr>
<th>Parameter</th>
<th>Default</th>
<th>Range</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>CC_AVG_PRICE_CANDLES_COUNT</code></td>
<td>5</td>
<td>Integer &gt; 0</td>
<td>VWAP candle count (1m interval)</td>
</tr>
<tr>
<td><code>CC_GET_CANDLES_RETRY_COUNT</code></td>
<td>3</td>
<td>Integer ≥ 0</td>
<td>Max retries on fetch failure</td>
</tr>
<tr>
<td><code>CC_GET_CANDLES_RETRY_DELAY_MS</code></td>
<td>5000</td>
<td>Integer &gt; 0</td>
<td>Delay between retries (ms)</td>
</tr>
<tr>
<td><code>CC_GET_CANDLES_PRICE_ANOMALY_THRESHOLD_FACTOR</code></td>
<td>1000</td>
<td>Number &gt; 0</td>
<td>Anomaly detection divisor</td>
</tr>
<tr>
<td><code>CC_GET_CANDLES_MIN_CANDLES_FOR_MEDIAN</code></td>
<td>5</td>
<td>Integer &gt; 0</td>
<td>Threshold for median vs average</td>
</tr>
</tbody>
</table>
<p><strong>Usage</strong>:</p>
<pre><code class="typescript"><span class="hl-3">import</span><span class="hl-1"> { </span><span class="hl-4">setConfig</span><span class="hl-1"> } </span><span class="hl-3">from</span><span class="hl-1"> </span><span class="hl-2">&#39;backtest-kit&#39;</span><span class="hl-1">;</span><br/><br/><span class="hl-0">setConfig</span><span class="hl-1">({</span><br/><span class="hl-1">    </span><span class="hl-4">CC_AVG_PRICE_CANDLES_COUNT:</span><span class="hl-1"> </span><span class="hl-6">10</span><span class="hl-1">,  </span><span class="hl-5">// Use 10 candles for VWAP</span><br/><span class="hl-1">    </span><span class="hl-4">CC_GET_CANDLES_RETRY_COUNT:</span><span class="hl-1"> </span><span class="hl-6">5</span><span class="hl-1">,   </span><span class="hl-5">// More retries for unstable APIs</span><br/><span class="hl-1">});</span>
</code><button type="button">Copy</button></pre>

<hr>
<a id="error-handling-and-retry-logic" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Error Handling and Retry Logic<a href="#error-handling-and-retry-logic" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>Exchange operations implement robust error handling:</p>
<p><strong>Retry Mechanism</strong> (<a href="">src/lib/client/ClientExchange.ts</a>):</p>
<ol>
<li>Wrap <code>getCandles()</code> call in try-catch</li>
<li>On error, log via <code>LoggerService</code></li>
<li>Wait <code>CC_GET_CANDLES_RETRY_DELAY_MS</code> milliseconds</li>
<li>Retry up to <code>CC_GET_CANDLES_RETRY_COUNT</code> times</li>
<li>If all retries exhausted, propagate error to caller</li>
</ol>
<p><strong>Error Scenarios</strong>:</p>
<ul>
<li><strong>Network Timeout</strong>: Retried automatically</li>
<li><strong>Rate Limit</strong>: User should implement exponential backoff in <code>getCandles</code> callback</li>
<li><strong>Invalid Symbol</strong>: Not retried (validation error)</li>
<li><strong>Anomalous Prices</strong>: Throws error after validation, triggers retry</li>
</ul>
<p><strong>Test Coverage</strong>: <a href="">test/e2e/sanitize.test.mjs:666-784</a> demonstrates incomplete candle detection and rejection</p>
<hr>
<a id="testing-examples" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Testing Examples<a href="#testing-examples" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><a id="mock-exchange-for-testing" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Mock Exchange for Testing<a href="#mock-exchange-for-testing" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><pre><code class="typescript"><span class="hl-3">import</span><span class="hl-1"> { </span><span class="hl-4">addExchange</span><span class="hl-1"> } </span><span class="hl-3">from</span><span class="hl-1"> </span><span class="hl-2">&#39;backtest-kit&#39;</span><span class="hl-1">;</span><br/><br/><span class="hl-0">addExchange</span><span class="hl-1">({</span><br/><span class="hl-1">    </span><span class="hl-4">exchangeName:</span><span class="hl-1"> </span><span class="hl-2">&#39;mock-exchange&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-0">getCandles</span><span class="hl-4">:</span><span class="hl-1"> </span><span class="hl-7">async</span><span class="hl-1"> (</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">interval</span><span class="hl-1">, </span><span class="hl-4">since</span><span class="hl-1">, </span><span class="hl-4">limit</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">        </span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">candles</span><span class="hl-1"> = [];</span><br/><span class="hl-1">        </span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">intervalMs</span><span class="hl-1"> = </span><span class="hl-6">60000</span><span class="hl-1">; </span><span class="hl-5">// 1 minute</span><br/><span class="hl-1">        </span><br/><span class="hl-1">        </span><span class="hl-3">for</span><span class="hl-1"> (</span><span class="hl-7">let</span><span class="hl-1"> </span><span class="hl-4">i</span><span class="hl-1"> = </span><span class="hl-6">0</span><span class="hl-1">; </span><span class="hl-4">i</span><span class="hl-1"> &lt; </span><span class="hl-4">limit</span><span class="hl-1">; </span><span class="hl-4">i</span><span class="hl-1">++) {</span><br/><span class="hl-1">            </span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">timestamp</span><span class="hl-1"> = </span><span class="hl-4">since</span><span class="hl-1">.</span><span class="hl-0">getTime</span><span class="hl-1">() + </span><span class="hl-4">i</span><span class="hl-1"> * </span><span class="hl-4">intervalMs</span><span class="hl-1">;</span><br/><span class="hl-1">            </span><span class="hl-4">candles</span><span class="hl-1">.</span><span class="hl-0">push</span><span class="hl-1">({</span><br/><span class="hl-1">                </span><span class="hl-4">timestamp</span><span class="hl-1">,</span><br/><span class="hl-1">                </span><span class="hl-4">open:</span><span class="hl-1"> </span><span class="hl-6">42000</span><span class="hl-1"> + </span><span class="hl-4">i</span><span class="hl-1"> * </span><span class="hl-6">100</span><span class="hl-1">,</span><br/><span class="hl-1">                </span><span class="hl-4">high:</span><span class="hl-1"> </span><span class="hl-6">42100</span><span class="hl-1"> + </span><span class="hl-4">i</span><span class="hl-1"> * </span><span class="hl-6">100</span><span class="hl-1">,</span><br/><span class="hl-1">                </span><span class="hl-4">low:</span><span class="hl-1"> </span><span class="hl-6">41900</span><span class="hl-1"> + </span><span class="hl-4">i</span><span class="hl-1"> * </span><span class="hl-6">100</span><span class="hl-1">,</span><br/><span class="hl-1">                </span><span class="hl-4">close:</span><span class="hl-1"> </span><span class="hl-6">42000</span><span class="hl-1"> + </span><span class="hl-4">i</span><span class="hl-1"> * </span><span class="hl-6">100</span><span class="hl-1">,</span><br/><span class="hl-1">                </span><span class="hl-4">volume:</span><span class="hl-1"> </span><span class="hl-6">100</span><span class="hl-1">,</span><br/><span class="hl-1">            });</span><br/><span class="hl-1">        }</span><br/><span class="hl-1">        </span><br/><span class="hl-1">        </span><span class="hl-3">return</span><span class="hl-1"> </span><span class="hl-4">candles</span><span class="hl-1">;</span><br/><span class="hl-1">    },</span><br/><span class="hl-1">    </span><span class="hl-0">formatPrice</span><span class="hl-4">:</span><span class="hl-1"> </span><span class="hl-7">async</span><span class="hl-1"> (</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">price</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> </span><span class="hl-4">price</span><span class="hl-1">.</span><span class="hl-0">toFixed</span><span class="hl-1">(</span><span class="hl-6">8</span><span class="hl-1">),</span><br/><span class="hl-1">    </span><span class="hl-0">formatQuantity</span><span class="hl-4">:</span><span class="hl-1"> </span><span class="hl-7">async</span><span class="hl-1"> (</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">quantity</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> </span><span class="hl-4">quantity</span><span class="hl-1">.</span><span class="hl-0">toFixed</span><span class="hl-1">(</span><span class="hl-6">8</span><span class="hl-1">),</span><br/><span class="hl-1">});</span>
</code><button type="button">Copy</button></pre>

<a id="anomaly-detection-test" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Anomaly Detection Test<a href="#anomaly-detection-test" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>From <a href="">test/e2e/sanitize.test.mjs:666-784</a>:</p>
<ul>
<li>Mock exchange returns incomplete candle with <code>open: 0.1</code> (anomaly)</li>
<li>Normal candles have <code>open: 42000</code></li>
<li><code>VALIDATE_NO_INCOMPLETE_CANDLES_FN</code> detects 0.1 &lt; 42000 / 1000 = 42</li>
<li>Error emitted via <code>errorEmitter</code></li>
<li>Test verifies error message contains &quot;anomalously low price&quot;</li>
</ul>
</div></div><div class="col-sidebar"><div class="page-menu"><div class="tsd-navigation settings"><details class="tsd-accordion"><summary class="tsd-accordion-summary"><h3><svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-chevronDown"></use></svg>Settings</h3></summary><div class="tsd-accordion-details"><div class="tsd-filter-visibility"><span class="settings-label">Member Visibility</span><ul id="tsd-filter-options"><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-protected" name="protected"/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Protected</span></label></li><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-inherited" name="inherited" checked/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Inherited</span></label></li><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-external" name="external"/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>External</span></label></li></ul></div><div class="tsd-theme-toggle"><label class="settings-label" for="tsd-theme">Theme</label><select id="tsd-theme"><option value="os">OS</option><option value="light">Light</option><option value="dark">Dark</option></select></div></div></details></div><details open class="tsd-accordion tsd-page-navigation"><summary class="tsd-accordion-summary"><h3><svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-chevronDown"></use></svg>On This Page</h3></summary><div class="tsd-accordion-details"><a href="#data-and-exchanges"><span>Data and <wbr/>Exchanges</span></a><ul><li><a href="#exchange-system-architecture"><span>Exchange <wbr/>System <wbr/>Architecture</span></a></li><li><a href="#exchange-configuration"><span>Exchange <wbr/>Configuration</span></a></li><li><ul><li><a href="#iexchangeschema-structure"><span>IExchange<wbr/>Schema <wbr/>Structure</span></a></li><li><a href="#registration-example"><span>Registration <wbr/>Example</span></a></li><li><a href="#validation-rules"><span>Validation <wbr/>Rules</span></a></li></ul></li><li><a href="#candle-data-and-vwap"><span>Candle <wbr/>Data and VWAP</span></a></li><li><ul><li><a href="#icandledata-structure"><span>ICandle<wbr/>Data <wbr/>Structure</span></a></li><li><a href="#vwap-calculation"><span>VWAP <wbr/>Calculation</span></a></li><li><a href="#price-anomaly-detection"><span>Price <wbr/>Anomaly <wbr/>Detection</span></a></li></ul></li><li><a href="#clientexchange-methods"><span>Client<wbr/>Exchange <wbr/>Methods</span></a></li><li><ul><li><a href="#getcandles-vs-getnextcandles"><span>get<wbr/>Candles vs get<wbr/>Next<wbr/>Candles</span></a></li></ul></li><li><a href="#timeframes-and-frames"><span>Timeframes and <wbr/>Frames</span></a></li><li><ul><li><a href="#iframeschema-structure"><span>IFrame<wbr/>Schema <wbr/>Structure</span></a></li><li><a href="#timeframe-generation-algorithm"><span>Timeframe <wbr/>Generation <wbr/>Algorithm</span></a></li><li><a href="#frame-registration-example"><span>Frame <wbr/>Registration <wbr/>Example</span></a></li><li><a href="#validation-rules-1"><span>Validation <wbr/>Rules</span></a></li></ul></li><li><a href="#exchange-and-frame-integration-flow"><span>Exchange and <wbr/>Frame <wbr/>Integration <wbr/>Flow</span></a></li><li><a href="#exchange-data-flow-and-caching"><span>Exchange <wbr/>Data <wbr/>Flow and <wbr/>Caching</span></a></li><li><a href="#configuration-parameters-summary"><span>Configuration <wbr/>Parameters <wbr/>Summary</span></a></li><li><a href="#error-handling-and-retry-logic"><span>Error <wbr/>Handling and <wbr/>Retry <wbr/>Logic</span></a></li><li><a href="#testing-examples"><span>Testing <wbr/>Examples</span></a></li><li><ul><li><a href="#mock-exchange-for-testing"><span>Mock <wbr/>Exchange for <wbr/>Testing</span></a></li><li><a href="#anomaly-detection-test"><span>Anomaly <wbr/>Detection <wbr/>Test</span></a></li></ul></li></ul></div></details></div><div class="site-menu"><nav class="tsd-navigation"><a href="../modules.html">backtest-kit</a><ul class="tsd-small-nested-navigation" id="tsd-nav-container"><li>Loading...</li></ul></nav></div></div></div><footer><p class="tsd-generator">Generated using <a href="https://typedoc.org/" target="_blank">TypeDoc</a></p></footer><div class="overlay"></div></body></html>

<!-- Yandex.Metrika counter -->
<script type="text/javascript">
    (function(m,e,t,r,i,k,a){
        m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
        m[i].l=1*new Date();
        for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }}
        k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)
    })(window, document,'script','https://mc.yandex.ru/metrika/tag.js?id=105455585', 'ym');

    ym(105455585, 'init', {ssr:true, webvisor:true, clickmap:true, ecommerce:"dataLayer", accurateTrackBounce:true, trackLinks:true});
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/105455585" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
<!-- /Yandex.Metrika counter -->

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-3MQZEBBDDR"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-3MQZEBBDDR');
</script>
