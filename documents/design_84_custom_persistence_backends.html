<!DOCTYPE html><html class="default" lang="en" data-base=".."><head><meta charset="utf-8"/><meta http-equiv="x-ua-compatible" content="IE=edge"/><title>design/84_custom_persistence_backends | backtest-kit</title><meta name="description" content="Documentation for backtest-kit"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="stylesheet" href="../assets/style.css"/><link rel="stylesheet" href="../assets/highlight.css"/><script defer src="../assets/main.js"></script><script async src="../assets/icons.js" id="tsd-icons-script"></script><script async src="../assets/search.js" id="tsd-search-script"></script><script async src="../assets/navigation.js" id="tsd-nav-script"></script><script async src="../assets/hierarchy.js" id="tsd-hierarchy-script"></script></head><body><script>document.documentElement.dataset.theme = localStorage.getItem("tsd-theme") || "os";document.body.style.display="none";setTimeout(() => app?app.showPage():document.body.style.removeProperty("display"),500)</script><header class="tsd-page-toolbar"><div class="tsd-toolbar-contents container"><div class="table-cell" id="tsd-search"><div class="field"><label for="tsd-search-field" class="tsd-widget tsd-toolbar-icon search no-caption"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-search"></use></svg></label><input type="text" id="tsd-search-field" aria-label="Search"/></div><div class="field"><div id="tsd-toolbar-links"></div></div><ul class="results"><li class="state loading">Preparing search index...</li><li class="state failure">The search index is not available</li></ul><a href="../index.html" class="title">backtest-kit</a></div><div class="table-cell" id="tsd-widgets"><a href="#" class="tsd-widget tsd-toolbar-icon menu no-caption" data-toggle="menu" aria-label="Menu"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-menu"></use></svg></a></div></div></header><div class="container container-main"><div class="col-content"><div class="tsd-page-title"><ul class="tsd-breadcrumb"><li><a href="../modules.html">backtest-kit</a></li><li><a href="design_84_custom_persistence_backends.html">design/84_custom_persistence_backends</a></li></ul></div><div class="tsd-panel tsd-typography"><a id="custom-persistence-backends" class="tsd-anchor"></a><h1 class="tsd-anchor-link">Custom Persistence Backends<a href="#custom-persistence-backends" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h1><a id="purpose-and-scope" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Purpose and Scope<a href="#purpose-and-scope" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>This document describes the pluggable persistence system in backtest-kit and how to implement custom storage backends. The framework uses a file-based persistence layer by default but provides a base class (<code>PersistBase</code>) and adapter registration pattern that allows replacement with alternative storage systems such as Redis, MongoDB, PostgreSQL, or other databases.</p>
<p>For information about the default persistence behavior and crash recovery in live trading, see <a href="design_56_live_trading.html">Live Trading</a>. For details on signal state lifecycle and persistence points, see <a href="design_50_signal_persistence.html">Signal Persistence</a>. For risk management state tracking, see <a href="design_65_risk_management.html">Risk Management</a>.</p>
<hr>
<a id="persistence-system-architecture" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Persistence System Architecture<a href="#persistence-system-architecture" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>The backtest-kit persistence layer is organized into four independent adapter systems, each managing a specific type of state data. All adapters extend the <code>PersistBase</code> class and can be independently replaced with custom implementations.</p>
<a id="adapter-system-overview" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Adapter System Overview<a href="#adapter-system-overview" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><img src="../media/84_Custom_Persistence_Backends_0.svg" alt="Mermaid Diagram"></p>
<a id="data-storage-organization" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Data Storage Organization<a href="#data-storage-organization" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Each adapter manages a specific entity type with its own directory structure:</p>
<table>
<thead>
<tr>
<th>Adapter</th>
<th>Entity Type</th>
<th>Storage Path</th>
<th>Purpose</th>
<th>Used By</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>PersistSignalAdapter</code></td>
<td>signal state</td>
<td><code>./dump/data/signal/{strategy}/{symbol}.json</code></td>
<td>Opened/active signals</td>
<td>Live mode only</td>
</tr>
<tr>
<td><code>PersistScheduleAdapter</code></td>
<td>scheduled signal</td>
<td><code>./dump/data/schedule/{strategy}/{symbol}.json</code></td>
<td>Limit orders waiting activation</td>
<td>Live mode only</td>
</tr>
<tr>
<td><code>PersistRiskAdapter</code></td>
<td>active positions</td>
<td><code>./dump/data/risk/{riskName}/positions.json</code></td>
<td>Portfolio-level position tracking</td>
<td>Live &amp; Backtest</td>
</tr>
<tr>
<td><code>PersistPartialAdapter</code></td>
<td>partial levels</td>
<td><code>./dump/data/partial/{symbol}/levels.json</code></td>
<td>Profit/loss milestone tracking</td>
<td>Live &amp; Backtest</td>
</tr>
</tbody>
</table>
<a id="persistence-points-in-signal-lifecycle" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Persistence Points in Signal Lifecycle<a href="#persistence-points-in-signal-lifecycle" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><img src="../media/84_Custom_Persistence_Backends_1.svg" alt="Mermaid Diagram"></p>
<hr>
<a id="persistbase-interface-reference" class="tsd-anchor"></a><h2 class="tsd-anchor-link">PersistBase Interface Reference<a href="#persistbase-interface-reference" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>The <code>PersistBase</code> abstract class defines the contract for all persistence operations. Custom adapters must implement all methods to ensure compatibility with the framework's crash recovery and state management systems.</p>
<a id="class-definition" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Class Definition<a href="#class-definition" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><img src="../media/84_Custom_Persistence_Backends_2.svg" alt="Mermaid Diagram"></p>
<a id="method-reference" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Method Reference<a href="#method-reference" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><table>
<thead>
<tr>
<th>Method</th>
<th>Parameters</th>
<th>Returns</th>
<th>Purpose</th>
<th>Required</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>waitForInit</code></td>
<td><code>initial: boolean</code></td>
<td><code>Promise&lt;void&gt;</code></td>
<td>Initialize connection, create indexes</td>
<td>Yes</td>
</tr>
<tr>
<td><code>readValue&lt;T&gt;</code></td>
<td><code>entityId: string | number</code></td>
<td><code>Promise&lt;T&gt;</code></td>
<td>Read entity by ID, throw if not found</td>
<td>Yes</td>
</tr>
<tr>
<td><code>hasValue</code></td>
<td><code>entityId: string | number</code></td>
<td><code>Promise&lt;boolean&gt;</code></td>
<td>Check entity existence</td>
<td>Yes</td>
</tr>
<tr>
<td><code>writeValue&lt;T&gt;</code></td>
<td><code>entityId, entity: T</code></td>
<td><code>Promise&lt;void&gt;</code></td>
<td>Write entity (upsert semantics)</td>
<td>Yes</td>
</tr>
<tr>
<td><code>removeValue</code></td>
<td><code>entityId: string | number</code></td>
<td><code>Promise&lt;void&gt;</code></td>
<td>Delete entity, throw if not found</td>
<td>Yes</td>
</tr>
<tr>
<td><code>removeAll</code></td>
<td>none</td>
<td><code>Promise&lt;void&gt;</code></td>
<td>Delete all entities for this type</td>
<td>Yes</td>
</tr>
<tr>
<td><code>values&lt;T&gt;</code></td>
<td>none</td>
<td><code>AsyncGenerator&lt;T&gt;</code></td>
<td>Iterate all entity values</td>
<td>Yes</td>
</tr>
<tr>
<td><code>keys</code></td>
<td>none</td>
<td><code>AsyncGenerator&lt;string&gt;</code></td>
<td>Iterate all entity IDs</td>
<td>Yes</td>
</tr>
<tr>
<td><code>filter&lt;T&gt;</code></td>
<td><code>predicate: (value: T) =&gt; boolean</code></td>
<td><code>AsyncGenerator&lt;T&gt;</code></td>
<td>Iterate filtered values</td>
<td>No (default)</td>
</tr>
<tr>
<td><code>take&lt;T&gt;</code></td>
<td><code>count: number</code></td>
<td><code>AsyncGenerator&lt;T&gt;</code></td>
<td>Iterate first N values</td>
<td>No (default)</td>
</tr>
</tbody>
</table>
<a id="constructor-parameters" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Constructor Parameters<a href="#constructor-parameters" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><pre><code class="typescript"><span class="hl-0">constructor</span><span class="hl-1">(</span><span class="hl-4">entityName</span><span class="hl-1">: </span><span class="hl-4">string</span><span class="hl-1">, </span><span class="hl-4">baseDir</span><span class="hl-1">: </span><span class="hl-4">string</span><span class="hl-1">)</span>
</code><button type="button">Copy</button></pre>

<ul>
<li><strong><code>entityName</code></strong>: Entity type identifier used for namespacing (e.g., <code>&quot;signal&quot;</code>, <code>&quot;schedule&quot;</code>, <code>&quot;risk&quot;</code>, <code>&quot;partial&quot;</code>)</li>
<li><strong><code>baseDir</code></strong>: Base directory path for storage (e.g., <code>&quot;./dump/data&quot;</code>)</li>
</ul>
<p>The constructor is called automatically by adapter registration. Custom implementations must accept both parameters and pass them to the superclass.</p>
<hr>
<a id="implementing-custom-adapters" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Implementing Custom Adapters<a href="#implementing-custom-adapters" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>Custom adapters must extend <code>PersistBase</code> and implement all abstract methods. The framework guarantees that <code>waitForInit()</code> is called before any other operations and that entity IDs are consistent within each adapter type.</p>
<a id="implementation-template" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Implementation Template<a href="#implementation-template" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><img src="../media/84_Custom_Persistence_Backends_3.svg" alt="Mermaid Diagram"></p>
<a id="redis-adapter-example" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Redis Adapter Example<a href="#redis-adapter-example" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>The following example demonstrates a production-ready Redis adapter with proper error handling and key namespacing:</p>
<pre><code class="typescript"><span class="hl-3">import</span><span class="hl-1"> { </span><span class="hl-4">PersistBase</span><span class="hl-1"> } </span><span class="hl-3">from</span><span class="hl-1"> </span><span class="hl-2">&quot;backtest-kit&quot;</span><span class="hl-1">;</span><br/><span class="hl-3">import</span><span class="hl-1"> </span><span class="hl-4">Redis</span><span class="hl-1"> </span><span class="hl-3">from</span><span class="hl-1"> </span><span class="hl-2">&quot;ioredis&quot;</span><span class="hl-1">;</span><br/><br/><span class="hl-6">class</span><span class="hl-1"> </span><span class="hl-10">RedisPersist</span><span class="hl-1"> </span><span class="hl-6">extends</span><span class="hl-1"> </span><span class="hl-10">PersistBase</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-6">private</span><span class="hl-1"> </span><span class="hl-4">redis</span><span class="hl-1">: </span><span class="hl-10">Redis</span><span class="hl-1">;</span><br/><span class="hl-1">  </span><br/><span class="hl-1">  </span><span class="hl-6">constructor</span><span class="hl-1">(</span><span class="hl-4">entityName</span><span class="hl-1">: </span><span class="hl-10">string</span><span class="hl-1">, </span><span class="hl-4">baseDir</span><span class="hl-1">: </span><span class="hl-10">string</span><span class="hl-1">) {</span><br/><span class="hl-1">    </span><span class="hl-6">super</span><span class="hl-1">(</span><span class="hl-4">entityName</span><span class="hl-1">, </span><span class="hl-4">baseDir</span><span class="hl-1">);</span><br/><span class="hl-1">    </span><span class="hl-6">this</span><span class="hl-1">.</span><span class="hl-4">redis</span><span class="hl-1"> = </span><span class="hl-6">new</span><span class="hl-1"> </span><span class="hl-0">Redis</span><span class="hl-1">(); </span><span class="hl-5">// Default connection</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">  </span><br/><span class="hl-1">  </span><span class="hl-5">// Initialize connection - called once before any operations</span><br/><span class="hl-1">  </span><span class="hl-6">async</span><span class="hl-1"> </span><span class="hl-0">waitForInit</span><span class="hl-1">(</span><span class="hl-4">initial</span><span class="hl-1">: </span><span class="hl-10">boolean</span><span class="hl-1">): </span><span class="hl-10">Promise</span><span class="hl-1">&lt;</span><span class="hl-10">void</span><span class="hl-1">&gt; {</span><br/><span class="hl-1">    </span><span class="hl-4">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-2">`Redis persistence initialized for </span><span class="hl-6">${</span><span class="hl-6">this</span><span class="hl-9">.</span><span class="hl-4">entityName</span><span class="hl-6">}</span><span class="hl-2">`</span><span class="hl-1">);</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">  </span><br/><span class="hl-1">  </span><span class="hl-5">// Read entity - throw if not found</span><br/><span class="hl-1">  </span><span class="hl-6">async</span><span class="hl-1"> </span><span class="hl-0">readValue</span><span class="hl-1">&lt;</span><span class="hl-10">T</span><span class="hl-1">&gt;(</span><span class="hl-4">entityId</span><span class="hl-1">: </span><span class="hl-10">string</span><span class="hl-1"> | </span><span class="hl-10">number</span><span class="hl-1">): </span><span class="hl-10">Promise</span><span class="hl-1">&lt;</span><span class="hl-10">T</span><span class="hl-1">&gt; {</span><br/><span class="hl-1">    </span><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">key</span><span class="hl-1"> = </span><span class="hl-2">`</span><span class="hl-6">${</span><span class="hl-6">this</span><span class="hl-9">.</span><span class="hl-4">entityName</span><span class="hl-6">}</span><span class="hl-2">:</span><span class="hl-6">${</span><span class="hl-4">entityId</span><span class="hl-6">}</span><span class="hl-2">`</span><span class="hl-1">;</span><br/><span class="hl-1">    </span><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">data</span><span class="hl-1"> = </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-6">this</span><span class="hl-1">.</span><span class="hl-4">redis</span><span class="hl-1">.</span><span class="hl-0">get</span><span class="hl-1">(</span><span class="hl-4">key</span><span class="hl-1">);</span><br/><span class="hl-1">    </span><br/><span class="hl-1">    </span><span class="hl-3">if</span><span class="hl-1"> (!</span><span class="hl-4">data</span><span class="hl-1">) {</span><br/><span class="hl-1">      </span><span class="hl-3">throw</span><span class="hl-1"> </span><span class="hl-6">new</span><span class="hl-1"> </span><span class="hl-0">Error</span><span class="hl-1">(</span><span class="hl-2">`Entity </span><span class="hl-6">${</span><span class="hl-6">this</span><span class="hl-9">.</span><span class="hl-4">entityName</span><span class="hl-6">}</span><span class="hl-2">:</span><span class="hl-6">${</span><span class="hl-4">entityId</span><span class="hl-6">}</span><span class="hl-2"> not found`</span><span class="hl-1">);</span><br/><span class="hl-1">    }</span><br/><span class="hl-1">    </span><br/><span class="hl-1">    </span><span class="hl-3">return</span><span class="hl-1"> </span><span class="hl-7">JSON</span><span class="hl-1">.</span><span class="hl-0">parse</span><span class="hl-1">(</span><span class="hl-4">data</span><span class="hl-1">) </span><span class="hl-3">as</span><span class="hl-1"> </span><span class="hl-10">T</span><span class="hl-1">;</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">  </span><br/><span class="hl-1">  </span><span class="hl-5">// Check existence</span><br/><span class="hl-1">  </span><span class="hl-6">async</span><span class="hl-1"> </span><span class="hl-0">hasValue</span><span class="hl-1">(</span><span class="hl-4">entityId</span><span class="hl-1">: </span><span class="hl-10">string</span><span class="hl-1"> | </span><span class="hl-10">number</span><span class="hl-1">): </span><span class="hl-10">Promise</span><span class="hl-1">&lt;</span><span class="hl-10">boolean</span><span class="hl-1">&gt; {</span><br/><span class="hl-1">    </span><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">key</span><span class="hl-1"> = </span><span class="hl-2">`</span><span class="hl-6">${</span><span class="hl-6">this</span><span class="hl-9">.</span><span class="hl-4">entityName</span><span class="hl-6">}</span><span class="hl-2">:</span><span class="hl-6">${</span><span class="hl-4">entityId</span><span class="hl-6">}</span><span class="hl-2">`</span><span class="hl-1">;</span><br/><span class="hl-1">    </span><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">exists</span><span class="hl-1"> = </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-6">this</span><span class="hl-1">.</span><span class="hl-4">redis</span><span class="hl-1">.</span><span class="hl-0">exists</span><span class="hl-1">(</span><span class="hl-4">key</span><span class="hl-1">);</span><br/><span class="hl-1">    </span><span class="hl-3">return</span><span class="hl-1"> </span><span class="hl-4">exists</span><span class="hl-1"> === </span><span class="hl-8">1</span><span class="hl-1">;</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">  </span><br/><span class="hl-1">  </span><span class="hl-5">// Write entity (upsert)</span><br/><span class="hl-1">  </span><span class="hl-6">async</span><span class="hl-1"> </span><span class="hl-0">writeValue</span><span class="hl-1">&lt;</span><span class="hl-10">T</span><span class="hl-1">&gt;(</span><span class="hl-4">entityId</span><span class="hl-1">: </span><span class="hl-10">string</span><span class="hl-1"> | </span><span class="hl-10">number</span><span class="hl-1">, </span><span class="hl-4">entity</span><span class="hl-1">: </span><span class="hl-10">T</span><span class="hl-1">): </span><span class="hl-10">Promise</span><span class="hl-1">&lt;</span><span class="hl-10">void</span><span class="hl-1">&gt; {</span><br/><span class="hl-1">    </span><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">key</span><span class="hl-1"> = </span><span class="hl-2">`</span><span class="hl-6">${</span><span class="hl-6">this</span><span class="hl-9">.</span><span class="hl-4">entityName</span><span class="hl-6">}</span><span class="hl-2">:</span><span class="hl-6">${</span><span class="hl-4">entityId</span><span class="hl-6">}</span><span class="hl-2">`</span><span class="hl-1">;</span><br/><span class="hl-1">    </span><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">serializedData</span><span class="hl-1"> = </span><span class="hl-7">JSON</span><span class="hl-1">.</span><span class="hl-0">stringify</span><span class="hl-1">(</span><span class="hl-4">entity</span><span class="hl-1">);</span><br/><span class="hl-1">    </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-6">this</span><span class="hl-1">.</span><span class="hl-4">redis</span><span class="hl-1">.</span><span class="hl-0">set</span><span class="hl-1">(</span><span class="hl-4">key</span><span class="hl-1">, </span><span class="hl-4">serializedData</span><span class="hl-1">);</span><br/><span class="hl-1">    </span><br/><span class="hl-1">    </span><span class="hl-5">// Optional: Set TTL for automatic cleanup</span><br/><span class="hl-1">    </span><span class="hl-5">// await this.redis.expire(key, 86400); // 24 hours</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">  </span><br/><span class="hl-1">  </span><span class="hl-5">// Remove entity - throw if not found</span><br/><span class="hl-1">  </span><span class="hl-6">async</span><span class="hl-1"> </span><span class="hl-0">removeValue</span><span class="hl-1">(</span><span class="hl-4">entityId</span><span class="hl-1">: </span><span class="hl-10">string</span><span class="hl-1"> | </span><span class="hl-10">number</span><span class="hl-1">): </span><span class="hl-10">Promise</span><span class="hl-1">&lt;</span><span class="hl-10">void</span><span class="hl-1">&gt; {</span><br/><span class="hl-1">    </span><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">key</span><span class="hl-1"> = </span><span class="hl-2">`</span><span class="hl-6">${</span><span class="hl-6">this</span><span class="hl-9">.</span><span class="hl-4">entityName</span><span class="hl-6">}</span><span class="hl-2">:</span><span class="hl-6">${</span><span class="hl-4">entityId</span><span class="hl-6">}</span><span class="hl-2">`</span><span class="hl-1">;</span><br/><span class="hl-1">    </span><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">result</span><span class="hl-1"> = </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-6">this</span><span class="hl-1">.</span><span class="hl-4">redis</span><span class="hl-1">.</span><span class="hl-0">del</span><span class="hl-1">(</span><span class="hl-4">key</span><span class="hl-1">);</span><br/><span class="hl-1">    </span><br/><span class="hl-1">    </span><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-4">result</span><span class="hl-1"> === </span><span class="hl-8">0</span><span class="hl-1">) {</span><br/><span class="hl-1">      </span><span class="hl-3">throw</span><span class="hl-1"> </span><span class="hl-6">new</span><span class="hl-1"> </span><span class="hl-0">Error</span><span class="hl-1">(</span><span class="hl-2">`Entity </span><span class="hl-6">${</span><span class="hl-6">this</span><span class="hl-9">.</span><span class="hl-4">entityName</span><span class="hl-6">}</span><span class="hl-2">:</span><span class="hl-6">${</span><span class="hl-4">entityId</span><span class="hl-6">}</span><span class="hl-2"> not found for deletion`</span><span class="hl-1">);</span><br/><span class="hl-1">    }</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">  </span><br/><span class="hl-1">  </span><span class="hl-5">// Remove all entities</span><br/><span class="hl-1">  </span><span class="hl-6">async</span><span class="hl-1"> </span><span class="hl-0">removeAll</span><span class="hl-1">(): </span><span class="hl-10">Promise</span><span class="hl-1">&lt;</span><span class="hl-10">void</span><span class="hl-1">&gt; {</span><br/><span class="hl-1">    </span><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">pattern</span><span class="hl-1"> = </span><span class="hl-2">`</span><span class="hl-6">${</span><span class="hl-6">this</span><span class="hl-9">.</span><span class="hl-4">entityName</span><span class="hl-6">}</span><span class="hl-2">:*`</span><span class="hl-1">;</span><br/><span class="hl-1">    </span><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">keys</span><span class="hl-1"> = </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-6">this</span><span class="hl-1">.</span><span class="hl-4">redis</span><span class="hl-1">.</span><span class="hl-0">keys</span><span class="hl-1">(</span><span class="hl-4">pattern</span><span class="hl-1">);</span><br/><span class="hl-1">    </span><br/><span class="hl-1">    </span><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-4">keys</span><span class="hl-1">.</span><span class="hl-4">length</span><span class="hl-1"> &gt; </span><span class="hl-8">0</span><span class="hl-1">) {</span><br/><span class="hl-1">      </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-6">this</span><span class="hl-1">.</span><span class="hl-4">redis</span><span class="hl-1">.</span><span class="hl-0">del</span><span class="hl-1">(...</span><span class="hl-4">keys</span><span class="hl-1">);</span><br/><span class="hl-1">    }</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">  </span><br/><span class="hl-1">  </span><span class="hl-5">// Iterate values</span><br/><span class="hl-1">  </span><span class="hl-6">async</span><span class="hl-1"> </span><span class="hl-6">*</span><span class="hl-0">values</span><span class="hl-1">&lt;</span><span class="hl-10">T</span><span class="hl-1">&gt;(): </span><span class="hl-10">AsyncGenerator</span><span class="hl-1">&lt;</span><span class="hl-10">T</span><span class="hl-1">&gt; {</span><br/><span class="hl-1">    </span><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">pattern</span><span class="hl-1"> = </span><span class="hl-2">`</span><span class="hl-6">${</span><span class="hl-6">this</span><span class="hl-9">.</span><span class="hl-4">entityName</span><span class="hl-6">}</span><span class="hl-2">:*`</span><span class="hl-1">;</span><br/><span class="hl-1">    </span><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">keys</span><span class="hl-1"> = </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-6">this</span><span class="hl-1">.</span><span class="hl-4">redis</span><span class="hl-1">.</span><span class="hl-0">keys</span><span class="hl-1">(</span><span class="hl-4">pattern</span><span class="hl-1">);</span><br/><span class="hl-1">    </span><br/><span class="hl-1">    </span><span class="hl-5">// Sort alphanumerically for consistent ordering</span><br/><span class="hl-1">    </span><span class="hl-4">keys</span><span class="hl-1">.</span><span class="hl-0">sort</span><span class="hl-1">((</span><span class="hl-4">a</span><span class="hl-1">, </span><span class="hl-4">b</span><span class="hl-1">) </span><span class="hl-6">=&gt;</span><span class="hl-1"> </span><span class="hl-4">a</span><span class="hl-1">.</span><span class="hl-0">localeCompare</span><span class="hl-1">(</span><span class="hl-4">b</span><span class="hl-1">, </span><span class="hl-6">undefined</span><span class="hl-1">, {</span><br/><span class="hl-1">      </span><span class="hl-4">numeric:</span><span class="hl-1"> </span><span class="hl-6">true</span><span class="hl-1">,</span><br/><span class="hl-1">      </span><span class="hl-4">sensitivity:</span><span class="hl-1"> </span><span class="hl-2">&quot;base&quot;</span><br/><span class="hl-1">    }));</span><br/><span class="hl-1">    </span><br/><span class="hl-1">    </span><span class="hl-3">for</span><span class="hl-1"> (</span><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">key</span><span class="hl-1"> </span><span class="hl-6">of</span><span class="hl-1"> </span><span class="hl-4">keys</span><span class="hl-1">) {</span><br/><span class="hl-1">      </span><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">data</span><span class="hl-1"> = </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-6">this</span><span class="hl-1">.</span><span class="hl-4">redis</span><span class="hl-1">.</span><span class="hl-0">get</span><span class="hl-1">(</span><span class="hl-4">key</span><span class="hl-1">);</span><br/><span class="hl-1">      </span><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-4">data</span><span class="hl-1">) {</span><br/><span class="hl-1">        </span><span class="hl-3">yield</span><span class="hl-1"> </span><span class="hl-7">JSON</span><span class="hl-1">.</span><span class="hl-0">parse</span><span class="hl-1">(</span><span class="hl-4">data</span><span class="hl-1">) </span><span class="hl-3">as</span><span class="hl-1"> </span><span class="hl-10">T</span><span class="hl-1">;</span><br/><span class="hl-1">      }</span><br/><span class="hl-1">    }</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">  </span><br/><span class="hl-1">  </span><span class="hl-5">// Iterate keys</span><br/><span class="hl-1">  </span><span class="hl-6">async</span><span class="hl-1"> </span><span class="hl-6">*</span><span class="hl-0">keys</span><span class="hl-1">(): </span><span class="hl-10">AsyncGenerator</span><span class="hl-1">&lt;</span><span class="hl-10">string</span><span class="hl-1">&gt; {</span><br/><span class="hl-1">    </span><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">pattern</span><span class="hl-1"> = </span><span class="hl-2">`</span><span class="hl-6">${</span><span class="hl-6">this</span><span class="hl-9">.</span><span class="hl-4">entityName</span><span class="hl-6">}</span><span class="hl-2">:*`</span><span class="hl-1">;</span><br/><span class="hl-1">    </span><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">keys</span><span class="hl-1"> = </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-6">this</span><span class="hl-1">.</span><span class="hl-4">redis</span><span class="hl-1">.</span><span class="hl-0">keys</span><span class="hl-1">(</span><span class="hl-4">pattern</span><span class="hl-1">);</span><br/><span class="hl-1">    </span><br/><span class="hl-1">    </span><span class="hl-5">// Sort alphanumerically</span><br/><span class="hl-1">    </span><span class="hl-4">keys</span><span class="hl-1">.</span><span class="hl-0">sort</span><span class="hl-1">((</span><span class="hl-4">a</span><span class="hl-1">, </span><span class="hl-4">b</span><span class="hl-1">) </span><span class="hl-6">=&gt;</span><span class="hl-1"> </span><span class="hl-4">a</span><span class="hl-1">.</span><span class="hl-0">localeCompare</span><span class="hl-1">(</span><span class="hl-4">b</span><span class="hl-1">, </span><span class="hl-6">undefined</span><span class="hl-1">, {</span><br/><span class="hl-1">      </span><span class="hl-4">numeric:</span><span class="hl-1"> </span><span class="hl-6">true</span><span class="hl-1">,</span><br/><span class="hl-1">      </span><span class="hl-4">sensitivity:</span><span class="hl-1"> </span><span class="hl-2">&quot;base&quot;</span><br/><span class="hl-1">    }));</span><br/><span class="hl-1">    </span><br/><span class="hl-1">    </span><span class="hl-3">for</span><span class="hl-1"> (</span><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">key</span><span class="hl-1"> </span><span class="hl-6">of</span><span class="hl-1"> </span><span class="hl-4">keys</span><span class="hl-1">) {</span><br/><span class="hl-1">      </span><span class="hl-5">// Extract entity ID from key (remove prefix)</span><br/><span class="hl-1">      </span><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">entityId</span><span class="hl-1"> = </span><span class="hl-4">key</span><span class="hl-1">.</span><span class="hl-0">slice</span><span class="hl-1">(</span><span class="hl-6">this</span><span class="hl-1">.</span><span class="hl-4">entityName</span><span class="hl-1">.</span><span class="hl-4">length</span><span class="hl-1"> + </span><span class="hl-8">1</span><span class="hl-1">);</span><br/><span class="hl-1">      </span><span class="hl-3">yield</span><span class="hl-1"> </span><span class="hl-4">entityId</span><span class="hl-1">;</span><br/><span class="hl-1">    }</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<a id="mongodb-adapter-example" class="tsd-anchor"></a><h3 class="tsd-anchor-link">MongoDB Adapter Example<a href="#mongodb-adapter-example" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>MongoDB adapter with proper indexing and collection management:</p>
<pre><code class="typescript"><span class="hl-3">import</span><span class="hl-1"> { </span><span class="hl-4">PersistBase</span><span class="hl-1"> } </span><span class="hl-3">from</span><span class="hl-1"> </span><span class="hl-2">&quot;backtest-kit&quot;</span><span class="hl-1">;</span><br/><span class="hl-3">import</span><span class="hl-1"> { </span><span class="hl-4">MongoClient</span><span class="hl-1">, </span><span class="hl-4">Collection</span><span class="hl-1"> } </span><span class="hl-3">from</span><span class="hl-1"> </span><span class="hl-2">&quot;mongodb&quot;</span><span class="hl-1">;</span><br/><br/><span class="hl-6">class</span><span class="hl-1"> </span><span class="hl-10">MongoPersist</span><span class="hl-1"> </span><span class="hl-6">extends</span><span class="hl-1"> </span><span class="hl-10">PersistBase</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-6">private</span><span class="hl-1"> </span><span class="hl-4">client</span><span class="hl-1">: </span><span class="hl-10">MongoClient</span><span class="hl-1">;</span><br/><span class="hl-1">  </span><span class="hl-6">private</span><span class="hl-1"> </span><span class="hl-4">collection</span><span class="hl-1">: </span><span class="hl-10">Collection</span><span class="hl-1">;</span><br/><span class="hl-1">  </span><br/><span class="hl-1">  </span><span class="hl-6">constructor</span><span class="hl-1">(</span><span class="hl-4">entityName</span><span class="hl-1">: </span><span class="hl-10">string</span><span class="hl-1">, </span><span class="hl-4">baseDir</span><span class="hl-1">: </span><span class="hl-10">string</span><span class="hl-1">) {</span><br/><span class="hl-1">    </span><span class="hl-6">super</span><span class="hl-1">(</span><span class="hl-4">entityName</span><span class="hl-1">, </span><span class="hl-4">baseDir</span><span class="hl-1">);</span><br/><span class="hl-1">    </span><span class="hl-6">this</span><span class="hl-1">.</span><span class="hl-4">client</span><span class="hl-1"> = </span><span class="hl-6">new</span><span class="hl-1"> </span><span class="hl-0">MongoClient</span><span class="hl-1">(</span><span class="hl-2">&quot;mongodb://localhost:27017&quot;</span><span class="hl-1">);</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">  </span><br/><span class="hl-1">  </span><span class="hl-6">async</span><span class="hl-1"> </span><span class="hl-0">waitForInit</span><span class="hl-1">(</span><span class="hl-4">initial</span><span class="hl-1">: </span><span class="hl-10">boolean</span><span class="hl-1">): </span><span class="hl-10">Promise</span><span class="hl-1">&lt;</span><span class="hl-10">void</span><span class="hl-1">&gt; {</span><br/><span class="hl-1">    </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-6">this</span><span class="hl-1">.</span><span class="hl-4">client</span><span class="hl-1">.</span><span class="hl-0">connect</span><span class="hl-1">();</span><br/><span class="hl-1">    </span><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">db</span><span class="hl-1"> = </span><span class="hl-6">this</span><span class="hl-1">.</span><span class="hl-4">client</span><span class="hl-1">.</span><span class="hl-0">db</span><span class="hl-1">(</span><span class="hl-2">&quot;backtest-kit&quot;</span><span class="hl-1">);</span><br/><span class="hl-1">    </span><span class="hl-6">this</span><span class="hl-1">.</span><span class="hl-4">collection</span><span class="hl-1"> = </span><span class="hl-4">db</span><span class="hl-1">.</span><span class="hl-0">collection</span><span class="hl-1">(</span><span class="hl-6">this</span><span class="hl-1">.</span><span class="hl-4">entityName</span><span class="hl-1">);</span><br/><span class="hl-1">    </span><br/><span class="hl-1">    </span><span class="hl-5">// Create unique index for faster lookups</span><br/><span class="hl-1">    </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-6">this</span><span class="hl-1">.</span><span class="hl-4">collection</span><span class="hl-1">.</span><span class="hl-0">createIndex</span><span class="hl-1">({ </span><span class="hl-4">entityId:</span><span class="hl-1"> </span><span class="hl-8">1</span><span class="hl-1"> }, { </span><span class="hl-4">unique:</span><span class="hl-1"> </span><span class="hl-6">true</span><span class="hl-1"> });</span><br/><span class="hl-1">    </span><span class="hl-4">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-2">`MongoDB persistence initialized for </span><span class="hl-6">${</span><span class="hl-6">this</span><span class="hl-9">.</span><span class="hl-4">entityName</span><span class="hl-6">}</span><span class="hl-2">`</span><span class="hl-1">);</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">  </span><br/><span class="hl-1">  </span><span class="hl-6">async</span><span class="hl-1"> </span><span class="hl-0">readValue</span><span class="hl-1">&lt;</span><span class="hl-10">T</span><span class="hl-1">&gt;(</span><span class="hl-4">entityId</span><span class="hl-1">: </span><span class="hl-10">string</span><span class="hl-1"> | </span><span class="hl-10">number</span><span class="hl-1">): </span><span class="hl-10">Promise</span><span class="hl-1">&lt;</span><span class="hl-10">T</span><span class="hl-1">&gt; {</span><br/><span class="hl-1">    </span><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">doc</span><span class="hl-1"> = </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-6">this</span><span class="hl-1">.</span><span class="hl-4">collection</span><span class="hl-1">.</span><span class="hl-0">findOne</span><span class="hl-1">({ </span><span class="hl-4">entityId</span><span class="hl-1"> });</span><br/><span class="hl-1">    </span><br/><span class="hl-1">    </span><span class="hl-3">if</span><span class="hl-1"> (!</span><span class="hl-4">doc</span><span class="hl-1">) {</span><br/><span class="hl-1">      </span><span class="hl-3">throw</span><span class="hl-1"> </span><span class="hl-6">new</span><span class="hl-1"> </span><span class="hl-0">Error</span><span class="hl-1">(</span><span class="hl-2">`Entity </span><span class="hl-6">${</span><span class="hl-6">this</span><span class="hl-9">.</span><span class="hl-4">entityName</span><span class="hl-6">}</span><span class="hl-2">:</span><span class="hl-6">${</span><span class="hl-4">entityId</span><span class="hl-6">}</span><span class="hl-2"> not found`</span><span class="hl-1">);</span><br/><span class="hl-1">    }</span><br/><span class="hl-1">    </span><br/><span class="hl-1">    </span><span class="hl-3">return</span><span class="hl-1"> </span><span class="hl-4">doc</span><span class="hl-1">.</span><span class="hl-4">data</span><span class="hl-1"> </span><span class="hl-3">as</span><span class="hl-1"> </span><span class="hl-10">T</span><span class="hl-1">;</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">  </span><br/><span class="hl-1">  </span><span class="hl-6">async</span><span class="hl-1"> </span><span class="hl-0">hasValue</span><span class="hl-1">(</span><span class="hl-4">entityId</span><span class="hl-1">: </span><span class="hl-10">string</span><span class="hl-1"> | </span><span class="hl-10">number</span><span class="hl-1">): </span><span class="hl-10">Promise</span><span class="hl-1">&lt;</span><span class="hl-10">boolean</span><span class="hl-1">&gt; {</span><br/><span class="hl-1">    </span><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">count</span><span class="hl-1"> = </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-6">this</span><span class="hl-1">.</span><span class="hl-4">collection</span><span class="hl-1">.</span><span class="hl-0">countDocuments</span><span class="hl-1">({ </span><span class="hl-4">entityId</span><span class="hl-1"> });</span><br/><span class="hl-1">    </span><span class="hl-3">return</span><span class="hl-1"> </span><span class="hl-4">count</span><span class="hl-1"> &gt; </span><span class="hl-8">0</span><span class="hl-1">;</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">  </span><br/><span class="hl-1">  </span><span class="hl-6">async</span><span class="hl-1"> </span><span class="hl-0">writeValue</span><span class="hl-1">&lt;</span><span class="hl-10">T</span><span class="hl-1">&gt;(</span><span class="hl-4">entityId</span><span class="hl-1">: </span><span class="hl-10">string</span><span class="hl-1"> | </span><span class="hl-10">number</span><span class="hl-1">, </span><span class="hl-4">entity</span><span class="hl-1">: </span><span class="hl-10">T</span><span class="hl-1">): </span><span class="hl-10">Promise</span><span class="hl-1">&lt;</span><span class="hl-10">void</span><span class="hl-1">&gt; {</span><br/><span class="hl-1">    </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-6">this</span><span class="hl-1">.</span><span class="hl-4">collection</span><span class="hl-1">.</span><span class="hl-0">updateOne</span><span class="hl-1">(</span><br/><span class="hl-1">      { </span><span class="hl-4">entityId</span><span class="hl-1"> },</span><br/><span class="hl-1">      { </span><span class="hl-4">$set:</span><span class="hl-1"> { </span><span class="hl-4">entityId</span><span class="hl-1">, </span><span class="hl-4">data:</span><span class="hl-1"> </span><span class="hl-4">entity</span><span class="hl-1">, </span><span class="hl-4">updatedAt:</span><span class="hl-1"> </span><span class="hl-6">new</span><span class="hl-1"> </span><span class="hl-0">Date</span><span class="hl-1">() } },</span><br/><span class="hl-1">      { </span><span class="hl-4">upsert:</span><span class="hl-1"> </span><span class="hl-6">true</span><span class="hl-1"> }</span><br/><span class="hl-1">    );</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">  </span><br/><span class="hl-1">  </span><span class="hl-6">async</span><span class="hl-1"> </span><span class="hl-0">removeValue</span><span class="hl-1">(</span><span class="hl-4">entityId</span><span class="hl-1">: </span><span class="hl-10">string</span><span class="hl-1"> | </span><span class="hl-10">number</span><span class="hl-1">): </span><span class="hl-10">Promise</span><span class="hl-1">&lt;</span><span class="hl-10">void</span><span class="hl-1">&gt; {</span><br/><span class="hl-1">    </span><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">result</span><span class="hl-1"> = </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-6">this</span><span class="hl-1">.</span><span class="hl-4">collection</span><span class="hl-1">.</span><span class="hl-0">deleteOne</span><span class="hl-1">({ </span><span class="hl-4">entityId</span><span class="hl-1"> });</span><br/><span class="hl-1">    </span><br/><span class="hl-1">    </span><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-4">result</span><span class="hl-1">.</span><span class="hl-4">deletedCount</span><span class="hl-1"> === </span><span class="hl-8">0</span><span class="hl-1">) {</span><br/><span class="hl-1">      </span><span class="hl-3">throw</span><span class="hl-1"> </span><span class="hl-6">new</span><span class="hl-1"> </span><span class="hl-0">Error</span><span class="hl-1">(</span><span class="hl-2">`Entity </span><span class="hl-6">${</span><span class="hl-6">this</span><span class="hl-9">.</span><span class="hl-4">entityName</span><span class="hl-6">}</span><span class="hl-2">:</span><span class="hl-6">${</span><span class="hl-4">entityId</span><span class="hl-6">}</span><span class="hl-2"> not found for deletion`</span><span class="hl-1">);</span><br/><span class="hl-1">    }</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">  </span><br/><span class="hl-1">  </span><span class="hl-6">async</span><span class="hl-1"> </span><span class="hl-0">removeAll</span><span class="hl-1">(): </span><span class="hl-10">Promise</span><span class="hl-1">&lt;</span><span class="hl-10">void</span><span class="hl-1">&gt; {</span><br/><span class="hl-1">    </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-6">this</span><span class="hl-1">.</span><span class="hl-4">collection</span><span class="hl-1">.</span><span class="hl-0">deleteMany</span><span class="hl-1">({});</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">  </span><br/><span class="hl-1">  </span><span class="hl-6">async</span><span class="hl-1"> </span><span class="hl-6">*</span><span class="hl-0">values</span><span class="hl-1">&lt;</span><span class="hl-10">T</span><span class="hl-1">&gt;(): </span><span class="hl-10">AsyncGenerator</span><span class="hl-1">&lt;</span><span class="hl-10">T</span><span class="hl-1">&gt; {</span><br/><span class="hl-1">    </span><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">cursor</span><span class="hl-1"> = </span><span class="hl-6">this</span><span class="hl-1">.</span><span class="hl-4">collection</span><span class="hl-1">.</span><span class="hl-0">find</span><span class="hl-1">({}).</span><span class="hl-0">sort</span><span class="hl-1">({ </span><span class="hl-4">entityId:</span><span class="hl-1"> </span><span class="hl-8">1</span><span class="hl-1"> });</span><br/><span class="hl-1">    </span><br/><span class="hl-1">    </span><span class="hl-3">for</span><span class="hl-1"> </span><span class="hl-3">await</span><span class="hl-1"> (</span><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">doc</span><span class="hl-1"> </span><span class="hl-6">of</span><span class="hl-1"> </span><span class="hl-4">cursor</span><span class="hl-1">) {</span><br/><span class="hl-1">      </span><span class="hl-3">yield</span><span class="hl-1"> </span><span class="hl-4">doc</span><span class="hl-1">.</span><span class="hl-4">data</span><span class="hl-1"> </span><span class="hl-3">as</span><span class="hl-1"> </span><span class="hl-10">T</span><span class="hl-1">;</span><br/><span class="hl-1">    }</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">  </span><br/><span class="hl-1">  </span><span class="hl-6">async</span><span class="hl-1"> </span><span class="hl-6">*</span><span class="hl-0">keys</span><span class="hl-1">(): </span><span class="hl-10">AsyncGenerator</span><span class="hl-1">&lt;</span><span class="hl-10">string</span><span class="hl-1">&gt; {</span><br/><span class="hl-1">    </span><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">cursor</span><span class="hl-1"> = </span><span class="hl-6">this</span><span class="hl-1">.</span><span class="hl-4">collection</span><br/><span class="hl-1">      .</span><span class="hl-0">find</span><span class="hl-1">({}, { </span><span class="hl-4">projection:</span><span class="hl-1"> { </span><span class="hl-4">entityId:</span><span class="hl-1"> </span><span class="hl-8">1</span><span class="hl-1"> } })</span><br/><span class="hl-1">      .</span><span class="hl-0">sort</span><span class="hl-1">({ </span><span class="hl-4">entityId:</span><span class="hl-1"> </span><span class="hl-8">1</span><span class="hl-1"> });</span><br/><span class="hl-1">    </span><br/><span class="hl-1">    </span><span class="hl-3">for</span><span class="hl-1"> </span><span class="hl-3">await</span><span class="hl-1"> (</span><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">doc</span><span class="hl-1"> </span><span class="hl-6">of</span><span class="hl-1"> </span><span class="hl-4">cursor</span><span class="hl-1">) {</span><br/><span class="hl-1">      </span><span class="hl-3">yield</span><span class="hl-1"> </span><span class="hl-0">String</span><span class="hl-1">(</span><span class="hl-4">doc</span><span class="hl-1">.</span><span class="hl-4">entityId</span><span class="hl-1">);</span><br/><span class="hl-1">    }</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<a id="postgresql-adapter-example" class="tsd-anchor"></a><h3 class="tsd-anchor-link">PostgreSQL Adapter Example<a href="#postgresql-adapter-example" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>PostgreSQL adapter with ACID transaction support:</p>
<pre><code class="typescript"><span class="hl-3">import</span><span class="hl-1"> { </span><span class="hl-4">PersistBase</span><span class="hl-1"> } </span><span class="hl-3">from</span><span class="hl-1"> </span><span class="hl-2">&quot;backtest-kit&quot;</span><span class="hl-1">;</span><br/><span class="hl-3">import</span><span class="hl-1"> { </span><span class="hl-4">Pool</span><span class="hl-1"> } </span><span class="hl-3">from</span><span class="hl-1"> </span><span class="hl-2">&quot;pg&quot;</span><span class="hl-1">;</span><br/><br/><span class="hl-6">class</span><span class="hl-1"> </span><span class="hl-10">PostgresPersist</span><span class="hl-1"> </span><span class="hl-6">extends</span><span class="hl-1"> </span><span class="hl-10">PersistBase</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-6">private</span><span class="hl-1"> </span><span class="hl-4">pool</span><span class="hl-1">: </span><span class="hl-10">Pool</span><span class="hl-1">;</span><br/><span class="hl-1">  </span><span class="hl-6">private</span><span class="hl-1"> </span><span class="hl-4">tableName</span><span class="hl-1">: </span><span class="hl-10">string</span><span class="hl-1">;</span><br/><span class="hl-1">  </span><br/><span class="hl-1">  </span><span class="hl-6">constructor</span><span class="hl-1">(</span><span class="hl-4">entityName</span><span class="hl-1">: </span><span class="hl-10">string</span><span class="hl-1">, </span><span class="hl-4">baseDir</span><span class="hl-1">: </span><span class="hl-10">string</span><span class="hl-1">) {</span><br/><span class="hl-1">    </span><span class="hl-6">super</span><span class="hl-1">(</span><span class="hl-4">entityName</span><span class="hl-1">, </span><span class="hl-4">baseDir</span><span class="hl-1">);</span><br/><span class="hl-1">    </span><span class="hl-6">this</span><span class="hl-1">.</span><span class="hl-4">pool</span><span class="hl-1"> = </span><span class="hl-6">new</span><span class="hl-1"> </span><span class="hl-0">Pool</span><span class="hl-1">({</span><br/><span class="hl-1">      </span><span class="hl-4">host:</span><span class="hl-1"> </span><span class="hl-2">&quot;localhost&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">      </span><span class="hl-4">port:</span><span class="hl-1"> </span><span class="hl-8">5432</span><span class="hl-1">,</span><br/><span class="hl-1">      </span><span class="hl-4">database:</span><span class="hl-1"> </span><span class="hl-2">&quot;backtest_kit&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">      </span><span class="hl-4">user:</span><span class="hl-1"> </span><span class="hl-2">&quot;postgres&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">      </span><span class="hl-4">password:</span><span class="hl-1"> </span><span class="hl-2">&quot;password&quot;</span><br/><span class="hl-1">    });</span><br/><span class="hl-1">    </span><span class="hl-5">// Sanitize table name</span><br/><span class="hl-1">    </span><span class="hl-6">this</span><span class="hl-1">.</span><span class="hl-4">tableName</span><span class="hl-1"> = </span><span class="hl-2">`persist_</span><span class="hl-6">${</span><span class="hl-4">entityName</span><span class="hl-9">.</span><span class="hl-0">replace</span><span class="hl-9">(</span><span class="hl-15">/</span><span class="hl-16">[^</span><span class="hl-15">a-z0-9_</span><span class="hl-16">]</span><span class="hl-15">/</span><span class="hl-6">gi</span><span class="hl-9">, </span><span class="hl-2">&quot;_&quot;</span><span class="hl-9">)</span><span class="hl-6">}</span><span class="hl-2">`</span><span class="hl-1">;</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">  </span><br/><span class="hl-1">  </span><span class="hl-6">async</span><span class="hl-1"> </span><span class="hl-0">waitForInit</span><span class="hl-1">(</span><span class="hl-4">initial</span><span class="hl-1">: </span><span class="hl-10">boolean</span><span class="hl-1">): </span><span class="hl-10">Promise</span><span class="hl-1">&lt;</span><span class="hl-10">void</span><span class="hl-1">&gt; {</span><br/><span class="hl-1">    </span><span class="hl-5">// Create table with proper schema</span><br/><span class="hl-1">    </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-6">this</span><span class="hl-1">.</span><span class="hl-4">pool</span><span class="hl-1">.</span><span class="hl-0">query</span><span class="hl-1">(</span><span class="hl-2">`</span><br/><span class="hl-2">      CREATE TABLE IF NOT EXISTS </span><span class="hl-6">${</span><span class="hl-6">this</span><span class="hl-9">.</span><span class="hl-4">tableName</span><span class="hl-6">}</span><span class="hl-2"> (</span><br/><span class="hl-2">        entity_id TEXT PRIMARY KEY,</span><br/><span class="hl-2">        data JSONB NOT NULL,</span><br/><span class="hl-2">        updated_at TIMESTAMP DEFAULT NOW()</span><br/><span class="hl-2">      )</span><br/><span class="hl-2">    `</span><span class="hl-1">);</span><br/><span class="hl-1">    </span><br/><span class="hl-1">    </span><span class="hl-5">// Create index on updated_at for time-based queries</span><br/><span class="hl-1">    </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-6">this</span><span class="hl-1">.</span><span class="hl-4">pool</span><span class="hl-1">.</span><span class="hl-0">query</span><span class="hl-1">(</span><span class="hl-2">`</span><br/><span class="hl-2">      CREATE INDEX IF NOT EXISTS idx_</span><span class="hl-6">${</span><span class="hl-6">this</span><span class="hl-9">.</span><span class="hl-4">tableName</span><span class="hl-6">}</span><span class="hl-2">_updated </span><br/><span class="hl-2">      ON </span><span class="hl-6">${</span><span class="hl-6">this</span><span class="hl-9">.</span><span class="hl-4">tableName</span><span class="hl-6">}</span><span class="hl-2">(updated_at)</span><br/><span class="hl-2">    `</span><span class="hl-1">);</span><br/><span class="hl-1">    </span><br/><span class="hl-1">    </span><span class="hl-4">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-2">`PostgreSQL persistence initialized for </span><span class="hl-6">${</span><span class="hl-6">this</span><span class="hl-9">.</span><span class="hl-4">entityName</span><span class="hl-6">}</span><span class="hl-2">`</span><span class="hl-1">);</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">  </span><br/><span class="hl-1">  </span><span class="hl-6">async</span><span class="hl-1"> </span><span class="hl-0">readValue</span><span class="hl-1">&lt;</span><span class="hl-10">T</span><span class="hl-1">&gt;(</span><span class="hl-4">entityId</span><span class="hl-1">: </span><span class="hl-10">string</span><span class="hl-1"> | </span><span class="hl-10">number</span><span class="hl-1">): </span><span class="hl-10">Promise</span><span class="hl-1">&lt;</span><span class="hl-10">T</span><span class="hl-1">&gt; {</span><br/><span class="hl-1">    </span><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">result</span><span class="hl-1"> = </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-6">this</span><span class="hl-1">.</span><span class="hl-4">pool</span><span class="hl-1">.</span><span class="hl-0">query</span><span class="hl-1">(</span><br/><span class="hl-1">      </span><span class="hl-2">`SELECT data FROM </span><span class="hl-6">${</span><span class="hl-6">this</span><span class="hl-9">.</span><span class="hl-4">tableName</span><span class="hl-6">}</span><span class="hl-2"> WHERE entity_id = $1`</span><span class="hl-1">,</span><br/><span class="hl-1">      [</span><span class="hl-0">String</span><span class="hl-1">(</span><span class="hl-4">entityId</span><span class="hl-1">)]</span><br/><span class="hl-1">    );</span><br/><span class="hl-1">    </span><br/><span class="hl-1">    </span><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-4">result</span><span class="hl-1">.</span><span class="hl-4">rows</span><span class="hl-1">.</span><span class="hl-4">length</span><span class="hl-1"> === </span><span class="hl-8">0</span><span class="hl-1">) {</span><br/><span class="hl-1">      </span><span class="hl-3">throw</span><span class="hl-1"> </span><span class="hl-6">new</span><span class="hl-1"> </span><span class="hl-0">Error</span><span class="hl-1">(</span><span class="hl-2">`Entity </span><span class="hl-6">${</span><span class="hl-6">this</span><span class="hl-9">.</span><span class="hl-4">entityName</span><span class="hl-6">}</span><span class="hl-2">:</span><span class="hl-6">${</span><span class="hl-4">entityId</span><span class="hl-6">}</span><span class="hl-2"> not found`</span><span class="hl-1">);</span><br/><span class="hl-1">    }</span><br/><span class="hl-1">    </span><br/><span class="hl-1">    </span><span class="hl-3">return</span><span class="hl-1"> </span><span class="hl-4">result</span><span class="hl-1">.</span><span class="hl-4">rows</span><span class="hl-1">[</span><span class="hl-8">0</span><span class="hl-1">].</span><span class="hl-4">data</span><span class="hl-1"> </span><span class="hl-3">as</span><span class="hl-1"> </span><span class="hl-10">T</span><span class="hl-1">;</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">  </span><br/><span class="hl-1">  </span><span class="hl-6">async</span><span class="hl-1"> </span><span class="hl-0">hasValue</span><span class="hl-1">(</span><span class="hl-4">entityId</span><span class="hl-1">: </span><span class="hl-10">string</span><span class="hl-1"> | </span><span class="hl-10">number</span><span class="hl-1">): </span><span class="hl-10">Promise</span><span class="hl-1">&lt;</span><span class="hl-10">boolean</span><span class="hl-1">&gt; {</span><br/><span class="hl-1">    </span><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">result</span><span class="hl-1"> = </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-6">this</span><span class="hl-1">.</span><span class="hl-4">pool</span><span class="hl-1">.</span><span class="hl-0">query</span><span class="hl-1">(</span><br/><span class="hl-1">      </span><span class="hl-2">`SELECT 1 FROM </span><span class="hl-6">${</span><span class="hl-6">this</span><span class="hl-9">.</span><span class="hl-4">tableName</span><span class="hl-6">}</span><span class="hl-2"> WHERE entity_id = $1 LIMIT 1`</span><span class="hl-1">,</span><br/><span class="hl-1">      [</span><span class="hl-0">String</span><span class="hl-1">(</span><span class="hl-4">entityId</span><span class="hl-1">)]</span><br/><span class="hl-1">    );</span><br/><span class="hl-1">    </span><br/><span class="hl-1">    </span><span class="hl-3">return</span><span class="hl-1"> </span><span class="hl-4">result</span><span class="hl-1">.</span><span class="hl-4">rows</span><span class="hl-1">.</span><span class="hl-4">length</span><span class="hl-1"> &gt; </span><span class="hl-8">0</span><span class="hl-1">;</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">  </span><br/><span class="hl-1">  </span><span class="hl-6">async</span><span class="hl-1"> </span><span class="hl-0">writeValue</span><span class="hl-1">&lt;</span><span class="hl-10">T</span><span class="hl-1">&gt;(</span><span class="hl-4">entityId</span><span class="hl-1">: </span><span class="hl-10">string</span><span class="hl-1"> | </span><span class="hl-10">number</span><span class="hl-1">, </span><span class="hl-4">entity</span><span class="hl-1">: </span><span class="hl-10">T</span><span class="hl-1">): </span><span class="hl-10">Promise</span><span class="hl-1">&lt;</span><span class="hl-10">void</span><span class="hl-1">&gt; {</span><br/><span class="hl-1">    </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-6">this</span><span class="hl-1">.</span><span class="hl-4">pool</span><span class="hl-1">.</span><span class="hl-0">query</span><span class="hl-1">(</span><br/><span class="hl-1">      </span><span class="hl-2">`INSERT INTO </span><span class="hl-6">${</span><span class="hl-6">this</span><span class="hl-9">.</span><span class="hl-4">tableName</span><span class="hl-6">}</span><span class="hl-2"> (entity_id, data, updated_at)</span><br/><span class="hl-2">       VALUES ($1, $2, NOW())</span><br/><span class="hl-2">       ON CONFLICT (entity_id) </span><br/><span class="hl-2">       DO UPDATE SET data = $2, updated_at = NOW()`</span><span class="hl-1">,</span><br/><span class="hl-1">      [</span><span class="hl-0">String</span><span class="hl-1">(</span><span class="hl-4">entityId</span><span class="hl-1">), </span><span class="hl-7">JSON</span><span class="hl-1">.</span><span class="hl-0">stringify</span><span class="hl-1">(</span><span class="hl-4">entity</span><span class="hl-1">)]</span><br/><span class="hl-1">    );</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">  </span><br/><span class="hl-1">  </span><span class="hl-6">async</span><span class="hl-1"> </span><span class="hl-0">removeValue</span><span class="hl-1">(</span><span class="hl-4">entityId</span><span class="hl-1">: </span><span class="hl-10">string</span><span class="hl-1"> | </span><span class="hl-10">number</span><span class="hl-1">): </span><span class="hl-10">Promise</span><span class="hl-1">&lt;</span><span class="hl-10">void</span><span class="hl-1">&gt; {</span><br/><span class="hl-1">    </span><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">result</span><span class="hl-1"> = </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-6">this</span><span class="hl-1">.</span><span class="hl-4">pool</span><span class="hl-1">.</span><span class="hl-0">query</span><span class="hl-1">(</span><br/><span class="hl-1">      </span><span class="hl-2">`DELETE FROM </span><span class="hl-6">${</span><span class="hl-6">this</span><span class="hl-9">.</span><span class="hl-4">tableName</span><span class="hl-6">}</span><span class="hl-2"> WHERE entity_id = $1`</span><span class="hl-1">,</span><br/><span class="hl-1">      [</span><span class="hl-0">String</span><span class="hl-1">(</span><span class="hl-4">entityId</span><span class="hl-1">)]</span><br/><span class="hl-1">    );</span><br/><span class="hl-1">    </span><br/><span class="hl-1">    </span><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-4">result</span><span class="hl-1">.</span><span class="hl-4">rowCount</span><span class="hl-1"> === </span><span class="hl-8">0</span><span class="hl-1">) {</span><br/><span class="hl-1">      </span><span class="hl-3">throw</span><span class="hl-1"> </span><span class="hl-6">new</span><span class="hl-1"> </span><span class="hl-0">Error</span><span class="hl-1">(</span><span class="hl-2">`Entity </span><span class="hl-6">${</span><span class="hl-6">this</span><span class="hl-9">.</span><span class="hl-4">entityName</span><span class="hl-6">}</span><span class="hl-2">:</span><span class="hl-6">${</span><span class="hl-4">entityId</span><span class="hl-6">}</span><span class="hl-2"> not found for deletion`</span><span class="hl-1">);</span><br/><span class="hl-1">    }</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">  </span><br/><span class="hl-1">  </span><span class="hl-6">async</span><span class="hl-1"> </span><span class="hl-0">removeAll</span><span class="hl-1">(): </span><span class="hl-10">Promise</span><span class="hl-1">&lt;</span><span class="hl-10">void</span><span class="hl-1">&gt; {</span><br/><span class="hl-1">    </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-6">this</span><span class="hl-1">.</span><span class="hl-4">pool</span><span class="hl-1">.</span><span class="hl-0">query</span><span class="hl-1">(</span><span class="hl-2">`DELETE FROM </span><span class="hl-6">${</span><span class="hl-6">this</span><span class="hl-9">.</span><span class="hl-4">tableName</span><span class="hl-6">}</span><span class="hl-2">`</span><span class="hl-1">);</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">  </span><br/><span class="hl-1">  </span><span class="hl-6">async</span><span class="hl-1"> </span><span class="hl-6">*</span><span class="hl-0">values</span><span class="hl-1">&lt;</span><span class="hl-10">T</span><span class="hl-1">&gt;(): </span><span class="hl-10">AsyncGenerator</span><span class="hl-1">&lt;</span><span class="hl-10">T</span><span class="hl-1">&gt; {</span><br/><span class="hl-1">    </span><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">result</span><span class="hl-1"> = </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-6">this</span><span class="hl-1">.</span><span class="hl-4">pool</span><span class="hl-1">.</span><span class="hl-0">query</span><span class="hl-1">(</span><br/><span class="hl-1">      </span><span class="hl-2">`SELECT data FROM </span><span class="hl-6">${</span><span class="hl-6">this</span><span class="hl-9">.</span><span class="hl-4">tableName</span><span class="hl-6">}</span><span class="hl-2"> ORDER BY entity_id`</span><br/><span class="hl-1">    );</span><br/><span class="hl-1">    </span><br/><span class="hl-1">    </span><span class="hl-3">for</span><span class="hl-1"> (</span><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">row</span><span class="hl-1"> </span><span class="hl-6">of</span><span class="hl-1"> </span><span class="hl-4">result</span><span class="hl-1">.</span><span class="hl-4">rows</span><span class="hl-1">) {</span><br/><span class="hl-1">      </span><span class="hl-3">yield</span><span class="hl-1"> </span><span class="hl-4">row</span><span class="hl-1">.</span><span class="hl-4">data</span><span class="hl-1"> </span><span class="hl-3">as</span><span class="hl-1"> </span><span class="hl-10">T</span><span class="hl-1">;</span><br/><span class="hl-1">    }</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">  </span><br/><span class="hl-1">  </span><span class="hl-6">async</span><span class="hl-1"> </span><span class="hl-6">*</span><span class="hl-0">keys</span><span class="hl-1">(): </span><span class="hl-10">AsyncGenerator</span><span class="hl-1">&lt;</span><span class="hl-10">string</span><span class="hl-1">&gt; {</span><br/><span class="hl-1">    </span><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">result</span><span class="hl-1"> = </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-6">this</span><span class="hl-1">.</span><span class="hl-4">pool</span><span class="hl-1">.</span><span class="hl-0">query</span><span class="hl-1">(</span><br/><span class="hl-1">      </span><span class="hl-2">`SELECT entity_id FROM </span><span class="hl-6">${</span><span class="hl-6">this</span><span class="hl-9">.</span><span class="hl-4">tableName</span><span class="hl-6">}</span><span class="hl-2"> ORDER BY entity_id`</span><br/><span class="hl-1">    );</span><br/><span class="hl-1">    </span><br/><span class="hl-1">    </span><span class="hl-3">for</span><span class="hl-1"> (</span><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">row</span><span class="hl-1"> </span><span class="hl-6">of</span><span class="hl-1"> </span><span class="hl-4">result</span><span class="hl-1">.</span><span class="hl-4">rows</span><span class="hl-1">) {</span><br/><span class="hl-1">      </span><span class="hl-3">yield</span><span class="hl-1"> </span><span class="hl-4">row</span><span class="hl-1">.</span><span class="hl-4">entity_id</span><span class="hl-1">;</span><br/><span class="hl-1">    }</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<hr>
<a id="registering-custom-adapters" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Registering Custom Adapters<a href="#registering-custom-adapters" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>Custom adapters must be registered before any trading operations begin. The framework provides static registration methods on each adapter class that accept a custom <code>PersistBase</code> subclass.</p>
<a id="registration-flow" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Registration Flow<a href="#registration-flow" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><img src="../media/84_Custom_Persistence_Backends_4.svg" alt="Mermaid Diagram"></p>
<a id="registration-example" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Registration Example<a href="#registration-example" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><pre><code class="typescript"><span class="hl-3">import</span><span class="hl-1"> { </span><br/><span class="hl-1">  </span><span class="hl-4">PersistSignalAdapter</span><span class="hl-1">, </span><br/><span class="hl-1">  </span><span class="hl-4">PersistScheduleAdapter</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">PersistRiskAdapter</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">PersistPartialAdapter</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">Live</span><span class="hl-1"> </span><br/><span class="hl-1">} </span><span class="hl-3">from</span><span class="hl-1"> </span><span class="hl-2">&quot;backtest-kit&quot;</span><span class="hl-1">;</span><br/><br/><span class="hl-5">// CRITICAL: Register adapters BEFORE running any strategies</span><br/><span class="hl-4">PersistSignalAdapter</span><span class="hl-1">.</span><span class="hl-0">usePersistSignalAdapter</span><span class="hl-1">(</span><span class="hl-4">RedisPersist</span><span class="hl-1">);</span><br/><span class="hl-4">PersistScheduleAdapter</span><span class="hl-1">.</span><span class="hl-0">usePersistScheduleAdapter</span><span class="hl-1">(</span><span class="hl-4">RedisPersist</span><span class="hl-1">);</span><br/><span class="hl-4">PersistRiskAdapter</span><span class="hl-1">.</span><span class="hl-0">usePersistRiskAdapter</span><span class="hl-1">(</span><span class="hl-4">RedisPersist</span><span class="hl-1">);</span><br/><span class="hl-4">PersistPartialAdapter</span><span class="hl-1">.</span><span class="hl-0">usePersistPartialAdapter</span><span class="hl-1">(</span><span class="hl-4">RedisPersist</span><span class="hl-1">);</span><br/><br/><span class="hl-5">// Now run live trading with Redis persistence</span><br/><span class="hl-4">Live</span><span class="hl-1">.</span><span class="hl-0">background</span><span class="hl-1">(</span><span class="hl-2">&quot;BTCUSDT&quot;</span><span class="hl-1">, {</span><br/><span class="hl-1">  </span><span class="hl-4">strategyName:</span><span class="hl-1"> </span><span class="hl-2">&quot;my-strategy&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">exchangeName:</span><span class="hl-1"> </span><span class="hl-2">&quot;binance&quot;</span><br/><span class="hl-1">});</span>
</code><button type="button">Copy</button></pre>

<p><strong>Registration must occur before any of the following operations:</strong></p>
<ul>
<li><code>Live.run()</code> or <code>Live.background()</code></li>
<li><code>Backtest.run()</code> or <code>Backtest.background()</code> (for risk/partial only)</li>
<li><code>ClientStrategy</code> instantiation</li>
</ul>
<a id="partial-adapter-registration" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Partial Adapter Registration<a href="#partial-adapter-registration" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>You can mix default file-based persistence with custom backends:</p>
<pre><code class="typescript"><span class="hl-5">// Use Redis only for signal state (high-frequency updates)</span><br/><span class="hl-4">PersistSignalAdapter</span><span class="hl-1">.</span><span class="hl-0">usePersistSignalAdapter</span><span class="hl-1">(</span><span class="hl-4">RedisPersist</span><span class="hl-1">);</span><br/><br/><span class="hl-5">// Use MongoDB for risk positions (complex queries)</span><br/><span class="hl-4">PersistRiskAdapter</span><span class="hl-1">.</span><span class="hl-0">usePersistRiskAdapter</span><span class="hl-1">(</span><span class="hl-4">MongoPersist</span><span class="hl-1">);</span><br/><br/><span class="hl-5">// Use default file-based for schedule and partial</span><br/><span class="hl-5">// (no registration needed - defaults are used)</span>
</code><button type="button">Copy</button></pre>

<hr>
<a id="backend-selection-guide" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Backend Selection Guide<a href="#backend-selection-guide" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>Different storage backends offer trade-offs in performance, complexity, and operational characteristics. This guide helps select the appropriate backend for your deployment scenario.</p>
<a id="backend-comparison-matrix" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Backend Comparison Matrix<a href="#backend-comparison-matrix" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><table>
<thead>
<tr>
<th>Backend</th>
<th>Throughput</th>
<th>Latency</th>
<th>Consistency</th>
<th>Scalability</th>
<th>Complexity</th>
<th>Use Case</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>File-based</strong> (default)</td>
<td>Low</td>
<td>High (disk I/O)</td>
<td>Strong (atomic writes)</td>
<td>Single instance</td>
<td>None</td>
<td>Development, single-bot deployments</td>
</tr>
<tr>
<td><strong>Redis</strong></td>
<td>Very High</td>
<td>Very Low (memory)</td>
<td>Eventual</td>
<td>Horizontal (Redis Cluster)</td>
<td>Low</td>
<td>High-frequency trading, multiple bots</td>
</tr>
<tr>
<td><strong>MongoDB</strong></td>
<td>High</td>
<td>Low</td>
<td>Strong (w:majority)</td>
<td>Horizontal (sharding)</td>
<td>Medium</td>
<td>Analytics, complex queries, audit trails</td>
</tr>
<tr>
<td><strong>PostgreSQL</strong></td>
<td>Medium</td>
<td>Medium</td>
<td>ACID</td>
<td>Vertical (read replicas)</td>
<td>High</td>
<td>Regulatory compliance, relational analysis</td>
</tr>
</tbody>
</table>
<a id="when-to-use-each-backend" class="tsd-anchor"></a><h3 class="tsd-anchor-link">When to Use Each Backend<a href="#when-to-use-each-backend" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><img src="../media/84_Custom_Persistence_Backends_5.svg" alt="Mermaid Diagram"></p>
<a id="performance-characteristics" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Performance Characteristics<a href="#performance-characteristics" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><strong>File System (Default)</strong></p>
<ul>
<li>Write latency: 5-50ms (depends on disk)</li>
<li>Read latency: 1-10ms (cached) / 5-50ms (uncached)</li>
<li>Concurrency: Single writer per file</li>
<li>Best for: Development, testing, single-bot production</li>
</ul>
<p><strong>Redis</strong></p>
<ul>
<li>Write latency: &lt;1ms (memory)</li>
<li>Read latency: &lt;1ms (memory)</li>
<li>Concurrency: High (async I/O)</li>
<li>Best for: Multiple bots, high-frequency strategies, distributed systems</li>
</ul>
<p><strong>MongoDB</strong></p>
<ul>
<li>Write latency: 5-10ms (w:1) / 10-30ms (w:majority)</li>
<li>Read latency: 1-5ms</li>
<li>Concurrency: Medium (document-level locks)</li>
<li>Best for: Analytics workloads, audit trails, complex filtering</li>
</ul>
<p><strong>PostgreSQL</strong></p>
<ul>
<li>Write latency: 10-20ms (fsync)</li>
<li>Read latency: 1-10ms</li>
<li>Concurrency: High (MVCC)</li>
<li>Best for: Transactional integrity, compliance, relational queries</li>
</ul>
<hr>
<a id="testing-custom-adapters" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Testing Custom Adapters<a href="#testing-custom-adapters" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>Custom adapters should be tested to ensure compatibility with the framework's expectations. All methods must be validated for correct behavior, especially error handling and async generator semantics.</p>
<a id="test-template" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Test Template<a href="#test-template" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><pre><code class="typescript"><span class="hl-3">import</span><span class="hl-1"> { </span><span class="hl-4">test</span><span class="hl-1"> } </span><span class="hl-3">from</span><span class="hl-1"> </span><span class="hl-2">&quot;worker-testbed&quot;</span><span class="hl-1">;</span><br/><span class="hl-3">import</span><span class="hl-1"> { </span><span class="hl-4">PersistBase</span><span class="hl-1"> } </span><span class="hl-3">from</span><span class="hl-1"> </span><span class="hl-2">&quot;backtest-kit&quot;</span><span class="hl-1">;</span><br/><br/><span class="hl-0">test</span><span class="hl-1">(</span><span class="hl-2">&quot;Custom adapter implements PersistBase correctly&quot;</span><span class="hl-1">, </span><span class="hl-6">async</span><span class="hl-1"> ({ </span><span class="hl-4">pass</span><span class="hl-1">, </span><span class="hl-4">fail</span><span class="hl-1"> }) </span><span class="hl-6">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">adapter</span><span class="hl-1"> = </span><span class="hl-6">new</span><span class="hl-1"> </span><span class="hl-0">CustomAdapter</span><span class="hl-1">(</span><span class="hl-2">&quot;test-entity&quot;</span><span class="hl-1">, </span><span class="hl-2">&quot;./test-data&quot;</span><span class="hl-1">);</span><br/><span class="hl-1">  </span><br/><span class="hl-1">  </span><span class="hl-5">// Test 1: Initialization</span><br/><span class="hl-1">  </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-4">adapter</span><span class="hl-1">.</span><span class="hl-0">waitForInit</span><span class="hl-1">(</span><span class="hl-6">true</span><span class="hl-1">);</span><br/><span class="hl-1">  </span><span class="hl-0">pass</span><span class="hl-1">(</span><span class="hl-2">&quot;Adapter initialized successfully&quot;</span><span class="hl-1">);</span><br/><span class="hl-1">  </span><br/><span class="hl-1">  </span><span class="hl-5">// Test 2: Write and read</span><br/><span class="hl-1">  </span><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">testData</span><span class="hl-1"> = { </span><span class="hl-4">id:</span><span class="hl-1"> </span><span class="hl-2">&quot;test1&quot;</span><span class="hl-1">, </span><span class="hl-4">value:</span><span class="hl-1"> </span><span class="hl-8">42</span><span class="hl-1"> };</span><br/><span class="hl-1">  </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-4">adapter</span><span class="hl-1">.</span><span class="hl-0">writeValue</span><span class="hl-1">(</span><span class="hl-2">&quot;test1&quot;</span><span class="hl-1">, </span><span class="hl-4">testData</span><span class="hl-1">);</span><br/><span class="hl-1">  </span><br/><span class="hl-1">  </span><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">readData</span><span class="hl-1"> = </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-4">adapter</span><span class="hl-1">.</span><span class="hl-0">readValue</span><span class="hl-1">(</span><span class="hl-2">&quot;test1&quot;</span><span class="hl-1">);</span><br/><span class="hl-1">  </span><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-7">JSON</span><span class="hl-1">.</span><span class="hl-0">stringify</span><span class="hl-1">(</span><span class="hl-4">readData</span><span class="hl-1">) === </span><span class="hl-7">JSON</span><span class="hl-1">.</span><span class="hl-0">stringify</span><span class="hl-1">(</span><span class="hl-4">testData</span><span class="hl-1">)) {</span><br/><span class="hl-1">    </span><span class="hl-0">pass</span><span class="hl-1">(</span><span class="hl-2">&quot;Write and read operations work correctly&quot;</span><span class="hl-1">);</span><br/><span class="hl-1">  } </span><span class="hl-3">else</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-0">fail</span><span class="hl-1">(</span><span class="hl-2">&quot;Data mismatch between write and read&quot;</span><span class="hl-1">);</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">  </span><br/><span class="hl-1">  </span><span class="hl-5">// Test 3: Existence check</span><br/><span class="hl-1">  </span><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">exists</span><span class="hl-1"> = </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-4">adapter</span><span class="hl-1">.</span><span class="hl-0">hasValue</span><span class="hl-1">(</span><span class="hl-2">&quot;test1&quot;</span><span class="hl-1">);</span><br/><span class="hl-1">  </span><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-4">exists</span><span class="hl-1">) {</span><br/><span class="hl-1">    </span><span class="hl-0">pass</span><span class="hl-1">(</span><span class="hl-2">&quot;hasValue returns true for existing entity&quot;</span><span class="hl-1">);</span><br/><span class="hl-1">  } </span><span class="hl-3">else</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-0">fail</span><span class="hl-1">(</span><span class="hl-2">&quot;hasValue should return true&quot;</span><span class="hl-1">);</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">  </span><br/><span class="hl-1">  </span><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">notExists</span><span class="hl-1"> = </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-4">adapter</span><span class="hl-1">.</span><span class="hl-0">hasValue</span><span class="hl-1">(</span><span class="hl-2">&quot;nonexistent&quot;</span><span class="hl-1">);</span><br/><span class="hl-1">  </span><span class="hl-3">if</span><span class="hl-1"> (!</span><span class="hl-4">notExists</span><span class="hl-1">) {</span><br/><span class="hl-1">    </span><span class="hl-0">pass</span><span class="hl-1">(</span><span class="hl-2">&quot;hasValue returns false for missing entity&quot;</span><span class="hl-1">);</span><br/><span class="hl-1">  } </span><span class="hl-3">else</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-0">fail</span><span class="hl-1">(</span><span class="hl-2">&quot;hasValue should return false for missing entity&quot;</span><span class="hl-1">);</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">  </span><br/><span class="hl-1">  </span><span class="hl-5">// Test 4: Iteration</span><br/><span class="hl-1">  </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-4">adapter</span><span class="hl-1">.</span><span class="hl-0">writeValue</span><span class="hl-1">(</span><span class="hl-2">&quot;test2&quot;</span><span class="hl-1">, { </span><span class="hl-4">id:</span><span class="hl-1"> </span><span class="hl-2">&quot;test2&quot;</span><span class="hl-1">, </span><span class="hl-4">value:</span><span class="hl-1"> </span><span class="hl-8">100</span><span class="hl-1"> });</span><br/><span class="hl-1">  </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-4">adapter</span><span class="hl-1">.</span><span class="hl-0">writeValue</span><span class="hl-1">(</span><span class="hl-2">&quot;test3&quot;</span><span class="hl-1">, { </span><span class="hl-4">id:</span><span class="hl-1"> </span><span class="hl-2">&quot;test3&quot;</span><span class="hl-1">, </span><span class="hl-4">value:</span><span class="hl-1"> </span><span class="hl-8">200</span><span class="hl-1"> });</span><br/><span class="hl-1">  </span><br/><span class="hl-1">  </span><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">values</span><span class="hl-1"> = [];</span><br/><span class="hl-1">  </span><span class="hl-3">for</span><span class="hl-1"> </span><span class="hl-3">await</span><span class="hl-1"> (</span><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">value</span><span class="hl-1"> </span><span class="hl-6">of</span><span class="hl-1"> </span><span class="hl-4">adapter</span><span class="hl-1">.</span><span class="hl-0">values</span><span class="hl-1">()) {</span><br/><span class="hl-1">    </span><span class="hl-4">values</span><span class="hl-1">.</span><span class="hl-0">push</span><span class="hl-1">(</span><span class="hl-4">value</span><span class="hl-1">);</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">  </span><br/><span class="hl-1">  </span><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-4">values</span><span class="hl-1">.</span><span class="hl-4">length</span><span class="hl-1"> === </span><span class="hl-8">3</span><span class="hl-1">) {</span><br/><span class="hl-1">    </span><span class="hl-0">pass</span><span class="hl-1">(</span><span class="hl-2">&quot;values() iterator returns all entities&quot;</span><span class="hl-1">);</span><br/><span class="hl-1">  } </span><span class="hl-3">else</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-0">fail</span><span class="hl-1">(</span><span class="hl-2">`Expected 3 values, got </span><span class="hl-6">${</span><span class="hl-4">values</span><span class="hl-9">.</span><span class="hl-4">length</span><span class="hl-6">}</span><span class="hl-2">`</span><span class="hl-1">);</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">  </span><br/><span class="hl-1">  </span><span class="hl-5">// Test 5: Key iteration</span><br/><span class="hl-1">  </span><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">keys</span><span class="hl-1"> = [];</span><br/><span class="hl-1">  </span><span class="hl-3">for</span><span class="hl-1"> </span><span class="hl-3">await</span><span class="hl-1"> (</span><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">key</span><span class="hl-1"> </span><span class="hl-6">of</span><span class="hl-1"> </span><span class="hl-4">adapter</span><span class="hl-1">.</span><span class="hl-0">keys</span><span class="hl-1">()) {</span><br/><span class="hl-1">    </span><span class="hl-4">keys</span><span class="hl-1">.</span><span class="hl-0">push</span><span class="hl-1">(</span><span class="hl-4">key</span><span class="hl-1">);</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">  </span><br/><span class="hl-1">  </span><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-4">keys</span><span class="hl-1">.</span><span class="hl-4">length</span><span class="hl-1"> === </span><span class="hl-8">3</span><span class="hl-1"> &amp;&amp; </span><span class="hl-4">keys</span><span class="hl-1">.</span><span class="hl-0">includes</span><span class="hl-1">(</span><span class="hl-2">&quot;test1&quot;</span><span class="hl-1">)) {</span><br/><span class="hl-1">    </span><span class="hl-0">pass</span><span class="hl-1">(</span><span class="hl-2">&quot;keys() iterator returns all entity IDs&quot;</span><span class="hl-1">);</span><br/><span class="hl-1">  } </span><span class="hl-3">else</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-0">fail</span><span class="hl-1">(</span><span class="hl-2">&quot;keys() iterator does not return correct IDs&quot;</span><span class="hl-1">);</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">  </span><br/><span class="hl-1">  </span><span class="hl-5">// Test 6: Delete</span><br/><span class="hl-1">  </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-4">adapter</span><span class="hl-1">.</span><span class="hl-0">removeValue</span><span class="hl-1">(</span><span class="hl-2">&quot;test1&quot;</span><span class="hl-1">);</span><br/><span class="hl-1">  </span><br/><span class="hl-1">  </span><span class="hl-3">try</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-4">adapter</span><span class="hl-1">.</span><span class="hl-0">readValue</span><span class="hl-1">(</span><span class="hl-2">&quot;test1&quot;</span><span class="hl-1">);</span><br/><span class="hl-1">    </span><span class="hl-0">fail</span><span class="hl-1">(</span><span class="hl-2">&quot;readValue should throw after removeValue&quot;</span><span class="hl-1">);</span><br/><span class="hl-1">  } </span><span class="hl-3">catch</span><span class="hl-1"> (</span><span class="hl-4">error</span><span class="hl-1">) {</span><br/><span class="hl-1">    </span><span class="hl-0">pass</span><span class="hl-1">(</span><span class="hl-2">&quot;readValue throws error for deleted entity&quot;</span><span class="hl-1">);</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">  </span><br/><span class="hl-1">  </span><span class="hl-5">// Test 7: Delete all</span><br/><span class="hl-1">  </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-4">adapter</span><span class="hl-1">.</span><span class="hl-0">removeAll</span><span class="hl-1">();</span><br/><span class="hl-1">  </span><br/><span class="hl-1">  </span><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">emptyKeys</span><span class="hl-1"> = [];</span><br/><span class="hl-1">  </span><span class="hl-3">for</span><span class="hl-1"> </span><span class="hl-3">await</span><span class="hl-1"> (</span><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">key</span><span class="hl-1"> </span><span class="hl-6">of</span><span class="hl-1"> </span><span class="hl-4">adapter</span><span class="hl-1">.</span><span class="hl-0">keys</span><span class="hl-1">()) {</span><br/><span class="hl-1">    </span><span class="hl-4">emptyKeys</span><span class="hl-1">.</span><span class="hl-0">push</span><span class="hl-1">(</span><span class="hl-4">key</span><span class="hl-1">);</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">  </span><br/><span class="hl-1">  </span><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-4">emptyKeys</span><span class="hl-1">.</span><span class="hl-4">length</span><span class="hl-1"> === </span><span class="hl-8">0</span><span class="hl-1">) {</span><br/><span class="hl-1">    </span><span class="hl-0">pass</span><span class="hl-1">(</span><span class="hl-2">&quot;removeAll clears all entities&quot;</span><span class="hl-1">);</span><br/><span class="hl-1">  } </span><span class="hl-3">else</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-0">fail</span><span class="hl-1">(</span><span class="hl-2">&quot;removeAll did not clear all entities&quot;</span><span class="hl-1">);</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">  </span><br/><span class="hl-1">  </span><span class="hl-5">// Test 8: Error handling for missing entity</span><br/><span class="hl-1">  </span><span class="hl-3">try</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-4">adapter</span><span class="hl-1">.</span><span class="hl-0">readValue</span><span class="hl-1">(</span><span class="hl-2">&quot;never-existed&quot;</span><span class="hl-1">);</span><br/><span class="hl-1">    </span><span class="hl-0">fail</span><span class="hl-1">(</span><span class="hl-2">&quot;readValue should throw for non-existent entity&quot;</span><span class="hl-1">);</span><br/><span class="hl-1">  } </span><span class="hl-3">catch</span><span class="hl-1"> (</span><span class="hl-4">error</span><span class="hl-1">) {</span><br/><span class="hl-1">    </span><span class="hl-0">pass</span><span class="hl-1">(</span><span class="hl-2">&quot;readValue throws error for non-existent entity&quot;</span><span class="hl-1">);</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">  </span><br/><span class="hl-1">  </span><span class="hl-3">try</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-4">adapter</span><span class="hl-1">.</span><span class="hl-0">removeValue</span><span class="hl-1">(</span><span class="hl-2">&quot;never-existed&quot;</span><span class="hl-1">);</span><br/><span class="hl-1">    </span><span class="hl-0">fail</span><span class="hl-1">(</span><span class="hl-2">&quot;removeValue should throw for non-existent entity&quot;</span><span class="hl-1">);</span><br/><span class="hl-1">  } </span><span class="hl-3">catch</span><span class="hl-1"> (</span><span class="hl-4">error</span><span class="hl-1">) {</span><br/><span class="hl-1">    </span><span class="hl-0">pass</span><span class="hl-1">(</span><span class="hl-2">&quot;removeValue throws error for non-existent entity&quot;</span><span class="hl-1">);</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">});</span>
</code><button type="button">Copy</button></pre>

<a id="integration-test-with-live-mode" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Integration Test with Live Mode<a href="#integration-test-with-live-mode" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><pre><code class="typescript"><span class="hl-3">import</span><span class="hl-1"> { </span><br/><span class="hl-1">  </span><span class="hl-4">addStrategy</span><span class="hl-1">, </span><br/><span class="hl-1">  </span><span class="hl-4">addExchange</span><span class="hl-1">, </span><br/><span class="hl-1">  </span><span class="hl-4">Live</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">PersistSignalAdapter</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">listenSignalLive</span><br/><span class="hl-1">} </span><span class="hl-3">from</span><span class="hl-1"> </span><span class="hl-2">&quot;backtest-kit&quot;</span><span class="hl-1">;</span><br/><br/><span class="hl-0">test</span><span class="hl-1">(</span><span class="hl-2">&quot;Custom adapter works with live mode&quot;</span><span class="hl-1">, </span><span class="hl-6">async</span><span class="hl-1"> ({ </span><span class="hl-4">pass</span><span class="hl-1">, </span><span class="hl-4">fail</span><span class="hl-1"> }) </span><span class="hl-6">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-5">// Register custom adapter</span><br/><span class="hl-1">  </span><span class="hl-4">PersistSignalAdapter</span><span class="hl-1">.</span><span class="hl-0">usePersistSignalAdapter</span><span class="hl-1">(</span><span class="hl-4">CustomAdapter</span><span class="hl-1">);</span><br/><span class="hl-1">  </span><br/><span class="hl-1">  </span><span class="hl-5">// Configure strategy</span><br/><span class="hl-1">  </span><span class="hl-0">addStrategy</span><span class="hl-1">({</span><br/><span class="hl-1">    </span><span class="hl-4">strategyName:</span><span class="hl-1"> </span><span class="hl-2">&quot;test-strategy&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-4">interval:</span><span class="hl-1"> </span><span class="hl-2">&quot;5m&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-0">getSignal</span><span class="hl-4">:</span><span class="hl-1"> </span><span class="hl-6">async</span><span class="hl-1"> (</span><span class="hl-4">symbol</span><span class="hl-1">) </span><span class="hl-6">=&gt;</span><span class="hl-1"> ({</span><br/><span class="hl-1">      </span><span class="hl-4">position:</span><span class="hl-1"> </span><span class="hl-2">&quot;long&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">      </span><span class="hl-4">note:</span><span class="hl-1"> </span><span class="hl-2">&quot;Test signal&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">      </span><span class="hl-4">priceOpen:</span><span class="hl-1"> </span><span class="hl-8">50000</span><span class="hl-1">,</span><br/><span class="hl-1">      </span><span class="hl-4">priceTakeProfit:</span><span class="hl-1"> </span><span class="hl-8">51000</span><span class="hl-1">,</span><br/><span class="hl-1">      </span><span class="hl-4">priceStopLoss:</span><span class="hl-1"> </span><span class="hl-8">49000</span><span class="hl-1">,</span><br/><span class="hl-1">      </span><span class="hl-4">minuteEstimatedTime:</span><span class="hl-1"> </span><span class="hl-8">60</span><br/><span class="hl-1">    })</span><br/><span class="hl-1">  });</span><br/><span class="hl-1">  </span><br/><span class="hl-1">  </span><span class="hl-0">addExchange</span><span class="hl-1">({</span><br/><span class="hl-1">    </span><span class="hl-4">exchangeName:</span><span class="hl-1"> </span><span class="hl-2">&quot;test-exchange&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-0">getCandles</span><span class="hl-4">:</span><span class="hl-1"> </span><span class="hl-6">async</span><span class="hl-1"> () </span><span class="hl-6">=&gt;</span><span class="hl-1"> [</span><span class="hl-5">/* mock data */</span><span class="hl-1">],</span><br/><span class="hl-1">    </span><span class="hl-0">formatPrice</span><span class="hl-4">:</span><span class="hl-1"> </span><span class="hl-6">async</span><span class="hl-1"> (</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">price</span><span class="hl-1">) </span><span class="hl-6">=&gt;</span><span class="hl-1"> </span><span class="hl-4">price</span><span class="hl-1">.</span><span class="hl-0">toFixed</span><span class="hl-1">(</span><span class="hl-8">2</span><span class="hl-1">),</span><br/><span class="hl-1">    </span><span class="hl-0">formatQuantity</span><span class="hl-4">:</span><span class="hl-1"> </span><span class="hl-6">async</span><span class="hl-1"> (</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">qty</span><span class="hl-1">) </span><span class="hl-6">=&gt;</span><span class="hl-1"> </span><span class="hl-4">qty</span><span class="hl-1">.</span><span class="hl-0">toFixed</span><span class="hl-1">(</span><span class="hl-8">8</span><span class="hl-1">)</span><br/><span class="hl-1">  });</span><br/><span class="hl-1">  </span><br/><span class="hl-1">  </span><span class="hl-5">// Track signal events</span><br/><span class="hl-1">  </span><span class="hl-6">let</span><span class="hl-1"> </span><span class="hl-4">signalOpened</span><span class="hl-1"> = </span><span class="hl-6">false</span><span class="hl-1">;</span><br/><span class="hl-1">  </span><span class="hl-6">let</span><span class="hl-1"> </span><span class="hl-4">signalRecovered</span><span class="hl-1"> = </span><span class="hl-6">false</span><span class="hl-1">;</span><br/><span class="hl-1">  </span><br/><span class="hl-1">  </span><span class="hl-0">listenSignalLive</span><span class="hl-1">((</span><span class="hl-4">event</span><span class="hl-1">) </span><span class="hl-6">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-4">event</span><span class="hl-1">.</span><span class="hl-4">action</span><span class="hl-1"> === </span><span class="hl-2">&quot;opened&quot;</span><span class="hl-1">) {</span><br/><span class="hl-1">      </span><span class="hl-4">signalOpened</span><span class="hl-1"> = </span><span class="hl-6">true</span><span class="hl-1">;</span><br/><span class="hl-1">    }</span><br/><span class="hl-1">  });</span><br/><span class="hl-1">  </span><br/><span class="hl-1">  </span><span class="hl-5">// Run live mode</span><br/><span class="hl-1">  </span><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">stop</span><span class="hl-1"> = </span><span class="hl-4">Live</span><span class="hl-1">.</span><span class="hl-0">background</span><span class="hl-1">(</span><span class="hl-2">&quot;BTCUSDT&quot;</span><span class="hl-1">, {</span><br/><span class="hl-1">    </span><span class="hl-4">strategyName:</span><span class="hl-1"> </span><span class="hl-2">&quot;test-strategy&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-4">exchangeName:</span><span class="hl-1"> </span><span class="hl-2">&quot;test-exchange&quot;</span><br/><span class="hl-1">  });</span><br/><span class="hl-1">  </span><br/><span class="hl-1">  </span><span class="hl-5">// Wait for signal to open</span><br/><span class="hl-1">  </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-6">new</span><span class="hl-1"> </span><span class="hl-10">Promise</span><span class="hl-1">(</span><span class="hl-4">resolve</span><span class="hl-1"> </span><span class="hl-6">=&gt;</span><span class="hl-1"> </span><span class="hl-0">setTimeout</span><span class="hl-1">(</span><span class="hl-4">resolve</span><span class="hl-1">, </span><span class="hl-8">2000</span><span class="hl-1">));</span><br/><span class="hl-1">  </span><br/><span class="hl-1">  </span><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-4">signalOpened</span><span class="hl-1">) {</span><br/><span class="hl-1">    </span><span class="hl-0">pass</span><span class="hl-1">(</span><span class="hl-2">&quot;Signal opened and persisted&quot;</span><span class="hl-1">);</span><br/><span class="hl-1">  } </span><span class="hl-3">else</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-0">fail</span><span class="hl-1">(</span><span class="hl-2">&quot;Signal did not open&quot;</span><span class="hl-1">);</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">  </span><br/><span class="hl-1">  </span><span class="hl-5">// Simulate crash: stop and restart</span><br/><span class="hl-1">  </span><span class="hl-0">stop</span><span class="hl-1">();</span><br/><span class="hl-1">  </span><br/><span class="hl-1">  </span><span class="hl-5">// Restart should recover persisted signal</span><br/><span class="hl-1">  </span><span class="hl-4">Live</span><span class="hl-1">.</span><span class="hl-0">background</span><span class="hl-1">(</span><span class="hl-2">&quot;BTCUSDT&quot;</span><span class="hl-1">, {</span><br/><span class="hl-1">    </span><span class="hl-4">strategyName:</span><span class="hl-1"> </span><span class="hl-2">&quot;test-strategy&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-4">exchangeName:</span><span class="hl-1"> </span><span class="hl-2">&quot;test-exchange&quot;</span><br/><span class="hl-1">  });</span><br/><span class="hl-1">  </span><br/><span class="hl-1">  </span><span class="hl-5">// Check if signal was recovered (onActive callback should fire)</span><br/><span class="hl-1">  </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-6">new</span><span class="hl-1"> </span><span class="hl-10">Promise</span><span class="hl-1">(</span><span class="hl-4">resolve</span><span class="hl-1"> </span><span class="hl-6">=&gt;</span><span class="hl-1"> </span><span class="hl-0">setTimeout</span><span class="hl-1">(</span><span class="hl-4">resolve</span><span class="hl-1">, </span><span class="hl-8">1000</span><span class="hl-1">));</span><br/><span class="hl-1">  </span><br/><span class="hl-1">  </span><span class="hl-5">// Cleanup</span><br/><span class="hl-1">  </span><span class="hl-0">stop</span><span class="hl-1">();</span><br/><span class="hl-1">});</span>
</code><button type="button">Copy</button></pre>

<hr>
<a id="direct-persistence-api-usage" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Direct Persistence API Usage<a href="#direct-persistence-api-usage" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>The <code>PersistBase</code> class can be instantiated directly for custom data storage requirements beyond the framework's built-in adapters. This is useful for storing custom logs, metadata, or auxiliary trading data.</p>
<a id="custom-entity-storage-example" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Custom Entity Storage Example<a href="#custom-entity-storage-example" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><pre><code class="typescript"><span class="hl-3">import</span><span class="hl-1"> { </span><span class="hl-4">PersistBase</span><span class="hl-1"> } </span><span class="hl-3">from</span><span class="hl-1"> </span><span class="hl-2">&quot;backtest-kit&quot;</span><span class="hl-1">;</span><br/><br/><span class="hl-5">// Create custom persistence for trading logs</span><br/><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">tradingLogs</span><span class="hl-1"> = </span><span class="hl-6">new</span><span class="hl-1"> </span><span class="hl-0">PersistBase</span><span class="hl-1">(</span><span class="hl-2">&quot;trading-logs&quot;</span><span class="hl-1">, </span><span class="hl-2">&quot;./logs/custom&quot;</span><span class="hl-1">);</span><br/><br/><span class="hl-5">// Initialize</span><br/><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-4">tradingLogs</span><span class="hl-1">.</span><span class="hl-0">waitForInit</span><span class="hl-1">(</span><span class="hl-6">true</span><span class="hl-1">);</span><br/><br/><span class="hl-5">// Write log entry</span><br/><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-4">tradingLogs</span><span class="hl-1">.</span><span class="hl-0">writeValue</span><span class="hl-1">(</span><span class="hl-2">&quot;log-1&quot;</span><span class="hl-1">, {</span><br/><span class="hl-1">  </span><span class="hl-4">timestamp:</span><span class="hl-1"> </span><span class="hl-4">Date</span><span class="hl-1">.</span><span class="hl-0">now</span><span class="hl-1">(),</span><br/><span class="hl-1">  </span><span class="hl-4">message:</span><span class="hl-1"> </span><span class="hl-2">&quot;Strategy started&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">metadata:</span><span class="hl-1"> { </span><span class="hl-4">symbol:</span><span class="hl-1"> </span><span class="hl-2">&quot;BTCUSDT&quot;</span><span class="hl-1">, </span><span class="hl-4">strategy:</span><span class="hl-1"> </span><span class="hl-2">&quot;sma-crossover&quot;</span><span class="hl-1"> }</span><br/><span class="hl-1">});</span><br/><br/><span class="hl-5">// Read log entry</span><br/><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">log</span><span class="hl-1"> = </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-4">tradingLogs</span><span class="hl-1">.</span><span class="hl-0">readValue</span><span class="hl-1">(</span><span class="hl-2">&quot;log-1&quot;</span><span class="hl-1">);</span><br/><span class="hl-4">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-4">log</span><span class="hl-1">);</span><br/><br/><span class="hl-5">// Check if log exists</span><br/><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">exists</span><span class="hl-1"> = </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-4">tradingLogs</span><span class="hl-1">.</span><span class="hl-0">hasValue</span><span class="hl-1">(</span><span class="hl-2">&quot;log-1&quot;</span><span class="hl-1">);</span><br/><span class="hl-4">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-2">`Log exists: </span><span class="hl-6">${</span><span class="hl-4">exists</span><span class="hl-6">}</span><span class="hl-2">`</span><span class="hl-1">);</span><br/><br/><span class="hl-5">// Iterate over all logs</span><br/><span class="hl-3">for</span><span class="hl-1"> </span><span class="hl-3">await</span><span class="hl-1"> (</span><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">log</span><span class="hl-1"> </span><span class="hl-6">of</span><span class="hl-1"> </span><span class="hl-4">tradingLogs</span><span class="hl-1">.</span><span class="hl-0">values</span><span class="hl-1">()) {</span><br/><span class="hl-1">  </span><span class="hl-4">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-2">&quot;Log:&quot;</span><span class="hl-1">, </span><span class="hl-4">log</span><span class="hl-1">);</span><br/><span class="hl-1">}</span><br/><br/><span class="hl-5">// Filter logs</span><br/><span class="hl-3">for</span><span class="hl-1"> </span><span class="hl-3">await</span><span class="hl-1"> (</span><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">log</span><span class="hl-1"> </span><span class="hl-6">of</span><span class="hl-1"> </span><span class="hl-4">tradingLogs</span><span class="hl-1">.</span><span class="hl-0">filter</span><span class="hl-1">((</span><span class="hl-4">l</span><span class="hl-1">: </span><span class="hl-10">any</span><span class="hl-1">) </span><span class="hl-6">=&gt;</span><span class="hl-1"> </span><br/><span class="hl-1">  </span><span class="hl-4">l</span><span class="hl-1">.</span><span class="hl-4">metadata</span><span class="hl-1">.</span><span class="hl-4">symbol</span><span class="hl-1"> === </span><span class="hl-2">&quot;BTCUSDT&quot;</span><br/><span class="hl-1">)) {</span><br/><span class="hl-1">  </span><span class="hl-4">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-2">&quot;BTC Log:&quot;</span><span class="hl-1">, </span><span class="hl-4">log</span><span class="hl-1">);</span><br/><span class="hl-1">}</span><br/><br/><span class="hl-5">// Take first 5 logs</span><br/><span class="hl-3">for</span><span class="hl-1"> </span><span class="hl-3">await</span><span class="hl-1"> (</span><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">log</span><span class="hl-1"> </span><span class="hl-6">of</span><span class="hl-1"> </span><span class="hl-4">tradingLogs</span><span class="hl-1">.</span><span class="hl-0">take</span><span class="hl-1">(</span><span class="hl-8">5</span><span class="hl-1">)) {</span><br/><span class="hl-1">  </span><span class="hl-4">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-2">&quot;Recent Log:&quot;</span><span class="hl-1">, </span><span class="hl-4">log</span><span class="hl-1">);</span><br/><span class="hl-1">}</span><br/><br/><span class="hl-5">// Remove specific log</span><br/><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-4">tradingLogs</span><span class="hl-1">.</span><span class="hl-0">removeValue</span><span class="hl-1">(</span><span class="hl-2">&quot;log-1&quot;</span><span class="hl-1">);</span><br/><br/><span class="hl-5">// Remove all logs</span><br/><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-4">tradingLogs</span><span class="hl-1">.</span><span class="hl-0">removeAll</span><span class="hl-1">();</span>
</code><button type="button">Copy</button></pre>

<a id="use-cases-for-direct-api" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Use Cases for Direct API<a href="#use-cases-for-direct-api" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><table>
<thead>
<tr>
<th>Use Case</th>
<th>Entity Type</th>
<th>Storage Path</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td>Trading Logs</td>
<td><code>&quot;trading-logs&quot;</code></td>
<td><code>./logs/custom/trading-logs/</code></td>
<td>Audit trail of strategy actions</td>
</tr>
<tr>
<td>Performance Metrics</td>
<td><code>&quot;performance&quot;</code></td>
<td><code>./logs/metrics/performance/</code></td>
<td>Per-symbol performance tracking</td>
</tr>
<tr>
<td>Market Data Cache</td>
<td><code>&quot;market-cache&quot;</code></td>
<td><code>./cache/market-cache/</code></td>
<td>Temporary storage of fetched candles</td>
</tr>
<tr>
<td>Configuration Snapshots</td>
<td><code>&quot;config-snapshot&quot;</code></td>
<td><code>./logs/config/config-snapshot/</code></td>
<td>Versioned strategy configurations</td>
</tr>
<tr>
<td>Order History</td>
<td><code>&quot;order-history&quot;</code></td>
<td><code>./logs/orders/order-history/</code></td>
<td>Complete order execution log</td>
</tr>
</tbody>
</table>
</div></div><div class="col-sidebar"><div class="page-menu"><div class="tsd-navigation settings"><details class="tsd-accordion"><summary class="tsd-accordion-summary"><h3><svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-chevronDown"></use></svg>Settings</h3></summary><div class="tsd-accordion-details"><div class="tsd-filter-visibility"><span class="settings-label">Member Visibility</span><ul id="tsd-filter-options"><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-protected" name="protected"/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Protected</span></label></li><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-inherited" name="inherited" checked/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Inherited</span></label></li><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-external" name="external"/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>External</span></label></li></ul></div><div class="tsd-theme-toggle"><label class="settings-label" for="tsd-theme">Theme</label><select id="tsd-theme"><option value="os">OS</option><option value="light">Light</option><option value="dark">Dark</option></select></div></div></details></div><details open class="tsd-accordion tsd-page-navigation"><summary class="tsd-accordion-summary"><h3><svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-chevronDown"></use></svg>On This Page</h3></summary><div class="tsd-accordion-details"><a href="#custom-persistence-backends"><span>Custom <wbr/>Persistence <wbr/>Backends</span></a><ul><li><a href="#purpose-and-scope"><span>Purpose and <wbr/>Scope</span></a></li><li><a href="#persistence-system-architecture"><span>Persistence <wbr/>System <wbr/>Architecture</span></a></li><li><ul><li><a href="#adapter-system-overview"><span>Adapter <wbr/>System <wbr/>Overview</span></a></li><li><a href="#data-storage-organization"><span>Data <wbr/>Storage <wbr/>Organization</span></a></li><li><a href="#persistence-points-in-signal-lifecycle"><span>Persistence <wbr/>Points in <wbr/>Signal <wbr/>Lifecycle</span></a></li></ul></li><li><a href="#persistbase-interface-reference"><span>Persist<wbr/>Base <wbr/>Interface <wbr/>Reference</span></a></li><li><ul><li><a href="#class-definition"><span>Class <wbr/>Definition</span></a></li><li><a href="#method-reference"><span>Method <wbr/>Reference</span></a></li><li><a href="#constructor-parameters"><span>Constructor <wbr/>Parameters</span></a></li></ul></li><li><a href="#implementing-custom-adapters"><span>Implementing <wbr/>Custom <wbr/>Adapters</span></a></li><li><ul><li><a href="#implementation-template"><span>Implementation <wbr/>Template</span></a></li><li><a href="#redis-adapter-example"><span>Redis <wbr/>Adapter <wbr/>Example</span></a></li><li><a href="#mongodb-adapter-example"><span>MongoDB <wbr/>Adapter <wbr/>Example</span></a></li><li><a href="#postgresql-adapter-example"><span>PostgreSQL <wbr/>Adapter <wbr/>Example</span></a></li></ul></li><li><a href="#registering-custom-adapters"><span>Registering <wbr/>Custom <wbr/>Adapters</span></a></li><li><ul><li><a href="#registration-flow"><span>Registration <wbr/>Flow</span></a></li><li><a href="#registration-example"><span>Registration <wbr/>Example</span></a></li><li><a href="#partial-adapter-registration"><span>Partial <wbr/>Adapter <wbr/>Registration</span></a></li></ul></li><li><a href="#backend-selection-guide"><span>Backend <wbr/>Selection <wbr/>Guide</span></a></li><li><ul><li><a href="#backend-comparison-matrix"><span>Backend <wbr/>Comparison <wbr/>Matrix</span></a></li><li><a href="#when-to-use-each-backend"><span>When to <wbr/>Use <wbr/>Each <wbr/>Backend</span></a></li><li><a href="#performance-characteristics"><span>Performance <wbr/>Characteristics</span></a></li></ul></li><li><a href="#testing-custom-adapters"><span>Testing <wbr/>Custom <wbr/>Adapters</span></a></li><li><ul><li><a href="#test-template"><span>Test <wbr/>Template</span></a></li><li><a href="#integration-test-with-live-mode"><span>Integration <wbr/>Test with <wbr/>Live <wbr/>Mode</span></a></li></ul></li><li><a href="#direct-persistence-api-usage"><span>Direct <wbr/>Persistence API <wbr/>Usage</span></a></li><li><ul><li><a href="#custom-entity-storage-example"><span>Custom <wbr/>Entity <wbr/>Storage <wbr/>Example</span></a></li><li><a href="#use-cases-for-direct-api"><span>Use <wbr/>Cases for <wbr/>Direct API</span></a></li></ul></li></ul></div></details></div><div class="site-menu"><nav class="tsd-navigation"><a href="../modules.html">backtest-kit</a><ul class="tsd-small-nested-navigation" id="tsd-nav-container"><li>Loading...</li></ul></nav></div></div></div><footer><p class="tsd-generator">Generated using <a href="https://typedoc.org/" target="_blank">TypeDoc</a></p></footer><div class="overlay"></div></body></html>

<!-- Yandex.Metrika counter -->
<script type="text/javascript">
    (function(m,e,t,r,i,k,a){
        m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
        m[i].l=1*new Date();
        for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }}
        k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)
    })(window, document,'script','https://mc.yandex.ru/metrika/tag.js?id=105455585', 'ym');

    ym(105455585, 'init', {ssr:true, webvisor:true, clickmap:true, ecommerce:"dataLayer", accurateTrackBounce:true, trackLinks:true});
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/105455585" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
<!-- /Yandex.Metrika counter -->

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-3MQZEBBDDR"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-3MQZEBBDDR');
</script>
