<!DOCTYPE html><html class="default" lang="en" data-base=".."><head><meta charset="utf-8"/><meta http-equiv="x-ua-compatible" content="IE=edge"/><title>design/26_exchange_schemas | backtest-kit</title><meta name="description" content="Documentation for backtest-kit"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="stylesheet" href="../assets/style.css"/><link rel="stylesheet" href="../assets/highlight.css"/><script defer src="../assets/main.js"></script><script async src="../assets/icons.js" id="tsd-icons-script"></script><script async src="../assets/search.js" id="tsd-search-script"></script><script async src="../assets/navigation.js" id="tsd-nav-script"></script><script async src="../assets/hierarchy.js" id="tsd-hierarchy-script"></script></head><body><script>document.documentElement.dataset.theme = localStorage.getItem("tsd-theme") || "os";document.body.style.display="none";setTimeout(() => app?app.showPage():document.body.style.removeProperty("display"),500)</script><header class="tsd-page-toolbar"><div class="tsd-toolbar-contents container"><div class="table-cell" id="tsd-search"><div class="field"><label for="tsd-search-field" class="tsd-widget tsd-toolbar-icon search no-caption"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-search"></use></svg></label><input type="text" id="tsd-search-field" aria-label="Search"/></div><div class="field"><div id="tsd-toolbar-links"></div></div><ul class="results"><li class="state loading">Preparing search index...</li><li class="state failure">The search index is not available</li></ul><a href="../index.html" class="title">backtest-kit</a></div><div class="table-cell" id="tsd-widgets"><a href="#" class="tsd-widget tsd-toolbar-icon menu no-caption" data-toggle="menu" aria-label="Menu"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-menu"></use></svg></a></div></div></header><div class="container container-main"><div class="col-content"><div class="tsd-page-title"><ul class="tsd-breadcrumb"><li><a href="../modules.html">backtest-kit</a></li><li><a href="design_26_exchange_schemas.html">design/26_exchange_schemas</a></li></ul></div><div class="tsd-panel tsd-typography"><a id="exchange-schemas" class="tsd-anchor"></a><h1 class="tsd-anchor-link">Exchange Schemas<a href="#exchange-schemas" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h1><p>Exchange schemas define market data sources for backtesting and live trading. An exchange provides historical candle data (OHLCV) and formatting functions for prices and quantities. Exchanges are registered via <code>addExchange()</code> and instantiated as <code>ClientExchange</code> instances by the connection service layer.</p>
<p>For information about strategy schemas that consume exchange data, see <a href="design_25_strategy_schemas.html">Strategy Schemas</a>. For frame schemas that define backtest time ranges, see <a href="design_27_frame_schemas.html">Frame Schemas</a>.</p>
<hr>
<a id="interface-definition" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Interface Definition<a href="#interface-definition" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>The <code>IExchangeSchema</code> interface specifies the contract for all exchange implementations. It consists of three core functions and optional lifecycle callbacks.</p>
<p><img src="../media/26_Exchange_Schemas_0.svg" alt="Mermaid Diagram"></p>
<hr>
<a id="required-fields" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Required Fields<a href="#required-fields" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><a id="exchangename" class="tsd-anchor"></a><h3 class="tsd-anchor-link">exchangeName<a href="#exchangename" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Unique identifier for the exchange. Used throughout the system to reference this exchange configuration via dependency injection.</p>
<table>
<thead>
<tr>
<th>Property</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>exchangeName</code></td>
<td><code>ExchangeName</code> (string)</td>
<td>Unique exchange identifier</td>
</tr>
<tr>
<td><code>note</code></td>
<td><code>string?</code></td>
<td>Optional developer documentation</td>
</tr>
</tbody>
</table>
<a id="getcandles-function" class="tsd-anchor"></a><h3 class="tsd-anchor-link">getCandles Function<a href="#getcandles-function" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Fetches historical OHLCV candle data from the exchange data source (API, database, or custom provider).</p>
<p><strong>Signature:</strong></p>
<pre><code class="typescript"><span class="hl-10">getCandles</span><span class="hl-1">: (</span><br/><span class="hl-1">    </span><span class="hl-4">symbol</span><span class="hl-1">: </span><span class="hl-4">string</span><span class="hl-1">,        </span><span class="hl-5">// Trading pair (e.g., &quot;BTCUSDT&quot;)</span><br/><span class="hl-1">    </span><span class="hl-4">interval</span><span class="hl-1">: </span><span class="hl-4">CandleInterval</span><span class="hl-1">,  </span><span class="hl-5">// Candle time interval</span><br/><span class="hl-1">    </span><span class="hl-4">since</span><span class="hl-1">: </span><span class="hl-4">Date</span><span class="hl-1">,           </span><span class="hl-5">// Start date for data fetch</span><br/><span class="hl-1">    </span><span class="hl-4">limit</span><span class="hl-1">: </span><span class="hl-4">number</span><span class="hl-1">          </span><span class="hl-5">// Maximum candles to return</span><br/><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> </span><span class="hl-11">Promise</span><span class="hl-1">&lt;</span><span class="hl-4">ICandleData</span><span class="hl-1">[]&gt;</span>
</code><button type="button">Copy</button></pre>

<p><strong>Returns:</strong> Array of <code>ICandleData</code> objects sorted by timestamp ascending.</p>
<p><strong>Temporal Isolation:</strong> The <code>since</code> parameter is automatically determined by <code>ExecutionContextService.context.when</code> to prevent look-ahead bias during backtesting. Strategies cannot access future data.</p>
<a id="formatprice-function" class="tsd-anchor"></a><h3 class="tsd-anchor-link">formatPrice Function<a href="#formatprice-function" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Formats price values according to exchange precision rules (e.g., 2 decimal places for USDT pairs).</p>
<p><strong>Signature:</strong></p>
<pre><code class="typescript"><span class="hl-10">formatPrice</span><span class="hl-1">: (</span><br/><span class="hl-1">    </span><span class="hl-4">symbol</span><span class="hl-1">: </span><span class="hl-4">string</span><span class="hl-1">,    </span><span class="hl-5">// Trading pair</span><br/><span class="hl-1">    </span><span class="hl-4">price</span><span class="hl-1">: </span><span class="hl-4">number</span><span class="hl-1">      </span><span class="hl-5">// Raw price value</span><br/><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> </span><span class="hl-11">Promise</span><span class="hl-1">&lt;</span><span class="hl-4">string</span><span class="hl-1">&gt;   </span><span class="hl-5">// Formatted price string</span>
</code><button type="button">Copy</button></pre>

<a id="formatquantity-function" class="tsd-anchor"></a><h3 class="tsd-anchor-link">formatQuantity Function<a href="#formatquantity-function" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Formats quantity/amount values according to exchange precision rules (e.g., 8 decimal places for BTC).</p>
<p><strong>Signature:</strong></p>
<pre><code class="typescript"><span class="hl-10">formatQuantity</span><span class="hl-1">: (</span><br/><span class="hl-1">    </span><span class="hl-4">symbol</span><span class="hl-1">: </span><span class="hl-4">string</span><span class="hl-1">,     </span><span class="hl-5">// Trading pair</span><br/><span class="hl-1">    </span><span class="hl-4">quantity</span><span class="hl-1">: </span><span class="hl-4">number</span><span class="hl-1">    </span><span class="hl-5">// Raw quantity value</span><br/><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> </span><span class="hl-11">Promise</span><span class="hl-1">&lt;</span><span class="hl-4">string</span><span class="hl-1">&gt;    </span><span class="hl-5">// Formatted quantity string</span>
</code><button type="button">Copy</button></pre>

<hr>
<a id="candle-data-structure" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Candle Data Structure<a href="#candle-data-structure" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>Each candle represents aggregated trading data for a specific time interval.</p>
<p><img src="../media/26_Exchange_Schemas_1.svg" alt="Mermaid Diagram"></p>
<table>
<thead>
<tr>
<th>Field</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>timestamp</code></td>
<td><code>number</code></td>
<td>Unix timestamp in milliseconds when candle opened</td>
</tr>
<tr>
<td><code>open</code></td>
<td><code>number</code></td>
<td>Opening price at candle start</td>
</tr>
<tr>
<td><code>high</code></td>
<td><code>number</code></td>
<td>Highest price during candle period</td>
</tr>
<tr>
<td><code>low</code></td>
<td><code>number</code></td>
<td>Lowest price during candle period</td>
</tr>
<tr>
<td><code>close</code></td>
<td><code>number</code></td>
<td>Closing price at candle end</td>
</tr>
<tr>
<td><code>volume</code></td>
<td><code>number</code></td>
<td>Trading volume during candle period</td>
</tr>
</tbody>
</table>
<p><strong>VWAP Formula:</strong> The system uses the last 5 1-minute candles to calculate Volume Weighted Average Price for realistic entry/exit pricing:</p>
<pre><code><span class="hl-4">Typical</span><span class="hl-1"> </span><span class="hl-4">Price</span><span class="hl-1"> = (</span><span class="hl-4">High</span><span class="hl-1"> + </span><span class="hl-4">Low</span><span class="hl-1"> + </span><span class="hl-4">Close</span><span class="hl-1">) / </span><span class="hl-6">3</span><br/><span class="hl-8">VWAP</span><span class="hl-1"> = </span><span class="hl-0">Σ</span><span class="hl-1">(</span><span class="hl-4">Typical</span><span class="hl-1"> </span><span class="hl-4">Price</span><span class="hl-1"> × </span><span class="hl-4">Volume</span><span class="hl-1">) / </span><span class="hl-0">Σ</span><span class="hl-1">(</span><span class="hl-4">Volume</span><span class="hl-1">)</span>
</code><button>Copy</button></pre>

<hr>
<a id="registration-flow" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Registration Flow<a href="#registration-flow" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>Exchange schemas are registered via <code>addExchange()</code> and stored in <code>ExchangeSchemaService</code> using the <code>ToolRegistry</code> pattern.</p>
<p><img src="../media/26_Exchange_Schemas_2.svg" alt="Mermaid Diagram"></p>
<hr>
<a id="exchange-instance-lifecycle" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Exchange Instance Lifecycle<a href="#exchange-instance-lifecycle" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p><code>ExchangeConnectionService</code> creates and memoizes <code>ClientExchange</code> instances using a composite key strategy.</p>
<p><img src="../media/26_Exchange_Schemas_3.svg" alt="Mermaid Diagram"></p>
<p><strong>Memoization Key:</strong> <code>${symbol}:${exchangeName}:${backtest}</code></p>
<p>This ensures separate exchange instances for:</p>
<ul>
<li>Different symbols (e.g., BTCUSDT vs ETHUSDT)</li>
<li>Different exchanges (e.g., binance vs coinbase)</li>
<li>Different execution modes (backtest vs live)</li>
</ul>
<hr>
<a id="candle-data-flow" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Candle Data Flow<a href="#candle-data-flow" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>Exchange candles flow through multiple layers before reaching strategies.</p>
<p><img src="../media/26_Exchange_Schemas_4.svg" alt="Mermaid Diagram"></p>
<p><strong>Temporal Isolation:</strong> <code>ClientExchange</code> automatically filters candles to ensure <code>candle.timestamp &lt;= ExecutionContextService.context.when</code>. This prevents look-ahead bias in backtesting.</p>
<hr>
<a id="callbacks" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Callbacks<a href="#callbacks" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>Optional lifecycle callbacks for monitoring candle data fetching.</p>
<a id="oncandledata" class="tsd-anchor"></a><h3 class="tsd-anchor-link">onCandleData<a href="#oncandledata" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Invoked after candle data is successfully fetched from the exchange. Useful for logging, caching, or debugging.</p>
<pre><code class="typescript"><span class="hl-10">callbacks</span><span class="hl-1">: {</span><br/><span class="hl-1">    </span><span class="hl-10">onCandleData</span><span class="hl-1">: (</span><br/><span class="hl-1">        </span><span class="hl-4">symbol</span><span class="hl-1">: </span><span class="hl-4">string</span><span class="hl-1">,          </span><span class="hl-5">// Trading pair</span><br/><span class="hl-1">        </span><span class="hl-4">interval</span><span class="hl-1">: </span><span class="hl-4">CandleInterval</span><span class="hl-1">, </span><span class="hl-5">// Candle interval</span><br/><span class="hl-1">        </span><span class="hl-4">since</span><span class="hl-1">: </span><span class="hl-4">Date</span><span class="hl-1">,             </span><span class="hl-5">// Start date requested</span><br/><span class="hl-1">        </span><span class="hl-4">limit</span><span class="hl-1">: </span><span class="hl-4">number</span><span class="hl-1">,           </span><span class="hl-5">// Limit requested</span><br/><span class="hl-1">        </span><span class="hl-4">data</span><span class="hl-1">: </span><span class="hl-4">ICandleData</span><span class="hl-1">[]      </span><span class="hl-5">// Fetched candles</span><br/><span class="hl-1">    ) </span><span class="hl-7">=&gt;</span><span class="hl-1"> </span><span class="hl-7">void</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<hr>
<a id="integration-example" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Integration Example<a href="#integration-example" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>Typical exchange schema using CCXT for Binance data:</p>
<pre><code class="typescript"><span class="hl-3">import</span><span class="hl-1"> </span><span class="hl-4">ccxt</span><span class="hl-1"> </span><span class="hl-3">from</span><span class="hl-1"> </span><span class="hl-2">&quot;ccxt&quot;</span><span class="hl-1">;</span><br/><span class="hl-3">import</span><span class="hl-1"> { </span><span class="hl-4">addExchange</span><span class="hl-1"> } </span><span class="hl-3">from</span><span class="hl-1"> </span><span class="hl-2">&quot;backtest-kit&quot;</span><span class="hl-1">;</span><br/><br/><span class="hl-0">addExchange</span><span class="hl-1">({</span><br/><span class="hl-1">    </span><span class="hl-4">exchangeName:</span><span class="hl-1"> </span><span class="hl-2">&quot;binance&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-4">note:</span><span class="hl-1"> </span><span class="hl-2">&quot;Binance exchange via CCXT&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><br/><span class="hl-1">    </span><span class="hl-0">getCandles</span><span class="hl-4">:</span><span class="hl-1"> </span><span class="hl-7">async</span><span class="hl-1"> (</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">interval</span><span class="hl-1">, </span><span class="hl-4">since</span><span class="hl-1">, </span><span class="hl-4">limit</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">        </span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">exchange</span><span class="hl-1"> = </span><span class="hl-7">new</span><span class="hl-1"> </span><span class="hl-4">ccxt</span><span class="hl-1">.</span><span class="hl-0">binance</span><span class="hl-1">();</span><br/><span class="hl-1">        </span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">ohlcv</span><span class="hl-1"> = </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-4">exchange</span><span class="hl-1">.</span><span class="hl-0">fetchOHLCV</span><span class="hl-1">(</span><br/><span class="hl-1">            </span><span class="hl-4">symbol</span><span class="hl-1">, </span><br/><span class="hl-1">            </span><span class="hl-4">interval</span><span class="hl-1">, </span><br/><span class="hl-1">            </span><span class="hl-4">since</span><span class="hl-1">.</span><span class="hl-0">getTime</span><span class="hl-1">(), </span><br/><span class="hl-1">            </span><span class="hl-4">limit</span><br/><span class="hl-1">        );</span><br/><span class="hl-1">        </span><br/><span class="hl-1">        </span><span class="hl-3">return</span><span class="hl-1"> </span><span class="hl-4">ohlcv</span><span class="hl-1">.</span><span class="hl-0">map</span><span class="hl-1">(([</span><span class="hl-4">timestamp</span><span class="hl-1">, </span><span class="hl-4">open</span><span class="hl-1">, </span><span class="hl-4">high</span><span class="hl-1">, </span><span class="hl-4">low</span><span class="hl-1">, </span><span class="hl-4">close</span><span class="hl-1">, </span><span class="hl-4">volume</span><span class="hl-1">]) </span><span class="hl-7">=&gt;</span><span class="hl-1"> ({</span><br/><span class="hl-1">            </span><span class="hl-4">timestamp</span><span class="hl-1">,</span><br/><span class="hl-1">            </span><span class="hl-4">open</span><span class="hl-1">,</span><br/><span class="hl-1">            </span><span class="hl-4">high</span><span class="hl-1">,</span><br/><span class="hl-1">            </span><span class="hl-4">low</span><span class="hl-1">,</span><br/><span class="hl-1">            </span><span class="hl-4">close</span><span class="hl-1">,</span><br/><span class="hl-1">            </span><span class="hl-4">volume</span><br/><span class="hl-1">        }));</span><br/><span class="hl-1">    },</span><br/><span class="hl-1">    </span><br/><span class="hl-1">    </span><span class="hl-0">formatPrice</span><span class="hl-4">:</span><span class="hl-1"> </span><span class="hl-7">async</span><span class="hl-1"> (</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">price</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">        </span><span class="hl-5">// USDT pairs: 2 decimals</span><br/><span class="hl-1">        </span><span class="hl-3">return</span><span class="hl-1"> </span><span class="hl-4">price</span><span class="hl-1">.</span><span class="hl-0">toFixed</span><span class="hl-1">(</span><span class="hl-6">2</span><span class="hl-1">);</span><br/><span class="hl-1">    },</span><br/><span class="hl-1">    </span><br/><span class="hl-1">    </span><span class="hl-0">formatQuantity</span><span class="hl-4">:</span><span class="hl-1"> </span><span class="hl-7">async</span><span class="hl-1"> (</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">quantity</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">        </span><span class="hl-5">// BTC: 8 decimals</span><br/><span class="hl-1">        </span><span class="hl-3">return</span><span class="hl-1"> </span><span class="hl-4">quantity</span><span class="hl-1">.</span><span class="hl-0">toFixed</span><span class="hl-1">(</span><span class="hl-6">8</span><span class="hl-1">);</span><br/><span class="hl-1">    },</span><br/><span class="hl-1">    </span><br/><span class="hl-1">    </span><span class="hl-4">callbacks:</span><span class="hl-1"> {</span><br/><span class="hl-1">        </span><span class="hl-0">onCandleData</span><span class="hl-4">:</span><span class="hl-1"> (</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">interval</span><span class="hl-1">, </span><span class="hl-4">since</span><span class="hl-1">, </span><span class="hl-4">limit</span><span class="hl-1">, </span><span class="hl-4">data</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">            </span><span class="hl-4">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-2">`Fetched </span><span class="hl-7">${</span><span class="hl-4">data</span><span class="hl-9">.</span><span class="hl-4">length</span><span class="hl-7">}</span><span class="hl-2"> </span><span class="hl-7">${</span><span class="hl-4">interval</span><span class="hl-7">}</span><span class="hl-2"> candles for </span><span class="hl-7">${</span><span class="hl-4">symbol</span><span class="hl-7">}</span><span class="hl-2">`</span><span class="hl-1">);</span><br/><span class="hl-1">        }</span><br/><span class="hl-1">    }</span><br/><span class="hl-1">});</span>
</code><button type="button">Copy</button></pre>

<hr>
<a id="validation-rules" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Validation Rules<a href="#validation-rules" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p><code>ExchangeValidationService</code> enforces the following constraints during registration:</p>
<table>
<thead>
<tr>
<th>Rule</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Unique Name</strong></td>
<td><code>exchangeName</code> must be unique across all registered exchanges</td>
</tr>
<tr>
<td><strong>Required Functions</strong></td>
<td><code>getCandles</code>, <code>formatPrice</code>, <code>formatQuantity</code> must be provided</td>
</tr>
<tr>
<td><strong>Valid Return Types</strong></td>
<td><code>getCandles</code> must return <code>Promise&lt;ICandleData[]&gt;</code></td>
</tr>
<tr>
<td><strong>Valid Intervals</strong></td>
<td>All <code>CandleInterval</code> values must be supported</td>
</tr>
</tbody>
</table>
<hr>
<a id="clientexchange-implementation" class="tsd-anchor"></a><h2 class="tsd-anchor-link">ClientExchange Implementation<a href="#clientexchange-implementation" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>The <code>ClientExchange</code> class implements the <code>IExchange</code> interface and provides additional functionality:</p>
<p><img src="../media/26_Exchange_Schemas_5.svg" alt="Mermaid Diagram"></p>
<p><strong>Additional Methods:</strong></p>
<a id="getnextcandles" class="tsd-anchor"></a><h3 class="tsd-anchor-link">getNextCandles<a href="#getnextcandles" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Fetches future candles for backtest fast-forwarding. Only used in backtest mode.</p>
<pre><code class="typescript"><span class="hl-10">getNextCandles</span><span class="hl-1">: (</span><br/><span class="hl-1">    </span><span class="hl-4">symbol</span><span class="hl-1">: </span><span class="hl-4">string</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-4">interval</span><span class="hl-1">: </span><span class="hl-4">CandleInterval</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-4">limit</span><span class="hl-1">: </span><span class="hl-4">number</span><br/><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> </span><span class="hl-11">Promise</span><span class="hl-1">&lt;</span><span class="hl-4">ICandleData</span><span class="hl-1">[]&gt;</span>
</code><button type="button">Copy</button></pre>

<p>Calculates <code>since</code> as <code>context.when + (interval duration)</code> to fetch candles starting after the current execution time.</p>
<a id="getaverageprice" class="tsd-anchor"></a><h3 class="tsd-anchor-link">getAveragePrice<a href="#getaverageprice" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Calculates VWAP from the last 5 1-minute candles. This is the price used for all signal entry/exit calculations to provide realistic execution pricing.</p>
<pre><code class="typescript"><span class="hl-10">getAveragePrice</span><span class="hl-1">: (</span><span class="hl-4">symbol</span><span class="hl-1">: </span><span class="hl-11">string</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> </span><span class="hl-11">Promise</span><span class="hl-1">&lt;</span><span class="hl-4">number</span><span class="hl-1">&gt;</span>
</code><button type="button">Copy</button></pre>

<p><strong>Formula Implementation:</strong></p>
<pre><code class="typescript"><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">candles</span><span class="hl-1"> = </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-7">this</span><span class="hl-1">.</span><span class="hl-0">getCandles</span><span class="hl-1">(</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-2">&quot;1m&quot;</span><span class="hl-1">, </span><span class="hl-6">5</span><span class="hl-1">);</span><br/><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">totalValue</span><span class="hl-1"> = </span><span class="hl-4">candles</span><span class="hl-1">.</span><span class="hl-0">reduce</span><span class="hl-1">((</span><span class="hl-4">sum</span><span class="hl-1">, </span><span class="hl-4">c</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">typicalPrice</span><span class="hl-1"> = (</span><span class="hl-4">c</span><span class="hl-1">.</span><span class="hl-4">high</span><span class="hl-1"> + </span><span class="hl-4">c</span><span class="hl-1">.</span><span class="hl-4">low</span><span class="hl-1"> + </span><span class="hl-4">c</span><span class="hl-1">.</span><span class="hl-4">close</span><span class="hl-1">) / </span><span class="hl-6">3</span><span class="hl-1">;</span><br/><span class="hl-1">    </span><span class="hl-3">return</span><span class="hl-1"> </span><span class="hl-4">sum</span><span class="hl-1"> + (</span><span class="hl-4">typicalPrice</span><span class="hl-1"> * </span><span class="hl-4">c</span><span class="hl-1">.</span><span class="hl-4">volume</span><span class="hl-1">);</span><br/><span class="hl-1">}, </span><span class="hl-6">0</span><span class="hl-1">);</span><br/><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">totalVolume</span><span class="hl-1"> = </span><span class="hl-4">candles</span><span class="hl-1">.</span><span class="hl-0">reduce</span><span class="hl-1">((</span><span class="hl-4">sum</span><span class="hl-1">, </span><span class="hl-4">c</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> </span><span class="hl-4">sum</span><span class="hl-1"> + </span><span class="hl-4">c</span><span class="hl-1">.</span><span class="hl-4">volume</span><span class="hl-1">, </span><span class="hl-6">0</span><span class="hl-1">);</span><br/><span class="hl-3">return</span><span class="hl-1"> </span><span class="hl-4">totalValue</span><span class="hl-1"> / </span><span class="hl-4">totalVolume</span><span class="hl-1">;</span>
</code><button type="button">Copy</button></pre>

<hr>
<a id="temporal-isolation" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Temporal Isolation<a href="#temporal-isolation" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p><code>ClientExchange</code> enforces temporal isolation to prevent look-ahead bias during backtesting.</p>
<p><img src="../media/26_Exchange_Schemas_6.svg" alt="Mermaid Diagram"></p>
<p><strong>Implementation:</strong> <a href="">src/client/ClientExchange.ts:70-120</a></p>
<p>This ensures that strategies only see historical data up to the current backtest timestamp, preventing look-ahead bias and ensuring realistic strategy testing.</p>
<hr>
<a id="public-api-functions" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Public API Functions<a href="#public-api-functions" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>Helper functions for accessing exchange functionality from user code:</p>
<a id="getcandles" class="tsd-anchor"></a><h3 class="tsd-anchor-link">getCandles<a href="#getcandles" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><pre><code class="typescript"><span class="hl-3">import</span><span class="hl-1"> { </span><span class="hl-4">getCandles</span><span class="hl-1"> } </span><span class="hl-3">from</span><span class="hl-1"> </span><span class="hl-2">&quot;backtest-kit&quot;</span><span class="hl-1">;</span><br/><br/><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">candles</span><span class="hl-1"> = </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-0">getCandles</span><span class="hl-1">(</span><span class="hl-2">&quot;BTCUSDT&quot;</span><span class="hl-1">, </span><span class="hl-2">&quot;1m&quot;</span><span class="hl-1">, </span><span class="hl-6">30</span><span class="hl-1">);</span>
</code><button type="button">Copy</button></pre>

<p>Retrieves candles using the current execution context (symbol, exchange, timestamp).</p>
<a id="getaverageprice-1" class="tsd-anchor"></a><h3 class="tsd-anchor-link">getAveragePrice<a href="#getaverageprice-1" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><pre><code class="typescript"><span class="hl-3">import</span><span class="hl-1"> { </span><span class="hl-4">getAveragePrice</span><span class="hl-1"> } </span><span class="hl-3">from</span><span class="hl-1"> </span><span class="hl-2">&quot;backtest-kit&quot;</span><span class="hl-1">;</span><br/><br/><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">vwapPrice</span><span class="hl-1"> = </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-0">getAveragePrice</span><span class="hl-1">(</span><span class="hl-2">&quot;BTCUSDT&quot;</span><span class="hl-1">);</span>
</code><button type="button">Copy</button></pre>

<p>Calculates VWAP from the last 5 1-minute candles.</p>
<a id="formatprice--formatquantity" class="tsd-anchor"></a><h3 class="tsd-anchor-link">formatPrice / formatQuantity<a href="#formatprice--formatquantity" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><pre><code class="typescript"><span class="hl-3">import</span><span class="hl-1"> { </span><span class="hl-4">formatPrice</span><span class="hl-1">, </span><span class="hl-4">formatQuantity</span><span class="hl-1"> } </span><span class="hl-3">from</span><span class="hl-1"> </span><span class="hl-2">&quot;backtest-kit&quot;</span><span class="hl-1">;</span><br/><br/><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">priceStr</span><span class="hl-1"> = </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-0">formatPrice</span><span class="hl-1">(</span><span class="hl-2">&quot;BTCUSDT&quot;</span><span class="hl-1">, </span><span class="hl-6">50000.123</span><span class="hl-1">);  </span><span class="hl-5">// &quot;50000.12&quot;</span><br/><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">qtyStr</span><span class="hl-1"> = </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-0">formatQuantity</span><span class="hl-1">(</span><span class="hl-2">&quot;BTCUSDT&quot;</span><span class="hl-1">, </span><span class="hl-6">0.123456789</span><span class="hl-1">);  </span><span class="hl-5">// &quot;0.12345679&quot;</span>
</code><button type="button">Copy</button></pre>

<p>Formats values according to exchange precision rules.</p>
</div></div><div class="col-sidebar"><div class="page-menu"><div class="tsd-navigation settings"><details class="tsd-accordion"><summary class="tsd-accordion-summary"><h3><svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-chevronDown"></use></svg>Settings</h3></summary><div class="tsd-accordion-details"><div class="tsd-filter-visibility"><span class="settings-label">Member Visibility</span><ul id="tsd-filter-options"><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-protected" name="protected"/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Protected</span></label></li><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-inherited" name="inherited" checked/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Inherited</span></label></li><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-external" name="external"/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>External</span></label></li></ul></div><div class="tsd-theme-toggle"><label class="settings-label" for="tsd-theme">Theme</label><select id="tsd-theme"><option value="os">OS</option><option value="light">Light</option><option value="dark">Dark</option></select></div></div></details></div><details open class="tsd-accordion tsd-page-navigation"><summary class="tsd-accordion-summary"><h3><svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-chevronDown"></use></svg>On This Page</h3></summary><div class="tsd-accordion-details"><a href="#exchange-schemas"><span>Exchange <wbr/>Schemas</span></a><ul><li><a href="#interface-definition"><span>Interface <wbr/>Definition</span></a></li><li><a href="#required-fields"><span>Required <wbr/>Fields</span></a></li><li><ul><li><a href="#exchangename"><span>exchange<wbr/>Name</span></a></li><li><a href="#getcandles-function"><span>get<wbr/>Candles <wbr/>Function</span></a></li><li><a href="#formatprice-function"><span>format<wbr/>Price <wbr/>Function</span></a></li><li><a href="#formatquantity-function"><span>format<wbr/>Quantity <wbr/>Function</span></a></li></ul></li><li><a href="#candle-data-structure"><span>Candle <wbr/>Data <wbr/>Structure</span></a></li><li><a href="#registration-flow"><span>Registration <wbr/>Flow</span></a></li><li><a href="#exchange-instance-lifecycle"><span>Exchange <wbr/>Instance <wbr/>Lifecycle</span></a></li><li><a href="#candle-data-flow"><span>Candle <wbr/>Data <wbr/>Flow</span></a></li><li><a href="#callbacks"><span>Callbacks</span></a></li><li><ul><li><a href="#oncandledata"><span>on<wbr/>Candle<wbr/>Data</span></a></li></ul></li><li><a href="#integration-example"><span>Integration <wbr/>Example</span></a></li><li><a href="#validation-rules"><span>Validation <wbr/>Rules</span></a></li><li><a href="#clientexchange-implementation"><span>Client<wbr/>Exchange <wbr/>Implementation</span></a></li><li><ul><li><a href="#getnextcandles"><span>get<wbr/>Next<wbr/>Candles</span></a></li><li><a href="#getaverageprice"><span>get<wbr/>Average<wbr/>Price</span></a></li></ul></li><li><a href="#temporal-isolation"><span>Temporal <wbr/>Isolation</span></a></li><li><a href="#public-api-functions"><span>Public API <wbr/>Functions</span></a></li><li><ul><li><a href="#getcandles"><span>get<wbr/>Candles</span></a></li><li><a href="#getaverageprice-1"><span>get<wbr/>Average<wbr/>Price</span></a></li><li><a href="#formatprice--formatquantity"><span>format<wbr/>Price / format<wbr/>Quantity</span></a></li></ul></li></ul></div></details></div><div class="site-menu"><nav class="tsd-navigation"><a href="../modules.html">backtest-kit</a><ul class="tsd-small-nested-navigation" id="tsd-nav-container"><li>Loading...</li></ul></nav></div></div></div><footer><p class="tsd-generator">Generated using <a href="https://typedoc.org/" target="_blank">TypeDoc</a></p></footer><div class="overlay"></div></body></html>

<!-- Yandex.Metrika counter -->
<script type="text/javascript">
    (function(m,e,t,r,i,k,a){
        m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
        m[i].l=1*new Date();
        for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }}
        k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)
    })(window, document,'script','https://mc.yandex.ru/metrika/tag.js?id=105455585', 'ym');

    ym(105455585, 'init', {ssr:true, webvisor:true, clickmap:true, ecommerce:"dataLayer", accurateTrackBounce:true, trackLinks:true});
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/105455585" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
<!-- /Yandex.Metrika counter -->

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-3MQZEBBDDR"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-3MQZEBBDDR');
</script>
