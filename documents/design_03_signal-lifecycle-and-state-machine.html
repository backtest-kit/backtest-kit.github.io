<!DOCTYPE html><html class="default" lang="en" data-base=".."><head><meta charset="utf-8"/><meta http-equiv="x-ua-compatible" content="IE=edge"/><title>design/03_signal-lifecycle-and-state-machine | backtest-kit</title><meta name="description" content="Documentation for backtest-kit"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="stylesheet" href="../assets/style.css"/><link rel="stylesheet" href="../assets/highlight.css"/><script defer src="../assets/main.js"></script><script async src="../assets/icons.js" id="tsd-icons-script"></script><script async src="../assets/search.js" id="tsd-search-script"></script><script async src="../assets/navigation.js" id="tsd-nav-script"></script><script async src="../assets/hierarchy.js" id="tsd-hierarchy-script"></script></head><body><script>document.documentElement.dataset.theme = localStorage.getItem("tsd-theme") || "os";document.body.style.display="none";setTimeout(() => app?app.showPage():document.body.style.removeProperty("display"),500)</script><header class="tsd-page-toolbar"><div class="tsd-toolbar-contents container"><div class="table-cell" id="tsd-search"><div class="field"><label for="tsd-search-field" class="tsd-widget tsd-toolbar-icon search no-caption"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-search"></use></svg></label><input type="text" id="tsd-search-field" aria-label="Search"/></div><div class="field"><div id="tsd-toolbar-links"></div></div><ul class="results"><li class="state loading">Preparing search index...</li><li class="state failure">The search index is not available</li></ul><a href="../index.html" class="title">backtest-kit</a></div><div class="table-cell" id="tsd-widgets"><a href="#" class="tsd-widget tsd-toolbar-icon menu no-caption" data-toggle="menu" aria-label="Menu"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-menu"></use></svg></a></div></div></header><div class="container container-main"><div class="col-content"><div class="tsd-page-title"><ul class="tsd-breadcrumb"><li><a href="../modules.html">backtest-kit</a></li><li><a href="design_03_signal-lifecycle-and-state-machine.html">design/03_signal-lifecycle-and-state-machine</a></li></ul></div><div class="tsd-panel tsd-typography"><a id="signal-lifecycle-and-state-machine" class="tsd-anchor"></a><h1 class="tsd-anchor-link">Signal Lifecycle and State Machine<a href="#signal-lifecycle-and-state-machine" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h1><a id="purpose-and-scope" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Purpose and Scope<a href="#purpose-and-scope" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>This document describes the complete lifecycle of trading signals in backtest-kit, including the state machine that governs signal progression from creation through closure. It covers the discriminated union type system used for type-safe state handling, state transition conditions, scheduled vs immediate signal flows, and crash-safe persistence mechanisms.</p>
<p>For information about how signals are generated by strategies, see the Strategy System documentation. For details on execution modes (Backtest vs Live), see <a href="design_04_execution-modes-overview.html">Execution Modes Overview</a>. For event-driven monitoring of signal state changes, see <a href="design_05_event-driven-architecture.html">Event-Driven Architecture</a>.</p>
<hr>
<a id="signal-state-machine-overview" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Signal State Machine Overview<a href="#signal-state-machine-overview" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>The signal lifecycle is implemented as a type-safe state machine using TypeScript discriminated unions. Every signal progresses through distinct states, with transitions triggered by price conditions, time expiration, or risk validation failures.</p>
<p><img src="../media/03-signal-lifecycle-and-state-machine_0.svg" alt="Mermaid Diagram"></p>
<hr>
<a id="discriminated-union-type-system" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Discriminated Union Type System<a href="#discriminated-union-type-system" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>The framework uses TypeScript discriminated unions for type-safe state handling. The <code>action</code> property serves as the discriminator, enabling exhaustive type checking at compile time.</p>
<table>
<thead>
<tr>
<th>State Type</th>
<th><code>action</code> Value</th>
<th>Signal Property</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>IStrategyTickResultIdle</code></td>
<td><code>&quot;idle&quot;</code></td>
<td><code>null</code></td>
<td>No active signal exists</td>
</tr>
<tr>
<td><code>IStrategyTickResultScheduled</code></td>
<td><code>&quot;scheduled&quot;</code></td>
<td><code>IScheduledSignalRow</code></td>
<td>Signal created, waiting for price activation</td>
</tr>
<tr>
<td><code>IStrategyTickResultOpened</code></td>
<td><code>&quot;opened&quot;</code></td>
<td><code>ISignalRow</code></td>
<td>Signal just opened (first tick after creation)</td>
</tr>
<tr>
<td><code>IStrategyTickResultActive</code></td>
<td><code>&quot;active&quot;</code></td>
<td><code>ISignalRow</code></td>
<td>Signal being monitored for TP/SL/time</td>
</tr>
<tr>
<td><code>IStrategyTickResultClosed</code></td>
<td><code>&quot;closed&quot;</code></td>
<td><code>ISignalRow</code></td>
<td>Signal completed with PNL calculation</td>
</tr>
<tr>
<td><code>IStrategyTickResultCancelled</code></td>
<td><code>&quot;cancelled&quot;</code></td>
<td><code>IScheduledSignalRow</code></td>
<td>Scheduled signal cancelled before activation</td>
</tr>
</tbody>
</table>
<p><strong>Union Type Definition</strong>:</p>
<pre><code class="typescript"><span class="hl-7">type</span><span class="hl-1"> </span><span class="hl-13">IStrategyTickResult</span><span class="hl-1"> = </span><br/><span class="hl-1">  | </span><span class="hl-13">IStrategyTickResultIdle</span><br/><span class="hl-1">  | </span><span class="hl-13">IStrategyTickResultScheduled</span><br/><span class="hl-1">  | </span><span class="hl-13">IStrategyTickResultOpened</span><br/><span class="hl-1">  | </span><span class="hl-13">IStrategyTickResultActive</span><br/><span class="hl-1">  | </span><span class="hl-13">IStrategyTickResultClosed</span><br/><span class="hl-1">  | </span><span class="hl-13">IStrategyTickResultCancelled</span><span class="hl-1">;</span>
</code><button type="button">Copy</button></pre>

<p><strong>Type Guard Pattern</strong>:</p>
<pre><code class="typescript"><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-4">result</span><span class="hl-1">.</span><span class="hl-4">action</span><span class="hl-1"> === </span><span class="hl-2">&quot;closed&quot;</span><span class="hl-1">) {</span><br/><span class="hl-1">  </span><span class="hl-5">// TypeScript knows result is IStrategyTickResultClosed</span><br/><span class="hl-1">  </span><span class="hl-4">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-4">result</span><span class="hl-1">.</span><span class="hl-4">closeReason</span><span class="hl-1">); </span><span class="hl-5">// &quot;take_profit&quot; | &quot;stop_loss&quot; | &quot;time_expired&quot;</span><br/><span class="hl-1">  </span><span class="hl-4">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-4">result</span><span class="hl-1">.</span><span class="hl-4">pnl</span><span class="hl-1">.</span><span class="hl-4">pnlPercentage</span><span class="hl-1">); </span><span class="hl-5">// Safe access</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<hr>
<a id="signal-data-structures" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Signal Data Structures<a href="#signal-data-structures" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><a id="signal-creation-flow" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Signal Creation Flow<a href="#signal-creation-flow" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><img src="../media/03-signal-lifecycle-and-state-machine_1.svg" alt="Mermaid Diagram"></p>
<a id="isignaldto-input" class="tsd-anchor"></a><h3 class="tsd-anchor-link">ISignalDto (Input)<a href="#isignaldto-input" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Data transfer object returned by <code>getSignal()</code> callback. Minimal structure provided by strategy developer.</p>
<table>
<thead>
<tr>
<th>Field</th>
<th>Type</th>
<th>Required</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>id</code></td>
<td><code>string</code></td>
<td>Optional</td>
<td>Auto-generated UUID if omitted</td>
</tr>
<tr>
<td><code>position</code></td>
<td><code>&quot;long&quot; | &quot;short&quot;</code></td>
<td>Yes</td>
<td>Trade direction</td>
</tr>
<tr>
<td><code>priceOpen</code></td>
<td><code>number</code></td>
<td>Optional</td>
<td>Entry price (if specified, becomes scheduled signal)</td>
</tr>
<tr>
<td><code>priceTakeProfit</code></td>
<td><code>number</code></td>
<td>Yes</td>
<td>Target exit price for profit</td>
</tr>
<tr>
<td><code>priceStopLoss</code></td>
<td><code>number</code></td>
<td>Yes</td>
<td>Exit price for loss protection</td>
</tr>
<tr>
<td><code>minuteEstimatedTime</code></td>
<td><code>number</code></td>
<td>Yes</td>
<td>Expected duration before time_expired</td>
</tr>
<tr>
<td><code>note</code></td>
<td><code>string</code></td>
<td>Optional</td>
<td>Human-readable signal description</td>
</tr>
</tbody>
</table>
<a id="isignalrow-active-signal" class="tsd-anchor"></a><h3 class="tsd-anchor-link">ISignalRow (Active Signal)<a href="#isignalrow-active-signal" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Complete signal structure after validation and augmentation. Used for immediate signals and activated scheduled signals.</p>
<table>
<thead>
<tr>
<th>Field</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>id</code></td>
<td><code>string</code></td>
<td>Unique UUID identifier</td>
</tr>
<tr>
<td><code>position</code></td>
<td><code>&quot;long&quot; | &quot;short&quot;</code></td>
<td>Trade direction</td>
</tr>
<tr>
<td><code>priceOpen</code></td>
<td><code>number</code></td>
<td>Actual entry price (required)</td>
</tr>
<tr>
<td><code>priceTakeProfit</code></td>
<td><code>number</code></td>
<td>Target profit exit</td>
</tr>
<tr>
<td><code>priceStopLoss</code></td>
<td><code>number</code></td>
<td>Stop loss exit</td>
</tr>
<tr>
<td><code>minuteEstimatedTime</code></td>
<td><code>number</code></td>
<td>Signal lifetime in minutes</td>
</tr>
<tr>
<td><code>symbol</code></td>
<td><code>string</code></td>
<td>Trading pair (e.g., &quot;BTCUSDT&quot;)</td>
</tr>
<tr>
<td><code>exchangeName</code></td>
<td><code>string</code></td>
<td>Exchange identifier</td>
</tr>
<tr>
<td><code>strategyName</code></td>
<td><code>string</code></td>
<td>Strategy identifier</td>
</tr>
<tr>
<td><code>scheduledAt</code></td>
<td><code>number</code></td>
<td>Creation timestamp (milliseconds)</td>
</tr>
<tr>
<td><code>pendingAt</code></td>
<td><code>number</code></td>
<td>Activation timestamp (milliseconds)</td>
</tr>
<tr>
<td><code>_isScheduled</code></td>
<td><code>boolean</code></td>
<td>Runtime marker (always <code>false</code> for active signals)</td>
</tr>
<tr>
<td><code>note</code></td>
<td><code>string</code></td>
<td>Optional description</td>
</tr>
</tbody>
</table>
<p><strong>Critical Timestamps</strong>:</p>
<ul>
<li><code>scheduledAt</code>: When signal was first created (never changes)</li>
<li><code>pendingAt</code>: When signal became active at <code>priceOpen</code> (may differ from <code>scheduledAt</code> for scheduled signals)</li>
</ul>
<a id="ischeduledsignalrow-waiting-for-activation" class="tsd-anchor"></a><h3 class="tsd-anchor-link">IScheduledSignalRow (Waiting for Activation)<a href="#ischeduledsignalrow-waiting-for-activation" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Extends <code>ISignalRow</code> for signals waiting for price to reach entry point. Identical structure but <code>_isScheduled</code> is <code>true</code>.</p>
<p><strong>Key Behaviors</strong>:</p>
<ul>
<li>Monitored for price activation conditions every tick</li>
<li>Subject to timeout via <code>CC_SCHEDULE_AWAIT_MINUTES</code> configuration</li>
<li>Can be cancelled if price hits <code>priceStopLoss</code> before <code>priceOpen</code> is reached</li>
<li><code>pendingAt</code> initially equals <code>scheduledAt</code>, updated upon activation</li>
</ul>
<hr>
<a id="state-transition-conditions" class="tsd-anchor"></a><h2 class="tsd-anchor-link">State Transition Conditions<a href="#state-transition-conditions" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><a id="idle-→-scheduled" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Idle → Scheduled<a href="#idle-→-scheduled" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><strong>Trigger</strong>: <code>getSignal()</code> returns <code>ISignalDto</code> with <code>priceOpen</code> specified, and current price hasn't reached entry point yet.</p>
<p><strong>Conditions</strong>:</p>
<ul>
<li>For LONG: <code>currentPrice &gt; priceOpen</code> (price needs to drop to enter)</li>
<li>For SHORT: <code>currentPrice &lt; priceOpen</code> (price needs to rise to enter)</li>
</ul>
<p><strong>Code Location</strong>: <a href="">src/client/ClientStrategy.ts:388-442</a></p>
<p><strong>Validation Steps</strong>:</p>
<ol>
<li>Check <code>priceOpen</code> is specified in DTO</li>
<li>Calculate activation condition based on position type</li>
<li>If not immediately activatable, create <code>IScheduledSignalRow</code></li>
<li>Call <code>VALIDATE_SIGNAL_FN</code> with <code>isScheduled=true</code></li>
</ol>
<hr>
<a id="idle-→-opened-immediate-entry" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Idle → Opened (Immediate Entry)<a href="#idle-→-opened-immediate-entry" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><strong>Trigger</strong>: <code>getSignal()</code> returns <code>ISignalDto</code> without <code>priceOpen</code>, OR with <code>priceOpen</code> already reached.</p>
<p><strong>Conditions</strong>:</p>
<ul>
<li><code>priceOpen</code> is undefined, OR</li>
<li>For LONG: <code>currentPrice &lt;= priceOpen</code></li>
<li>For SHORT: <code>currentPrice &gt;= priceOpen</code></li>
</ul>
<p><strong>Code Location</strong>: <a href="">src/client/ClientStrategy.ts:389-420</a>, <a href="">src/client/ClientStrategy.ts:444-461</a></p>
<p><strong>Risk Check</strong>: Must pass <code>Risk.checkSignal()</code> before opening (<a href="">src/client/ClientStrategy.ts:374-387</a>)</p>
<p><strong>Auto-Generated Values</strong>:</p>
<ul>
<li><code>priceOpen</code>: Set to <code>currentPrice</code> if omitted</li>
<li><code>scheduledAt</code>: Current timestamp</li>
<li><code>pendingAt</code>: Same as <code>scheduledAt</code> (immediate entry)</li>
<li><code>_isScheduled</code>: <code>false</code></li>
</ul>
<hr>
<a id="scheduled-→-opened-activation" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Scheduled → Opened (Activation)<a href="#scheduled-→-opened-activation" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><strong>Trigger</strong>: Price reaches entry point while scheduled signal is active.</p>
<p><strong>Conditions</strong>:</p>
<ul>
<li>For LONG: <code>currentPrice &lt;= scheduledSignal.priceOpen</code></li>
<li>For SHORT: <code>currentPrice &gt;= scheduledSignal.priceOpen</code></li>
<li>Must NOT have hit <code>priceStopLoss</code> first (checked with priority)</li>
</ul>
<p><strong>Code Location</strong>: <a href="">src/client/ClientStrategy.ts:610-644</a>, <a href="">src/client/ClientStrategy.ts:681-774</a></p>
<p><strong>Activation Flow</strong>:</p>
<p><img src="../media/03-signal-lifecycle-and-state-machine_2.svg" alt="Mermaid Diagram"></p>
<p><strong>Critical</strong>: <code>pendingAt</code> is updated to the actual activation timestamp, not kept at <code>scheduledAt</code>.</p>
<hr>
<a id="scheduled-→-cancelled-timeout-or-stoploss" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Scheduled → Cancelled (Timeout or StopLoss)<a href="#scheduled-→-cancelled-timeout-or-stoploss" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><strong>Trigger</strong>: Scheduled signal expires or price hits stop loss before entry.</p>
<p><strong>Timeout Condition</strong>:</p>
<ul>
<li><code>currentTime - scheduledAt &gt;= CC_SCHEDULE_AWAIT_MINUTES * 60 * 1000</code></li>
<li>Default: 90 minutes (<a href="">types.d.ts:10</a>)</li>
</ul>
<p><strong>Code Location</strong>: <a href="">src/client/ClientStrategy.ts:554-608</a></p>
<p><strong>StopLoss Cancellation</strong>:</p>
<ul>
<li>For LONG: <code>currentPrice &lt;= priceStopLoss</code></li>
<li>For SHORT: <code>currentPrice &gt;= priceStopLoss</code></li>
<li>Checked BEFORE activation check to prevent invalid entry</li>
</ul>
<p><strong>Code Location</strong>: <a href="">src/client/ClientStrategy.ts:610-644</a>, <a href="">src/client/ClientStrategy.ts:646-679</a></p>
<p><strong>Result</strong>: <code>IStrategyTickResultCancelled</code> emitted, signal removed from persistence.</p>
<hr>
<a id="opened-→-active" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Opened → Active<a href="#opened-→-active" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><strong>Trigger</strong>: Next tick after signal opening. Automatic transition.</p>
<p><strong>Purpose</strong>: Separates &quot;signal just created&quot; event from &quot;signal monitoring&quot; state for callback clarity.</p>
<p><strong>Code Location</strong>: Implicit in state machine - <code>opened</code> is only emitted once, subsequent ticks emit <code>active</code>.</p>
<hr>
<a id="active-→-closed" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Active → Closed<a href="#active-→-closed" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><strong>Three Close Conditions</strong> (checked in priority order):</p>
<a id="1-take-profit-hit" class="tsd-anchor"></a><h4 class="tsd-anchor-link">1. Take Profit Hit<a href="#1-take-profit-hit" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><p><strong>Condition</strong>:</p>
<ul>
<li>For LONG: <code>currentPrice &gt;= priceTakeProfit</code></li>
<li>For SHORT: <code>currentPrice &lt;= priceTakeProfit</code></li>
</ul>
<p><strong>Code Location</strong>: <a href="">src/client/ClientStrategy.ts:1141-1180</a>, <a href="">src/client/ClientStrategy.ts:1182-1221</a></p>
<p><strong>Close Reason</strong>: <code>&quot;take_profit&quot;</code></p>
<a id="2-stop-loss-hit" class="tsd-anchor"></a><h4 class="tsd-anchor-link">2. Stop Loss Hit<a href="#2-stop-loss-hit" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><p><strong>Condition</strong>:</p>
<ul>
<li>For LONG: <code>currentPrice &lt;= priceStopLoss</code></li>
<li>For SHORT: <code>currentPrice &gt;= priceStopLoss</code></li>
</ul>
<p><strong>Code Location</strong>: <a href="">src/client/ClientStrategy.ts:1223-1262</a>, <a href="">src/client/ClientStrategy.ts:1264-1303</a></p>
<p><strong>Close Reason</strong>: <code>&quot;stop_loss&quot;</code></p>
<a id="3-time-expiration" class="tsd-anchor"></a><h4 class="tsd-anchor-link">3. Time Expiration<a href="#3-time-expiration" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><p><strong>Condition</strong>:</p>
<ul>
<li><code>currentTime - pendingAt &gt;= minuteEstimatedTime * 60 * 1000</code></li>
</ul>
<p><strong>Code Location</strong>: <a href="">src/client/ClientStrategy.ts:1305-1342</a></p>
<p><strong>Close Reason</strong>: <code>&quot;time_expired&quot;</code></p>
<p><strong>Max Lifetime Protection</strong>: Signals cannot exceed <code>CC_MAX_SIGNAL_LIFETIME_MINUTES</code> (default: 1440 minutes = 1 day) to prevent risk limit deadlock (<a href="">types.d.ts:55-59</a>).</p>
<hr>
<a id="signal-validation-rules" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Signal Validation Rules<a href="#signal-validation-rules" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>Validation occurs via <code>VALIDATE_SIGNAL_FN</code> before signal creation or activation. Throws error if any check fails.</p>
<a id="price-relationship-validation" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Price Relationship Validation<a href="#price-relationship-validation" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><table>
<thead>
<tr>
<th>Position</th>
<th>Condition</th>
<th>Error if Violated</th>
</tr>
</thead>
<tbody>
<tr>
<td>LONG</td>
<td><code>priceTakeProfit &gt; priceOpen</code></td>
<td>TP must be above entry</td>
</tr>
<tr>
<td>LONG</td>
<td><code>priceStopLoss &lt; priceOpen</code></td>
<td>SL must be below entry</td>
</tr>
<tr>
<td>SHORT</td>
<td><code>priceTakeProfit &lt; priceOpen</code></td>
<td>TP must be below entry</td>
</tr>
<tr>
<td>SHORT</td>
<td><code>priceStopLoss &gt; priceOpen</code></td>
<td>SL must be above entry</td>
</tr>
</tbody>
</table>
<p><strong>Code Location</strong>: <a href="">src/client/ClientStrategy.ts:111-214</a></p>
<a id="economic-viability-checks" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Economic Viability Checks<a href="#economic-viability-checks" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><table>
<thead>
<tr>
<th>Check</th>
<th>Configuration</th>
<th>Default</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td>Min TP Distance</td>
<td><code>CC_MIN_TAKEPROFIT_DISTANCE_PERCENT</code></td>
<td>0.5%</td>
<td>Ensure TP covers fees + slippage</td>
</tr>
<tr>
<td>Min SL Distance</td>
<td><code>CC_MIN_STOPLOSS_DISTANCE_PERCENT</code></td>
<td>0.5%</td>
<td>Prevent instant stop-out on volatility</td>
</tr>
<tr>
<td>Max SL Distance</td>
<td><code>CC_MAX_STOPLOSS_DISTANCE_PERCENT</code></td>
<td>20%</td>
<td>Limit catastrophic losses</td>
</tr>
<tr>
<td>Max Lifetime</td>
<td><code>CC_MAX_SIGNAL_LIFETIME_MINUTES</code></td>
<td>1440 min</td>
<td>Prevent eternal signals blocking risk limits</td>
</tr>
</tbody>
</table>
<p><strong>Code Location</strong>: <a href="">src/client/ClientStrategy.ts:163-316</a></p>
<p><strong>TP Distance Calculation</strong> (LONG example):</p>
<pre><code><span class="hl-4">tpDistancePercent</span><span class="hl-1"> = ((</span><span class="hl-4">priceTakeProfit</span><span class="hl-1"> - </span><span class="hl-4">priceOpen</span><span class="hl-1">) / </span><span class="hl-4">priceOpen</span><span class="hl-1">) * </span><span class="hl-6">100</span>
</code><button>Copy</button></pre>

<p>Must be &gt;= 0.5% to cover:</p>
<ul>
<li>Entry slippage: ~0.1%</li>
<li>Entry fee: 0.1%</li>
<li>Exit slippage: ~0.1%</li>
<li>Exit fee: 0.1%</li>
<li>Minimum profit buffer: 0.1%</li>
</ul>
<a id="immediate-close-prevention" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Immediate Close Prevention<a href="#immediate-close-prevention" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Prevents signals that would close instantly upon creation.</p>
<table>
<thead>
<tr>
<th>Scenario</th>
<th>Check</th>
<th>Error Message</th>
</tr>
</thead>
<tbody>
<tr>
<td>LONG Immediate</td>
<td><code>currentPrice &lt;= priceStopLoss</code></td>
<td>&quot;Signal would be immediately closed by stop loss&quot;</td>
</tr>
<tr>
<td>LONG Immediate</td>
<td><code>currentPrice &gt;= priceTakeProfit</code></td>
<td>&quot;Signal would be immediately closed by take profit&quot;</td>
</tr>
<tr>
<td>SHORT Immediate</td>
<td><code>currentPrice &gt;= priceStopLoss</code></td>
<td>&quot;Signal would be immediately closed by stop loss&quot;</td>
</tr>
<tr>
<td>SHORT Immediate</td>
<td><code>currentPrice &lt;= priceTakeProfit</code></td>
<td>&quot;Signal would be immediately closed by take profit&quot;</td>
</tr>
<tr>
<td>LONG Scheduled</td>
<td><code>priceOpen &lt;= priceStopLoss</code></td>
<td>&quot;Signal would be immediately cancelled on activation&quot;</td>
</tr>
<tr>
<td>LONG Scheduled</td>
<td><code>priceOpen &gt;= priceTakeProfit</code></td>
<td>&quot;This is logically impossible for LONG position&quot;</td>
</tr>
<tr>
<td>SHORT Scheduled</td>
<td><code>priceOpen &gt;= priceStopLoss</code></td>
<td>&quot;Signal would be immediately cancelled on activation&quot;</td>
</tr>
<tr>
<td>SHORT Scheduled</td>
<td><code>priceOpen &lt;= priceTakeProfit</code></td>
<td>&quot;This is logically impossible for SHORT position&quot;</td>
</tr>
</tbody>
</table>
<p><strong>Code Location</strong>: <a href="">src/client/ClientStrategy.ts:124-251</a></p>
<hr>
<a id="pnl-calculation" class="tsd-anchor"></a><h2 class="tsd-anchor-link">PNL Calculation<a href="#pnl-calculation" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>Profit and loss calculation includes realistic trading costs via <code>toProfitLossDto</code> helper.</p>
<a id="cost-modeling" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Cost Modeling<a href="#cost-modeling" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><table>
<thead>
<tr>
<th>Cost Component</th>
<th>Configuration</th>
<th>Default</th>
<th>Applied When</th>
</tr>
</thead>
<tbody>
<tr>
<td>Slippage</td>
<td><code>CC_PERCENT_SLIPPAGE</code></td>
<td>0.1%</td>
<td>Entry and Exit (2x)</td>
</tr>
<tr>
<td>Fees</td>
<td><code>CC_PERCENT_FEE</code></td>
<td>0.1%</td>
<td>Entry and Exit (2x)</td>
</tr>
</tbody>
</table>
<p><strong>Total Trading Costs</strong>: ~0.4% per round trip</p>
<p><strong>Adjusted Price Calculation</strong>:</p>
<pre><code class="typescript"><span class="hl-5">// LONG Position</span><br/><span class="hl-4">priceOpenAdjusted</span><span class="hl-1"> = </span><span class="hl-4">priceOpen</span><span class="hl-1"> * (</span><span class="hl-6">1</span><span class="hl-1"> + </span><span class="hl-4">slippage</span><span class="hl-1"> + </span><span class="hl-4">fee</span><span class="hl-1">)  </span><span class="hl-5">// Pay more to enter</span><br/><span class="hl-4">priceCloseAdjusted</span><span class="hl-1"> = </span><span class="hl-4">priceClose</span><span class="hl-1"> * (</span><span class="hl-6">1</span><span class="hl-1"> - </span><span class="hl-4">slippage</span><span class="hl-1"> - </span><span class="hl-4">fee</span><span class="hl-1">) </span><span class="hl-5">// Receive less on exit</span><br/><br/><span class="hl-5">// SHORT Position  </span><br/><span class="hl-4">priceOpenAdjusted</span><span class="hl-1"> = </span><span class="hl-4">priceOpen</span><span class="hl-1"> * (</span><span class="hl-6">1</span><span class="hl-1"> - </span><span class="hl-4">slippage</span><span class="hl-1"> - </span><span class="hl-4">fee</span><span class="hl-1">)  </span><span class="hl-5">// Receive less to enter</span><br/><span class="hl-4">priceCloseAdjusted</span><span class="hl-1"> = </span><span class="hl-4">priceClose</span><span class="hl-1"> * (</span><span class="hl-6">1</span><span class="hl-1"> + </span><span class="hl-4">slippage</span><span class="hl-1"> + </span><span class="hl-4">fee</span><span class="hl-1">) </span><span class="hl-5">// Pay more on exit</span>
</code><button type="button">Copy</button></pre>

<p><strong>PNL Percentage Formula</strong>:</p>
<pre><code class="typescript"><span class="hl-5">// LONG</span><br/><span class="hl-4">pnlPercentage</span><span class="hl-1"> = ((</span><span class="hl-4">priceCloseAdjusted</span><span class="hl-1"> - </span><span class="hl-4">priceOpenAdjusted</span><span class="hl-1">) / </span><span class="hl-4">priceOpenAdjusted</span><span class="hl-1">) * </span><span class="hl-6">100</span><br/><br/><span class="hl-5">// SHORT</span><br/><span class="hl-4">pnlPercentage</span><span class="hl-1"> = ((</span><span class="hl-4">priceOpenAdjusted</span><span class="hl-1"> - </span><span class="hl-4">priceCloseAdjusted</span><span class="hl-1">) / </span><span class="hl-4">priceOpenAdjusted</span><span class="hl-1">) * </span><span class="hl-6">100</span>
</code><button type="button">Copy</button></pre>

<p><strong>Code Location</strong>: <a href="">src/helpers/toProfitLossDto.ts</a></p>
<hr>
<a id="persistence-and-crash-recovery" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Persistence and Crash Recovery<a href="#persistence-and-crash-recovery" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>The framework implements crash-safe state persistence via atomic file writes, enabling live trading processes to recover from crashes without position loss.</p>
<a id="persistence-adapters" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Persistence Adapters<a href="#persistence-adapters" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><table>
<thead>
<tr>
<th>Adapter</th>
<th>File Location</th>
<th>Stored Data</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>PersistSignalAdapter</code></td>
<td><code>./dump/signal/{symbol}_{strategyName}.json</code></td>
<td>Active <code>ISignalRow</code></td>
<td>Restore active positions</td>
</tr>
<tr>
<td><code>PersistScheduleAdapter</code></td>
<td><code>./dump/schedule/{symbol}_{strategyName}.json</code></td>
<td>Scheduled <code>IScheduledSignalRow</code></td>
<td>Restore waiting signals</td>
</tr>
</tbody>
</table>
<p><strong>Atomic Write Pattern</strong>:</p>
<ol>
<li>Write to temporary file (<code>{filename}.tmp</code>)</li>
<li>Rename to target file (atomic operation)</li>
<li>Prevents partial writes on crash</li>
</ol>
<p><strong>Code Location</strong>: <a href="">src/classes/Persist.ts</a></p>
<a id="recovery-flow-live-mode" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Recovery Flow (Live Mode)<a href="#recovery-flow-live-mode" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><img src="../media/03-signal-lifecycle-and-state-machine_3.svg" alt="Mermaid Diagram"></p>
<p><strong>Code Location</strong>: <a href="">src/client/ClientStrategy.ts:491-552</a></p>
<p><strong>Key Points</strong>:</p>
<ul>
<li>Only runs in live mode (<code>backtest=false</code>)</li>
<li>Restores both active and scheduled signals</li>
<li>Validates <code>exchangeName</code> and <code>strategyName</code> match</li>
<li>Calls appropriate lifecycle callbacks (<code>onActive</code>, <code>onSchedule</code>) after restoration</li>
</ul>
<hr>
<a id="lifecycle-callbacks" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Lifecycle Callbacks<a href="#lifecycle-callbacks" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>Strategies can register optional callbacks to observe state transitions. All callbacks receive <code>backtest</code> flag to distinguish execution mode.</p>
<a id="callback-invocation-points" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Callback Invocation Points<a href="#callback-invocation-points" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><table>
<thead>
<tr>
<th>Callback</th>
<th>When Invoked</th>
<th>Parameters</th>
<th>State</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>onTick</code></td>
<td>Every tick (all states)</td>
<td><code>symbol</code>, <code>result</code>, <code>backtest</code></td>
<td>All</td>
</tr>
<tr>
<td><code>onIdle</code></td>
<td>No active signal</td>
<td><code>symbol</code>, <code>currentPrice</code>, <code>backtest</code></td>
<td>Idle</td>
</tr>
<tr>
<td><code>onSchedule</code></td>
<td>Scheduled signal created</td>
<td><code>symbol</code>, <code>data: IScheduledSignalRow</code>, <code>currentPrice</code>, <code>backtest</code></td>
<td>Scheduled</td>
</tr>
<tr>
<td><code>onOpen</code></td>
<td>Signal opened/activated</td>
<td><code>symbol</code>, <code>data: ISignalRow</code>, <code>currentPrice</code>, <code>backtest</code></td>
<td>Opened</td>
</tr>
<tr>
<td><code>onActive</code></td>
<td>Signal being monitored</td>
<td><code>symbol</code>, <code>data: ISignalRow</code>, <code>currentPrice</code>, <code>backtest</code></td>
<td>Active</td>
</tr>
<tr>
<td><code>onPartialProfit</code></td>
<td>Profit milestone reached</td>
<td><code>symbol</code>, <code>data: ISignalRow</code>, <code>currentPrice</code>, <code>revenuePercent</code>, <code>backtest</code></td>
<td>Active</td>
</tr>
<tr>
<td><code>onPartialLoss</code></td>
<td>Loss milestone reached</td>
<td><code>symbol</code>, <code>data: ISignalRow</code>, <code>currentPrice</code>, <code>lossPercent</code>, <code>backtest</code></td>
<td>Active</td>
</tr>
<tr>
<td><code>onClose</code></td>
<td>Signal closed</td>
<td><code>symbol</code>, <code>data: ISignalRow</code>, <code>priceClose</code>, <code>backtest</code></td>
<td>Closed</td>
</tr>
<tr>
<td><code>onCancel</code></td>
<td>Scheduled signal cancelled</td>
<td><code>symbol</code>, <code>data: IScheduledSignalRow</code>, <code>currentPrice</code>, <code>backtest</code></td>
<td>Cancelled</td>
</tr>
<tr>
<td><code>onWrite</code></td>
<td>State persisted (testing)</td>
<td><code>symbol</code>, <code>data: ISignalRow | null</code>, <code>backtest</code></td>
<td>Any</td>
</tr>
</tbody>
</table>
<p><strong>Code Locations</strong>:</p>
<ul>
<li>Callback interface: <a href="">src/interfaces/Strategy.interface.ts:96-126</a></li>
<li>Invocation points: <a href="">src/client/ClientStrategy.ts</a> (various locations)</li>
</ul>
<p><strong>onTick Universality</strong>: <code>onTick</code> is called for EVERY state transition, receiving the full <code>IStrategyTickResult</code>. Other callbacks are supplementary and state-specific.</p>
<hr>
<a id="event-emissions" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Event Emissions<a href="#event-emissions" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>Beyond callbacks, the framework emits events via global <code>Subject</code> instances for cross-cutting concerns like reporting and monitoring.</p>
<a id="signal-event-emitters" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Signal Event Emitters<a href="#signal-event-emitters" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><table>
<thead>
<tr>
<th>Emitter</th>
<th>Emits</th>
<th>Scope</th>
<th>Listener Functions</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>signalEmitter</code></td>
<td>All <code>IStrategyTickResult</code></td>
<td>Both backtest and live</td>
<td><code>listenSignal()</code>, <code>listenSignalOnce()</code></td>
</tr>
<tr>
<td><code>signalBacktestEmitter</code></td>
<td>Backtest results only</td>
<td>Backtest mode</td>
<td><code>listenSignalBacktest()</code>, <code>listenSignalBacktestOnce()</code></td>
</tr>
<tr>
<td><code>signalLiveEmitter</code></td>
<td>Live results only</td>
<td>Live mode</td>
<td><code>listenSignalLive()</code>, <code>listenSignalLiveOnce()</code></td>
</tr>
</tbody>
</table>
<p><strong>Emission Points</strong>:</p>
<ul>
<li>After every <code>tick()</code> call: <a href="">src/lib/services/connection/StrategyConnectionService.ts:218-227</a></li>
<li>After every <code>backtest()</code> call: <a href="">src/lib/services/connection/StrategyConnectionService.ts:254-259</a></li>
</ul>
<p><strong>Queued Processing</strong>: All listener functions use <code>queued()</code> wrapper from functools-kit to ensure sequential async execution, preventing race conditions.</p>
<p><strong>Code Location</strong>: <a href="">src/config/emitters.ts:15-31</a>, <a href="">src/function/event.ts:70-221</a></p>
<hr>
<a id="backtest-fast-path-optimization" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Backtest Fast-Path Optimization<a href="#backtest-fast-path-optimization" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>In backtest mode, signals use a fast-path through historical candles to avoid tick-by-tick processing.</p>
<a id="backtest-method-flow" class="tsd-anchor"></a><h3 class="tsd-anchor-link">backtest() Method Flow<a href="#backtest-method-flow" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><img src="../media/03-signal-lifecycle-and-state-machine_4.svg" alt="Mermaid Diagram"></p>
<p><strong>Key Optimizations</strong>:</p>
<ol>
<li><strong>Skip Individual Ticks</strong>: Processes array of candles directly instead of tick-by-tick</li>
<li><strong>VWAP Per Candle</strong>: Calculates typical price <code>(high + low + close) / 3</code> weighted by volume</li>
<li><strong>Early Exit</strong>: Stops iterating once close condition met</li>
<li><strong>No Persistence</strong>: Backtest mode doesn't write to disk (stateless)</li>
</ol>
<p><strong>Code Location</strong>: <a href="">src/client/ClientStrategy.ts:1008-1139</a></p>
<p><strong>VWAP Calculation</strong>: <a href="">src/client/ClientStrategy.ts:478-489</a></p>
<hr>
<a id="runtime-state-management" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Runtime State Management<a href="#runtime-state-management" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>The <code>ClientStrategy</code> class maintains internal state via private properties.</p>
<a id="state-properties" class="tsd-anchor"></a><h3 class="tsd-anchor-link">State Properties<a href="#state-properties" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><table>
<thead>
<tr>
<th>Property</th>
<th>Type</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>_pendingSignal</code></td>
<td><code>ISignalRow | null</code></td>
<td>Currently active signal being monitored</td>
</tr>
<tr>
<td><code>_scheduledSignal</code></td>
<td><code>IScheduledSignalRow | null</code></td>
<td>Scheduled signal waiting for activation</td>
</tr>
<tr>
<td><code>_lastSignalTimestamp</code></td>
<td><code>number | null</code></td>
<td>Last <code>getSignal()</code> invocation time (for throttling)</td>
</tr>
<tr>
<td><code>_isStopped</code></td>
<td><code>boolean</code></td>
<td>Stop flag for graceful shutdown</td>
</tr>
</tbody>
</table>
<p><strong>Mutual Exclusivity</strong>: A strategy can have EITHER <code>_pendingSignal</code> OR <code>_scheduledSignal</code> active, never both simultaneously.</p>
<p><strong>Code Location</strong>: <a href="">src/client/ClientStrategy.ts</a> (class properties)</p>
<a id="state-setter-methods" class="tsd-anchor"></a><h3 class="tsd-anchor-link">State Setter Methods<a href="#state-setter-methods" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><table>
<thead>
<tr>
<th>Method</th>
<th>Purpose</th>
<th>Side Effects</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>setPendingSignal(signal)</code></td>
<td>Set active signal</td>
<td>Writes to <code>PersistSignalAdapter</code> (live mode only)</td>
</tr>
<tr>
<td><code>setScheduledSignal(signal)</code></td>
<td>Set scheduled signal</td>
<td>Writes to <code>PersistScheduleAdapter</code> (live mode only)</td>
</tr>
<tr>
<td><code>waitForInit()</code></td>
<td>Load persisted state</td>
<td>Reads from both adapters, restores state, calls callbacks</td>
</tr>
<tr>
<td><code>stop()</code></td>
<td>Set stop flag</td>
<td>Sets <code>_isStopped = true</code></td>
</tr>
</tbody>
</table>
<p><strong>Persistence Conditional</strong>: State writes only occur in live mode (<code>backtest=false</code>). Backtest mode keeps state in memory only.</p>
<p><strong>Code Location</strong>: <a href="">src/client/ClientStrategy.ts</a> (various methods)</p>
<hr>
<a id="summary-table-state-transitions" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Summary Table: State Transitions<a href="#summary-table-state-transitions" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><table>
<thead>
<tr>
<th>From State</th>
<th>To State</th>
<th>Trigger</th>
<th>Validation</th>
<th>Result Type</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>idle</code></td>
<td><code>idle</code></td>
<td><code>getSignal()</code> returns <code>null</code></td>
<td>N/A</td>
<td><code>IStrategyTickResultIdle</code></td>
</tr>
<tr>
<td><code>idle</code></td>
<td><code>scheduled</code></td>
<td><code>getSignal()</code> returns DTO with <code>priceOpen</code> not reached</td>
<td>Signal + Risk</td>
<td><code>IStrategyTickResultScheduled</code></td>
</tr>
<tr>
<td><code>idle</code></td>
<td><code>opened</code></td>
<td><code>getSignal()</code> returns DTO, immediate entry</td>
<td>Signal + Risk</td>
<td><code>IStrategyTickResultOpened</code></td>
</tr>
<tr>
<td><code>scheduled</code></td>
<td><code>scheduled</code></td>
<td>Price hasn't reached <code>priceOpen</code></td>
<td>N/A</td>
<td><code>IStrategyTickResultActive</code> (monitoring)</td>
</tr>
<tr>
<td><code>scheduled</code></td>
<td><code>opened</code></td>
<td>Price reaches <code>priceOpen</code></td>
<td>Risk re-check</td>
<td><code>IStrategyTickResultOpened</code></td>
</tr>
<tr>
<td><code>scheduled</code></td>
<td><code>cancelled</code></td>
<td>Timeout OR StopLoss before entry</td>
<td>N/A</td>
<td><code>IStrategyTickResultCancelled</code></td>
</tr>
<tr>
<td><code>scheduled</code></td>
<td><code>idle</code></td>
<td>Risk check fails on activation</td>
<td>N/A</td>
<td><code>IStrategyTickResultIdle</code></td>
</tr>
<tr>
<td><code>opened</code></td>
<td><code>active</code></td>
<td>Next tick</td>
<td>N/A</td>
<td><code>IStrategyTickResultActive</code></td>
</tr>
<tr>
<td><code>active</code></td>
<td><code>active</code></td>
<td>No close condition met</td>
<td>N/A</td>
<td><code>IStrategyTickResultActive</code></td>
</tr>
<tr>
<td><code>active</code></td>
<td><code>closed</code></td>
<td>TP hit</td>
<td>N/A</td>
<td><code>IStrategyTickResultClosed</code> (<code>take_profit</code>)</td>
</tr>
<tr>
<td><code>active</code></td>
<td><code>closed</code></td>
<td>SL hit</td>
<td>N/A</td>
<td><code>IStrategyTickResultClosed</code> (<code>stop_loss</code>)</td>
</tr>
<tr>
<td><code>active</code></td>
<td><code>closed</code></td>
<td>Time expired</td>
<td>N/A</td>
<td><code>IStrategyTickResultClosed</code> (<code>time_expired</code>)</td>
</tr>
</tbody>
</table>
</div></div><div class="col-sidebar"><div class="page-menu"><div class="tsd-navigation settings"><details class="tsd-accordion"><summary class="tsd-accordion-summary"><h3><svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-chevronDown"></use></svg>Settings</h3></summary><div class="tsd-accordion-details"><div class="tsd-filter-visibility"><span class="settings-label">Member Visibility</span><ul id="tsd-filter-options"><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-protected" name="protected"/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Protected</span></label></li><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-inherited" name="inherited" checked/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Inherited</span></label></li><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-external" name="external"/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>External</span></label></li></ul></div><div class="tsd-theme-toggle"><label class="settings-label" for="tsd-theme">Theme</label><select id="tsd-theme"><option value="os">OS</option><option value="light">Light</option><option value="dark">Dark</option></select></div></div></details></div><details open class="tsd-accordion tsd-page-navigation"><summary class="tsd-accordion-summary"><h3><svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-chevronDown"></use></svg>On This Page</h3></summary><div class="tsd-accordion-details"><a href="#signal-lifecycle-and-state-machine"><span>Signal <wbr/>Lifecycle and <wbr/>State <wbr/>Machine</span></a><ul><li><a href="#purpose-and-scope"><span>Purpose and <wbr/>Scope</span></a></li><li><a href="#signal-state-machine-overview"><span>Signal <wbr/>State <wbr/>Machine <wbr/>Overview</span></a></li><li><a href="#discriminated-union-type-system"><span>Discriminated <wbr/>Union <wbr/>Type <wbr/>System</span></a></li><li><a href="#signal-data-structures"><span>Signal <wbr/>Data <wbr/>Structures</span></a></li><li><ul><li><a href="#signal-creation-flow"><span>Signal <wbr/>Creation <wbr/>Flow</span></a></li><li><a href="#isignaldto-input"><span>ISignal<wbr/>Dto (<wbr/>Input)</span></a></li><li><a href="#isignalrow-active-signal"><span>ISignal<wbr/>Row (<wbr/>Active <wbr/>Signal)</span></a></li><li><a href="#ischeduledsignalrow-waiting-for-activation"><span>IScheduled<wbr/>Signal<wbr/>Row (<wbr/>Waiting for <wbr/>Activation)</span></a></li></ul></li><li><a href="#state-transition-conditions"><span>State <wbr/>Transition <wbr/>Conditions</span></a></li><li><ul><li><a href="#idle-→-scheduled"><span>Idle → <wbr/>Scheduled</span></a></li><li><a href="#idle-→-opened-immediate-entry"><span>Idle → <wbr/>Opened (<wbr/>Immediate <wbr/>Entry)</span></a></li><li><a href="#scheduled-→-opened-activation"><span>Scheduled → <wbr/>Opened (<wbr/>Activation)</span></a></li><li><a href="#scheduled-→-cancelled-timeout-or-stoploss"><span>Scheduled → <wbr/>Cancelled (<wbr/>Timeout or <wbr/>Stop<wbr/>Loss)</span></a></li><li><a href="#opened-→-active"><span>Opened → <wbr/>Active</span></a></li><li><a href="#active-→-closed"><span>Active → <wbr/>Closed</span></a></li><li><ul><li><a href="#1-take-profit-hit"><span>1. <wbr/>Take <wbr/>Profit <wbr/>Hit</span></a></li><li><a href="#2-stop-loss-hit"><span>2. <wbr/>Stop <wbr/>Loss <wbr/>Hit</span></a></li><li><a href="#3-time-expiration"><span>3. <wbr/>Time <wbr/>Expiration</span></a></li></ul></li></ul></li><li><a href="#signal-validation-rules"><span>Signal <wbr/>Validation <wbr/>Rules</span></a></li><li><ul><li><a href="#price-relationship-validation"><span>Price <wbr/>Relationship <wbr/>Validation</span></a></li><li><a href="#economic-viability-checks"><span>Economic <wbr/>Viability <wbr/>Checks</span></a></li><li><a href="#immediate-close-prevention"><span>Immediate <wbr/>Close <wbr/>Prevention</span></a></li></ul></li><li><a href="#pnl-calculation"><span>PNL <wbr/>Calculation</span></a></li><li><ul><li><a href="#cost-modeling"><span>Cost <wbr/>Modeling</span></a></li></ul></li><li><a href="#persistence-and-crash-recovery"><span>Persistence and <wbr/>Crash <wbr/>Recovery</span></a></li><li><ul><li><a href="#persistence-adapters"><span>Persistence <wbr/>Adapters</span></a></li><li><a href="#recovery-flow-live-mode"><span>Recovery <wbr/>Flow (<wbr/>Live <wbr/>Mode)</span></a></li></ul></li><li><a href="#lifecycle-callbacks"><span>Lifecycle <wbr/>Callbacks</span></a></li><li><ul><li><a href="#callback-invocation-points"><span>Callback <wbr/>Invocation <wbr/>Points</span></a></li></ul></li><li><a href="#event-emissions"><span>Event <wbr/>Emissions</span></a></li><li><ul><li><a href="#signal-event-emitters"><span>Signal <wbr/>Event <wbr/>Emitters</span></a></li></ul></li><li><a href="#backtest-fast-path-optimization"><span>Backtest <wbr/>Fast-<wbr/>Path <wbr/>Optimization</span></a></li><li><ul><li><a href="#backtest-method-flow"><span>backtest() <wbr/>Method <wbr/>Flow</span></a></li></ul></li><li><a href="#runtime-state-management"><span>Runtime <wbr/>State <wbr/>Management</span></a></li><li><ul><li><a href="#state-properties"><span>State <wbr/>Properties</span></a></li><li><a href="#state-setter-methods"><span>State <wbr/>Setter <wbr/>Methods</span></a></li></ul></li><li><a href="#summary-table-state-transitions"><span>Summary <wbr/>Table: <wbr/>State <wbr/>Transitions</span></a></li></ul></div></details></div><div class="site-menu"><nav class="tsd-navigation"><a href="../modules.html">backtest-kit</a><ul class="tsd-small-nested-navigation" id="tsd-nav-container"><li>Loading...</li></ul></nav></div></div></div><footer><p class="tsd-generator">Generated using <a href="https://typedoc.org/" target="_blank">TypeDoc</a></p></footer><div class="overlay"></div></body></html>

<!-- Yandex.Metrika counter -->
<script type="text/javascript">
    (function(m,e,t,r,i,k,a){
        m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
        m[i].l=1*new Date();
        for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }}
        k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)
    })(window, document,'script','https://mc.yandex.ru/metrika/tag.js?id=105455585', 'ym');

    ym(105455585, 'init', {ssr:true, webvisor:true, clickmap:true, ecommerce:"dataLayer", accurateTrackBounce:true, trackLinks:true});
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/105455585" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
<!-- /Yandex.Metrika counter -->

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-3MQZEBBDDR"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-3MQZEBBDDR');
</script>
