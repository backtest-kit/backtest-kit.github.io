<!DOCTYPE html><html class="default" lang="en" data-base=".."><head><meta charset="utf-8"/><meta http-equiv="x-ua-compatible" content="IE=edge"/><title>design/10_client-layer | backtest-kit</title><meta name="description" content="Documentation for backtest-kit"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="stylesheet" href="../assets/style.css"/><link rel="stylesheet" href="../assets/highlight.css"/><script defer src="../assets/main.js"></script><script async src="../assets/icons.js" id="tsd-icons-script"></script><script async src="../assets/search.js" id="tsd-search-script"></script><script async src="../assets/navigation.js" id="tsd-nav-script"></script><script async src="../assets/hierarchy.js" id="tsd-hierarchy-script"></script></head><body><script>document.documentElement.dataset.theme = localStorage.getItem("tsd-theme") || "os";document.body.style.display="none";setTimeout(() => app?app.showPage():document.body.style.removeProperty("display"),500)</script><header class="tsd-page-toolbar"><div class="tsd-toolbar-contents container"><div class="table-cell" id="tsd-search"><div class="field"><label for="tsd-search-field" class="tsd-widget tsd-toolbar-icon search no-caption"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-search"></use></svg></label><input type="text" id="tsd-search-field" aria-label="Search"/></div><div class="field"><div id="tsd-toolbar-links"></div></div><ul class="results"><li class="state loading">Preparing search index...</li><li class="state failure">The search index is not available</li></ul><a href="../index.html" class="title">backtest-kit</a></div><div class="table-cell" id="tsd-widgets"><a href="#" class="tsd-widget tsd-toolbar-icon menu no-caption" data-toggle="menu" aria-label="Menu"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-menu"></use></svg></a></div></div></header><div class="container container-main"><div class="col-content"><div class="tsd-page-title"><ul class="tsd-breadcrumb"><li><a href="../modules.html">backtest-kit</a></li><li><a href="design_10_client-layer.html">design/10_client-layer</a></li></ul></div><div class="tsd-panel tsd-typography"><a id="client-layer" class="tsd-anchor"></a><h1 class="tsd-anchor-link">Client Layer<a href="#client-layer" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h1><a id="purpose-and-scope" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Purpose and Scope<a href="#purpose-and-scope" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>The Client Layer contains the six core business logic implementations that execute domain operations. These clients are instantiated and managed by ConnectionServices in the Service Layer (see <a href="design_09_service-categories.html">Service Categories</a>) and consume configuration from Schema services. Each client encapsulates a specific domain responsibility: strategy execution, exchange data access, timeframe generation, risk validation, optimizer orchestration, and partial profit/loss tracking.</p>
<p>For information about how these clients are orchestrated in different execution modes, see <a href="design_04_execution-modes-overview.html">Execution Modes Overview</a>. For details on the service architecture that manages client instantiation, see <a href="design_08_dependency-injection-system.html">Dependency Injection System</a>.</p>
<hr>
<a id="architecture-overview" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Architecture Overview<a href="#architecture-overview" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>The Client Layer implements the business logic for six distinct domains. Each client is instantiated by its corresponding ConnectionService, which applies memoization for performance optimization. Clients receive dependencies through constructor injection and access execution context via scoped services.</p>
<a id="client-layer-structure" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Client Layer Structure<a href="#client-layer-structure" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><img src="../media/10-client-layer_0.svg" alt="Mermaid Diagram"></p>
<a id="memoization-pattern" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Memoization Pattern<a href="#memoization-pattern" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>All ConnectionServices use <code>memoize</code> from <code>functools-kit</code> to cache client instances. The cache keys are constructed from schema names (e.g., <code>symbol:strategyName</code> for ClientStrategy, <code>exchangeName</code> for ClientExchange). This pattern optimizes resource usage by ensuring only one client instance exists per unique configuration.</p>
<table>
<thead>
<tr>
<th>ConnectionService</th>
<th>Cache Key Pattern</th>
<th>Instantiated Class</th>
</tr>
</thead>
<tbody>
<tr>
<td>StrategyConnectionService</td>
<td><code>${symbol}:${strategyName}</code></td>
<td>ClientStrategy</td>
</tr>
<tr>
<td>ExchangeConnectionService</td>
<td><code>${exchangeName}</code></td>
<td>ClientExchange</td>
</tr>
<tr>
<td>FrameConnectionService</td>
<td><code>${frameName}</code></td>
<td>ClientFrame</td>
</tr>
<tr>
<td>RiskConnectionService</td>
<td><code>${riskName}</code></td>
<td>ClientRisk</td>
</tr>
<tr>
<td>OptimizerConnectionService</td>
<td><code>${optimizerName}</code></td>
<td>ClientOptimizer</td>
</tr>
<tr>
<td>PartialConnectionService</td>
<td><code>${symbol}</code></td>
<td>ClientPartial</td>
</tr>
</tbody>
</table>
<hr>
<a id="clientstrategy" class="tsd-anchor"></a><h2 class="tsd-anchor-link">ClientStrategy<a href="#clientstrategy" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>ClientStrategy implements the <code>IStrategy</code> interface and manages the complete signal lifecycle from generation through monitoring to closure. It handles both immediate and scheduled signals, integrates with risk management, and supports both live trading (via <code>tick()</code>) and fast backtesting (via <code>backtest()</code>).</p>
<a id="signal-lifecycle-state-machine" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Signal Lifecycle State Machine<a href="#signal-lifecycle-state-machine" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><img src="../media/10-client-layer_1.svg" alt="Mermaid Diagram"></p>
<a id="key-methods" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Key Methods<a href="#key-methods" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><a id="tick" class="tsd-anchor"></a><h4 class="tsd-anchor-link">tick()<a href="#tick" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><p>Executes a single strategy iteration with VWAP monitoring. This method:</p>
<ol>
<li>Checks for scheduled signal timeout (<a href="">src/client/ClientStrategy.ts:554-608</a>)</li>
<li>Checks for scheduled signal activation (<a href="">src/client/ClientStrategy.ts:610-644</a>)</li>
<li>Monitors active signal TP/SL/time expiration</li>
<li>Calls <code>getSignal()</code> with interval throttling (<a href="">src/client/ClientStrategy.ts:332-476</a>)</li>
<li>Validates signals via <code>VALIDATE_SIGNAL_FN</code> (<a href="">src/client/ClientStrategy.ts:45-330</a>)</li>
<li>Persists state changes via <code>PersistSignalAdapter</code> and <code>PersistScheduleAdapter</code></li>
</ol>
<p>Returns discriminated union <code>IStrategyTickResult</code> with action: <code>&quot;idle&quot; | &quot;scheduled&quot; | &quot;opened&quot; | &quot;active&quot; | &quot;closed&quot; | &quot;cancelled&quot;</code>.</p>
<a id="backtest" class="tsd-anchor"></a><h4 class="tsd-anchor-link">backtest()<a href="#backtest" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><p>Performs fast historical simulation by iterating through candle data. For each candle:</p>
<ol>
<li>Calculates VWAP using <code>GET_AVG_PRICE_FN</code> (<a href="">src/client/ClientStrategy.ts:478-489</a>)</li>
<li>For scheduled signals: checks activation/cancellation conditions</li>
<li>For active signals: checks if TP/SL/time conditions met</li>
<li>Returns immediately upon closure (optimization: skips remaining candles)</li>
</ol>
<p>Returns <code>IStrategyBacktestResult</code> (always <code>&quot;closed&quot;</code> or <code>&quot;cancelled&quot;</code>), never <code>&quot;idle&quot;</code> or <code>&quot;active&quot;</code>.</p>
<a id="scheduled-signal-handling" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Scheduled Signal Handling<a href="#scheduled-signal-handling" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>ClientStrategy supports delayed entry signals where <code>priceOpen</code> is specified in <code>ISignalDto</code>. The signal enters <code>&quot;scheduled&quot;</code> state and waits for price to reach entry point:</p>
<ul>
<li><strong>Long positions</strong>: Activates when <code>currentPrice &lt;= priceOpen</code></li>
<li><strong>Short positions</strong>: Activates when <code>currentPrice &gt;= priceOpen</code></li>
<li><strong>Cancellation</strong>: Occurs if price breaches <code>priceStopLoss</code> before activation or timeout exceeds <code>CC_SCHEDULE_AWAIT_MINUTES</code></li>
</ul>
<p>Timeout logic is implemented in <code>CHECK_SCHEDULED_SIGNAL_TIMEOUT_FN</code> (<a href="">src/client/ClientStrategy.ts:554-608</a>), activation logic in <code>CHECK_SCHEDULED_SIGNAL_PRICE_ACTIVATION_FN</code> (<a href="">src/client/ClientStrategy.ts:610-644</a>).</p>
<a id="signal-validation" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Signal Validation<a href="#signal-validation" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>All signals pass through <code>VALIDATE_SIGNAL_FN</code> which enforces:</p>
<ul>
<li>Price sanity checks (finite, positive values)</li>
<li>Long position rules: <code>priceStopLoss &lt; priceOpen &lt; priceTakeProfit</code></li>
<li>Short position rules: <code>priceTakeProfit &lt; priceOpen &lt; priceStopLoss</code></li>
<li>Minimum TP distance: <code>&gt;= CC_MIN_TAKEPROFIT_DISTANCE_PERCENT</code> (<a href="">src/client/ClientStrategy.ts:163-173</a>)</li>
<li>Minimum SL distance: <code>&gt;= CC_MIN_STOPLOSS_DISTANCE_PERCENT</code> (<a href="">src/client/ClientStrategy.ts:176-186</a>)</li>
<li>Maximum SL distance: <code>&lt;= CC_MAX_STOPLOSS_DISTANCE_PERCENT</code> (<a href="">src/client/ClientStrategy.ts:189-199</a>)</li>
<li>Maximum lifetime: <code>&lt;= CC_MAX_SIGNAL_LIFETIME_MINUTES</code> (<a href="">src/client/ClientStrategy.ts:306-316</a>)</li>
<li>Immediate closure prevention: validates <code>currentPrice</code> is between SL and TP bounds</li>
</ul>
<a id="integration-points" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Integration Points<a href="#integration-points" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>ClientStrategy receives dependencies via <code>IStrategyParams</code>:</p>
<table>
<thead>
<tr>
<th>Dependency</th>
<th>Type</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>exchange</code></td>
<td><code>IExchange</code></td>
<td>VWAP calculation, candle fetching</td>
</tr>
<tr>
<td><code>risk</code></td>
<td><code>IRisk</code></td>
<td>Signal validation via <code>checkSignal()</code></td>
</tr>
<tr>
<td><code>partial</code></td>
<td><code>IPartial</code></td>
<td>Milestone tracking for profit/loss levels</td>
</tr>
<tr>
<td><code>execution</code></td>
<td><code>TExecutionContextService</code></td>
<td>Symbol, when (timestamp), backtest flag</td>
</tr>
<tr>
<td><code>method</code></td>
<td><code>TMethodContextService</code></td>
<td>strategyName, exchangeName, frameName</td>
</tr>
</tbody>
</table>
<p>Risk integration occurs at two points:</p>
<ol>
<li>Before signal creation in <code>GET_SIGNAL_FN</code> (<a href="">src/client/ClientStrategy.ts:374-387</a>)</li>
<li>Before scheduled signal activation in <code>ACTIVATE_SCHEDULED_SIGNAL_FN</code> (<a href="">src/client/ClientStrategy.ts:711-729</a>)</li>
</ol>
<hr>
<a id="clientexchange" class="tsd-anchor"></a><h2 class="tsd-anchor-link">ClientExchange<a href="#clientexchange" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>ClientExchange implements the <code>IExchange</code> interface and provides market data access with retry logic, anomaly detection, and VWAP calculation. It wraps the user-provided <code>getCandles</code> implementation from <code>IExchangeSchema</code> with production-grade error handling.</p>
<a id="data-flow" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Data Flow<a href="#data-flow" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><img src="../media/10-client-layer_2.svg" alt="Mermaid Diagram"></p>
<a id="key-methods-1" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Key Methods<a href="#key-methods-1" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><a id="getcandles" class="tsd-anchor"></a><h4 class="tsd-anchor-link">getCandles()<a href="#getcandles" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><p>Fetches historical candles <strong>backwards</strong> from execution context time (<code>execution.context.when</code>). Implements:</p>
<ul>
<li>Retry logic with exponential backoff (<code>CC_GET_CANDLES_RETRY_COUNT</code>, <code>CC_GET_CANDLES_RETRY_DELAY_MS</code>)</li>
<li>Price anomaly detection to filter incomplete candles (<a href="">types.d.ts:84-91</a>)</li>
<li>Median-based validation: rejects candles where <code>price &lt; median / CC_GET_CANDLES_PRICE_ANOMALY_THRESHOLD_FACTOR</code></li>
<li>Callback invocation: <code>callbacks.onCandleData</code> if provided</li>
</ul>
<a id="getnextcandles" class="tsd-anchor"></a><h4 class="tsd-anchor-link">getNextCandles()<a href="#getnextcandles" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><p>Fetches future candles <strong>forward</strong> from execution context time (backtest mode only). Used by <code>ClientStrategy.backtest()</code> to simulate forward-looking price action. Same retry/anomaly logic as <code>getCandles()</code>.</p>
<a id="getaverageprice" class="tsd-anchor"></a><h4 class="tsd-anchor-link">getAveragePrice()<a href="#getaverageprice" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><p>Calculates VWAP from last <code>CC_AVG_PRICE_CANDLES_COUNT</code> candles (default: 5) using 1-minute interval:</p>
<pre><code><span class="hl-4">Typical</span><span class="hl-1"> </span><span class="hl-4">Price</span><span class="hl-1"> = (</span><span class="hl-4">High</span><span class="hl-1"> + </span><span class="hl-4">Low</span><span class="hl-1"> + </span><span class="hl-4">Close</span><span class="hl-1">) / </span><span class="hl-6">3</span><br/><span class="hl-8">VWAP</span><span class="hl-1"> = </span><span class="hl-0">Σ</span><span class="hl-1">(</span><span class="hl-4">Typical</span><span class="hl-1"> </span><span class="hl-4">Price</span><span class="hl-1"> × </span><span class="hl-4">Volume</span><span class="hl-1">) / </span><span class="hl-0">Σ</span><span class="hl-1">(</span><span class="hl-4">Volume</span><span class="hl-1">)</span>
</code><button>Copy</button></pre>

<p>Falls back to simple average if total volume is zero.</p>
<a id="formatprice-and-formatquantity" class="tsd-anchor"></a><h4 class="tsd-anchor-link">formatPrice() and formatQuantity()<a href="#formatprice-and-formatquantity" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><p>Delegate to user-provided formatting functions in <code>IExchangeSchema</code>. These enforce exchange-specific precision rules (e.g., Binance requires 8 decimal places for BTC prices).</p>
<a id="anomaly-detection-rationale" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Anomaly Detection Rationale<a href="#anomaly-detection-rationale" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>The anomaly detection system addresses a known issue with incomplete candles from exchange APIs. When the API returns incomplete data, prices can be near zero (e.g., <code>$0.01</code> for BTC instead of <code>$50,000</code>). The threshold factor of 1000 catches these anomalies:</p>
<ul>
<li>BTC at <code>$50,000</code> median → threshold <code>$50</code> → rejects <code>$0.01</code> candles</li>
<li>Factor 1000 is chosen as a balance: strict enough to catch incomplete data, permissive enough for normal volatility</li>
</ul>
<hr>
<a id="clientframe" class="tsd-anchor"></a><h2 class="tsd-anchor-link">ClientFrame<a href="#clientframe" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>ClientFrame implements the <code>IFrame</code> interface and generates arrays of timestamps for backtest iteration. It converts date ranges and intervals from <code>IFrameSchema</code> into concrete <code>Date[]</code> arrays.</p>
<a id="timeframe-generation" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Timeframe Generation<a href="#timeframe-generation" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><img src="../media/10-client-layer_3.svg" alt="Mermaid Diagram"></p>
<a id="interval-mapping" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Interval Mapping<a href="#interval-mapping" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>ClientFrame converts <code>FrameInterval</code> strings into millisecond offsets:</p>
<table>
<thead>
<tr>
<th>FrameInterval</th>
<th>Milliseconds</th>
<th>Example Usage</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>&quot;1m&quot;</code></td>
<td>60,000</td>
<td>High-frequency scalping backtests</td>
</tr>
<tr>
<td><code>&quot;5m&quot;</code></td>
<td>300,000</td>
<td>Short-term swing strategies</td>
</tr>
<tr>
<td><code>&quot;15m&quot;</code></td>
<td>900,000</td>
<td>Intraday trend following</td>
</tr>
<tr>
<td><code>&quot;1h&quot;</code></td>
<td>3,600,000</td>
<td>Multi-hour position strategies</td>
</tr>
<tr>
<td><code>&quot;4h&quot;</code></td>
<td>14,400,000</td>
<td>Daily swing trading</td>
</tr>
<tr>
<td><code>&quot;1d&quot;</code></td>
<td>86,400,000</td>
<td>Long-term position strategies</td>
</tr>
</tbody>
</table>
<a id="callbacks" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Callbacks<a href="#callbacks" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>If <code>IFrameSchema.callbacks.onTimeframe</code> is provided, ClientFrame invokes it after generating the timeframe array. This allows inspection of generated timestamps for validation or logging purposes.</p>
<hr>
<a id="clientrisk" class="tsd-anchor"></a><h2 class="tsd-anchor-link">ClientRisk<a href="#clientrisk" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>ClientRisk implements the <code>IRisk</code> interface and enforces portfolio-level risk controls via custom validation functions. It maintains in-memory tracking of active positions across all strategies and validates new signals against user-defined rules.</p>
<a id="risk-validation-flow" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Risk Validation Flow<a href="#risk-validation-flow" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><img src="../media/10-client-layer_4.svg" alt="Mermaid Diagram"></p>
<a id="validation-system" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Validation System<a href="#validation-system" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Risk validations are defined as an array in <code>IRiskSchema.validations</code>. Each validation can be:</p>
<ol>
<li>Function directly: <code>(payload: IRiskValidationPayload) =&gt; void</code></li>
<li>Object with function + note: <code>{ validate: Function, note: string }</code></li>
</ol>
<p>The <code>note</code> field is included in rejection events emitted to <code>riskSubject</code>, allowing identification of which rule failed.</p>
<a id="position-tracking" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Position Tracking<a href="#position-tracking" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>ClientRisk maintains three parallel data structures:</p>
<table>
<thead>
<tr>
<th>Method</th>
<th>Purpose</th>
<th>Timing</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>checkSignal()</code></td>
<td>Pre-creation validation</td>
<td>Before signal opens</td>
</tr>
<tr>
<td><code>addSignal()</code></td>
<td>Register opened position</td>
<td>After signal opens</td>
</tr>
<tr>
<td><code>removeSignal()</code></td>
<td>Unregister closed position</td>
<td>After signal closes</td>
</tr>
</tbody>
</table>
<p>The active position count and list are passed to validation functions via <code>IRiskValidationPayload</code>, enabling rules like &quot;max 3 concurrent positions&quot; or &quot;no more than 1 position per symbol&quot;.</p>
<a id="integration-with-persistence" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Integration with Persistence<a href="#integration-with-persistence" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>In live mode, ClientRisk state is persisted via <code>PersistRiskAdapter</code> for crash recovery. The <code>_states</code> Map is serialized to JSON and restored on initialization via <code>waitForInit()</code>.</p>
<hr>
<a id="clientpartial" class="tsd-anchor"></a><h2 class="tsd-anchor-link">ClientPartial<a href="#clientpartial" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>ClientPartial implements the <code>IPartial</code> interface and tracks profit/loss milestones (10%, 20%, 30%, ..., 100%) for active signals. It uses Set-based deduplication to ensure each level is emitted exactly once per signal.</p>
<a id="milestone-tracking-architecture" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Milestone Tracking Architecture<a href="#milestone-tracking-architecture" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><img src="../media/10-client-layer_5.svg" alt="Mermaid Diagram"></p>
<a id="deduplication-logic" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Deduplication Logic<a href="#deduplication-logic" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>ClientPartial maintains per-signal state:</p>
<pre><code class="typescript"><span class="hl-7">interface</span><span class="hl-1"> </span><span class="hl-13">IPartialState</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-4">profitLevels</span><span class="hl-1">: </span><span class="hl-13">Set</span><span class="hl-1">&lt;</span><span class="hl-13">PartialLevel</span><span class="hl-1">&gt;; </span><span class="hl-5">// 10, 20, 30, ..., 100</span><br/><span class="hl-1">  </span><span class="hl-4">lossLevels</span><span class="hl-1">: </span><span class="hl-13">Set</span><span class="hl-1">&lt;</span><span class="hl-13">PartialLevel</span><span class="hl-1">&gt;;   </span><span class="hl-5">// 10, 20, 30, ..., 100</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<p>When <code>profit()</code> is called with <code>revenuePercent = 22.5</code>:</p>
<ol>
<li>Calculates which levels are reached: 10, 20</li>
<li>Checks <code>profitLevels</code> Set: 10 already exists, 20 is new</li>
<li>Emits event only for 20%</li>
<li>Adds 20 to <code>profitLevels</code> Set</li>
</ol>
<p>This ensures each milestone is reported exactly once even if price oscillates around threshold.</p>
<a id="persistence" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Persistence<a href="#persistence" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>For live mode crash recovery, ClientPartial serializes state via <code>PersistPartialAdapter</code>:</p>
<ul>
<li>In-memory: <code>Map&lt;signalId, IPartialState&gt;</code> (Sets)</li>
<li>On disk: <code>Record&lt;signalId, IPartialData&gt;</code> (arrays)</li>
</ul>
<p>Conversion happens in <code>waitForInit()</code> (deserialize) and on each emit (serialize).</p>
<a id="clear-operation" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Clear Operation<a href="#clear-operation" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>When a signal closes, <code>clear()</code> removes the signal's state from memory and disk. This prevents unbounded growth of the state map and ensures milestone tracking is reset for future signals.</p>
<hr>
<a id="clientoptimizer" class="tsd-anchor"></a><h2 class="tsd-anchor-link">ClientOptimizer<a href="#clientoptimizer" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>ClientOptimizer implements the <code>IOptimizer</code> interface and orchestrates LLM-based strategy code generation. It fetches multi-timeframe historical data, formats it for LLM consumption, sends prompts to Ollama API, and generates executable <code>.mjs</code> files.</p>
<a id="optimization-pipeline" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Optimization Pipeline<a href="#optimization-pipeline" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><img src="../media/10-client-layer_6.svg" alt="Mermaid Diagram"></p>
<a id="data-source-iteration" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Data Source Iteration<a href="#data-source-iteration" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>ClientOptimizer iterates through <code>IOptimizerSource[]</code> defined in <code>IOptimizerSchema.sources</code>. Each source specifies:</p>
<table>
<thead>
<tr>
<th>Field</th>
<th>Type</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>interval</code></td>
<td><code>CandleInterval</code></td>
<td>Candle timeframe (e.g., &quot;1h&quot;, &quot;15m&quot;)</td>
</tr>
<tr>
<td><code>range</code></td>
<td><code>IOptimizerRange</code></td>
<td>Date range for data fetching</td>
</tr>
<tr>
<td><code>filter</code></td>
<td><code>(args: IOptimizerFilterArgs) =&gt; boolean</code></td>
<td>Post-fetch filtering predicate</td>
</tr>
</tbody>
</table>
<p>For each source, optimizer fetches candles and formats them as markdown tables for LLM context window.</p>
<a id="llm-prompt-construction" class="tsd-anchor"></a><h3 class="tsd-anchor-link">LLM Prompt Construction<a href="#llm-prompt-construction" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>The user provides <code>getPrompt</code> callback which receives formatted data and returns <code>MessageModel[]</code>. This allows complete control over LLM instruction:</p>
<pre><code class="typescript"><span class="hl-10">getPrompt</span><span class="hl-1">: (</span><span class="hl-4">data</span><span class="hl-1">: </span><span class="hl-13">IOptimizerData</span><span class="hl-1">[]) </span><span class="hl-7">=&gt;</span><span class="hl-1"> </span><span class="hl-13">Promise</span><span class="hl-1">&lt;</span><span class="hl-4">MessageModel</span><span class="hl-1">[]&gt;</span>
</code><button type="button">Copy</button></pre>

<p><code>IOptimizerData</code> contains:</p>
<ul>
<li><code>interval</code>: Source timeframe</li>
<li><code>candles</code>: Formatted markdown table</li>
<li><code>range</code>: Date range metadata</li>
</ul>
<a id="template-system" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Template System<a href="#template-system" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>ClientOptimizer uses <code>OptimizerTemplateService</code> to merge LLM-generated strategy code with boilerplate:</p>
<ol>
<li>Default template includes <code>addExchange</code>, <code>addStrategy</code>, <code>Walker.background</code> calls</li>
<li>User can override via <code>IOptimizerSchema.template.code</code></li>
<li>Template receives strategy code as <code>{{strategy}}</code> placeholder</li>
<li>Result is executable Node.js module</li>
</ol>
<a id="code-export" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Code Export<a href="#code-export" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Generated code is returned as string from <code>run()</code> method. To write to disk:</p>
<pre><code class="typescript"><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">code</span><span class="hl-1"> = </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-4">Optimizer</span><span class="hl-1">.</span><span class="hl-0">run</span><span class="hl-1">(</span><span class="hl-2">&quot;BTCUSDT&quot;</span><span class="hl-1">, { </span><span class="hl-4">optimizerName:</span><span class="hl-1"> </span><span class="hl-2">&quot;my-optimizer&quot;</span><span class="hl-1"> });</span><br/><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-4">Optimizer</span><span class="hl-1">.</span><span class="hl-0">dump</span><span class="hl-1">(</span><span class="hl-2">&quot;my-optimizer&quot;</span><span class="hl-1">, </span><span class="hl-2">&quot;BTCUSDT&quot;</span><span class="hl-1">, </span><span class="hl-4">code</span><span class="hl-1">);</span><br/><span class="hl-5">// Writes to ./my-optimizer_BTCUSDT.mjs</span>
</code><button type="button">Copy</button></pre>

<hr>
<a id="instantiation-and-lifecycle" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Instantiation and Lifecycle<a href="#instantiation-and-lifecycle" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>All client instances are created and managed by their respective ConnectionServices, which implement consistent patterns for instantiation, dependency injection, and lifecycle management.</p>
<a id="factory-pattern" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Factory Pattern<a href="#factory-pattern" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>ConnectionServices act as factories with memoization:</p>
<p><img src="../media/10-client-layer_7.svg" alt="Mermaid Diagram"></p>
<a id="dependency-injection-pattern" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Dependency Injection Pattern<a href="#dependency-injection-pattern" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>All clients receive dependencies via constructor parameters. Example from ClientStrategy:</p>
<pre><code class="typescript"><span class="hl-7">new</span><span class="hl-1"> </span><span class="hl-0">ClientStrategy</span><span class="hl-1">({</span><br/><span class="hl-1">  </span><span class="hl-4">symbol:</span><span class="hl-1"> </span><span class="hl-4">string</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">interval:</span><span class="hl-1"> </span><span class="hl-4">SignalInterval</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">execution:</span><span class="hl-1"> </span><span class="hl-4">TExecutionContextService</span><span class="hl-1">,    </span><span class="hl-5">// Scoped: symbol, when, backtest</span><br/><span class="hl-1">  </span><span class="hl-4">method:</span><span class="hl-1"> </span><span class="hl-4">TMethodContextService</span><span class="hl-1">,          </span><span class="hl-5">// Scoped: strategyName, exchangeName, frameName</span><br/><span class="hl-1">  </span><span class="hl-4">logger:</span><span class="hl-1"> </span><span class="hl-4">ILogger</span><span class="hl-1">,                        </span><span class="hl-5">// Global: LoggerService</span><br/><span class="hl-1">  </span><span class="hl-4">partial:</span><span class="hl-1"> </span><span class="hl-4">IPartial</span><span class="hl-1">,                      </span><span class="hl-5">// Memoized: PartialConnectionService</span><br/><span class="hl-1">  </span><span class="hl-4">exchange:</span><span class="hl-1"> </span><span class="hl-4">IExchange</span><span class="hl-1">,                    </span><span class="hl-5">// Memoized: ExchangeConnectionService</span><br/><span class="hl-1">  </span><span class="hl-4">risk:</span><span class="hl-1"> </span><span class="hl-4">IRisk</span><span class="hl-1">,                            </span><span class="hl-5">// Memoized: RiskConnectionService or NOOP_RISK</span><br/><span class="hl-1">  </span><span class="hl-4">riskName:</span><span class="hl-1"> </span><span class="hl-4">RiskName</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">strategyName:</span><span class="hl-1"> </span><span class="hl-4">StrategyName</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">getSignal:</span><span class="hl-1"> </span><span class="hl-4">Function</span><span class="hl-1">,                    </span><span class="hl-5">// From StrategySchemaService</span><br/><span class="hl-1">  </span><span class="hl-4">callbacks:</span><span class="hl-1"> </span><span class="hl-4">IStrategyCallbacks</span><span class="hl-1">           </span><span class="hl-5">// From StrategySchemaService</span><br/><span class="hl-1">})</span>
</code><button type="button">Copy</button></pre>

<p>This pattern ensures:</p>
<ul>
<li>Clients are decoupled from service locator</li>
<li>Dependencies are explicit and type-safe</li>
<li>Easy to mock for testing</li>
</ul>
<a id="initialization-waitforinit" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Initialization: waitForInit()<a href="#initialization-waitforinit" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Clients that require crash recovery implement <code>waitForInit()</code> method:</p>
<table>
<thead>
<tr>
<th>Client</th>
<th>Persistence Adapter</th>
<th>Recovery Action</th>
</tr>
</thead>
<tbody>
<tr>
<td>ClientStrategy</td>
<td>PersistSignalAdapter, PersistScheduleAdapter</td>
<td>Restore pending/scheduled signals</td>
</tr>
<tr>
<td>ClientRisk</td>
<td>PersistRiskAdapter</td>
<td>Restore active position tracking</td>
</tr>
<tr>
<td>ClientPartial</td>
<td>PersistPartialAdapter</td>
<td>Restore profit/loss milestone state</td>
</tr>
</tbody>
</table>
<p>In live mode, ConnectionServices call <code>await strategy.waitForInit()</code> before first operation. In backtest mode, <code>waitForInit()</code> returns immediately (no persistence).</p>
<a id="cache-management" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Cache Management<a href="#cache-management" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>ConnectionServices provide <code>clear()</code> method to invalidate memoization cache:</p>
<pre><code class="typescript"><span class="hl-5">// Clear specific instance</span><br/><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-4">strategyConnectionService</span><span class="hl-1">.</span><span class="hl-0">clear</span><span class="hl-1">({ </span><br/><span class="hl-1">  </span><span class="hl-4">symbol:</span><span class="hl-1"> </span><span class="hl-2">&quot;BTCUSDT&quot;</span><span class="hl-1">, </span><br/><span class="hl-1">  </span><span class="hl-4">strategyName:</span><span class="hl-1"> </span><span class="hl-2">&quot;my-strategy&quot;</span><span class="hl-1"> </span><br/><span class="hl-1">});</span><br/><br/><span class="hl-5">// Clear all instances</span><br/><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-4">strategyConnectionService</span><span class="hl-1">.</span><span class="hl-0">clear</span><span class="hl-1">();</span>
</code><button type="button">Copy</button></pre>

<p>This is useful for:</p>
<ul>
<li>Releasing resources after execution completes</li>
<li>Resetting state between test runs</li>
<li>Force-reloading strategy after schema changes</li>
</ul>
<a id="risk-composition" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Risk Composition<a href="#risk-composition" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>StrategyConnectionService implements special logic for risk composition. If <code>IStrategySchema</code> defines both <code>riskName</code> and <code>riskList</code>, they are merged:</p>
<pre><code class="typescript"><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-0">GET_RISK_FN</span><span class="hl-1"> = (</span><span class="hl-4">dto</span><span class="hl-1">, </span><span class="hl-4">self</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-3">if</span><span class="hl-1"> (!</span><span class="hl-4">dto</span><span class="hl-1">.</span><span class="hl-4">riskName</span><span class="hl-1"> &amp;&amp; !</span><span class="hl-4">dto</span><span class="hl-1">.</span><span class="hl-4">riskList</span><span class="hl-1">?.</span><span class="hl-4">length</span><span class="hl-1">) {</span><br/><span class="hl-1">    </span><span class="hl-3">return</span><span class="hl-1"> </span><span class="hl-8">NOOP_RISK</span><span class="hl-1">;</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">  </span><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-4">dto</span><span class="hl-1">.</span><span class="hl-4">riskName</span><span class="hl-1"> &amp;&amp; </span><span class="hl-4">dto</span><span class="hl-1">.</span><span class="hl-4">riskList</span><span class="hl-1">?.</span><span class="hl-4">length</span><span class="hl-1">) {</span><br/><span class="hl-1">    </span><span class="hl-3">return</span><span class="hl-1"> </span><span class="hl-7">new</span><span class="hl-1"> </span><span class="hl-0">MergeRisk</span><span class="hl-1">([</span><br/><span class="hl-1">      </span><span class="hl-4">self</span><span class="hl-1">.</span><span class="hl-4">riskConnectionService</span><span class="hl-1">.</span><span class="hl-0">getRisk</span><span class="hl-1">(</span><span class="hl-4">dto</span><span class="hl-1">.</span><span class="hl-4">riskName</span><span class="hl-1">),</span><br/><span class="hl-1">      ...</span><span class="hl-4">dto</span><span class="hl-1">.</span><span class="hl-4">riskList</span><span class="hl-1">.</span><span class="hl-0">map</span><span class="hl-1">(</span><span class="hl-4">name</span><span class="hl-1"> </span><span class="hl-7">=&gt;</span><span class="hl-1"> </span><span class="hl-4">self</span><span class="hl-1">.</span><span class="hl-4">riskConnectionService</span><span class="hl-1">.</span><span class="hl-0">getRisk</span><span class="hl-1">(</span><span class="hl-4">name</span><span class="hl-1">))</span><br/><span class="hl-1">    ]);</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">  </span><span class="hl-5">// ... single risk cases</span><br/><span class="hl-1">};</span>
</code><button type="button">Copy</button></pre>

<p><code>MergeRisk</code> class combines multiple risk profiles by executing all validations sequentially.</p>
<hr>
<a id="summary-table" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Summary Table<a href="#summary-table" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><table>
<thead>
<tr>
<th>Client</th>
<th>Interface</th>
<th>File Path</th>
<th>Primary Methods</th>
<th>Memoization Key</th>
</tr>
</thead>
<tbody>
<tr>
<td>ClientStrategy</td>
<td><code>IStrategy</code></td>
<td><a href="">src/client/ClientStrategy.ts:1-1000</a></td>
<td><code>tick()</code>, <code>backtest()</code>, <code>getPendingSignal()</code>, <code>stop()</code></td>
<td><code>${symbol}:${strategyName}</code></td>
</tr>
<tr>
<td>ClientExchange</td>
<td><code>IExchange</code></td>
<td><a href="">src/client/ClientExchange.ts:1-300</a></td>
<td><code>getCandles()</code>, <code>getNextCandles()</code>, <code>getAveragePrice()</code>, <code>formatPrice()</code>, <code>formatQuantity()</code></td>
<td><code>${exchangeName}</code></td>
</tr>
<tr>
<td>ClientFrame</td>
<td><code>IFrame</code></td>
<td><a href="">src/client/ClientFrame.ts:1-200</a></td>
<td><code>getTimeframe()</code></td>
<td><code>${frameName}</code></td>
</tr>
<tr>
<td>ClientRisk</td>
<td><code>IRisk</code></td>
<td><a href="">src/client/ClientRisk.ts:1-300</a></td>
<td><code>checkSignal()</code>, <code>addSignal()</code>, <code>removeSignal()</code></td>
<td><code>${riskName}</code></td>
</tr>
<tr>
<td>ClientPartial</td>
<td><code>IPartial</code></td>
<td><a href="">src/client/ClientPartial.ts:1-300</a></td>
<td><code>profit()</code>, <code>loss()</code>, <code>clear()</code></td>
<td><code>${symbol}</code></td>
</tr>
<tr>
<td>ClientOptimizer</td>
<td><code>IOptimizer</code></td>
<td><a href="">src/client/ClientOptimizer.ts:1-500</a></td>
<td><code>run()</code>, <code>dump()</code></td>
<td><code>${optimizerName}</code></td>
</tr>
</tbody>
</table>
</div></div><div class="col-sidebar"><div class="page-menu"><div class="tsd-navigation settings"><details class="tsd-accordion"><summary class="tsd-accordion-summary"><h3><svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-chevronDown"></use></svg>Settings</h3></summary><div class="tsd-accordion-details"><div class="tsd-filter-visibility"><span class="settings-label">Member Visibility</span><ul id="tsd-filter-options"><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-protected" name="protected"/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Protected</span></label></li><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-inherited" name="inherited" checked/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Inherited</span></label></li><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-external" name="external"/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>External</span></label></li></ul></div><div class="tsd-theme-toggle"><label class="settings-label" for="tsd-theme">Theme</label><select id="tsd-theme"><option value="os">OS</option><option value="light">Light</option><option value="dark">Dark</option></select></div></div></details></div><details open class="tsd-accordion tsd-page-navigation"><summary class="tsd-accordion-summary"><h3><svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-chevronDown"></use></svg>On This Page</h3></summary><div class="tsd-accordion-details"><a href="#client-layer"><span>Client <wbr/>Layer</span></a><ul><li><a href="#purpose-and-scope"><span>Purpose and <wbr/>Scope</span></a></li><li><a href="#architecture-overview"><span>Architecture <wbr/>Overview</span></a></li><li><ul><li><a href="#client-layer-structure"><span>Client <wbr/>Layer <wbr/>Structure</span></a></li><li><a href="#memoization-pattern"><span>Memoization <wbr/>Pattern</span></a></li></ul></li><li><a href="#clientstrategy"><span>Client<wbr/>Strategy</span></a></li><li><ul><li><a href="#signal-lifecycle-state-machine"><span>Signal <wbr/>Lifecycle <wbr/>State <wbr/>Machine</span></a></li><li><a href="#key-methods"><span>Key <wbr/>Methods</span></a></li><li><ul><li><a href="#tick"><span>tick()</span></a></li><li><a href="#backtest"><span>backtest()</span></a></li></ul></li><li><a href="#scheduled-signal-handling"><span>Scheduled <wbr/>Signal <wbr/>Handling</span></a></li><li><a href="#signal-validation"><span>Signal <wbr/>Validation</span></a></li><li><a href="#integration-points"><span>Integration <wbr/>Points</span></a></li></ul></li><li><a href="#clientexchange"><span>Client<wbr/>Exchange</span></a></li><li><ul><li><a href="#data-flow"><span>Data <wbr/>Flow</span></a></li><li><a href="#key-methods-1"><span>Key <wbr/>Methods</span></a></li><li><ul><li><a href="#getcandles"><span>get<wbr/>Candles()</span></a></li><li><a href="#getnextcandles"><span>get<wbr/>Next<wbr/>Candles()</span></a></li><li><a href="#getaverageprice"><span>get<wbr/>Average<wbr/>Price()</span></a></li><li><a href="#formatprice-and-formatquantity"><span>format<wbr/>Price() and format<wbr/>Quantity()</span></a></li></ul></li><li><a href="#anomaly-detection-rationale"><span>Anomaly <wbr/>Detection <wbr/>Rationale</span></a></li></ul></li><li><a href="#clientframe"><span>Client<wbr/>Frame</span></a></li><li><ul><li><a href="#timeframe-generation"><span>Timeframe <wbr/>Generation</span></a></li><li><a href="#interval-mapping"><span>Interval <wbr/>Mapping</span></a></li><li><a href="#callbacks"><span>Callbacks</span></a></li></ul></li><li><a href="#clientrisk"><span>Client<wbr/>Risk</span></a></li><li><ul><li><a href="#risk-validation-flow"><span>Risk <wbr/>Validation <wbr/>Flow</span></a></li><li><a href="#validation-system"><span>Validation <wbr/>System</span></a></li><li><a href="#position-tracking"><span>Position <wbr/>Tracking</span></a></li><li><a href="#integration-with-persistence"><span>Integration with <wbr/>Persistence</span></a></li></ul></li><li><a href="#clientpartial"><span>Client<wbr/>Partial</span></a></li><li><ul><li><a href="#milestone-tracking-architecture"><span>Milestone <wbr/>Tracking <wbr/>Architecture</span></a></li><li><a href="#deduplication-logic"><span>Deduplication <wbr/>Logic</span></a></li><li><a href="#persistence"><span>Persistence</span></a></li><li><a href="#clear-operation"><span>Clear <wbr/>Operation</span></a></li></ul></li><li><a href="#clientoptimizer"><span>Client<wbr/>Optimizer</span></a></li><li><ul><li><a href="#optimization-pipeline"><span>Optimization <wbr/>Pipeline</span></a></li><li><a href="#data-source-iteration"><span>Data <wbr/>Source <wbr/>Iteration</span></a></li><li><a href="#llm-prompt-construction"><span>LLM <wbr/>Prompt <wbr/>Construction</span></a></li><li><a href="#template-system"><span>Template <wbr/>System</span></a></li><li><a href="#code-export"><span>Code <wbr/>Export</span></a></li></ul></li><li><a href="#instantiation-and-lifecycle"><span>Instantiation and <wbr/>Lifecycle</span></a></li><li><ul><li><a href="#factory-pattern"><span>Factory <wbr/>Pattern</span></a></li><li><a href="#dependency-injection-pattern"><span>Dependency <wbr/>Injection <wbr/>Pattern</span></a></li><li><a href="#initialization-waitforinit"><span>Initialization: wait<wbr/>For<wbr/>Init()</span></a></li><li><a href="#cache-management"><span>Cache <wbr/>Management</span></a></li><li><a href="#risk-composition"><span>Risk <wbr/>Composition</span></a></li></ul></li><li><a href="#summary-table"><span>Summary <wbr/>Table</span></a></li></ul></div></details></div><div class="site-menu"><nav class="tsd-navigation"><a href="../modules.html">backtest-kit</a><ul class="tsd-small-nested-navigation" id="tsd-nav-container"><li>Loading...</li></ul></nav></div></div></div><footer><p class="tsd-generator">Generated using <a href="https://typedoc.org/" target="_blank">TypeDoc</a></p></footer><div class="overlay"></div></body></html>

<!-- Yandex.Metrika counter -->
<script type="text/javascript">
    (function(m,e,t,r,i,k,a){
        m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
        m[i].l=1*new Date();
        for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }}
        k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)
    })(window, document,'script','https://mc.yandex.ru/metrika/tag.js?id=105455585', 'ym');

    ym(105455585, 'init', {ssr:true, webvisor:true, clickmap:true, ecommerce:"dataLayer", accurateTrackBounce:true, trackLinks:true});
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/105455585" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
<!-- /Yandex.Metrika counter -->

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-3MQZEBBDDR"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-3MQZEBBDDR');
</script>
