<!DOCTYPE html><html class="default" lang="en" data-base=".."><head><meta charset="utf-8"/><meta http-equiv="x-ua-compatible" content="IE=edge"/><title>design/28_risk_schemas | backtest-kit</title><meta name="description" content="Documentation for backtest-kit"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="stylesheet" href="../assets/style.css"/><link rel="stylesheet" href="../assets/highlight.css"/><script defer src="../assets/main.js"></script><script async src="../assets/icons.js" id="tsd-icons-script"></script><script async src="../assets/search.js" id="tsd-search-script"></script><script async src="../assets/navigation.js" id="tsd-nav-script"></script><script async src="../assets/hierarchy.js" id="tsd-hierarchy-script"></script></head><body><script>document.documentElement.dataset.theme = localStorage.getItem("tsd-theme") || "os";document.body.style.display="none";setTimeout(() => app?app.showPage():document.body.style.removeProperty("display"),500)</script><header class="tsd-page-toolbar"><div class="tsd-toolbar-contents container"><div class="table-cell" id="tsd-search"><div class="field"><label for="tsd-search-field" class="tsd-widget tsd-toolbar-icon search no-caption"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-search"></use></svg></label><input type="text" id="tsd-search-field" aria-label="Search"/></div><div class="field"><div id="tsd-toolbar-links"></div></div><ul class="results"><li class="state loading">Preparing search index...</li><li class="state failure">The search index is not available</li></ul><a href="../index.html" class="title">backtest-kit</a></div><div class="table-cell" id="tsd-widgets"><a href="#" class="tsd-widget tsd-toolbar-icon menu no-caption" data-toggle="menu" aria-label="Menu"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-menu"></use></svg></a></div></div></header><div class="container container-main"><div class="col-content"><div class="tsd-page-title"><ul class="tsd-breadcrumb"><li><a href="../modules.html">backtest-kit</a></li><li><a href="design_28_risk_schemas.html">design/28_risk_schemas</a></li></ul></div><div class="tsd-panel tsd-typography"><a id="risk-schemas" class="tsd-anchor"></a><h1 class="tsd-anchor-link">Risk Schemas<a href="#risk-schemas" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h1><p>This document describes the risk management schema system in backtest-kit. Risk schemas define portfolio-level risk controls that prevent signals from violating configured limits. Multiple strategies can share the same risk profile, enabling cross-strategy risk analysis.</p>
<p>The <code>IRiskSchema</code> interface specifies four core fields: <code>riskName</code> (unique identifier), <code>validations</code> (array of validation functions), <code>callbacks</code> (lifecycle event hooks), and optional <code>note</code> (documentation). Position limits like maximum concurrent positions are implemented as custom validation functions, not as direct schema fields.</p>
<p>For information about strategy schemas (which reference risk schemas), see page 5.1. For information about the <code>ClientRisk</code> implementation that executes risk logic, see page 6.4.</p>
<hr>
<a id="purpose-and-scope" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Purpose and Scope<a href="#purpose-and-scope" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>Risk schemas provide portfolio-level risk management by:</p>
<ul>
<li><strong>Cross-strategy position tracking</strong>: Track active positions across all strategies sharing the same risk profile via <code>activePositionCount</code> and <code>activePositions</code> in validation payload</li>
<li><strong>Custom validation logic</strong>: Execute user-defined validation functions with access to portfolio state via <code>IRiskValidationPayload</code></li>
<li><strong>Flexible constraints</strong>: Enforce position limits, symbol restrictions, risk-reward ratios, and other business rules through validation functions</li>
<li><strong>Risk isolation</strong>: Each risk profile maintains independent position tracking via memoized <code>ClientRisk</code> instances</li>
</ul>
<p>Risk schemas are registered via <code>addRisk()</code> and referenced by strategies via the <code>riskName</code> or <code>riskList</code> fields in <code>IStrategySchema</code>. The validation functions throw errors to reject signals or return normally to allow them.</p>
<hr>
<a id="schema-structure" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Schema Structure<a href="#schema-structure" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><a id="iriskschema-interface" class="tsd-anchor"></a><h3 class="tsd-anchor-link">IRiskSchema Interface<a href="#iriskschema-interface" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><img src="../media/28_Risk_Schemas_0.svg" alt="Mermaid Diagram"></p>
<p><strong>Diagram: Risk Schema Type Hierarchy</strong></p>
<p>The <code>IRiskSchema</code> interface consists of:</p>
<table>
<thead>
<tr>
<th>Field</th>
<th>Type</th>
<th>Required</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>riskName</code></td>
<td><code>RiskName</code> (string)</td>
<td>Yes</td>
<td>Unique identifier for the risk profile</td>
</tr>
<tr>
<td><code>note</code></td>
<td><code>string</code></td>
<td>No</td>
<td>Optional developer documentation for the risk profile</td>
</tr>
<tr>
<td><code>validations</code></td>
<td><code>(IRiskValidation | IRiskValidationFn)[]</code></td>
<td>Yes</td>
<td>Array of validation functions (direct functions or objects with validate + note)</td>
</tr>
<tr>
<td><code>callbacks</code></td>
<td><code>Partial&lt;IRiskCallbacks&gt;</code></td>
<td>No</td>
<td>Optional lifecycle event hooks (<code>onRejected</code>, <code>onAllowed</code>)</td>
</tr>
</tbody>
</table>
<p><strong>Key Points</strong>:</p>
<ul>
<li>Validations can be provided as functions directly or as objects with <code>validate</code> function and <code>note</code> documentation</li>
<li>All validations receive <code>IRiskValidationPayload</code> with portfolio state (<code>activePositionCount</code>, <code>activePositions</code>)</li>
<li>Throwing an error in any validation function rejects the signal</li>
<li>Both callback functions receive <code>IRiskCheckArgs</code> (without portfolio state additions)</li>
</ul>
<hr>
<a id="validation-functions" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Validation Functions<a href="#validation-functions" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><a id="validation-types" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Validation Types<a href="#validation-types" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Risk validations can be provided in two forms:</p>
<p><strong>1. Function form</strong> (direct validation function):</p>
<pre><code class="typescript"><span class="hl-1">addRisk</span><span class="hl-2">({</span><br/><span class="hl-2">  </span><span class="hl-6">riskName:</span><span class="hl-2"> </span><span class="hl-4">&quot;my-risk&quot;</span><span class="hl-2">,</span><br/><span class="hl-2">  </span><span class="hl-6">validations:</span><span class="hl-2"> [</span><br/><span class="hl-2">    </span><span class="hl-3">async</span><span class="hl-2"> ({ </span><span class="hl-6">activePositionCount</span><span class="hl-2"> }) </span><span class="hl-3">=&gt;</span><span class="hl-2"> {</span><br/><span class="hl-2">      </span><span class="hl-5">if</span><span class="hl-2"> (</span><span class="hl-6">activePositionCount</span><span class="hl-2"> &gt;= </span><span class="hl-7">5</span><span class="hl-2">) {</span><br/><span class="hl-2">        </span><span class="hl-5">throw</span><span class="hl-2"> </span><span class="hl-3">new</span><span class="hl-2"> </span><span class="hl-1">Error</span><span class="hl-2">(</span><span class="hl-4">&quot;Max 5 positions&quot;</span><span class="hl-2">);</span><br/><span class="hl-2">      }</span><br/><span class="hl-2">    }</span><br/><span class="hl-2">  ]</span><br/><span class="hl-2">});</span>
</code><button type="button">Copy</button></pre>

<p><strong>2. Object form</strong> (with documentation):</p>
<pre><code class="typescript"><span class="hl-1">addRisk</span><span class="hl-2">({</span><br/><span class="hl-2">  </span><span class="hl-6">riskName:</span><span class="hl-2"> </span><span class="hl-4">&quot;my-risk&quot;</span><span class="hl-2">,</span><br/><span class="hl-2">  </span><span class="hl-6">validations:</span><span class="hl-2"> [</span><br/><span class="hl-2">    {</span><br/><span class="hl-2">      </span><span class="hl-1">validate</span><span class="hl-6">:</span><span class="hl-2"> </span><span class="hl-3">async</span><span class="hl-2"> ({ </span><span class="hl-6">activePositionCount</span><span class="hl-2"> }) </span><span class="hl-3">=&gt;</span><span class="hl-2"> {</span><br/><span class="hl-2">        </span><span class="hl-5">if</span><span class="hl-2"> (</span><span class="hl-6">activePositionCount</span><span class="hl-2"> &gt;= </span><span class="hl-7">5</span><span class="hl-2">) {</span><br/><span class="hl-2">          </span><span class="hl-5">throw</span><span class="hl-2"> </span><span class="hl-3">new</span><span class="hl-2"> </span><span class="hl-1">Error</span><span class="hl-2">(</span><span class="hl-4">&quot;Max 5 positions&quot;</span><span class="hl-2">);</span><br/><span class="hl-2">        }</span><br/><span class="hl-2">      },</span><br/><span class="hl-2">      </span><span class="hl-6">note:</span><span class="hl-2"> </span><span class="hl-4">&quot;Limit concurrent positions to 5&quot;</span><br/><span class="hl-2">    }</span><br/><span class="hl-2">  ]</span><br/><span class="hl-2">});</span>
</code><button type="button">Copy</button></pre>

<a id="iriskvalidationpayload" class="tsd-anchor"></a><h3 class="tsd-anchor-link">IRiskValidationPayload<a href="#iriskvalidationpayload" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Validation functions receive a payload with all risk check context:</p>
<table>
<thead>
<tr>
<th>Field</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>symbol</code></td>
<td><code>string</code></td>
<td>Trading pair (e.g., &quot;BTCUSDT&quot;)</td>
</tr>
<tr>
<td><code>pendingSignal</code></td>
<td><code>ISignalDto</code></td>
<td>Signal attempting to open (priceOpen, priceTakeProfit, priceStopLoss, position, etc.)</td>
</tr>
<tr>
<td><code>strategyName</code></td>
<td><code>StrategyName</code></td>
<td>Strategy requesting position</td>
</tr>
<tr>
<td><code>exchangeName</code></td>
<td><code>ExchangeName</code></td>
<td>Exchange name</td>
</tr>
<tr>
<td><code>currentPrice</code></td>
<td><code>number</code></td>
<td>Current VWAP price</td>
</tr>
<tr>
<td><code>timestamp</code></td>
<td><code>number</code></td>
<td>Current timestamp in milliseconds</td>
</tr>
<tr>
<td><code>activePositionCount</code></td>
<td><code>number</code></td>
<td>Number of active positions across all strategies using this risk profile</td>
</tr>
<tr>
<td><code>activePositions</code></td>
<td><code>IRiskActivePosition[]</code></td>
<td>List of all active positions with full details</td>
</tr>
</tbody>
</table>
<p><strong>Portfolio State Access</strong>:</p>
<ul>
<li>The <code>activePositions</code> array provides access to all currently open positions across all strategies sharing this risk profile</li>
<li>Each <code>IRiskActivePosition</code> entry includes the signal details, strategy name, exchange name, and open timestamp</li>
<li>The <code>activePositionCount</code> is simply <code>activePositions.length</code> for convenience</li>
<li>The <code>pendingSignal</code> contains the signal attempting to open, allowing price/position validation</li>
</ul>
<a id="validation-execution-flow" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Validation Execution Flow<a href="#validation-execution-flow" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><img src="../media/28_Risk_Schemas_1.svg" alt="Mermaid Diagram"></p>
<p><strong>Diagram: Risk Validation Execution Flow</strong></p>
<p>Validation execution follows this pattern:</p>
<ol>
<li><strong>Initialization</strong>: Load active positions from persistence if needed (<a href="">src/client/ClientRisk.ts:88-96</a>)</li>
<li><strong>Payload Construction</strong>: Combine check args with portfolio state (<a href="">src/client/ClientRisk.ts:177-181</a>)</li>
<li><strong>Sequential Validation</strong>: Execute each validation in order (<a href="">src/client/ClientRisk.ts:186-201</a>)</li>
<li><strong>Error Handling</strong>: Wrapped by <code>DO_VALIDATION_FN</code> with automatic error catching (<a href="">src/client/ClientRisk.ts:31-46</a>)</li>
<li><strong>Early Exit</strong>: Stop on first validation failure</li>
<li><strong>Callback Invocation</strong>: Trigger <code>onRejected</code> or <code>onAllowed</code> based on result</li>
</ol>
<hr>
<a id="position-tracking" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Position Tracking<a href="#position-tracking" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><a id="active-position-map" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Active Position Map<a href="#active-position-map" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>ClientRisk maintains a <code>Map&lt;string, IRiskActivePosition&gt;</code> to track active positions across all strategies:</p>
<pre><code class="typescript"><span class="hl-0">// Key format: `${strategyName}:${symbol}`</span><br/><span class="hl-0">// Example: &quot;my-strategy:BTCUSDT&quot;</span><br/><span class="hl-10">_activePositions</span><span class="hl-2">: </span><span class="hl-6">Map</span><span class="hl-2">&lt;</span><span class="hl-6">string</span><span class="hl-2">, </span><span class="hl-6">IRiskActivePosition</span><span class="hl-2">&gt;</span>
</code><button type="button">Copy</button></pre>

<p>The map stores position metadata without full signal details:</p>
<pre><code class="typescript"><span class="hl-3">interface</span><span class="hl-2"> </span><span class="hl-11">IRiskActivePosition</span><span class="hl-2"> {</span><br/><span class="hl-2">  </span><span class="hl-6">signal</span><span class="hl-2">: </span><span class="hl-11">ISignalRow</span><span class="hl-2">;        </span><span class="hl-0">// Signal details (set to null in practice)</span><br/><span class="hl-2">  </span><span class="hl-6">strategyName</span><span class="hl-2">: </span><span class="hl-11">string</span><span class="hl-2">;      </span><span class="hl-0">// Strategy that opened position</span><br/><span class="hl-2">  </span><span class="hl-6">exchangeName</span><span class="hl-2">: </span><span class="hl-11">string</span><span class="hl-2">;      </span><span class="hl-0">// Exchange name (empty in practice)</span><br/><span class="hl-2">  </span><span class="hl-6">openTimestamp</span><span class="hl-2">: </span><span class="hl-11">number</span><span class="hl-2">;     </span><span class="hl-0">// Timestamp when position opened</span><br/><span class="hl-2">}</span>
</code><button type="button">Copy</button></pre>

<a id="position-lifecycle" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Position Lifecycle<a href="#position-lifecycle" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><img src="../media/28_Risk_Schemas_2.svg" alt="Mermaid Diagram"></p>
<p><strong>Diagram: Position Tracking Lifecycle</strong></p>
<p>Position tracking operations:</p>
<ol>
<li>
<p><strong>addSignal()</strong>: Called by <code>StrategyConnectionService</code> after signal opens (<a href="">src/client/ClientRisk.ts:107-128</a>)</p>
<ul>
<li>Generates key: <code>GET_KEY_FN(strategyName, symbol)</code></li>
<li>Adds entry to <code>_activePositions</code> Map</li>
<li>Persists updated Map to disk via <code>_updatePositions()</code></li>
</ul>
</li>
<li>
<p><strong>removeSignal()</strong>: Called when signal closes (<a href="">src/client/ClientRisk.ts:134-150</a>)</p>
<ul>
<li>Uses same key generation for lookup</li>
<li>Removes entry from Map</li>
<li>Persists updated Map to disk</li>
</ul>
</li>
<li>
<p><strong>checkSignal()</strong>: Exposes position count and list to validations (<a href="">src/client/ClientRisk.ts:165-217</a>)</p>
<ul>
<li>Provides <code>activePositionCount = riskMap.size</code></li>
<li>Provides <code>activePositions = Array.from(riskMap.values())</code></li>
</ul>
</li>
</ol>
<a id="risk-isolation" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Risk Isolation<a href="#risk-isolation" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Each <code>riskName</code> maintains independent position tracking:</p>
<p><img src="../media/28_Risk_Schemas_3.svg" alt="Mermaid Diagram"></p>
<p><strong>Diagram: Risk Profile Isolation via Memoization</strong></p>
<p>Each risk profile gets its own <code>ClientRisk</code> instance via memoization in <code>RiskConnectionService.getRisk()</code>. The memoization key is the <code>riskName</code>, ensuring complete isolation between risk profiles.</p>
<hr>
<a id="callbacks" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Callbacks<a href="#callbacks" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><a id="iriskcallbacks-interface" class="tsd-anchor"></a><h3 class="tsd-anchor-link">IRiskCallbacks Interface<a href="#iriskcallbacks-interface" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><pre><code class="typescript"><span class="hl-3">interface</span><span class="hl-2"> </span><span class="hl-11">IRiskCallbacks</span><span class="hl-2"> {</span><br/><span class="hl-2">  </span><span class="hl-0">/** Called when signal rejected due to risk limits */</span><br/><span class="hl-2">  </span><span class="hl-1">onRejected</span><span class="hl-2">: (</span><span class="hl-6">symbol</span><span class="hl-2">: </span><span class="hl-11">string</span><span class="hl-2">, </span><span class="hl-6">params</span><span class="hl-2">: </span><span class="hl-11">IRiskCheckArgs</span><span class="hl-2">) </span><span class="hl-3">=&gt;</span><span class="hl-2"> </span><span class="hl-11">void</span><span class="hl-2">;</span><br/><span class="hl-2">  </span><br/><span class="hl-2">  </span><span class="hl-0">/** Called when signal passes risk checks */</span><br/><span class="hl-2">  </span><span class="hl-1">onAllowed</span><span class="hl-2">: (</span><span class="hl-6">symbol</span><span class="hl-2">: </span><span class="hl-11">string</span><span class="hl-2">, </span><span class="hl-6">params</span><span class="hl-2">: </span><span class="hl-11">IRiskCheckArgs</span><span class="hl-2">) </span><span class="hl-3">=&gt;</span><span class="hl-2"> </span><span class="hl-11">void</span><span class="hl-2">;</span><br/><span class="hl-2">}</span>
</code><button type="button">Copy</button></pre>

<p>Callbacks are invoked after all validations complete:</p>
<ul>
<li><strong>onRejected</strong>: Called when any validation throws an error (<a href="">src/client/ClientRisk.ts:203-208</a>)</li>
<li><strong>onAllowed</strong>: Called when all validations pass (<a href="">src/client/ClientRisk.ts:212-214</a>)</li>
</ul>
<p>Both callbacks receive the original <code>IRiskCheckArgs</code> (without portfolio state additions).</p>
<p><strong>Example usage</strong>:</p>
<pre><code class="typescript"><span class="hl-1">addRisk</span><span class="hl-2">({</span><br/><span class="hl-2">  </span><span class="hl-6">riskName:</span><span class="hl-2"> </span><span class="hl-4">&quot;monitored-risk&quot;</span><span class="hl-2">,</span><br/><span class="hl-2">  </span><span class="hl-6">validations:</span><span class="hl-2"> [</span><br/><span class="hl-2">    ({ </span><span class="hl-6">activePositionCount</span><span class="hl-2"> }) </span><span class="hl-3">=&gt;</span><span class="hl-2"> {</span><br/><span class="hl-2">      </span><span class="hl-5">if</span><span class="hl-2"> (</span><span class="hl-6">activePositionCount</span><span class="hl-2"> &gt;= </span><span class="hl-7">3</span><span class="hl-2">) {</span><br/><span class="hl-2">        </span><span class="hl-5">throw</span><span class="hl-2"> </span><span class="hl-3">new</span><span class="hl-2"> </span><span class="hl-1">Error</span><span class="hl-2">(</span><span class="hl-4">&quot;Max 3 positions&quot;</span><span class="hl-2">);</span><br/><span class="hl-2">      }</span><br/><span class="hl-2">    }</span><br/><span class="hl-2">  ],</span><br/><span class="hl-2">  </span><span class="hl-6">callbacks:</span><span class="hl-2"> {</span><br/><span class="hl-2">    </span><span class="hl-1">onRejected</span><span class="hl-6">:</span><span class="hl-2"> (</span><span class="hl-6">symbol</span><span class="hl-2">, </span><span class="hl-6">params</span><span class="hl-2">) </span><span class="hl-3">=&gt;</span><span class="hl-2"> {</span><br/><span class="hl-2">      </span><span class="hl-6">console</span><span class="hl-2">.</span><span class="hl-1">log</span><span class="hl-2">(</span><span class="hl-4">`[RISK REJECTED] </span><span class="hl-3">${</span><span class="hl-6">symbol</span><span class="hl-3">}</span><span class="hl-4"> by </span><span class="hl-3">${</span><span class="hl-6">params</span><span class="hl-9">.</span><span class="hl-6">strategyName</span><span class="hl-3">}</span><span class="hl-4">`</span><span class="hl-2">);</span><br/><span class="hl-2">    },</span><br/><span class="hl-2">    </span><span class="hl-1">onAllowed</span><span class="hl-6">:</span><span class="hl-2"> (</span><span class="hl-6">symbol</span><span class="hl-2">, </span><span class="hl-6">params</span><span class="hl-2">) </span><span class="hl-3">=&gt;</span><span class="hl-2"> {</span><br/><span class="hl-2">      </span><span class="hl-6">console</span><span class="hl-2">.</span><span class="hl-1">log</span><span class="hl-2">(</span><span class="hl-4">`[RISK ALLOWED] </span><span class="hl-3">${</span><span class="hl-6">symbol</span><span class="hl-3">}</span><span class="hl-4"> by </span><span class="hl-3">${</span><span class="hl-6">params</span><span class="hl-9">.</span><span class="hl-6">strategyName</span><span class="hl-3">}</span><span class="hl-4">`</span><span class="hl-2">);</span><br/><span class="hl-2">    }</span><br/><span class="hl-2">  }</span><br/><span class="hl-2">});</span>
</code><button type="button">Copy</button></pre>

<hr>
<a id="registration-and-usage" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Registration and Usage<a href="#registration-and-usage" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><a id="registration-via-addrisk" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Registration via addRisk()<a href="#registration-via-addrisk" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><img src="../media/28_Risk_Schemas_4.svg" alt="Mermaid Diagram"></p>
<p><strong>Diagram: Risk Schema Registration Flow</strong></p>
<p>The <code>addRisk()</code> function performs two operations:</p>
<ol>
<li><strong>Validation</strong>: Ensures no duplicate <code>riskName</code> exists (<a href="">src/function/add.ts:332-336</a>)</li>
<li><strong>Storage</strong>: Registers schema in <code>RiskSchemaService</code> (<a href="">src/function/add.ts:337-340</a>)</li>
</ol>
<p><strong>Example registration</strong>:</p>
<pre><code class="typescript"><span class="hl-5">import</span><span class="hl-2"> { </span><span class="hl-6">addRisk</span><span class="hl-2"> } </span><span class="hl-5">from</span><span class="hl-2"> </span><span class="hl-4">&quot;backtest-kit&quot;</span><span class="hl-2">;</span><br/><br/><span class="hl-1">addRisk</span><span class="hl-2">({</span><br/><span class="hl-2">  </span><span class="hl-6">riskName:</span><span class="hl-2"> </span><span class="hl-4">&quot;conservative&quot;</span><span class="hl-2">,</span><br/><span class="hl-2">  </span><span class="hl-6">note:</span><span class="hl-2"> </span><span class="hl-4">&quot;Conservative risk management with tight position limits&quot;</span><span class="hl-2">,</span><br/><span class="hl-2">  </span><span class="hl-6">validations:</span><span class="hl-2"> [</span><br/><span class="hl-2">    {</span><br/><span class="hl-2">      </span><span class="hl-1">validate</span><span class="hl-6">:</span><span class="hl-2"> ({ </span><span class="hl-6">activePositionCount</span><span class="hl-2"> }) </span><span class="hl-3">=&gt;</span><span class="hl-2"> {</span><br/><span class="hl-2">        </span><span class="hl-5">if</span><span class="hl-2"> (</span><span class="hl-6">activePositionCount</span><span class="hl-2"> &gt;= </span><span class="hl-7">5</span><span class="hl-2">) {</span><br/><span class="hl-2">          </span><span class="hl-5">throw</span><span class="hl-2"> </span><span class="hl-3">new</span><span class="hl-2"> </span><span class="hl-1">Error</span><span class="hl-2">(</span><span class="hl-4">&quot;Maximum 5 concurrent positions allowed&quot;</span><span class="hl-2">);</span><br/><span class="hl-2">        }</span><br/><span class="hl-2">      },</span><br/><span class="hl-2">      </span><span class="hl-6">note:</span><span class="hl-2"> </span><span class="hl-4">&quot;Limit concurrent positions to 5&quot;</span><br/><span class="hl-2">    },</span><br/><span class="hl-2">    ({ </span><span class="hl-6">symbol</span><span class="hl-2"> }) </span><span class="hl-3">=&gt;</span><span class="hl-2"> {</span><br/><span class="hl-2">      </span><span class="hl-5">if</span><span class="hl-2"> (</span><span class="hl-6">symbol</span><span class="hl-2"> === </span><span class="hl-4">&quot;DOGEUSDT&quot;</span><span class="hl-2">) {</span><br/><span class="hl-2">        </span><span class="hl-5">throw</span><span class="hl-2"> </span><span class="hl-3">new</span><span class="hl-2"> </span><span class="hl-1">Error</span><span class="hl-2">(</span><span class="hl-4">&quot;DOGE trading not allowed&quot;</span><span class="hl-2">);</span><br/><span class="hl-2">      }</span><br/><span class="hl-2">    }</span><br/><span class="hl-2">  ],</span><br/><span class="hl-2">  </span><span class="hl-6">callbacks:</span><span class="hl-2"> {</span><br/><span class="hl-2">    </span><span class="hl-1">onRejected</span><span class="hl-6">:</span><span class="hl-2"> (</span><span class="hl-6">symbol</span><span class="hl-2">, </span><span class="hl-6">params</span><span class="hl-2">) </span><span class="hl-3">=&gt;</span><span class="hl-2"> {</span><br/><span class="hl-2">      </span><span class="hl-6">console</span><span class="hl-2">.</span><span class="hl-1">log</span><span class="hl-2">(</span><span class="hl-4">`Risk rejected signal for </span><span class="hl-3">${</span><span class="hl-6">symbol</span><span class="hl-3">}</span><span class="hl-4">`</span><span class="hl-2">);</span><br/><span class="hl-2">    },</span><br/><span class="hl-2">    </span><span class="hl-1">onAllowed</span><span class="hl-6">:</span><span class="hl-2"> (</span><span class="hl-6">symbol</span><span class="hl-2">, </span><span class="hl-6">params</span><span class="hl-2">) </span><span class="hl-3">=&gt;</span><span class="hl-2"> {</span><br/><span class="hl-2">      </span><span class="hl-6">console</span><span class="hl-2">.</span><span class="hl-1">log</span><span class="hl-2">(</span><span class="hl-4">`Risk allowed signal for </span><span class="hl-3">${</span><span class="hl-6">symbol</span><span class="hl-3">}</span><span class="hl-4">`</span><span class="hl-2">);</span><br/><span class="hl-2">    }</span><br/><span class="hl-2">  }</span><br/><span class="hl-2">});</span>
</code><button type="button">Copy</button></pre>

<a id="referencing-from-strategies" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Referencing from Strategies<a href="#referencing-from-strategies" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Strategies reference risk profiles via the <code>riskName</code> field:</p>
<pre><code class="typescript"><span class="hl-5">import</span><span class="hl-2"> { </span><span class="hl-6">addStrategy</span><span class="hl-2">, </span><span class="hl-6">addRisk</span><span class="hl-2"> } </span><span class="hl-5">from</span><span class="hl-2"> </span><span class="hl-4">&quot;backtest-kit&quot;</span><span class="hl-2">;</span><br/><br/><span class="hl-0">// Register risk profile first</span><br/><span class="hl-1">addRisk</span><span class="hl-2">({</span><br/><span class="hl-2">  </span><span class="hl-6">riskName:</span><span class="hl-2"> </span><span class="hl-4">&quot;my-risk&quot;</span><span class="hl-2">,</span><br/><span class="hl-2">  </span><span class="hl-6">validations:</span><span class="hl-2"> [</span><br/><span class="hl-2">    ({ </span><span class="hl-6">activePositionCount</span><span class="hl-2"> }) </span><span class="hl-3">=&gt;</span><span class="hl-2"> {</span><br/><span class="hl-2">      </span><span class="hl-5">if</span><span class="hl-2"> (</span><span class="hl-6">activePositionCount</span><span class="hl-2"> &gt;= </span><span class="hl-7">3</span><span class="hl-2">) {</span><br/><span class="hl-2">        </span><span class="hl-5">throw</span><span class="hl-2"> </span><span class="hl-3">new</span><span class="hl-2"> </span><span class="hl-1">Error</span><span class="hl-2">(</span><span class="hl-4">&quot;Max 3 positions&quot;</span><span class="hl-2">);</span><br/><span class="hl-2">      }</span><br/><span class="hl-2">    }</span><br/><span class="hl-2">  ]</span><br/><span class="hl-2">});</span><br/><br/><span class="hl-0">// Reference from strategy</span><br/><span class="hl-1">addStrategy</span><span class="hl-2">({</span><br/><span class="hl-2">  </span><span class="hl-6">strategyName:</span><span class="hl-2"> </span><span class="hl-4">&quot;my-strategy&quot;</span><span class="hl-2">,</span><br/><span class="hl-2">  </span><span class="hl-6">interval:</span><span class="hl-2"> </span><span class="hl-4">&quot;5m&quot;</span><span class="hl-2">,</span><br/><span class="hl-2">  </span><span class="hl-6">riskName:</span><span class="hl-2"> </span><span class="hl-4">&quot;my-risk&quot;</span><span class="hl-2">,  </span><span class="hl-0">// Reference the risk profile</span><br/><span class="hl-2">  </span><span class="hl-1">getSignal</span><span class="hl-6">:</span><span class="hl-2"> </span><span class="hl-3">async</span><span class="hl-2"> (</span><span class="hl-6">symbol</span><span class="hl-2">) </span><span class="hl-3">=&gt;</span><span class="hl-2"> {</span><br/><span class="hl-2">    </span><span class="hl-0">// Strategy logic...</span><br/><span class="hl-2">    </span><span class="hl-5">return</span><span class="hl-2"> {</span><br/><span class="hl-2">      </span><span class="hl-6">position:</span><span class="hl-2"> </span><span class="hl-4">&quot;long&quot;</span><span class="hl-2">,</span><br/><span class="hl-2">      </span><span class="hl-6">priceTakeProfit:</span><span class="hl-2"> </span><span class="hl-7">51000</span><span class="hl-2">,</span><br/><span class="hl-2">      </span><span class="hl-6">priceStopLoss:</span><span class="hl-2"> </span><span class="hl-7">49000</span><span class="hl-2">,</span><br/><span class="hl-2">      </span><span class="hl-6">minuteEstimatedTime:</span><span class="hl-2"> </span><span class="hl-7">60</span><br/><span class="hl-2">    };</span><br/><span class="hl-2">  }</span><br/><span class="hl-2">});</span>
</code><button type="button">Copy</button></pre>

<p>Multiple strategies can share the same risk profile, enabling cross-strategy position limits.</p>
<hr>
<a id="persistence" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Persistence<a href="#persistence" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><a id="persistriskadapter" class="tsd-anchor"></a><h3 class="tsd-anchor-link">PersistRiskAdapter<a href="#persistriskadapter" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Risk position data is persisted to disk in live mode to enable crash recovery:</p>
<p><img src="../media/28_Risk_Schemas_5.svg" alt="Mermaid Diagram"></p>
<p><strong>Diagram: Risk Position Persistence Flow</strong></p>
<a id="persistence-operations" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Persistence Operations<a href="#persistence-operations" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><strong>Write Operation</strong> (<a href="">src/client/ClientRisk.ts:93-101</a>):</p>
<pre><code class="typescript"><span class="hl-6">private</span><span class="hl-2"> </span><span class="hl-6">async</span><span class="hl-2"> </span><span class="hl-1">_updatePositions</span><span class="hl-2">(): </span><span class="hl-11">Promise</span><span class="hl-2">&lt;</span><span class="hl-3">void</span><span class="hl-2">&gt; {</span><br/><span class="hl-2">  </span><span class="hl-1">if</span><span class="hl-2"> (this._activePositions === </span><span class="hl-6">POSITION_NEED_FETCH</span><span class="hl-2">) {</span><br/><span class="hl-2">    </span><span class="hl-5">await</span><span class="hl-2"> </span><span class="hl-3">this</span><span class="hl-2">.</span><span class="hl-1">waitForInit</span><span class="hl-2">();</span><br/><span class="hl-2">  }</span><br/><span class="hl-2">  await PersistRiskAdapter.writePositionData(</span><br/><span class="hl-2">    Array.from(&lt;RiskMap&gt;this._activePositions),  </span><span class="hl-0">// Convert Map to Array</span><br/><span class="hl-2">    this.params.</span><span class="hl-6">riskName</span><br/><span class="hl-2">  );</span><br/><span class="hl-2">}</span>
</code><button type="button">Copy</button></pre>

<p><strong>Read Operation</strong> (<a href="">src/client/ClientRisk.ts:53-59</a>):</p>
<pre><code class="typescript"><span class="hl-5">export</span><span class="hl-2"> </span><span class="hl-3">const</span><span class="hl-2"> </span><span class="hl-1">WAIT_FOR_INIT_FN</span><span class="hl-2"> = </span><span class="hl-3">async</span><span class="hl-2"> (</span><span class="hl-6">self</span><span class="hl-2">: </span><span class="hl-11">ClientRisk</span><span class="hl-2">): </span><span class="hl-11">Promise</span><span class="hl-2">&lt;</span><span class="hl-11">void</span><span class="hl-2">&gt; </span><span class="hl-3">=&gt;</span><span class="hl-2"> {</span><br/><span class="hl-2">  </span><span class="hl-6">self</span><span class="hl-2">.</span><span class="hl-6">params</span><span class="hl-2">.</span><span class="hl-6">logger</span><span class="hl-2">.</span><span class="hl-1">debug</span><span class="hl-2">(</span><span class="hl-4">&quot;ClientRisk waitForInit&quot;</span><span class="hl-2">);</span><br/><span class="hl-2">  </span><span class="hl-3">const</span><span class="hl-2"> </span><span class="hl-8">persistedPositions</span><span class="hl-2"> = </span><span class="hl-5">await</span><span class="hl-2"> </span><span class="hl-6">PersistRiskAdapter</span><span class="hl-2">.</span><span class="hl-1">readPositionData</span><span class="hl-2">(</span><br/><span class="hl-2">    </span><span class="hl-6">self</span><span class="hl-2">.</span><span class="hl-6">params</span><span class="hl-2">.</span><span class="hl-6">riskName</span><br/><span class="hl-2">  );</span><br/><span class="hl-2">  </span><span class="hl-6">self</span><span class="hl-2">.</span><span class="hl-6">_activePositions</span><span class="hl-2"> = </span><span class="hl-3">new</span><span class="hl-2"> </span><span class="hl-1">Map</span><span class="hl-2">(</span><span class="hl-6">persistedPositions</span><span class="hl-2">);  </span><span class="hl-0">// Convert Array to Map</span><br/><span class="hl-2">};</span>
</code><button type="button">Copy</button></pre>

<a id="data-format" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Data Format<a href="#data-format" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Persisted data is stored as an array of tuples:</p>
<pre><code class="typescript"><span class="hl-3">type</span><span class="hl-2"> </span><span class="hl-11">PersistedPositions</span><span class="hl-2"> = </span><span class="hl-11">Array</span><span class="hl-2">&lt;[</span><br/><span class="hl-2">  </span><span class="hl-11">string</span><span class="hl-2">,                    </span><span class="hl-0">// Key: &quot;${strategyName}:${symbol}&quot;</span><br/><span class="hl-2">  </span><span class="hl-11">IRiskActivePosition</span><span class="hl-2">        </span><span class="hl-0">// Position metadata</span><br/><span class="hl-2">]&gt;</span>
</code><button type="button">Copy</button></pre>

<p>This format allows direct conversion to/from the internal <code>Map&lt;string, IRiskActivePosition&gt;</code> structure.</p>
<hr>
<a id="service-architecture" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Service Architecture<a href="#service-architecture" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p><img src="../media/28_Risk_Schemas_6.svg" alt="Mermaid Diagram"></p>
<p><strong>Diagram: Risk Management Service Architecture</strong></p>
<p>The risk system follows the standard service layer pattern:</p>
<table>
<thead>
<tr>
<th>Layer</th>
<th>Class</th>
<th>Responsibility</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Public API</strong></td>
<td><code>addRisk()</code></td>
<td>Schema registration entry point</td>
</tr>
<tr>
<td><strong>Validation</strong></td>
<td><code>RiskValidationService</code></td>
<td>Duplicate checking, schema validation</td>
</tr>
<tr>
<td><strong>Schema Storage</strong></td>
<td><code>RiskSchemaService</code></td>
<td>ToolRegistry-based schema storage</td>
</tr>
<tr>
<td><strong>Global Service</strong></td>
<td><code>RiskGlobalService</code></td>
<td>Public API for risk operations</td>
</tr>
<tr>
<td><strong>Connection</strong></td>
<td><code>RiskConnectionService</code></td>
<td>Memoized ClientRisk instance management</td>
</tr>
<tr>
<td><strong>Client</strong></td>
<td><code>ClientRisk</code></td>
<td>Business logic: position tracking, validation execution</td>
</tr>
<tr>
<td><strong>Persistence</strong></td>
<td><code>PersistRiskAdapter</code></td>
<td>Crash-safe file writes for live mode</td>
</tr>
</tbody>
</table>
<hr>
<a id="common-validation-patterns" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Common Validation Patterns<a href="#common-validation-patterns" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><a id="maximum-concurrent-positions" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Maximum Concurrent Positions<a href="#maximum-concurrent-positions" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><pre><code class="typescript"><span class="hl-1">addRisk</span><span class="hl-2">({</span><br/><span class="hl-2">  </span><span class="hl-6">riskName:</span><span class="hl-2"> </span><span class="hl-4">&quot;max-positions&quot;</span><span class="hl-2">,</span><br/><span class="hl-2">  </span><span class="hl-6">validations:</span><span class="hl-2"> [</span><br/><span class="hl-2">    ({ </span><span class="hl-6">activePositionCount</span><span class="hl-2"> }) </span><span class="hl-3">=&gt;</span><span class="hl-2"> {</span><br/><span class="hl-2">      </span><span class="hl-5">if</span><span class="hl-2"> (</span><span class="hl-6">activePositionCount</span><span class="hl-2"> &gt;= </span><span class="hl-7">5</span><span class="hl-2">) {</span><br/><span class="hl-2">        </span><span class="hl-5">throw</span><span class="hl-2"> </span><span class="hl-3">new</span><span class="hl-2"> </span><span class="hl-1">Error</span><span class="hl-2">(</span><span class="hl-4">&quot;Maximum 5 concurrent positions allowed&quot;</span><span class="hl-2">);</span><br/><span class="hl-2">      }</span><br/><span class="hl-2">    }</span><br/><span class="hl-2">  ]</span><br/><span class="hl-2">});</span>
</code><button type="button">Copy</button></pre>

<a id="symbol-filtering" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Symbol Filtering<a href="#symbol-filtering" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><pre><code class="typescript"><span class="hl-1">addRisk</span><span class="hl-2">({</span><br/><span class="hl-2">  </span><span class="hl-6">riskName:</span><span class="hl-2"> </span><span class="hl-4">&quot;symbol-filter&quot;</span><span class="hl-2">,</span><br/><span class="hl-2">  </span><span class="hl-6">validations:</span><span class="hl-2"> [</span><br/><span class="hl-2">    ({ </span><span class="hl-6">symbol</span><span class="hl-2"> }) </span><span class="hl-3">=&gt;</span><span class="hl-2"> {</span><br/><span class="hl-2">      </span><span class="hl-3">const</span><span class="hl-2"> </span><span class="hl-8">blacklist</span><span class="hl-2"> = [</span><span class="hl-4">&quot;DOGEUSDT&quot;</span><span class="hl-2">, </span><span class="hl-4">&quot;SHIBUSDT&quot;</span><span class="hl-2">];</span><br/><span class="hl-2">      </span><span class="hl-5">if</span><span class="hl-2"> (</span><span class="hl-6">blacklist</span><span class="hl-2">.</span><span class="hl-1">includes</span><span class="hl-2">(</span><span class="hl-6">symbol</span><span class="hl-2">)) {</span><br/><span class="hl-2">        </span><span class="hl-5">throw</span><span class="hl-2"> </span><span class="hl-3">new</span><span class="hl-2"> </span><span class="hl-1">Error</span><span class="hl-2">(</span><span class="hl-4">`Trading </span><span class="hl-3">${</span><span class="hl-6">symbol</span><span class="hl-3">}</span><span class="hl-4"> not allowed`</span><span class="hl-2">);</span><br/><span class="hl-2">      }</span><br/><span class="hl-2">    }</span><br/><span class="hl-2">  ]</span><br/><span class="hl-2">});</span>
</code><button type="button">Copy</button></pre>

<a id="portfolio-exposure-limits" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Portfolio Exposure Limits<a href="#portfolio-exposure-limits" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><pre><code class="typescript"><span class="hl-1">addRisk</span><span class="hl-2">({</span><br/><span class="hl-2">  </span><span class="hl-6">riskName:</span><span class="hl-2"> </span><span class="hl-4">&quot;exposure-limits&quot;</span><span class="hl-2">,</span><br/><span class="hl-2">  </span><span class="hl-6">validations:</span><span class="hl-2"> [</span><br/><span class="hl-2">    ({ </span><span class="hl-6">activePositions</span><span class="hl-2">, </span><span class="hl-6">symbol</span><span class="hl-2"> }) </span><span class="hl-3">=&gt;</span><span class="hl-2"> {</span><br/><span class="hl-2">      </span><span class="hl-3">const</span><span class="hl-2"> </span><span class="hl-8">symbolPositions</span><span class="hl-2"> = </span><span class="hl-6">activePositions</span><span class="hl-2">.</span><span class="hl-1">filter</span><span class="hl-2">(</span><br/><span class="hl-2">        </span><span class="hl-6">pos</span><span class="hl-2"> </span><span class="hl-3">=&gt;</span><span class="hl-2"> </span><span class="hl-6">pos</span><span class="hl-2">.</span><span class="hl-6">signal</span><span class="hl-2">.</span><span class="hl-6">symbol</span><span class="hl-2"> === </span><span class="hl-6">symbol</span><br/><span class="hl-2">      );</span><br/><span class="hl-2">      </span><span class="hl-5">if</span><span class="hl-2"> (</span><span class="hl-6">symbolPositions</span><span class="hl-2">.</span><span class="hl-6">length</span><span class="hl-2"> &gt;= </span><span class="hl-7">2</span><span class="hl-2">) {</span><br/><span class="hl-2">        </span><span class="hl-5">throw</span><span class="hl-2"> </span><span class="hl-3">new</span><span class="hl-2"> </span><span class="hl-1">Error</span><span class="hl-2">(</span><span class="hl-4">`Max 2 positions per symbol`</span><span class="hl-2">);</span><br/><span class="hl-2">      }</span><br/><span class="hl-2">    }</span><br/><span class="hl-2">  ]</span><br/><span class="hl-2">});</span>
</code><button type="button">Copy</button></pre>

<a id="strategy-specific-limits" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Strategy-Specific Limits<a href="#strategy-specific-limits" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><pre><code class="typescript"><span class="hl-1">addRisk</span><span class="hl-2">({</span><br/><span class="hl-2">  </span><span class="hl-6">riskName:</span><span class="hl-2"> </span><span class="hl-4">&quot;strategy-limits&quot;</span><span class="hl-2">,</span><br/><span class="hl-2">  </span><span class="hl-6">validations:</span><span class="hl-2"> [</span><br/><span class="hl-2">    ({ </span><span class="hl-6">activePositions</span><span class="hl-2">, </span><span class="hl-6">strategyName</span><span class="hl-2"> }) </span><span class="hl-3">=&gt;</span><span class="hl-2"> {</span><br/><span class="hl-2">      </span><span class="hl-3">const</span><span class="hl-2"> </span><span class="hl-8">strategyPositions</span><span class="hl-2"> = </span><span class="hl-6">activePositions</span><span class="hl-2">.</span><span class="hl-1">filter</span><span class="hl-2">(</span><br/><span class="hl-2">        </span><span class="hl-6">pos</span><span class="hl-2"> </span><span class="hl-3">=&gt;</span><span class="hl-2"> </span><span class="hl-6">pos</span><span class="hl-2">.</span><span class="hl-6">strategyName</span><span class="hl-2"> === </span><span class="hl-6">strategyName</span><br/><span class="hl-2">      );</span><br/><span class="hl-2">      </span><span class="hl-5">if</span><span class="hl-2"> (</span><span class="hl-6">strategyPositions</span><span class="hl-2">.</span><span class="hl-6">length</span><span class="hl-2"> &gt;= </span><span class="hl-7">3</span><span class="hl-2">) {</span><br/><span class="hl-2">        </span><span class="hl-5">throw</span><span class="hl-2"> </span><span class="hl-3">new</span><span class="hl-2"> </span><span class="hl-1">Error</span><span class="hl-2">(</span><span class="hl-4">`Strategy </span><span class="hl-3">${</span><span class="hl-6">strategyName</span><span class="hl-3">}</span><span class="hl-4"> has max 3 positions`</span><span class="hl-2">);</span><br/><span class="hl-2">      }</span><br/><span class="hl-2">    }</span><br/><span class="hl-2">  ]</span><br/><span class="hl-2">});</span>
</code><button type="button">Copy</button></pre>

</div></div><div class="col-sidebar"><div class="page-menu"><div class="tsd-navigation settings"><details class="tsd-accordion"><summary class="tsd-accordion-summary"><h3><svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-chevronDown"></use></svg>Settings</h3></summary><div class="tsd-accordion-details"><div class="tsd-filter-visibility"><span class="settings-label">Member Visibility</span><ul id="tsd-filter-options"><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-protected" name="protected"/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Protected</span></label></li><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-inherited" name="inherited" checked/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Inherited</span></label></li><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-external" name="external"/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>External</span></label></li></ul></div><div class="tsd-theme-toggle"><label class="settings-label" for="tsd-theme">Theme</label><select id="tsd-theme"><option value="os">OS</option><option value="light">Light</option><option value="dark">Dark</option></select></div></div></details></div><details open class="tsd-accordion tsd-page-navigation"><summary class="tsd-accordion-summary"><h3><svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-chevronDown"></use></svg>On This Page</h3></summary><div class="tsd-accordion-details"><a href="#risk-schemas"><span>Risk <wbr/>Schemas</span></a><ul><li><a href="#purpose-and-scope"><span>Purpose and <wbr/>Scope</span></a></li><li><a href="#schema-structure"><span>Schema <wbr/>Structure</span></a></li><li><ul><li><a href="#iriskschema-interface"><span>IRisk<wbr/>Schema <wbr/>Interface</span></a></li></ul></li><li><a href="#validation-functions"><span>Validation <wbr/>Functions</span></a></li><li><ul><li><a href="#validation-types"><span>Validation <wbr/>Types</span></a></li><li><a href="#iriskvalidationpayload"><span>IRisk<wbr/>Validation<wbr/>Payload</span></a></li><li><a href="#validation-execution-flow"><span>Validation <wbr/>Execution <wbr/>Flow</span></a></li></ul></li><li><a href="#position-tracking"><span>Position <wbr/>Tracking</span></a></li><li><ul><li><a href="#active-position-map"><span>Active <wbr/>Position <wbr/>Map</span></a></li><li><a href="#position-lifecycle"><span>Position <wbr/>Lifecycle</span></a></li><li><a href="#risk-isolation"><span>Risk <wbr/>Isolation</span></a></li></ul></li><li><a href="#callbacks"><span>Callbacks</span></a></li><li><ul><li><a href="#iriskcallbacks-interface"><span>IRisk<wbr/>Callbacks <wbr/>Interface</span></a></li></ul></li><li><a href="#registration-and-usage"><span>Registration and <wbr/>Usage</span></a></li><li><ul><li><a href="#registration-via-addrisk"><span>Registration via add<wbr/>Risk()</span></a></li><li><a href="#referencing-from-strategies"><span>Referencing from <wbr/>Strategies</span></a></li></ul></li><li><a href="#persistence"><span>Persistence</span></a></li><li><ul><li><a href="#persistriskadapter"><span>Persist<wbr/>Risk<wbr/>Adapter</span></a></li><li><a href="#persistence-operations"><span>Persistence <wbr/>Operations</span></a></li><li><a href="#data-format"><span>Data <wbr/>Format</span></a></li></ul></li><li><a href="#service-architecture"><span>Service <wbr/>Architecture</span></a></li><li><a href="#common-validation-patterns"><span>Common <wbr/>Validation <wbr/>Patterns</span></a></li><li><ul><li><a href="#maximum-concurrent-positions"><span>Maximum <wbr/>Concurrent <wbr/>Positions</span></a></li><li><a href="#symbol-filtering"><span>Symbol <wbr/>Filtering</span></a></li><li><a href="#portfolio-exposure-limits"><span>Portfolio <wbr/>Exposure <wbr/>Limits</span></a></li><li><a href="#strategy-specific-limits"><span>Strategy-<wbr/>Specific <wbr/>Limits</span></a></li></ul></li></ul></div></details></div><div class="site-menu"><nav class="tsd-navigation"><a href="../modules.html">backtest-kit</a><ul class="tsd-small-nested-navigation" id="tsd-nav-container"><li>Loading...</li></ul></nav></div></div></div><footer><p class="tsd-generator">Generated using <a href="https://typedoc.org/" target="_blank">TypeDoc</a></p></footer><div class="overlay"></div></body></html>

<!-- Yandex.Metrika counter -->
<script type="text/javascript">
    (function(m,e,t,r,i,k,a){
        m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
        m[i].l=1*new Date();
        for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }}
        k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)
    })(window, document,'script','https://mc.yandex.ru/metrika/tag.js?id=105455585', 'ym');

    ym(105455585, 'init', {ssr:true, webvisor:true, clickmap:true, ecommerce:"dataLayer", accurateTrackBounce:true, trackLinks:true});
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/105455585" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
<!-- /Yandex.Metrika counter -->

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-3MQZEBBDDR"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-3MQZEBBDDR');
</script>
