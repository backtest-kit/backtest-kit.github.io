<!DOCTYPE html><html class="default" lang="en" data-base=".."><head><meta charset="utf-8"/><meta http-equiv="x-ua-compatible" content="IE=edge"/><title>design/36_exchanges-data-sources | backtest-kit</title><meta name="description" content="Documentation for backtest-kit"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="stylesheet" href="../assets/style.css"/><link rel="stylesheet" href="../assets/highlight.css"/><script defer src="../assets/main.js"></script><script async src="../assets/icons.js" id="tsd-icons-script"></script><script async src="../assets/search.js" id="tsd-search-script"></script><script async src="../assets/navigation.js" id="tsd-nav-script"></script><script async src="../assets/hierarchy.js" id="tsd-hierarchy-script"></script></head><body><script>document.documentElement.dataset.theme = localStorage.getItem("tsd-theme") || "os";document.body.style.display="none";setTimeout(() => app?app.showPage():document.body.style.removeProperty("display"),500)</script><header class="tsd-page-toolbar"><div class="tsd-toolbar-contents container"><div class="table-cell" id="tsd-search"><div class="field"><label for="tsd-search-field" class="tsd-widget tsd-toolbar-icon search no-caption"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-search"></use></svg></label><input type="text" id="tsd-search-field" aria-label="Search"/></div><div class="field"><div id="tsd-toolbar-links"></div></div><ul class="results"><li class="state loading">Preparing search index...</li><li class="state failure">The search index is not available</li></ul><a href="../index.html" class="title">backtest-kit</a></div><div class="table-cell" id="tsd-widgets"><a href="#" class="tsd-widget tsd-toolbar-icon menu no-caption" data-toggle="menu" aria-label="Menu"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-menu"></use></svg></a></div></div></header><div class="container container-main"><div class="col-content"><div class="tsd-page-title"><ul class="tsd-breadcrumb"><li><a href="../modules.html">backtest-kit</a></li><li><a href="design_36_exchanges-data-sources.html">design/36_exchanges-data-sources</a></li></ul></div><div class="tsd-panel tsd-typography"><a id="exchanges--data-sources" class="tsd-anchor"></a><h1 class="tsd-anchor-link">Exchanges &amp; Data Sources<a href="#exchanges--data-sources" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h1><a id="purpose-and-scope" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Purpose and Scope<a href="#purpose-and-scope" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>This page documents how to configure exchanges and data sources in Backtest Kit. Exchanges provide historical and real-time market data (OHLCV candles) and handle price/quantity formatting according to exchange-specific precision rules. The framework supports any data source that implements the required interface, including CCXT, custom APIs, databases, or CSV files.</p>
<p>For information about using candle data within strategies, see <a href="design_25_strategy-development.html">Multi-Timeframe Analysis</a>. For execution context propagation, see <a href="design_08_core-concepts.html">Execution Contexts</a>. For VWAP pricing details, see <a href="design_08_core-concepts.html">VWAP Pricing &amp; Data Handling</a>.</p>
<hr>
<a id="exchange-schema-definition" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Exchange Schema Definition<a href="#exchange-schema-definition" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><a id="iexchangeschema-interface" class="tsd-anchor"></a><h3 class="tsd-anchor-link">IExchangeSchema Interface<a href="#iexchangeschema-interface" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Exchanges are registered using the <code>IExchangeSchema</code> interface, which defines the contract for data fetching and formatting operations.</p>
<p><img src="../media/36_exchanges-data-sources_0.svg" alt="Mermaid Diagram"></p>
<p><strong>Interface Structure:</strong></p>
<table>
<thead>
<tr>
<th>Property</th>
<th>Type</th>
<th>Required</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>exchangeName</code></td>
<td><code>ExchangeName</code> (string)</td>
<td>Yes</td>
<td>Unique identifier for the exchange</td>
</tr>
<tr>
<td><code>getCandles</code></td>
<td>Function</td>
<td>Yes</td>
<td>Fetches OHLCV candle data</td>
</tr>
<tr>
<td><code>formatPrice</code></td>
<td>Function</td>
<td>Yes</td>
<td>Formats price to exchange precision</td>
</tr>
<tr>
<td><code>formatQuantity</code></td>
<td>Function</td>
<td>Yes</td>
<td>Formats quantity to exchange precision</td>
</tr>
<tr>
<td><code>note</code></td>
<td>string</td>
<td>No</td>
<td>Developer documentation</td>
</tr>
<tr>
<td><code>callbacks</code></td>
<td><code>Partial&lt;IExchangeCallbacks&gt;</code></td>
<td>No</td>
<td>Lifecycle event callbacks</td>
</tr>
</tbody>
</table>
<hr>
<a id="registering-an-exchange" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Registering an Exchange<a href="#registering-an-exchange" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><a id="addexchange-function" class="tsd-anchor"></a><h3 class="tsd-anchor-link">addExchange Function<a href="#addexchange-function" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>The <code>addExchange</code> global function registers an exchange schema. The framework validates uniqueness of <code>exchangeName</code> and stores the schema in the registry.</p>
<pre><code class="typescript"><span class="hl-3">import</span><span class="hl-1"> { </span><span class="hl-4">addExchange</span><span class="hl-1"> } </span><span class="hl-3">from</span><span class="hl-1"> </span><span class="hl-2">&#39;backtest-kit&#39;</span><span class="hl-1">;</span><br/><br/><span class="hl-0">addExchange</span><span class="hl-1">({</span><br/><span class="hl-1">  </span><span class="hl-4">exchangeName:</span><span class="hl-1"> </span><span class="hl-2">&quot;binance&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">note:</span><span class="hl-1"> </span><span class="hl-2">&quot;Binance production data source&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><br/><span class="hl-1">  </span><span class="hl-0">getCandles</span><span class="hl-4">:</span><span class="hl-1"> </span><span class="hl-7">async</span><span class="hl-1"> (</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">interval</span><span class="hl-1">, </span><span class="hl-4">since</span><span class="hl-1">, </span><span class="hl-4">limit</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-5">// Implementation here</span><br/><span class="hl-1">    </span><span class="hl-3">return</span><span class="hl-1"> </span><span class="hl-4">candles</span><span class="hl-1">;</span><br/><span class="hl-1">  },</span><br/><span class="hl-1">  </span><br/><span class="hl-1">  </span><span class="hl-0">formatPrice</span><span class="hl-4">:</span><span class="hl-1"> </span><span class="hl-7">async</span><span class="hl-1"> (</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">price</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-3">return</span><span class="hl-1"> </span><span class="hl-4">price</span><span class="hl-1">.</span><span class="hl-0">toFixed</span><span class="hl-1">(</span><span class="hl-6">2</span><span class="hl-1">);</span><br/><span class="hl-1">  },</span><br/><span class="hl-1">  </span><br/><span class="hl-1">  </span><span class="hl-0">formatQuantity</span><span class="hl-4">:</span><span class="hl-1"> </span><span class="hl-7">async</span><span class="hl-1"> (</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">quantity</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-3">return</span><span class="hl-1"> </span><span class="hl-4">quantity</span><span class="hl-1">.</span><span class="hl-0">toFixed</span><span class="hl-1">(</span><span class="hl-6">8</span><span class="hl-1">);</span><br/><span class="hl-1">  },</span><br/><span class="hl-1">  </span><br/><span class="hl-1">  </span><span class="hl-4">callbacks:</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-0">onCandleData</span><span class="hl-4">:</span><span class="hl-1"> (</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">interval</span><span class="hl-1">, </span><span class="hl-4">since</span><span class="hl-1">, </span><span class="hl-4">limit</span><span class="hl-1">, </span><span class="hl-4">data</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">      </span><span class="hl-4">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-2">`Fetched </span><span class="hl-7">${</span><span class="hl-4">data</span><span class="hl-9">.</span><span class="hl-4">length</span><span class="hl-7">}</span><span class="hl-2"> candles`</span><span class="hl-1">);</span><br/><span class="hl-1">    }</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">});</span>
</code><button type="button">Copy</button></pre>

<p><strong>Validation:</strong></p>
<ul>
<li><code>exchangeName</code> must be unique (checked by <code>ExchangeValidationService</code>)</li>
<li>All required methods must be provided</li>
<li>Methods must return promises</li>
</ul>
<hr>
<a id="data-fetching-requirements" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Data Fetching Requirements<a href="#data-fetching-requirements" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><a id="getcandles-method-contract" class="tsd-anchor"></a><h3 class="tsd-anchor-link">getCandles Method Contract<a href="#getcandles-method-contract" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>The <code>getCandles</code> method is the core data fetching interface. It must return historical OHLCV candles according to the specified parameters.</p>
<p><strong>Signature:</strong></p>
<pre><code class="typescript"><span class="hl-10">getCandles</span><span class="hl-1">: (</span><br/><span class="hl-1">  </span><span class="hl-4">symbol</span><span class="hl-1">: </span><span class="hl-4">string</span><span class="hl-1">,        </span><span class="hl-5">// Trading pair (e.g., &quot;BTCUSDT&quot;)</span><br/><span class="hl-1">  </span><span class="hl-4">interval</span><span class="hl-1">: </span><span class="hl-4">CandleInterval</span><span class="hl-1">,  </span><span class="hl-5">// &quot;1m&quot; | &quot;3m&quot; | &quot;5m&quot; | &quot;15m&quot; | &quot;30m&quot; | &quot;1h&quot; | &quot;2h&quot; | &quot;4h&quot; | &quot;6h&quot; | &quot;8h&quot;</span><br/><span class="hl-1">  </span><span class="hl-4">since</span><span class="hl-1">: </span><span class="hl-4">Date</span><span class="hl-1">,          </span><span class="hl-5">// Start date for fetching</span><br/><span class="hl-1">  </span><span class="hl-4">limit</span><span class="hl-1">: </span><span class="hl-4">number</span><span class="hl-1">         </span><span class="hl-5">// Maximum number of candles to return</span><br/><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> </span><span class="hl-13">Promise</span><span class="hl-1">&lt;</span><span class="hl-4">ICandleData</span><span class="hl-1">[]&gt;</span>
</code><button type="button">Copy</button></pre>

<p><strong>ICandleData Structure:</strong></p>
<p><img src="../media/36_exchanges-data-sources_1.svg" alt="Mermaid Diagram"></p>
<table>
<thead>
<tr>
<th>Field</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>timestamp</code></td>
<td>number</td>
<td>Unix timestamp in milliseconds when candle opened</td>
</tr>
<tr>
<td><code>open</code></td>
<td>number</td>
<td>Opening price at candle start</td>
</tr>
<tr>
<td><code>high</code></td>
<td>number</td>
<td>Highest price during candle period</td>
</tr>
<tr>
<td><code>low</code></td>
<td>number</td>
<td>Lowest price during candle period</td>
</tr>
<tr>
<td><code>close</code></td>
<td>number</td>
<td>Closing price at candle end</td>
</tr>
<tr>
<td><code>volume</code></td>
<td>number</td>
<td>Trading volume during candle period</td>
</tr>
</tbody>
</table>
<p><strong>Temporal Context:</strong> The <code>since</code> parameter represents the current execution timestamp. In backtest mode, it corresponds to the frame iteration timestamp. In live mode, it's the current time minus the requested lookback. This ensures <strong>look-ahead bias prevention</strong> - strategies can never access future data.</p>
<hr>
<a id="internal-data-flow" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Internal Data Flow<a href="#internal-data-flow" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p><img src="../media/36_exchanges-data-sources_2.svg" alt="Mermaid Diagram"></p>
<p><strong>Key Points:</strong></p>
<ul>
<li><code>getCandles()</code> uses <code>when - (limit × interval)</code> to calculate <code>since</code> (backward lookup)</li>
<li><code>getNextCandles()</code> uses <code>when</code> as <code>since</code> (forward lookup for backtest fast mode)</li>
<li><code>ExecutionContextService</code> provides temporal context automatically</li>
<li><code>ExchangeConnectionService</code> memoizes <code>ClientExchange</code> instances by <code>exchangeName</code></li>
</ul>
<hr>
<a id="vwap-pricing" class="tsd-anchor"></a><h2 class="tsd-anchor-link">VWAP Pricing<a href="#vwap-pricing" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><a id="volume-weighted-average-price-calculation" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Volume Weighted Average Price Calculation<a href="#volume-weighted-average-price-calculation" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>VWAP (Volume Weighted Average Price) is used for realistic entry/exit price simulation. The framework calculates VWAP from the last N 1-minute candles (default: 5).</p>
<p><strong>Formula:</strong></p>
<pre><code><span class="hl-4">Typical</span><span class="hl-1"> </span><span class="hl-4">Price</span><span class="hl-1"> = (</span><span class="hl-4">High</span><span class="hl-1"> + </span><span class="hl-4">Low</span><span class="hl-1"> + </span><span class="hl-4">Close</span><span class="hl-1">) / </span><span class="hl-6">3</span><br/><span class="hl-8">VWAP</span><span class="hl-1"> = </span><span class="hl-0">Σ</span><span class="hl-1">(</span><span class="hl-4">Typical</span><span class="hl-1"> </span><span class="hl-4">Price</span><span class="hl-1"> × </span><span class="hl-4">Volume</span><span class="hl-1">) / </span><span class="hl-0">Σ</span><span class="hl-1">(</span><span class="hl-4">Volume</span><span class="hl-1">)</span>
</code><button>Copy</button></pre>

<p><img src="../media/36_exchanges-data-sources_3.svg" alt="Mermaid Diagram"></p>
<p><strong>Configuration:</strong></p>
<ul>
<li><code>CC_AVG_PRICE_CANDLES_COUNT</code> - Number of candles for VWAP (default: 5)</li>
<li>Always uses 1-minute interval for high precision</li>
<li>Falls back to simple average if volume data is unavailable</li>
</ul>
<p><strong>Usage in Signal Execution:</strong></p>
<pre><code class="typescript"><span class="hl-5">// Framework automatically uses VWAP for:</span><br/><span class="hl-5">// 1. Signal activation (scheduled → opened)</span><br/><span class="hl-5">// 2. Take profit detection</span><br/><span class="hl-5">// 3. Stop loss detection</span><br/><span class="hl-5">// 4. Partial profit/loss calculations</span>
</code><button type="button">Copy</button></pre>

<hr>
<a id="data-validation--anomaly-detection" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Data Validation &amp; Anomaly Detection<a href="#data-validation--anomaly-detection" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><a id="incomplete-candle-detection" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Incomplete Candle Detection<a href="#incomplete-candle-detection" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>The framework detects incomplete candles from API responses (e.g., Binance sometimes returns candles with near-zero prices).</p>
<p><strong>Detection Logic:</strong></p>
<p><img src="../media/36_exchanges-data-sources_4.svg" alt="Mermaid Diagram"></p>
<p><strong>Configuration Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Parameter</th>
<th>Default</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>CC_GET_CANDLES_PRICE_ANOMALY_THRESHOLD_FACTOR</code></td>
<td>1000</td>
<td>Max deviation factor for price detection</td>
</tr>
<tr>
<td><code>CC_GET_CANDLES_MIN_CANDLES_FOR_MEDIAN</code></td>
<td>5</td>
<td>Minimum candles for median calculation</td>
</tr>
</tbody>
</table>
<p><strong>Anomaly Detection Algorithm:</strong></p>
<ol>
<li>Collect all OHLC prices from fetched candles</li>
<li>Calculate reference price:
<ul>
<li>If <code>candles.length &gt;= CC_GET_CANDLES_MIN_CANDLES_FOR_MEDIAN</code>: use <strong>median</strong></li>
<li>Otherwise: use <strong>average</strong></li>
</ul>
</li>
<li>Calculate threshold: <code>referencePrice / CC_GET_CANDLES_PRICE_ANOMALY_THRESHOLD_FACTOR</code></li>
<li>Check each candle's OHLC values</li>
<li>If any price &lt; threshold: <strong>throw error</strong></li>
</ol>
<p><strong>Example:</strong></p>
<pre><code class="typescript"><span class="hl-5">// BTC median price: $50,000</span><br/><span class="hl-5">// Threshold: $50,000 / 1000 = $50</span><br/><span class="hl-5">// Incomplete candle with close=$0.01 → DETECTED (0.01 &lt; 50)</span><br/><span class="hl-5">// Normal candle with close=$49,500 → VALID (49500 &gt; 50)</span>
</code><button type="button">Copy</button></pre>

<hr>
<a id="retry-logic" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Retry Logic<a href="#retry-logic" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><a id="failed-fetch-handling" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Failed Fetch Handling<a href="#failed-fetch-handling" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>The framework implements automatic retry logic with exponential backoff for transient network failures.</p>
<p><img src="../media/36_exchanges-data-sources_5.svg" alt="Mermaid Diagram"></p>
<p><strong>Configuration:</strong></p>
<table>
<thead>
<tr>
<th>Parameter</th>
<th>Default</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>CC_GET_CANDLES_RETRY_COUNT</code></td>
<td>3</td>
<td>Maximum retry attempts</td>
</tr>
<tr>
<td><code>CC_GET_CANDLES_RETRY_DELAY_MS</code></td>
<td>5000</td>
<td>Delay between retries (ms)</td>
</tr>
</tbody>
</table>
<p><strong>Retry Triggers:</strong></p>
<ul>
<li>Network errors (connection timeout, DNS failure)</li>
<li>HTTP 429 (rate limit)</li>
<li>HTTP 500/502/503 (server errors)</li>
<li>Anomaly detection failures</li>
</ul>
<hr>
<a id="price-and-quantity-formatting" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Price and Quantity Formatting<a href="#price-and-quantity-formatting" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><a id="exchange-specific-precision" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Exchange-Specific Precision<a href="#exchange-specific-precision" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Exchanges have different precision rules for prices and quantities. The <code>formatPrice</code> and <code>formatQuantity</code> methods ensure values match exchange requirements.</p>
<p><strong>formatPrice Method:</strong></p>
<pre><code class="typescript"><span class="hl-10">formatPrice</span><span class="hl-1">: </span><span class="hl-7">async</span><span class="hl-1"> (</span><span class="hl-4">symbol</span><span class="hl-1">: </span><span class="hl-13">string</span><span class="hl-1">, </span><span class="hl-4">price</span><span class="hl-1">: </span><span class="hl-13">number</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> </span><span class="hl-13">Promise</span><span class="hl-1">&lt;</span><span class="hl-4">string</span><span class="hl-1">&gt;</span>
</code><button type="button">Copy</button></pre>

<p><strong>formatQuantity Method:</strong></p>
<pre><code class="typescript"><span class="hl-10">formatQuantity</span><span class="hl-1">: </span><span class="hl-7">async</span><span class="hl-1"> (</span><span class="hl-4">symbol</span><span class="hl-1">: </span><span class="hl-13">string</span><span class="hl-1">, </span><span class="hl-4">quantity</span><span class="hl-1">: </span><span class="hl-13">number</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> </span><span class="hl-13">Promise</span><span class="hl-1">&lt;</span><span class="hl-4">string</span><span class="hl-1">&gt;</span>
</code><button type="button">Copy</button></pre>

<p><strong>Common Patterns:</strong></p>
<table>
<thead>
<tr>
<th>Exchange</th>
<th>Price Precision</th>
<th>Quantity Precision</th>
<th>Example</th>
</tr>
</thead>
<tbody>
<tr>
<td>Binance</td>
<td>2-8 decimals</td>
<td>8 decimals</td>
<td><code>price.toFixed(2)</code></td>
</tr>
<tr>
<td>Kraken</td>
<td>1-5 decimals</td>
<td>8 decimals</td>
<td><code>price.toFixed(1)</code></td>
</tr>
<tr>
<td>Custom</td>
<td>Variable</td>
<td>Variable</td>
<td>Lookup table</td>
</tr>
</tbody>
</table>
<p><strong>Usage in Framework:</strong></p>
<ul>
<li>Report generation (markdown tables)</li>
<li>Order placement (live trading)</li>
<li>Position size calculations</li>
</ul>
<hr>
<a id="ccxt-integration" class="tsd-anchor"></a><h2 class="tsd-anchor-link">CCXT Integration<a href="#ccxt-integration" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><a id="common-integration-pattern" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Common Integration Pattern<a href="#common-integration-pattern" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>CCXT is a popular cryptocurrency exchange library. Below is the standard pattern for integrating CCXT as a data source.</p>
<p><strong>Basic CCXT Exchange:</strong></p>
<pre><code class="typescript"><span class="hl-3">import</span><span class="hl-1"> </span><span class="hl-4">ccxt</span><span class="hl-1"> </span><span class="hl-3">from</span><span class="hl-1"> </span><span class="hl-2">&#39;ccxt&#39;</span><span class="hl-1">;</span><br/><span class="hl-3">import</span><span class="hl-1"> { </span><span class="hl-4">addExchange</span><span class="hl-1"> } </span><span class="hl-3">from</span><span class="hl-1"> </span><span class="hl-2">&#39;backtest-kit&#39;</span><span class="hl-1">;</span><br/><br/><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">exchange</span><span class="hl-1"> = </span><span class="hl-7">new</span><span class="hl-1"> </span><span class="hl-4">ccxt</span><span class="hl-1">.</span><span class="hl-0">binance</span><span class="hl-1">({</span><br/><span class="hl-1">  </span><span class="hl-5">// Optional: API credentials for live trading</span><br/><span class="hl-1">  </span><span class="hl-4">apiKey:</span><span class="hl-1"> </span><span class="hl-4">process</span><span class="hl-1">.</span><span class="hl-4">env</span><span class="hl-1">.</span><span class="hl-8">BINANCE_API_KEY</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">secret:</span><span class="hl-1"> </span><span class="hl-4">process</span><span class="hl-1">.</span><span class="hl-4">env</span><span class="hl-1">.</span><span class="hl-8">BINANCE_API_SECRET</span><span class="hl-1">,</span><br/><span class="hl-1">});</span><br/><br/><span class="hl-0">addExchange</span><span class="hl-1">({</span><br/><span class="hl-1">  </span><span class="hl-4">exchangeName:</span><span class="hl-1"> </span><span class="hl-2">&#39;binance&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><br/><span class="hl-1">  </span><span class="hl-0">getCandles</span><span class="hl-4">:</span><span class="hl-1"> </span><span class="hl-7">async</span><span class="hl-1"> (</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">interval</span><span class="hl-1">, </span><span class="hl-4">since</span><span class="hl-1">, </span><span class="hl-4">limit</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-5">// CCXT uses different interval format</span><br/><span class="hl-1">    </span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">ohlcv</span><span class="hl-1"> = </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-4">exchange</span><span class="hl-1">.</span><span class="hl-0">fetchOHLCV</span><span class="hl-1">(</span><br/><span class="hl-1">      </span><span class="hl-4">symbol</span><span class="hl-1">,</span><br/><span class="hl-1">      </span><span class="hl-4">interval</span><span class="hl-1">,</span><br/><span class="hl-1">      </span><span class="hl-4">since</span><span class="hl-1">.</span><span class="hl-0">getTime</span><span class="hl-1">(),</span><br/><span class="hl-1">      </span><span class="hl-4">limit</span><br/><span class="hl-1">    );</span><br/><span class="hl-1">    </span><br/><span class="hl-1">    </span><span class="hl-5">// Convert CCXT format [timestamp, o, h, l, c, v] to ICandleData</span><br/><span class="hl-1">    </span><span class="hl-3">return</span><span class="hl-1"> </span><span class="hl-4">ohlcv</span><span class="hl-1">.</span><span class="hl-0">map</span><span class="hl-1">(([</span><span class="hl-4">timestamp</span><span class="hl-1">, </span><span class="hl-4">open</span><span class="hl-1">, </span><span class="hl-4">high</span><span class="hl-1">, </span><span class="hl-4">low</span><span class="hl-1">, </span><span class="hl-4">close</span><span class="hl-1">, </span><span class="hl-4">volume</span><span class="hl-1">]) </span><span class="hl-7">=&gt;</span><span class="hl-1"> ({</span><br/><span class="hl-1">      </span><span class="hl-4">timestamp</span><span class="hl-1">,</span><br/><span class="hl-1">      </span><span class="hl-4">open</span><span class="hl-1">,</span><br/><span class="hl-1">      </span><span class="hl-4">high</span><span class="hl-1">,</span><br/><span class="hl-1">      </span><span class="hl-4">low</span><span class="hl-1">,</span><br/><span class="hl-1">      </span><span class="hl-4">close</span><span class="hl-1">,</span><br/><span class="hl-1">      </span><span class="hl-4">volume</span><span class="hl-1">,</span><br/><span class="hl-1">    }));</span><br/><span class="hl-1">  },</span><br/><span class="hl-1">  </span><br/><span class="hl-1">  </span><span class="hl-0">formatPrice</span><span class="hl-4">:</span><span class="hl-1"> </span><span class="hl-7">async</span><span class="hl-1"> (</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">price</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">market</span><span class="hl-1"> = </span><span class="hl-4">exchange</span><span class="hl-1">.</span><span class="hl-0">market</span><span class="hl-1">(</span><span class="hl-4">symbol</span><span class="hl-1">);</span><br/><span class="hl-1">    </span><span class="hl-3">return</span><span class="hl-1"> </span><span class="hl-4">exchange</span><span class="hl-1">.</span><span class="hl-0">priceToPrecision</span><span class="hl-1">(</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">price</span><span class="hl-1">);</span><br/><span class="hl-1">  },</span><br/><span class="hl-1">  </span><br/><span class="hl-1">  </span><span class="hl-0">formatQuantity</span><span class="hl-4">:</span><span class="hl-1"> </span><span class="hl-7">async</span><span class="hl-1"> (</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">quantity</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">market</span><span class="hl-1"> = </span><span class="hl-4">exchange</span><span class="hl-1">.</span><span class="hl-0">market</span><span class="hl-1">(</span><span class="hl-4">symbol</span><span class="hl-1">);</span><br/><span class="hl-1">    </span><span class="hl-3">return</span><span class="hl-1"> </span><span class="hl-4">exchange</span><span class="hl-1">.</span><span class="hl-0">amountToPrecision</span><span class="hl-1">(</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">quantity</span><span class="hl-1">);</span><br/><span class="hl-1">  },</span><br/><span class="hl-1">});</span>
</code><button type="button">Copy</button></pre>

<p><strong>CCXT-Specific Considerations:</strong></p>
<table>
<thead>
<tr>
<th>Aspect</th>
<th>Solution</th>
</tr>
</thead>
<tbody>
<tr>
<td>Rate limiting</td>
<td>CCXT handles automatically</td>
</tr>
<tr>
<td>Symbol format</td>
<td>Use CCXT unified symbols (e.g., &quot;BTC/USDT&quot;)</td>
</tr>
<tr>
<td>Precision</td>
<td>Use <code>priceToPrecision</code> and <code>amountToPrecision</code></td>
</tr>
<tr>
<td>Error handling</td>
<td>Wrap in try-catch, let retry logic handle</td>
</tr>
</tbody>
</table>
<p><strong>Advanced: Multiple Exchanges:</strong></p>
<pre><code class="typescript"><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">exchanges</span><span class="hl-1"> = {</span><br/><span class="hl-1">  </span><span class="hl-4">binance:</span><span class="hl-1"> </span><span class="hl-7">new</span><span class="hl-1"> </span><span class="hl-4">ccxt</span><span class="hl-1">.</span><span class="hl-0">binance</span><span class="hl-1">(),</span><br/><span class="hl-1">  </span><span class="hl-4">kraken:</span><span class="hl-1"> </span><span class="hl-7">new</span><span class="hl-1"> </span><span class="hl-4">ccxt</span><span class="hl-1">.</span><span class="hl-0">kraken</span><span class="hl-1">(),</span><br/><span class="hl-1">  </span><span class="hl-4">coinbase:</span><span class="hl-1"> </span><span class="hl-7">new</span><span class="hl-1"> </span><span class="hl-4">ccxt</span><span class="hl-1">.</span><span class="hl-0">coinbase</span><span class="hl-1">(),</span><br/><span class="hl-1">};</span><br/><br/><span class="hl-4">Object</span><span class="hl-1">.</span><span class="hl-0">entries</span><span class="hl-1">(</span><span class="hl-4">exchanges</span><span class="hl-1">).</span><span class="hl-0">forEach</span><span class="hl-1">(([</span><span class="hl-4">name</span><span class="hl-1">, </span><span class="hl-4">instance</span><span class="hl-1">]) </span><span class="hl-7">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-0">addExchange</span><span class="hl-1">({</span><br/><span class="hl-1">    </span><span class="hl-4">exchangeName:</span><span class="hl-1"> </span><span class="hl-4">name</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-0">getCandles</span><span class="hl-4">:</span><span class="hl-1"> </span><span class="hl-7">async</span><span class="hl-1"> (</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">interval</span><span class="hl-1">, </span><span class="hl-4">since</span><span class="hl-1">, </span><span class="hl-4">limit</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">      </span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">ohlcv</span><span class="hl-1"> = </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-4">instance</span><span class="hl-1">.</span><span class="hl-0">fetchOHLCV</span><span class="hl-1">(</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">interval</span><span class="hl-1">, </span><span class="hl-4">since</span><span class="hl-1">.</span><span class="hl-0">getTime</span><span class="hl-1">(), </span><span class="hl-4">limit</span><span class="hl-1">);</span><br/><span class="hl-1">      </span><span class="hl-3">return</span><span class="hl-1"> </span><span class="hl-4">ohlcv</span><span class="hl-1">.</span><span class="hl-0">map</span><span class="hl-1">(([</span><span class="hl-4">timestamp</span><span class="hl-1">, </span><span class="hl-4">open</span><span class="hl-1">, </span><span class="hl-4">high</span><span class="hl-1">, </span><span class="hl-4">low</span><span class="hl-1">, </span><span class="hl-4">close</span><span class="hl-1">, </span><span class="hl-4">volume</span><span class="hl-1">]) </span><span class="hl-7">=&gt;</span><span class="hl-1"> ({</span><br/><span class="hl-1">        </span><span class="hl-4">timestamp</span><span class="hl-1">, </span><span class="hl-4">open</span><span class="hl-1">, </span><span class="hl-4">high</span><span class="hl-1">, </span><span class="hl-4">low</span><span class="hl-1">, </span><span class="hl-4">close</span><span class="hl-1">, </span><span class="hl-4">volume</span><br/><span class="hl-1">      }));</span><br/><span class="hl-1">    },</span><br/><span class="hl-1">    </span><span class="hl-0">formatPrice</span><span class="hl-4">:</span><span class="hl-1"> (</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">price</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> </span><span class="hl-4">instance</span><span class="hl-1">.</span><span class="hl-0">priceToPrecision</span><span class="hl-1">(</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">price</span><span class="hl-1">),</span><br/><span class="hl-1">    </span><span class="hl-0">formatQuantity</span><span class="hl-4">:</span><span class="hl-1"> (</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">qty</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> </span><span class="hl-4">instance</span><span class="hl-1">.</span><span class="hl-0">amountToPrecision</span><span class="hl-1">(</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">qty</span><span class="hl-1">),</span><br/><span class="hl-1">  });</span><br/><span class="hl-1">});</span>
</code><button type="button">Copy</button></pre>

<hr>
<a id="clientexchange-architecture" class="tsd-anchor"></a><h2 class="tsd-anchor-link">ClientExchange Architecture<a href="#clientexchange-architecture" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><a id="internal-implementation" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Internal Implementation<a href="#internal-implementation" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><code>ClientExchange</code> is the internal client that wraps exchange schemas and provides additional functionality like VWAP calculation and retry logic.</p>
<p><img src="../media/36_exchanges-data-sources_6.svg" alt="Mermaid Diagram"></p>
<p><strong>Key Architectural Decisions:</strong></p>
<ol>
<li>
<p><strong>Memoization:</strong> <code>ExchangeConnectionService</code> caches <code>ClientExchange</code> instances by <code>exchangeName</code> to prevent redundant instantiation.</p>
</li>
<li>
<p><strong>Prototype Methods:</strong> All methods are defined on the prototype for memory efficiency (shared across instances).</p>
</li>
<li>
<p><strong>Context Injection:</strong> <code>ExecutionContextService</code> provides temporal context (symbol, when, backtest flag) automatically.</p>
</li>
<li>
<p><strong>Separation of Concerns:</strong></p>
<ul>
<li><strong>Schema (IExchangeSchema):</strong> User-defined data fetching logic</li>
<li><strong>Client (ClientExchange):</strong> Framework-provided validation, retry, VWAP</li>
<li><strong>Service (ExchangeConnectionService):</strong> Lifecycle management, routing</li>
</ul>
</li>
</ol>
<hr>
<a id="configuration-reference" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Configuration Reference<a href="#configuration-reference" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><a id="data-fetching-parameters" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Data Fetching Parameters<a href="#data-fetching-parameters" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><table>
<thead>
<tr>
<th>Parameter</th>
<th>Default</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>CC_AVG_PRICE_CANDLES_COUNT</code></td>
<td>5</td>
<td>number</td>
<td>Number of 1m candles for VWAP calculation</td>
</tr>
<tr>
<td><code>CC_GET_CANDLES_RETRY_COUNT</code></td>
<td>3</td>
<td>number</td>
<td>Maximum retry attempts for failed fetches</td>
</tr>
<tr>
<td><code>CC_GET_CANDLES_RETRY_DELAY_MS</code></td>
<td>5000</td>
<td>number</td>
<td>Delay between retry attempts (milliseconds)</td>
</tr>
<tr>
<td><code>CC_GET_CANDLES_PRICE_ANOMALY_THRESHOLD_FACTOR</code></td>
<td>1000</td>
<td>number</td>
<td>Max price deviation factor for anomaly detection</td>
</tr>
<tr>
<td><code>CC_GET_CANDLES_MIN_CANDLES_FOR_MEDIAN</code></td>
<td>5</td>
<td>number</td>
<td>Minimum candles required for median price calculation</td>
</tr>
</tbody>
</table>
<p><strong>Configuration Example:</strong></p>
<pre><code class="typescript"><span class="hl-3">import</span><span class="hl-1"> { </span><span class="hl-4">setConfig</span><span class="hl-1"> } </span><span class="hl-3">from</span><span class="hl-1"> </span><span class="hl-2">&#39;backtest-kit&#39;</span><span class="hl-1">;</span><br/><br/><span class="hl-0">setConfig</span><span class="hl-1">({</span><br/><span class="hl-1">  </span><span class="hl-4">CC_AVG_PRICE_CANDLES_COUNT:</span><span class="hl-1"> </span><span class="hl-6">10</span><span class="hl-1">,  </span><span class="hl-5">// Use 10 candles for VWAP</span><br/><span class="hl-1">  </span><span class="hl-4">CC_GET_CANDLES_RETRY_COUNT:</span><span class="hl-1"> </span><span class="hl-6">5</span><span class="hl-1">,   </span><span class="hl-5">// Retry 5 times on failure</span><br/><span class="hl-1">  </span><span class="hl-4">CC_GET_CANDLES_RETRY_DELAY_MS:</span><span class="hl-1"> </span><span class="hl-6">3000</span><span class="hl-1">,  </span><span class="hl-5">// 3 second delay</span><br/><span class="hl-1">  </span><span class="hl-4">CC_GET_CANDLES_PRICE_ANOMALY_THRESHOLD_FACTOR:</span><span class="hl-1"> </span><span class="hl-6">500</span><span class="hl-1">,  </span><span class="hl-5">// Stricter anomaly detection</span><br/><span class="hl-1">});</span>
</code><button type="button">Copy</button></pre>

<hr>
<a id="exchange-callbacks" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Exchange Callbacks<a href="#exchange-callbacks" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><a id="lifecycle-event-monitoring" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Lifecycle Event Monitoring<a href="#lifecycle-event-monitoring" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>The optional <code>callbacks</code> property in <code>IExchangeSchema</code> allows monitoring data fetching events.</p>
<p><strong>IExchangeCallbacks Interface:</strong></p>
<pre><code class="typescript"><span class="hl-7">interface</span><span class="hl-1"> </span><span class="hl-13">IExchangeCallbacks</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-0">onCandleData</span><span class="hl-1">: (</span><br/><span class="hl-1">    </span><span class="hl-4">symbol</span><span class="hl-1">: </span><span class="hl-13">string</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-4">interval</span><span class="hl-1">: </span><span class="hl-13">CandleInterval</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-4">since</span><span class="hl-1">: </span><span class="hl-13">Date</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-4">limit</span><span class="hl-1">: </span><span class="hl-13">number</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-4">data</span><span class="hl-1">: </span><span class="hl-13">ICandleData</span><span class="hl-1">[]</span><br/><span class="hl-1">  ) </span><span class="hl-7">=&gt;</span><span class="hl-1"> </span><span class="hl-13">void</span><span class="hl-1">;</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<p><strong>Usage Example:</strong></p>
<pre><code class="typescript"><span class="hl-0">addExchange</span><span class="hl-1">({</span><br/><span class="hl-1">  </span><span class="hl-4">exchangeName:</span><span class="hl-1"> </span><span class="hl-2">&quot;binance&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><br/><span class="hl-1">  </span><span class="hl-0">getCandles</span><span class="hl-4">:</span><span class="hl-1"> </span><span class="hl-7">async</span><span class="hl-1"> (</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">interval</span><span class="hl-1">, </span><span class="hl-4">since</span><span class="hl-1">, </span><span class="hl-4">limit</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-5">// Fetch logic</span><br/><span class="hl-1">    </span><span class="hl-3">return</span><span class="hl-1"> </span><span class="hl-4">candles</span><span class="hl-1">;</span><br/><span class="hl-1">  },</span><br/><span class="hl-1">  </span><br/><span class="hl-1">  </span><span class="hl-0">formatPrice</span><span class="hl-4">:</span><span class="hl-1"> </span><span class="hl-7">async</span><span class="hl-1"> (</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">price</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> </span><span class="hl-4">price</span><span class="hl-1">.</span><span class="hl-0">toFixed</span><span class="hl-1">(</span><span class="hl-6">2</span><span class="hl-1">),</span><br/><span class="hl-1">  </span><span class="hl-0">formatQuantity</span><span class="hl-4">:</span><span class="hl-1"> </span><span class="hl-7">async</span><span class="hl-1"> (</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">quantity</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> </span><span class="hl-4">quantity</span><span class="hl-1">.</span><span class="hl-0">toFixed</span><span class="hl-1">(</span><span class="hl-6">8</span><span class="hl-1">),</span><br/><span class="hl-1">  </span><br/><span class="hl-1">  </span><span class="hl-4">callbacks:</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-0">onCandleData</span><span class="hl-4">:</span><span class="hl-1"> (</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">interval</span><span class="hl-1">, </span><span class="hl-4">since</span><span class="hl-1">, </span><span class="hl-4">limit</span><span class="hl-1">, </span><span class="hl-4">data</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">      </span><span class="hl-4">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-2">`[</span><span class="hl-7">${</span><span class="hl-4">symbol</span><span class="hl-7">}</span><span class="hl-2">] Fetched </span><span class="hl-7">${</span><span class="hl-4">data</span><span class="hl-9">.</span><span class="hl-4">length</span><span class="hl-7">}</span><span class="hl-2"> </span><span class="hl-7">${</span><span class="hl-4">interval</span><span class="hl-7">}</span><span class="hl-2"> candles from </span><span class="hl-7">${</span><span class="hl-4">since</span><span class="hl-9">.</span><span class="hl-0">toISOString</span><span class="hl-9">()</span><span class="hl-7">}</span><span class="hl-2">`</span><span class="hl-1">);</span><br/><span class="hl-1">      </span><br/><span class="hl-1">      </span><span class="hl-5">// Example: Log to monitoring service</span><br/><span class="hl-1">      </span><span class="hl-4">monitoring</span><span class="hl-1">.</span><span class="hl-0">track</span><span class="hl-1">(</span><span class="hl-2">&#39;candle_fetch&#39;</span><span class="hl-1">, {</span><br/><span class="hl-1">        </span><span class="hl-4">symbol</span><span class="hl-1">,</span><br/><span class="hl-1">        </span><span class="hl-4">interval</span><span class="hl-1">,</span><br/><span class="hl-1">        </span><span class="hl-4">count:</span><span class="hl-1"> </span><span class="hl-4">data</span><span class="hl-1">.</span><span class="hl-4">length</span><span class="hl-1">,</span><br/><span class="hl-1">        </span><span class="hl-4">requested:</span><span class="hl-1"> </span><span class="hl-4">limit</span><span class="hl-1">,</span><br/><span class="hl-1">        </span><span class="hl-4">fulfilled:</span><span class="hl-1"> </span><span class="hl-4">data</span><span class="hl-1">.</span><span class="hl-4">length</span><span class="hl-1"> === </span><span class="hl-4">limit</span><span class="hl-1">,</span><br/><span class="hl-1">      });</span><br/><span class="hl-1">    },</span><br/><span class="hl-1">  },</span><br/><span class="hl-1">});</span>
</code><button type="button">Copy</button></pre>

<p><strong>Use Cases:</strong></p>
<ul>
<li>Logging data fetch operations</li>
<li>Monitoring API usage and quotas</li>
<li>Debugging data quality issues</li>
<li>Performance profiling</li>
</ul>
<hr>
<a id="complete-example-custom-database-exchange" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Complete Example: Custom Database Exchange<a href="#complete-example-custom-database-exchange" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><a id="csv-file-data-source" class="tsd-anchor"></a><h3 class="tsd-anchor-link">CSV File Data Source<a href="#csv-file-data-source" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><pre><code class="typescript"><span class="hl-3">import</span><span class="hl-1"> { </span><span class="hl-4">addExchange</span><span class="hl-1">, </span><span class="hl-4">ICandleData</span><span class="hl-1"> } </span><span class="hl-3">from</span><span class="hl-1"> </span><span class="hl-2">&#39;backtest-kit&#39;</span><span class="hl-1">;</span><br/><span class="hl-3">import</span><span class="hl-1"> </span><span class="hl-4">fs</span><span class="hl-1"> </span><span class="hl-3">from</span><span class="hl-1"> </span><span class="hl-2">&#39;fs/promises&#39;</span><span class="hl-1">;</span><br/><span class="hl-3">import</span><span class="hl-1"> </span><span class="hl-4">path</span><span class="hl-1"> </span><span class="hl-3">from</span><span class="hl-1"> </span><span class="hl-2">&#39;path&#39;</span><span class="hl-1">;</span><br/><br/><span class="hl-5">// Custom exchange reading from CSV files</span><br/><span class="hl-0">addExchange</span><span class="hl-1">({</span><br/><span class="hl-1">  </span><span class="hl-4">exchangeName:</span><span class="hl-1"> </span><span class="hl-2">&#39;csv-historical&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">note:</span><span class="hl-1"> </span><span class="hl-2">&#39;Historical data from CSV files&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><br/><span class="hl-1">  </span><span class="hl-0">getCandles</span><span class="hl-4">:</span><span class="hl-1"> </span><span class="hl-7">async</span><span class="hl-1"> (</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">interval</span><span class="hl-1">, </span><span class="hl-4">since</span><span class="hl-1">, </span><span class="hl-4">limit</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-5">// CSV file path: ./data/BTCUSDT_1m.csv</span><br/><span class="hl-1">    </span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">filename</span><span class="hl-1"> = </span><span class="hl-2">`./data/</span><span class="hl-7">${</span><span class="hl-4">symbol</span><span class="hl-7">}</span><span class="hl-2">_</span><span class="hl-7">${</span><span class="hl-4">interval</span><span class="hl-7">}</span><span class="hl-2">.csv`</span><span class="hl-1">;</span><br/><span class="hl-1">    </span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">content</span><span class="hl-1"> = </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-4">fs</span><span class="hl-1">.</span><span class="hl-0">readFile</span><span class="hl-1">(</span><span class="hl-4">filename</span><span class="hl-1">, </span><span class="hl-2">&#39;utf-8&#39;</span><span class="hl-1">);</span><br/><span class="hl-1">    </span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">lines</span><span class="hl-1"> = </span><span class="hl-4">content</span><span class="hl-1">.</span><span class="hl-0">split</span><span class="hl-1">(</span><span class="hl-2">&#39;</span><span class="hl-12">\n</span><span class="hl-2">&#39;</span><span class="hl-1">).</span><span class="hl-0">slice</span><span class="hl-1">(</span><span class="hl-6">1</span><span class="hl-1">); </span><span class="hl-5">// Skip header</span><br/><span class="hl-1">    </span><br/><span class="hl-1">    </span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">allCandles</span><span class="hl-1">: </span><span class="hl-13">ICandleData</span><span class="hl-1">[] = </span><span class="hl-4">lines</span><br/><span class="hl-1">      .</span><span class="hl-0">filter</span><span class="hl-1">(</span><span class="hl-4">line</span><span class="hl-1"> </span><span class="hl-7">=&gt;</span><span class="hl-1"> </span><span class="hl-4">line</span><span class="hl-1">.</span><span class="hl-0">trim</span><span class="hl-1">())</span><br/><span class="hl-1">      .</span><span class="hl-0">map</span><span class="hl-1">(</span><span class="hl-4">line</span><span class="hl-1"> </span><span class="hl-7">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">        </span><span class="hl-7">const</span><span class="hl-1"> [</span><span class="hl-8">timestamp</span><span class="hl-1">, </span><span class="hl-8">open</span><span class="hl-1">, </span><span class="hl-8">high</span><span class="hl-1">, </span><span class="hl-8">low</span><span class="hl-1">, </span><span class="hl-8">close</span><span class="hl-1">, </span><span class="hl-8">volume</span><span class="hl-1">] = </span><span class="hl-4">line</span><span class="hl-1">.</span><span class="hl-0">split</span><span class="hl-1">(</span><span class="hl-2">&#39;,&#39;</span><span class="hl-1">);</span><br/><span class="hl-1">        </span><span class="hl-3">return</span><span class="hl-1"> {</span><br/><span class="hl-1">          </span><span class="hl-4">timestamp:</span><span class="hl-1"> </span><span class="hl-0">parseInt</span><span class="hl-1">(</span><span class="hl-4">timestamp</span><span class="hl-1">),</span><br/><span class="hl-1">          </span><span class="hl-4">open:</span><span class="hl-1"> </span><span class="hl-0">parseFloat</span><span class="hl-1">(</span><span class="hl-4">open</span><span class="hl-1">),</span><br/><span class="hl-1">          </span><span class="hl-4">high:</span><span class="hl-1"> </span><span class="hl-0">parseFloat</span><span class="hl-1">(</span><span class="hl-4">high</span><span class="hl-1">),</span><br/><span class="hl-1">          </span><span class="hl-4">low:</span><span class="hl-1"> </span><span class="hl-0">parseFloat</span><span class="hl-1">(</span><span class="hl-4">low</span><span class="hl-1">),</span><br/><span class="hl-1">          </span><span class="hl-4">close:</span><span class="hl-1"> </span><span class="hl-0">parseFloat</span><span class="hl-1">(</span><span class="hl-4">close</span><span class="hl-1">),</span><br/><span class="hl-1">          </span><span class="hl-4">volume:</span><span class="hl-1"> </span><span class="hl-0">parseFloat</span><span class="hl-1">(</span><span class="hl-4">volume</span><span class="hl-1">),</span><br/><span class="hl-1">        };</span><br/><span class="hl-1">      });</span><br/><span class="hl-1">    </span><br/><span class="hl-1">    </span><span class="hl-5">// Filter by date range</span><br/><span class="hl-1">    </span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">sinceMs</span><span class="hl-1"> = </span><span class="hl-4">since</span><span class="hl-1">.</span><span class="hl-0">getTime</span><span class="hl-1">();</span><br/><span class="hl-1">    </span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">filtered</span><span class="hl-1"> = </span><span class="hl-4">allCandles</span><span class="hl-1">.</span><span class="hl-0">filter</span><span class="hl-1">(</span><span class="hl-4">c</span><span class="hl-1"> </span><span class="hl-7">=&gt;</span><span class="hl-1"> </span><span class="hl-4">c</span><span class="hl-1">.</span><span class="hl-4">timestamp</span><span class="hl-1"> &gt;= </span><span class="hl-4">sinceMs</span><span class="hl-1">);</span><br/><span class="hl-1">    </span><br/><span class="hl-1">    </span><span class="hl-5">// Return requested limit</span><br/><span class="hl-1">    </span><span class="hl-3">return</span><span class="hl-1"> </span><span class="hl-4">filtered</span><span class="hl-1">.</span><span class="hl-0">slice</span><span class="hl-1">(</span><span class="hl-6">0</span><span class="hl-1">, </span><span class="hl-4">limit</span><span class="hl-1">);</span><br/><span class="hl-1">  },</span><br/><span class="hl-1">  </span><br/><span class="hl-1">  </span><span class="hl-0">formatPrice</span><span class="hl-4">:</span><span class="hl-1"> </span><span class="hl-7">async</span><span class="hl-1"> (</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">price</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-5">// Fixed precision for all symbols</span><br/><span class="hl-1">    </span><span class="hl-3">return</span><span class="hl-1"> </span><span class="hl-4">price</span><span class="hl-1">.</span><span class="hl-0">toFixed</span><span class="hl-1">(</span><span class="hl-6">2</span><span class="hl-1">);</span><br/><span class="hl-1">  },</span><br/><span class="hl-1">  </span><br/><span class="hl-1">  </span><span class="hl-0">formatQuantity</span><span class="hl-4">:</span><span class="hl-1"> </span><span class="hl-7">async</span><span class="hl-1"> (</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">quantity</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-3">return</span><span class="hl-1"> </span><span class="hl-4">quantity</span><span class="hl-1">.</span><span class="hl-0">toFixed</span><span class="hl-1">(</span><span class="hl-6">8</span><span class="hl-1">);</span><br/><span class="hl-1">  },</span><br/><span class="hl-1">  </span><br/><span class="hl-1">  </span><span class="hl-4">callbacks:</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-0">onCandleData</span><span class="hl-4">:</span><span class="hl-1"> (</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">interval</span><span class="hl-1">, </span><span class="hl-4">since</span><span class="hl-1">, </span><span class="hl-4">limit</span><span class="hl-1">, </span><span class="hl-4">data</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">      </span><span class="hl-4">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-2">`CSV: Loaded </span><span class="hl-7">${</span><span class="hl-4">data</span><span class="hl-9">.</span><span class="hl-4">length</span><span class="hl-7">}</span><span class="hl-2">/</span><span class="hl-7">${</span><span class="hl-4">limit</span><span class="hl-7">}</span><span class="hl-2"> </span><span class="hl-7">${</span><span class="hl-4">interval</span><span class="hl-7">}</span><span class="hl-2"> candles for </span><span class="hl-7">${</span><span class="hl-4">symbol</span><span class="hl-7">}</span><span class="hl-2">`</span><span class="hl-1">);</span><br/><span class="hl-1">    },</span><br/><span class="hl-1">  },</span><br/><span class="hl-1">});</span>
</code><button type="button">Copy</button></pre>

</div></div><div class="col-sidebar"><div class="page-menu"><div class="tsd-navigation settings"><details class="tsd-accordion"><summary class="tsd-accordion-summary"><h3><svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-chevronDown"></use></svg>Settings</h3></summary><div class="tsd-accordion-details"><div class="tsd-filter-visibility"><span class="settings-label">Member Visibility</span><ul id="tsd-filter-options"><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-protected" name="protected"/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Protected</span></label></li><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-inherited" name="inherited" checked/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Inherited</span></label></li><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-external" name="external"/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>External</span></label></li></ul></div><div class="tsd-theme-toggle"><label class="settings-label" for="tsd-theme">Theme</label><select id="tsd-theme"><option value="os">OS</option><option value="light">Light</option><option value="dark">Dark</option></select></div></div></details></div><details open class="tsd-accordion tsd-page-navigation"><summary class="tsd-accordion-summary"><h3><svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-chevronDown"></use></svg>On This Page</h3></summary><div class="tsd-accordion-details"><a href="#exchanges--data-sources"><span>Exchanges &amp; <wbr/>Data <wbr/>Sources</span></a><ul><li><a href="#purpose-and-scope"><span>Purpose and <wbr/>Scope</span></a></li><li><a href="#exchange-schema-definition"><span>Exchange <wbr/>Schema <wbr/>Definition</span></a></li><li><ul><li><a href="#iexchangeschema-interface"><span>IExchange<wbr/>Schema <wbr/>Interface</span></a></li></ul></li><li><a href="#registering-an-exchange"><span>Registering an <wbr/>Exchange</span></a></li><li><ul><li><a href="#addexchange-function"><span>add<wbr/>Exchange <wbr/>Function</span></a></li></ul></li><li><a href="#data-fetching-requirements"><span>Data <wbr/>Fetching <wbr/>Requirements</span></a></li><li><ul><li><a href="#getcandles-method-contract"><span>get<wbr/>Candles <wbr/>Method <wbr/>Contract</span></a></li></ul></li><li><a href="#internal-data-flow"><span>Internal <wbr/>Data <wbr/>Flow</span></a></li><li><a href="#vwap-pricing"><span>VWAP <wbr/>Pricing</span></a></li><li><ul><li><a href="#volume-weighted-average-price-calculation"><span>Volume <wbr/>Weighted <wbr/>Average <wbr/>Price <wbr/>Calculation</span></a></li></ul></li><li><a href="#data-validation--anomaly-detection"><span>Data <wbr/>Validation &amp; <wbr/>Anomaly <wbr/>Detection</span></a></li><li><ul><li><a href="#incomplete-candle-detection"><span>Incomplete <wbr/>Candle <wbr/>Detection</span></a></li></ul></li><li><a href="#retry-logic"><span>Retry <wbr/>Logic</span></a></li><li><ul><li><a href="#failed-fetch-handling"><span>Failed <wbr/>Fetch <wbr/>Handling</span></a></li></ul></li><li><a href="#price-and-quantity-formatting"><span>Price and <wbr/>Quantity <wbr/>Formatting</span></a></li><li><ul><li><a href="#exchange-specific-precision"><span>Exchange-<wbr/>Specific <wbr/>Precision</span></a></li></ul></li><li><a href="#ccxt-integration"><span>CCXT <wbr/>Integration</span></a></li><li><ul><li><a href="#common-integration-pattern"><span>Common <wbr/>Integration <wbr/>Pattern</span></a></li></ul></li><li><a href="#clientexchange-architecture"><span>Client<wbr/>Exchange <wbr/>Architecture</span></a></li><li><ul><li><a href="#internal-implementation"><span>Internal <wbr/>Implementation</span></a></li></ul></li><li><a href="#configuration-reference"><span>Configuration <wbr/>Reference</span></a></li><li><ul><li><a href="#data-fetching-parameters"><span>Data <wbr/>Fetching <wbr/>Parameters</span></a></li></ul></li><li><a href="#exchange-callbacks"><span>Exchange <wbr/>Callbacks</span></a></li><li><ul><li><a href="#lifecycle-event-monitoring"><span>Lifecycle <wbr/>Event <wbr/>Monitoring</span></a></li></ul></li><li><a href="#complete-example-custom-database-exchange"><span>Complete <wbr/>Example: <wbr/>Custom <wbr/>Database <wbr/>Exchange</span></a></li><li><ul><li><a href="#csv-file-data-source"><span>CSV <wbr/>File <wbr/>Data <wbr/>Source</span></a></li></ul></li></ul></div></details></div><div class="site-menu"><nav class="tsd-navigation"><a href="../modules.html">backtest-kit</a><ul class="tsd-small-nested-navigation" id="tsd-nav-container"><li>Loading...</li></ul></nav></div></div></div><footer><p class="tsd-generator">Generated using <a href="https://typedoc.org/" target="_blank">TypeDoc</a></p></footer><div class="overlay"></div></body></html>

<!-- Yandex.Metrika counter -->
<script type="text/javascript">
    (function(m,e,t,r,i,k,a){
        m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
        m[i].l=1*new Date();
        for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }}
        k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)
    })(window, document,'script','https://mc.yandex.ru/metrika/tag.js?id=105455585', 'ym');

    ym(105455585, 'init', {ssr:true, webvisor:true, clickmap:true, ecommerce:"dataLayer", accurateTrackBounce:true, trackLinks:true});
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/105455585" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
<!-- /Yandex.Metrika counter -->

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-3MQZEBBDDR"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-3MQZEBBDDR');
</script>
