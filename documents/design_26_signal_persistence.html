<!DOCTYPE html><html class="default" lang="en" data-base=".."><head><meta charset="utf-8"/><meta http-equiv="x-ua-compatible" content="IE=edge"/><title>design/26_signal_persistence | backtest-kit</title><meta name="description" content="Documentation for backtest-kit"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="stylesheet" href="../assets/style.css"/><link rel="stylesheet" href="../assets/highlight.css"/><script defer src="../assets/main.js"></script><script async src="../assets/icons.js" id="tsd-icons-script"></script><script async src="../assets/search.js" id="tsd-search-script"></script><script async src="../assets/navigation.js" id="tsd-nav-script"></script><script async src="../assets/hierarchy.js" id="tsd-hierarchy-script"></script></head><body><script>document.documentElement.dataset.theme = localStorage.getItem("tsd-theme") || "os";document.body.style.display="none";setTimeout(() => app?app.showPage():document.body.style.removeProperty("display"),500)</script><header class="tsd-page-toolbar"><div class="tsd-toolbar-contents container"><div class="table-cell" id="tsd-search"><div class="field"><label for="tsd-search-field" class="tsd-widget tsd-toolbar-icon search no-caption"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-search"></use></svg></label><input type="text" id="tsd-search-field" aria-label="Search"/></div><div class="field"><div id="tsd-toolbar-links"></div></div><ul class="results"><li class="state loading">Preparing search index...</li><li class="state failure">The search index is not available</li></ul><a href="../index.html" class="title">backtest-kit</a></div><div class="table-cell" id="tsd-widgets"><a href="#" class="tsd-widget tsd-toolbar-icon menu no-caption" data-toggle="menu" aria-label="Menu"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-menu"></use></svg></a></div></div></header><div class="container container-main"><div class="col-content"><div class="tsd-page-title"><ul class="tsd-breadcrumb"><li><a href="../modules.html">backtest-kit</a></li><li><a href="design_26_signal_persistence.html">design/26_signal_persistence</a></li></ul></div><div class="tsd-panel tsd-typography"><a id="signal-persistence" class="tsd-anchor"></a><h1 class="tsd-anchor-link">Signal Persistence<a href="#signal-persistence" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h1><p>Signal persistence ensures crash-safe operation during live trading by atomically writing signal state to disk before yielding results. This prevents duplicate signals and enables seamless recovery after process restarts. In backtest mode, persistence is disabled for performance.</p>
<p>For information about signal states and transitions, see <a href="design_24_signal_states.html">Signal States</a>. For custom storage backends (Redis, PostgreSQL), see <a href="design_44_custom_persistence_backends.html">Custom Persistence Backends</a>.</p>
<a id="overview" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Overview<a href="#overview" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>The persistence system provides durability guarantees for active trading signals through atomic file operations. When a signal is opened or closed, the state change is written to disk before the result is returned to the user. On restart, <code>ClientStrategy</code> loads the last known signal state and resumes monitoring without generating duplicate signals.</p>
<p><strong>Key Components:</strong></p>
<table>
<thead>
<tr>
<th>Component</th>
<th>Purpose</th>
<th>Location</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>PersistSignalAdapter</code></td>
<td>Static adapter for signal CRUD operations</td>
<td><a href="">src/classes/Persist.ts:31-168</a></td>
</tr>
<tr>
<td><code>ClientStrategy.waitForInit()</code></td>
<td>Loads persisted state on startup</td>
<td><a href="">src/client/ClientStrategy.ts:209-209</a></td>
</tr>
<tr>
<td><code>ClientStrategy.setPendingSignal()</code></td>
<td>Writes signal state atomically</td>
<td><a href="">src/client/ClientStrategy.ts:220-233</a></td>
</tr>
<tr>
<td><code>PersistBase&lt;ISignalData&gt;</code></td>
<td>Base class for file-based persistence</td>
<td><a href="">src/classes/Persist.ts:15-29</a></td>
</tr>
</tbody>
</table>
<a id="persistence-architecture" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Persistence Architecture<a href="#persistence-architecture" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p><img src="../media/26_Signal_Persistence_0.svg" alt="Mermaid Diagram"></p>
<p>The architecture uses a three-layer approach:</p>
<ol>
<li><strong>ClientStrategy</strong> - Business logic layer that coordinates persistence calls</li>
<li><strong>PersistSignalAdapter</strong> - Domain-specific adapter that converts between <code>ISignalRow</code> and <code>ISignalData</code></li>
<li><strong>PersistBase</strong> - Generic file-based persistence with atomic write guarantees</li>
</ol>
<a id="signal-state-recovery" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Signal State Recovery<a href="#signal-state-recovery" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>On initialization, <code>ClientStrategy.waitForInit()</code> attempts to load the last persisted signal state. This occurs once per strategy instance using the <code>singleshot</code> pattern from <code>functools-kit</code>.</p>
<p><img src="../media/26_Signal_Persistence_1.svg" alt="Mermaid Diagram"></p>
<p>The recovery process validates that the persisted signal matches the current execution context:</p>
<pre><code class="typescript"><span class="hl-5">// Validation checks in WAIT_FOR_INIT_FN</span><br/><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-4">pendingSignal</span><span class="hl-1">.</span><span class="hl-4">exchangeName</span><span class="hl-1"> !== </span><span class="hl-4">self</span><span class="hl-1">.</span><span class="hl-4">params</span><span class="hl-1">.</span><span class="hl-4">method</span><span class="hl-1">.</span><span class="hl-4">context</span><span class="hl-1">.</span><span class="hl-4">exchangeName</span><span class="hl-1">) {</span><br/><span class="hl-1">  </span><span class="hl-3">return</span><span class="hl-1">; </span><span class="hl-5">// Different exchange, ignore</span><br/><span class="hl-1">}</span><br/><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-4">pendingSignal</span><span class="hl-1">.</span><span class="hl-4">strategyName</span><span class="hl-1"> !== </span><span class="hl-4">self</span><span class="hl-1">.</span><span class="hl-4">params</span><span class="hl-1">.</span><span class="hl-4">method</span><span class="hl-1">.</span><span class="hl-4">context</span><span class="hl-1">.</span><span class="hl-4">strategyName</span><span class="hl-1">) {</span><br/><span class="hl-1">  </span><span class="hl-3">return</span><span class="hl-1">; </span><span class="hl-5">// Different strategy, ignore</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<a id="atomic-write-operations" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Atomic Write Operations<a href="#atomic-write-operations" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>Every signal state change is persisted atomically through <code>ClientStrategy.setPendingSignal()</code>. The method writes to disk <strong>before</strong> the result is yielded to the user, ensuring durability.</p>
<p><img src="../media/26_Signal_Persistence_2.svg" alt="Mermaid Diagram"></p>
<p>The atomic write pattern ensures crash safety:</p>
<ol>
<li><strong>Write to temporary file</strong> - New state written to <code>{filename}.json.tmp</code></li>
<li><strong>Atomic rename</strong> - <code>fs.rename()</code> atomically replaces old file with new file</li>
<li><strong>No intermediate state</strong> - File is either old state or new state, never corrupted</li>
</ol>
<p>This pattern is implemented in <code>PersistBase.writeValue()</code>:</p>
<a id="file-system-structure" class="tsd-anchor"></a><h2 class="tsd-anchor-link">File System Structure<a href="#file-system-structure" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>Signals are stored in a flat directory structure under <code>./signal/</code> in the working directory. Each signal is identified by <code>{strategyName}_{symbol}</code> and stored as a JSON file.</p>
<p><strong>Directory Layout:</strong></p>
<pre><code><span class="hl-1">.</span><span class="hl-14">/signal/</span><br/><span class="hl-1">├── </span><span class="hl-4">strategy1_BTCUSDT</span><span class="hl-1">.</span><span class="hl-4">json</span><span class="hl-1">      # </span><span class="hl-4">Active</span><span class="hl-1"> </span><span class="hl-4">signal</span><span class="hl-1"> </span><span class="hl-4">for</span><span class="hl-1"> </span><span class="hl-4">strategy1</span><span class="hl-1"> </span><span class="hl-4">on</span><span class="hl-1"> </span><span class="hl-7">BTCUSDT</span><br/><span class="hl-1">├── </span><span class="hl-4">strategy1_ETHUSDT</span><span class="hl-1">.</span><span class="hl-4">json</span><span class="hl-1">      # </span><span class="hl-4">Active</span><span class="hl-1"> </span><span class="hl-4">signal</span><span class="hl-1"> </span><span class="hl-4">for</span><span class="hl-1"> </span><span class="hl-4">strategy1</span><span class="hl-1"> </span><span class="hl-4">on</span><span class="hl-1"> </span><span class="hl-7">ETHUSDT</span><br/><span class="hl-1">├── </span><span class="hl-4">strategy2_BTCUSDT</span><span class="hl-1">.</span><span class="hl-4">json</span><span class="hl-1">      # </span><span class="hl-4">Active</span><span class="hl-1"> </span><span class="hl-4">signal</span><span class="hl-1"> </span><span class="hl-4">for</span><span class="hl-1"> </span><span class="hl-4">strategy2</span><span class="hl-1"> </span><span class="hl-4">on</span><span class="hl-1"> </span><span class="hl-7">BTCUSDT</span><br/><span class="hl-1">└── </span><span class="hl-4">strategy3_SOLUSDT</span><span class="hl-1">.</span><span class="hl-4">json</span><span class="hl-1">.</span><span class="hl-4">tmp</span><span class="hl-1">  # </span><span class="hl-4">Temporary</span><span class="hl-1"> </span><span class="hl-4">file</span><span class="hl-1"> </span><span class="hl-4">during</span><span class="hl-1"> </span><span class="hl-4">atomic</span><span class="hl-1"> </span><span class="hl-4">write</span>
</code><button>Copy</button></pre>

<p><strong>File Content Example:</strong></p>
<pre><code class="json"><span class="hl-1">{</span><br/><span class="hl-1">  </span><span class="hl-13">&quot;signalRow&quot;</span><span class="hl-1">: {</span><br/><span class="hl-1">    </span><span class="hl-13">&quot;id&quot;</span><span class="hl-1">: </span><span class="hl-2">&quot;abc123-def456-ghi789&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-13">&quot;position&quot;</span><span class="hl-1">: </span><span class="hl-2">&quot;long&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-13">&quot;priceOpen&quot;</span><span class="hl-1">: </span><span class="hl-8">50000.0</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-13">&quot;priceTakeProfit&quot;</span><span class="hl-1">: </span><span class="hl-8">51000.0</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-13">&quot;priceStopLoss&quot;</span><span class="hl-1">: </span><span class="hl-8">49000.0</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-13">&quot;minuteEstimatedTime&quot;</span><span class="hl-1">: </span><span class="hl-8">60</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-13">&quot;timestamp&quot;</span><span class="hl-1">: </span><span class="hl-8">1704067200000</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-13">&quot;symbol&quot;</span><span class="hl-1">: </span><span class="hl-2">&quot;BTCUSDT&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-13">&quot;exchangeName&quot;</span><span class="hl-1">: </span><span class="hl-2">&quot;binance&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-13">&quot;strategyName&quot;</span><span class="hl-1">: </span><span class="hl-2">&quot;momentum-strategy&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-13">&quot;note&quot;</span><span class="hl-1">: </span><span class="hl-2">&quot;Bullish momentum detected&quot;</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<p>When a signal is closed, the file contains:</p>
<pre><code class="json"><span class="hl-1">{</span><br/><span class="hl-1">  </span><span class="hl-13">&quot;signalRow&quot;</span><span class="hl-1">: </span><span class="hl-6">null</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<a id="entity-id-generation" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Entity ID Generation<a href="#entity-id-generation" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>The <code>PersistSignalAdapter</code> generates entity IDs by combining strategy name and symbol:</p>
<pre><code class="typescript"><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">entityId</span><span class="hl-1"> = </span><span class="hl-2">`</span><span class="hl-6">${</span><span class="hl-4">strategyName</span><span class="hl-6">}</span><span class="hl-2">_</span><span class="hl-6">${</span><span class="hl-4">symbol</span><span class="hl-6">}</span><span class="hl-2">`</span><span class="hl-1">;</span>
</code><button type="button">Copy</button></pre>

<p>This creates a unique identifier for each strategy-symbol pair. Multiple strategies can run on the same symbol without conflicts, and the same strategy can run on multiple symbols independently.</p>
<p><strong>Entity ID Examples:</strong></p>
<table>
<thead>
<tr>
<th>Strategy Name</th>
<th>Symbol</th>
<th>Entity ID</th>
<th>File Path</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>momentum-5m</code></td>
<td><code>BTCUSDT</code></td>
<td><code>momentum-5m_BTCUSDT</code></td>
<td><code>./signal/momentum-5m_BTCUSDT.json</code></td>
</tr>
<tr>
<td><code>mean-reversion</code></td>
<td><code>ETHUSDT</code></td>
<td><code>mean-reversion_ETHUSDT</code></td>
<td><code>./signal/mean-reversion_ETHUSDT.json</code></td>
</tr>
<tr>
<td><code>momentum-5m</code></td>
<td><code>ETHUSDT</code></td>
<td><code>momentum-5m_ETHUSDT</code></td>
<td><code>./signal/momentum-5m_ETHUSDT.json</code></td>
</tr>
</tbody>
</table>
<a id="backtest-vs-live-mode" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Backtest vs Live Mode<a href="#backtest-vs-live-mode" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>Persistence behavior differs significantly between execution modes:</p>
<p><img src="../media/26_Signal_Persistence_3.svg" alt="Mermaid Diagram"></p>
<p><strong>Comparison Table:</strong></p>
<table>
<thead>
<tr>
<th>Operation</th>
<th>Backtest Mode</th>
<th>Live Mode</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>waitForInit()</code></td>
<td>Returns immediately (no read)</td>
<td>Reads from <code>./signal/{entityId}.json</code></td>
</tr>
<tr>
<td><code>setPendingSignal()</code></td>
<td>Updates in-memory state only</td>
<td>Writes to disk atomically before return</td>
</tr>
<tr>
<td>Crash Recovery</td>
<td>Not applicable (single-process simulation)</td>
<td>Full state recovery on restart</td>
</tr>
<tr>
<td>Performance</td>
<td>Maximum (no I/O overhead)</td>
<td>Slight latency from disk writes (~1-5ms)</td>
</tr>
<tr>
<td>Durability</td>
<td>None (in-memory only)</td>
<td>Full durability (survives crashes)</td>
</tr>
</tbody>
</table>
<p>The mode is determined by <code>params.execution.context.backtest</code>:</p>
<pre><code class="typescript"><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-6">this</span><span class="hl-1">.</span><span class="hl-4">params</span><span class="hl-1">.</span><span class="hl-4">execution</span><span class="hl-1">.</span><span class="hl-4">context</span><span class="hl-1">.</span><span class="hl-4">backtest</span><span class="hl-1">) {</span><br/><span class="hl-1">  </span><span class="hl-3">return</span><span class="hl-1">; </span><span class="hl-5">// Skip persistence</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<a id="persistence-lifecycle" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Persistence Lifecycle<a href="#persistence-lifecycle" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p><img src="../media/26_Signal_Persistence_4.svg" alt="Mermaid Diagram"></p>
<a id="error-handling" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Error Handling<a href="#error-handling" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>Persistence operations are wrapped in <code>trycatch</code> patterns to handle file system errors gracefully:</p>
<p><strong>Read Errors:</strong></p>
<ul>
<li>File not found → Returns <code>null</code> (no previous signal)</li>
<li>Invalid JSON → Logs warning, returns <code>null</code></li>
<li>Permission denied → Throws error (fatal)</li>
</ul>
<p><strong>Write Errors:</strong></p>
<ul>
<li>Directory not exists → Creates directory automatically</li>
<li>Disk full → Throws error (fatal)</li>
<li>Permission denied → Throws error (fatal)</li>
</ul>
<p>All fatal errors are logged and propagated to the caller, preventing the strategy from yielding results with unconfirmed persistence.</p>
<a id="custom-persistence-backends" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Custom Persistence Backends<a href="#custom-persistence-backends" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>The framework supports custom persistence implementations through the <code>usePersistSignalAdapter()</code> function. This allows replacing file-based storage with databases or distributed systems.</p>
<p><strong>Example: Redis-backed persistence</strong></p>
<pre><code class="typescript"><span class="hl-3">import</span><span class="hl-1"> { </span><span class="hl-4">usePersistSignalAdapter</span><span class="hl-1"> } </span><span class="hl-3">from</span><span class="hl-1"> </span><span class="hl-2">&quot;backtest-kit&quot;</span><span class="hl-1">;</span><br/><br/><span class="hl-6">class</span><span class="hl-1"> </span><span class="hl-11">RedisPersistAdapter</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-6">async</span><span class="hl-1"> </span><span class="hl-0">readSignalData</span><span class="hl-1">(</span><span class="hl-4">strategyName</span><span class="hl-1">, </span><span class="hl-4">symbol</span><span class="hl-1">) {</span><br/><span class="hl-1">    </span><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">key</span><span class="hl-1"> = </span><span class="hl-2">`signal:</span><span class="hl-6">${</span><span class="hl-4">strategyName</span><span class="hl-6">}</span><span class="hl-2">:</span><span class="hl-6">${</span><span class="hl-4">symbol</span><span class="hl-6">}</span><span class="hl-2">`</span><span class="hl-1">;</span><br/><span class="hl-1">    </span><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">data</span><span class="hl-1"> = </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-4">redis</span><span class="hl-1">.</span><span class="hl-0">get</span><span class="hl-1">(</span><span class="hl-4">key</span><span class="hl-1">);</span><br/><span class="hl-1">    </span><span class="hl-3">return</span><span class="hl-1"> </span><span class="hl-4">data</span><span class="hl-1"> ? </span><span class="hl-7">JSON</span><span class="hl-1">.</span><span class="hl-0">parse</span><span class="hl-1">(</span><span class="hl-4">data</span><span class="hl-1">).</span><span class="hl-4">signalRow</span><span class="hl-1"> : </span><span class="hl-6">null</span><span class="hl-1">;</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">  </span><br/><span class="hl-1">  </span><span class="hl-6">async</span><span class="hl-1"> </span><span class="hl-0">writeSignalData</span><span class="hl-1">(</span><span class="hl-4">signal</span><span class="hl-1">, </span><span class="hl-4">strategyName</span><span class="hl-1">, </span><span class="hl-4">symbol</span><span class="hl-1">) {</span><br/><span class="hl-1">    </span><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">key</span><span class="hl-1"> = </span><span class="hl-2">`signal:</span><span class="hl-6">${</span><span class="hl-4">strategyName</span><span class="hl-6">}</span><span class="hl-2">:</span><span class="hl-6">${</span><span class="hl-4">symbol</span><span class="hl-6">}</span><span class="hl-2">`</span><span class="hl-1">;</span><br/><span class="hl-1">    </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-4">redis</span><span class="hl-1">.</span><span class="hl-0">set</span><span class="hl-1">(</span><span class="hl-4">key</span><span class="hl-1">, </span><span class="hl-7">JSON</span><span class="hl-1">.</span><span class="hl-0">stringify</span><span class="hl-1">({ </span><span class="hl-4">signalRow:</span><span class="hl-1"> </span><span class="hl-4">signal</span><span class="hl-1"> }));</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">}</span><br/><br/><span class="hl-0">usePersistSignalAdapter</span><span class="hl-1">(</span><span class="hl-6">new</span><span class="hl-1"> </span><span class="hl-0">RedisPersistAdapter</span><span class="hl-1">());</span>
</code><button type="button">Copy</button></pre>

<p>For detailed information on implementing custom persistence backends, see <a href="design_44_custom_persistence_backends.html">Custom Persistence Backends</a>.</p>
<a id="integration-with-signal-lifecycle" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Integration with Signal Lifecycle<a href="#integration-with-signal-lifecycle" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>Persistence is called at critical transition points in the signal lifecycle:</p>
<p><img src="../media/26_Signal_Persistence_5.svg" alt="Mermaid Diagram"></p>
<p>The persistence calls occur at exactly two points:</p>
<ol>
<li><strong>Signal Opened</strong> - After validation, before yielding <code>opened</code> result <a href="">src/client/ClientStrategy.ts:263</a></li>
<li><strong>Signal Closed</strong> - After PnL calculation, before yielding <code>closed</code> result <a href="">src/client/ClientStrategy.ts:414</a></li>
</ol>
<p>This ensures that the yielded results always reflect the persisted state, maintaining consistency between in-memory and disk state.</p>
</div></div><div class="col-sidebar"><div class="page-menu"><div class="tsd-navigation settings"><details class="tsd-accordion"><summary class="tsd-accordion-summary"><h3><svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-chevronDown"></use></svg>Settings</h3></summary><div class="tsd-accordion-details"><div class="tsd-filter-visibility"><span class="settings-label">Member Visibility</span><ul id="tsd-filter-options"><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-protected" name="protected"/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Protected</span></label></li><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-inherited" name="inherited" checked/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Inherited</span></label></li><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-external" name="external"/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>External</span></label></li></ul></div><div class="tsd-theme-toggle"><label class="settings-label" for="tsd-theme">Theme</label><select id="tsd-theme"><option value="os">OS</option><option value="light">Light</option><option value="dark">Dark</option></select></div></div></details></div><details open class="tsd-accordion tsd-page-navigation"><summary class="tsd-accordion-summary"><h3><svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-chevronDown"></use></svg>On This Page</h3></summary><div class="tsd-accordion-details"><a href="#signal-persistence"><span>Signal <wbr/>Persistence</span></a><ul><li><a href="#overview"><span>Overview</span></a></li><li><a href="#persistence-architecture"><span>Persistence <wbr/>Architecture</span></a></li><li><a href="#signal-state-recovery"><span>Signal <wbr/>State <wbr/>Recovery</span></a></li><li><a href="#atomic-write-operations"><span>Atomic <wbr/>Write <wbr/>Operations</span></a></li><li><a href="#file-system-structure"><span>File <wbr/>System <wbr/>Structure</span></a></li><li><a href="#entity-id-generation"><span>Entity ID <wbr/>Generation</span></a></li><li><a href="#backtest-vs-live-mode"><span>Backtest vs <wbr/>Live <wbr/>Mode</span></a></li><li><a href="#persistence-lifecycle"><span>Persistence <wbr/>Lifecycle</span></a></li><li><a href="#error-handling"><span>Error <wbr/>Handling</span></a></li><li><a href="#custom-persistence-backends"><span>Custom <wbr/>Persistence <wbr/>Backends</span></a></li><li><a href="#integration-with-signal-lifecycle"><span>Integration with <wbr/>Signal <wbr/>Lifecycle</span></a></li></ul></div></details></div><div class="site-menu"><nav class="tsd-navigation"><a href="../modules.html">backtest-kit</a><ul class="tsd-small-nested-navigation" id="tsd-nav-container"><li>Loading...</li></ul></nav></div></div></div><footer><p class="tsd-generator">Generated using <a href="https://typedoc.org/" target="_blank">TypeDoc</a></p></footer><div class="overlay"></div></body></html>

<!-- Yandex.Metrika counter -->
<script type="text/javascript">
    (function(m,e,t,r,i,k,a){
        m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
        m[i].l=1*new Date();
        for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }}
        k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)
    })(window, document,'script','https://mc.yandex.ru/metrika/tag.js?id=105455585', 'ym');

    ym(105455585, 'init', {ssr:true, webvisor:true, clickmap:true, ecommerce:"dataLayer", accurateTrackBounce:true, trackLinks:true});
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/105455585" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
<!-- /Yandex.Metrika counter -->

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-3MQZEBBDDR"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-3MQZEBBDDR');
</script>
