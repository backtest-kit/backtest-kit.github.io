<!DOCTYPE html><html class="default" lang="en" data-base=".."><head><meta charset="utf-8"/><meta http-equiv="x-ua-compatible" content="IE=edge"/><title>design/21_exchange_functions | backtest-kit</title><meta name="description" content="Documentation for backtest-kit"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="stylesheet" href="../assets/style.css"/><link rel="stylesheet" href="../assets/highlight.css"/><script defer src="../assets/main.js"></script><script async src="../assets/icons.js" id="tsd-icons-script"></script><script async src="../assets/search.js" id="tsd-search-script"></script><script async src="../assets/navigation.js" id="tsd-nav-script"></script><script async src="../assets/hierarchy.js" id="tsd-hierarchy-script"></script></head><body><script>document.documentElement.dataset.theme = localStorage.getItem("tsd-theme") || "os";document.body.style.display="none";setTimeout(() => app?app.showPage():document.body.style.removeProperty("display"),500)</script><header class="tsd-page-toolbar"><div class="tsd-toolbar-contents container"><div class="table-cell" id="tsd-search"><div class="field"><label for="tsd-search-field" class="tsd-widget tsd-toolbar-icon search no-caption"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-search"></use></svg></label><input type="text" id="tsd-search-field" aria-label="Search"/></div><div class="field"><div id="tsd-toolbar-links"></div></div><ul class="results"><li class="state loading">Preparing search index...</li><li class="state failure">The search index is not available</li></ul><a href="../index.html" class="title">backtest-kit</a></div><div class="table-cell" id="tsd-widgets"><a href="#" class="tsd-widget tsd-toolbar-icon menu no-caption" data-toggle="menu" aria-label="Menu"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-menu"></use></svg></a></div></div></header><div class="container container-main"><div class="col-content"><div class="tsd-page-title"><ul class="tsd-breadcrumb"><li><a href="../modules.html">backtest-kit</a></li><li><a href="design_21_exchange_functions.html">design/21_exchange_functions</a></li></ul></div><div class="tsd-panel tsd-typography"><a id="exchange-functions" class="tsd-anchor"></a><h1 class="tsd-anchor-link">Exchange Functions<a href="#exchange-functions" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h1><p>This page documents the exchange helper functions available in the public API. These functions provide standardized access to market data (candles, prices) with built-in retry logic, validation, and VWAP calculation. Exchange functions are defined in user-provided exchange schemas and accessed through the <code>ClientExchange</code> implementation.</p>
<p>For information about registering exchange schemas, see <a href="design_16_component_registration_functions.html">Component Registration Functions</a>. For details on implementing custom exchange integrations, see <a href="design_83_custom_exchange_integration.html">Custom Exchange Integration</a>.</p>
<hr>
<a id="function-overview" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Function Overview<a href="#function-overview" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>Exchange functions provide four categories of functionality:</p>
<table>
<thead>
<tr>
<th>Function</th>
<th>Purpose</th>
<th>Mode Support</th>
<th>Configuration</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>getCandles</code></td>
<td>Fetch historical candles backwards from execution context time</td>
<td>Backtest, Live</td>
<td><code>CC_AVG_PRICE_CANDLES_COUNT</code>, retry params</td>
</tr>
<tr>
<td><code>getNextCandles</code></td>
<td>Fetch future candles forward from execution context time</td>
<td>Backtest only</td>
<td>Retry params, anomaly detection</td>
</tr>
<tr>
<td><code>getAveragePrice</code></td>
<td>Calculate VWAP from last N 1-minute candles</td>
<td>Backtest, Live</td>
<td><code>CC_AVG_PRICE_CANDLES_COUNT</code></td>
</tr>
<tr>
<td><code>formatPrice</code></td>
<td>Format price according to exchange precision rules</td>
<td>Backtest, Live</td>
<td>User-defined in schema</td>
</tr>
<tr>
<td><code>formatQuantity</code></td>
<td>Format quantity according to exchange precision rules</td>
<td>Backtest, Live</td>
<td>User-defined in schema</td>
</tr>
</tbody>
</table>
<p>All functions operate within the current <code>ExecutionContext</code> (symbol, when, backtest flag) and automatically handle retries, validation, and error logging.</p>
<hr>
<a id="exchange-function-access-patterns" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Exchange Function Access Patterns<a href="#exchange-function-access-patterns" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p><img src="../media/21_Exchange_Functions_0.svg" alt="Mermaid Diagram"></p>
<p><strong>Diagram: Exchange Function Call Flow and Service Layers</strong></p>
<p>This diagram shows how exchange functions are accessed through multiple service layers. User-provided implementations are wrapped with retry logic, validation, and context injection. The <code>ExchangeGlobalService</code> provides the entry point for strategy code, while <code>ClientExchange</code> implements the core logic.</p>
<hr>
<a id="getcandles-function" class="tsd-anchor"></a><h2 class="tsd-anchor-link">getCandles Function<a href="#getcandles-function" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>The <code>getCandles</code> function fetches historical candles backwards from the current execution context time (<code>ExecutionContext.when</code>). It automatically calculates the correct <code>since</code> timestamp based on the requested interval and limit.</p>
<a id="function-signature" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Function Signature<a href="#function-signature" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><pre><code class="typescript"><span class="hl-0">getCandles</span><span class="hl-1">(</span><br/><span class="hl-1">  </span><span class="hl-4">symbol</span><span class="hl-1">: </span><span class="hl-4">string</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">interval</span><span class="hl-1">: </span><span class="hl-4">CandleInterval</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">limit</span><span class="hl-1">: </span><span class="hl-4">number</span><br/><span class="hl-1">): </span><span class="hl-13">Promise</span><span class="hl-1">&lt;</span><span class="hl-4">ICandleData</span><span class="hl-1">[]&gt;</span>
</code><button type="button">Copy</button></pre>

<a id="parameters" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Parameters<a href="#parameters" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><ul>
<li><strong>symbol</strong>: Trading pair symbol (e.g., <code>&quot;BTCUSDT&quot;</code>)</li>
<li><strong>interval</strong>: Candle time interval - <code>&quot;1m&quot;</code> | <code>&quot;3m&quot;</code> | <code>&quot;5m&quot;</code> | <code>&quot;15m&quot;</code> | <code>&quot;30m&quot;</code> | <code>&quot;1h&quot;</code> | <code>&quot;2h&quot;</code> | <code>&quot;4h&quot;</code> | <code>&quot;6h&quot;</code> | <code>&quot;8h&quot;</code></li>
<li><strong>limit</strong>: Maximum number of candles to fetch</li>
</ul>
<a id="return-type" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Return Type<a href="#return-type" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><pre><code class="typescript"><span class="hl-7">interface</span><span class="hl-1"> </span><span class="hl-13">ICandleData</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-4">timestamp</span><span class="hl-1">: </span><span class="hl-13">number</span><span class="hl-1">;  </span><span class="hl-5">// Unix timestamp in milliseconds</span><br/><span class="hl-1">  </span><span class="hl-4">open</span><span class="hl-1">: </span><span class="hl-13">number</span><span class="hl-1">;       </span><span class="hl-5">// Opening price</span><br/><span class="hl-1">  </span><span class="hl-4">high</span><span class="hl-1">: </span><span class="hl-13">number</span><span class="hl-1">;       </span><span class="hl-5">// Highest price</span><br/><span class="hl-1">  </span><span class="hl-4">low</span><span class="hl-1">: </span><span class="hl-13">number</span><span class="hl-1">;        </span><span class="hl-5">// Lowest price</span><br/><span class="hl-1">  </span><span class="hl-4">close</span><span class="hl-1">: </span><span class="hl-13">number</span><span class="hl-1">;      </span><span class="hl-5">// Closing price</span><br/><span class="hl-1">  </span><span class="hl-4">volume</span><span class="hl-1">: </span><span class="hl-13">number</span><span class="hl-1">;     </span><span class="hl-5">// Trading volume</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<a id="implementation-details" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Implementation Details<a href="#implementation-details" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>The function calculates the <code>since</code> timestamp by subtracting <code>(interval * limit - interval)</code> minutes from <code>ExecutionContext.when</code>:</p>
<pre><code class="typescript"><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">step</span><span class="hl-1"> = </span><span class="hl-8">INTERVAL_MINUTES</span><span class="hl-1">[</span><span class="hl-4">interval</span><span class="hl-1">];</span><br/><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">adjust</span><span class="hl-1"> = </span><span class="hl-4">step</span><span class="hl-1"> * </span><span class="hl-4">limit</span><span class="hl-1"> - </span><span class="hl-4">step</span><span class="hl-1">;</span><br/><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">since</span><span class="hl-1"> = </span><span class="hl-7">new</span><span class="hl-1"> </span><span class="hl-0">Date</span><span class="hl-1">(</span><br/><span class="hl-1">  </span><span class="hl-7">this</span><span class="hl-1">.</span><span class="hl-4">params</span><span class="hl-1">.</span><span class="hl-4">execution</span><span class="hl-1">.</span><span class="hl-4">context</span><span class="hl-1">.</span><span class="hl-4">when</span><span class="hl-1">.</span><span class="hl-0">getTime</span><span class="hl-1">() - </span><span class="hl-4">adjust</span><span class="hl-1"> * </span><span class="hl-6">60</span><span class="hl-1"> * </span><span class="hl-6">1_000</span><br/><span class="hl-1">);</span>
</code><button type="button">Copy</button></pre>

<p>After fetching candles, the function filters results to match the exact requested range:</p>
<pre><code class="typescript"><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">filteredData</span><span class="hl-1"> = </span><span class="hl-4">data</span><span class="hl-1">.</span><span class="hl-0">filter</span><span class="hl-1">(</span><br/><span class="hl-1">  (</span><span class="hl-4">candle</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><br/><span class="hl-1">    </span><span class="hl-4">candle</span><span class="hl-1">.</span><span class="hl-4">timestamp</span><span class="hl-1"> &gt;= </span><span class="hl-4">sinceTimestamp</span><span class="hl-1"> &amp;&amp; </span><span class="hl-4">candle</span><span class="hl-1">.</span><span class="hl-4">timestamp</span><span class="hl-1"> &lt;= </span><span class="hl-4">whenTimestamp</span><br/><span class="hl-1">);</span>
</code><button type="button">Copy</button></pre>

<a id="retry-logic" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Retry Logic<a href="#retry-logic" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><code>getCandles</code> automatically retries failed requests using the <code>GET_CANDLES_FN</code> wrapper:</p>
<ul>
<li>Retry count: <code>CC_GET_CANDLES_RETRY_COUNT</code> (default: 3)</li>
<li>Retry delay: <code>CC_GET_CANDLES_RETRY_DELAY_MS</code> (default: 5000ms)</li>
<li>Validates candles after each attempt using <code>VALIDATE_NO_INCOMPLETE_CANDLES_FN</code></li>
</ul>
<hr>
<a id="getnextcandles-function" class="tsd-anchor"></a><h2 class="tsd-anchor-link">getNextCandles Function<a href="#getnextcandles-function" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>The <code>getNextCandles</code> function fetches future candles forward from the current execution context time. This function is <strong>only valid in backtest mode</strong> and returns empty array if the requested period extends beyond <code>Date.now()</code>.</p>
<a id="function-signature-1" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Function Signature<a href="#function-signature-1" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><pre><code class="typescript"><span class="hl-0">getNextCandles</span><span class="hl-1">(</span><br/><span class="hl-1">  </span><span class="hl-4">symbol</span><span class="hl-1">: </span><span class="hl-4">string</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">interval</span><span class="hl-1">: </span><span class="hl-4">CandleInterval</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">limit</span><span class="hl-1">: </span><span class="hl-4">number</span><br/><span class="hl-1">): </span><span class="hl-13">Promise</span><span class="hl-1">&lt;</span><span class="hl-4">ICandleData</span><span class="hl-1">[]&gt;</span>
</code><button type="button">Copy</button></pre>

<a id="backtest-only-guard" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Backtest-Only Guard<a href="#backtest-only-guard" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><pre><code class="typescript"><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">step</span><span class="hl-1"> = </span><span class="hl-8">INTERVAL_MINUTES</span><span class="hl-1">[</span><span class="hl-4">interval</span><span class="hl-1">];</span><br/><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">endTime</span><span class="hl-1"> = </span><span class="hl-4">since</span><span class="hl-1">.</span><span class="hl-0">getTime</span><span class="hl-1">() + </span><span class="hl-4">limit</span><span class="hl-1"> * </span><span class="hl-4">step</span><span class="hl-1"> * </span><span class="hl-6">60</span><span class="hl-1"> * </span><span class="hl-6">1000</span><span class="hl-1">;</span><br/><br/><span class="hl-5">// Returns empty array if requesting future data beyond now</span><br/><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-4">endTime</span><span class="hl-1"> &gt; </span><span class="hl-4">now</span><span class="hl-1">) {</span><br/><span class="hl-1">  </span><span class="hl-3">return</span><span class="hl-1"> [];</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<p>This guard ensures that backtest simulations cannot &quot;peek into the future&quot; beyond the current timestamp. The function starts fetching from <code>ExecutionContext.when</code> and extends forward by <code>limit</code> intervals.</p>
<a id="use-cases" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Use Cases<a href="#use-cases" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>The function is primarily used by backtest execution to fetch candles for signal duration:</p>
<ol>
<li><strong>Signal Open</strong>: When a signal opens, <code>BacktestLogicPrivateService</code> fetches <code>minuteEstimatedTime</code> candles forward</li>
<li><strong>Scheduled Signal</strong>: For scheduled signals, fetches <code>CC_SCHEDULE_AWAIT_MINUTES + minuteEstimatedTime + 1</code> candles</li>
<li><strong>Fast-forward</strong>: Allows backtest to skip timeframes during active signal monitoring</li>
</ol>
<hr>
<a id="getaverageprice-function-vwap-calculation" class="tsd-anchor"></a><h2 class="tsd-anchor-link">getAveragePrice Function (VWAP Calculation)<a href="#getaverageprice-function-vwap-calculation" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>The <code>getAveragePrice</code> function calculates the Volume-Weighted Average Price (VWAP) from the last N 1-minute candles. The number of candles is configurable via <code>GLOBAL_CONFIG.CC_AVG_PRICE_CANDLES_COUNT</code> (default: 5).</p>
<a id="vwap-calculation-flow" class="tsd-anchor"></a><h3 class="tsd-anchor-link">VWAP Calculation Flow<a href="#vwap-calculation-flow" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><img src="../media/21_Exchange_Functions_1.svg" alt="Mermaid Diagram"></p>
<p><strong>Diagram: VWAP Calculation Algorithm</strong></p>
<a id="formula" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Formula<a href="#formula" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><strong>VWAP</strong> = Σ(Typical Price × Volume) / Σ(Volume)</p>
<p>Where <strong>Typical Price</strong> = (High + Low + Close) / 3</p>
<a id="fallback-behavior" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Fallback Behavior<a href="#fallback-behavior" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>If total volume is zero (rare edge case), the function returns a simple average of close prices:</p>
<pre><code class="typescript"><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-4">totalVolume</span><span class="hl-1"> === </span><span class="hl-6">0</span><span class="hl-1">) {</span><br/><span class="hl-1">  </span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">sum</span><span class="hl-1"> = </span><span class="hl-4">candles</span><span class="hl-1">.</span><span class="hl-0">reduce</span><span class="hl-1">((</span><span class="hl-4">acc</span><span class="hl-1">, </span><span class="hl-4">candle</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> </span><span class="hl-4">acc</span><span class="hl-1"> + </span><span class="hl-4">candle</span><span class="hl-1">.</span><span class="hl-4">close</span><span class="hl-1">, </span><span class="hl-6">0</span><span class="hl-1">);</span><br/><span class="hl-1">  </span><span class="hl-3">return</span><span class="hl-1"> </span><span class="hl-4">sum</span><span class="hl-1"> / </span><span class="hl-4">candles</span><span class="hl-1">.</span><span class="hl-4">length</span><span class="hl-1">;</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<a id="usage-context" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Usage Context<a href="#usage-context" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><code>getAveragePrice</code> is called extensively throughout the system:</p>
<ul>
<li><strong>Signal Generation</strong>: <code>ClientStrategy</code> uses VWAP as <code>currentPrice</code> for risk checks</li>
<li><strong>Signal Validation</strong>: VWAP is compared against <code>priceOpen</code>, <code>priceTakeProfit</code>, <code>priceStopLoss</code></li>
<li><strong>Signal Monitoring</strong>: Active signals are monitored using VWAP for TP/SL detection</li>
<li><strong>Callbacks</strong>: VWAP is passed to strategy callbacks as <code>currentPrice</code> parameter</li>
</ul>
<hr>
<a id="format-functions" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Format Functions<a href="#format-functions" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>The <code>formatPrice</code> and <code>formatQuantity</code> functions delegate to user-provided implementations in the exchange schema. These functions apply exchange-specific precision rules to ensure valid order placement.</p>
<a id="formatprice" class="tsd-anchor"></a><h3 class="tsd-anchor-link">formatPrice<a href="#formatprice" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><pre><code class="typescript"><span class="hl-0">formatPrice</span><span class="hl-1">(</span><span class="hl-4">symbol</span><span class="hl-1">: </span><span class="hl-4">string</span><span class="hl-1">, </span><span class="hl-4">price</span><span class="hl-1">: </span><span class="hl-4">number</span><span class="hl-1">): </span><span class="hl-13">Promise</span><span class="hl-1">&lt;</span><span class="hl-4">string</span><span class="hl-1">&gt;</span>
</code><button type="button">Copy</button></pre>

<p>Formats a price value according to exchange precision rules. For example, Binance might require 2 decimal places for BTCUSDT but 8 decimals for smaller altcoins.</p>
<a id="formatquantity" class="tsd-anchor"></a><h3 class="tsd-anchor-link">formatQuantity<a href="#formatquantity" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><pre><code class="typescript"><span class="hl-0">formatQuantity</span><span class="hl-1">(</span><span class="hl-4">symbol</span><span class="hl-1">: </span><span class="hl-4">string</span><span class="hl-1">, </span><span class="hl-4">quantity</span><span class="hl-1">: </span><span class="hl-4">number</span><span class="hl-1">): </span><span class="hl-13">Promise</span><span class="hl-1">&lt;</span><span class="hl-4">string</span><span class="hl-1">&gt;</span>
</code><button type="button">Copy</button></pre>

<p>Formats a quantity value according to exchange lot size and step size rules. Ensures the quantity meets minimum order size requirements.</p>
<a id="implementation-pattern" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Implementation Pattern<a href="#implementation-pattern" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Both functions are thin wrappers around user-provided implementations:</p>
<pre><code class="typescript"><span class="hl-4">public</span><span class="hl-1"> </span><span class="hl-4">async</span><span class="hl-1"> </span><span class="hl-0">formatPrice</span><span class="hl-1">(</span><span class="hl-4">symbol</span><span class="hl-1">: </span><span class="hl-4">string</span><span class="hl-1">, </span><span class="hl-4">price</span><span class="hl-1">: </span><span class="hl-4">number</span><span class="hl-1">) {</span><br/><span class="hl-1">  </span><span class="hl-7">this</span><span class="hl-1">.</span><span class="hl-4">params</span><span class="hl-1">.</span><span class="hl-4">logger</span><span class="hl-1">.</span><span class="hl-0">debug</span><span class="hl-1">(</span><span class="hl-2">&quot;binanceService formatPrice&quot;</span><span class="hl-1">, {</span><br/><span class="hl-1">    </span><span class="hl-4">symbol</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-4">price</span><span class="hl-1">,</span><br/><span class="hl-1">  });</span><br/><span class="hl-1">  </span><span class="hl-3">return</span><span class="hl-1"> </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-7">this</span><span class="hl-1">.</span><span class="hl-4">params</span><span class="hl-1">.</span><span class="hl-0">formatPrice</span><span class="hl-1">(</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">price</span><span class="hl-1">);</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<p>The actual formatting logic is defined in the <code>IExchangeSchema</code> registered via <code>addExchange()</code>.</p>
<hr>
<a id="retry-logic-and-error-handling" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Retry Logic and Error Handling<a href="#retry-logic-and-error-handling" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p><img src="../media/21_Exchange_Functions_2.svg" alt="Mermaid Diagram"></p>
<p><strong>Diagram: GET_CANDLES_FN Retry Logic Flow</strong></p>
<a id="retry-configuration" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Retry Configuration<a href="#retry-configuration" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><table>
<thead>
<tr>
<th>Parameter</th>
<th>Default</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>CC_GET_CANDLES_RETRY_COUNT</code></td>
<td>3</td>
<td>Number of retry attempts before throwing error</td>
</tr>
<tr>
<td><code>CC_GET_CANDLES_RETRY_DELAY_MS</code></td>
<td>5000</td>
<td>Delay in milliseconds between retry attempts</td>
</tr>
</tbody>
</table>
<a id="error-logging" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Error Logging<a href="#error-logging" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Each retry attempt logs a warning with detailed context:</p>
<pre><code class="typescript"><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">message</span><span class="hl-1"> = </span><span class="hl-2">`ClientExchange GET_CANDLES_FN: attempt </span><span class="hl-7">${</span><span class="hl-4">i</span><span class="hl-9"> </span><span class="hl-1">+</span><span class="hl-9"> </span><span class="hl-6">1</span><span class="hl-7">}</span><span class="hl-2"> failed for symbol=</span><span class="hl-7">${</span><span class="hl-4">dto</span><span class="hl-9">.</span><span class="hl-4">symbol</span><span class="hl-7">}</span><span class="hl-2">, interval=</span><span class="hl-7">${</span><span class="hl-4">dto</span><span class="hl-9">.</span><span class="hl-4">interval</span><span class="hl-7">}</span><span class="hl-2">, since=</span><span class="hl-7">${</span><span class="hl-4">since</span><span class="hl-9">.</span><span class="hl-0">toISOString</span><span class="hl-9">()</span><span class="hl-7">}</span><span class="hl-2">, limit=</span><span class="hl-7">${</span><span class="hl-4">dto</span><span class="hl-9">.</span><span class="hl-4">limit</span><span class="hl-7">}</span><span class="hl-2">}`</span><span class="hl-1">;</span><br/><span class="hl-4">self</span><span class="hl-1">.</span><span class="hl-4">params</span><span class="hl-1">.</span><span class="hl-4">logger</span><span class="hl-1">.</span><span class="hl-0">warn</span><span class="hl-1">(</span><span class="hl-4">message</span><span class="hl-1">, {</span><br/><span class="hl-1">  </span><span class="hl-4">error:</span><span class="hl-1"> </span><span class="hl-0">errorData</span><span class="hl-1">(</span><span class="hl-4">err</span><span class="hl-1">),</span><br/><span class="hl-1">  </span><span class="hl-4">message:</span><span class="hl-1"> </span><span class="hl-0">getErrorMessage</span><span class="hl-1">(</span><span class="hl-4">err</span><span class="hl-1">),</span><br/><span class="hl-1">});</span><br/><span class="hl-4">console</span><span class="hl-1">.</span><span class="hl-0">warn</span><span class="hl-1">(</span><span class="hl-4">message</span><span class="hl-1">);</span>
</code><button type="button">Copy</button></pre>

<p>After exhausting all retries, the function throws the last error encountered.</p>
<hr>
<a id="data-validation-and-price-anomaly-detection" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Data Validation and Price Anomaly Detection<a href="#data-validation-and-price-anomaly-detection" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>All fetched candles are validated using <code>VALIDATE_NO_INCOMPLETE_CANDLES_FN</code> to detect incomplete or anomalous data from exchange APIs (particularly common with Binance).</p>
<a id="validation-checks" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Validation Checks<a href="#validation-checks" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><img src="../media/21_Exchange_Functions_3.svg" alt="Mermaid Diagram"></p>
<p><strong>Diagram: Candle Validation and Anomaly Detection Flow</strong></p>
<a id="reference-price-calculation" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Reference Price Calculation<a href="#reference-price-calculation" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>The validation uses different statistical methods based on data size:</p>
<ul>
<li><strong>Large dataset</strong> (≥ <code>CC_GET_CANDLES_MIN_CANDLES_FOR_MEDIAN</code>): Uses <strong>median</strong> for robust statistics</li>
<li><strong>Small dataset</strong> (&lt; threshold): Uses <strong>average</strong> for more stable calculation</li>
</ul>
<pre><code class="typescript"><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-4">candles</span><span class="hl-1">.</span><span class="hl-4">length</span><span class="hl-1"> &gt;= </span><span class="hl-8">GLOBAL_CONFIG</span><span class="hl-1">.</span><span class="hl-8">CC_GET_CANDLES_MIN_CANDLES_FOR_MEDIAN</span><span class="hl-1">) {</span><br/><span class="hl-1">  </span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">sortedPrices</span><span class="hl-1"> = [...</span><span class="hl-4">validPrices</span><span class="hl-1">].</span><span class="hl-0">sort</span><span class="hl-1">((</span><span class="hl-4">a</span><span class="hl-1">, </span><span class="hl-4">b</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> </span><span class="hl-4">a</span><span class="hl-1"> - </span><span class="hl-4">b</span><span class="hl-1">);</span><br/><span class="hl-1">  </span><span class="hl-4">referencePrice</span><span class="hl-1"> = </span><span class="hl-4">sortedPrices</span><span class="hl-1">[</span><span class="hl-4">Math</span><span class="hl-1">.</span><span class="hl-0">floor</span><span class="hl-1">(</span><span class="hl-4">sortedPrices</span><span class="hl-1">.</span><span class="hl-4">length</span><span class="hl-1"> / </span><span class="hl-6">2</span><span class="hl-1">)] || </span><span class="hl-6">0</span><span class="hl-1">;</span><br/><span class="hl-1">} </span><span class="hl-3">else</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">sum</span><span class="hl-1"> = </span><span class="hl-4">validPrices</span><span class="hl-1">.</span><span class="hl-0">reduce</span><span class="hl-1">((</span><span class="hl-4">acc</span><span class="hl-1">, </span><span class="hl-4">p</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> </span><span class="hl-4">acc</span><span class="hl-1"> + </span><span class="hl-4">p</span><span class="hl-1">, </span><span class="hl-6">0</span><span class="hl-1">);</span><br/><span class="hl-1">  </span><span class="hl-4">referencePrice</span><span class="hl-1"> = </span><span class="hl-4">validPrices</span><span class="hl-1">.</span><span class="hl-4">length</span><span class="hl-1"> &gt; </span><span class="hl-6">0</span><span class="hl-1"> ? </span><span class="hl-4">sum</span><span class="hl-1"> / </span><span class="hl-4">validPrices</span><span class="hl-1">.</span><span class="hl-4">length</span><span class="hl-1"> : </span><span class="hl-6">0</span><span class="hl-1">;</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<a id="anomaly-detection" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Anomaly Detection<a href="#anomaly-detection" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>The function detects anomalously low prices (common indicator of incomplete candles):</p>
<pre><code class="typescript"><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">minValidPrice</span><span class="hl-1"> = </span><span class="hl-4">referencePrice</span><span class="hl-1"> / </span><span class="hl-8">GLOBAL_CONFIG</span><span class="hl-1">.</span><span class="hl-8">CC_GET_CANDLES_PRICE_ANOMALY_THRESHOLD_FACTOR</span><span class="hl-1">;</span><br/><br/><span class="hl-5">// Example with BTC at $50,000 median and factor 1000:</span><br/><span class="hl-5">// minValidPrice = $50 (catches prices like $0.01-1)</span>
</code><button type="button">Copy</button></pre>

<a id="validation-errors" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Validation Errors<a href="#validation-errors" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>The function throws detailed errors for three types of anomalies:</p>
<ol>
<li><strong>Invalid numeric values</strong>: NaN or Infinity in OHLCV fields</li>
<li><strong>Non-positive values</strong>: Zero or negative prices, negative volume</li>
<li><strong>Anomalous prices</strong>: Prices below threshold (likely incomplete candles)</li>
</ol>
<hr>
<a id="configuration-parameters" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Configuration Parameters<a href="#configuration-parameters" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>The following global configuration parameters control exchange function behavior:</p>
<table>
<thead>
<tr>
<th>Parameter</th>
<th>Default</th>
<th>Type</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>CC_AVG_PRICE_CANDLES_COUNT</code></td>
<td>5</td>
<td>number</td>
<td>Number of 1m candles for VWAP calculation</td>
</tr>
<tr>
<td><code>CC_GET_CANDLES_RETRY_COUNT</code></td>
<td>3</td>
<td>number</td>
<td>Maximum retry attempts for failed candle fetches</td>
</tr>
<tr>
<td><code>CC_GET_CANDLES_RETRY_DELAY_MS</code></td>
<td>5000</td>
<td>number</td>
<td>Delay in milliseconds between retry attempts</td>
</tr>
<tr>
<td><code>CC_GET_CANDLES_PRICE_ANOMALY_THRESHOLD_FACTOR</code></td>
<td>1000</td>
<td>number</td>
<td>Divisor for anomaly detection threshold</td>
</tr>
<tr>
<td><code>CC_GET_CANDLES_MIN_CANDLES_FOR_MEDIAN</code></td>
<td>5</td>
<td>number</td>
<td>Minimum candles to use median vs average for reference price</td>
</tr>
</tbody>
</table>
<a id="configuration-example" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Configuration Example<a href="#configuration-example" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><pre><code class="typescript"><span class="hl-3">import</span><span class="hl-1"> { </span><span class="hl-4">setConfig</span><span class="hl-1"> } </span><span class="hl-3">from</span><span class="hl-1"> </span><span class="hl-2">&#39;backtest-kit&#39;</span><span class="hl-1">;</span><br/><br/><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-0">setConfig</span><span class="hl-1">({</span><br/><span class="hl-1">  </span><span class="hl-4">CC_AVG_PRICE_CANDLES_COUNT:</span><span class="hl-1"> </span><span class="hl-6">10</span><span class="hl-1">,      </span><span class="hl-5">// Use 10 candles for VWAP</span><br/><span class="hl-1">  </span><span class="hl-4">CC_GET_CANDLES_RETRY_COUNT:</span><span class="hl-1"> </span><span class="hl-6">5</span><span class="hl-1">,       </span><span class="hl-5">// Retry 5 times</span><br/><span class="hl-1">  </span><span class="hl-4">CC_GET_CANDLES_RETRY_DELAY_MS:</span><span class="hl-1"> </span><span class="hl-6">3000</span><span class="hl-1">, </span><span class="hl-5">// Wait 3 seconds between retries</span><br/><span class="hl-1">});</span>
</code><button type="button">Copy</button></pre>

<p>For complete configuration documentation, see <a href="design_75_global_configuration.html">Global Configuration</a>.</p>
<hr>
<a id="usage-in-different-execution-modes" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Usage in Different Execution Modes<a href="#usage-in-different-execution-modes" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><a id="backtest-mode" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Backtest Mode<a href="#backtest-mode" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>In backtest mode, exchange functions operate on historical data:</p>
<pre><code class="typescript"><span class="hl-5">// BacktestLogicPrivateService iterates through timeframes</span><br/><span class="hl-3">for</span><span class="hl-1"> (</span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">when</span><span class="hl-1"> </span><span class="hl-7">of</span><span class="hl-1"> </span><span class="hl-4">timeframes</span><span class="hl-1">) {</span><br/><span class="hl-1">  </span><span class="hl-5">// tick() uses getCandles (backwards) and getAveragePrice (VWAP)</span><br/><span class="hl-1">  </span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">result</span><span class="hl-1"> = </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-4">strategyGlobalService</span><span class="hl-1">.</span><span class="hl-0">tick</span><span class="hl-1">(</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">when</span><span class="hl-1">, </span><span class="hl-7">true</span><span class="hl-1">);</span><br/><span class="hl-1">  </span><br/><span class="hl-1">  </span><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-4">result</span><span class="hl-1">.</span><span class="hl-4">action</span><span class="hl-1"> === </span><span class="hl-2">&quot;opened&quot;</span><span class="hl-1">) {</span><br/><span class="hl-1">    </span><span class="hl-5">// backtest() uses getNextCandles (forward) for signal duration</span><br/><span class="hl-1">    </span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">candles</span><span class="hl-1"> = </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-4">exchangeGlobalService</span><span class="hl-1">.</span><span class="hl-0">getNextCandles</span><span class="hl-1">(</span><br/><span class="hl-1">      </span><span class="hl-4">symbol</span><span class="hl-1">,</span><br/><span class="hl-1">      </span><span class="hl-2">&quot;1m&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">      </span><span class="hl-4">signal</span><span class="hl-1">.</span><span class="hl-4">minuteEstimatedTime</span><span class="hl-1">,</span><br/><span class="hl-1">      </span><span class="hl-4">when</span><span class="hl-1">,</span><br/><span class="hl-1">      </span><span class="hl-7">true</span><br/><span class="hl-1">    );</span><br/><span class="hl-1">    </span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">backtestResult</span><span class="hl-1"> = </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-4">strategyGlobalService</span><span class="hl-1">.</span><span class="hl-0">backtest</span><span class="hl-1">(</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">candles</span><span class="hl-1">, </span><span class="hl-4">when</span><span class="hl-1">, </span><span class="hl-7">true</span><span class="hl-1">);</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<a id="live-mode" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Live Mode<a href="#live-mode" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>In live mode, exchange functions operate on real-time data:</p>
<pre><code class="typescript"><span class="hl-5">// LiveLogicPrivateService uses current time</span><br/><span class="hl-3">while</span><span class="hl-1"> (</span><span class="hl-7">true</span><span class="hl-1">) {</span><br/><span class="hl-1">  </span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">when</span><span class="hl-1"> = </span><span class="hl-7">new</span><span class="hl-1"> </span><span class="hl-0">Date</span><span class="hl-1">(); </span><span class="hl-5">// Real-time timestamp</span><br/><span class="hl-1">  </span><br/><span class="hl-1">  </span><span class="hl-5">// getCandles fetches most recent historical data</span><br/><span class="hl-1">  </span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">result</span><span class="hl-1"> = </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-4">strategyGlobalService</span><span class="hl-1">.</span><span class="hl-0">tick</span><span class="hl-1">(</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">when</span><span class="hl-1">, </span><span class="hl-7">false</span><span class="hl-1">);</span><br/><span class="hl-1">  </span><br/><span class="hl-1">  </span><span class="hl-5">// getNextCandles would return empty array (future data unavailable)</span><br/><span class="hl-1">  </span><br/><span class="hl-1">  </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-0">sleep</span><span class="hl-1">(</span><span class="hl-8">TICK_TTL</span><span class="hl-1">); </span><span class="hl-5">// 61 seconds</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<a id="context-injection" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Context Injection<a href="#context-injection" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>All exchange functions receive context implicitly through <code>ExecutionContextService</code>:</p>
<pre><code class="typescript"><span class="hl-5">// Context is injected automatically</span><br/><span class="hl-4">ExecutionContextService</span><span class="hl-1">.</span><span class="hl-0">runInContext</span><span class="hl-1">(</span><br/><span class="hl-1">  </span><span class="hl-7">async</span><span class="hl-1"> () </span><span class="hl-7">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-5">// Inside this callback, exchange functions know:</span><br/><span class="hl-1">    </span><span class="hl-5">// - symbol: &quot;BTCUSDT&quot;</span><br/><span class="hl-1">    </span><span class="hl-5">// - when: new Date(&quot;2024-01-15T10:30:00Z&quot;)</span><br/><span class="hl-1">    </span><span class="hl-5">// - backtest: true</span><br/><span class="hl-1">    </span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">candles</span><span class="hl-1"> = </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-4">exchange</span><span class="hl-1">.</span><span class="hl-0">getCandles</span><span class="hl-1">(</span><span class="hl-2">&quot;BTCUSDT&quot;</span><span class="hl-1">, </span><span class="hl-2">&quot;1m&quot;</span><span class="hl-1">, </span><span class="hl-6">100</span><span class="hl-1">);</span><br/><span class="hl-1">  },</span><br/><span class="hl-1">  { </span><span class="hl-4">symbol:</span><span class="hl-1"> </span><span class="hl-2">&quot;BTCUSDT&quot;</span><span class="hl-1">, </span><span class="hl-4">when:</span><span class="hl-1"> </span><span class="hl-7">new</span><span class="hl-1"> </span><span class="hl-0">Date</span><span class="hl-1">(</span><span class="hl-2">&quot;2024-01-15T10:30:00Z&quot;</span><span class="hl-1">), </span><span class="hl-4">backtest:</span><span class="hl-1"> </span><span class="hl-7">true</span><span class="hl-1"> }</span><br/><span class="hl-1">);</span>
</code><button type="button">Copy</button></pre>

<hr>
<a id="exchange-function-integration-in-signal-lifecycle" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Exchange Function Integration in Signal Lifecycle<a href="#exchange-function-integration-in-signal-lifecycle" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p><img src="../media/21_Exchange_Functions_4.svg" alt="Mermaid Diagram"></p>
<p><strong>Diagram: Exchange Function Calls During Signal Lifecycle</strong></p>
<p>This sequence diagram shows how exchange functions are invoked during a typical signal lifecycle. The <code>getAveragePrice</code> function (which internally calls <code>getCandles</code>) is the most frequently called function, used for both signal generation and monitoring.</p>
<hr>
<a id="callback-integration" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Callback Integration<a href="#callback-integration" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>Exchange schemas can define an optional <code>onCandleData</code> callback that is invoked after every successful candle fetch:</p>
<pre><code class="typescript"><span class="hl-7">interface</span><span class="hl-1"> </span><span class="hl-13">IExchangeCallbacks</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-0">onCandleData</span><span class="hl-1">: (</span><br/><span class="hl-1">    </span><span class="hl-4">symbol</span><span class="hl-1">: </span><span class="hl-13">string</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-4">interval</span><span class="hl-1">: </span><span class="hl-13">CandleInterval</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-4">since</span><span class="hl-1">: </span><span class="hl-13">Date</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-4">limit</span><span class="hl-1">: </span><span class="hl-13">number</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-4">data</span><span class="hl-1">: </span><span class="hl-13">ICandleData</span><span class="hl-1">[]</span><br/><span class="hl-1">  ) </span><span class="hl-7">=&gt;</span><span class="hl-1"> </span><span class="hl-13">void</span><span class="hl-1">;</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<p>The callback is invoked with the filtered candle data after validation:</p>
<pre><code class="typescript"><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-7">this</span><span class="hl-1">.</span><span class="hl-4">params</span><span class="hl-1">.</span><span class="hl-4">callbacks</span><span class="hl-1">?.</span><span class="hl-4">onCandleData</span><span class="hl-1">) {</span><br/><span class="hl-1">  </span><span class="hl-7">this</span><span class="hl-1">.</span><span class="hl-4">params</span><span class="hl-1">.</span><span class="hl-4">callbacks</span><span class="hl-1">.</span><span class="hl-0">onCandleData</span><span class="hl-1">(</span><br/><span class="hl-1">    </span><span class="hl-4">symbol</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-4">interval</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-4">since</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-4">limit</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-4">filteredData</span><br/><span class="hl-1">  );</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<p>This enables users to implement custom logging, caching, or data persistence for fetched candles.</p>
</div></div><div class="col-sidebar"><div class="page-menu"><div class="tsd-navigation settings"><details class="tsd-accordion"><summary class="tsd-accordion-summary"><h3><svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-chevronDown"></use></svg>Settings</h3></summary><div class="tsd-accordion-details"><div class="tsd-filter-visibility"><span class="settings-label">Member Visibility</span><ul id="tsd-filter-options"><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-protected" name="protected"/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Protected</span></label></li><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-inherited" name="inherited" checked/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Inherited</span></label></li><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-external" name="external"/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>External</span></label></li></ul></div><div class="tsd-theme-toggle"><label class="settings-label" for="tsd-theme">Theme</label><select id="tsd-theme"><option value="os">OS</option><option value="light">Light</option><option value="dark">Dark</option></select></div></div></details></div><details open class="tsd-accordion tsd-page-navigation"><summary class="tsd-accordion-summary"><h3><svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-chevronDown"></use></svg>On This Page</h3></summary><div class="tsd-accordion-details"><a href="#exchange-functions"><span>Exchange <wbr/>Functions</span></a><ul><li><a href="#function-overview"><span>Function <wbr/>Overview</span></a></li><li><a href="#exchange-function-access-patterns"><span>Exchange <wbr/>Function <wbr/>Access <wbr/>Patterns</span></a></li><li><a href="#getcandles-function"><span>get<wbr/>Candles <wbr/>Function</span></a></li><li><ul><li><a href="#function-signature"><span>Function <wbr/>Signature</span></a></li><li><a href="#parameters"><span>Parameters</span></a></li><li><a href="#return-type"><span>Return <wbr/>Type</span></a></li><li><a href="#implementation-details"><span>Implementation <wbr/>Details</span></a></li><li><a href="#retry-logic"><span>Retry <wbr/>Logic</span></a></li></ul></li><li><a href="#getnextcandles-function"><span>get<wbr/>Next<wbr/>Candles <wbr/>Function</span></a></li><li><ul><li><a href="#function-signature-1"><span>Function <wbr/>Signature</span></a></li><li><a href="#backtest-only-guard"><span>Backtest-<wbr/>Only <wbr/>Guard</span></a></li><li><a href="#use-cases"><span>Use <wbr/>Cases</span></a></li></ul></li><li><a href="#getaverageprice-function-vwap-calculation"><span>get<wbr/>Average<wbr/>Price <wbr/>Function (VWAP <wbr/>Calculation)</span></a></li><li><ul><li><a href="#vwap-calculation-flow"><span>VWAP <wbr/>Calculation <wbr/>Flow</span></a></li><li><a href="#formula"><span>Formula</span></a></li><li><a href="#fallback-behavior"><span>Fallback <wbr/>Behavior</span></a></li><li><a href="#usage-context"><span>Usage <wbr/>Context</span></a></li></ul></li><li><a href="#format-functions"><span>Format <wbr/>Functions</span></a></li><li><ul><li><a href="#formatprice"><span>format<wbr/>Price</span></a></li><li><a href="#formatquantity"><span>format<wbr/>Quantity</span></a></li><li><a href="#implementation-pattern"><span>Implementation <wbr/>Pattern</span></a></li></ul></li><li><a href="#retry-logic-and-error-handling"><span>Retry <wbr/>Logic and <wbr/>Error <wbr/>Handling</span></a></li><li><ul><li><a href="#retry-configuration"><span>Retry <wbr/>Configuration</span></a></li><li><a href="#error-logging"><span>Error <wbr/>Logging</span></a></li></ul></li><li><a href="#data-validation-and-price-anomaly-detection"><span>Data <wbr/>Validation and <wbr/>Price <wbr/>Anomaly <wbr/>Detection</span></a></li><li><ul><li><a href="#validation-checks"><span>Validation <wbr/>Checks</span></a></li><li><a href="#reference-price-calculation"><span>Reference <wbr/>Price <wbr/>Calculation</span></a></li><li><a href="#anomaly-detection"><span>Anomaly <wbr/>Detection</span></a></li><li><a href="#validation-errors"><span>Validation <wbr/>Errors</span></a></li></ul></li><li><a href="#configuration-parameters"><span>Configuration <wbr/>Parameters</span></a></li><li><ul><li><a href="#configuration-example"><span>Configuration <wbr/>Example</span></a></li></ul></li><li><a href="#usage-in-different-execution-modes"><span>Usage in <wbr/>Different <wbr/>Execution <wbr/>Modes</span></a></li><li><ul><li><a href="#backtest-mode"><span>Backtest <wbr/>Mode</span></a></li><li><a href="#live-mode"><span>Live <wbr/>Mode</span></a></li><li><a href="#context-injection"><span>Context <wbr/>Injection</span></a></li></ul></li><li><a href="#exchange-function-integration-in-signal-lifecycle"><span>Exchange <wbr/>Function <wbr/>Integration in <wbr/>Signal <wbr/>Lifecycle</span></a></li><li><a href="#callback-integration"><span>Callback <wbr/>Integration</span></a></li></ul></div></details></div><div class="site-menu"><nav class="tsd-navigation"><a href="../modules.html">backtest-kit</a><ul class="tsd-small-nested-navigation" id="tsd-nav-container"><li>Loading...</li></ul></nav></div></div></div><footer><p class="tsd-generator">Generated using <a href="https://typedoc.org/" target="_blank">TypeDoc</a></p></footer><div class="overlay"></div></body></html>

<!-- Yandex.Metrika counter -->
<script type="text/javascript">
    (function(m,e,t,r,i,k,a){
        m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
        m[i].l=1*new Date();
        for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }}
        k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)
    })(window, document,'script','https://mc.yandex.ru/metrika/tag.js?id=105455585', 'ym');

    ym(105455585, 'init', {ssr:true, webvisor:true, clickmap:true, ecommerce:"dataLayer", accurateTrackBounce:true, trackLinks:true});
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/105455585" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
<!-- /Yandex.Metrika counter -->

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-3MQZEBBDDR"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-3MQZEBBDDR');
</script>
