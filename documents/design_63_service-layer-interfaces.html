<!DOCTYPE html><html class="default" lang="en" data-base=".."><head><meta charset="utf-8"/><meta http-equiv="x-ua-compatible" content="IE=edge"/><title>design/63_service-layer-interfaces | backtest-kit</title><meta name="description" content="Documentation for backtest-kit"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="stylesheet" href="../assets/style.css"/><link rel="stylesheet" href="../assets/highlight.css"/><script defer src="../assets/main.js"></script><script async src="../assets/icons.js" id="tsd-icons-script"></script><script async src="../assets/search.js" id="tsd-search-script"></script><script async src="../assets/navigation.js" id="tsd-nav-script"></script><script async src="../assets/hierarchy.js" id="tsd-hierarchy-script"></script></head><body><script>document.documentElement.dataset.theme = localStorage.getItem("tsd-theme") || "os";document.body.style.display="none";setTimeout(() => app?app.showPage():document.body.style.removeProperty("display"),500)</script><header class="tsd-page-toolbar"><div class="tsd-toolbar-contents container"><div class="table-cell" id="tsd-search"><div class="field"><label for="tsd-search-field" class="tsd-widget tsd-toolbar-icon search no-caption"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-search"></use></svg></label><input type="text" id="tsd-search-field" aria-label="Search"/></div><div class="field"><div id="tsd-toolbar-links"></div></div><ul class="results"><li class="state loading">Preparing search index...</li><li class="state failure">The search index is not available</li></ul><a href="../index.html" class="title">backtest-kit</a></div><div class="table-cell" id="tsd-widgets"><a href="#" class="tsd-widget tsd-toolbar-icon menu no-caption" data-toggle="menu" aria-label="Menu"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-menu"></use></svg></a></div></div></header><div class="container container-main"><div class="col-content"><div class="tsd-page-title"><ul class="tsd-breadcrumb"><li><a href="../modules.html">backtest-kit</a></li><li><a href="design_63_service-layer-interfaces.html">design/63_service-layer-interfaces</a></li></ul></div><div class="tsd-panel tsd-typography"><a id="service-layer-interfaces" class="tsd-anchor"></a><h1 class="tsd-anchor-link">Service Layer Interfaces<a href="#service-layer-interfaces" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h1><a id="purpose-and-scope" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Purpose and Scope<a href="#purpose-and-scope" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>This page documents the internal service interfaces used by the backtest-kit service layer. These interfaces define the contract between service layer components (Connection Services, Core Services, Global Services) and the client layer implementations (ClientStrategy, ClientExchange, ClientFrame, ClientRisk, ClientPartial).</p>
<p><strong>Target Audience:</strong> Advanced users who need to understand the internal architecture for debugging, extending the framework, or implementing custom components.</p>
<p><strong>Related Pages:</strong></p>
<ul>
<li>For user-facing schema interfaces (<code>IStrategySchema</code>, <code>IExchangeSchema</code>, etc.), see <a href="design_56_api-reference.html">Core Interfaces</a></li>
<li>For public API methods and classes, see <a href="design_56_api-reference.html">Execution Classes API</a></li>
<li>For service layer architecture overview, see <a href="design_14_architecture-deep-dive.html">Service Layer &amp; Dependency Injection</a></li>
</ul>
<hr>
<a id="architecture-overview" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Architecture Overview<a href="#architecture-overview" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>The service layer acts as a bridge between user-defined schemas and runtime client implementations. Service interfaces define the operational contract that client classes must fulfill.</p>
<p><img src="../media/63_service-layer-interfaces_0.svg" alt="Mermaid Diagram"></p>
<hr>
<a id="core-domain-interfaces" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Core Domain Interfaces<a href="#core-domain-interfaces" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><a id="istrategy-interface" class="tsd-anchor"></a><h3 class="tsd-anchor-link">IStrategy Interface<a href="#istrategy-interface" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>The <code>IStrategy</code> interface defines the execution contract for trading strategies. <code>ClientStrategy</code> implements this interface to provide signal generation and monitoring capabilities.</p>
<p><strong>Location:</strong> Not explicitly exported, but documented in <code>docs/interfaces/IStrategy.md</code></p>
<p><strong>Methods:</strong></p>
<table>
<thead>
<tr>
<th>Method</th>
<th>Signature</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>tick</code></td>
<td><code>(symbol: string) =&gt; Promise&lt;IStrategyTickResult&gt;</code></td>
<td>Single tick of strategy execution with VWAP monitoring, throttled signal generation, and TP/SL checks</td>
</tr>
<tr>
<td><code>getPendingSignal</code></td>
<td><code>(symbol: string) =&gt; Promise&lt;ISignalRow&gt;</code></td>
<td>Retrieves currently active signal or null</td>
</tr>
<tr>
<td><code>backtest</code></td>
<td><code>(candles: ICandleData[]) =&gt; Promise&lt;IStrategyBacktestResult&gt;</code></td>
<td>Fast backtest using historical candles with VWAP calculation</td>
</tr>
<tr>
<td><code>stop</code></td>
<td><code>(symbol: string) =&gt; Promise&lt;void&gt;</code></td>
<td>Prevents new signal generation while allowing active signals to complete</td>
</tr>
</tbody>
</table>
<p><strong>Key Characteristics:</strong></p>
<ul>
<li>Discriminated union return types for type-safe state handling</li>
<li>Async operations for data fetching and validation</li>
<li>Stateful instance (maintains <code>_pendingSignal</code> and <code>_stopped</code> flags)</li>
<li>Context-aware through <code>ExecutionContextService</code> and <code>MethodContextService</code></li>
</ul>
<p><strong>Usage Example:</strong>
Connection services route calls to <code>IStrategy</code> methods:</p>
<pre><code class="typescript"><span class="hl-5">// StrategyConnectionService routes to ClientStrategy instance</span><br/><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">strategy</span><span class="hl-1">: </span><span class="hl-11">IStrategy</span><span class="hl-1"> = </span><span class="hl-4">strategyConnectionService</span><span class="hl-1">.</span><span class="hl-0">getStrategy</span><span class="hl-1">(</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">strategyName</span><span class="hl-1">);</span><br/><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">result</span><span class="hl-1"> = </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-4">strategy</span><span class="hl-1">.</span><span class="hl-0">tick</span><span class="hl-1">(</span><span class="hl-4">symbol</span><span class="hl-1">);</span>
</code><button type="button">Copy</button></pre>

<hr>
<a id="iexchange-interface" class="tsd-anchor"></a><h3 class="tsd-anchor-link">IExchange Interface<a href="#iexchange-interface" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>The <code>IExchange</code> interface defines data access and formatting operations for exchange data sources. <code>ClientExchange</code> implements this interface to provide candle data and VWAP calculations.</p>
<p><strong>Location:</strong> <code>types.d.ts:160-205</code></p>
<p><strong>Methods:</strong></p>
<table>
<thead>
<tr>
<th>Method</th>
<th>Signature</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>getCandles</code></td>
<td><code>(symbol: string, interval: CandleInterval, limit: number) =&gt; Promise&lt;ICandleData[]&gt;</code></td>
<td>Fetches historical candles backwards from execution context time</td>
</tr>
<tr>
<td><code>getNextCandles</code></td>
<td><code>(symbol: string, interval: CandleInterval, limit: number) =&gt; Promise&lt;ICandleData[]&gt;</code></td>
<td>Fetches future candles forward from execution context time (backtest only)</td>
</tr>
<tr>
<td><code>formatQuantity</code></td>
<td><code>(symbol: string, quantity: number) =&gt; Promise&lt;string&gt;</code></td>
<td>Formats quantity according to exchange precision rules</td>
</tr>
<tr>
<td><code>formatPrice</code></td>
<td><code>(symbol: string, price: number) =&gt; Promise&lt;string&gt;</code></td>
<td>Formats price according to exchange precision rules</td>
</tr>
<tr>
<td><code>getAveragePrice</code></td>
<td><code>(symbol: string) =&gt; Promise&lt;number&gt;</code></td>
<td>Calculates VWAP from last 5 1-minute candles using formula: VWAP = Σ(Typical Price × Volume) / Σ(Volume)</td>
</tr>
</tbody>
</table>
<p><strong>Key Characteristics:</strong></p>
<ul>
<li>Read-only operations (no state modification)</li>
<li>Context-aware through <code>ExecutionContextService</code> (uses <code>when</code> timestamp)</li>
<li>All methods accept <code>symbol</code> parameter for multi-symbol support</li>
<li>VWAP calculation uses candle data: <code>(High + Low + Close) / 3 × Volume</code></li>
</ul>
<p><strong>Implementation Details:</strong>
<code>ClientExchange</code> wraps user-defined <code>IExchangeSchema.getCandles</code> function and adds:</p>
<ul>
<li>Candle buffer management (caches up to 500 candles)</li>
<li>Anomaly detection (filters candles with zero/NaN/Infinity prices)</li>
<li>Retry logic with exponential backoff</li>
<li>VWAP calculation using last 5 1-minute candles</li>
</ul>
<hr>
<a id="iframe-interface" class="tsd-anchor"></a><h3 class="tsd-anchor-link">IFrame Interface<a href="#iframe-interface" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>The <code>IFrame</code> interface defines timeframe generation for backtesting. <code>ClientFrame</code> implements this interface to provide timestamp arrays for iteration.</p>
<p><strong>Location:</strong> <code>types.d.ts:280-289</code></p>
<p><strong>Methods:</strong></p>
<table>
<thead>
<tr>
<th>Method</th>
<th>Signature</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>getTimeframe</code></td>
<td><code>(symbol: string, frameName: FrameName) =&gt; Promise&lt;Date[]&gt;</code></td>
<td>Generates array of timestamps for backtest iteration, spaced according to configured interval</td>
</tr>
</tbody>
</table>
<p><strong>Key Characteristics:</strong></p>
<ul>
<li>Single method interface (simplest domain interface)</li>
<li>Symbol parameter unused but included for API consistency</li>
<li>Stateless operation (generates dates from schema configuration)</li>
<li>Interval options: <code>1m, 3m, 5m, 15m, 30m, 1h, 2h, 4h, 6h, 8h, 12h, 1d, 3d</code></li>
</ul>
<p><strong>Implementation Details:</strong>
<code>ClientFrame</code> uses <code>types.d.ts:262-275</code> schema properties:</p>
<ul>
<li><code>startDate</code>: Beginning of backtest period (inclusive)</li>
<li><code>endDate</code>: End of backtest period (inclusive)</li>
<li><code>interval</code>: Time spacing between timestamps</li>
<li><code>callbacks.onTimeframe</code>: Optional callback after generation</li>
</ul>
<p><strong>Usage Pattern:</strong></p>
<pre><code class="typescript"><span class="hl-5">// FrameConnectionService routes to ClientFrame instance</span><br/><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">frame</span><span class="hl-1">: </span><span class="hl-11">IFrame</span><span class="hl-1"> = </span><span class="hl-4">frameConnectionService</span><span class="hl-1">.</span><span class="hl-0">getFrame</span><span class="hl-1">(</span><span class="hl-4">frameName</span><span class="hl-1">);</span><br/><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">timeframes</span><span class="hl-1"> = </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-4">frame</span><span class="hl-1">.</span><span class="hl-0">getTimeframe</span><span class="hl-1">(</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">frameName</span><span class="hl-1">);</span><br/><span class="hl-5">// Returns: [Date(2024-01-01 00:00), Date(2024-01-01 00:01), ...]</span>
</code><button type="button">Copy</button></pre>

<hr>
<a id="irisk-interface" class="tsd-anchor"></a><h3 class="tsd-anchor-link">IRisk Interface<a href="#irisk-interface" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>The <code>IRisk</code> interface defines risk management operations for signal validation. <code>ClientRisk</code> and <code>MergeRisk</code> implement this interface to provide portfolio-level controls.</p>
<p><strong>Location:</strong> <code>types.d.ts:448-479</code></p>
<p><strong>Methods:</strong></p>
<table>
<thead>
<tr>
<th>Method</th>
<th>Signature</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>checkSignal</code></td>
<td><code>(params: IRiskCheckArgs) =&gt; Promise&lt;boolean&gt;</code></td>
<td>Validates signal against risk limits, returns true if allowed</td>
</tr>
<tr>
<td><code>addSignal</code></td>
<td><code>(symbol: string, context: {strategyName, riskName}) =&gt; Promise&lt;void&gt;</code></td>
<td>Registers new opened signal/position</td>
</tr>
<tr>
<td><code>removeSignal</code></td>
<td><code>(symbol: string, context: {strategyName, riskName}) =&gt; Promise&lt;void&gt;</code></td>
<td>Removes closed signal/position</td>
</tr>
</tbody>
</table>
<p><strong>Key Data Structures:</strong></p>
<p><img src="../media/63_service-layer-interfaces_1.svg" alt="Mermaid Diagram"></p>
<p><strong>Key Characteristics:</strong></p>
<ul>
<li>Stateful tracking of active positions across strategies</li>
<li>Validation functions throw errors to reject signals</li>
<li><code>addSignal</code>/<code>removeSignal</code> lifecycle matches signal open/close</li>
<li>Multi-strategy awareness through <code>activePositions</code> array</li>
</ul>
<p><strong>Implementation Variants:</strong></p>
<ol>
<li><strong>ClientRisk</strong> (<code>types.d.ts:417-426</code>): Single risk profile with custom validations</li>
<li><strong>MergeRisk</strong>: Combines multiple <code>ClientRisk</code> instances (used when <code>riskList</code> provided in strategy schema)</li>
</ol>
<p><strong>Validation Flow:</strong>
<img src="../media/63_service-layer-interfaces_2.svg" alt="Mermaid Diagram"></p>
<hr>
<a id="ipartial-interface" class="tsd-anchor"></a><h3 class="tsd-anchor-link">IPartial Interface<a href="#ipartial-interface" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>The <code>IPartial</code> interface defines profit/loss milestone tracking for active signals. <code>ClientPartial</code> implements this interface to emit events when signals reach 10%, 20%, 30% profit or loss thresholds.</p>
<p><strong>Location:</strong> <code>types.d.ts:548-639</code></p>
<p><strong>Methods:</strong></p>
<table>
<thead>
<tr>
<th>Method</th>
<th>Signature</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>profit</code></td>
<td><code>(symbol, data, currentPrice, revenuePercent, backtest, when) =&gt; Promise&lt;void&gt;</code></td>
<td>Processes profit state and emits events for new profit levels reached</td>
</tr>
<tr>
<td><code>loss</code></td>
<td><code>(symbol, data, currentPrice, lossPercent, backtest, when) =&gt; Promise&lt;void&gt;</code></td>
<td>Processes loss state and emits events for new loss levels reached</td>
</tr>
<tr>
<td><code>clear</code></td>
<td><code>(symbol, data, priceClose, backtest) =&gt; Promise&lt;void&gt;</code></td>
<td>Clears partial profit/loss state when signal closes</td>
</tr>
</tbody>
</table>
<p><strong>Type Definition: PartialLevel</strong></p>
<pre><code class="typescript"><span class="hl-7">type</span><span class="hl-1"> </span><span class="hl-11">PartialLevel</span><span class="hl-1"> = </span><span class="hl-6">10</span><span class="hl-1"> | </span><span class="hl-6">20</span><span class="hl-1"> | </span><span class="hl-6">30</span><span class="hl-1"> | </span><span class="hl-6">40</span><span class="hl-1"> | </span><span class="hl-6">50</span><span class="hl-1"> | </span><span class="hl-6">60</span><span class="hl-1"> | </span><span class="hl-6">70</span><span class="hl-1"> | </span><span class="hl-6">80</span><span class="hl-1"> | </span><span class="hl-6">90</span><span class="hl-1"> | </span><span class="hl-6">100</span><span class="hl-1">;</span>
</code><button type="button">Copy</button></pre>

<p><strong>State Management:</strong></p>
<p><img src="../media/63_service-layer-interfaces_3.svg" alt="Mermaid Diagram"></p>
<p><strong>Key Characteristics:</strong></p>
<ul>
<li>Stateful tracking using <code>Map&lt;signalId, IPartialState&gt;</code> where state contains:
<ul>
<li><code>profitLevels: Set&lt;PartialLevel&gt;</code> - Deduplication via Set</li>
<li><code>lossLevels: Set&lt;PartialLevel&gt;</code> - Prevents duplicate events</li>
</ul>
</li>
<li>Persistent state via <code>PersistPartialAdapter</code> for crash recovery</li>
<li>Only tracks levels &gt;= 10% (no sub-10% granularity)</li>
<li>Separate profit and loss tracking (signal can have both if price oscillates)</li>
</ul>
<p><strong>Event Emission Logic:</strong></p>
<p><img src="../media/63_service-layer-interfaces_4.svg" alt="Mermaid Diagram"></p>
<p><strong>Persistence Schema:</strong></p>
<pre><code class="typescript"><span class="hl-7">interface</span><span class="hl-1"> </span><span class="hl-11">IPartialData</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-4">profitLevels</span><span class="hl-1">: </span><span class="hl-11">PartialLevel</span><span class="hl-1">[];  </span><span class="hl-5">// Array (serialized from Set)</span><br/><span class="hl-1">    </span><span class="hl-4">lossLevels</span><span class="hl-1">: </span><span class="hl-11">PartialLevel</span><span class="hl-1">[];    </span><span class="hl-5">// Array (serialized from Set)</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<p>Stored as: <code>Map&lt;signalId, IPartialData&gt;</code> in <code>PersistPartialAdapter</code></p>
<hr>
<a id="service-categories" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Service Categories<a href="#service-categories" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><a id="connection-services-memoized-factories" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Connection Services (Memoized Factories)<a href="#connection-services-memoized-factories" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Connection services act as memoized factories that create and cache client instances. They route operations based on context and implement the factory pattern with caching.</p>
<p><img src="../media/63_service-layer-interfaces_5.svg" alt="Mermaid Diagram"></p>
<p><strong>Common Pattern:</strong></p>
<p>All connection services follow this pattern:</p>
<ol>
<li>Inject schema service + context services</li>
<li>Implement memoized getter (e.g., <code>getStrategy</code>, <code>getExchange</code>)</li>
<li>Delegate method calls to cached client instances</li>
<li>Use context services for routing decisions</li>
</ol>
<p><strong>Example: StrategyConnectionService</strong></p>
<p>Key properties from <code>docs/classes/StrategyConnectionService.md:21-68</code>:</p>
<table>
<thead>
<tr>
<th>Property</th>
<th>Type</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>loggerService</code></td>
<td>LoggerService</td>
<td>Centralized logging</td>
</tr>
<tr>
<td><code>executionContextService</code></td>
<td>TExecutionContextService</td>
<td>Symbol, when, backtest flag</td>
</tr>
<tr>
<td><code>methodContextService</code></td>
<td>MethodContextService</td>
<td>Strategy/exchange/frame names</td>
</tr>
<tr>
<td><code>strategySchemaService</code></td>
<td>StrategySchemaService</td>
<td>Schema registry</td>
</tr>
<tr>
<td><code>riskConnectionService</code></td>
<td>RiskConnectionService</td>
<td>Risk validation routing</td>
</tr>
<tr>
<td><code>exchangeConnectionService</code></td>
<td>ExchangeConnectionService</td>
<td>Exchange data routing</td>
</tr>
<tr>
<td><code>partialConnectionService</code></td>
<td>PartialConnectionService</td>
<td>Partial tracking routing</td>
</tr>
<tr>
<td><code>getStrategy</code></td>
<td>Memoized function</td>
<td>Returns cached <code>ClientStrategy</code></td>
</tr>
</tbody>
</table>
<p><strong>Memoization Key Pattern:</strong></p>
<pre><code class="typescript"><span class="hl-5">// StrategyConnectionService</span><br/><span class="hl-4">key</span><span class="hl-1"> = </span><span class="hl-2">`</span><span class="hl-7">${</span><span class="hl-4">symbol</span><span class="hl-7">}</span><span class="hl-2">:</span><span class="hl-7">${</span><span class="hl-4">strategyName</span><span class="hl-7">}</span><span class="hl-2">`</span><span class="hl-1">;  </span><span class="hl-5">// &quot;BTCUSDT:my-strategy&quot;</span><br/><br/><span class="hl-5">// ExchangeConnectionService</span><br/><span class="hl-4">key</span><span class="hl-1"> = </span><span class="hl-4">exchangeName</span><span class="hl-1">;  </span><span class="hl-5">// &quot;binance&quot;</span><br/><br/><span class="hl-5">// FrameConnectionService</span><br/><span class="hl-4">key</span><span class="hl-1"> = </span><span class="hl-4">frameName</span><span class="hl-1">;  </span><span class="hl-5">// &quot;1d-backtest&quot;</span><br/><br/><span class="hl-5">// RiskConnectionService</span><br/><span class="hl-4">key</span><span class="hl-1"> = </span><span class="hl-4">riskName</span><span class="hl-1">;  </span><span class="hl-5">// &quot;portfolio-limit&quot;</span><br/><br/><span class="hl-5">// PartialConnectionService</span><br/><span class="hl-4">key</span><span class="hl-1"> = </span><span class="hl-2">`</span><span class="hl-7">${</span><span class="hl-4">symbol</span><span class="hl-7">}</span><span class="hl-2">:</span><span class="hl-7">${</span><span class="hl-4">signalId</span><span class="hl-7">}</span><span class="hl-2">`</span><span class="hl-1">;  </span><span class="hl-5">// &quot;BTCUSDT:uuid-v4-here&quot;</span>
</code><button type="button">Copy</button></pre>

<hr>
<a id="core-services-orchestration" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Core Services (Orchestration)<a href="#core-services-orchestration" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Core services orchestrate business logic by coordinating connection services and validation services. They implement the service facade pattern.</p>
<p><img src="../media/63_service-layer-interfaces_6.svg" alt="Mermaid Diagram"></p>
<p><strong>StrategyCoreService Responsibilities:</strong></p>
<ol>
<li>Pre-execution validation (strategy exists, risk exists)</li>
<li>Context propagation via <code>MethodContextService</code></li>
<li>Routing tick/backtest calls to <code>StrategyConnectionService</code></li>
<li>No business logic (pure orchestration)</li>
</ol>
<p><strong>Delegation Pattern:</strong></p>
<p><img src="../media/63_service-layer-interfaces_7.svg" alt="Mermaid Diagram"></p>
<hr>
<a id="global-services-shared-state" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Global Services (Shared State)<a href="#global-services-shared-state" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Global services manage cross-strategy state and provide singleton access to shared resources.</p>
<p><img src="../media/63_service-layer-interfaces_8.svg" alt="Mermaid Diagram"></p>
<p><strong>RiskGlobalService:</strong></p>
<p>Tracks active positions across all strategies for portfolio-level risk management. Maintains in-memory map of active signals and persists to disk for crash recovery.</p>
<p><strong>Key Data:</strong></p>
<ul>
<li><code>Map&lt;symbol, Set&lt;{strategyName, riskName}&gt;&gt;</code> - Active position tracking</li>
<li>Updated via <code>IRisk.addSignal()</code> and <code>IRisk.removeSignal()</code></li>
<li>Queried by <code>IRiskValidationPayload.activePositionCount</code> and <code>activePositions</code></li>
</ul>
<p><strong>PartialGlobalService:</strong></p>
<p>Aggregates partial profit/loss events across symbols for portfolio-wide reporting. Provides global access to partial state without requiring symbol-specific routing.</p>
<p><strong>OptimizerGlobalService:</strong></p>
<p>Manages LLM connection pool and prompt history for strategy optimization. Implements conversation state management for iterative code generation.</p>
<hr>
<a id="dependency-injection-flow" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Dependency Injection Flow<a href="#dependency-injection-flow" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>The service layer uses a custom dependency injection container built with Symbol-based tokens. The <code>backtest</code> object aggregates all services.</p>
<p><img src="../media/63_service-layer-interfaces_9.svg" alt="Mermaid Diagram"></p>
<p><strong>Resolution Order:</strong></p>
<p>Services are resolved lazily when first accessed. Dependencies are injected via constructor parameters using <code>inject()</code> function.</p>
<p><strong>Example Service Registration:</strong></p>
<pre><code class="typescript"><span class="hl-5">// Conceptual representation of service registration</span><br/><span class="hl-0">provide</span><span class="hl-1">(</span><span class="hl-8">TYPES</span><span class="hl-1">.</span><span class="hl-4">StrategyConnectionService</span><span class="hl-1">, () </span><span class="hl-7">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-3">return</span><span class="hl-1"> </span><span class="hl-7">new</span><span class="hl-1"> </span><span class="hl-0">StrategyConnectionService</span><span class="hl-1">(</span><br/><span class="hl-1">        </span><span class="hl-0">inject</span><span class="hl-1">(</span><span class="hl-8">TYPES</span><span class="hl-1">.</span><span class="hl-4">LoggerService</span><span class="hl-1">),</span><br/><span class="hl-1">        </span><span class="hl-0">inject</span><span class="hl-1">(</span><span class="hl-8">TYPES</span><span class="hl-1">.</span><span class="hl-4">ExecutionContextService</span><span class="hl-1">),</span><br/><span class="hl-1">        </span><span class="hl-0">inject</span><span class="hl-1">(</span><span class="hl-8">TYPES</span><span class="hl-1">.</span><span class="hl-4">StrategySchemaService</span><span class="hl-1">),</span><br/><span class="hl-1">        </span><span class="hl-0">inject</span><span class="hl-1">(</span><span class="hl-8">TYPES</span><span class="hl-1">.</span><span class="hl-4">RiskConnectionService</span><span class="hl-1">),</span><br/><span class="hl-1">        </span><span class="hl-0">inject</span><span class="hl-1">(</span><span class="hl-8">TYPES</span><span class="hl-1">.</span><span class="hl-4">ExchangeConnectionService</span><span class="hl-1">),</span><br/><span class="hl-1">        </span><span class="hl-0">inject</span><span class="hl-1">(</span><span class="hl-8">TYPES</span><span class="hl-1">.</span><span class="hl-4">MethodContextService</span><span class="hl-1">),</span><br/><span class="hl-1">        </span><span class="hl-0">inject</span><span class="hl-1">(</span><span class="hl-8">TYPES</span><span class="hl-1">.</span><span class="hl-4">PartialConnectionService</span><span class="hl-1">)</span><br/><span class="hl-1">    );</span><br/><span class="hl-1">});</span>
</code><button type="button">Copy</button></pre>

<p><strong>Access Pattern:</strong></p>
<p>All services are accessed through the <code>backtest</code> object:</p>
<pre><code class="typescript"><span class="hl-3">import</span><span class="hl-1"> { </span><span class="hl-4">lib</span><span class="hl-1"> } </span><span class="hl-3">from</span><span class="hl-1"> </span><span class="hl-2">&#39;backtest-kit&#39;</span><span class="hl-1">;</span><br/><br/><span class="hl-5">// Access services</span><br/><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">logger</span><span class="hl-1"> = </span><span class="hl-4">lib</span><span class="hl-1">.</span><span class="hl-4">loggerService</span><span class="hl-1">;</span><br/><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">strategyCore</span><span class="hl-1"> = </span><span class="hl-4">lib</span><span class="hl-1">.</span><span class="hl-4">strategyCoreService</span><span class="hl-1">;</span><br/><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">strategyConnection</span><span class="hl-1"> = </span><span class="hl-4">lib</span><span class="hl-1">.</span><span class="hl-4">strategyConnectionService</span><span class="hl-1">;</span>
</code><button type="button">Copy</button></pre>

<hr>
<a id="context-propagation" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Context Propagation<a href="#context-propagation" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>Service interfaces receive ambient context through two scoped services: <code>ExecutionContextService</code> and <code>MethodContextService</code>. This enables implicit parameter passing without polluting method signatures.</p>
<p><img src="../media/63_service-layer-interfaces_10.svg" alt="Mermaid Diagram"></p>
<p><strong>ExecutionContextService:</strong></p>
<p>Provides runtime execution parameters. Accessible via <code>executionContextService.context</code>:</p>
<pre><code class="typescript"><span class="hl-7">interface</span><span class="hl-1"> </span><span class="hl-11">IExecutionContext</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-4">symbol</span><span class="hl-1">: </span><span class="hl-11">string</span><span class="hl-1">;        </span><span class="hl-5">// &quot;BTCUSDT&quot;</span><br/><span class="hl-1">    </span><span class="hl-4">when</span><span class="hl-1">: </span><span class="hl-11">Date</span><span class="hl-1">;            </span><span class="hl-5">// Current timestamp</span><br/><span class="hl-1">    </span><span class="hl-4">backtest</span><span class="hl-1">: </span><span class="hl-11">boolean</span><span class="hl-1">;     </span><span class="hl-5">// true for backtest, false for live</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<p><strong>MethodContextService:</strong></p>
<p>Provides schema routing parameters. Accessible via <code>methodContextService.context</code>:</p>
<pre><code class="typescript"><span class="hl-7">interface</span><span class="hl-1"> </span><span class="hl-11">IMethodContext</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-4">exchangeName</span><span class="hl-1">: </span><span class="hl-11">string</span><span class="hl-1">;   </span><span class="hl-5">// &quot;binance&quot;</span><br/><span class="hl-1">    </span><span class="hl-4">strategyName</span><span class="hl-1">: </span><span class="hl-11">string</span><span class="hl-1">;   </span><span class="hl-5">// &quot;my-strategy&quot;</span><br/><span class="hl-1">    </span><span class="hl-4">frameName</span><span class="hl-1">: </span><span class="hl-11">string</span><span class="hl-1">;      </span><span class="hl-5">// &quot;1d-backtest&quot; or &quot;&quot; for live</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<p><strong>Usage Pattern:</strong></p>
<pre><code class="typescript"><span class="hl-5">// In ClientExchange.getCandles()</span><br/><span class="hl-7">const</span><span class="hl-1"> { </span><span class="hl-8">when</span><span class="hl-1">, </span><span class="hl-8">backtest</span><span class="hl-1"> } = </span><span class="hl-7">this</span><span class="hl-1">.</span><span class="hl-4">executionContextService</span><span class="hl-1">.</span><span class="hl-4">context</span><span class="hl-1">;</span><br/><br/><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-4">backtest</span><span class="hl-1">) {</span><br/><span class="hl-1">    </span><span class="hl-5">// Fetch backward from &#39;when&#39;</span><br/><span class="hl-1">    </span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">since</span><span class="hl-1"> = </span><span class="hl-7">new</span><span class="hl-1"> </span><span class="hl-0">Date</span><span class="hl-1">(</span><span class="hl-4">when</span><span class="hl-1">.</span><span class="hl-0">getTime</span><span class="hl-1">() - </span><span class="hl-4">interval</span><span class="hl-1"> * </span><span class="hl-4">limit</span><span class="hl-1">);</span><br/><span class="hl-1">    </span><span class="hl-3">return</span><span class="hl-1"> </span><span class="hl-7">this</span><span class="hl-1">.</span><span class="hl-0">getCandlesImpl</span><span class="hl-1">(</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">interval</span><span class="hl-1">, </span><span class="hl-4">since</span><span class="hl-1">, </span><span class="hl-4">limit</span><span class="hl-1">);</span><br/><span class="hl-1">} </span><span class="hl-3">else</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-5">// Fetch most recent</span><br/><span class="hl-1">    </span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">since</span><span class="hl-1"> = </span><span class="hl-7">new</span><span class="hl-1"> </span><span class="hl-0">Date</span><span class="hl-1">(</span><span class="hl-4">Date</span><span class="hl-1">.</span><span class="hl-0">now</span><span class="hl-1">() - </span><span class="hl-4">interval</span><span class="hl-1"> * </span><span class="hl-4">limit</span><span class="hl-1">);</span><br/><span class="hl-1">    </span><span class="hl-3">return</span><span class="hl-1"> </span><span class="hl-7">this</span><span class="hl-1">.</span><span class="hl-0">getCandlesImpl</span><span class="hl-1">(</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">interval</span><span class="hl-1">, </span><span class="hl-4">since</span><span class="hl-1">, </span><span class="hl-4">limit</span><span class="hl-1">);</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<hr>
<a id="method-signature-reference" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Method Signature Reference<a href="#method-signature-reference" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><a id="istrategy-methods" class="tsd-anchor"></a><h3 class="tsd-anchor-link">IStrategy Methods<a href="#istrategy-methods" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><a id="ticksymbol-string-promise" class="tsd-anchor"></a><h4 class="tsd-anchor-link">tick(symbol: string): Promise<IStrategyTickResult><a href="#ticksymbol-string-promise" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><p>Executes single strategy tick with throttled signal generation and TP/SL monitoring.</p>
<p><strong>Return Types (Discriminated Union):</strong></p>
<pre><code class="typescript"><span class="hl-7">type</span><span class="hl-1"> </span><span class="hl-11">IStrategyTickResult</span><span class="hl-1"> = </span><br/><span class="hl-1">    | { </span><span class="hl-4">action</span><span class="hl-1">: </span><span class="hl-2">&quot;idle&quot;</span><span class="hl-1">, </span><span class="hl-4">signal</span><span class="hl-1">: </span><span class="hl-11">null</span><span class="hl-1">, </span><span class="hl-4">currentPrice</span><span class="hl-1">, ... }</span><br/><span class="hl-1">    | { </span><span class="hl-4">action</span><span class="hl-1">: </span><span class="hl-2">&quot;scheduled&quot;</span><span class="hl-1">, </span><span class="hl-4">signal</span><span class="hl-1">: </span><span class="hl-11">IScheduledSignalRow</span><span class="hl-1">, ... }</span><br/><span class="hl-1">    | { </span><span class="hl-4">action</span><span class="hl-1">: </span><span class="hl-2">&quot;opened&quot;</span><span class="hl-1">, </span><span class="hl-4">signal</span><span class="hl-1">: </span><span class="hl-11">ISignalRow</span><span class="hl-1">, ... }</span><br/><span class="hl-1">    | { </span><span class="hl-4">action</span><span class="hl-1">: </span><span class="hl-2">&quot;active&quot;</span><span class="hl-1">, </span><span class="hl-4">signal</span><span class="hl-1">: </span><span class="hl-11">ISignalRow</span><span class="hl-1">, </span><span class="hl-4">percentTp</span><span class="hl-1">, </span><span class="hl-4">percentSl</span><span class="hl-1">, ... }</span><br/><span class="hl-1">    | { </span><span class="hl-4">action</span><span class="hl-1">: </span><span class="hl-2">&quot;closed&quot;</span><span class="hl-1">, </span><span class="hl-4">signal</span><span class="hl-1">: </span><span class="hl-11">ISignalRow</span><span class="hl-1">, </span><span class="hl-4">closeReason</span><span class="hl-1">, </span><span class="hl-4">pnl</span><span class="hl-1">, ... }</span><br/><span class="hl-1">    | { </span><span class="hl-4">action</span><span class="hl-1">: </span><span class="hl-2">&quot;cancelled&quot;</span><span class="hl-1">, </span><span class="hl-4">signal</span><span class="hl-1">: </span><span class="hl-11">IScheduledSignalRow</span><span class="hl-1">, ... }</span>
</code><button type="button">Copy</button></pre>

<p><strong>Flow:</strong></p>
<ol>
<li>Check if strategy stopped → return idle</li>
<li>Check interval throttling → skip if too soon</li>
<li>Check pending signal exists → monitor TP/SL/time</li>
<li>Check scheduled signal exists → monitor activation/cancellation</li>
<li>Call <code>getSignal()</code> → validate → persist → return opened</li>
</ol>
<a id="backtestcandles-icandledata-promise" class="tsd-anchor"></a><h4 class="tsd-anchor-link">backtest(candles: ICandleData[]): Promise<IStrategyBacktestResult><a href="#backtestcandles-icandledata-promise" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><p>Fast backtest using bulk candle processing with VWAP calculation per candle.</p>
<p><strong>Return Types:</strong></p>
<pre><code class="typescript"><span class="hl-7">type</span><span class="hl-1"> </span><span class="hl-11">IStrategyBacktestResult</span><span class="hl-1"> = </span><br/><span class="hl-1">    | </span><span class="hl-11">IStrategyTickResultClosed</span><span class="hl-1">    </span><span class="hl-5">// TP/SL/time_expired</span><br/><span class="hl-1">    | </span><span class="hl-11">IStrategyTickResultCancelled</span><span class="hl-1">  </span><span class="hl-5">// Scheduled never activated</span>
</code><button type="button">Copy</button></pre>

<p><strong>Flow:</strong></p>
<ol>
<li>Check pending/scheduled signal exists → monitor per candle</li>
<li>For each candle: calculate VWAP, check TP/SL, emit partial events</li>
<li>Return closed/cancelled result when signal completes</li>
</ol>
<hr>
<a id="iexchange-methods" class="tsd-anchor"></a><h3 class="tsd-anchor-link">IExchange Methods<a href="#iexchange-methods" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><a id="getcandlessymbol-interval-limit-promise" class="tsd-anchor"></a><h4 class="tsd-anchor-link">getCandles(symbol, interval, limit): Promise&lt;ICandleData[]&gt;<a href="#getcandlessymbol-interval-limit-promise" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><p>Fetches historical candles backward from execution context time.</p>
<p><strong>Parameters:</strong></p>
<ul>
<li><code>symbol</code>: Trading pair (e.g., &quot;BTCUSDT&quot;)</li>
<li><code>interval</code>: Candle time interval (<code>1m, 3m, 5m, 15m, 30m, 1h, 2h, 4h, 6h, 8h</code>)</li>
<li><code>limit</code>: Maximum candles to fetch</li>
</ul>
<p><strong>Context-Aware Behavior:</strong></p>
<ul>
<li>Uses <code>executionContextService.context.when</code> as reference point</li>
<li>Calculates <code>since = when - (interval * limit)</code></li>
<li>Caches candles in buffer (up to 500)</li>
</ul>
<a id="getaveragepricesymbol-promise" class="tsd-anchor"></a><h4 class="tsd-anchor-link">getAveragePrice(symbol): Promise<number><a href="#getaveragepricesymbol-promise" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><p>Calculates VWAP from last 5 1-minute candles.</p>
<p><strong>Formula:</strong></p>
<pre><code><span class="hl-4">Typical</span><span class="hl-1"> </span><span class="hl-4">Price</span><span class="hl-1"> = (</span><span class="hl-4">High</span><span class="hl-1"> + </span><span class="hl-4">Low</span><span class="hl-1"> + </span><span class="hl-4">Close</span><span class="hl-1">) / </span><span class="hl-6">3</span><br/><span class="hl-8">VWAP</span><span class="hl-1"> = </span><span class="hl-0">Σ</span><span class="hl-1">(</span><span class="hl-4">Typical</span><span class="hl-1"> </span><span class="hl-4">Price</span><span class="hl-1"> × </span><span class="hl-4">Volume</span><span class="hl-1">) / </span><span class="hl-0">Σ</span><span class="hl-1">(</span><span class="hl-4">Volume</span><span class="hl-1">)</span>
</code><button>Copy</button></pre>

<hr>
<a id="irisk-methods" class="tsd-anchor"></a><h3 class="tsd-anchor-link">IRisk Methods<a href="#irisk-methods" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><a id="checksignalparams-iriskcheckargs-promise" class="tsd-anchor"></a><h4 class="tsd-anchor-link">checkSignal(params: IRiskCheckArgs): Promise<boolean><a href="#checksignalparams-iriskcheckargs-promise" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><p>Validates signal against risk limits. Returns <code>true</code> if allowed, <code>false</code> if rejected.</p>
<p><strong>Validation Process:</strong></p>
<ol>
<li>Build <code>IRiskValidationPayload</code> with active position data</li>
<li>Execute each validation function in <code>validations[]</code> array</li>
<li>If any validation throws error → return <code>false</code> (rejected)</li>
<li>If all validations pass → return <code>true</code> (allowed)</li>
</ol>
<p><strong>Error Handling:</strong>
Validation functions throw errors with <code>note</code> property for rejection reasons:</p>
<pre><code class="typescript"><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-0">validation</span><span class="hl-1">: </span><span class="hl-11">IRiskValidationFn</span><span class="hl-1"> = (</span><span class="hl-4">payload</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-4">payload</span><span class="hl-1">.</span><span class="hl-4">activePositionCount</span><span class="hl-1"> &gt;= </span><span class="hl-6">3</span><span class="hl-1">) {</span><br/><span class="hl-1">        </span><span class="hl-3">throw</span><span class="hl-1"> </span><span class="hl-7">new</span><span class="hl-1"> </span><span class="hl-0">Error</span><span class="hl-1">(</span><span class="hl-2">&quot;Max 3 concurrent positions&quot;</span><span class="hl-1">);</span><br/><span class="hl-1">    }</span><br/><span class="hl-1">};</span>
</code><button type="button">Copy</button></pre>

<hr>
<a id="ipartial-methods" class="tsd-anchor"></a><h3 class="tsd-anchor-link">IPartial Methods<a href="#ipartial-methods" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><a id="profitsymbol-data-currentprice-revenuepercent-backtest-when-promise" class="tsd-anchor"></a><h4 class="tsd-anchor-link">profit(symbol, data, currentPrice, revenuePercent, backtest, when): Promise<void><a href="#profitsymbol-data-currentprice-revenuepercent-backtest-when-promise" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><p>Processes profit state and emits events for newly reached profit levels.</p>
<p><strong>Parameters:</strong></p>
<ul>
<li><code>revenuePercent</code>: Current profit as positive percentage (e.g., <code>15.5</code> for 15.5% profit)</li>
</ul>
<p><strong>Deduplication:</strong>
Uses <code>Set&lt;PartialLevel&gt;</code> to track emitted levels. Only emits event once per level per signal.</p>
<p><strong>Example:</strong></p>
<pre><code class="typescript"><span class="hl-5">// First call: revenuePercent = 12.3</span><br/><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-4">partial</span><span class="hl-1">.</span><span class="hl-0">profit</span><span class="hl-1">(..., </span><span class="hl-6">12.3</span><span class="hl-1">, ...);</span><br/><span class="hl-5">// Emits: 10% profit event</span><br/><br/><span class="hl-5">// Second call: revenuePercent = 23.7</span><br/><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-4">partial</span><span class="hl-1">.</span><span class="hl-0">profit</span><span class="hl-1">(..., </span><span class="hl-6">23.7</span><span class="hl-1">, ...);</span><br/><span class="hl-5">// Emits: 20% profit event (10% already emitted)</span>
</code><button type="button">Copy</button></pre>

<hr>
<a id="summary-table-service-interfaces" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Summary Table: Service Interfaces<a href="#summary-table-service-interfaces" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><table>
<thead>
<tr>
<th>Interface</th>
<th>Implementing Class</th>
<th>Purpose</th>
<th>Key Methods</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>IStrategy</code></td>
<td><code>ClientStrategy</code></td>
<td>Strategy execution and monitoring</td>
<td><code>tick</code>, <code>backtest</code>, <code>getPendingSignal</code>, <code>stop</code></td>
</tr>
<tr>
<td><code>IExchange</code></td>
<td><code>ClientExchange</code></td>
<td>Exchange data access</td>
<td><code>getCandles</code>, <code>getNextCandles</code>, <code>getAveragePrice</code>, <code>formatPrice</code>, <code>formatQuantity</code></td>
</tr>
<tr>
<td><code>IFrame</code></td>
<td><code>ClientFrame</code></td>
<td>Timeframe generation</td>
<td><code>getTimeframe</code></td>
</tr>
<tr>
<td><code>IRisk</code></td>
<td><code>ClientRisk</code>, <code>MergeRisk</code></td>
<td>Risk validation and tracking</td>
<td><code>checkSignal</code>, <code>addSignal</code>, <code>removeSignal</code></td>
</tr>
<tr>
<td><code>IPartial</code></td>
<td><code>ClientPartial</code></td>
<td>Profit/loss milestone tracking</td>
<td><code>profit</code>, <code>loss</code>, <code>clear</code></td>
</tr>
</tbody>
</table>
</div></div><div class="col-sidebar"><div class="page-menu"><div class="tsd-navigation settings"><details class="tsd-accordion"><summary class="tsd-accordion-summary"><h3><svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-chevronDown"></use></svg>Settings</h3></summary><div class="tsd-accordion-details"><div class="tsd-filter-visibility"><span class="settings-label">Member Visibility</span><ul id="tsd-filter-options"><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-protected" name="protected"/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Protected</span></label></li><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-inherited" name="inherited" checked/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Inherited</span></label></li><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-external" name="external"/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>External</span></label></li></ul></div><div class="tsd-theme-toggle"><label class="settings-label" for="tsd-theme">Theme</label><select id="tsd-theme"><option value="os">OS</option><option value="light">Light</option><option value="dark">Dark</option></select></div></div></details></div><details open class="tsd-accordion tsd-page-navigation"><summary class="tsd-accordion-summary"><h3><svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-chevronDown"></use></svg>On This Page</h3></summary><div class="tsd-accordion-details"><a href="#service-layer-interfaces"><span>Service <wbr/>Layer <wbr/>Interfaces</span></a><ul><li><a href="#purpose-and-scope"><span>Purpose and <wbr/>Scope</span></a></li><li><a href="#architecture-overview"><span>Architecture <wbr/>Overview</span></a></li><li><a href="#core-domain-interfaces"><span>Core <wbr/>Domain <wbr/>Interfaces</span></a></li><li><ul><li><a href="#istrategy-interface"><span>IStrategy <wbr/>Interface</span></a></li><li><a href="#iexchange-interface"><span>IExchange <wbr/>Interface</span></a></li><li><a href="#iframe-interface"><span>IFrame <wbr/>Interface</span></a></li><li><a href="#irisk-interface"><span>IRisk <wbr/>Interface</span></a></li><li><a href="#ipartial-interface"><span>IPartial <wbr/>Interface</span></a></li></ul></li><li><a href="#service-categories"><span>Service <wbr/>Categories</span></a></li><li><ul><li><a href="#connection-services-memoized-factories"><span>Connection <wbr/>Services (<wbr/>Memoized <wbr/>Factories)</span></a></li><li><a href="#core-services-orchestration"><span>Core <wbr/>Services (<wbr/>Orchestration)</span></a></li><li><a href="#global-services-shared-state"><span>Global <wbr/>Services (<wbr/>Shared <wbr/>State)</span></a></li></ul></li><li><a href="#dependency-injection-flow"><span>Dependency <wbr/>Injection <wbr/>Flow</span></a></li><li><a href="#context-propagation"><span>Context <wbr/>Propagation</span></a></li><li><a href="#method-signature-reference"><span>Method <wbr/>Signature <wbr/>Reference</span></a></li><li><ul><li><a href="#istrategy-methods"><span>IStrategy <wbr/>Methods</span></a></li><li><ul><li><a href="#ticksymbol-string-promise"><span>tick(symbol: string): <wbr/>Promise&lt;IStrategy<wbr/>Tick<wbr/>Result&gt;</span></a></li><li><a href="#backtestcandles-icandledata-promise"><span>backtest(candles: ICandle<wbr/>Data[]): <wbr/>Promise&lt;IStrategy<wbr/>Backtest<wbr/>Result&gt;</span></a></li></ul></li><li><a href="#iexchange-methods"><span>IExchange <wbr/>Methods</span></a></li><li><ul><li><a href="#getcandlessymbol-interval-limit-promise"><span>get<wbr/>Candles(symbol, interval, limit): <wbr/>Promise&lt;ICandle<wbr/>Data[]&gt;</span></a></li><li><a href="#getaveragepricesymbol-promise"><span>get<wbr/>Average<wbr/>Price(symbol): <wbr/>Promise&lt;number&gt;</span></a></li></ul></li><li><a href="#irisk-methods"><span>IRisk <wbr/>Methods</span></a></li><li><ul><li><a href="#checksignalparams-iriskcheckargs-promise"><span>check<wbr/>Signal(params: IRisk<wbr/>Check<wbr/>Args): <wbr/>Promise&lt;boolean&gt;</span></a></li></ul></li><li><a href="#ipartial-methods"><span>IPartial <wbr/>Methods</span></a></li><li><ul><li><a href="#profitsymbol-data-currentprice-revenuepercent-backtest-when-promise"><span>profit(symbol, data, current<wbr/>Price, revenue<wbr/>Percent, backtest, when): <wbr/>Promise&lt;void&gt;</span></a></li></ul></li></ul></li><li><a href="#summary-table-service-interfaces"><span>Summary <wbr/>Table: <wbr/>Service <wbr/>Interfaces</span></a></li></ul></div></details></div><div class="site-menu"><nav class="tsd-navigation"><a href="../modules.html">backtest-kit</a><ul class="tsd-small-nested-navigation" id="tsd-nav-container"><li>Loading...</li></ul></nav></div></div></div><footer><p class="tsd-generator">Generated using <a href="https://typedoc.org/" target="_blank">TypeDoc</a></p></footer><div class="overlay"></div></body></html>

<!-- Yandex.Metrika counter -->
<script type="text/javascript">
    (function(m,e,t,r,i,k,a){
        m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
        m[i].l=1*new Date();
        for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }}
        k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)
    })(window, document,'script','https://mc.yandex.ru/metrika/tag.js?id=105455585', 'ym');

    ym(105455585, 'init', {ssr:true, webvisor:true, clickmap:true, ecommerce:"dataLayer", accurateTrackBounce:true, trackLinks:true});
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/105455585" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
<!-- /Yandex.Metrika counter -->

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-3MQZEBBDDR"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-3MQZEBBDDR');
</script>
