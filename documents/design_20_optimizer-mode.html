<!DOCTYPE html><html class="default" lang="en" data-base=".."><head><meta charset="utf-8"/><meta http-equiv="x-ua-compatible" content="IE=edge"/><title>design/20_optimizer-mode | backtest-kit</title><meta name="description" content="Documentation for backtest-kit"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="stylesheet" href="../assets/style.css"/><link rel="stylesheet" href="../assets/highlight.css"/><script defer src="../assets/main.js"></script><script async src="../assets/icons.js" id="tsd-icons-script"></script><script async src="../assets/search.js" id="tsd-search-script"></script><script async src="../assets/navigation.js" id="tsd-nav-script"></script><script async src="../assets/hierarchy.js" id="tsd-hierarchy-script"></script></head><body><script>document.documentElement.dataset.theme = localStorage.getItem("tsd-theme") || "os";document.body.style.display="none";setTimeout(() => app?app.showPage():document.body.style.removeProperty("display"),500)</script><header class="tsd-page-toolbar"><div class="tsd-toolbar-contents container"><div class="table-cell" id="tsd-search"><div class="field"><label for="tsd-search-field" class="tsd-widget tsd-toolbar-icon search no-caption"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-search"></use></svg></label><input type="text" id="tsd-search-field" aria-label="Search"/></div><div class="field"><div id="tsd-toolbar-links"></div></div><ul class="results"><li class="state loading">Preparing search index...</li><li class="state failure">The search index is not available</li></ul><a href="../index.html" class="title">backtest-kit</a></div><div class="table-cell" id="tsd-widgets"><a href="#" class="tsd-widget tsd-toolbar-icon menu no-caption" data-toggle="menu" aria-label="Menu"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-menu"></use></svg></a></div></div></header><div class="container container-main"><div class="col-content"><div class="tsd-page-title"><ul class="tsd-breadcrumb"><li><a href="../modules.html">backtest-kit</a></li><li><a href="design_20_optimizer-mode.html">design/20_optimizer-mode</a></li></ul></div><div class="tsd-panel tsd-typography"><a id="optimizer-mode" class="tsd-anchor"></a><h1 class="tsd-anchor-link">Optimizer Mode<a href="#optimizer-mode" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h1><p><strong>Purpose</strong>: This page documents the Optimizer execution mode, which generates executable trading strategies using Large Language Model (LLM) integration. Unlike other execution modes that run strategies directly, Optimizer Mode produces complete strategy code files by collecting multi-timeframe historical data, formatting it for LLM consumption via the Ollama API, and assembling executable <code>.mjs</code> files with integrated Walker-based backtesting.</p>
<p>For information about executing strategies in historical simulation, see <a href="design_17_backtest-mode.html">Backtest Mode</a>. For comparing multiple strategies, see <a href="design_19_walker-mode.html">Walker Mode</a>. For LLM-based strategy definition, see <a href="design_12_defining-strategies.html">Defining Strategies</a>.</p>
<hr>
<a id="overview" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Overview<a href="#overview" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>Optimizer Mode is a code generation system that bridges historical market data with LLM-powered strategy logic. The system fetches data from configurable sources (such as pre-computed technical indicators), formats it into LLM conversation messages, generates strategy prompts via Ollama API, and assembles complete executable JavaScript modules.</p>
<p>The generated code includes:</p>
<ul>
<li>Exchange configuration with CCXT integration</li>
<li>Training and testing frame definitions</li>
<li>Multiple strategy variants (one per training period)</li>
<li>Walker configuration for strategy comparison</li>
<li>Event listeners and progress tracking</li>
<li>Helper functions for LLM interaction and debug logging</li>
</ul>
<p><strong>Key Characteristics</strong>:</p>
<ul>
<li><strong>Generative</strong>: Produces code artifacts rather than execution results</li>
<li><strong>Multi-Source</strong>: Fetches data from multiple configurable sources with pagination</li>
<li><strong>Multi-Timeframe</strong>: Typically processes 1m, 15m, 30m, 1h candle data</li>
<li><strong>Template-Based</strong>: Uses customizable templates for each code section</li>
<li><strong>LLM-Integrated</strong>: Communicates with Ollama API for strategy generation</li>
</ul>
<hr>
<a id="optimizer-schema-registration" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Optimizer Schema Registration<a href="#optimizer-schema-registration" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>Optimizer configurations are registered via <code>addOptimizer()</code> function, which accepts an <code>IOptimizerSchema</code> object defining data sources, time ranges, and code generation logic.</p>
<a id="registration-api" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Registration API<a href="#registration-api" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><pre><code class="typescript"><span class="hl-0">addOptimizer</span><span class="hl-1">({</span><br/><span class="hl-1">  </span><span class="hl-4">optimizerName:</span><span class="hl-1"> </span><span class="hl-2">&quot;my-optimizer&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">rangeTrain:</span><span class="hl-1"> [</span><br/><span class="hl-1">    {</span><br/><span class="hl-1">      </span><span class="hl-4">note:</span><span class="hl-1"> </span><span class="hl-2">&quot;Training period 1&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">      </span><span class="hl-4">startDate:</span><span class="hl-1"> </span><span class="hl-7">new</span><span class="hl-1"> </span><span class="hl-0">Date</span><span class="hl-1">(</span><span class="hl-2">&quot;2025-11-24T00:00:00Z&quot;</span><span class="hl-1">),</span><br/><span class="hl-1">      </span><span class="hl-4">endDate:</span><span class="hl-1"> </span><span class="hl-7">new</span><span class="hl-1"> </span><span class="hl-0">Date</span><span class="hl-1">(</span><span class="hl-2">&quot;2025-11-24T23:59:59Z&quot;</span><span class="hl-1">),</span><br/><span class="hl-1">    },</span><br/><span class="hl-1">    </span><span class="hl-5">// Additional training periods...</span><br/><span class="hl-1">  ],</span><br/><span class="hl-1">  </span><span class="hl-4">rangeTest:</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-4">note:</span><span class="hl-1"> </span><span class="hl-2">&quot;Testing period&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-4">startDate:</span><span class="hl-1"> </span><span class="hl-7">new</span><span class="hl-1"> </span><span class="hl-0">Date</span><span class="hl-1">(</span><span class="hl-2">&quot;2025-12-01T00:00:00Z&quot;</span><span class="hl-1">),</span><br/><span class="hl-1">    </span><span class="hl-4">endDate:</span><span class="hl-1"> </span><span class="hl-7">new</span><span class="hl-1"> </span><span class="hl-0">Date</span><span class="hl-1">(</span><span class="hl-2">&quot;2025-12-01T23:59:59Z&quot;</span><span class="hl-1">),</span><br/><span class="hl-1">  },</span><br/><span class="hl-1">  </span><span class="hl-4">source:</span><span class="hl-1"> [</span><br/><span class="hl-1">    {</span><br/><span class="hl-1">      </span><span class="hl-4">name:</span><span class="hl-1"> </span><span class="hl-2">&quot;1h-candles&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">      </span><span class="hl-0">fetch</span><span class="hl-4">:</span><span class="hl-1"> </span><span class="hl-7">async</span><span class="hl-1"> ({ </span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">startDate</span><span class="hl-1">, </span><span class="hl-4">endDate</span><span class="hl-1">, </span><span class="hl-4">limit</span><span class="hl-1">, </span><span class="hl-4">offset</span><span class="hl-1"> }) </span><span class="hl-7">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">        </span><span class="hl-5">// Fetch paginated data with unique IDs</span><br/><span class="hl-1">        </span><span class="hl-3">return</span><span class="hl-1"> </span><span class="hl-4">data</span><span class="hl-1">;</span><br/><span class="hl-1">      },</span><br/><span class="hl-1">      </span><span class="hl-0">user</span><span class="hl-4">:</span><span class="hl-1"> (</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">data</span><span class="hl-1">, </span><span class="hl-4">name</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">        </span><span class="hl-5">// Format data as user message for LLM</span><br/><span class="hl-1">        </span><span class="hl-3">return</span><span class="hl-1"> </span><span class="hl-4">markdownTable</span><span class="hl-1">;</span><br/><span class="hl-1">      },</span><br/><span class="hl-1">      </span><span class="hl-0">assistant</span><span class="hl-4">:</span><span class="hl-1"> () </span><span class="hl-7">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">        </span><span class="hl-5">// Format acknowledgment as assistant message</span><br/><span class="hl-1">        </span><span class="hl-3">return</span><span class="hl-1"> </span><span class="hl-2">&quot;Data received&quot;</span><span class="hl-1">;</span><br/><span class="hl-1">      }</span><br/><span class="hl-1">    }</span><br/><span class="hl-1">  ],</span><br/><span class="hl-1">  </span><span class="hl-0">getPrompt</span><span class="hl-4">:</span><span class="hl-1"> </span><span class="hl-7">async</span><span class="hl-1"> (</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">messages</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-5">// Generate strategy logic from conversation history</span><br/><span class="hl-1">    </span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">ollama</span><span class="hl-1"> = </span><span class="hl-7">new</span><span class="hl-1"> </span><span class="hl-0">Ollama</span><span class="hl-1">({ </span><span class="hl-5">/* ... */</span><span class="hl-1"> });</span><br/><span class="hl-1">    </span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">response</span><span class="hl-1"> = </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-4">ollama</span><span class="hl-1">.</span><span class="hl-0">chat</span><span class="hl-1">({ </span><span class="hl-4">messages</span><span class="hl-1"> });</span><br/><span class="hl-1">    </span><span class="hl-3">return</span><span class="hl-1"> </span><span class="hl-4">response</span><span class="hl-1">.</span><span class="hl-4">message</span><span class="hl-1">.</span><span class="hl-4">content</span><span class="hl-1">;</span><br/><span class="hl-1">  },</span><br/><span class="hl-1">  </span><span class="hl-4">template:</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-5">// Optional template overrides</span><br/><span class="hl-1">  },</span><br/><span class="hl-1">  </span><span class="hl-4">callbacks:</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-0">onData</span><span class="hl-4">:</span><span class="hl-1"> (</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">strategyData</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> { </span><span class="hl-5">/* ... */</span><span class="hl-1"> },</span><br/><span class="hl-1">    </span><span class="hl-0">onCode</span><span class="hl-4">:</span><span class="hl-1"> (</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">code</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> { </span><span class="hl-5">/* ... */</span><span class="hl-1"> },</span><br/><span class="hl-1">    </span><span class="hl-0">onDump</span><span class="hl-4">:</span><span class="hl-1"> (</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">filepath</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> { </span><span class="hl-5">/* ... */</span><span class="hl-1"> }</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">});</span>
</code><button type="button">Copy</button></pre>

<a id="schema-structure" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Schema Structure<a href="#schema-structure" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><table>
<thead>
<tr>
<th>Field</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>optimizerName</code></td>
<td><code>string</code></td>
<td>Unique identifier for this optimizer</td>
</tr>
<tr>
<td><code>rangeTrain</code></td>
<td><code>IOptimizerRange[]</code></td>
<td>Training time ranges (one strategy per range)</td>
</tr>
<tr>
<td><code>rangeTest</code></td>
<td><code>IOptimizerRange</code></td>
<td>Testing time range for Walker validation</td>
</tr>
<tr>
<td><code>source</code></td>
<td><code>Source[]</code></td>
<td>Data sources with fetch and format functions</td>
</tr>
<tr>
<td><code>getPrompt</code></td>
<td><code>function</code></td>
<td>Generates strategy logic from conversation</td>
</tr>
<tr>
<td><code>template</code></td>
<td><code>Partial&lt;IOptimizerTemplate&gt;</code></td>
<td>Optional template overrides</td>
</tr>
<tr>
<td><code>callbacks</code></td>
<td><code>Partial&lt;IOptimizerCallbacks&gt;</code></td>
<td>Lifecycle event hooks</td>
</tr>
</tbody>
</table>
<p>Each <code>IOptimizerRange</code> contains:</p>
<ul>
<li><code>startDate</code>: Start of data collection period (inclusive)</li>
<li><code>endDate</code>: End of data collection period (inclusive)</li>
<li><code>note</code>: Optional description</li>
</ul>
<p>Each <code>Source</code> can be either:</p>
<ul>
<li>A simple fetch function: <code>(args: IOptimizerFetchArgs) =&gt; Data[]</code></li>
<li>A full configuration object with <code>name</code>, <code>fetch</code>, <code>user</code>, <code>assistant</code> fields</li>
</ul>
<a id="data-source-requirements" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Data Source Requirements<a href="#data-source-requirements" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>All data returned by <code>fetch</code> functions must implement <code>IOptimizerData</code>:</p>
<pre><code class="typescript"><span class="hl-7">interface</span><span class="hl-1"> </span><span class="hl-13">IOptimizerData</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-4">id</span><span class="hl-1">: </span><span class="hl-13">string</span><span class="hl-1"> | </span><span class="hl-13">number</span><span class="hl-1">; </span><span class="hl-5">// Unique identifier for deduplication</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<p>The <code>fetch</code> function receives paginated query parameters:</p>
<pre><code class="typescript"><span class="hl-7">interface</span><span class="hl-1"> </span><span class="hl-13">IOptimizerFetchArgs</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-4">symbol</span><span class="hl-1">: </span><span class="hl-13">string</span><span class="hl-1">;</span><br/><span class="hl-1">  </span><span class="hl-4">startDate</span><span class="hl-1">: </span><span class="hl-13">Date</span><span class="hl-1">;</span><br/><span class="hl-1">  </span><span class="hl-4">endDate</span><span class="hl-1">: </span><span class="hl-13">Date</span><span class="hl-1">;</span><br/><span class="hl-1">  </span><span class="hl-4">limit</span><span class="hl-1">: </span><span class="hl-13">number</span><span class="hl-1">;  </span><span class="hl-5">// Max records per request (default: 25)</span><br/><span class="hl-1">  </span><span class="hl-4">offset</span><span class="hl-1">: </span><span class="hl-13">number</span><span class="hl-1">; </span><span class="hl-5">// Records to skip for pagination</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<p>The system automatically handles pagination using <code>iterateDocuments</code> from <code>functools-kit</code>, fetching all available data and deduplicating by <code>id</code> field.</p>
<hr>
<a id="system-architecture" class="tsd-anchor"></a><h2 class="tsd-anchor-link">System Architecture<a href="#system-architecture" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p><img src="../media/20-optimizer-mode_0.svg" alt="Mermaid Diagram"></p>
<p><strong>Architecture Diagram: Optimizer Mode Component Structure</strong></p>
<p>The architecture follows a layered pattern:</p>
<ol>
<li><strong>Public API</strong>: <code>addOptimizer()</code> for registration, <code>Optimizer</code> class for operations</li>
<li><strong>Validation Layer</strong>: Maintains registry and validates optimizer existence</li>
<li><strong>Schema Layer</strong>: Immutable storage using <code>ToolRegistry</code> pattern</li>
<li><strong>Global Service</strong>: Entry point with validation before delegation</li>
<li><strong>Connection Layer</strong>: Memoized client factory with template merging</li>
<li><strong>Template Layer</strong>: Default implementations for all code generation methods</li>
<li><strong>Client Layer</strong>: Core business logic for data collection and code assembly</li>
<li><strong>Event System</strong>: Progress tracking via <code>progressOptimizerEmitter</code></li>
</ol>
<hr>
<a id="data-collection-and-processing" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Data Collection and Processing<a href="#data-collection-and-processing" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>The optimizer collects data through a multi-stage pipeline that iterates through training ranges and data sources, building LLM conversation history.</p>
<a id="data-flow-diagram" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Data Flow Diagram<a href="#data-flow-diagram" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><img src="../media/20-optimizer-mode_1.svg" alt="Mermaid Diagram"></p>
<p><strong>Data Flow Diagram: Strategy Data Collection Process</strong></p>
<a id="pagination-and-deduplication" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Pagination and Deduplication<a href="#pagination-and-deduplication" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>The system uses <code>functools-kit</code> utilities for efficient data fetching:</p>
<pre><code class="typescript"><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-0">RESOLVE_PAGINATION_FN</span><span class="hl-1"> = </span><span class="hl-7">async</span><span class="hl-1"> &lt;</span><span class="hl-13">Data</span><span class="hl-1"> </span><span class="hl-7">extends</span><span class="hl-1"> </span><span class="hl-13">IOptimizerData</span><span class="hl-1"> = </span><span class="hl-13">any</span><span class="hl-1">&gt;(</span><br/><span class="hl-1">  </span><span class="hl-4">fetch</span><span class="hl-1">: </span><span class="hl-13">IOptimizerSourceFn</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">filterData</span><span class="hl-1">: </span><span class="hl-13">IOptimizerFilterArgs</span><br/><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">iterator</span><span class="hl-1"> = </span><span class="hl-0">iterateDocuments</span><span class="hl-1">&lt;</span><span class="hl-13">Data</span><span class="hl-1">&gt;({</span><br/><span class="hl-1">    </span><span class="hl-4">limit:</span><span class="hl-1"> </span><span class="hl-8">ITERATION_LIMIT</span><span class="hl-1">,  </span><span class="hl-5">// 25 records per request</span><br/><span class="hl-1">    </span><span class="hl-7">async</span><span class="hl-1"> </span><span class="hl-0">createRequest</span><span class="hl-1">({ </span><span class="hl-4">limit</span><span class="hl-1">, </span><span class="hl-4">offset</span><span class="hl-1"> }) {</span><br/><span class="hl-1">      </span><span class="hl-3">return</span><span class="hl-1"> </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-0">fetch</span><span class="hl-1">({</span><br/><span class="hl-1">        </span><span class="hl-4">symbol:</span><span class="hl-1"> </span><span class="hl-4">filterData</span><span class="hl-1">.</span><span class="hl-4">symbol</span><span class="hl-1">,</span><br/><span class="hl-1">        </span><span class="hl-4">startDate:</span><span class="hl-1"> </span><span class="hl-4">filterData</span><span class="hl-1">.</span><span class="hl-4">startDate</span><span class="hl-1">,</span><br/><span class="hl-1">        </span><span class="hl-4">endDate:</span><span class="hl-1"> </span><span class="hl-4">filterData</span><span class="hl-1">.</span><span class="hl-4">endDate</span><span class="hl-1">,</span><br/><span class="hl-1">        </span><span class="hl-4">limit</span><span class="hl-1">,</span><br/><span class="hl-1">        </span><span class="hl-4">offset</span><span class="hl-1">,</span><br/><span class="hl-1">      });</span><br/><span class="hl-1">    },</span><br/><span class="hl-1">  });</span><br/><span class="hl-1">  </span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">distinct</span><span class="hl-1"> = </span><span class="hl-0">distinctDocuments</span><span class="hl-1">(</span><span class="hl-4">iterator</span><span class="hl-1">, (</span><span class="hl-4">data</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> </span><span class="hl-4">data</span><span class="hl-1">.</span><span class="hl-4">id</span><span class="hl-1">);</span><br/><span class="hl-1">  </span><span class="hl-3">return</span><span class="hl-1"> </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-0">resolveDocuments</span><span class="hl-1">(</span><span class="hl-4">distinct</span><span class="hl-1">);</span><br/><span class="hl-1">};</span>
</code><button type="button">Copy</button></pre>

<p>This approach:</p>
<ul>
<li>Fetches 25 records at a time (configurable via <code>ITERATION_LIMIT</code>)</li>
<li>Automatically continues pagination until no more data</li>
<li>Deduplicates by <code>id</code> field to handle overlapping requests</li>
<li>Returns complete resolved array</li>
</ul>
<a id="conversation-building" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Conversation Building<a href="#conversation-building" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>For each training range, the system builds a conversation history:</p>
<ol>
<li><strong>Iterate Sources</strong>: Process each source sequentially</li>
<li><strong>Emit Progress</strong>: Update progress before fetching each source</li>
<li><strong>Fetch Data</strong>: Call <code>RESOLVE_PAGINATION_FN</code> for complete dataset</li>
<li><strong>Format Messages</strong>:
<ul>
<li>Call <code>user()</code> or default <code>getUserMessage()</code> for user message</li>
<li>Call <code>assistant()</code> or default <code>getAssistantMessage()</code> for assistant response</li>
</ul>
</li>
<li><strong>Append to History</strong>: Add user/assistant message pair to <code>messageList</code></li>
<li><strong>Generate Prompt</strong>: After all sources, call <code>getPrompt()</code> with complete conversation</li>
<li><strong>Store Strategy</strong>: Save <code>{symbol, name, messages, strategy}</code> to <code>strategyList</code></li>
</ol>
<hr>
<a id="template-system" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Template System<a href="#template-system" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>The template system generates executable code sections through customizable template methods. Each template method returns a string of TypeScript/JavaScript code.</p>
<a id="template-interface" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Template Interface<a href="#template-interface" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><pre><code class="typescript"><span class="hl-7">interface</span><span class="hl-1"> </span><span class="hl-13">IOptimizerTemplate</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-0">getTopBanner</span><span class="hl-1">(</span><span class="hl-4">symbol</span><span class="hl-1">: </span><span class="hl-13">string</span><span class="hl-1">): </span><span class="hl-13">string</span><span class="hl-1"> | </span><span class="hl-13">Promise</span><span class="hl-1">&lt;</span><span class="hl-13">string</span><span class="hl-1">&gt;;</span><br/><span class="hl-1">  </span><span class="hl-0">getUserMessage</span><span class="hl-1">(</span><span class="hl-4">symbol</span><span class="hl-1">: </span><span class="hl-13">string</span><span class="hl-1">, </span><span class="hl-4">data</span><span class="hl-1">: </span><span class="hl-13">IOptimizerData</span><span class="hl-1">[], </span><span class="hl-4">name</span><span class="hl-1">: </span><span class="hl-13">string</span><span class="hl-1">): </span><span class="hl-13">string</span><span class="hl-1"> | </span><span class="hl-13">Promise</span><span class="hl-1">&lt;</span><span class="hl-13">string</span><span class="hl-1">&gt;;</span><br/><span class="hl-1">  </span><span class="hl-0">getAssistantMessage</span><span class="hl-1">(</span><span class="hl-4">symbol</span><span class="hl-1">: </span><span class="hl-13">string</span><span class="hl-1">, </span><span class="hl-4">data</span><span class="hl-1">: </span><span class="hl-13">IOptimizerData</span><span class="hl-1">[], </span><span class="hl-4">name</span><span class="hl-1">: </span><span class="hl-13">string</span><span class="hl-1">): </span><span class="hl-13">string</span><span class="hl-1"> | </span><span class="hl-13">Promise</span><span class="hl-1">&lt;</span><span class="hl-13">string</span><span class="hl-1">&gt;;</span><br/><span class="hl-1">  </span><span class="hl-0">getWalkerTemplate</span><span class="hl-1">(</span><span class="hl-4">walkerName</span><span class="hl-1">: </span><span class="hl-13">string</span><span class="hl-1">, </span><span class="hl-4">exchangeName</span><span class="hl-1">: </span><span class="hl-13">string</span><span class="hl-1">, </span><span class="hl-4">frameName</span><span class="hl-1">: </span><span class="hl-13">string</span><span class="hl-1">, </span><span class="hl-4">strategies</span><span class="hl-1">: </span><span class="hl-13">string</span><span class="hl-1">[]): </span><span class="hl-13">string</span><span class="hl-1"> | </span><span class="hl-13">Promise</span><span class="hl-1">&lt;</span><span class="hl-13">string</span><span class="hl-1">&gt;;</span><br/><span class="hl-1">  </span><span class="hl-0">getExchangeTemplate</span><span class="hl-1">(</span><span class="hl-4">symbol</span><span class="hl-1">: </span><span class="hl-13">string</span><span class="hl-1">, </span><span class="hl-4">exchangeName</span><span class="hl-1">: </span><span class="hl-13">string</span><span class="hl-1">): </span><span class="hl-13">string</span><span class="hl-1"> | </span><span class="hl-13">Promise</span><span class="hl-1">&lt;</span><span class="hl-13">string</span><span class="hl-1">&gt;;</span><br/><span class="hl-1">  </span><span class="hl-0">getFrameTemplate</span><span class="hl-1">(</span><span class="hl-4">symbol</span><span class="hl-1">: </span><span class="hl-13">string</span><span class="hl-1">, </span><span class="hl-4">frameName</span><span class="hl-1">: </span><span class="hl-13">string</span><span class="hl-1">, </span><span class="hl-4">interval</span><span class="hl-1">: </span><span class="hl-13">CandleInterval</span><span class="hl-1">, </span><span class="hl-4">startDate</span><span class="hl-1">: </span><span class="hl-13">Date</span><span class="hl-1">, </span><span class="hl-4">endDate</span><span class="hl-1">: </span><span class="hl-13">Date</span><span class="hl-1">): </span><span class="hl-13">string</span><span class="hl-1"> | </span><span class="hl-13">Promise</span><span class="hl-1">&lt;</span><span class="hl-13">string</span><span class="hl-1">&gt;;</span><br/><span class="hl-1">  </span><span class="hl-0">getStrategyTemplate</span><span class="hl-1">(</span><span class="hl-4">strategyName</span><span class="hl-1">: </span><span class="hl-13">string</span><span class="hl-1">, </span><span class="hl-4">interval</span><span class="hl-1">: </span><span class="hl-13">string</span><span class="hl-1">, </span><span class="hl-4">prompt</span><span class="hl-1">: </span><span class="hl-13">string</span><span class="hl-1">): </span><span class="hl-13">string</span><span class="hl-1"> | </span><span class="hl-13">Promise</span><span class="hl-1">&lt;</span><span class="hl-13">string</span><span class="hl-1">&gt;;</span><br/><span class="hl-1">  </span><span class="hl-0">getLauncherTemplate</span><span class="hl-1">(</span><span class="hl-4">symbol</span><span class="hl-1">: </span><span class="hl-13">string</span><span class="hl-1">, </span><span class="hl-4">walkerName</span><span class="hl-1">: </span><span class="hl-13">string</span><span class="hl-1">): </span><span class="hl-13">string</span><span class="hl-1"> | </span><span class="hl-13">Promise</span><span class="hl-1">&lt;</span><span class="hl-13">string</span><span class="hl-1">&gt;;</span><br/><span class="hl-1">  </span><span class="hl-0">getTextTemplate</span><span class="hl-1">(</span><span class="hl-4">symbol</span><span class="hl-1">: </span><span class="hl-13">string</span><span class="hl-1">): </span><span class="hl-13">string</span><span class="hl-1"> | </span><span class="hl-13">Promise</span><span class="hl-1">&lt;</span><span class="hl-13">string</span><span class="hl-1">&gt;;</span><br/><span class="hl-1">  </span><span class="hl-0">getJsonTemplate</span><span class="hl-1">(</span><span class="hl-4">symbol</span><span class="hl-1">: </span><span class="hl-13">string</span><span class="hl-1">): </span><span class="hl-13">string</span><span class="hl-1"> | </span><span class="hl-13">Promise</span><span class="hl-1">&lt;</span><span class="hl-13">string</span><span class="hl-1">&gt;;</span><br/><span class="hl-1">  </span><span class="hl-0">getJsonDumpTemplate</span><span class="hl-1">(</span><span class="hl-4">symbol</span><span class="hl-1">: </span><span class="hl-13">string</span><span class="hl-1">): </span><span class="hl-13">string</span><span class="hl-1"> | </span><span class="hl-13">Promise</span><span class="hl-1">&lt;</span><span class="hl-13">string</span><span class="hl-1">&gt;;</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<a id="template-merging-process" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Template Merging Process<a href="#template-merging-process" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><img src="../media/20-optimizer-mode_2.svg" alt="Mermaid Diagram"></p>
<p><strong>Template Merging Diagram: How Custom and Default Templates Combine</strong></p>
<p>The <code>OptimizerConnectionService.getOptimizer()</code> method performs template merging:</p>
<pre><code class="typescript"><span class="hl-7">const</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-8">getAssistantMessage</span><span class="hl-1"> = </span><span class="hl-7">this</span><span class="hl-1">.</span><span class="hl-4">optimizerTemplateService</span><span class="hl-1">.</span><span class="hl-4">getAssistantMessage</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-8">getExchangeTemplate</span><span class="hl-1"> = </span><span class="hl-7">this</span><span class="hl-1">.</span><span class="hl-4">optimizerTemplateService</span><span class="hl-1">.</span><span class="hl-4">getExchangeTemplate</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-5">// ... other methods with default fallbacks</span><br/><span class="hl-1">} = </span><span class="hl-4">rawTemplate</span><span class="hl-1">;</span><br/><br/><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">template</span><span class="hl-1">: </span><span class="hl-13">IOptimizerTemplate</span><span class="hl-1"> = {</span><br/><span class="hl-1">  </span><span class="hl-4">getAssistantMessage</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">getExchangeTemplate</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-5">// ... complete template object</span><br/><span class="hl-1">};</span>
</code><button type="button">Copy</button></pre>

<p>This allows partial overrides - any method not provided in schema falls back to <code>OptimizerTemplateService</code> defaults.</p>
<a id="default-template-implementations" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Default Template Implementations<a href="#default-template-implementations" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>The <code>OptimizerTemplateService</code> provides default implementations for all template methods:</p>
<table>
<thead>
<tr>
<th>Method</th>
<th>Purpose</th>
<th>Example Output</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>getTopBanner()</code></td>
<td>Imports and constants</td>
<td><code>#!/usr/bin/env node\nimport { Ollama } from &quot;ollama&quot;;</code></td>
</tr>
<tr>
<td><code>getUserMessage()</code></td>
<td>LLM user prompt</td>
<td><code>&quot;Прочитай данные и скажи ОК\n\n&quot; + JSON.stringify(data)</code></td>
</tr>
<tr>
<td><code>getAssistantMessage()</code></td>
<td>LLM acknowledgment</td>
<td><code>&quot;ОК&quot;</code></td>
</tr>
<tr>
<td><code>getExchangeTemplate()</code></td>
<td>Exchange config</td>
<td><code>addExchange({ exchangeName, getCandles: async (...) =&gt; { ... } })</code></td>
</tr>
<tr>
<td><code>getFrameTemplate()</code></td>
<td>Frame config</td>
<td><code>addFrame({ frameName, interval, startDate, endDate })</code></td>
</tr>
<tr>
<td><code>getStrategyTemplate()</code></td>
<td>Strategy with LLM</td>
<td><code>addStrategy({ strategyName, interval, getSignal: async (...) =&gt; { ... } })</code></td>
</tr>
<tr>
<td><code>getWalkerTemplate()</code></td>
<td>Walker config</td>
<td><code>addWalker({ walkerName, exchangeName, frameName, strategies })</code></td>
</tr>
<tr>
<td><code>getLauncherTemplate()</code></td>
<td>Execution code</td>
<td><code>Walker.background(symbol, { walkerName })</code></td>
</tr>
<tr>
<td><code>getTextTemplate()</code></td>
<td>Text LLM helper</td>
<td><code>async function text(messages) { ... }</code></td>
</tr>
<tr>
<td><code>getJsonTemplate()</code></td>
<td>JSON LLM helper</td>
<td><code>async function json(messages) { ... }</code></td>
</tr>
<tr>
<td><code>getJsonDumpTemplate()</code></td>
<td>Debug logger</td>
<td><code>async function dumpJson(...) { ... }</code></td>
</tr>
</tbody>
</table>
<a id="strategy-template-example" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Strategy Template Example<a href="#strategy-template-example" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>The <code>getStrategyTemplate()</code> method generates multi-timeframe strategy code:</p>
<pre><code class="typescript"><span class="hl-4">public</span><span class="hl-1"> </span><span class="hl-0">getStrategyTemplate</span><span class="hl-1"> = </span><span class="hl-7">async</span><span class="hl-1"> (</span><br/><span class="hl-1">  </span><span class="hl-4">strategyName</span><span class="hl-1">: </span><span class="hl-13">string</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">interval</span><span class="hl-1">: </span><span class="hl-13">string</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">prompt</span><span class="hl-1">: </span><span class="hl-13">string</span><br/><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">escapedPrompt</span><span class="hl-1"> = </span><span class="hl-0">String</span><span class="hl-1">(</span><span class="hl-4">prompt</span><span class="hl-1">)</span><br/><span class="hl-1">    .</span><span class="hl-0">replace</span><span class="hl-1">(</span><span class="hl-15">/</span><span class="hl-12">\\</span><span class="hl-15">/</span><span class="hl-7">g</span><span class="hl-1">, </span><span class="hl-2">&#39;</span><span class="hl-12">\\\\</span><span class="hl-2">&#39;</span><span class="hl-1">)</span><br/><span class="hl-1">    .</span><span class="hl-0">replace</span><span class="hl-1">(</span><span class="hl-15">/`/</span><span class="hl-7">g</span><span class="hl-1">, </span><span class="hl-2">&#39;</span><span class="hl-12">\\</span><span class="hl-2">`&#39;</span><span class="hl-1">)</span><br/><span class="hl-1">    .</span><span class="hl-0">replace</span><span class="hl-1">(</span><span class="hl-15">/</span><span class="hl-12">\$</span><span class="hl-15">/</span><span class="hl-7">g</span><span class="hl-1">, </span><span class="hl-2">&#39;</span><span class="hl-12">\\</span><span class="hl-2">$&#39;</span><span class="hl-1">);</span><br/><br/><span class="hl-1">  </span><span class="hl-3">return</span><span class="hl-1"> [</span><br/><span class="hl-1">    </span><span class="hl-2">`addStrategy({`</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-2">`    strategyName: &quot;</span><span class="hl-7">${</span><span class="hl-4">strategyName</span><span class="hl-7">}</span><span class="hl-2">&quot;,`</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-2">`    interval: &quot;</span><span class="hl-7">${</span><span class="hl-4">interval</span><span class="hl-7">}</span><span class="hl-2">&quot;,`</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-2">`    getSignal: async (symbol) =&gt; {`</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-2">`        const messages = [];`</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-2">``</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-2">`        // Загружаем данные всех таймфреймов`</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-2">`        const microTermCandles = await getCandles(symbol, &quot;1m&quot;, 30);`</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-2">`        const mainTermCandles = await getCandles(symbol, &quot;5m&quot;, 24);`</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-5">// ... message building for each timeframe</span><br/><span class="hl-1">    </span><span class="hl-2">`        messages.push({`</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-2">`            role: &quot;user&quot;,`</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-2">`            content: [`</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-2">`                &quot;Проанализируй все таймфреймы и сгенерируй торговый сигнал...&quot;,`</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-2">`                &quot;&quot;,`</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-2">`                </span><span class="hl-12">\`</span><span class="hl-7">${</span><span class="hl-4">escapedPrompt</span><span class="hl-7">}</span><span class="hl-12">\`</span><span class="hl-2">,`</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-2">`            ].join(&quot;</span><span class="hl-12">\\</span><span class="hl-2">n&quot;),`</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-2">`        });`</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-2">``</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-2">`        const result = await json(messages);`</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-2">`        return result;`</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-2">`    },`</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-2">`});`</span><br/><span class="hl-1">  ].</span><span class="hl-0">join</span><span class="hl-1">(</span><span class="hl-2">&quot;</span><span class="hl-12">\n</span><span class="hl-2">&quot;</span><span class="hl-1">);</span><br/><span class="hl-1">};</span>
</code><button type="button">Copy</button></pre>

<p>Key features:</p>
<ul>
<li>Fetches 1m, 5m, 15m, 1h candles via <code>getCandles()</code></li>
<li>Formats each timeframe as separate user/assistant message pair</li>
<li>Includes custom strategy prompt from <code>getPrompt()</code></li>
<li>Calls <code>json()</code> helper for structured LLM output</li>
<li>Returns <code>ISignalDto</code> compatible object</li>
</ul>
<hr>
<a id="code-generation-process" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Code Generation Process<a href="#code-generation-process" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>The <code>getCode()</code> method assembles all template sections into complete executable code.</p>
<a id="code-assembly-flow" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Code Assembly Flow<a href="#code-assembly-flow" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><img src="../media/20-optimizer-mode_3.svg" alt="Mermaid Diagram"></p>
<p><strong>Code Assembly Diagram: How Template Sections Are Combined</strong></p>
<a id="naming-convention" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Naming Convention<a href="#naming-convention" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>All generated entities use a unique prefix to avoid conflicts:</p>
<pre><code class="typescript"><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">prefix</span><span class="hl-1"> = </span><span class="hl-0">CREATE_PREFIX_FN</span><span class="hl-1">(); </span><span class="hl-5">// e.g., &quot;a7f3k2&quot;</span><br/><br/><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">exchangeName</span><span class="hl-1"> = </span><span class="hl-2">`</span><span class="hl-7">${</span><span class="hl-4">prefix</span><span class="hl-7">}</span><span class="hl-2">_exchange`</span><span class="hl-1">;       </span><span class="hl-5">// &quot;a7f3k2_exchange&quot;</span><br/><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">trainFrameName</span><span class="hl-1"> = </span><span class="hl-2">`</span><span class="hl-7">${</span><span class="hl-4">prefix</span><span class="hl-7">}</span><span class="hl-2">_train_frame-1`</span><span class="hl-1">; </span><span class="hl-5">// &quot;a7f3k2_train_frame-1&quot;</span><br/><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">testFrameName</span><span class="hl-1"> = </span><span class="hl-2">`</span><span class="hl-7">${</span><span class="hl-4">prefix</span><span class="hl-7">}</span><span class="hl-2">_test_frame`</span><span class="hl-1">;     </span><span class="hl-5">// &quot;a7f3k2_test_frame&quot;</span><br/><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">strategyName</span><span class="hl-1"> = </span><span class="hl-2">`</span><span class="hl-7">${</span><span class="hl-4">prefix</span><span class="hl-7">}</span><span class="hl-2">_strategy-1`</span><span class="hl-1">;      </span><span class="hl-5">// &quot;a7f3k2_strategy-1&quot;</span><br/><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">walkerName</span><span class="hl-1"> = </span><span class="hl-2">`</span><span class="hl-7">${</span><span class="hl-4">prefix</span><span class="hl-7">}</span><span class="hl-2">_walker`</span><span class="hl-1">;            </span><span class="hl-5">// &quot;a7f3k2_walker&quot;</span>
</code><button type="button">Copy</button></pre>

<p>The prefix is generated using: <code>(Math.random() + 1).toString(36).substring(7)</code></p>
<a id="generated-code-structure" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Generated Code Structure<a href="#generated-code-structure" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>The final code has this structure:</p>
<pre><code><span class="hl-5">#!/usr/bin/env node</span><br/><br/><span class="hl-5">// Imports (Ollama, ccxt, backtest-kit, fs, uuid, path)</span><br/><span class="hl-3">import</span><span class="hl-1"> { </span><span class="hl-4">Ollama</span><span class="hl-1"> } </span><span class="hl-3">from</span><span class="hl-1"> </span><span class="hl-2">&quot;ollama&quot;</span><span class="hl-1">;</span><br/><span class="hl-3">import</span><span class="hl-1"> </span><span class="hl-4">ccxt</span><span class="hl-1"> </span><span class="hl-3">from</span><span class="hl-1"> </span><span class="hl-2">&quot;ccxt&quot;</span><span class="hl-1">;</span><br/><span class="hl-3">import</span><span class="hl-1"> { </span><span class="hl-4">addExchange</span><span class="hl-1">, </span><span class="hl-4">addStrategy</span><span class="hl-1">, </span><span class="hl-4">addFrame</span><span class="hl-1">, </span><span class="hl-4">addWalker</span><span class="hl-1">, </span><span class="hl-4">Walker</span><span class="hl-1">, ... } </span><span class="hl-3">from</span><span class="hl-1"> </span><span class="hl-2">&quot;backtest-kit&quot;</span><span class="hl-1">;</span><br/><br/><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">WARN_KB</span><span class="hl-1"> = </span><span class="hl-6">100</span><span class="hl-1">;</span><br/><br/><span class="hl-5">// Helper: dumpJson() - Saves LLM conversations to ./dump/strategy/{resultId}/</span><br/><span class="hl-7">async</span><span class="hl-1"> </span><span class="hl-7">function</span><span class="hl-1"> </span><span class="hl-0">dumpJson</span><span class="hl-1">(</span><span class="hl-4">resultId</span><span class="hl-1">, </span><span class="hl-4">history</span><span class="hl-1">, </span><span class="hl-4">result</span><span class="hl-1">, </span><span class="hl-4">outputDir</span><span class="hl-1"> = </span><span class="hl-2">&quot;./dump/strategy&quot;</span><span class="hl-1">) { ... }</span><br/><br/><span class="hl-5">// Helper: text() - LLM text generation via Ollama</span><br/><span class="hl-7">async</span><span class="hl-1"> </span><span class="hl-7">function</span><span class="hl-1"> </span><span class="hl-0">text</span><span class="hl-1">(</span><span class="hl-4">messages</span><span class="hl-1">) { ... }</span><br/><br/><span class="hl-5">// Helper: json() - LLM structured output with signal schema</span><br/><span class="hl-7">async</span><span class="hl-1"> </span><span class="hl-7">function</span><span class="hl-1"> </span><span class="hl-0">json</span><span class="hl-1">(</span><span class="hl-4">messages</span><span class="hl-1">) { ... }</span><br/><br/><span class="hl-5">// Exchange configuration</span><br/><span class="hl-0">addExchange</span><span class="hl-1">({</span><br/><span class="hl-1">    </span><span class="hl-4">exchangeName:</span><span class="hl-1"> </span><span class="hl-2">&quot;a7f3k2_exchange&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-0">getCandles</span><span class="hl-4">:</span><span class="hl-1"> </span><span class="hl-7">async</span><span class="hl-1"> (</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">interval</span><span class="hl-1">, </span><span class="hl-4">since</span><span class="hl-1">, </span><span class="hl-4">limit</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> { ... },</span><br/><span class="hl-1">    </span><span class="hl-0">formatPrice</span><span class="hl-4">:</span><span class="hl-1"> </span><span class="hl-7">async</span><span class="hl-1"> (</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">price</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> </span><span class="hl-4">price</span><span class="hl-1">.</span><span class="hl-0">toFixed</span><span class="hl-1">(</span><span class="hl-6">2</span><span class="hl-1">),</span><br/><span class="hl-1">    </span><span class="hl-0">formatQuantity</span><span class="hl-4">:</span><span class="hl-1"> </span><span class="hl-7">async</span><span class="hl-1"> (</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">quantity</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> </span><span class="hl-4">quantity</span><span class="hl-1">.</span><span class="hl-0">toFixed</span><span class="hl-1">(</span><span class="hl-6">8</span><span class="hl-1">),</span><br/><span class="hl-1">});</span><br/><br/><span class="hl-5">// Training frames (one per rangeTrain)</span><br/><span class="hl-0">addFrame</span><span class="hl-1">({ </span><span class="hl-4">frameName:</span><span class="hl-1"> </span><span class="hl-2">&quot;a7f3k2_train_frame-1&quot;</span><span class="hl-1">, </span><span class="hl-4">interval:</span><span class="hl-1"> </span><span class="hl-2">&quot;1m&quot;</span><span class="hl-1">, </span><span class="hl-4">startDate:</span><span class="hl-1"> ..., </span><span class="hl-4">endDate:</span><span class="hl-1"> ... });</span><br/><span class="hl-0">addFrame</span><span class="hl-1">({ </span><span class="hl-4">frameName:</span><span class="hl-1"> </span><span class="hl-2">&quot;a7f3k2_train_frame-2&quot;</span><span class="hl-1">, </span><span class="hl-4">interval:</span><span class="hl-1"> </span><span class="hl-2">&quot;1m&quot;</span><span class="hl-1">, </span><span class="hl-4">startDate:</span><span class="hl-1"> ..., </span><span class="hl-4">endDate:</span><span class="hl-1"> ... });</span><br/><br/><span class="hl-5">// Test frame (from rangeTest)</span><br/><span class="hl-0">addFrame</span><span class="hl-1">({ </span><span class="hl-4">frameName:</span><span class="hl-1"> </span><span class="hl-2">&quot;a7f3k2_test_frame&quot;</span><span class="hl-1">, </span><span class="hl-4">interval:</span><span class="hl-1"> </span><span class="hl-2">&quot;1m&quot;</span><span class="hl-1">, </span><span class="hl-4">startDate:</span><span class="hl-1"> ..., </span><span class="hl-4">endDate:</span><span class="hl-1"> ... });</span><br/><br/><span class="hl-5">// Strategies (one per training range/source)</span><br/><span class="hl-0">addStrategy</span><span class="hl-1">({</span><br/><span class="hl-1">    </span><span class="hl-4">strategyName:</span><span class="hl-1"> </span><span class="hl-2">&quot;a7f3k2_strategy-1&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-4">interval:</span><span class="hl-1"> </span><span class="hl-2">&quot;5m&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-0">getSignal</span><span class="hl-4">:</span><span class="hl-1"> </span><span class="hl-7">async</span><span class="hl-1"> (</span><span class="hl-4">symbol</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">        </span><span class="hl-5">// Multi-timeframe data fetching</span><br/><span class="hl-1">        </span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">microTermCandles</span><span class="hl-1"> = </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-0">getCandles</span><span class="hl-1">(</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-2">&quot;1m&quot;</span><span class="hl-1">, </span><span class="hl-6">30</span><span class="hl-1">);</span><br/><span class="hl-1">        </span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">mainTermCandles</span><span class="hl-1"> = </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-0">getCandles</span><span class="hl-1">(</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-2">&quot;5m&quot;</span><span class="hl-1">, </span><span class="hl-6">24</span><span class="hl-1">);</span><br/><span class="hl-1">        </span><span class="hl-5">// ... message building</span><br/><span class="hl-1">        </span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">result</span><span class="hl-1"> = </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-0">json</span><span class="hl-1">(</span><span class="hl-4">messages</span><span class="hl-1">);</span><br/><span class="hl-1">        </span><span class="hl-3">return</span><span class="hl-1"> </span><span class="hl-4">result</span><span class="hl-1">;</span><br/><span class="hl-1">    },</span><br/><span class="hl-1">});</span><br/><span class="hl-0">addStrategy</span><span class="hl-1">({ </span><span class="hl-4">strategyName:</span><span class="hl-1"> </span><span class="hl-2">&quot;a7f3k2_strategy-2&quot;</span><span class="hl-1">, ... });</span><br/><br/><span class="hl-5">// Walker configuration</span><br/><span class="hl-0">addWalker</span><span class="hl-1">({</span><br/><span class="hl-1">    </span><span class="hl-4">walkerName:</span><span class="hl-1"> </span><span class="hl-2">&quot;a7f3k2_walker&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-4">exchangeName:</span><span class="hl-1"> </span><span class="hl-2">&quot;a7f3k2_exchange&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-4">frameName:</span><span class="hl-1"> </span><span class="hl-2">&quot;a7f3k2_test_frame&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-4">strategies:</span><span class="hl-1"> [</span><span class="hl-2">&quot;a7f3k2_strategy-1&quot;</span><span class="hl-1">, </span><span class="hl-2">&quot;a7f3k2_strategy-2&quot;</span><span class="hl-1">],</span><br/><span class="hl-1">});</span><br/><br/><span class="hl-5">// Launcher with event listeners</span><br/><span class="hl-4">Walker</span><span class="hl-1">.</span><span class="hl-0">background</span><span class="hl-1">(</span><span class="hl-2">&quot;BTCUSDT&quot;</span><span class="hl-1">, { </span><span class="hl-4">walkerName:</span><span class="hl-1"> </span><span class="hl-2">&quot;a7f3k2_walker&quot;</span><span class="hl-1"> });</span><br/><span class="hl-0">listenSignalBacktest</span><span class="hl-1">((</span><span class="hl-4">event</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> { ... });</span><br/><span class="hl-0">listenWalkerComplete</span><span class="hl-1">((</span><span class="hl-4">results</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> { ... });</span>
</code><button>Copy</button></pre>

<hr>
<a id="public-api-methods" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Public API Methods<a href="#public-api-methods" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>The <code>Optimizer</code> class provides three main methods for interacting with the optimizer system.</p>
<a id="optimizergetdata" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Optimizer.getData()<a href="#optimizergetdata" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Fetches data from all sources and generates strategy metadata without generating code:</p>
<pre><code class="typescript"><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">strategies</span><span class="hl-1"> = </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-4">Optimizer</span><span class="hl-1">.</span><span class="hl-0">getData</span><span class="hl-1">(</span><span class="hl-2">&quot;BTCUSDT&quot;</span><span class="hl-1">, {</span><br/><span class="hl-1">  </span><span class="hl-4">optimizerName:</span><span class="hl-1"> </span><span class="hl-2">&quot;my-optimizer&quot;</span><br/><span class="hl-1">});</span><br/><br/><span class="hl-5">// Returns: IOptimizerStrategy[]</span><br/><span class="hl-5">// [</span><br/><span class="hl-5">//   {</span><br/><span class="hl-5">//     symbol: &quot;BTCUSDT&quot;,</span><br/><span class="hl-5">//     name: &quot;1h-candles&quot;,</span><br/><span class="hl-5">//     messages: [</span><br/><span class="hl-5">//       { role: &quot;user&quot;, content: &quot;...&quot; },</span><br/><span class="hl-5">//       { role: &quot;assistant&quot;, content: &quot;...&quot; },</span><br/><span class="hl-5">//       // ... more messages</span><br/><span class="hl-5">//     ],</span><br/><span class="hl-5">//     strategy: &quot;Trading strategy prompt...&quot;</span><br/><span class="hl-5">//   },</span><br/><span class="hl-5">//   // ... more strategies (one per training range)</span><br/><span class="hl-5">// ]</span>
</code><button type="button">Copy</button></pre>

<p>Useful for:</p>
<ul>
<li>Inspecting generated strategy prompts</li>
<li>Debugging data source formatting</li>
<li>Validating conversation history</li>
<li>Testing <code>getPrompt()</code> output</li>
</ul>
<a id="optimizergetcode" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Optimizer.getCode()<a href="#optimizergetcode" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Generates complete executable strategy code as a string:</p>
<pre><code class="typescript"><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">code</span><span class="hl-1"> = </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-4">Optimizer</span><span class="hl-1">.</span><span class="hl-0">getCode</span><span class="hl-1">(</span><span class="hl-2">&quot;BTCUSDT&quot;</span><span class="hl-1">, {</span><br/><span class="hl-1">  </span><span class="hl-4">optimizerName:</span><span class="hl-1"> </span><span class="hl-2">&quot;my-optimizer&quot;</span><br/><span class="hl-1">});</span><br/><br/><span class="hl-5">// Returns: string (complete .mjs file content)</span><br/><span class="hl-5">// Can be executed directly or written to file</span>
</code><button type="button">Copy</button></pre>

<p>This method:</p>
<ol>
<li>Calls <code>getData()</code> internally</li>
<li>Generates all template sections</li>
<li>Combines sections with newlines</li>
<li>Invokes <code>callbacks.onCode()</code> if defined</li>
<li>Returns complete code string</li>
</ol>
<a id="optimizerdump" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Optimizer.dump()<a href="#optimizerdump" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Generates code and writes it to the file system:</p>
<pre><code class="typescript"><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-4">Optimizer</span><span class="hl-1">.</span><span class="hl-0">dump</span><span class="hl-1">(</span><span class="hl-2">&quot;BTCUSDT&quot;</span><span class="hl-1">, {</span><br/><span class="hl-1">  </span><span class="hl-4">optimizerName:</span><span class="hl-1"> </span><span class="hl-2">&quot;my-optimizer&quot;</span><br/><span class="hl-1">}, </span><span class="hl-2">&quot;./output&quot;</span><span class="hl-1">);</span><br/><br/><span class="hl-5">// Creates: ./output/my-optimizer_BTCUSDT.mjs</span>
</code><button type="button">Copy</button></pre>

<p>File naming: <code>{optimizerName}_{symbol}.mjs</code></p>
<p>This method:</p>
<ol>
<li>Calls <code>getCode()</code> internally</li>
<li>Creates output directory (recursive)</li>
<li>Writes file with UTF-8 encoding</li>
<li>Invokes <code>callbacks.onDump()</code> if defined</li>
<li>Logs success/failure via logger</li>
</ol>
<p>Default path: <code>./</code> (current directory)</p>
<hr>
<a id="progress-monitoring" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Progress Monitoring<a href="#progress-monitoring" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>The optimizer emits progress events during data collection to track source processing.</p>
<a id="progress-event-structure" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Progress Event Structure<a href="#progress-event-structure" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><pre><code class="typescript"><span class="hl-7">interface</span><span class="hl-1"> </span><span class="hl-13">ProgressOptimizerContract</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-4">optimizerName</span><span class="hl-1">: </span><span class="hl-13">string</span><span class="hl-1">;      </span><span class="hl-5">// Optimizer being executed</span><br/><span class="hl-1">  </span><span class="hl-4">symbol</span><span class="hl-1">: </span><span class="hl-13">string</span><span class="hl-1">;             </span><span class="hl-5">// Trading symbol (e.g., &quot;BTCUSDT&quot;)</span><br/><span class="hl-1">  </span><span class="hl-4">totalSources</span><span class="hl-1">: </span><span class="hl-13">number</span><span class="hl-1">;       </span><span class="hl-5">// Total sources to process</span><br/><span class="hl-1">  </span><span class="hl-4">processedSources</span><span class="hl-1">: </span><span class="hl-13">number</span><span class="hl-1">;   </span><span class="hl-5">// Sources processed so far</span><br/><span class="hl-1">  </span><span class="hl-4">progress</span><span class="hl-1">: </span><span class="hl-13">number</span><span class="hl-1">;           </span><span class="hl-5">// Completion (0.0 to 1.0)</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<a id="listening-to-progress" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Listening to Progress<a href="#listening-to-progress" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><pre><code class="typescript"><span class="hl-3">import</span><span class="hl-1"> { </span><span class="hl-4">listenOptimizerProgress</span><span class="hl-1"> } </span><span class="hl-3">from</span><span class="hl-1"> </span><span class="hl-2">&quot;backtest-kit&quot;</span><span class="hl-1">;</span><br/><br/><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">unsubscribe</span><span class="hl-1"> = </span><span class="hl-0">listenOptimizerProgress</span><span class="hl-1">((</span><span class="hl-4">event</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-4">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-2">`Progress: </span><span class="hl-7">${</span><span class="hl-9">(</span><span class="hl-4">event</span><span class="hl-9">.</span><span class="hl-4">progress</span><span class="hl-9"> </span><span class="hl-1">*</span><span class="hl-9"> </span><span class="hl-6">100</span><span class="hl-9">).</span><span class="hl-0">toFixed</span><span class="hl-9">(</span><span class="hl-6">2</span><span class="hl-9">)</span><span class="hl-7">}</span><span class="hl-2">%`</span><span class="hl-1">);</span><br/><span class="hl-1">  </span><span class="hl-4">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-2">`Processed: </span><span class="hl-7">${</span><span class="hl-4">event</span><span class="hl-9">.</span><span class="hl-4">processedSources</span><span class="hl-7">}</span><span class="hl-2"> / </span><span class="hl-7">${</span><span class="hl-4">event</span><span class="hl-9">.</span><span class="hl-4">totalSources</span><span class="hl-7">}</span><span class="hl-2">`</span><span class="hl-1">);</span><br/><span class="hl-1">  </span><span class="hl-4">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-2">`Optimizer: </span><span class="hl-7">${</span><span class="hl-4">event</span><span class="hl-9">.</span><span class="hl-4">optimizerName</span><span class="hl-7">}</span><span class="hl-2">, Symbol: </span><span class="hl-7">${</span><span class="hl-4">event</span><span class="hl-9">.</span><span class="hl-4">symbol</span><span class="hl-7">}</span><span class="hl-2">`</span><span class="hl-1">);</span><br/><span class="hl-1">});</span><br/><br/><span class="hl-5">// Later: stop listening</span><br/><span class="hl-0">unsubscribe</span><span class="hl-1">();</span>
</code><button type="button">Copy</button></pre>

<p>Progress is emitted:</p>
<ol>
<li><strong>Before each source</strong> is fetched (start of processing)</li>
<li><strong>After all sources</strong> are complete (final 100% event)</li>
</ol>
<p>Calculation: <code>progress = processedSources / totalSources</code></p>
<p>Total sources: <code>rangeTrain.length * source.length</code></p>
<a id="event-flow-diagram" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Event Flow Diagram<a href="#event-flow-diagram" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><img src="../media/20-optimizer-mode_4.svg" alt="Mermaid Diagram"></p>
<p><strong>Progress Event Flow: Tracking Source Processing</strong></p>
<hr>
<a id="demo-application-example" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Demo Application Example<a href="#demo-application-example" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>The demo application at <code>demo/optimization</code> demonstrates real-world optimizer usage with pre-computed technical indicators.</p>
<a id="configuration" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Configuration<a href="#configuration" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><pre><code class="javascript"><span class="hl-5">// Training ranges (7 days)</span><br/><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">TRAIN_RANGE</span><span class="hl-1"> = [</span><br/><span class="hl-1">  {</span><br/><span class="hl-1">    </span><span class="hl-4">note:</span><span class="hl-1"> </span><span class="hl-2">&quot;24 ноября 2025&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-4">startDate:</span><span class="hl-1"> </span><span class="hl-7">new</span><span class="hl-1"> </span><span class="hl-0">Date</span><span class="hl-1">(</span><span class="hl-2">&quot;2025-11-24T00:00:00Z&quot;</span><span class="hl-1">),</span><br/><span class="hl-1">    </span><span class="hl-4">endDate:</span><span class="hl-1"> </span><span class="hl-7">new</span><span class="hl-1"> </span><span class="hl-0">Date</span><span class="hl-1">(</span><span class="hl-2">&quot;2025-11-24T23:59:59Z&quot;</span><span class="hl-1">),</span><br/><span class="hl-1">  },</span><br/><span class="hl-1">  </span><span class="hl-5">// ... 6 more training days</span><br/><span class="hl-1">];</span><br/><br/><span class="hl-5">// Testing range (1 day)</span><br/><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">TEST_RANGE</span><span class="hl-1"> = {</span><br/><span class="hl-1">  </span><span class="hl-4">note:</span><span class="hl-1"> </span><span class="hl-2">&quot;1 декабря 2025&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">startDate:</span><span class="hl-1"> </span><span class="hl-7">new</span><span class="hl-1"> </span><span class="hl-0">Date</span><span class="hl-1">(</span><span class="hl-2">&quot;2025-12-01T00:00:00Z&quot;</span><span class="hl-1">),</span><br/><span class="hl-1">  </span><span class="hl-4">endDate:</span><span class="hl-1"> </span><span class="hl-7">new</span><span class="hl-1"> </span><span class="hl-0">Date</span><span class="hl-1">(</span><span class="hl-2">&quot;2025-12-01T23:59:59Z&quot;</span><span class="hl-1">),</span><br/><span class="hl-1">};</span><br/><br/><span class="hl-5">// Data sources (4 timeframes)</span><br/><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">SOURCE_LIST</span><span class="hl-1"> = [</span><br/><span class="hl-1">  {</span><br/><span class="hl-1">    </span><span class="hl-4">name:</span><span class="hl-1"> </span><span class="hl-2">&quot;long-term-range&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-0">fetch</span><span class="hl-4">:</span><span class="hl-1"> </span><span class="hl-7">async</span><span class="hl-1"> ({ </span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">startDate</span><span class="hl-1">, </span><span class="hl-4">endDate</span><span class="hl-1">, </span><span class="hl-4">limit</span><span class="hl-1">, </span><span class="hl-4">offset</span><span class="hl-1"> }) </span><span class="hl-7">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">      </span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">url</span><span class="hl-1"> = </span><span class="hl-7">new</span><span class="hl-1"> </span><span class="hl-0">URL</span><span class="hl-1">(</span><span class="hl-2">`</span><span class="hl-7">${</span><span class="hl-4">process</span><span class="hl-9">.</span><span class="hl-4">env</span><span class="hl-9">.</span><span class="hl-8">CCXT_DUMPER_URL</span><span class="hl-7">}</span><span class="hl-2">/view/long-term-range`</span><span class="hl-1">);</span><br/><span class="hl-1">      </span><span class="hl-4">url</span><span class="hl-1">.</span><span class="hl-4">searchParams</span><span class="hl-1">.</span><span class="hl-0">set</span><span class="hl-1">(</span><span class="hl-2">&quot;symbol&quot;</span><span class="hl-1">, </span><span class="hl-4">symbol</span><span class="hl-1">);</span><br/><span class="hl-1">      </span><span class="hl-4">url</span><span class="hl-1">.</span><span class="hl-4">searchParams</span><span class="hl-1">.</span><span class="hl-0">set</span><span class="hl-1">(</span><span class="hl-2">&quot;startDate&quot;</span><span class="hl-1">, </span><span class="hl-4">startDate</span><span class="hl-1">.</span><span class="hl-0">getTime</span><span class="hl-1">());</span><br/><span class="hl-1">      </span><span class="hl-4">url</span><span class="hl-1">.</span><span class="hl-4">searchParams</span><span class="hl-1">.</span><span class="hl-0">set</span><span class="hl-1">(</span><span class="hl-2">&quot;endDate&quot;</span><span class="hl-1">, </span><span class="hl-4">endDate</span><span class="hl-1">.</span><span class="hl-0">getTime</span><span class="hl-1">());</span><br/><span class="hl-1">      </span><span class="hl-4">url</span><span class="hl-1">.</span><span class="hl-4">searchParams</span><span class="hl-1">.</span><span class="hl-0">set</span><span class="hl-1">(</span><span class="hl-2">&quot;limit&quot;</span><span class="hl-1">, </span><span class="hl-4">limit</span><span class="hl-1"> || </span><span class="hl-6">1000</span><span class="hl-1">);</span><br/><span class="hl-1">      </span><span class="hl-4">url</span><span class="hl-1">.</span><span class="hl-4">searchParams</span><span class="hl-1">.</span><span class="hl-0">set</span><span class="hl-1">(</span><span class="hl-2">&quot;offset&quot;</span><span class="hl-1">, </span><span class="hl-4">offset</span><span class="hl-1"> || </span><span class="hl-6">0</span><span class="hl-1">);</span><br/><span class="hl-1">      </span><span class="hl-7">const</span><span class="hl-1"> { </span><span class="hl-4">rows</span><span class="hl-1">: </span><span class="hl-8">data</span><span class="hl-1"> } = </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-0">fetchApi</span><span class="hl-1">(</span><span class="hl-4">url</span><span class="hl-1">);</span><br/><span class="hl-1">      </span><span class="hl-3">return</span><span class="hl-1"> </span><span class="hl-4">data</span><span class="hl-1">;</span><br/><span class="hl-1">    },</span><br/><span class="hl-1">    </span><span class="hl-0">user</span><span class="hl-4">:</span><span class="hl-1"> (</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">data</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> </span><br/><span class="hl-1">      </span><span class="hl-4">str</span><span class="hl-1">.</span><span class="hl-0">newline</span><span class="hl-1">(</span><br/><span class="hl-1">        </span><span class="hl-2">`# 1-Hour Candles Trading Analysis for </span><span class="hl-7">${</span><span class="hl-4">symbol</span><span class="hl-7">}</span><span class="hl-12">\n\n</span><span class="hl-2">`</span><span class="hl-1">,</span><br/><span class="hl-1">        </span><span class="hl-0">arrayToMarkdownTable</span><span class="hl-1">(</span><span class="hl-4">data</span><span class="hl-1">),</span><br/><span class="hl-1">        </span><span class="hl-5">// ... metadata about indicators</span><br/><span class="hl-1">      ),</span><br/><span class="hl-1">    </span><span class="hl-0">assistant</span><span class="hl-4">:</span><span class="hl-1"> () </span><span class="hl-7">=&gt;</span><span class="hl-1"> </span><span class="hl-2">&quot;Исторические данные 1-часовых свечей получены&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">  },</span><br/><span class="hl-1">  </span><span class="hl-5">// ... 3 more sources (30m, 15m, 1m)</span><br/><span class="hl-1">];</span>
</code><button type="button">Copy</button></pre>

<a id="integration-with-ccxt-dumper" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Integration with CCXT Dumper<a href="#integration-with-ccxt-dumper" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>The demo relies on <code>CCXT_DUMPER_URL</code> environment variable pointing to a pre-computation service:</p>
<pre><code><span class="hl-8">CCXT_DUMPER_URL</span><span class="hl-1">=</span><span class="hl-10">http</span><span class="hl-1">:</span><span class="hl-5">//localhost:3000</span><br/><span class="hl-8">OLLAMA_API_KEY</span><span class="hl-1">=</span><span class="hl-4">your_api_key</span>
</code><button>Copy</button></pre>

<p>The dumper service provides endpoints for each timeframe:</p>
<ul>
<li><code>/view/long-term-range</code> - 1-hour candles with indicators</li>
<li><code>/view/swing-term-range</code> - 30-minute candles with indicators</li>
<li><code>/view/short-term-range</code> - 15-minute candles with indicators</li>
<li><code>/view/micro-term-range</code> - 1-minute candles with indicators</li>
</ul>
<p>Each endpoint returns JSON with paginated technical indicators (RSI, MACD, Bollinger Bands, etc.)</p>
<a id="prompt-generation" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Prompt Generation<a href="#prompt-generation" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>The demo uses Ollama API to generate strategy recommendations:</p>
<pre><code class="javascript"><span class="hl-10">getPrompt</span><span class="hl-1">: </span><span class="hl-7">async</span><span class="hl-1"> (</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">messages</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">ollama</span><span class="hl-1"> = </span><span class="hl-7">new</span><span class="hl-1"> </span><span class="hl-0">Ollama</span><span class="hl-1">({</span><br/><span class="hl-1">    </span><span class="hl-4">host:</span><span class="hl-1"> </span><span class="hl-2">&quot;https://ollama.com&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-4">headers:</span><span class="hl-1"> {</span><br/><span class="hl-1">      </span><span class="hl-4">Authorization:</span><span class="hl-1"> </span><span class="hl-2">`Bearer </span><span class="hl-7">${</span><span class="hl-4">process</span><span class="hl-9">.</span><span class="hl-4">env</span><span class="hl-9">.</span><span class="hl-8">OLLAMA_API_KEY</span><span class="hl-7">}</span><span class="hl-2">`</span><span class="hl-1">,</span><br/><span class="hl-1">    },</span><br/><span class="hl-1">  });</span><br/><br/><span class="hl-1">  </span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">response</span><span class="hl-1"> = </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-4">ollama</span><span class="hl-1">.</span><span class="hl-0">chat</span><span class="hl-1">({</span><br/><span class="hl-1">    </span><span class="hl-4">model:</span><span class="hl-1"> </span><span class="hl-2">&quot;deepseek-v3.1:671b&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-4">messages:</span><span class="hl-1"> [</span><br/><span class="hl-1">      {</span><br/><span class="hl-1">        </span><span class="hl-4">role:</span><span class="hl-1"> </span><span class="hl-2">&quot;system&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">        </span><span class="hl-4">content:</span><span class="hl-1"> [</span><br/><span class="hl-1">          </span><span class="hl-2">&quot;В ответ напиши торговую стратегию где нет ничего лишнего,&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">          </span><span class="hl-2">&quot;только отчёт готовый для копипасты целиком&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">          </span><span class="hl-2">&quot;&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">          </span><span class="hl-2">&quot;**ВАЖНО**: Не здоровайся, не говори что делаешь - только отчёт!&quot;</span><br/><span class="hl-1">        ].</span><span class="hl-0">join</span><span class="hl-1">(</span><span class="hl-2">&quot;</span><span class="hl-12">\n</span><span class="hl-2">&quot;</span><span class="hl-1">),</span><br/><span class="hl-1">      },</span><br/><span class="hl-1">      ...</span><span class="hl-4">messages</span><span class="hl-1">,</span><br/><span class="hl-1">      {</span><br/><span class="hl-1">        </span><span class="hl-4">role:</span><span class="hl-1"> </span><span class="hl-2">&quot;user&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">        </span><span class="hl-4">content:</span><span class="hl-1"> [</span><br/><span class="hl-1">          </span><span class="hl-2">`На каких условиях мне купить </span><span class="hl-7">${</span><span class="hl-4">symbol</span><span class="hl-7">}</span><span class="hl-2">?`</span><span class="hl-1">,</span><br/><span class="hl-1">          </span><span class="hl-2">&quot;Дай анализ рынка на основе поддержки/сопротивления, точек входа в LONG/SHORT позиции.&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">          </span><span class="hl-2">&quot;Какой RR ставить для позиций?&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">          </span><span class="hl-5">// ...</span><br/><span class="hl-1">        ].</span><span class="hl-0">join</span><span class="hl-1">(</span><span class="hl-2">&quot;</span><span class="hl-12">\n</span><span class="hl-2">&quot;</span><span class="hl-1">)</span><br/><span class="hl-1">      }</span><br/><span class="hl-1">    ]</span><br/><span class="hl-1">  });</span><br/><br/><span class="hl-1">  </span><span class="hl-3">return</span><span class="hl-1"> </span><span class="hl-4">response</span><span class="hl-1">.</span><span class="hl-4">message</span><span class="hl-1">.</span><span class="hl-4">content</span><span class="hl-1">.</span><span class="hl-0">trim</span><span class="hl-1">()</span><br/><span class="hl-1">    .</span><span class="hl-0">replace</span><span class="hl-1">(</span><span class="hl-15">/</span><span class="hl-12">\\</span><span class="hl-15">/</span><span class="hl-7">g</span><span class="hl-1">, </span><span class="hl-2">&#39;</span><span class="hl-12">\\\\</span><span class="hl-2">&#39;</span><span class="hl-1">)</span><br/><span class="hl-1">    .</span><span class="hl-0">replace</span><span class="hl-1">(</span><span class="hl-15">/`/</span><span class="hl-7">g</span><span class="hl-1">, </span><span class="hl-2">&#39;</span><span class="hl-12">\\</span><span class="hl-2">`&#39;</span><span class="hl-1">)</span><br/><span class="hl-1">    .</span><span class="hl-0">replace</span><span class="hl-1">(</span><span class="hl-15">/</span><span class="hl-12">\$</span><span class="hl-15">/</span><span class="hl-7">g</span><span class="hl-1">, </span><span class="hl-2">&#39;</span><span class="hl-12">\\</span><span class="hl-2">$&#39;</span><span class="hl-1">)</span><br/><span class="hl-1">    .</span><span class="hl-0">replace</span><span class="hl-1">(</span><span class="hl-15">/&quot;/</span><span class="hl-7">g</span><span class="hl-1">, </span><span class="hl-2">&#39;</span><span class="hl-12">\\</span><span class="hl-2">&quot;&#39;</span><span class="hl-1">);</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<p>The prompt asks the LLM to:</p>
<ol>
<li>Analyze multi-timeframe data</li>
<li>Identify support/resistance levels</li>
<li>Determine LONG/SHORT entry points</li>
<li>Calculate risk/reward ratios</li>
<li>Provide strategic recommendations</li>
</ol>
<a id="execution" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Execution<a href="#execution" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><pre><code class="bash"><span class="hl-0">cd</span><span class="hl-1"> </span><span class="hl-2">demo/optimization</span><br/><span class="hl-0">npm</span><span class="hl-1"> </span><span class="hl-2">install</span><br/><span class="hl-0">npm</span><span class="hl-1"> </span><span class="hl-2">start</span>
</code><button type="button">Copy</button></pre>

<p>This:</p>
<ol>
<li>Registers optimizer with <code>addOptimizer()</code></li>
<li>Calls <code>Optimizer.dump(&quot;BTC/USDT&quot;, &quot;btc-optimizer&quot;)</code></li>
<li>Generates file: <code>./btc-optimizer_BTC/USDT.mjs</code></li>
<li>Logs progress to console</li>
</ol>
<hr>
<a id="key-implementation-details" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Key Implementation Details<a href="#key-implementation-details" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><a id="security-string-escaping" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Security: String Escaping<a href="#security-string-escaping" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>All template methods escape user input to prevent code injection:</p>
<pre><code class="typescript"><span class="hl-5">// Escape special characters for safe string interpolation</span><br/><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">escapedStrategyName</span><span class="hl-1"> = </span><span class="hl-0">String</span><span class="hl-1">(</span><span class="hl-4">strategyName</span><span class="hl-1">)</span><br/><span class="hl-1">  .</span><span class="hl-0">replace</span><span class="hl-1">(</span><span class="hl-15">/</span><span class="hl-12">\\</span><span class="hl-15">/</span><span class="hl-7">g</span><span class="hl-1">, </span><span class="hl-2">&#39;</span><span class="hl-12">\\\\</span><span class="hl-2">&#39;</span><span class="hl-1">)</span><br/><span class="hl-1">  .</span><span class="hl-0">replace</span><span class="hl-1">(</span><span class="hl-15">/&quot;/</span><span class="hl-7">g</span><span class="hl-1">, </span><span class="hl-2">&#39;</span><span class="hl-12">\\</span><span class="hl-2">&quot;&#39;</span><span class="hl-1">);</span><br/><br/><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">escapedPrompt</span><span class="hl-1"> = </span><span class="hl-0">String</span><span class="hl-1">(</span><span class="hl-4">plainPrompt</span><span class="hl-1">)</span><br/><span class="hl-1">  .</span><span class="hl-0">replace</span><span class="hl-1">(</span><span class="hl-15">/</span><span class="hl-12">\\</span><span class="hl-15">/</span><span class="hl-7">g</span><span class="hl-1">, </span><span class="hl-2">&#39;</span><span class="hl-12">\\\\</span><span class="hl-2">&#39;</span><span class="hl-1">)</span><br/><span class="hl-1">  .</span><span class="hl-0">replace</span><span class="hl-1">(</span><span class="hl-15">/`/</span><span class="hl-7">g</span><span class="hl-1">, </span><span class="hl-2">&#39;</span><span class="hl-12">\\</span><span class="hl-2">`&#39;</span><span class="hl-1">)</span><br/><span class="hl-1">  .</span><span class="hl-0">replace</span><span class="hl-1">(</span><span class="hl-15">/</span><span class="hl-12">\$</span><span class="hl-15">/</span><span class="hl-7">g</span><span class="hl-1">, </span><span class="hl-2">&#39;</span><span class="hl-12">\\</span><span class="hl-2">$&#39;</span><span class="hl-1">);</span>
</code><button type="button">Copy</button></pre>

<p>This prevents malicious input in:</p>
<ul>
<li>Optimizer names</li>
<li>Strategy names</li>
<li>Exchange names</li>
<li>Frame names</li>
<li>Strategy prompts</li>
<li>User messages</li>
</ul>
<a id="memory-efficiency-generator-pattern" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Memory Efficiency: Generator Pattern<a href="#memory-efficiency-generator-pattern" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>While optimizer doesn't use generators (returns complete code), it processes data incrementally:</p>
<ul>
<li>Fetches sources one at a time</li>
<li>Builds conversation incrementally</li>
<li>Emits progress events during processing</li>
<li>Doesn't load all training data into memory simultaneously</li>
</ul>
<a id="memoization-client-caching" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Memoization: Client Caching<a href="#memoization-client-caching" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><code>OptimizerConnectionService.getOptimizer()</code> is memoized by <code>optimizerName</code>:</p>
<pre><code class="typescript"><span class="hl-4">public</span><span class="hl-1"> </span><span class="hl-4">getOptimizer</span><span class="hl-1"> = </span><span class="hl-0">memoize</span><span class="hl-1">(</span><br/><span class="hl-1">  ([</span><span class="hl-4">optimizerName</span><span class="hl-1">]) </span><span class="hl-7">=&gt;</span><span class="hl-1"> </span><span class="hl-2">`</span><span class="hl-7">${</span><span class="hl-4">optimizerName</span><span class="hl-7">}</span><span class="hl-2">`</span><span class="hl-1">,</span><br/><span class="hl-1">  (</span><span class="hl-4">optimizerName</span><span class="hl-1">: </span><span class="hl-13">OptimizerName</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-5">// ... create ClientOptimizer instance</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">);</span>
</code><button type="button">Copy</button></pre>

<p>This ensures:</p>
<ul>
<li>One <code>ClientOptimizer</code> instance per optimizer</li>
<li>Template merging happens once</li>
<li>Repeated calls reuse same instance</li>
<li>Memory efficient for multiple operations on same optimizer</li>
</ul>
<a id="file-system-atomic-writes" class="tsd-anchor"></a><h3 class="tsd-anchor-link">File System: Atomic Writes<a href="#file-system-atomic-writes" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>The <code>dump()</code> method uses standard Node.js file system operations:</p>
<pre><code class="typescript"><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">dir</span><span class="hl-1"> = </span><span class="hl-0">join</span><span class="hl-1">(</span><span class="hl-4">process</span><span class="hl-1">.</span><span class="hl-0">cwd</span><span class="hl-1">(), </span><span class="hl-4">path</span><span class="hl-1">);</span><br/><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-0">mkdir</span><span class="hl-1">(</span><span class="hl-4">dir</span><span class="hl-1">, { </span><span class="hl-4">recursive:</span><span class="hl-1"> </span><span class="hl-7">true</span><span class="hl-1"> });</span><br/><br/><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">filename</span><span class="hl-1"> = </span><span class="hl-2">`</span><span class="hl-7">${</span><span class="hl-4">self</span><span class="hl-9">.</span><span class="hl-4">params</span><span class="hl-9">.</span><span class="hl-4">optimizerName</span><span class="hl-7">}</span><span class="hl-2">_</span><span class="hl-7">${</span><span class="hl-4">symbol</span><span class="hl-7">}</span><span class="hl-2">.mjs`</span><span class="hl-1">;</span><br/><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">filepath</span><span class="hl-1"> = </span><span class="hl-0">join</span><span class="hl-1">(</span><span class="hl-4">dir</span><span class="hl-1">, </span><span class="hl-4">filename</span><span class="hl-1">);</span><br/><br/><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-0">writeFile</span><span class="hl-1">(</span><span class="hl-4">filepath</span><span class="hl-1">, </span><span class="hl-4">report</span><span class="hl-1">, </span><span class="hl-2">&quot;utf-8&quot;</span><span class="hl-1">);</span>
</code><button type="button">Copy</button></pre>

<p>While not truly atomic, it:</p>
<ul>
<li>Creates directories recursively</li>
<li>Writes complete file in single operation</li>
<li>Uses UTF-8 encoding for cross-platform compatibility</li>
<li>Logs errors for debugging</li>
</ul>
<hr>
<a id="related-documentation" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Related Documentation<a href="#related-documentation" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><ul>
<li>For executing the generated code, see <a href="design_19_walker-mode.html">Walker Mode</a></li>
<li>For backtest execution mechanics, see <a href="design_17_backtest-mode.html">Backtest Mode</a></li>
<li>For strategy definition patterns, see <a href="design_12_defining-strategies.html">Defining Strategies</a></li>
<li>For data fetching and VWAP calculation, see <a href="design_22_exchange-configuration.html">Exchange Configuration</a></li>
<li>For event system usage, see <a href="design_05_event-driven-architecture.html">Event-Driven Architecture</a></li>
</ul>
</div></div><div class="col-sidebar"><div class="page-menu"><div class="tsd-navigation settings"><details class="tsd-accordion"><summary class="tsd-accordion-summary"><h3><svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-chevronDown"></use></svg>Settings</h3></summary><div class="tsd-accordion-details"><div class="tsd-filter-visibility"><span class="settings-label">Member Visibility</span><ul id="tsd-filter-options"><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-protected" name="protected"/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Protected</span></label></li><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-inherited" name="inherited" checked/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Inherited</span></label></li><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-external" name="external"/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>External</span></label></li></ul></div><div class="tsd-theme-toggle"><label class="settings-label" for="tsd-theme">Theme</label><select id="tsd-theme"><option value="os">OS</option><option value="light">Light</option><option value="dark">Dark</option></select></div></div></details></div><details open class="tsd-accordion tsd-page-navigation"><summary class="tsd-accordion-summary"><h3><svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-chevronDown"></use></svg>On This Page</h3></summary><div class="tsd-accordion-details"><a href="#optimizer-mode"><span>Optimizer <wbr/>Mode</span></a><ul><li><a href="#overview"><span>Overview</span></a></li><li><a href="#optimizer-schema-registration"><span>Optimizer <wbr/>Schema <wbr/>Registration</span></a></li><li><ul><li><a href="#registration-api"><span>Registration API</span></a></li><li><a href="#schema-structure"><span>Schema <wbr/>Structure</span></a></li><li><a href="#data-source-requirements"><span>Data <wbr/>Source <wbr/>Requirements</span></a></li></ul></li><li><a href="#system-architecture"><span>System <wbr/>Architecture</span></a></li><li><a href="#data-collection-and-processing"><span>Data <wbr/>Collection and <wbr/>Processing</span></a></li><li><ul><li><a href="#data-flow-diagram"><span>Data <wbr/>Flow <wbr/>Diagram</span></a></li><li><a href="#pagination-and-deduplication"><span>Pagination and <wbr/>Deduplication</span></a></li><li><a href="#conversation-building"><span>Conversation <wbr/>Building</span></a></li></ul></li><li><a href="#template-system"><span>Template <wbr/>System</span></a></li><li><ul><li><a href="#template-interface"><span>Template <wbr/>Interface</span></a></li><li><a href="#template-merging-process"><span>Template <wbr/>Merging <wbr/>Process</span></a></li><li><a href="#default-template-implementations"><span>Default <wbr/>Template <wbr/>Implementations</span></a></li><li><a href="#strategy-template-example"><span>Strategy <wbr/>Template <wbr/>Example</span></a></li></ul></li><li><a href="#code-generation-process"><span>Code <wbr/>Generation <wbr/>Process</span></a></li><li><ul><li><a href="#code-assembly-flow"><span>Code <wbr/>Assembly <wbr/>Flow</span></a></li><li><a href="#naming-convention"><span>Naming <wbr/>Convention</span></a></li><li><a href="#generated-code-structure"><span>Generated <wbr/>Code <wbr/>Structure</span></a></li></ul></li><li><a href="#public-api-methods"><span>Public API <wbr/>Methods</span></a></li><li><ul><li><a href="#optimizergetdata"><span>Optimizer.get<wbr/>Data()</span></a></li><li><a href="#optimizergetcode"><span>Optimizer.get<wbr/>Code()</span></a></li><li><a href="#optimizerdump"><span>Optimizer.dump()</span></a></li></ul></li><li><a href="#progress-monitoring"><span>Progress <wbr/>Monitoring</span></a></li><li><ul><li><a href="#progress-event-structure"><span>Progress <wbr/>Event <wbr/>Structure</span></a></li><li><a href="#listening-to-progress"><span>Listening to <wbr/>Progress</span></a></li><li><a href="#event-flow-diagram"><span>Event <wbr/>Flow <wbr/>Diagram</span></a></li></ul></li><li><a href="#demo-application-example"><span>Demo <wbr/>Application <wbr/>Example</span></a></li><li><ul><li><a href="#configuration"><span>Configuration</span></a></li><li><a href="#integration-with-ccxt-dumper"><span>Integration with CCXT <wbr/>Dumper</span></a></li><li><a href="#prompt-generation"><span>Prompt <wbr/>Generation</span></a></li><li><a href="#execution"><span>Execution</span></a></li></ul></li><li><a href="#key-implementation-details"><span>Key <wbr/>Implementation <wbr/>Details</span></a></li><li><ul><li><a href="#security-string-escaping"><span>Security: <wbr/>String <wbr/>Escaping</span></a></li><li><a href="#memory-efficiency-generator-pattern"><span>Memory <wbr/>Efficiency: <wbr/>Generator <wbr/>Pattern</span></a></li><li><a href="#memoization-client-caching"><span>Memoization: <wbr/>Client <wbr/>Caching</span></a></li><li><a href="#file-system-atomic-writes"><span>File <wbr/>System: <wbr/>Atomic <wbr/>Writes</span></a></li></ul></li><li><a href="#related-documentation"><span>Related <wbr/>Documentation</span></a></li></ul></div></details></div><div class="site-menu"><nav class="tsd-navigation"><a href="../modules.html">backtest-kit</a><ul class="tsd-small-nested-navigation" id="tsd-nav-container"><li>Loading...</li></ul></nav></div></div></div><footer><p class="tsd-generator">Generated using <a href="https://typedoc.org/" target="_blank">TypeDoc</a></p></footer><div class="overlay"></div></body></html>

<!-- Yandex.Metrika counter -->
<script type="text/javascript">
    (function(m,e,t,r,i,k,a){
        m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
        m[i].l=1*new Date();
        for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }}
        k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)
    })(window, document,'script','https://mc.yandex.ru/metrika/tag.js?id=105455585', 'ym');

    ym(105455585, 'init', {ssr:true, webvisor:true, clickmap:true, ecommerce:"dataLayer", accurateTrackBounce:true, trackLinks:true});
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/105455585" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
<!-- /Yandex.Metrika counter -->

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-3MQZEBBDDR"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-3MQZEBBDDR');
</script>
