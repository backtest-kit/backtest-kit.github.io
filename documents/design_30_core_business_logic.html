<!DOCTYPE html><html class="default" lang="en" data-base=".."><head><meta charset="utf-8"/><meta http-equiv="x-ua-compatible" content="IE=edge"/><title>design/30_core_business_logic | backtest-kit</title><meta name="description" content="Documentation for backtest-kit"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="stylesheet" href="../assets/style.css"/><link rel="stylesheet" href="../assets/highlight.css"/><script defer src="../assets/main.js"></script><script async src="../assets/icons.js" id="tsd-icons-script"></script><script async src="../assets/search.js" id="tsd-search-script"></script><script async src="../assets/navigation.js" id="tsd-nav-script"></script><script async src="../assets/hierarchy.js" id="tsd-hierarchy-script"></script></head><body><script>document.documentElement.dataset.theme = localStorage.getItem("tsd-theme") || "os";document.body.style.display="none";setTimeout(() => app?app.showPage():document.body.style.removeProperty("display"),500)</script><header class="tsd-page-toolbar"><div class="tsd-toolbar-contents container"><div class="table-cell" id="tsd-search"><div class="field"><label for="tsd-search-field" class="tsd-widget tsd-toolbar-icon search no-caption"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-search"></use></svg></label><input type="text" id="tsd-search-field" aria-label="Search"/></div><div class="field"><div id="tsd-toolbar-links"></div></div><ul class="results"><li class="state loading">Preparing search index...</li><li class="state failure">The search index is not available</li></ul><a href="../index.html" class="title">backtest-kit</a></div><div class="table-cell" id="tsd-widgets"><a href="#" class="tsd-widget tsd-toolbar-icon menu no-caption" data-toggle="menu" aria-label="Menu"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-menu"></use></svg></a></div></div></header><div class="container container-main"><div class="col-content"><div class="tsd-page-title"><ul class="tsd-breadcrumb"><li><a href="../modules.html">backtest-kit</a></li><li><a href="design_30_core_business_logic.html">design/30_core_business_logic</a></li></ul></div><div class="tsd-panel tsd-typography"><a id="core-business-logic" class="tsd-anchor"></a><h1 class="tsd-anchor-link">Core Business Logic<a href="#core-business-logic" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h1><a id="purpose-and-scope" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Purpose and Scope<a href="#purpose-and-scope" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>This document describes the Client classes layer, which implements core business logic for signal management, market data, risk validation, and timeframe generation. Client classes are pure TypeScript classes without dependency injection, designed for memory efficiency and testability. They represent the innermost layer of the framework's architecture, containing algorithmic logic isolated from infrastructure concerns.</p>
<p>For information about the service layer that wraps these client classes, see <a href="design_36_service_layer.html">Service Layer</a>. For details on dependency injection and context propagation, see <a href="design_09_architecture.html">Architecture</a>.</p>
<a id="client-layer-architecture" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Client Layer Architecture<a href="#client-layer-architecture" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>Client classes form Layer 4 in the framework's six-layer architecture. They implement business rules and algorithms without any dependency on the DI container, making them independently testable and memory-efficient through prototype methods.</p>
<p><img src="../media/30_Core_Business_Logic_0.svg" alt="Mermaid Diagram"></p>
<a id="client-classes-overview" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Client Classes Overview<a href="#client-classes-overview" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>The framework provides five client classes, each responsible for a specific domain of business logic:</p>
<table>
<thead>
<tr>
<th>Client Class</th>
<th>File Location</th>
<th>Primary Responsibility</th>
<th>Key Methods</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>ClientStrategy</code></td>
<td><a href="">src/client/ClientStrategy.ts</a></td>
<td>Signal lifecycle management, TP/SL monitoring, backtest fast-forward</td>
<td><code>tick()</code>, <code>backtest()</code>, <code>waitForInit()</code>, <code>stop()</code></td>
</tr>
<tr>
<td><code>ClientExchange</code></td>
<td><a href="">src/client/ClientExchange.ts</a></td>
<td>Market data fetching, VWAP calculation, price/quantity formatting</td>
<td><code>getCandles()</code>, <code>getAveragePrice()</code>, <code>formatPrice()</code>, <code>formatQuantity()</code></td>
</tr>
<tr>
<td><code>ClientRisk</code></td>
<td><a href="">src/client/ClientRisk.ts</a></td>
<td>Portfolio position tracking, custom risk validations, concurrent limits</td>
<td><code>checkSignal()</code>, <code>addSignal()</code>, <code>removeSignal()</code></td>
</tr>
<tr>
<td><code>ClientFrame</code></td>
<td><a href="">src/client/ClientFrame.ts</a></td>
<td>Timeframe generation for backtesting, interval-based timestamp arrays</td>
<td><code>getTimeframe()</code></td>
</tr>
<tr>
<td><code>ClientSizing</code></td>
<td><a href="">src/client/ClientSizing.ts</a></td>
<td>Position size calculation using fixed, Kelly, or ATR methods</td>
<td><code>calculateSize()</code></td>
</tr>
</tbody>
</table>
<a id="design-principles" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Design Principles<a href="#design-principles" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><a id="no-dependency-injection" class="tsd-anchor"></a><h3 class="tsd-anchor-link">No Dependency Injection<a href="#no-dependency-injection" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Client classes receive all dependencies through constructor parameters, avoiding framework-level dependency injection:</p>
<p><img src="../media/30_Core_Business_Logic_1.svg" alt="Mermaid Diagram"></p>
<p>This design allows client classes to be instantiated and tested independently without the DI container. Constructor parameters are plain objects conforming to interfaces like <code>IStrategyParams</code>.</p>
<a id="prototype-methods-for-memory-efficiency" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Prototype Methods for Memory Efficiency<a href="#prototype-methods-for-memory-efficiency" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Client classes use prototype methods instead of arrow functions to avoid creating new function instances for each object:</p>
<pre><code class="typescript"><span class="hl-5">// Prototype method (efficient - shared across instances)</span><br/><span class="hl-6">class</span><span class="hl-1"> </span><span class="hl-10">ClientStrategy</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-6">public</span><span class="hl-1"> </span><span class="hl-0">tick</span><span class="hl-1"> = </span><span class="hl-6">async</span><span class="hl-1"> (): </span><span class="hl-10">Promise</span><span class="hl-1">&lt;</span><span class="hl-10">IStrategyTickResult</span><span class="hl-1">&gt; </span><span class="hl-6">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-5">// Method implementation</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">}</span><br/><br/><span class="hl-5">// Arrow function property (inefficient - new function per instance)</span><br/><span class="hl-6">class</span><span class="hl-1"> </span><span class="hl-10">ClientStrategy</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-6">public</span><span class="hl-1"> </span><span class="hl-0">tick</span><span class="hl-1"> = </span><span class="hl-6">async</span><span class="hl-1"> (): </span><span class="hl-10">Promise</span><span class="hl-1">&lt;</span><span class="hl-10">IStrategyTickResult</span><span class="hl-1">&gt; </span><span class="hl-6">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-5">// Method implementation</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<p>All Client classes follow the prototype method pattern, ensuring that multiple instances share the same method implementations in memory.</p>
<a id="private-helper-functions" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Private Helper Functions<a href="#private-helper-functions" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Client classes extensively use module-level private functions prefixed with uppercase names (e.g., <code>GET_SIGNAL_FN</code>, <code>VALIDATE_SIGNAL_FN</code>) instead of class methods. This pattern:</p>
<ol>
<li>Keeps the class interface clean with only public methods</li>
<li>Prevents accidental access to internal implementation details</li>
<li>Allows helper functions to be unit tested independently</li>
<li>Reduces memory overhead by sharing functions across all instances</li>
</ol>
<p><img src="../media/30_Core_Business_Logic_2.svg" alt="Mermaid Diagram"></p>
<p><strong>Example private function pattern:</strong></p>
<p><a href="">src/client/ClientStrategy.ts:40-185</a> defines <code>VALIDATE_SIGNAL_FN</code> as a module-level constant function that validates signal prices, TP/SL relationships, and time parameters. This function is called by <code>GET_SIGNAL_FN</code> at <a href="">src/client/ClientStrategy.ts:251</a> and <a href="">src/client/ClientStrategy.ts:269</a>.</p>
<a id="connection-service-instantiation" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Connection Service Instantiation<a href="#connection-service-instantiation" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>Connection Services act as factories that create and memoize Client class instances. The memoization pattern ensures one client instance per schema name:</p>
<p><img src="../media/30_Core_Business_Logic_3.svg" alt="Mermaid Diagram"></p>
<p>The memoization key is the schema name string (e.g., <code>strategyName</code>, <code>exchangeName</code>), ensuring that multiple calls with the same name reuse the same client instance.</p>
<a id="instance-lifecycle-management" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Instance Lifecycle Management<a href="#instance-lifecycle-management" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>Client instances persist for the duration of the application process and maintain internal state across multiple operations:</p>
<table>
<thead>
<tr>
<th>Lifecycle Phase</th>
<th>Description</th>
<th>Relevant Methods</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Instantiation</strong></td>
<td>Connection Service creates instance via <code>new ClientClass(params)</code> with schema configuration</td>
<td>Constructor</td>
</tr>
<tr>
<td><strong>Initialization</strong></td>
<td>One-time setup operations (e.g., loading persisted state)</td>
<td><code>waitForInit()</code> for ClientStrategy</td>
</tr>
<tr>
<td><strong>Active Use</strong></td>
<td>Repeated method calls for core operations (tick, backtest, checkSignal)</td>
<td><code>tick()</code>, <code>backtest()</code>, <code>checkSignal()</code>, etc.</td>
</tr>
<tr>
<td><strong>State Management</strong></td>
<td>Internal state tracked across calls (e.g., <code>_pendingSignal</code>, <code>_activePositions</code>)</td>
<td>Private instance variables</td>
</tr>
<tr>
<td><strong>Cleanup</strong></td>
<td>Graceful shutdown and resource release</td>
<td><code>stop()</code> for ClientStrategy, <code>clear()</code> for Connection Services</td>
</tr>
</tbody>
</table>
<p><strong>Example state tracking in ClientStrategy:</strong></p>
<p><a href="">src/client/ClientStrategy.ts:1247-1255</a> shows the class constructor initializing state variables:</p>
<ul>
<li><code>_pendingSignal</code>: Currently active signal being monitored</li>
<li><code>_scheduledSignal</code>: Signal waiting for price activation</li>
<li><code>_lastSignalTimestamp</code>: Interval throttling timestamp</li>
<li><code>_isStopped</code>: Graceful shutdown flag</li>
</ul>
<a id="client-dependencies-and-collaboration" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Client Dependencies and Collaboration<a href="#client-dependencies-and-collaboration" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>Client classes collaborate through dependency references passed in constructor parameters, forming a dependency graph:</p>
<p><img src="../media/30_Core_Business_Logic_4.svg" alt="Mermaid Diagram"></p>
<p><strong>Key collaboration patterns:</strong></p>
<ol>
<li>
<p><strong>ClientStrategy → ClientExchange</strong>: Fetches VWAP prices via <code>getAveragePrice()</code> and historical candles via <code>getCandles()</code> at <a href="">src/client/ClientStrategy.ts:209-211</a></p>
</li>
<li>
<p><strong>ClientStrategy → ClientRisk</strong>: Validates signals via <code>checkSignal()</code> at <a href="">src/client/ClientStrategy.ts:214-224</a>, adds positions via <code>addSignal()</code> at <a href="">src/client/ClientStrategy.ts:519-523</a>, removes positions via <code>removeSignal()</code> at <a href="">src/client/ClientStrategy.ts:761-764</a></p>
</li>
<li>
<p><strong>Context Services</strong>: All clients access <code>execution.context.symbol</code>, <code>execution.context.when</code>, <code>execution.context.backtest</code>, and <code>method.context.strategyName</code> to determine runtime behavior</p>
</li>
</ol>
<a id="summary" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Summary<a href="#summary" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>Client classes form the core algorithmic layer of the framework, implementing business logic without dependency injection for testability and memory efficiency. The five client classes (Strategy, Exchange, Risk, Frame, Sizing) are instantiated and memoized by Connection Services, maintaining state across operations while collaborating through interface references. This architectural separation enables the framework to keep business rules isolated from infrastructure concerns.</p>
<p>For detailed implementation documentation of individual client classes, see:</p>
<ul>
<li><a href="design_31_clientstrategy.html">ClientStrategy</a> - Signal lifecycle and monitoring</li>
<li><a href="design_32_clientexchange.html">ClientExchange</a> - Market data and formatting</li>
<li><a href="design_33_clientframe.html">ClientFrame</a> - Timeframe generation</li>
<li><a href="design_34_clientrisk.html">ClientRisk</a> - Portfolio risk management</li>
<li><a href="design_35_clientsizing.html">ClientSizing</a> - Position sizing algorithms</li>
</ul>
</div></div><div class="col-sidebar"><div class="page-menu"><div class="tsd-navigation settings"><details class="tsd-accordion"><summary class="tsd-accordion-summary"><h3><svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-chevronDown"></use></svg>Settings</h3></summary><div class="tsd-accordion-details"><div class="tsd-filter-visibility"><span class="settings-label">Member Visibility</span><ul id="tsd-filter-options"><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-protected" name="protected"/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Protected</span></label></li><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-inherited" name="inherited" checked/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Inherited</span></label></li><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-external" name="external"/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>External</span></label></li></ul></div><div class="tsd-theme-toggle"><label class="settings-label" for="tsd-theme">Theme</label><select id="tsd-theme"><option value="os">OS</option><option value="light">Light</option><option value="dark">Dark</option></select></div></div></details></div><details open class="tsd-accordion tsd-page-navigation"><summary class="tsd-accordion-summary"><h3><svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-chevronDown"></use></svg>On This Page</h3></summary><div class="tsd-accordion-details"><a href="#core-business-logic"><span>Core <wbr/>Business <wbr/>Logic</span></a><ul><li><a href="#purpose-and-scope"><span>Purpose and <wbr/>Scope</span></a></li><li><a href="#client-layer-architecture"><span>Client <wbr/>Layer <wbr/>Architecture</span></a></li><li><a href="#client-classes-overview"><span>Client <wbr/>Classes <wbr/>Overview</span></a></li><li><a href="#design-principles"><span>Design <wbr/>Principles</span></a></li><li><ul><li><a href="#no-dependency-injection"><span>No <wbr/>Dependency <wbr/>Injection</span></a></li><li><a href="#prototype-methods-for-memory-efficiency"><span>Prototype <wbr/>Methods for <wbr/>Memory <wbr/>Efficiency</span></a></li><li><a href="#private-helper-functions"><span>Private <wbr/>Helper <wbr/>Functions</span></a></li></ul></li><li><a href="#connection-service-instantiation"><span>Connection <wbr/>Service <wbr/>Instantiation</span></a></li><li><a href="#instance-lifecycle-management"><span>Instance <wbr/>Lifecycle <wbr/>Management</span></a></li><li><a href="#client-dependencies-and-collaboration"><span>Client <wbr/>Dependencies and <wbr/>Collaboration</span></a></li><li><a href="#summary"><span>Summary</span></a></li></ul></div></details></div><div class="site-menu"><nav class="tsd-navigation"><a href="../modules.html">backtest-kit</a><ul class="tsd-small-nested-navigation" id="tsd-nav-container"><li>Loading...</li></ul></nav></div></div></div><footer><p class="tsd-generator">Generated using <a href="https://typedoc.org/" target="_blank">TypeDoc</a></p></footer><div class="overlay"></div></body></html>

<!-- Yandex.Metrika counter -->
<script type="text/javascript">
    (function(m,e,t,r,i,k,a){
        m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
        m[i].l=1*new Date();
        for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }}
        k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)
    })(window, document,'script','https://mc.yandex.ru/metrika/tag.js?id=105455585', 'ym');

    ym(105455585, 'init', {ssr:true, webvisor:true, clickmap:true, ecommerce:"dataLayer", accurateTrackBounce:true, trackLinks:true});
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/105455585" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
<!-- /Yandex.Metrika counter -->

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-3MQZEBBDDR"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-3MQZEBBDDR');
</script>
