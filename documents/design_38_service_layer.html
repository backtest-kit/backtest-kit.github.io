<!DOCTYPE html><html class="default" lang="en" data-base=".."><head><meta charset="utf-8"/><meta http-equiv="x-ua-compatible" content="IE=edge"/><title>design/38_service_layer | backtest-kit</title><meta name="description" content="Documentation for backtest-kit"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="stylesheet" href="../assets/style.css"/><link rel="stylesheet" href="../assets/highlight.css"/><script defer src="../assets/main.js"></script><script async src="../assets/icons.js" id="tsd-icons-script"></script><script async src="../assets/search.js" id="tsd-search-script"></script><script async src="../assets/navigation.js" id="tsd-nav-script"></script><script async src="../assets/hierarchy.js" id="tsd-hierarchy-script"></script></head><body><script>document.documentElement.dataset.theme = localStorage.getItem("tsd-theme") || "os";document.body.style.display="none";setTimeout(() => app?app.showPage():document.body.style.removeProperty("display"),500)</script><header class="tsd-page-toolbar"><div class="tsd-toolbar-contents container"><div class="table-cell" id="tsd-search"><div class="field"><label for="tsd-search-field" class="tsd-widget tsd-toolbar-icon search no-caption"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-search"></use></svg></label><input type="text" id="tsd-search-field" aria-label="Search"/></div><div class="field"><div id="tsd-toolbar-links"></div></div><ul class="results"><li class="state loading">Preparing search index...</li><li class="state failure">The search index is not available</li></ul><a href="../index.html" class="title">backtest-kit</a></div><div class="table-cell" id="tsd-widgets"><a href="#" class="tsd-widget tsd-toolbar-icon menu no-caption" data-toggle="menu" aria-label="Menu"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-menu"></use></svg></a></div></div></header><div class="container container-main"><div class="col-content"><div class="tsd-page-title"><ul class="tsd-breadcrumb"><li><a href="../modules.html">backtest-kit</a></li><li><a href="design_38_service_layer.html">design/38_service_layer</a></li></ul></div><div class="tsd-panel tsd-typography"><a id="service-layer" class="tsd-anchor"></a><h1 class="tsd-anchor-link">Service Layer<a href="#service-layer" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h1><p>The Service Layer provides the orchestration infrastructure that coordinates business logic execution across the framework. It implements a layered architecture where ~60 services are organized into functional categories, each handling a specific aspect of system operation: connection management, schema registration, validation, context injection, execution logic, and reporting. Services communicate through dependency injection, with the <code>backtest</code> aggregation object providing a unified namespace for all service access.</p>
<p>For information about the core business logic classes (<code>ClientStrategy</code>, <code>ClientExchange</code>, etc.) that services orchestrate, see <a href="design_46_signal_lifecycle.html">Core Business Logic</a>. For dependency injection implementation details, see <a href="design_11_dependency_injection_system.html">Dependency Injection System</a>.</p>
<a id="service-organization" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Service Organization<a href="#service-organization" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>Services follow a matrix organization pattern where most component types (Strategy, Exchange, Frame, Risk, Sizing) have corresponding service variants across multiple functional categories. This creates a predictable structure where finding a service for a specific component and function is straightforward.</p>
<p>The service matrix spans two dimensions:</p>
<table>
<thead>
<tr>
<th>Component Type</th>
<th>Connection</th>
<th>Schema</th>
<th>Global</th>
<th>Validation</th>
<th>Markdown</th>
</tr>
</thead>
<tbody>
<tr>
<td>Strategy</td>
<td>StrategyConnectionService</td>
<td>StrategySchemaService</td>
<td>StrategyGlobalService</td>
<td>StrategyValidationService</td>
<td>-</td>
</tr>
<tr>
<td>Exchange</td>
<td>ExchangeConnectionService</td>
<td>ExchangeSchemaService</td>
<td>ExchangeGlobalService</td>
<td>ExchangeValidationService</td>
<td>-</td>
</tr>
<tr>
<td>Frame</td>
<td>FrameConnectionService</td>
<td>FrameSchemaService</td>
<td>FrameGlobalService</td>
<td>FrameValidationService</td>
<td>-</td>
</tr>
<tr>
<td>Risk</td>
<td>RiskConnectionService</td>
<td>RiskSchemaService</td>
<td>RiskGlobalService</td>
<td>RiskValidationService</td>
<td>-</td>
</tr>
<tr>
<td>Sizing</td>
<td>SizingConnectionService</td>
<td>SizingSchemaService</td>
<td>SizingGlobalService</td>
<td>SizingValidationService</td>
<td>-</td>
</tr>
<tr>
<td>Walker</td>
<td>-</td>
<td>WalkerSchemaService</td>
<td>-</td>
<td>WalkerValidationService</td>
<td>WalkerMarkdownService</td>
</tr>
<tr>
<td>Optimizer</td>
<td>OptimizerConnectionService</td>
<td>OptimizerSchemaService</td>
<td>OptimizerGlobalService</td>
<td>OptimizerValidationService</td>
<td>-</td>
</tr>
<tr>
<td>Partial</td>
<td>PartialConnectionService</td>
<td>-</td>
<td>PartialGlobalService</td>
<td>-</td>
<td>PartialMarkdownService</td>
</tr>
</tbody>
</table>
<p>Additional service categories exist for execution modes:</p>
<ul>
<li><strong>Command Services</strong>: BacktestCommandService, LiveCommandService, WalkerCommandService</li>
<li><strong>Logic Services</strong>: BacktestLogicPrivateService, BacktestLogicPublicService, LiveLogicPrivateService, LiveLogicPublicService, WalkerLogicPrivateService, WalkerLogicPublicService</li>
<li><strong>Markdown Services</strong>: BacktestMarkdownService, LiveMarkdownService, ScheduleMarkdownService, PerformanceMarkdownService, HeatMarkdownService</li>
<li><strong>Context Services</strong>: ExecutionContextService, MethodContextService</li>
<li><strong>Template Services</strong>: OptimizerTemplateService</li>
</ul>
<a id="service-categories" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Service Categories<a href="#service-categories" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p><img src="../media/38_Service_Layer_0.svg" alt="Mermaid Diagram"></p>
<a id="connection-services" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Connection Services<a href="#connection-services" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Connection Services manage memoized instances of Client* business logic classes. Each service caches instances by a key derived from execution parameters (e.g., <code>symbol:strategyName</code> for strategies). The <code>getStrategy</code>, <code>getExchange</code>, <code>getRisk</code> methods use <code>memoize</code> from <code>functools-kit</code> to ensure only one instance exists per unique parameter combination.</p>
<p><strong>Key Methods:</strong></p>
<ul>
<li><strong>StrategyConnectionService</strong>: <code>tick()</code>, <code>backtest()</code>, <code>stop()</code>, <code>clear()</code>, <code>getPendingSignal()</code></li>
<li><strong>ExchangeConnectionService</strong>: <code>getCandles()</code>, <code>getNextCandles()</code>, <code>getAveragePrice()</code>, <code>formatPrice()</code>, <code>formatQuantity()</code></li>
<li><strong>RiskConnectionService</strong>: <code>getRisk()</code> returns memoized <code>ClientRisk</code> interface</li>
<li><strong>SizingConnectionService</strong>: <code>getSizing()</code> returns memoized <code>ClientSizing</code> interface</li>
</ul>
<p>These services ensure consistent instance routing - multiple calls with the same parameters return the same cached instance, preserving internal state like signal history and initialization promises.</p>
<a id="schema-services" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Schema Services<a href="#schema-services" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Schema Services maintain registries mapping component names to their configuration schemas. Each service exposes <code>register(name, schema)</code> to add entries and <code>get(name)</code> to retrieve them. The registries are Map-based stores that persist for the application lifetime.</p>
<p><strong>Example:</strong></p>
<pre><code class="typescript"><span class="hl-5">// Internal storage</span><br/><span class="hl-4">private</span><span class="hl-1"> </span><span class="hl-4">schemaMap</span><span class="hl-1"> = </span><span class="hl-7">new</span><span class="hl-1"> </span><span class="hl-0">Map</span><span class="hl-1">&lt;</span><span class="hl-13">StrategyName</span><span class="hl-1">, </span><span class="hl-13">IStrategySchema</span><span class="hl-1">&gt;()</span><br/><br/><span class="hl-5">// Registration</span><br/><span class="hl-4">strategySchemaService</span><span class="hl-1">.</span><span class="hl-0">register</span><span class="hl-1">(</span><span class="hl-2">&quot;my-strategy&quot;</span><span class="hl-1">, {</span><br/><span class="hl-1">  </span><span class="hl-4">strategyName:</span><span class="hl-1"> </span><span class="hl-2">&quot;my-strategy&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">interval:</span><span class="hl-1"> </span><span class="hl-2">&quot;5m&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-0">getSignal</span><span class="hl-4">:</span><span class="hl-1"> </span><span class="hl-7">async</span><span class="hl-1"> (</span><span class="hl-4">symbol</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> { </span><span class="hl-5">/* ... */</span><span class="hl-1"> }</span><br/><span class="hl-1">})</span><br/><br/><span class="hl-5">// Retrieval</span><br/><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">schema</span><span class="hl-1"> = </span><span class="hl-4">strategySchemaService</span><span class="hl-1">.</span><span class="hl-0">get</span><span class="hl-1">(</span><span class="hl-2">&quot;my-strategy&quot;</span><span class="hl-1">)</span>
</code><button type="button">Copy</button></pre>

<p>These services are queried by Connection Services during instance creation to retrieve configuration data.</p>
<a id="global-services" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Global Services<a href="#global-services" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Global Services wrap Connection Services with context injection via <code>ExecutionContextService</code>. They call <code>ExecutionContextService.runInContext()</code> to set the <code>symbol</code>, <code>when</code>, and <code>backtest</code> parameters before delegating to Connection Services. This pattern enables implicit parameter passing without requiring these values to be passed through every function call.</p>
<p><strong>Flow:</strong></p>
<pre><code><span class="hl-4">StrategyGlobalService</span><span class="hl-1">.</span><span class="hl-0">tick</span><span class="hl-1">(</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">when</span><span class="hl-1">, </span><span class="hl-4">backtest</span><span class="hl-1">)</span><br/><span class="hl-1">  → </span><span class="hl-4">ExecutionContextService</span><span class="hl-1">.</span><span class="hl-0">runInContext</span><span class="hl-1">({ </span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">when</span><span class="hl-1">, </span><span class="hl-4">backtest</span><span class="hl-1"> })</span><br/><span class="hl-1">    → </span><span class="hl-4">StrategyConnectionService</span><span class="hl-1">.</span><span class="hl-0">tick</span><span class="hl-1">(</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">strategyName</span><span class="hl-1">)</span><br/><span class="hl-1">      → </span><span class="hl-4">ClientStrategy</span><span class="hl-1">.</span><span class="hl-0">tick</span><span class="hl-1">() [</span><span class="hl-4">reads</span><span class="hl-1"> </span><span class="hl-4">context</span><span class="hl-1"> </span><span class="hl-4">implicitly</span><span class="hl-1">]</span>
</code><button>Copy</button></pre>

<p>Global Services also call Validation Services to verify component registration before operations.</p>
<a id="validation-services" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Validation Services<a href="#validation-services" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Validation Services implement two validation layers:</p>
<ol>
<li><strong>Registration Validation</strong> (<code>addStrategy</code>, <code>addExchange</code>, etc.): Called by <code>add.ts</code> functions to verify schema correctness before registration</li>
<li><strong>Usage Validation</strong> (<code>validate</code>): Called by Global Services or Command Services before operations to verify component exists</li>
</ol>
<p><strong>StrategyValidationService</strong> implements 30+ signal validation rules checked during strategy execution:</p>
<ul>
<li>Price logic (TP must be above entry for long, SL must be below)</li>
<li>NaN/Infinity checks on all numeric fields</li>
<li>Price anomaly detection (unrealistic values)</li>
<li>Timestamp validity</li>
<li>Position type validation</li>
</ul>
<a id="command-services" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Command Services<a href="#command-services" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Command Services provide the top-level entry points for execution modes. They perform validation, inject context, and delegate to Logic Services.</p>
<p><strong>Responsibilities:</strong></p>
<ul>
<li>Validate all components exist (strategy, exchange, frame)</li>
<li>Set MethodContextService with component names</li>
<li>Delegate to LogicPublicService</li>
<li>Return AsyncGenerator for result streaming</li>
</ul>
<a id="logic-services" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Logic Services<a href="#logic-services" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Logic Services implement execution mode algorithms through a two-tier architecture:</p>
<ul>
<li><strong>Public Services</strong> (<code>BacktestLogicPublicService</code>, etc.): External contract that validates parameters and delegates to Private</li>
<li><strong>Private Services</strong> (<code>BacktestLogicPrivateService</code>, etc.): Internal implementation with core execution logic</li>
</ul>
<p>This separation enables Private Services to call other Private Services without re-validation while maintaining a clean public API.</p>
<p><strong>Execution Patterns:</strong></p>
<ul>
<li><strong>BacktestLogicPrivateService</strong>: Iterates timeframes, calls <code>tick()</code>, skips ahead on signal open</li>
<li><strong>LiveLogicPrivateService</strong>: Infinite <code>while(true)</code> loop with <code>sleep(TICK_TTL)</code>, persistence recovery</li>
<li><strong>WalkerLogicPrivateService</strong>: Serial strategy iteration with metric comparison</li>
</ul>
<p>For detailed execution flows, see <a href="design_44_logic_services.html">Logic Services</a>.</p>
<a id="markdown-services" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Markdown Services<a href="#markdown-services" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Markdown Services accumulate events from execution and generate reports with statistics. They subscribe to event emitters (e.g., <code>signalBacktestEmitter</code>) and maintain internal arrays of events (limited to <code>MAX_EVENTS = 5000</code>).</p>
<p><strong>Methods:</strong></p>
<ul>
<li><code>getData(symbol, strategyName)</code>: Returns statistics object (sharpe ratio, win rate, etc.)</li>
<li><code>getReport(symbol, strategyName)</code>: Returns markdown formatted report string</li>
<li><code>dump(strategyName, path)</code>: Writes report to disk</li>
</ul>
<p><strong>Statistics Calculation:</strong></p>
<ul>
<li>Safe math layer with <code>isUnsafe()</code> checks for NaN/Infinity</li>
<li>Variance/standard deviation computation</li>
<li>Annualized metrics (Sharpe, returns)</li>
<li>Win rate, certainty ratio, expected yearly returns</li>
</ul>
<p>For detailed metrics, see <a href="design_71_performance_metrics.html">Performance Metrics</a>.</p>
<a id="template-services" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Template Services<a href="#template-services" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Template Services provide code generation templates for AI optimization. <code>OptimizerTemplateService</code> contains 11 template methods that generate different sections of the output script:</p>
<ul>
<li><code>getTopBanner()</code>: Imports and constants</li>
<li><code>getJsonDumpTemplate()</code>: Helper functions</li>
<li><code>getStrategyTemplate()</code>: Strategy configuration with LLM integration</li>
<li><code>getWalkerTemplate()</code>: Walker comparison setup</li>
<li><code>getLauncherTemplate()</code>: Execution code with event listeners</li>
</ul>
<p>For details on AI optimization, see <a href="design_87_ai-powered_strategy_optimization.html">AI-Powered Strategy Optimization</a>.</p>
<a id="service-registration-and-injection" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Service Registration and Injection<a href="#service-registration-and-injection" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p><img src="../media/38_Service_Layer_1.svg" alt="Mermaid Diagram"></p>
<p>The registration process follows three phases:</p>
<p><strong>Phase 1: Type Definition</strong> - <a href="">src/lib/core/types.ts:1-96</a> defines Symbol constants for each service. Symbols prevent naming collisions and enable type-safe lookups.</p>
<p><strong>Phase 2: Service Registration</strong> - <a href="">src/lib/core/provide.ts:1-132</a> calls <code>provide(type, factory)</code> for each service. Factory functions instantiate services with their dependencies injected via <code>inject&lt;T&gt;(type)</code>.</p>
<p><strong>Phase 3: Aggregation</strong> - <a href="">src/lib/index.ts:212-224</a> imports all services via <code>inject()</code> and aggregates them into the <code>backtest</code> object, creating a single-namespace API.</p>
<a id="the-backtest-aggregation-object" class="tsd-anchor"></a><h2 class="tsd-anchor-link">The Backtest Aggregation Object<a href="#the-backtest-aggregation-object" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>The <code>backtest</code> object exported from <a href="">src/lib/index.ts:212-224</a> flattens the service hierarchy into a single namespace. This provides convenient access to any service without needing to understand the dependency graph:</p>
<pre><code class="typescript"><span class="hl-5">// Internal organization</span><br/><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">baseServices</span><span class="hl-1"> = {</span><br/><span class="hl-1">  </span><span class="hl-4">loggerService:</span><span class="hl-1"> </span><span class="hl-0">inject</span><span class="hl-1">&lt;</span><span class="hl-13">LoggerService</span><span class="hl-1">&gt;(</span><span class="hl-8">TYPES</span><span class="hl-1">.</span><span class="hl-4">loggerService</span><span class="hl-1">),</span><br/><span class="hl-1">}</span><br/><br/><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">connectionServices</span><span class="hl-1"> = {</span><br/><span class="hl-1">  </span><span class="hl-4">strategyConnectionService:</span><span class="hl-1"> </span><span class="hl-0">inject</span><span class="hl-1">&lt;</span><span class="hl-13">StrategyConnectionService</span><span class="hl-1">&gt;(</span><span class="hl-8">TYPES</span><span class="hl-1">.</span><span class="hl-4">strategyConnectionService</span><span class="hl-1">),</span><br/><span class="hl-1">  </span><span class="hl-4">exchangeConnectionService:</span><span class="hl-1"> </span><span class="hl-0">inject</span><span class="hl-1">&lt;</span><span class="hl-13">ExchangeConnectionService</span><span class="hl-1">&gt;(</span><span class="hl-8">TYPES</span><span class="hl-1">.</span><span class="hl-4">exchangeConnectionService</span><span class="hl-1">),</span><br/><span class="hl-1">  </span><span class="hl-5">// ... 5 more</span><br/><span class="hl-1">}</span><br/><br/><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">schemaServices</span><span class="hl-1"> = {</span><br/><span class="hl-1">  </span><span class="hl-4">strategySchemaService:</span><span class="hl-1"> </span><span class="hl-0">inject</span><span class="hl-1">&lt;</span><span class="hl-13">StrategySchemaService</span><span class="hl-1">&gt;(</span><span class="hl-8">TYPES</span><span class="hl-1">.</span><span class="hl-4">strategySchemaService</span><span class="hl-1">),</span><br/><span class="hl-1">  </span><span class="hl-4">exchangeSchemaService:</span><span class="hl-1"> </span><span class="hl-0">inject</span><span class="hl-1">&lt;</span><span class="hl-13">ExchangeSchemaService</span><span class="hl-1">&gt;(</span><span class="hl-8">TYPES</span><span class="hl-1">.</span><span class="hl-4">exchangeSchemaService</span><span class="hl-1">),</span><br/><span class="hl-1">  </span><span class="hl-5">// ... 5 more</span><br/><span class="hl-1">}</span><br/><br/><span class="hl-5">// ... 7 more categories</span><br/><br/><span class="hl-3">export</span><span class="hl-1"> </span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">backtest</span><span class="hl-1"> = {</span><br/><span class="hl-1">  ...</span><span class="hl-4">baseServices</span><span class="hl-1">,</span><br/><span class="hl-1">  ...</span><span class="hl-4">contextServices</span><span class="hl-1">,</span><br/><span class="hl-1">  ...</span><span class="hl-4">connectionServices</span><span class="hl-1">,</span><br/><span class="hl-1">  ...</span><span class="hl-4">schemaServices</span><span class="hl-1">,</span><br/><span class="hl-1">  ...</span><span class="hl-4">globalServices</span><span class="hl-1">,</span><br/><span class="hl-1">  ...</span><span class="hl-4">commandServices</span><span class="hl-1">,</span><br/><span class="hl-1">  ...</span><span class="hl-4">logicPrivateServices</span><span class="hl-1">,</span><br/><span class="hl-1">  ...</span><span class="hl-4">logicPublicServices</span><span class="hl-1">,</span><br/><span class="hl-1">  ...</span><span class="hl-4">markdownServices</span><span class="hl-1">,</span><br/><span class="hl-1">  ...</span><span class="hl-4">validationServices</span><span class="hl-1">,</span><br/><span class="hl-1">  ...</span><span class="hl-4">templateServices</span><span class="hl-1">,</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<p>This enables direct service access:</p>
<pre><code class="typescript"><span class="hl-3">import</span><span class="hl-1"> </span><span class="hl-4">backtest</span><span class="hl-1"> </span><span class="hl-3">from</span><span class="hl-1"> </span><span class="hl-2">&quot;./lib&quot;</span><br/><br/><span class="hl-5">// Access any service directly</span><br/><span class="hl-4">backtest</span><span class="hl-1">.</span><span class="hl-4">loggerService</span><span class="hl-1">.</span><span class="hl-0">info</span><span class="hl-1">(</span><span class="hl-2">&quot;message&quot;</span><span class="hl-1">, </span><span class="hl-4">data</span><span class="hl-1">)</span><br/><span class="hl-4">backtest</span><span class="hl-1">.</span><span class="hl-4">strategySchemaService</span><span class="hl-1">.</span><span class="hl-0">get</span><span class="hl-1">(</span><span class="hl-2">&quot;my-strategy&quot;</span><span class="hl-1">)</span><br/><span class="hl-4">backtest</span><span class="hl-1">.</span><span class="hl-4">backtestCommandService</span><span class="hl-1">.</span><span class="hl-0">run</span><span class="hl-1">(</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">context</span><span class="hl-1">)</span>
</code><button type="button">Copy</button></pre>

<p>The Backtest, Live, and Walker utility classes (<a href="">src/classes/Backtest.ts</a>, <a href="">src/classes/Live.ts</a>, <a href="">src/classes/Walker.ts</a>) use this object internally to access services.</p>
<a id="service-interaction-patterns" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Service Interaction Patterns<a href="#service-interaction-patterns" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>Services follow a strict layering pattern to prevent circular dependencies:</p>
<p><img src="../media/38_Service_Layer_2.svg" alt="Mermaid Diagram"></p>
<p><strong>Layering Rules:</strong></p>
<ol>
<li><strong>Base Services</strong> (Layer 1) have no dependencies on other services</li>
<li><strong>Schema Services</strong> (Layer 2) depend only on Base Services</li>
<li><strong>Validation Services</strong> (Layer 3) depend on Base + Schema</li>
<li><strong>Connection Services</strong> (Layer 4) depend on Base + Schema + other Connections (for composition)</li>
<li><strong>Global Services</strong> (Layer 5) depend on Connection + Validation + Context</li>
<li><strong>Command Services</strong> (Layer 6) depend on Global + Validation</li>
<li><strong>Logic Services</strong> (Layer 7) depend on Command + Global</li>
<li><strong>Markdown Services</strong> (Layer 8) depend on event emitters only (passive listeners)</li>
</ol>
<p>This layering ensures:</p>
<ul>
<li>No circular dependencies</li>
<li>Clear separation of concerns</li>
<li>Predictable initialization order</li>
<li>Easy testing (mock lower layers)</li>
</ul>
<p><strong>Example Dependency Chain:</strong></p>
<pre><code><span class="hl-4">User</span><span class="hl-1"> </span><span class="hl-4">calls</span><span class="hl-1"> </span><span class="hl-4">Backtest</span><span class="hl-1">.</span><span class="hl-0">run</span><span class="hl-1">()</span><br/><span class="hl-1">  → </span><span class="hl-4">BacktestCommandService</span><span class="hl-1">.</span><span class="hl-0">run</span><span class="hl-1">()</span><br/><span class="hl-1">    → </span><span class="hl-4">BacktestLogicPublicService</span><span class="hl-1">.</span><span class="hl-0">run</span><span class="hl-1">()</span><br/><span class="hl-1">      → </span><span class="hl-4">BacktestLogicPrivateService</span><span class="hl-1">.</span><span class="hl-0">run</span><span class="hl-1">()</span><br/><span class="hl-1">        → </span><span class="hl-4">StrategyGlobalService</span><span class="hl-1">.</span><span class="hl-0">tick</span><span class="hl-1">()</span><br/><span class="hl-1">          → </span><span class="hl-4">StrategyConnectionService</span><span class="hl-1">.</span><span class="hl-0">tick</span><span class="hl-1">()</span><br/><span class="hl-1">            → </span><span class="hl-4">ClientStrategy</span><span class="hl-1">.</span><span class="hl-0">tick</span><span class="hl-1">()</span><br/><span class="hl-1">              → </span><span class="hl-4">ExchangeConnectionService</span><span class="hl-1">.</span><span class="hl-0">getCandles</span><span class="hl-1">()</span><br/><span class="hl-1">                → </span><span class="hl-4">ClientExchange</span><span class="hl-1">.</span><span class="hl-0">getCandles</span><span class="hl-1">()</span>
</code><button>Copy</button></pre>

<p>Each layer adds value:</p>
<ul>
<li><strong>Command</strong>: Validation and context setup</li>
<li><strong>Logic Public</strong>: External contract</li>
<li><strong>Logic Private</strong>: Core algorithm</li>
<li><strong>Global</strong>: Context injection</li>
<li><strong>Connection</strong>: Instance routing</li>
<li><strong>Client</strong>: Business logic</li>
</ul>
<a id="service-category-deep-dives" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Service Category Deep Dives<a href="#service-category-deep-dives" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>For detailed information about each service category:</p>
<ul>
<li><a href="design_39_service_architecture_overview.html">Service Architecture Overview</a> - Service matrix patterns and organization principles</li>
<li><a href="design_54_timeframe_generation.html">Connection Services</a> - Memoization, instance routing, dependency injection details</li>
<li><a href="design_55_fast-forward_simulation.html">Schema Services</a> - Registration patterns, retrieval, name-based lookup</li>
<li><a href="design_42_validation_services.html">Validation Services</a> - 30+ validation rules, error handling, registration validation</li>
<li><a href="design_43_global_services.html">Global Services</a> - Context injection wrappers, ExecutionContext integration</li>
<li><a href="design_44_logic_services.html">Logic Services</a> - Private vs Public separation, AsyncGenerator streaming, execution orchestration</li>
<li><a href="design_45_markdown_services.html">Markdown Services</a> - Event accumulation, statistics calculation, report generation</li>
</ul>
</div></div><div class="col-sidebar"><div class="page-menu"><div class="tsd-navigation settings"><details class="tsd-accordion"><summary class="tsd-accordion-summary"><h3><svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-chevronDown"></use></svg>Settings</h3></summary><div class="tsd-accordion-details"><div class="tsd-filter-visibility"><span class="settings-label">Member Visibility</span><ul id="tsd-filter-options"><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-protected" name="protected"/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Protected</span></label></li><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-inherited" name="inherited" checked/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Inherited</span></label></li><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-external" name="external"/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>External</span></label></li></ul></div><div class="tsd-theme-toggle"><label class="settings-label" for="tsd-theme">Theme</label><select id="tsd-theme"><option value="os">OS</option><option value="light">Light</option><option value="dark">Dark</option></select></div></div></details></div><details open class="tsd-accordion tsd-page-navigation"><summary class="tsd-accordion-summary"><h3><svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-chevronDown"></use></svg>On This Page</h3></summary><div class="tsd-accordion-details"><a href="#service-layer"><span>Service <wbr/>Layer</span></a><ul><li><a href="#service-organization"><span>Service <wbr/>Organization</span></a></li><li><a href="#service-categories"><span>Service <wbr/>Categories</span></a></li><li><ul><li><a href="#connection-services"><span>Connection <wbr/>Services</span></a></li><li><a href="#schema-services"><span>Schema <wbr/>Services</span></a></li><li><a href="#global-services"><span>Global <wbr/>Services</span></a></li><li><a href="#validation-services"><span>Validation <wbr/>Services</span></a></li><li><a href="#command-services"><span>Command <wbr/>Services</span></a></li><li><a href="#logic-services"><span>Logic <wbr/>Services</span></a></li><li><a href="#markdown-services"><span>Markdown <wbr/>Services</span></a></li><li><a href="#template-services"><span>Template <wbr/>Services</span></a></li></ul></li><li><a href="#service-registration-and-injection"><span>Service <wbr/>Registration and <wbr/>Injection</span></a></li><li><a href="#the-backtest-aggregation-object"><span>The <wbr/>Backtest <wbr/>Aggregation <wbr/>Object</span></a></li><li><a href="#service-interaction-patterns"><span>Service <wbr/>Interaction <wbr/>Patterns</span></a></li><li><a href="#service-category-deep-dives"><span>Service <wbr/>Category <wbr/>Deep <wbr/>Dives</span></a></li></ul></div></details></div><div class="site-menu"><nav class="tsd-navigation"><a href="../modules.html">backtest-kit</a><ul class="tsd-small-nested-navigation" id="tsd-nav-container"><li>Loading...</li></ul></nav></div></div></div><footer><p class="tsd-generator">Generated using <a href="https://typedoc.org/" target="_blank">TypeDoc</a></p></footer><div class="overlay"></div></body></html>

<!-- Yandex.Metrika counter -->
<script type="text/javascript">
    (function(m,e,t,r,i,k,a){
        m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
        m[i].l=1*new Date();
        for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }}
        k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)
    })(window, document,'script','https://mc.yandex.ru/metrika/tag.js?id=105455585', 'ym');

    ym(105455585, 'init', {ssr:true, webvisor:true, clickmap:true, ecommerce:"dataLayer", accurateTrackBounce:true, trackLinks:true});
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/105455585" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
<!-- /Yandex.Metrika counter -->

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-3MQZEBBDDR"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-3MQZEBBDDR');
</script>
