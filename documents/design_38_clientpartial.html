<!DOCTYPE html><html class="default" lang="en" data-base=".."><head><meta charset="utf-8"/><meta http-equiv="x-ua-compatible" content="IE=edge"/><title>design/38_clientpartial | backtest-kit</title><meta name="description" content="Documentation for backtest-kit"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="stylesheet" href="../assets/style.css"/><link rel="stylesheet" href="../assets/highlight.css"/><script defer src="../assets/main.js"></script><script async src="../assets/icons.js" id="tsd-icons-script"></script><script async src="../assets/search.js" id="tsd-search-script"></script><script async src="../assets/navigation.js" id="tsd-nav-script"></script><script async src="../assets/hierarchy.js" id="tsd-hierarchy-script"></script></head><body><script>document.documentElement.dataset.theme = localStorage.getItem("tsd-theme") || "os";document.body.style.display="none";setTimeout(() => app?app.showPage():document.body.style.removeProperty("display"),500)</script><header class="tsd-page-toolbar"><div class="tsd-toolbar-contents container"><div class="table-cell" id="tsd-search"><div class="field"><label for="tsd-search-field" class="tsd-widget tsd-toolbar-icon search no-caption"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-search"></use></svg></label><input type="text" id="tsd-search-field" aria-label="Search"/></div><div class="field"><div id="tsd-toolbar-links"></div></div><ul class="results"><li class="state loading">Preparing search index...</li><li class="state failure">The search index is not available</li></ul><a href="../index.html" class="title">backtest-kit</a></div><div class="table-cell" id="tsd-widgets"><a href="#" class="tsd-widget tsd-toolbar-icon menu no-caption" data-toggle="menu" aria-label="Menu"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-menu"></use></svg></a></div></div></header><div class="container container-main"><div class="col-content"><div class="tsd-page-title"><ul class="tsd-breadcrumb"><li><a href="../modules.html">backtest-kit</a></li><li><a href="design_38_clientpartial.html">design/38_clientpartial</a></li></ul></div><div class="tsd-panel tsd-typography"><a id="clientpartial" class="tsd-anchor"></a><h1 class="tsd-anchor-link">ClientPartial<a href="#clientpartial" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h1><a id="purpose-and-scope" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Purpose and Scope<a href="#purpose-and-scope" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>ClientPartial implements milestone-based profit/loss tracking for active trading signals. It monitors when signals reach specific profit or loss thresholds (10%, 20%, 30%, etc.) and emits events for each milestone exactly once per signal. The system provides crash-safe state persistence for live trading and integrates with the broader signal lifecycle through PartialGlobalService and PartialConnectionService.</p>
<p>For signal lifecycle state management, see <a href="design_33_clientstrategy.html">ClientStrategy</a>. For persistence architecture details, see <a href="design_84_persistence_layer.html">Persistence Layer</a>. For event consumption patterns, see <a href="design_23_event_listeners.html">Event Listeners</a>.</p>
<hr>
<a id="architecture-overview" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Architecture Overview<a href="#architecture-overview" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>ClientPartial operates within a multi-layered service architecture that separates concerns between core logic, instance management, and global coordination.</p>
<p><img src="../media/38_ClientPartial_0.svg" alt="Mermaid Diagram"></p>
<hr>
<a id="core-components" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Core Components<a href="#core-components" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><a id="clientpartial-class" class="tsd-anchor"></a><h3 class="tsd-anchor-link">ClientPartial Class<a href="#clientpartial-class" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>ClientPartial is the core implementation that tracks profit/loss milestones for individual signals. Each instance is tied to a specific <code>signalId</code> and <code>backtest</code> mode.</p>
<table>
<thead>
<tr>
<th>Property</th>
<th>Type</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>_states</code></td>
<td><code>Map&lt;string, IPartialState&gt;</code> | <code>typeof NEED_FETCH</code></td>
<td>Map of signal IDs to their profit/loss state, or sentinel before initialization</td>
</tr>
<tr>
<td><code>params.signalId</code></td>
<td><code>string</code></td>
<td>Unique signal ID associated with this instance</td>
</tr>
<tr>
<td><code>params.logger</code></td>
<td><code>ILogger</code></td>
<td>Logger service for debug and info messages</td>
</tr>
<tr>
<td><code>params.backtest</code></td>
<td><code>boolean</code></td>
<td>Execution mode flag (true = backtest, false = live)</td>
</tr>
<tr>
<td><code>params.onProfit</code></td>
<td><code>function</code></td>
<td>Callback for profit level events</td>
</tr>
<tr>
<td><code>params.onLoss</code></td>
<td><code>function</code></td>
<td>Callback for loss level events</td>
</tr>
</tbody>
</table>
<p><strong>Key Methods</strong>:</p>
<ul>
<li><code>waitForInit(symbol, strategyName)</code>: Loads persisted state from disk (live mode only), wrapped with <code>singleshot</code> to ensure one-time execution</li>
<li><code>profit(symbol, data, currentPrice, revenuePercent, backtest, when)</code>: Checks for newly reached profit levels, emits events, persists state</li>
<li><code>loss(symbol, data, currentPrice, lossPercent, backtest, when)</code>: Checks for newly reached loss levels, emits events, persists state</li>
<li><code>clear(symbol, data, priceClose, backtest)</code>: Removes signal state and persists changes</li>
<li><code>_persistState(symbol, strategyName)</code>: Converts in-memory Maps/Sets to JSON and writes atomically</li>
</ul>
<a id="state-structures" class="tsd-anchor"></a><h3 class="tsd-anchor-link">State Structures<a href="#state-structures" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><img src="../media/38_ClientPartial_1.svg" alt="Mermaid Diagram"></p>
<p><strong>Type Definitions</strong>:</p>
<pre><code class="typescript"><span class="hl-0">// In-memory state (Sets for O(1) lookup)</span><br/><span class="hl-3">interface</span><span class="hl-2"> </span><span class="hl-11">IPartialState</span><span class="hl-2"> {</span><br/><span class="hl-2">  </span><span class="hl-6">profitLevels</span><span class="hl-2">: </span><span class="hl-11">Set</span><span class="hl-2">&lt;</span><span class="hl-11">PartialLevel</span><span class="hl-2">&gt;;</span><br/><span class="hl-2">  </span><span class="hl-6">lossLevels</span><span class="hl-2">: </span><span class="hl-11">Set</span><span class="hl-2">&lt;</span><span class="hl-11">PartialLevel</span><span class="hl-2">&gt;;</span><br/><span class="hl-2">}</span><br/><br/><span class="hl-0">// Persisted state (Arrays for JSON serialization)</span><br/><span class="hl-3">interface</span><span class="hl-2"> </span><span class="hl-11">IPartialData</span><span class="hl-2"> {</span><br/><span class="hl-2">  </span><span class="hl-6">profitLevels</span><span class="hl-2">: </span><span class="hl-11">PartialLevel</span><span class="hl-2">[];</span><br/><span class="hl-2">  </span><span class="hl-6">lossLevels</span><span class="hl-2">: </span><span class="hl-11">PartialLevel</span><span class="hl-2">[];</span><br/><span class="hl-2">}</span><br/><br/><span class="hl-0">// Milestone levels (10%, 20%, ..., 100%)</span><br/><span class="hl-3">type</span><span class="hl-2"> </span><span class="hl-11">PartialLevel</span><span class="hl-2"> = </span><span class="hl-7">10</span><span class="hl-2"> | </span><span class="hl-7">20</span><span class="hl-2"> | </span><span class="hl-7">30</span><span class="hl-2"> | </span><span class="hl-7">40</span><span class="hl-2"> | </span><span class="hl-7">50</span><span class="hl-2"> | </span><span class="hl-7">60</span><span class="hl-2"> | </span><span class="hl-7">70</span><span class="hl-2"> | </span><span class="hl-7">80</span><span class="hl-2"> | </span><span class="hl-7">90</span><span class="hl-2"> | </span><span class="hl-7">100</span><span class="hl-2">;</span>
</code><button type="button">Copy</button></pre>

<hr>
<a id="milestone-detection-system" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Milestone Detection System<a href="#milestone-detection-system" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><a id="profit-level-tracking" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Profit Level Tracking<a href="#profit-level-tracking" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>The profit detection algorithm iterates through predefined profit levels and checks which have been reached but not yet recorded. When a new level is detected, it adds the level to the Set, invokes the callback, and persists state.</p>
<p><img src="../media/38_ClientPartial_2.svg" alt="Mermaid Diagram"></p>
<p><strong>Implementation</strong>: The <code>HANDLE_PROFIT_FN</code> function at <a href="">src/client/ClientPartial.ts:44-105</a> implements this logic. It uses a <code>for</code> loop over <code>PROFIT_LEVELS</code> constant defined at <a href="">src/client/ClientPartial.ts:22</a>.</p>
<a id="loss-level-tracking" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Loss Level Tracking<a href="#loss-level-tracking" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Loss tracking mirrors profit tracking but converts negative <code>lossPercent</code> to absolute value for comparison. This allows using the same level thresholds (10, 20, 30...) for both directions.</p>
<p><strong>Key Difference</strong>: Loss percent is passed as negative value (e.g., <code>-15.5</code>), but converted to absolute value (<code>15.5</code>) before level comparison. The <code>LOSS_LEVELS</code> array is identical to <code>PROFIT_LEVELS</code>.</p>
<pre><code class="typescript"><span class="hl-0">// Line 152: Convert negative loss to absolute value</span><br/><span class="hl-3">const</span><span class="hl-2"> </span><span class="hl-8">absLoss</span><span class="hl-2"> = </span><span class="hl-6">Math</span><span class="hl-2">.</span><span class="hl-1">abs</span><span class="hl-2">(</span><span class="hl-6">lossPercent</span><span class="hl-2">);</span><br/><br/><span class="hl-0">// Line 155-156: Check if absolute loss exceeds level</span><br/><span class="hl-5">for</span><span class="hl-2"> (</span><span class="hl-3">const</span><span class="hl-2"> </span><span class="hl-8">level</span><span class="hl-2"> </span><span class="hl-3">of</span><span class="hl-2"> </span><span class="hl-8">LOSS_LEVELS</span><span class="hl-2">) {</span><br/><span class="hl-2">  </span><span class="hl-5">if</span><span class="hl-2"> (</span><span class="hl-6">absLoss</span><span class="hl-2"> &gt;= </span><span class="hl-6">level</span><span class="hl-2"> &amp;&amp; !</span><span class="hl-6">state</span><span class="hl-2">.</span><span class="hl-6">lossLevels</span><span class="hl-2">.</span><span class="hl-1">has</span><span class="hl-2">(</span><span class="hl-6">level</span><span class="hl-2">)) {</span><br/><span class="hl-2">    </span><span class="hl-0">// Emit event for this level</span><br/><span class="hl-2">  }</span><br/><span class="hl-2">}</span>
</code><button type="button">Copy</button></pre>

<hr>
<a id="instance-lifecycle-and-memoization" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Instance Lifecycle and Memoization<a href="#instance-lifecycle-and-memoization" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><a id="partialconnectionservice" class="tsd-anchor"></a><h3 class="tsd-anchor-link">PartialConnectionService<a href="#partialconnectionservice" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>PartialConnectionService acts as a factory for ClientPartial instances with memoization to ensure one instance per signal. The memoization key combines <code>signalId</code> and <code>backtest</code> mode.</p>
<p><img src="../media/38_ClientPartial_3.svg" alt="Mermaid Diagram"></p>
<p><strong>Memoization Implementation</strong>:</p>
<pre><code class="typescript"><span class="hl-0">// Lines 132-143: Memoized factory</span><br/><span class="hl-6">private</span><span class="hl-2"> </span><span class="hl-6">getPartial</span><span class="hl-2"> = </span><span class="hl-1">memoize</span><span class="hl-2">&lt;(</span><span class="hl-6">signalId</span><span class="hl-2">: </span><span class="hl-11">string</span><span class="hl-2">, </span><span class="hl-6">backtest</span><span class="hl-2">: </span><span class="hl-11">boolean</span><span class="hl-2">) </span><span class="hl-3">=&gt;</span><span class="hl-2"> </span><span class="hl-11">ClientPartial</span><span class="hl-2">&gt;(</span><br/><span class="hl-2">  ([</span><span class="hl-6">signalId</span><span class="hl-2">, </span><span class="hl-6">backtest</span><span class="hl-2">]) </span><span class="hl-3">=&gt;</span><span class="hl-2"> </span><span class="hl-4">`</span><span class="hl-3">${</span><span class="hl-6">signalId</span><span class="hl-3">}</span><span class="hl-4">:</span><span class="hl-3">${</span><span class="hl-6">backtest</span><span class="hl-9"> </span><span class="hl-2">?</span><span class="hl-9"> </span><span class="hl-4">&quot;backtest&quot;</span><span class="hl-9"> </span><span class="hl-2">:</span><span class="hl-9"> </span><span class="hl-4">&quot;live&quot;</span><span class="hl-3">}</span><span class="hl-4">`</span><span class="hl-2">,</span><br/><span class="hl-2">  (</span><span class="hl-6">signalId</span><span class="hl-2">: </span><span class="hl-11">string</span><span class="hl-2">, </span><span class="hl-6">backtest</span><span class="hl-2">: </span><span class="hl-11">boolean</span><span class="hl-2">) </span><span class="hl-3">=&gt;</span><span class="hl-2"> {</span><br/><span class="hl-2">    </span><span class="hl-5">return</span><span class="hl-2"> </span><span class="hl-3">new</span><span class="hl-2"> </span><span class="hl-1">ClientPartial</span><span class="hl-2">({</span><br/><span class="hl-2">      </span><span class="hl-6">signalId</span><span class="hl-2">,</span><br/><span class="hl-2">      </span><span class="hl-6">logger:</span><span class="hl-2"> </span><span class="hl-3">this</span><span class="hl-2">.</span><span class="hl-6">loggerService</span><span class="hl-2">,</span><br/><span class="hl-2">      </span><span class="hl-6">backtest</span><span class="hl-2">,</span><br/><span class="hl-2">      </span><span class="hl-6">onProfit:</span><span class="hl-2"> </span><span class="hl-8">COMMIT_PROFIT_FN</span><span class="hl-2">,</span><br/><span class="hl-2">      </span><span class="hl-6">onLoss:</span><span class="hl-2"> </span><span class="hl-8">COMMIT_LOSS_FN</span><span class="hl-2">,</span><br/><span class="hl-2">    });</span><br/><span class="hl-2">  }</span><br/><span class="hl-2">);</span>
</code><button type="button">Copy</button></pre>

<p><strong>Cleanup on Signal Close</strong>: When <code>clear()</code> is called, the memoized entry is removed at <a href="">src/lib/services/connection/PartialConnectionService.ts:262</a>. This prevents memory leaks for long-running live trading sessions.</p>
<hr>
<a id="persistence-layer-integration" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Persistence Layer Integration<a href="#persistence-layer-integration" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><a id="persistpartialadapter" class="tsd-anchor"></a><h3 class="tsd-anchor-link">PersistPartialAdapter<a href="#persistpartialadapter" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>PersistPartialAdapter extends the base persistence system with partial-specific logic. It stores state per <code>{symbol}_{strategyName}</code> entity.</p>
<table>
<thead>
<tr>
<th>Method</th>
<th>Purpose</th>
<th>File Path</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>readPartialData(symbol, strategyName)</code></td>
<td>Reads persisted partial data from disk</td>
<td><a href="">src/classes/Persist.ts:712-734</a></td>
</tr>
<tr>
<td><code>writePartialData(partialData, symbol, strategyName)</code></td>
<td>Writes partial data atomically to disk</td>
<td><a href="">src/classes/Persist.ts:736-755</a></td>
</tr>
<tr>
<td><code>usePersistPartialAdapter(Ctor)</code></td>
<td>Registers custom persistence adapter</td>
<td><a href="">src/classes/Persist.ts:694-710</a></td>
</tr>
</tbody>
</table>
<p><strong>Directory Structure</strong>:</p>
<pre><code><span class="hl-2">./</span><span class="hl-6">dump</span><span class="hl-2">/</span><span class="hl-6">data</span><span class="hl-2">/</span><span class="hl-6">partial</span><span class="hl-2">/</span><br/><span class="hl-2">  ├── </span><span class="hl-6">BTCUSDT_my</span><span class="hl-2">-</span><span class="hl-6">strategy</span><span class="hl-2">/</span><br/><span class="hl-2">  │   └── </span><span class="hl-6">levels</span><span class="hl-2">.</span><span class="hl-6">json</span><br/><span class="hl-2">  ├── </span><span class="hl-6">ETHUSDT_my</span><span class="hl-2">-</span><span class="hl-6">strategy</span><span class="hl-2">/</span><br/><span class="hl-2">  │   └── </span><span class="hl-6">levels</span><span class="hl-2">.</span><span class="hl-6">json</span><br/><span class="hl-2">  └── </span><span class="hl-6">BTCUSDT_other</span><span class="hl-2">-</span><span class="hl-6">strategy</span><span class="hl-2">/</span><br/><span class="hl-2">      └── </span><span class="hl-6">levels</span><span class="hl-2">.</span><span class="hl-6">json</span>
</code><button>Copy</button></pre>

<p><strong>File Content Example</strong> (<code>levels.json</code>):</p>
<pre><code class="json"><span class="hl-2">{</span><br/><span class="hl-2">  </span><span class="hl-14">&quot;signal-abc123&quot;</span><span class="hl-2">: {</span><br/><span class="hl-2">    </span><span class="hl-14">&quot;profitLevels&quot;</span><span class="hl-2">: [</span><span class="hl-7">10</span><span class="hl-2">, </span><span class="hl-7">20</span><span class="hl-2">, </span><span class="hl-7">30</span><span class="hl-2">],</span><br/><span class="hl-2">    </span><span class="hl-14">&quot;lossLevels&quot;</span><span class="hl-2">: [</span><span class="hl-7">10</span><span class="hl-2">]</span><br/><span class="hl-2">  },</span><br/><span class="hl-2">  </span><span class="hl-14">&quot;signal-def456&quot;</span><span class="hl-2">: {</span><br/><span class="hl-2">    </span><span class="hl-14">&quot;profitLevels&quot;</span><span class="hl-2">: [</span><span class="hl-7">10</span><span class="hl-2">],</span><br/><span class="hl-2">    </span><span class="hl-14">&quot;lossLevels&quot;</span><span class="hl-2">: []</span><br/><span class="hl-2">  }</span><br/><span class="hl-2">}</span>
</code><button type="button">Copy</button></pre>

<p>Each file is a <code>Record&lt;signalId, IPartialData&gt;</code> where multiple signals for the same symbol/strategy are stored together.</p>
<a id="initialization-flow" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Initialization Flow<a href="#initialization-flow" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><img src="../media/38_ClientPartial_4.svg" alt="Mermaid Diagram"></p>
<p><strong>Key Points</strong>:</p>
<ol>
<li><code>waitForInit()</code> is wrapped with <code>singleshot</code> to ensure one-time execution per <code>(symbol, strategyName)</code> tuple</li>
<li>Backtest mode skips all persistence operations (lines 215-218 of ClientPartial.ts)</li>
<li>Live mode reads existing state from disk and converts <code>IPartialData</code> arrays to <code>IPartialState</code> Sets</li>
<li>State restoration happens at lines 222-228 of ClientPartial.ts</li>
</ol>
<hr>
<a id="integration-with-clientstrategy" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Integration with ClientStrategy<a href="#integration-with-clientstrategy" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>ClientStrategy invokes ClientPartial methods during signal monitoring when calculating profit/loss percentages. The integration occurs in the signal state machine's &quot;active&quot; state.</p>
<p><img src="../media/38_ClientPartial_5.svg" alt="Mermaid Diagram"></p>
<p><strong>ClientStrategy Constructor Injection</strong>:</p>
<p>The <code>partial</code> parameter is injected into ClientStrategy through <code>IStrategyParams</code> interface. This occurs in StrategyConnectionService which constructs ClientStrategy instances with PartialGlobalService.</p>
<p><strong>Example Flow</strong>:</p>
<ol>
<li>Signal opens at $50,000</li>
<li>Price rises to $55,000 (10% profit)</li>
<li>ClientStrategy calculates <code>revenuePercent = 10.0</code></li>
<li>Calls <code>this.params.partial.profit(&quot;BTCUSDT&quot;, signal, 55000, 10.0, false, new Date())</code></li>
<li>PartialGlobalService validates and delegates to PartialConnectionService</li>
<li>PartialConnectionService retrieves/creates ClientPartial for signal ID</li>
<li>ClientPartial checks levels, emits event for 10%, persists state</li>
</ol>
<hr>
<a id="event-system-and-contracts" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Event System and Contracts<a href="#event-system-and-contracts" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><a id="event-emission-architecture" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Event Emission Architecture<a href="#event-emission-architecture" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>ClientPartial emits events through callback functions passed via <code>IPartialParams</code>. These callbacks are configured by PartialConnectionService to emit to RxJS Subjects.</p>
<p><img src="../media/38_ClientPartial_6.svg" alt="Mermaid Diagram"></p>
<a id="event-contracts" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Event Contracts<a href="#event-contracts" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><strong>PartialProfitContract</strong> (<a href="">src/contract/PartialProfit.contract.ts:35-99</a>):</p>
<table>
<thead>
<tr>
<th>Field</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>symbol</code></td>
<td><code>string</code></td>
<td>Trading pair (e.g., &quot;BTCUSDT&quot;)</td>
</tr>
<tr>
<td><code>strategyName</code></td>
<td><code>string</code></td>
<td>Strategy identifier</td>
</tr>
<tr>
<td><code>exchangeName</code></td>
<td><code>string</code></td>
<td>Exchange identifier</td>
</tr>
<tr>
<td><code>data</code></td>
<td><code>ISignalRow</code></td>
<td>Complete signal data</td>
</tr>
<tr>
<td><code>currentPrice</code></td>
<td><code>number</code></td>
<td>Market price at milestone</td>
</tr>
<tr>
<td><code>level</code></td>
<td><code>PartialLevel</code></td>
<td>Profit level reached (10-100)</td>
</tr>
<tr>
<td><code>backtest</code></td>
<td><code>boolean</code></td>
<td>Execution mode flag</td>
</tr>
<tr>
<td><code>timestamp</code></td>
<td><code>number</code></td>
<td>Event time in milliseconds</td>
</tr>
</tbody>
</table>
<p><strong>PartialLossContract</strong> (<a href="">src/contract/PartialLoss.contract.ts:40-113</a>):</p>
<p>Same structure as PartialProfitContract. The <code>level</code> field stores absolute value (e.g., <code>20</code> for -20% loss).</p>
<hr>
<a id="usage-examples" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Usage Examples<a href="#usage-examples" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><a id="basic-profitloss-tracking" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Basic Profit/Loss Tracking<a href="#basic-profitloss-tracking" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><pre><code class="typescript"><span class="hl-5">import</span><span class="hl-2"> { </span><span class="hl-6">listenPartialProfit</span><span class="hl-2">, </span><span class="hl-6">listenPartialLoss</span><span class="hl-2"> } </span><span class="hl-5">from</span><span class="hl-2"> </span><span class="hl-4">&quot;backtest-kit&quot;</span><span class="hl-2">;</span><br/><br/><span class="hl-0">// Monitor all profit milestones</span><br/><span class="hl-1">listenPartialProfit</span><span class="hl-2">((</span><span class="hl-6">event</span><span class="hl-2">) </span><span class="hl-3">=&gt;</span><span class="hl-2"> {</span><br/><span class="hl-2">  </span><span class="hl-6">console</span><span class="hl-2">.</span><span class="hl-1">log</span><span class="hl-2">(</span><span class="hl-4">`[</span><span class="hl-3">${</span><span class="hl-6">event</span><span class="hl-9">.</span><span class="hl-6">symbol</span><span class="hl-3">}</span><span class="hl-4">] </span><span class="hl-3">${</span><span class="hl-6">event</span><span class="hl-9">.</span><span class="hl-6">level</span><span class="hl-3">}</span><span class="hl-4">% profit at $</span><span class="hl-3">${</span><span class="hl-6">event</span><span class="hl-9">.</span><span class="hl-6">currentPrice</span><span class="hl-3">}</span><span class="hl-4">`</span><span class="hl-2">);</span><br/><span class="hl-2">  </span><span class="hl-6">console</span><span class="hl-2">.</span><span class="hl-1">log</span><span class="hl-2">(</span><span class="hl-4">`Signal: </span><span class="hl-3">${</span><span class="hl-6">event</span><span class="hl-9">.</span><span class="hl-6">data</span><span class="hl-9">.</span><span class="hl-6">id</span><span class="hl-3">}</span><span class="hl-4">, Strategy: </span><span class="hl-3">${</span><span class="hl-6">event</span><span class="hl-9">.</span><span class="hl-6">strategyName</span><span class="hl-3">}</span><span class="hl-4">`</span><span class="hl-2">);</span><br/><span class="hl-2">  </span><br/><span class="hl-2">  </span><span class="hl-0">// Take action on significant profits</span><br/><span class="hl-2">  </span><span class="hl-5">if</span><span class="hl-2"> (</span><span class="hl-6">event</span><span class="hl-2">.</span><span class="hl-6">level</span><span class="hl-2"> &gt;= </span><span class="hl-7">50</span><span class="hl-2"> &amp;&amp; !</span><span class="hl-6">event</span><span class="hl-2">.</span><span class="hl-6">backtest</span><span class="hl-2">) {</span><br/><span class="hl-2">    </span><span class="hl-6">console</span><span class="hl-2">.</span><span class="hl-1">log</span><span class="hl-2">(</span><span class="hl-4">&quot;Consider partial exit for 50%+ profit&quot;</span><span class="hl-2">);</span><br/><span class="hl-2">  }</span><br/><span class="hl-2">});</span><br/><br/><span class="hl-0">// Monitor loss milestones</span><br/><span class="hl-1">listenPartialLoss</span><span class="hl-2">((</span><span class="hl-6">event</span><span class="hl-2">) </span><span class="hl-3">=&gt;</span><span class="hl-2"> {</span><br/><span class="hl-2">  </span><span class="hl-6">console</span><span class="hl-2">.</span><span class="hl-1">log</span><span class="hl-2">(</span><span class="hl-4">`[</span><span class="hl-3">${</span><span class="hl-6">event</span><span class="hl-9">.</span><span class="hl-6">symbol</span><span class="hl-3">}</span><span class="hl-4">] -</span><span class="hl-3">${</span><span class="hl-6">event</span><span class="hl-9">.</span><span class="hl-6">level</span><span class="hl-3">}</span><span class="hl-4">% loss at $</span><span class="hl-3">${</span><span class="hl-6">event</span><span class="hl-9">.</span><span class="hl-6">currentPrice</span><span class="hl-3">}</span><span class="hl-4">`</span><span class="hl-2">);</span><br/><span class="hl-2">  </span><br/><span class="hl-2">  </span><span class="hl-0">// Alert on high drawdown</span><br/><span class="hl-2">  </span><span class="hl-5">if</span><span class="hl-2"> (</span><span class="hl-6">event</span><span class="hl-2">.</span><span class="hl-6">level</span><span class="hl-2"> &gt;= </span><span class="hl-7">30</span><span class="hl-2">) {</span><br/><span class="hl-2">    </span><span class="hl-6">console</span><span class="hl-2">.</span><span class="hl-1">warn</span><span class="hl-2">(</span><span class="hl-4">&quot;HIGH DRAWDOWN ALERT:&quot;</span><span class="hl-2">, </span><span class="hl-6">event</span><span class="hl-2">.</span><span class="hl-6">data</span><span class="hl-2">.</span><span class="hl-6">id</span><span class="hl-2">);</span><br/><span class="hl-2">  }</span><br/><span class="hl-2">});</span>
</code><button type="button">Copy</button></pre>

<a id="waiting-for-specific-milestones" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Waiting for Specific Milestones<a href="#waiting-for-specific-milestones" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><pre><code class="typescript"><span class="hl-5">import</span><span class="hl-2"> { </span><span class="hl-6">listenPartialProfitOnce</span><span class="hl-2">, </span><span class="hl-6">listenPartialLossOnce</span><span class="hl-2"> } </span><span class="hl-5">from</span><span class="hl-2"> </span><span class="hl-4">&quot;backtest-kit&quot;</span><span class="hl-2">;</span><br/><br/><span class="hl-0">// Wait for first 20% profit on BTCUSDT</span><br/><span class="hl-1">listenPartialProfitOnce</span><span class="hl-2">(</span><br/><span class="hl-2">  (</span><span class="hl-6">event</span><span class="hl-2">) </span><span class="hl-3">=&gt;</span><span class="hl-2"> </span><span class="hl-6">event</span><span class="hl-2">.</span><span class="hl-6">symbol</span><span class="hl-2"> === </span><span class="hl-4">&quot;BTCUSDT&quot;</span><span class="hl-2"> &amp;&amp; </span><span class="hl-6">event</span><span class="hl-2">.</span><span class="hl-6">level</span><span class="hl-2"> === </span><span class="hl-7">20</span><span class="hl-2">,</span><br/><span class="hl-2">  (</span><span class="hl-6">event</span><span class="hl-2">) </span><span class="hl-3">=&gt;</span><span class="hl-2"> {</span><br/><span class="hl-2">    </span><span class="hl-6">console</span><span class="hl-2">.</span><span class="hl-1">log</span><span class="hl-2">(</span><span class="hl-4">&quot;BTCUSDT reached 20% profit target&quot;</span><span class="hl-2">);</span><br/><span class="hl-2">    </span><span class="hl-6">console</span><span class="hl-2">.</span><span class="hl-1">log</span><span class="hl-2">(</span><span class="hl-4">`Entry: </span><span class="hl-3">${</span><span class="hl-6">event</span><span class="hl-9">.</span><span class="hl-6">data</span><span class="hl-9">.</span><span class="hl-6">priceOpen</span><span class="hl-3">}</span><span class="hl-4">, Current: </span><span class="hl-3">${</span><span class="hl-6">event</span><span class="hl-9">.</span><span class="hl-6">currentPrice</span><span class="hl-3">}</span><span class="hl-4">`</span><span class="hl-2">);</span><br/><span class="hl-2">  }</span><br/><span class="hl-2">);</span><br/><br/><span class="hl-0">// Stop loss alert</span><br/><span class="hl-1">listenPartialLossOnce</span><span class="hl-2">(</span><br/><span class="hl-2">  (</span><span class="hl-6">event</span><span class="hl-2">) </span><span class="hl-3">=&gt;</span><span class="hl-2"> </span><span class="hl-6">event</span><span class="hl-2">.</span><span class="hl-6">level</span><span class="hl-2"> === </span><span class="hl-7">10</span><span class="hl-2">,</span><br/><span class="hl-2">  (</span><span class="hl-6">event</span><span class="hl-2">) </span><span class="hl-3">=&gt;</span><span class="hl-2"> {</span><br/><span class="hl-2">    </span><span class="hl-6">console</span><span class="hl-2">.</span><span class="hl-1">error</span><span class="hl-2">(</span><span class="hl-4">&quot;First 10% loss occurred:&quot;</span><span class="hl-2">, </span><span class="hl-6">event</span><span class="hl-2">.</span><span class="hl-6">data</span><span class="hl-2">.</span><span class="hl-6">note</span><span class="hl-2">);</span><br/><span class="hl-2">  }</span><br/><span class="hl-2">);</span>
</code><button type="button">Copy</button></pre>

<a id="custom-persistence-adapter" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Custom Persistence Adapter<a href="#custom-persistence-adapter" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><pre><code class="typescript"><span class="hl-5">import</span><span class="hl-2"> { </span><span class="hl-6">PersistPartialAdapter</span><span class="hl-2">, </span><span class="hl-6">PersistBase</span><span class="hl-2"> } </span><span class="hl-5">from</span><span class="hl-2"> </span><span class="hl-4">&quot;backtest-kit&quot;</span><span class="hl-2">;</span><br/><br/><span class="hl-0">// Custom Redis-based persistence</span><br/><span class="hl-3">class</span><span class="hl-2"> </span><span class="hl-11">RedisPersistPartial</span><span class="hl-2"> </span><span class="hl-3">extends</span><span class="hl-2"> </span><span class="hl-11">PersistBase</span><span class="hl-2"> {</span><br/><span class="hl-2">  </span><span class="hl-3">async</span><span class="hl-2"> </span><span class="hl-1">readValue</span><span class="hl-2">(</span><span class="hl-6">entityId</span><span class="hl-2">) {</span><br/><span class="hl-2">    </span><span class="hl-3">const</span><span class="hl-2"> </span><span class="hl-8">json</span><span class="hl-2"> = </span><span class="hl-5">await</span><span class="hl-2"> </span><span class="hl-6">redis</span><span class="hl-2">.</span><span class="hl-1">get</span><span class="hl-2">(</span><span class="hl-4">`partial:</span><span class="hl-3">${</span><span class="hl-3">this</span><span class="hl-9">.</span><span class="hl-6">entityName</span><span class="hl-3">}</span><span class="hl-4">:</span><span class="hl-3">${</span><span class="hl-6">entityId</span><span class="hl-3">}</span><span class="hl-4">`</span><span class="hl-2">);</span><br/><span class="hl-2">    </span><span class="hl-5">return</span><span class="hl-2"> </span><span class="hl-8">JSON</span><span class="hl-2">.</span><span class="hl-1">parse</span><span class="hl-2">(</span><span class="hl-6">json</span><span class="hl-2">);</span><br/><span class="hl-2">  }</span><br/><span class="hl-2">  </span><br/><span class="hl-2">  </span><span class="hl-3">async</span><span class="hl-2"> </span><span class="hl-1">writeValue</span><span class="hl-2">(</span><span class="hl-6">entityId</span><span class="hl-2">, </span><span class="hl-6">entity</span><span class="hl-2">) {</span><br/><span class="hl-2">    </span><span class="hl-5">await</span><span class="hl-2"> </span><span class="hl-6">redis</span><span class="hl-2">.</span><span class="hl-1">set</span><span class="hl-2">(</span><br/><span class="hl-2">      </span><span class="hl-4">`partial:</span><span class="hl-3">${</span><span class="hl-3">this</span><span class="hl-9">.</span><span class="hl-6">entityName</span><span class="hl-3">}</span><span class="hl-4">:</span><span class="hl-3">${</span><span class="hl-6">entityId</span><span class="hl-3">}</span><span class="hl-4">`</span><span class="hl-2">,</span><br/><span class="hl-2">      </span><span class="hl-8">JSON</span><span class="hl-2">.</span><span class="hl-1">stringify</span><span class="hl-2">(</span><span class="hl-6">entity</span><span class="hl-2">)</span><br/><span class="hl-2">    );</span><br/><span class="hl-2">  }</span><br/><span class="hl-2">  </span><br/><span class="hl-2">  </span><span class="hl-3">async</span><span class="hl-2"> </span><span class="hl-1">hasValue</span><span class="hl-2">(</span><span class="hl-6">entityId</span><span class="hl-2">) {</span><br/><span class="hl-2">    </span><span class="hl-5">return</span><span class="hl-2"> (</span><span class="hl-5">await</span><span class="hl-2"> </span><span class="hl-6">redis</span><span class="hl-2">.</span><span class="hl-1">exists</span><span class="hl-2">(</span><span class="hl-4">`partial:</span><span class="hl-3">${</span><span class="hl-3">this</span><span class="hl-9">.</span><span class="hl-6">entityName</span><span class="hl-3">}</span><span class="hl-4">:</span><span class="hl-3">${</span><span class="hl-6">entityId</span><span class="hl-3">}</span><span class="hl-4">`</span><span class="hl-2">)) === </span><span class="hl-7">1</span><span class="hl-2">;</span><br/><span class="hl-2">  }</span><br/><span class="hl-2">}</span><br/><br/><span class="hl-0">// Register custom adapter</span><br/><span class="hl-6">PersistPartialAdapter</span><span class="hl-2">.</span><span class="hl-1">usePersistPartialAdapter</span><span class="hl-2">(</span><span class="hl-6">RedisPersistPartial</span><span class="hl-2">);</span>
</code><button type="button">Copy</button></pre>

<hr>
<a id="performance-considerations" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Performance Considerations<a href="#performance-considerations" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><a id="memory-management" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Memory Management<a href="#memory-management" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><ol>
<li>
<p><strong>Memoization Cleanup</strong>: The <code>clear()</code> method removes memoized instances from PartialConnectionService to prevent memory leaks (<a href="">src/lib/services/connection/PartialConnectionService.ts:261-262</a>)</p>
</li>
<li>
<p><strong>Set-based Deduplication</strong>: Using <code>Set&lt;PartialLevel&gt;</code> provides O(1) membership checks vs. O(n) for array-based approaches</p>
</li>
<li>
<p><strong>Signal-scoped State</strong>: Each ClientPartial instance tracks state for only one signal ID, keeping memory footprint proportional to active signals</p>
</li>
</ol>
<a id="disk-io-optimization" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Disk I/O Optimization<a href="#disk-io-optimization" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><ol>
<li>
<p><strong>Backtest Skip</strong>: All persistence operations are skipped in backtest mode (<a href="">src/client/ClientPartial.ts:215-218</a>, <a href="">src/client/ClientPartial.ts:350-352</a>), avoiding unnecessary disk writes during historical simulation</p>
</li>
<li>
<p><strong>Atomic Writes</strong>: Uses <code>writeFileAtomic</code> with tmp → rename pattern to prevent corruption (<a href="">src/classes/Persist.ts:306</a>)</p>
</li>
<li>
<p><strong>Batched Persistence</strong>: State is persisted only when new levels are reached (<code>shouldPersist</code> flag at <a href="">src/client/ClientPartial.ts:74</a>, <a href="">src/client/ClientPartial.ts:153</a>), not on every monitoring tick</p>
</li>
</ol>
<a id="event-emission-efficiency" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Event Emission Efficiency<a href="#event-emission-efficiency" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><ol>
<li>
<p><strong>Single Callback per Level</strong>: Each level emits exactly one event due to Set-based tracking</p>
</li>
<li>
<p><strong>Queued Processing</strong>: Event listeners use <code>queued()</code> wrapper to process events sequentially, preventing backpressure (<a href="">src/function/event.ts:14</a>)</p>
</li>
</ol>
<hr>
<a id="error-handling-and-edge-cases" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Error Handling and Edge Cases<a href="#error-handling-and-edge-cases" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><a id="initialization-safety" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Initialization Safety<a href="#initialization-safety" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><strong>NEED_FETCH Sentinel</strong>: Before <code>waitForInit()</code> is called, <code>_states</code> is set to the symbol <code>NEED_FETCH</code> (<a href="">src/client/ClientPartial.ts:16</a>). Any attempt to use profit/loss/clear methods before initialization throws an error:</p>
<pre><code class="typescript"><span class="hl-5">if</span><span class="hl-2"> (</span><span class="hl-6">self</span><span class="hl-2">.</span><span class="hl-6">_states</span><span class="hl-2"> === </span><span class="hl-8">NEED_FETCH</span><span class="hl-2">) {</span><br/><span class="hl-2">  </span><span class="hl-5">throw</span><span class="hl-2"> </span><span class="hl-3">new</span><span class="hl-2"> </span><span class="hl-1">Error</span><span class="hl-2">(</span><br/><span class="hl-2">    </span><span class="hl-4">&quot;ClientPartial not initialized. Call waitForInit() before using.&quot;</span><br/><span class="hl-2">  );</span><br/><span class="hl-2">}</span>
</code><button type="button">Copy</button></pre>

<p>This prevents accessing uninitialized state and ensures crash recovery data is loaded in live mode.</p>
<a id="signal-id-validation" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Signal ID Validation<a href="#signal-id-validation" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>ClientPartial validates that the signal ID matches the instance's configured <code>signalId</code>:</p>
<pre><code class="typescript"><span class="hl-5">if</span><span class="hl-2"> (</span><span class="hl-6">data</span><span class="hl-2">.</span><span class="hl-6">id</span><span class="hl-2"> !== </span><span class="hl-6">self</span><span class="hl-2">.</span><span class="hl-6">params</span><span class="hl-2">.</span><span class="hl-6">signalId</span><span class="hl-2">) {</span><br/><span class="hl-2">  </span><span class="hl-5">throw</span><span class="hl-2"> </span><span class="hl-3">new</span><span class="hl-2"> </span><span class="hl-1">Error</span><span class="hl-2">(</span><br/><span class="hl-2">    </span><span class="hl-4">`Signal ID mismatch: expected </span><span class="hl-3">${</span><span class="hl-6">self</span><span class="hl-9">.</span><span class="hl-6">params</span><span class="hl-9">.</span><span class="hl-6">signalId</span><span class="hl-3">}</span><span class="hl-4">, got </span><span class="hl-3">${</span><span class="hl-6">data</span><span class="hl-9">.</span><span class="hl-6">id</span><span class="hl-3">}</span><span class="hl-4">`</span><br/><span class="hl-2">  );</span><br/><span class="hl-2">}</span>
</code><button type="button">Copy</button></pre>

<p>This catches programming errors where the wrong signal is passed to an instance.</p>
<a id="persistence-failure-handling" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Persistence Failure Handling<a href="#persistence-failure-handling" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>If persistence fails during <code>_persistState()</code>, the error propagates to the caller. The atomic write pattern in <code>writeFileAtomic</code> ensures that:</p>
<ol>
<li>Either the full state is written successfully</li>
<li>Or the previous state remains intact (no partial corruption)</li>
</ol>
<hr>
<a id="testing-considerations" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Testing Considerations<a href="#testing-considerations" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><a id="mocking-callbacks" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Mocking Callbacks<a href="#mocking-callbacks" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>For testing ClientPartial in isolation, mock the <code>onProfit</code> and <code>onLoss</code> callbacks:</p>
<pre><code class="typescript"><span class="hl-3">const</span><span class="hl-2"> </span><span class="hl-8">profitEvents</span><span class="hl-2">: </span><span class="hl-11">PartialProfitContract</span><span class="hl-2">[] = [];</span><br/><span class="hl-3">const</span><span class="hl-2"> </span><span class="hl-8">lossEvents</span><span class="hl-2">: </span><span class="hl-11">PartialLossContract</span><span class="hl-2">[] = [];</span><br/><br/><span class="hl-3">const</span><span class="hl-2"> </span><span class="hl-8">partial</span><span class="hl-2"> = </span><span class="hl-3">new</span><span class="hl-2"> </span><span class="hl-1">ClientPartial</span><span class="hl-2">({</span><br/><span class="hl-2">  </span><span class="hl-6">signalId:</span><span class="hl-2"> </span><span class="hl-4">&quot;test-signal&quot;</span><span class="hl-2">,</span><br/><span class="hl-2">  </span><span class="hl-6">logger:</span><span class="hl-2"> </span><span class="hl-6">mockLogger</span><span class="hl-2">,</span><br/><span class="hl-2">  </span><span class="hl-6">backtest:</span><span class="hl-2"> </span><span class="hl-3">true</span><span class="hl-2">,</span><br/><span class="hl-2">  </span><span class="hl-1">onProfit</span><span class="hl-6">:</span><span class="hl-2"> </span><span class="hl-3">async</span><span class="hl-2"> (...</span><span class="hl-6">args</span><span class="hl-2">) </span><span class="hl-3">=&gt;</span><span class="hl-2"> {</span><br/><span class="hl-2">    </span><span class="hl-6">profitEvents</span><span class="hl-2">.</span><span class="hl-1">push</span><span class="hl-2">({ </span><span class="hl-0">/* construct contract */</span><span class="hl-2"> });</span><br/><span class="hl-2">  },</span><br/><span class="hl-2">  </span><span class="hl-1">onLoss</span><span class="hl-6">:</span><span class="hl-2"> </span><span class="hl-3">async</span><span class="hl-2"> (...</span><span class="hl-6">args</span><span class="hl-2">) </span><span class="hl-3">=&gt;</span><span class="hl-2"> {</span><br/><span class="hl-2">    </span><span class="hl-6">lossEvents</span><span class="hl-2">.</span><span class="hl-1">push</span><span class="hl-2">({ </span><span class="hl-0">/* construct contract */</span><span class="hl-2"> });</span><br/><span class="hl-2">  },</span><br/><span class="hl-2">});</span><br/><br/><span class="hl-5">await</span><span class="hl-2"> </span><span class="hl-6">partial</span><span class="hl-2">.</span><span class="hl-1">waitForInit</span><span class="hl-2">(</span><span class="hl-4">&quot;BTCUSDT&quot;</span><span class="hl-2">, </span><span class="hl-4">&quot;test-strategy&quot;</span><span class="hl-2">);</span><br/><br/><span class="hl-0">// Test profit detection</span><br/><span class="hl-5">await</span><span class="hl-2"> </span><span class="hl-6">partial</span><span class="hl-2">.</span><span class="hl-1">profit</span><span class="hl-2">(</span><span class="hl-4">&quot;BTCUSDT&quot;</span><span class="hl-2">, </span><span class="hl-6">signal</span><span class="hl-2">, </span><span class="hl-7">55000</span><span class="hl-2">, </span><span class="hl-7">15.5</span><span class="hl-2">, </span><span class="hl-3">true</span><span class="hl-2">, </span><span class="hl-3">new</span><span class="hl-2"> </span><span class="hl-1">Date</span><span class="hl-2">());</span><br/><br/><span class="hl-0">// Assert: profitEvents should contain 10% level event</span><br/><span class="hl-1">expect</span><span class="hl-2">(</span><span class="hl-6">profitEvents</span><span class="hl-2">).</span><span class="hl-1">toHaveLength</span><span class="hl-2">(</span><span class="hl-7">1</span><span class="hl-2">);</span><br/><span class="hl-1">expect</span><span class="hl-2">(</span><span class="hl-6">profitEvents</span><span class="hl-2">[</span><span class="hl-7">0</span><span class="hl-2">].</span><span class="hl-6">level</span><span class="hl-2">).</span><span class="hl-1">toBe</span><span class="hl-2">(</span><span class="hl-7">10</span><span class="hl-2">);</span>
</code><button type="button">Copy</button></pre>

<a id="backtest-vs-live-behavior" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Backtest vs Live Behavior<a href="#backtest-vs-live-behavior" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Toggle <code>backtest</code> parameter to test both modes:</p>
<ul>
<li><strong>Backtest</strong>: Persistence is skipped, events still emit</li>
<li><strong>Live</strong>: Full persistence, crash recovery tested</li>
</ul>
<a id="state-serialization" class="tsd-anchor"></a><h3 class="tsd-anchor-link">State Serialization<a href="#state-serialization" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Test <code>IPartialState</code> ↔ <code>IPartialData</code> conversion:</p>
<pre><code class="typescript"><span class="hl-3">const</span><span class="hl-2"> </span><span class="hl-8">state</span><span class="hl-2">: </span><span class="hl-11">IPartialState</span><span class="hl-2"> = {</span><br/><span class="hl-2">  </span><span class="hl-6">profitLevels:</span><span class="hl-2"> </span><span class="hl-3">new</span><span class="hl-2"> </span><span class="hl-1">Set</span><span class="hl-2">([</span><span class="hl-7">10</span><span class="hl-2">, </span><span class="hl-7">20</span><span class="hl-2">, </span><span class="hl-7">30</span><span class="hl-2">]),</span><br/><span class="hl-2">  </span><span class="hl-6">lossLevels:</span><span class="hl-2"> </span><span class="hl-3">new</span><span class="hl-2"> </span><span class="hl-1">Set</span><span class="hl-2">([</span><span class="hl-7">10</span><span class="hl-2">]),</span><br/><span class="hl-2">};</span><br/><br/><span class="hl-3">const</span><span class="hl-2"> </span><span class="hl-8">data</span><span class="hl-2">: </span><span class="hl-11">IPartialData</span><span class="hl-2"> = {</span><br/><span class="hl-2">  </span><span class="hl-6">profitLevels:</span><span class="hl-2"> </span><span class="hl-6">Array</span><span class="hl-2">.</span><span class="hl-1">from</span><span class="hl-2">(</span><span class="hl-6">state</span><span class="hl-2">.</span><span class="hl-6">profitLevels</span><span class="hl-2">),</span><br/><span class="hl-2">  </span><span class="hl-6">lossLevels:</span><span class="hl-2"> </span><span class="hl-6">Array</span><span class="hl-2">.</span><span class="hl-1">from</span><span class="hl-2">(</span><span class="hl-6">state</span><span class="hl-2">.</span><span class="hl-6">lossLevels</span><span class="hl-2">),</span><br/><span class="hl-2">};</span><br/><br/><span class="hl-0">// Verify round-trip</span><br/><span class="hl-3">const</span><span class="hl-2"> </span><span class="hl-8">restored</span><span class="hl-2">: </span><span class="hl-11">IPartialState</span><span class="hl-2"> = {</span><br/><span class="hl-2">  </span><span class="hl-6">profitLevels:</span><span class="hl-2"> </span><span class="hl-3">new</span><span class="hl-2"> </span><span class="hl-1">Set</span><span class="hl-2">(</span><span class="hl-6">data</span><span class="hl-2">.</span><span class="hl-6">profitLevels</span><span class="hl-2">),</span><br/><span class="hl-2">  </span><span class="hl-6">lossLevels:</span><span class="hl-2"> </span><span class="hl-3">new</span><span class="hl-2"> </span><span class="hl-1">Set</span><span class="hl-2">(</span><span class="hl-6">data</span><span class="hl-2">.</span><span class="hl-6">lossLevels</span><span class="hl-2">),</span><br/><span class="hl-2">};</span>
</code><button type="button">Copy</button></pre>

</div></div><div class="col-sidebar"><div class="page-menu"><div class="tsd-navigation settings"><details class="tsd-accordion"><summary class="tsd-accordion-summary"><h3><svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-chevronDown"></use></svg>Settings</h3></summary><div class="tsd-accordion-details"><div class="tsd-filter-visibility"><span class="settings-label">Member Visibility</span><ul id="tsd-filter-options"><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-protected" name="protected"/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Protected</span></label></li><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-inherited" name="inherited" checked/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Inherited</span></label></li><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-external" name="external"/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>External</span></label></li></ul></div><div class="tsd-theme-toggle"><label class="settings-label" for="tsd-theme">Theme</label><select id="tsd-theme"><option value="os">OS</option><option value="light">Light</option><option value="dark">Dark</option></select></div></div></details></div><details open class="tsd-accordion tsd-page-navigation"><summary class="tsd-accordion-summary"><h3><svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-chevronDown"></use></svg>On This Page</h3></summary><div class="tsd-accordion-details"><a href="#clientpartial"><span>Client<wbr/>Partial</span></a><ul><li><a href="#purpose-and-scope"><span>Purpose and <wbr/>Scope</span></a></li><li><a href="#architecture-overview"><span>Architecture <wbr/>Overview</span></a></li><li><a href="#core-components"><span>Core <wbr/>Components</span></a></li><li><ul><li><a href="#clientpartial-class"><span>Client<wbr/>Partial <wbr/>Class</span></a></li><li><a href="#state-structures"><span>State <wbr/>Structures</span></a></li></ul></li><li><a href="#milestone-detection-system"><span>Milestone <wbr/>Detection <wbr/>System</span></a></li><li><ul><li><a href="#profit-level-tracking"><span>Profit <wbr/>Level <wbr/>Tracking</span></a></li><li><a href="#loss-level-tracking"><span>Loss <wbr/>Level <wbr/>Tracking</span></a></li></ul></li><li><a href="#instance-lifecycle-and-memoization"><span>Instance <wbr/>Lifecycle and <wbr/>Memoization</span></a></li><li><ul><li><a href="#partialconnectionservice"><span>Partial<wbr/>Connection<wbr/>Service</span></a></li></ul></li><li><a href="#persistence-layer-integration"><span>Persistence <wbr/>Layer <wbr/>Integration</span></a></li><li><ul><li><a href="#persistpartialadapter"><span>Persist<wbr/>Partial<wbr/>Adapter</span></a></li><li><a href="#initialization-flow"><span>Initialization <wbr/>Flow</span></a></li></ul></li><li><a href="#integration-with-clientstrategy"><span>Integration with <wbr/>Client<wbr/>Strategy</span></a></li><li><a href="#event-system-and-contracts"><span>Event <wbr/>System and <wbr/>Contracts</span></a></li><li><ul><li><a href="#event-emission-architecture"><span>Event <wbr/>Emission <wbr/>Architecture</span></a></li><li><a href="#event-contracts"><span>Event <wbr/>Contracts</span></a></li></ul></li><li><a href="#usage-examples"><span>Usage <wbr/>Examples</span></a></li><li><ul><li><a href="#basic-profitloss-tracking"><span>Basic <wbr/>Profit/<wbr/>Loss <wbr/>Tracking</span></a></li><li><a href="#waiting-for-specific-milestones"><span>Waiting for <wbr/>Specific <wbr/>Milestones</span></a></li><li><a href="#custom-persistence-adapter"><span>Custom <wbr/>Persistence <wbr/>Adapter</span></a></li></ul></li><li><a href="#performance-considerations"><span>Performance <wbr/>Considerations</span></a></li><li><ul><li><a href="#memory-management"><span>Memory <wbr/>Management</span></a></li><li><a href="#disk-io-optimization"><span>Disk <wbr/>I/<wbr/>O <wbr/>Optimization</span></a></li><li><a href="#event-emission-efficiency"><span>Event <wbr/>Emission <wbr/>Efficiency</span></a></li></ul></li><li><a href="#error-handling-and-edge-cases"><span>Error <wbr/>Handling and <wbr/>Edge <wbr/>Cases</span></a></li><li><ul><li><a href="#initialization-safety"><span>Initialization <wbr/>Safety</span></a></li><li><a href="#signal-id-validation"><span>Signal ID <wbr/>Validation</span></a></li><li><a href="#persistence-failure-handling"><span>Persistence <wbr/>Failure <wbr/>Handling</span></a></li></ul></li><li><a href="#testing-considerations"><span>Testing <wbr/>Considerations</span></a></li><li><ul><li><a href="#mocking-callbacks"><span>Mocking <wbr/>Callbacks</span></a></li><li><a href="#backtest-vs-live-behavior"><span>Backtest vs <wbr/>Live <wbr/>Behavior</span></a></li><li><a href="#state-serialization"><span>State <wbr/>Serialization</span></a></li></ul></li></ul></div></details></div><div class="site-menu"><nav class="tsd-navigation"><a href="../modules.html">backtest-kit</a><ul class="tsd-small-nested-navigation" id="tsd-nav-container"><li>Loading...</li></ul></nav></div></div></div><footer><p class="tsd-generator">Generated using <a href="https://typedoc.org/" target="_blank">TypeDoc</a></p></footer><div class="overlay"></div></body></html>

<!-- Yandex.Metrika counter -->
<script type="text/javascript">
    (function(m,e,t,r,i,k,a){
        m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
        m[i].l=1*new Date();
        for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }}
        k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)
    })(window, document,'script','https://mc.yandex.ru/metrika/tag.js?id=105455585', 'ym');

    ym(105455585, 'init', {ssr:true, webvisor:true, clickmap:true, ecommerce:"dataLayer", accurateTrackBounce:true, trackLinks:true});
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/105455585" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
<!-- /Yandex.Metrika counter -->

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-3MQZEBBDDR"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-3MQZEBBDDR');
</script>
