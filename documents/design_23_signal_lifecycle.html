<!DOCTYPE html><html class="default" lang="en" data-base=".."><head><meta charset="utf-8"/><meta http-equiv="x-ua-compatible" content="IE=edge"/><title>design/23_signal_lifecycle | backtest-kit</title><meta name="description" content="Documentation for backtest-kit"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="stylesheet" href="../assets/style.css"/><link rel="stylesheet" href="../assets/highlight.css"/><script defer src="../assets/main.js"></script><script async src="../assets/icons.js" id="tsd-icons-script"></script><script async src="../assets/search.js" id="tsd-search-script"></script><script async src="../assets/navigation.js" id="tsd-nav-script"></script><script async src="../assets/hierarchy.js" id="tsd-hierarchy-script"></script></head><body><script>document.documentElement.dataset.theme = localStorage.getItem("tsd-theme") || "os";document.body.style.display="none";setTimeout(() => app?app.showPage():document.body.style.removeProperty("display"),500)</script><header class="tsd-page-toolbar"><div class="tsd-toolbar-contents container"><div class="table-cell" id="tsd-search"><div class="field"><label for="tsd-search-field" class="tsd-widget tsd-toolbar-icon search no-caption"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-search"></use></svg></label><input type="text" id="tsd-search-field" aria-label="Search"/></div><div class="field"><div id="tsd-toolbar-links"></div></div><ul class="results"><li class="state loading">Preparing search index...</li><li class="state failure">The search index is not available</li></ul><a href="../index.html" class="title">backtest-kit</a></div><div class="table-cell" id="tsd-widgets"><a href="#" class="tsd-widget tsd-toolbar-icon menu no-caption" data-toggle="menu" aria-label="Menu"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-menu"></use></svg></a></div></div></header><div class="container container-main"><div class="col-content"><div class="tsd-page-title"><ul class="tsd-breadcrumb"><li><a href="../modules.html">backtest-kit</a></li><li><a href="design_23_signal_lifecycle.html">design/23_signal_lifecycle</a></li></ul></div><div class="tsd-panel tsd-typography"><a id="signal-lifecycle" class="tsd-anchor"></a><h1 class="tsd-anchor-link">Signal Lifecycle<a href="#signal-lifecycle" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h1><a id="purpose-and-scope" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Purpose and Scope<a href="#purpose-and-scope" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>This document provides a comprehensive technical reference for signal lifecycle management in the backtest-kit framework. It covers the four discrete states a trading signal can occupy (idle, opened, active, closed), the discriminated union type system used for type-safe state handling, validation rules, and the persistence mechanisms that enable crash-safe operation in live trading.</p>
<p>For execution orchestration of signals in backtest mode, see <a href="design_28_backtesting.html">Backtesting</a>. For live trading execution with crash recovery, see <a href="design_32_live_trading.html">Live Trading</a>. For ClientStrategy's broader role in business logic, see <a href="design_15_clientstrategy.html">ClientStrategy</a>.</p>
<hr>
<a id="signal-state-overview" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Signal State Overview<a href="#signal-state-overview" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>A signal exists in exactly one of four states at any given time. The framework uses TypeScript discriminated unions to ensure type-safe handling of each state.</p>
<a id="state-summary-table" class="tsd-anchor"></a><h3 class="tsd-anchor-link">State Summary Table<a href="#state-summary-table" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><table>
<thead>
<tr>
<th>State</th>
<th>Action Discriminator</th>
<th>Signal Presence</th>
<th>Description</th>
<th>Yielded in Live Mode</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Idle</strong></td>
<td><code>&quot;idle&quot;</code></td>
<td><code>null</code></td>
<td>No active signal, strategy monitoring market conditions</td>
<td>Yes</td>
</tr>
<tr>
<td><strong>Opened</strong></td>
<td><code>&quot;opened&quot;</code></td>
<td><code>ISignalRow</code></td>
<td>Signal just created, validated, and persisted</td>
<td>Yes</td>
</tr>
<tr>
<td><strong>Active</strong></td>
<td><code>&quot;active&quot;</code></td>
<td><code>ISignalRow</code></td>
<td>Signal monitoring for TP/SL/time expiration</td>
<td>No (filtered)</td>
</tr>
<tr>
<td><strong>Closed</strong></td>
<td><code>&quot;closed&quot;</code></td>
<td><code>ISignalRow</code></td>
<td>Signal completed with PNL calculation</td>
<td>Yes</td>
</tr>
</tbody>
</table>
<hr>
<a id="signal-data-structures" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Signal Data Structures<a href="#signal-data-structures" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><a id="core-signal-types" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Core Signal Types<a href="#core-signal-types" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>The framework distinguishes between three signal representations:</p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Purpose</th>
<th>ID Field</th>
<th>Usage Context</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>ISignalDto</code></td>
<td>User-provided signal data</td>
<td><code>id?: string</code> (optional)</td>
<td>Returned by <code>getSignal()</code> function</td>
</tr>
<tr>
<td><code>ISignalRow</code></td>
<td>Validated signal with metadata</td>
<td><code>id: string</code> (required)</td>
<td>Internal state, persistence, results</td>
</tr>
<tr>
<td><code>IStrategyTickResult</code></td>
<td>Discriminated union of states</td>
<td>N/A (contains <code>ISignalRow</code> or <code>null</code>)</td>
<td>Return type of <code>tick()</code> and <code>backtest()</code></td>
</tr>
</tbody>
</table>
<a id="signal-dto-to-signal-row-transformation" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Signal DTO to Signal Row Transformation<a href="#signal-dto-to-signal-row-transformation" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>When <code>getSignal()</code> returns a signal, it undergoes augmentation in <a href="">src/client/ClientStrategy.ts:114-121</a>:</p>
<pre><code class="typescript"><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">signalRow</span><span class="hl-1">: </span><span class="hl-10">ISignalRow</span><span class="hl-1"> = {</span><br/><span class="hl-1">  </span><span class="hl-4">id:</span><span class="hl-1"> </span><span class="hl-0">randomString</span><span class="hl-1">(),           </span><span class="hl-5">// Auto-generated UUID v4</span><br/><span class="hl-1">  ...</span><span class="hl-4">signal</span><span class="hl-1">,                    </span><span class="hl-5">// User-provided ISignalDto fields</span><br/><span class="hl-1">  </span><span class="hl-4">symbol:</span><span class="hl-1"> </span><span class="hl-4">self</span><span class="hl-1">.</span><span class="hl-4">params</span><span class="hl-1">.</span><span class="hl-4">execution</span><span class="hl-1">.</span><span class="hl-4">context</span><span class="hl-1">.</span><span class="hl-4">symbol</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">exchangeName:</span><span class="hl-1"> </span><span class="hl-4">self</span><span class="hl-1">.</span><span class="hl-4">params</span><span class="hl-1">.</span><span class="hl-4">method</span><span class="hl-1">.</span><span class="hl-4">context</span><span class="hl-1">.</span><span class="hl-4">exchangeName</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">strategyName:</span><span class="hl-1"> </span><span class="hl-4">self</span><span class="hl-1">.</span><span class="hl-4">params</span><span class="hl-1">.</span><span class="hl-4">method</span><span class="hl-1">.</span><span class="hl-4">context</span><span class="hl-1">.</span><span class="hl-4">strategyName</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">timestamp:</span><span class="hl-1"> </span><span class="hl-4">currentTime</span><span class="hl-1">,       </span><span class="hl-5">// Execution context time</span><br/><span class="hl-1">};</span>
</code><button type="button">Copy</button></pre>

<a id="discriminated-union-structure" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Discriminated Union Structure<a href="#discriminated-union-structure" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>The <code>IStrategyTickResult</code> type uses the <code>action</code> field as a discriminator:</p>
<pre><code class="typescript"><span class="hl-6">type</span><span class="hl-1"> </span><span class="hl-10">IStrategyTickResult</span><span class="hl-1"> =</span><br/><span class="hl-1">  | </span><span class="hl-10">IStrategyTickResultIdle</span><span class="hl-1">      </span><span class="hl-5">// action: &quot;idle&quot;</span><br/><span class="hl-1">  | </span><span class="hl-10">IStrategyTickResultOpened</span><span class="hl-1">    </span><span class="hl-5">// action: &quot;opened&quot;</span><br/><span class="hl-1">  | </span><span class="hl-10">IStrategyTickResultActive</span><span class="hl-1">    </span><span class="hl-5">// action: &quot;active&quot;</span><br/><span class="hl-1">  | </span><span class="hl-10">IStrategyTickResultClosed</span><span class="hl-1">    </span><span class="hl-5">// action: &quot;closed&quot;</span>
</code><button type="button">Copy</button></pre>

<p>This enables type-safe narrowing using the discriminator:</p>
<pre><code class="typescript"><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">result</span><span class="hl-1"> = </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-4">strategy</span><span class="hl-1">.</span><span class="hl-0">tick</span><span class="hl-1">();</span><br/><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-4">result</span><span class="hl-1">.</span><span class="hl-4">action</span><span class="hl-1"> === </span><span class="hl-2">&quot;closed&quot;</span><span class="hl-1">) {</span><br/><span class="hl-1">  </span><span class="hl-5">// TypeScript knows result is IStrategyTickResultClosed</span><br/><span class="hl-1">  </span><span class="hl-4">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-4">result</span><span class="hl-1">.</span><span class="hl-4">pnl</span><span class="hl-1">.</span><span class="hl-4">pnlPercentage</span><span class="hl-1">);  </span><span class="hl-5">// Type-safe access</span><br/><span class="hl-1">  </span><span class="hl-4">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-4">result</span><span class="hl-1">.</span><span class="hl-4">closeReason</span><span class="hl-1">);        </span><span class="hl-5">// Type-safe access</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<hr>
<a id="signal-generation-and-throttling" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Signal Generation and Throttling<a href="#signal-generation-and-throttling" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><a id="generation-flow" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Generation Flow<a href="#generation-flow" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>The <code>tick()</code> method calls <code>GET_SIGNAL_FN</code> when no pending signal exists. The following diagram shows the complete generation pipeline:</p>
<p><img src="../media/23_Signal_Lifecycle_1.svg" alt="Mermaid Diagram"></p>
<a id="throttling-intervals" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Throttling Intervals<a href="#throttling-intervals" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Signal generation is throttled using the <code>interval</code> parameter from <code>IStrategySchema</code>. The mapping is defined in <a href="">src/client/ClientStrategy.ts:19-26</a>:</p>
<table>
<thead>
<tr>
<th>Interval</th>
<th>Minutes</th>
<th>Milliseconds</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>&quot;1m&quot;</code></td>
<td>1</td>
<td>60,000</td>
</tr>
<tr>
<td><code>&quot;3m&quot;</code></td>
<td>3</td>
<td>180,000</td>
</tr>
<tr>
<td><code>&quot;5m&quot;</code></td>
<td>5</td>
<td>300,000</td>
</tr>
<tr>
<td><code>&quot;15m&quot;</code></td>
<td>15</td>
<td>900,000</td>
</tr>
<tr>
<td><code>&quot;30m&quot;</code></td>
<td>30</td>
<td>1,800,000</td>
</tr>
<tr>
<td><code>&quot;1h&quot;</code></td>
<td>60</td>
<td>3,600,000</td>
</tr>
</tbody>
</table>
<p>The throttle check occurs in <a href="">src/client/ClientStrategy.ts:94-106</a>:</p>
<pre><code class="typescript"><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">intervalMinutes</span><span class="hl-1"> = </span><span class="hl-7">INTERVAL_MINUTES</span><span class="hl-1">[</span><span class="hl-4">self</span><span class="hl-1">.</span><span class="hl-4">params</span><span class="hl-1">.</span><span class="hl-4">interval</span><span class="hl-1">];</span><br/><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">intervalMs</span><span class="hl-1"> = </span><span class="hl-4">intervalMinutes</span><span class="hl-1"> * </span><span class="hl-8">60</span><span class="hl-1"> * </span><span class="hl-8">1000</span><span class="hl-1">;</span><br/><br/><span class="hl-3">if</span><span class="hl-1"> (</span><br/><span class="hl-1">  </span><span class="hl-4">self</span><span class="hl-1">.</span><span class="hl-4">_lastSignalTimestamp</span><span class="hl-1"> !== </span><span class="hl-6">null</span><span class="hl-1"> &amp;&amp;</span><br/><span class="hl-1">  </span><span class="hl-4">currentTime</span><span class="hl-1"> - </span><span class="hl-4">self</span><span class="hl-1">.</span><span class="hl-4">_lastSignalTimestamp</span><span class="hl-1"> &lt; </span><span class="hl-4">intervalMs</span><br/><span class="hl-1">) {</span><br/><span class="hl-1">  </span><span class="hl-3">return</span><span class="hl-1"> </span><span class="hl-6">null</span><span class="hl-1">;  </span><span class="hl-5">// Throttled, skip this tick</span><br/><span class="hl-1">}</span><br/><br/><span class="hl-4">self</span><span class="hl-1">.</span><span class="hl-4">_lastSignalTimestamp</span><span class="hl-1"> = </span><span class="hl-4">currentTime</span><span class="hl-1">;</span>
</code><button type="button">Copy</button></pre>

<hr>
<a id="signal-validation" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Signal Validation<a href="#signal-validation" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><a id="validation-rules" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Validation Rules<a href="#validation-rules" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>The <code>VALIDATE_SIGNAL_FN</code> performs comprehensive validation before accepting a signal. All validation occurs in <a href="">src/client/ClientStrategy.ts:28-88</a>:</p>
<a id="price-validation" class="tsd-anchor"></a><h4 class="tsd-anchor-link">Price Validation<a href="#price-validation" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><table>
<thead>
<tr>
<th>Field</th>
<th>Rule</th>
<th>Error Message</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>priceOpen</code></td>
<td>Must be &gt; 0</td>
<td><code>&quot;priceOpen must be positive, got {value}&quot;</code></td>
</tr>
<tr>
<td><code>priceTakeProfit</code></td>
<td>Must be &gt; 0</td>
<td><code>&quot;priceTakeProfit must be positive, got {value}&quot;</code></td>
</tr>
<tr>
<td><code>priceStopLoss</code></td>
<td>Must be &gt; 0</td>
<td><code>&quot;priceStopLoss must be positive, got {value}&quot;</code></td>
</tr>
</tbody>
</table>
<a id="long-position-validation" class="tsd-anchor"></a><h4 class="tsd-anchor-link">Long Position Validation<a href="#long-position-validation" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><table>
<thead>
<tr>
<th>Condition</th>
<th>Rule</th>
<th>Error Message</th>
</tr>
</thead>
<tbody>
<tr>
<td>Take Profit</td>
<td><code>priceTakeProfit &gt; priceOpen</code></td>
<td><code>&quot;Long: priceTakeProfit ({TP}) must be &gt; priceOpen ({open})&quot;</code></td>
</tr>
<tr>
<td>Stop Loss</td>
<td><code>priceStopLoss &lt; priceOpen</code></td>
<td><code>&quot;Long: priceStopLoss ({SL}) must be &lt; priceOpen ({open})&quot;</code></td>
</tr>
</tbody>
</table>
<a id="short-position-validation" class="tsd-anchor"></a><h4 class="tsd-anchor-link">Short Position Validation<a href="#short-position-validation" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><table>
<thead>
<tr>
<th>Condition</th>
<th>Rule</th>
<th>Error Message</th>
</tr>
</thead>
<tbody>
<tr>
<td>Take Profit</td>
<td><code>priceTakeProfit &lt; priceOpen</code></td>
<td><code>&quot;Short: priceTakeProfit ({TP}) must be &lt; priceOpen ({open})&quot;</code></td>
</tr>
<tr>
<td>Stop Loss</td>
<td><code>priceStopLoss &gt; priceOpen</code></td>
<td><code>&quot;Short: priceStopLoss ({SL}) must be &gt; priceOpen ({open})&quot;</code></td>
</tr>
</tbody>
</table>
<a id="temporal-validation" class="tsd-anchor"></a><h4 class="tsd-anchor-link">Temporal Validation<a href="#temporal-validation" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><table>
<thead>
<tr>
<th>Field</th>
<th>Rule</th>
<th>Error Message</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>minuteEstimatedTime</code></td>
<td>Must be &gt; 0</td>
<td><code>&quot;minuteEstimatedTime must be positive, got {value}&quot;</code></td>
</tr>
<tr>
<td><code>timestamp</code></td>
<td>Must be &gt; 0</td>
<td><code>&quot;timestamp must be positive, got {value}&quot;</code></td>
</tr>
</tbody>
</table>
<a id="validation-error-handling" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Validation Error Handling<a href="#validation-error-handling" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>When validation fails, all errors are aggregated and thrown as a single Error with newline-separated messages:</p>
<pre><code class="typescript"><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-4">errors</span><span class="hl-1">.</span><span class="hl-4">length</span><span class="hl-1"> &gt; </span><span class="hl-8">0</span><span class="hl-1">) {</span><br/><span class="hl-1">  </span><span class="hl-3">throw</span><span class="hl-1"> </span><span class="hl-6">new</span><span class="hl-1"> </span><span class="hl-0">Error</span><span class="hl-1">(</span><br/><span class="hl-1">    </span><span class="hl-2">`Invalid signal for </span><span class="hl-6">${</span><span class="hl-4">signal</span><span class="hl-9">.</span><span class="hl-4">position</span><span class="hl-6">}</span><span class="hl-2"> position:</span><span class="hl-12">\n</span><span class="hl-6">${</span><span class="hl-4">errors</span><span class="hl-9">.</span><span class="hl-0">join</span><span class="hl-9">(</span><span class="hl-2">&quot;</span><span class="hl-12">\n</span><span class="hl-2">&quot;</span><span class="hl-9">)</span><span class="hl-6">}</span><span class="hl-2">`</span><br/><span class="hl-1">  );</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<p>The error is caught by the <code>trycatch</code> wrapper in <code>GET_SIGNAL_FN</code>, which returns <code>null</code> on failure <a href="">src/client/ClientStrategy.ts:90-131</a>.</p>
<hr>
<a id="monitoring-active-signals-tick-method" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Monitoring Active Signals (tick Method)<a href="#monitoring-active-signals-tick-method" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><a id="execution-flow" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Execution Flow<a href="#execution-flow" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>When a pending signal exists, the <code>tick()</code> method monitors it against three closure conditions. The following sequence diagram shows the complete monitoring flow:</p>
<p><img src="../media/23_Signal_Lifecycle_2.svg" alt="Mermaid Diagram"></p>
<a id="close-condition-logic" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Close Condition Logic<a href="#close-condition-logic" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>The closure conditions are checked in <a href="">src/client/ClientStrategy.ts:343-371</a>:</p>
<a id="time-expiration-check" class="tsd-anchor"></a><h4 class="tsd-anchor-link">Time Expiration Check<a href="#time-expiration-check" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><pre><code class="typescript"><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">signalEndTime</span><span class="hl-1"> = </span><span class="hl-4">signal</span><span class="hl-1">.</span><span class="hl-4">timestamp</span><span class="hl-1"> + </span><span class="hl-4">signal</span><span class="hl-1">.</span><span class="hl-4">minuteEstimatedTime</span><span class="hl-1"> * </span><span class="hl-8">60</span><span class="hl-1"> * </span><span class="hl-8">1000</span><span class="hl-1">;</span><br/><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-4">when</span><span class="hl-1">.</span><span class="hl-0">getTime</span><span class="hl-1">() &gt;= </span><span class="hl-4">signalEndTime</span><span class="hl-1">) {</span><br/><span class="hl-1">  </span><span class="hl-4">shouldClose</span><span class="hl-1"> = </span><span class="hl-6">true</span><span class="hl-1">;</span><br/><span class="hl-1">  </span><span class="hl-4">closeReason</span><span class="hl-1"> = </span><span class="hl-2">&quot;time_expired&quot;</span><span class="hl-1">;</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<a id="long-position-tpsl-check" class="tsd-anchor"></a><h4 class="tsd-anchor-link">Long Position TP/SL Check<a href="#long-position-tpsl-check" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><pre><code class="typescript"><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-4">signal</span><span class="hl-1">.</span><span class="hl-4">position</span><span class="hl-1"> === </span><span class="hl-2">&quot;long&quot;</span><span class="hl-1">) {</span><br/><span class="hl-1">  </span><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-4">averagePrice</span><span class="hl-1"> &gt;= </span><span class="hl-4">signal</span><span class="hl-1">.</span><span class="hl-4">priceTakeProfit</span><span class="hl-1">) {</span><br/><span class="hl-1">    </span><span class="hl-4">shouldClose</span><span class="hl-1"> = </span><span class="hl-6">true</span><span class="hl-1">;</span><br/><span class="hl-1">    </span><span class="hl-4">closeReason</span><span class="hl-1"> = </span><span class="hl-2">&quot;take_profit&quot;</span><span class="hl-1">;</span><br/><span class="hl-1">  } </span><span class="hl-3">else</span><span class="hl-1"> </span><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-4">averagePrice</span><span class="hl-1"> &lt;= </span><span class="hl-4">signal</span><span class="hl-1">.</span><span class="hl-4">priceStopLoss</span><span class="hl-1">) {</span><br/><span class="hl-1">    </span><span class="hl-4">shouldClose</span><span class="hl-1"> = </span><span class="hl-6">true</span><span class="hl-1">;</span><br/><span class="hl-1">    </span><span class="hl-4">closeReason</span><span class="hl-1"> = </span><span class="hl-2">&quot;stop_loss&quot;</span><span class="hl-1">;</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<a id="short-position-tpsl-check" class="tsd-anchor"></a><h4 class="tsd-anchor-link">Short Position TP/SL Check<a href="#short-position-tpsl-check" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><pre><code class="typescript"><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-4">signal</span><span class="hl-1">.</span><span class="hl-4">position</span><span class="hl-1"> === </span><span class="hl-2">&quot;short&quot;</span><span class="hl-1">) {</span><br/><span class="hl-1">  </span><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-4">averagePrice</span><span class="hl-1"> &lt;= </span><span class="hl-4">signal</span><span class="hl-1">.</span><span class="hl-4">priceTakeProfit</span><span class="hl-1">) {</span><br/><span class="hl-1">    </span><span class="hl-4">shouldClose</span><span class="hl-1"> = </span><span class="hl-6">true</span><span class="hl-1">;</span><br/><span class="hl-1">    </span><span class="hl-4">closeReason</span><span class="hl-1"> = </span><span class="hl-2">&quot;take_profit&quot;</span><span class="hl-1">;</span><br/><span class="hl-1">  } </span><span class="hl-3">else</span><span class="hl-1"> </span><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-4">averagePrice</span><span class="hl-1"> &gt;= </span><span class="hl-4">signal</span><span class="hl-1">.</span><span class="hl-4">priceStopLoss</span><span class="hl-1">) {</span><br/><span class="hl-1">    </span><span class="hl-4">shouldClose</span><span class="hl-1"> = </span><span class="hl-6">true</span><span class="hl-1">;</span><br/><span class="hl-1">    </span><span class="hl-4">closeReason</span><span class="hl-1"> = </span><span class="hl-2">&quot;stop_loss&quot;</span><span class="hl-1">;</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<hr>
<a id="fast-forward-backtest-simulation" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Fast-Forward Backtest Simulation<a href="#fast-forward-backtest-simulation" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><a id="method-overview" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Method Overview<a href="#method-overview" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>The <code>backtest()</code> method provides fast-forward simulation by processing an array of historical candles without iterating through every timestamp. This is called by <code>BacktestLogicPrivateService</code> after a signal opens.</p>
<a id="backtest-vs-tick-comparison" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Backtest vs Tick Comparison<a href="#backtest-vs-tick-comparison" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><table>
<thead>
<tr>
<th>Aspect</th>
<th><code>tick()</code></th>
<th><code>backtest()</code></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Context</strong></td>
<td>Live or Backtest</td>
<td>Backtest only</td>
</tr>
<tr>
<td><strong>Input</strong></td>
<td>Execution context time</td>
<td>Array of future candles</td>
</tr>
<tr>
<td><strong>Monitoring</strong></td>
<td>Single price point (VWAP)</td>
<td>Iterates through candles</td>
</tr>
<tr>
<td><strong>VWAP Calculation</strong></td>
<td>Exchange service</td>
<td>Internal <code>GET_AVG_PRICE_FN</code></td>
</tr>
<tr>
<td><strong>Return Type</strong></td>
<td><code>IStrategyTickResult</code> (4 states)</td>
<td><code>IStrategyBacktestResult</code> (always closed)</td>
</tr>
<tr>
<td><strong>Closure</strong></td>
<td>May return &quot;active&quot;</td>
<td>Always returns &quot;closed&quot;</td>
</tr>
<tr>
<td><strong>Starting Index</strong></td>
<td>N/A</td>
<td>Index 4 (needs 5 candles for VWAP)</td>
</tr>
</tbody>
</table>
<a id="backtest-execution-flow" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Backtest Execution Flow<a href="#backtest-execution-flow" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><img src="../media/23_Signal_Lifecycle_3.svg" alt="Mermaid Diagram"></p>
<a id="vwap-calculation-for-backtest" class="tsd-anchor"></a><h3 class="tsd-anchor-link">VWAP Calculation for Backtest<a href="#vwap-calculation-for-backtest" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>The <code>GET_AVG_PRICE_FN</code> calculates Volume-Weighted Average Price from candle data <a href="">src/client/ClientStrategy.ts:133-144</a>:</p>
<pre><code class="typescript"><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-0">GET_AVG_PRICE_FN</span><span class="hl-1"> = (</span><span class="hl-4">candles</span><span class="hl-1">: </span><span class="hl-10">ICandleData</span><span class="hl-1">[]): </span><span class="hl-10">number</span><span class="hl-1"> </span><span class="hl-6">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">sumPriceVolume</span><span class="hl-1"> = </span><span class="hl-4">candles</span><span class="hl-1">.</span><span class="hl-0">reduce</span><span class="hl-1">((</span><span class="hl-4">acc</span><span class="hl-1">, </span><span class="hl-4">c</span><span class="hl-1">) </span><span class="hl-6">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">typicalPrice</span><span class="hl-1"> = (</span><span class="hl-4">c</span><span class="hl-1">.</span><span class="hl-4">high</span><span class="hl-1"> + </span><span class="hl-4">c</span><span class="hl-1">.</span><span class="hl-4">low</span><span class="hl-1"> + </span><span class="hl-4">c</span><span class="hl-1">.</span><span class="hl-4">close</span><span class="hl-1">) / </span><span class="hl-8">3</span><span class="hl-1">;</span><br/><span class="hl-1">    </span><span class="hl-3">return</span><span class="hl-1"> </span><span class="hl-4">acc</span><span class="hl-1"> + </span><span class="hl-4">typicalPrice</span><span class="hl-1"> * </span><span class="hl-4">c</span><span class="hl-1">.</span><span class="hl-4">volume</span><span class="hl-1">;</span><br/><span class="hl-1">  }, </span><span class="hl-8">0</span><span class="hl-1">);</span><br/><br/><span class="hl-1">  </span><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">totalVolume</span><span class="hl-1"> = </span><span class="hl-4">candles</span><span class="hl-1">.</span><span class="hl-0">reduce</span><span class="hl-1">((</span><span class="hl-4">acc</span><span class="hl-1">, </span><span class="hl-4">c</span><span class="hl-1">) </span><span class="hl-6">=&gt;</span><span class="hl-1"> </span><span class="hl-4">acc</span><span class="hl-1"> + </span><span class="hl-4">c</span><span class="hl-1">.</span><span class="hl-4">volume</span><span class="hl-1">, </span><span class="hl-8">0</span><span class="hl-1">);</span><br/><br/><span class="hl-1">  </span><span class="hl-3">return</span><span class="hl-1"> </span><span class="hl-4">totalVolume</span><span class="hl-1"> === </span><span class="hl-8">0</span><br/><span class="hl-1">    ? </span><span class="hl-4">candles</span><span class="hl-1">.</span><span class="hl-0">reduce</span><span class="hl-1">((</span><span class="hl-4">acc</span><span class="hl-1">, </span><span class="hl-4">c</span><span class="hl-1">) </span><span class="hl-6">=&gt;</span><span class="hl-1"> </span><span class="hl-4">acc</span><span class="hl-1"> + </span><span class="hl-4">c</span><span class="hl-1">.</span><span class="hl-4">close</span><span class="hl-1">, </span><span class="hl-8">0</span><span class="hl-1">) / </span><span class="hl-4">candles</span><span class="hl-1">.</span><span class="hl-4">length</span><br/><span class="hl-1">    : </span><span class="hl-4">sumPriceVolume</span><span class="hl-1"> / </span><span class="hl-4">totalVolume</span><span class="hl-1">;</span><br/><span class="hl-1">};</span>
</code><button type="button">Copy</button></pre>

<p>This uses a 5-candle rolling window starting from index 4 <a href="">src/client/ClientStrategy.ts:512-515</a>:</p>
<pre><code class="typescript"><span class="hl-3">for</span><span class="hl-1"> (</span><span class="hl-6">let</span><span class="hl-1"> </span><span class="hl-4">i</span><span class="hl-1"> = </span><span class="hl-8">4</span><span class="hl-1">; </span><span class="hl-4">i</span><span class="hl-1"> &lt; </span><span class="hl-4">candles</span><span class="hl-1">.</span><span class="hl-4">length</span><span class="hl-1">; </span><span class="hl-4">i</span><span class="hl-1">++) {</span><br/><span class="hl-1">  </span><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">recentCandles</span><span class="hl-1"> = </span><span class="hl-4">candles</span><span class="hl-1">.</span><span class="hl-0">slice</span><span class="hl-1">(</span><span class="hl-4">i</span><span class="hl-1"> - </span><span class="hl-8">4</span><span class="hl-1">, </span><span class="hl-4">i</span><span class="hl-1"> + </span><span class="hl-8">1</span><span class="hl-1">);  </span><span class="hl-5">// 5 candles</span><br/><span class="hl-1">  </span><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">averagePrice</span><span class="hl-1"> = </span><span class="hl-0">GET_AVG_PRICE_FN</span><span class="hl-1">(</span><span class="hl-4">recentCandles</span><span class="hl-1">);</span>
</code><button type="button">Copy</button></pre>

<hr>
<a id="signal-persistence-and-crash-recovery" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Signal Persistence and Crash Recovery<a href="#signal-persistence-and-crash-recovery" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><a id="setpendingsignal-method" class="tsd-anchor"></a><h3 class="tsd-anchor-link">setPendingSignal Method<a href="#setpendingsignal-method" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>All signal state changes flow through the centralized <code>setPendingSignal()</code> method <a href="">src/client/ClientStrategy.ts:220-233</a>:</p>
<pre><code class="typescript"><span class="hl-4">public</span><span class="hl-1"> </span><span class="hl-4">async</span><span class="hl-1"> </span><span class="hl-0">setPendingSignal</span><span class="hl-1">(</span><span class="hl-4">pendingSignal</span><span class="hl-1">: </span><span class="hl-4">ISignalRow</span><span class="hl-1"> | </span><span class="hl-6">null</span><span class="hl-1">) {</span><br/><span class="hl-1">  </span><span class="hl-6">this</span><span class="hl-1">.</span><span class="hl-4">params</span><span class="hl-1">.</span><span class="hl-4">logger</span><span class="hl-1">.</span><span class="hl-0">debug</span><span class="hl-1">(</span><span class="hl-2">&quot;ClientStrategy setPendingSignal&quot;</span><span class="hl-1">, {</span><br/><span class="hl-1">    </span><span class="hl-4">pendingSignal</span><span class="hl-1">,</span><br/><span class="hl-1">  });</span><br/><span class="hl-1">  </span><span class="hl-6">this</span><span class="hl-1">.</span><span class="hl-4">_pendingSignal</span><span class="hl-1"> = </span><span class="hl-4">pendingSignal</span><span class="hl-1">;</span><br/><span class="hl-1">  </span><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-6">this</span><span class="hl-1">.</span><span class="hl-4">params</span><span class="hl-1">.</span><span class="hl-4">execution</span><span class="hl-1">.</span><span class="hl-4">context</span><span class="hl-1">.</span><span class="hl-4">backtest</span><span class="hl-1">) {</span><br/><span class="hl-1">    </span><span class="hl-3">return</span><span class="hl-1">;  </span><span class="hl-5">// Skip persistence in backtest mode</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">  </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-4">PersistSignalAdaper</span><span class="hl-1">.</span><span class="hl-0">writeSignalData</span><span class="hl-1">(</span><br/><span class="hl-1">    </span><span class="hl-6">this</span><span class="hl-1">.</span><span class="hl-4">_pendingSignal</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-6">this</span><span class="hl-1">.</span><span class="hl-4">params</span><span class="hl-1">.</span><span class="hl-4">strategyName</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-6">this</span><span class="hl-1">.</span><span class="hl-4">params</span><span class="hl-1">.</span><span class="hl-4">execution</span><span class="hl-1">.</span><span class="hl-4">context</span><span class="hl-1">.</span><span class="hl-4">symbol</span><br/><span class="hl-1">  );</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<p>This method:</p>
<ol>
<li>Updates in-memory <code>_pendingSignal</code> field</li>
<li>Skips disk writes in backtest mode (performance optimization)</li>
<li>Calls <code>PersistSignalAdaper.writeSignalData()</code> for atomic file write in live mode</li>
</ol>
<a id="state-recovery-on-initialization" class="tsd-anchor"></a><h3 class="tsd-anchor-link">State Recovery on Initialization<a href="#state-recovery-on-initialization" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>The <code>waitForInit()</code> method loads persisted state during strategy startup <a href="">src/client/ClientStrategy.ts:146-165</a>, <a href="">src/client/ClientStrategy.ts:209</a>:</p>
<pre><code class="typescript"><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-0">WAIT_FOR_INIT_FN</span><span class="hl-1"> = </span><span class="hl-6">async</span><span class="hl-1"> (</span><span class="hl-4">self</span><span class="hl-1">: </span><span class="hl-10">ClientStrategy</span><span class="hl-1">) </span><span class="hl-6">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-4">self</span><span class="hl-1">.</span><span class="hl-4">params</span><span class="hl-1">.</span><span class="hl-4">logger</span><span class="hl-1">.</span><span class="hl-0">debug</span><span class="hl-1">(</span><span class="hl-2">&quot;ClientStrategy waitForInit&quot;</span><span class="hl-1">);</span><br/><span class="hl-1">  </span><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-4">self</span><span class="hl-1">.</span><span class="hl-4">params</span><span class="hl-1">.</span><span class="hl-4">execution</span><span class="hl-1">.</span><span class="hl-4">context</span><span class="hl-1">.</span><span class="hl-4">backtest</span><span class="hl-1">) {</span><br/><span class="hl-1">    </span><span class="hl-3">return</span><span class="hl-1">;  </span><span class="hl-5">// No state to load in backtest</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">  </span><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">pendingSignal</span><span class="hl-1"> = </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-4">PersistSignalAdaper</span><span class="hl-1">.</span><span class="hl-0">readSignalData</span><span class="hl-1">(</span><br/><span class="hl-1">    </span><span class="hl-4">self</span><span class="hl-1">.</span><span class="hl-4">params</span><span class="hl-1">.</span><span class="hl-4">strategyName</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-4">self</span><span class="hl-1">.</span><span class="hl-4">params</span><span class="hl-1">.</span><span class="hl-4">execution</span><span class="hl-1">.</span><span class="hl-4">context</span><span class="hl-1">.</span><span class="hl-4">symbol</span><br/><span class="hl-1">  );</span><br/><span class="hl-1">  </span><span class="hl-3">if</span><span class="hl-1"> (!</span><span class="hl-4">pendingSignal</span><span class="hl-1">) {</span><br/><span class="hl-1">    </span><span class="hl-3">return</span><span class="hl-1">;  </span><span class="hl-5">// No persisted signal</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">  </span><span class="hl-5">// Validate loaded signal matches current execution context</span><br/><span class="hl-1">  </span><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-4">pendingSignal</span><span class="hl-1">.</span><span class="hl-4">exchangeName</span><span class="hl-1"> !== </span><span class="hl-4">self</span><span class="hl-1">.</span><span class="hl-4">params</span><span class="hl-1">.</span><span class="hl-4">method</span><span class="hl-1">.</span><span class="hl-4">context</span><span class="hl-1">.</span><span class="hl-4">exchangeName</span><span class="hl-1">) {</span><br/><span class="hl-1">    </span><span class="hl-3">return</span><span class="hl-1">;</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">  </span><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-4">pendingSignal</span><span class="hl-1">.</span><span class="hl-4">strategyName</span><span class="hl-1"> !== </span><span class="hl-4">self</span><span class="hl-1">.</span><span class="hl-4">params</span><span class="hl-1">.</span><span class="hl-4">method</span><span class="hl-1">.</span><span class="hl-4">context</span><span class="hl-1">.</span><span class="hl-4">strategyName</span><span class="hl-1">) {</span><br/><span class="hl-1">    </span><span class="hl-3">return</span><span class="hl-1">;</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">  </span><span class="hl-4">self</span><span class="hl-1">.</span><span class="hl-4">_pendingSignal</span><span class="hl-1"> = </span><span class="hl-4">pendingSignal</span><span class="hl-1">;  </span><span class="hl-5">// Restore state</span><br/><span class="hl-1">};</span><br/><br/><span class="hl-4">public</span><span class="hl-1"> </span><span class="hl-4">waitForInit</span><span class="hl-1"> = </span><span class="hl-0">singleshot</span><span class="hl-1">(</span><span class="hl-6">async</span><span class="hl-1"> () </span><span class="hl-6">=&gt;</span><span class="hl-1"> </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-0">WAIT_FOR_INIT_FN</span><span class="hl-1">(</span><span class="hl-6">this</span><span class="hl-1">));</span>
</code><button type="button">Copy</button></pre>

<p>The <code>singleshot</code> wrapper ensures initialization happens exactly once, even if called multiple times.</p>
<a id="persistence-call-sites" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Persistence Call Sites<a href="#persistence-call-sites" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Signal persistence occurs at exactly two points in the lifecycle:</p>
<table>
<thead>
<tr>
<th>Location</th>
<th>State Change</th>
<th>Persisted Value</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="">src/client/ClientStrategy.ts:263</a></td>
<td>Signal opened</td>
<td><code>ISignalRow</code> (new signal)</td>
</tr>
<tr>
<td><a href="">src/client/ClientStrategy.ts:414</a></td>
<td>Signal closed (tick)</td>
<td><code>null</code> (clear state)</td>
</tr>
<tr>
<td><a href="">src/client/ClientStrategy.ts:575</a></td>
<td>Signal closed (backtest)</td>
<td><code>null</code> (clear state)</td>
</tr>
<tr>
<td><a href="">src/client/ClientStrategy.ts:634</a></td>
<td>Signal closed (backtest time_expired)</td>
<td><code>null</code> (clear state)</td>
</tr>
</tbody>
</table>
<p>This ensures:</p>
<ul>
<li>No duplicate signals after crash (cleared on close)</li>
<li>Active signals resume correctly after restart (preserved until close)</li>
<li>Backtest mode skips all disk I/O for performance</li>
</ul>
<p>For detailed persistence implementation, see <a href="design_26_signal_persistence.html">Signal Persistence</a>.</p>
<hr>
<a id="pnl-calculation" class="tsd-anchor"></a><h2 class="tsd-anchor-link">PnL Calculation<a href="#pnl-calculation" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><a id="calculation-function" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Calculation Function<a href="#calculation-function" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Profit and loss calculation occurs in the <code>toProfitLossDto</code> helper function (referenced at <a href="">src/client/ClientStrategy.ts:15</a>). The calculation applies realistic trading costs:</p>
<ol>
<li><strong>Entry Slippage</strong>: ±0.1% on <code>priceOpen</code></li>
<li><strong>Exit Slippage</strong>: ±0.1% on <code>priceClose</code></li>
<li><strong>Trading Fees</strong>: 0.1% entry + 0.1% exit = 0.2% total</li>
</ol>
<p>For long positions:</p>
<ul>
<li>Entry price adjusted up (unfavorable): <code>priceOpen * 1.001</code></li>
<li>Exit price adjusted down (unfavorable): <code>priceClose * 0.999</code></li>
</ul>
<p>For short positions:</p>
<ul>
<li>Entry price adjusted down (unfavorable): <code>priceOpen * 0.999</code></li>
<li>Exit price adjusted up (unfavorable): <code>priceClose * 1.001</code></li>
</ul>
<a id="usage-in-clientstrategy" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Usage in ClientStrategy<a href="#usage-in-clientstrategy" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>PnL calculation is called when a signal closes in both <code>tick()</code> and <code>backtest()</code> methods:</p>
<table>
<thead>
<tr>
<th>Method</th>
<th>Call Site</th>
<th>Context</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>tick()</code></td>
<td><a href="">src/client/ClientStrategy.ts:375</a></td>
<td>Live or backtest real-time closure</td>
</tr>
<tr>
<td><code>backtest()</code></td>
<td><a href="">src/client/ClientStrategy.ts:544</a></td>
<td>Backtest TP/SL hit</td>
</tr>
<tr>
<td><code>backtest()</code></td>
<td><a href="">src/client/ClientStrategy.ts:606</a></td>
<td>Backtest time_expired</td>
</tr>
</tbody>
</table>
<p>Example call:</p>
<pre><code class="typescript"><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">pnl</span><span class="hl-1"> = </span><span class="hl-0">toProfitLossDto</span><span class="hl-1">(</span><span class="hl-4">signal</span><span class="hl-1">, </span><span class="hl-4">averagePrice</span><span class="hl-1">);</span><br/><span class="hl-5">// pnl.pnlPercentage: e.g., 1.5 for +1.5% profit</span><br/><span class="hl-5">// pnl.priceOpen: adjusted entry price with fees/slippage</span><br/><span class="hl-5">// pnl.priceClose: adjusted exit price with fees/slippage</span>
</code><button type="button">Copy</button></pre>

<a id="loss-warnings" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Loss Warnings<a href="#loss-warnings" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>ClientStrategy logs warnings when signals close at a loss:</p>
<table>
<thead>
<tr>
<th>Condition</th>
<th>Log Level</th>
<th>Message Pattern</th>
</tr>
</thead>
<tbody>
<tr>
<td>Stop Loss hit (tick)</td>
<td><code>warn</code></td>
<td><code>&quot;Signal closed with loss (stop_loss), PNL: {percentage}%&quot;</code></td>
</tr>
<tr>
<td>Time expired with loss (tick)</td>
<td><code>warn</code></td>
<td><code>&quot;Signal closed with loss (time_expired), PNL: {percentage}%&quot;</code></td>
</tr>
<tr>
<td>Stop Loss hit (backtest)</td>
<td><code>warn</code></td>
<td><code>&quot;Signal closed with loss (stop_loss), PNL: {percentage}%&quot;</code></td>
</tr>
<tr>
<td>Time expired with loss (backtest)</td>
<td><code>warn</code></td>
<td><code>&quot;Signal closed with loss (time_expired), PNL: {percentage}%&quot;</code></td>
</tr>
</tbody>
</table>
<p>These warnings occur at:</p>
<ul>
<li><a href="">src/client/ClientStrategy.ts:379-384</a> (tick stop_loss)</li>
<li><a href="">src/client/ClientStrategy.ts:388-393</a> (tick time_expired)</li>
<li><a href="">src/client/ClientStrategy.ts:558-563</a> (backtest stop_loss)</li>
<li><a href="">src/client/ClientStrategy.ts:617-622</a> (backtest time_expired)</li>
</ul>
<p>For detailed PnL calculation implementation, see <a href="design_27_pnl_calculation.html">PnL Calculation</a>.</p>
<hr>
<a id="summary" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Summary<a href="#summary" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>The signal lifecycle in backtest-kit follows a deterministic state machine with four discrete states (idle, opened, active, closed) represented using TypeScript discriminated unions. The <code>ClientStrategy</code> class in <a href="">src/client/ClientStrategy.ts</a> orchestrates all state transitions, applying comprehensive validation rules, throttling signal generation by configurable intervals, monitoring active signals against VWAP-based TP/SL conditions, and calculating realistic PnL including fees (0.2%) and slippage (0.2% total).</p>
<p>In live trading mode, all state changes are atomically persisted to disk via <code>PersistSignalAdapter</code> before yielding results, enabling crash-safe recovery. In backtest mode, the <code>backtest()</code> method provides fast-forward simulation by iterating through historical candles without intermediate state persistence, always returning a closed result.</p>
<p>The discriminated union type system ensures type-safe handling of all states, with the <code>action</code> field serving as the discriminator for pattern matching.</p>
</div></div><div class="col-sidebar"><div class="page-menu"><div class="tsd-navigation settings"><details class="tsd-accordion"><summary class="tsd-accordion-summary"><h3><svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-chevronDown"></use></svg>Settings</h3></summary><div class="tsd-accordion-details"><div class="tsd-filter-visibility"><span class="settings-label">Member Visibility</span><ul id="tsd-filter-options"><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-protected" name="protected"/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Protected</span></label></li><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-inherited" name="inherited" checked/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Inherited</span></label></li><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-external" name="external"/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>External</span></label></li></ul></div><div class="tsd-theme-toggle"><label class="settings-label" for="tsd-theme">Theme</label><select id="tsd-theme"><option value="os">OS</option><option value="light">Light</option><option value="dark">Dark</option></select></div></div></details></div><details open class="tsd-accordion tsd-page-navigation"><summary class="tsd-accordion-summary"><h3><svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-chevronDown"></use></svg>On This Page</h3></summary><div class="tsd-accordion-details"><a href="#signal-lifecycle"><span>Signal <wbr/>Lifecycle</span></a><ul><li><a href="#purpose-and-scope"><span>Purpose and <wbr/>Scope</span></a></li><li><a href="#signal-state-overview"><span>Signal <wbr/>State <wbr/>Overview</span></a></li><li><ul><li><a href="#state-summary-table"><span>State <wbr/>Summary <wbr/>Table</span></a></li></ul></li><li><a href="#signal-data-structures"><span>Signal <wbr/>Data <wbr/>Structures</span></a></li><li><ul><li><a href="#core-signal-types"><span>Core <wbr/>Signal <wbr/>Types</span></a></li><li><a href="#signal-dto-to-signal-row-transformation"><span>Signal DTO to <wbr/>Signal <wbr/>Row <wbr/>Transformation</span></a></li><li><a href="#discriminated-union-structure"><span>Discriminated <wbr/>Union <wbr/>Structure</span></a></li></ul></li><li><a href="#signal-generation-and-throttling"><span>Signal <wbr/>Generation and <wbr/>Throttling</span></a></li><li><ul><li><a href="#generation-flow"><span>Generation <wbr/>Flow</span></a></li><li><a href="#throttling-intervals"><span>Throttling <wbr/>Intervals</span></a></li></ul></li><li><a href="#signal-validation"><span>Signal <wbr/>Validation</span></a></li><li><ul><li><a href="#validation-rules"><span>Validation <wbr/>Rules</span></a></li><li><ul><li><a href="#price-validation"><span>Price <wbr/>Validation</span></a></li><li><a href="#long-position-validation"><span>Long <wbr/>Position <wbr/>Validation</span></a></li><li><a href="#short-position-validation"><span>Short <wbr/>Position <wbr/>Validation</span></a></li><li><a href="#temporal-validation"><span>Temporal <wbr/>Validation</span></a></li></ul></li><li><a href="#validation-error-handling"><span>Validation <wbr/>Error <wbr/>Handling</span></a></li></ul></li><li><a href="#monitoring-active-signals-tick-method"><span>Monitoring <wbr/>Active <wbr/>Signals (tick <wbr/>Method)</span></a></li><li><ul><li><a href="#execution-flow"><span>Execution <wbr/>Flow</span></a></li><li><a href="#close-condition-logic"><span>Close <wbr/>Condition <wbr/>Logic</span></a></li><li><ul><li><a href="#time-expiration-check"><span>Time <wbr/>Expiration <wbr/>Check</span></a></li><li><a href="#long-position-tpsl-check"><span>Long <wbr/>Position TP/SL <wbr/>Check</span></a></li><li><a href="#short-position-tpsl-check"><span>Short <wbr/>Position TP/SL <wbr/>Check</span></a></li></ul></li></ul></li><li><a href="#fast-forward-backtest-simulation"><span>Fast-<wbr/>Forward <wbr/>Backtest <wbr/>Simulation</span></a></li><li><ul><li><a href="#method-overview"><span>Method <wbr/>Overview</span></a></li><li><a href="#backtest-vs-tick-comparison"><span>Backtest vs <wbr/>Tick <wbr/>Comparison</span></a></li><li><a href="#backtest-execution-flow"><span>Backtest <wbr/>Execution <wbr/>Flow</span></a></li><li><a href="#vwap-calculation-for-backtest"><span>VWAP <wbr/>Calculation for <wbr/>Backtest</span></a></li></ul></li><li><a href="#signal-persistence-and-crash-recovery"><span>Signal <wbr/>Persistence and <wbr/>Crash <wbr/>Recovery</span></a></li><li><ul><li><a href="#setpendingsignal-method"><span>set<wbr/>Pending<wbr/>Signal <wbr/>Method</span></a></li><li><a href="#state-recovery-on-initialization"><span>State <wbr/>Recovery on <wbr/>Initialization</span></a></li><li><a href="#persistence-call-sites"><span>Persistence <wbr/>Call <wbr/>Sites</span></a></li></ul></li><li><a href="#pnl-calculation"><span>Pn<wbr/>L <wbr/>Calculation</span></a></li><li><ul><li><a href="#calculation-function"><span>Calculation <wbr/>Function</span></a></li><li><a href="#usage-in-clientstrategy"><span>Usage in <wbr/>Client<wbr/>Strategy</span></a></li><li><a href="#loss-warnings"><span>Loss <wbr/>Warnings</span></a></li></ul></li><li><a href="#summary"><span>Summary</span></a></li></ul></div></details></div><div class="site-menu"><nav class="tsd-navigation"><a href="../modules.html">backtest-kit</a><ul class="tsd-small-nested-navigation" id="tsd-nav-container"><li>Loading...</li></ul></nav></div></div></div><footer><p class="tsd-generator">Generated using <a href="https://typedoc.org/" target="_blank">TypeDoc</a></p></footer><div class="overlay"></div></body></html>

<!-- Yandex.Metrika counter -->
<script type="text/javascript">
    (function(m,e,t,r,i,k,a){
        m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
        m[i].l=1*new Date();
        for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }}
        k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)
    })(window, document,'script','https://mc.yandex.ru/metrika/tag.js?id=105455585', 'ym');

    ym(105455585, 'init', {ssr:true, webvisor:true, clickmap:true, ecommerce:"dataLayer", accurateTrackBounce:true, trackLinks:true});
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/105455585" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
<!-- /Yandex.Metrika counter -->

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-3MQZEBBDDR"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-3MQZEBBDDR');
</script>
