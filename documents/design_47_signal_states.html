<!DOCTYPE html><html class="default" lang="en" data-base=".."><head><meta charset="utf-8"/><meta http-equiv="x-ua-compatible" content="IE=edge"/><title>design/47_signal_states | backtest-kit</title><meta name="description" content="Documentation for backtest-kit"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="stylesheet" href="../assets/style.css"/><link rel="stylesheet" href="../assets/highlight.css"/><script defer src="../assets/main.js"></script><script async src="../assets/icons.js" id="tsd-icons-script"></script><script async src="../assets/search.js" id="tsd-search-script"></script><script async src="../assets/navigation.js" id="tsd-nav-script"></script><script async src="../assets/hierarchy.js" id="tsd-hierarchy-script"></script></head><body><script>document.documentElement.dataset.theme = localStorage.getItem("tsd-theme") || "os";document.body.style.display="none";setTimeout(() => app?app.showPage():document.body.style.removeProperty("display"),500)</script><header class="tsd-page-toolbar"><div class="tsd-toolbar-contents container"><div class="table-cell" id="tsd-search"><div class="field"><label for="tsd-search-field" class="tsd-widget tsd-toolbar-icon search no-caption"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-search"></use></svg></label><input type="text" id="tsd-search-field" aria-label="Search"/></div><div class="field"><div id="tsd-toolbar-links"></div></div><ul class="results"><li class="state loading">Preparing search index...</li><li class="state failure">The search index is not available</li></ul><a href="../index.html" class="title">backtest-kit</a></div><div class="table-cell" id="tsd-widgets"><a href="#" class="tsd-widget tsd-toolbar-icon menu no-caption" data-toggle="menu" aria-label="Menu"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-menu"></use></svg></a></div></div></header><div class="container container-main"><div class="col-content"><div class="tsd-page-title"><ul class="tsd-breadcrumb"><li><a href="../modules.html">backtest-kit</a></li><li><a href="design_47_signal_states.html">design/47_signal_states</a></li></ul></div><div class="tsd-panel tsd-typography"><a id="signal-states" class="tsd-anchor"></a><h1 class="tsd-anchor-link">Signal States<a href="#signal-states" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h1><p>This page defines the six distinct states a trading signal can occupy during its lifecycle: <strong>idle</strong>, <strong>scheduled</strong>, <strong>opened</strong>, <strong>active</strong>, <strong>closed</strong>, and <strong>cancelled</strong>. Each state represents a specific phase of signal execution with well-defined entry conditions, exit conditions, and behaviors. Understanding these states is critical for implementing strategies, monitoring execution, and debugging signal lifecycle issues.</p>
<p>For information about signal generation and validation rules, see <a href="design_48_signal_generation_and_validation.html">Signal Generation and Validation</a>. For details on scheduled signal behavior and activation, see <a href="design_49_scheduled_signals.html">Scheduled Signals</a>. For crash recovery and state persistence, see <a href="design_50_signal_persistence.html">Signal Persistence</a>.</p>
<hr>
<a id="state-overview" class="tsd-anchor"></a><h2 class="tsd-anchor-link">State Overview<a href="#state-overview" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>The framework models signal lifecycle as a deterministic state machine with six states:</p>
<table>
<thead>
<tr>
<th>State</th>
<th>Description</th>
<th>Internal Flag</th>
<th>Terminal State</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>idle</strong></td>
<td>No active signal; strategy waiting for entry conditions</td>
<td><code>_pendingSignal === null &amp;&amp; _scheduledSignal === null</code></td>
<td>No</td>
</tr>
<tr>
<td><strong>scheduled</strong></td>
<td>Limit order waiting for <code>priceOpen</code> activation</td>
<td><code>_scheduledSignal !== null</code></td>
<td>No</td>
</tr>
<tr>
<td><strong>opened</strong></td>
<td>Signal just created and position opened</td>
<td><code>_pendingSignal !== null</code> (first tick after creation)</td>
<td>No</td>
</tr>
<tr>
<td><strong>active</strong></td>
<td>Position being monitored for TP/SL/timeout</td>
<td><code>_pendingSignal !== null</code> (subsequent ticks)</td>
<td>No</td>
</tr>
<tr>
<td><strong>closed</strong></td>
<td>Position closed with realized PnL</td>
<td><code>_pendingSignal === null</code> (after TP/SL/timeout)</td>
<td>Yes</td>
</tr>
<tr>
<td><strong>cancelled</strong></td>
<td>Scheduled signal cancelled without opening</td>
<td><code>_scheduledSignal === null</code> (after timeout/SL)</td>
<td>Yes</td>
</tr>
</tbody>
</table>
<ul>
<li><a href="">src/interfaces/Strategy.interface.ts:173-289</a></li>
<li><a href="">src/client/ClientStrategy.ts:1-100</a></li>
<li><a href="">types.d.ts:853-965</a></li>
</ul>
<hr>
<a id="state-definitions" class="tsd-anchor"></a><h2 class="tsd-anchor-link">State Definitions<a href="#state-definitions" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><a id="1-idle-state" class="tsd-anchor"></a><h3 class="tsd-anchor-link">1. Idle State<a href="#1-idle-state" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><strong>Discriminator:</strong> <code>action: &quot;idle&quot;</code></p>
<p>The idle state indicates no active trading position exists. The strategy is evaluating market conditions via <code>getSignal()</code> but has not yet generated a valid signal that passes risk validation. This is the default state at strategy initialization and after signal closure.</p>
<p><strong>Characteristics:</strong></p>
<ul>
<li><code>signal</code> field is <code>null</code></li>
<li><code>getSignal()</code> called on every tick (subject to interval throttling)</li>
<li>Risk checks performed via <code>checkSignal()</code> before signal creation</li>
<li>Callback: <code>onIdle(symbol, currentPrice, backtest)</code> triggered</li>
</ul>
<p><strong>State Tracking:</strong></p>
<pre><code class="typescript"><span class="hl-5">// Internal ClientStrategy state</span><br/><span class="hl-12">_pendingSignal</span><span class="hl-1">: </span><span class="hl-4">ISignalRow</span><span class="hl-1"> | </span><span class="hl-6">null</span><span class="hl-1"> = </span><span class="hl-6">null</span><span class="hl-1">;</span><br/><span class="hl-12">_scheduledSignal</span><span class="hl-1">: </span><span class="hl-4">IScheduledSignalRow</span><span class="hl-1"> | </span><span class="hl-6">null</span><span class="hl-1"> = </span><span class="hl-6">null</span><span class="hl-1">;</span><br/><span class="hl-5">// idle when both are null</span>
</code><button type="button">Copy</button></pre>

<p><strong>Type Definition:</strong></p>
<pre><code class="typescript"><span class="hl-6">interface</span><span class="hl-1"> </span><span class="hl-10">IStrategyTickResultIdle</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-4">action</span><span class="hl-1">: </span><span class="hl-2">&quot;idle&quot;</span><span class="hl-1">;</span><br/><span class="hl-1">  </span><span class="hl-4">signal</span><span class="hl-1">: </span><span class="hl-10">null</span><span class="hl-1">;</span><br/><span class="hl-1">  </span><span class="hl-4">strategyName</span><span class="hl-1">: </span><span class="hl-10">StrategyName</span><span class="hl-1">;</span><br/><span class="hl-1">  </span><span class="hl-4">exchangeName</span><span class="hl-1">: </span><span class="hl-10">ExchangeName</span><span class="hl-1">;</span><br/><span class="hl-1">  </span><span class="hl-4">symbol</span><span class="hl-1">: </span><span class="hl-10">string</span><span class="hl-1">;</span><br/><span class="hl-1">  </span><span class="hl-4">currentPrice</span><span class="hl-1">: </span><span class="hl-10">number</span><span class="hl-1">;</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<ul>
<li><a href="">src/interfaces/Strategy.interface.ts:173-186</a></li>
<li><a href="">src/client/ClientStrategy.ts:263-310</a></li>
<li><a href="">types.d.ts:853-867</a></li>
</ul>
<hr>
<a id="2-scheduled-state" class="tsd-anchor"></a><h3 class="tsd-anchor-link">2. Scheduled State<a href="#2-scheduled-state" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><strong>Discriminator:</strong> <code>action: &quot;scheduled&quot;</code></p>
<p>A scheduled signal represents a limit order waiting for price to reach the specified <code>priceOpen</code> entry point. This state exists when <code>getSignal()</code> returns a signal with an explicit <code>priceOpen</code> value that differs from the current market price.</p>
<p><strong>Characteristics:</strong></p>
<ul>
<li><code>priceOpen</code> explicitly specified in signal DTO</li>
<li>Position has NOT yet opened (no risk capital committed)</li>
<li>Waiting for market price to reach <code>priceOpen</code> for activation</li>
<li>Subject to timeout cancellation (default: 120 minutes via <code>CC_SCHEDULE_AWAIT_MINUTES</code>)</li>
<li>Subject to pre-activation SL cancellation if price moves adversely</li>
<li>Callback: <code>onSchedule(symbol, data, currentPrice, backtest)</code> triggered</li>
</ul>
<p><strong>Activation Conditions:</strong></p>
<pre><code class="typescript"><span class="hl-5">// LONG: activate when currentPrice &lt;= priceOpen</span><br/><span class="hl-5">// SHORT: activate when currentPrice &gt;= priceOpen</span><br/><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">shouldActivate</span><span class="hl-1"> = </span><br/><span class="hl-1">  (</span><span class="hl-4">signal</span><span class="hl-1">.</span><span class="hl-4">position</span><span class="hl-1"> === </span><span class="hl-2">&quot;long&quot;</span><span class="hl-1"> &amp;&amp; </span><span class="hl-4">currentPrice</span><span class="hl-1"> &lt;= </span><span class="hl-4">signal</span><span class="hl-1">.</span><span class="hl-4">priceOpen</span><span class="hl-1">) ||</span><br/><span class="hl-1">  (</span><span class="hl-4">signal</span><span class="hl-1">.</span><span class="hl-4">position</span><span class="hl-1"> === </span><span class="hl-2">&quot;short&quot;</span><span class="hl-1"> &amp;&amp; </span><span class="hl-4">currentPrice</span><span class="hl-1"> &gt;= </span><span class="hl-4">signal</span><span class="hl-1">.</span><span class="hl-4">priceOpen</span><span class="hl-1">);</span>
</code><button type="button">Copy</button></pre>

<p><strong>Cancellation Conditions:</strong></p>
<ul>
<li><strong>Timeout:</strong> <code>(currentTime - scheduledAt) &gt;= CC_SCHEDULE_AWAIT_MINUTES * 60000</code></li>
<li><strong>Pre-activation SL:</strong> Price crosses StopLoss before reaching <code>priceOpen</code></li>
<li><strong>Risk rejection:</strong> Risk check fails at activation time</li>
</ul>
<p><strong>Type Definition:</strong></p>
<pre><code class="typescript"><span class="hl-6">interface</span><span class="hl-1"> </span><span class="hl-10">IStrategyTickResultScheduled</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-4">action</span><span class="hl-1">: </span><span class="hl-2">&quot;scheduled&quot;</span><span class="hl-1">;</span><br/><span class="hl-1">  </span><span class="hl-4">signal</span><span class="hl-1">: </span><span class="hl-10">IScheduledSignalRow</span><span class="hl-1">;</span><br/><span class="hl-1">  </span><span class="hl-4">strategyName</span><span class="hl-1">: </span><span class="hl-10">StrategyName</span><span class="hl-1">;</span><br/><span class="hl-1">  </span><span class="hl-4">exchangeName</span><span class="hl-1">: </span><span class="hl-10">ExchangeName</span><span class="hl-1">;</span><br/><span class="hl-1">  </span><span class="hl-4">symbol</span><span class="hl-1">: </span><span class="hl-10">string</span><span class="hl-1">;</span><br/><span class="hl-1">  </span><span class="hl-4">currentPrice</span><span class="hl-1">: </span><span class="hl-10">number</span><span class="hl-1">;</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<ul>
<li><a href="">src/interfaces/Strategy.interface.ts:192-205</a></li>
<li><a href="">src/client/ClientStrategy.ts:312-367</a></li>
<li><a href="">src/client/ClientStrategy.ts:530-564</a></li>
<li><a href="">types.d.ts:871-885</a></li>
</ul>
<hr>
<a id="3-opened-state" class="tsd-anchor"></a><h3 class="tsd-anchor-link">3. Opened State<a href="#3-opened-state" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><strong>Discriminator:</strong> <code>action: &quot;opened&quot;</code></p>
<p>The opened state represents the first tick immediately after signal creation and position opening. This is a transient state that transitions to <strong>active</strong> on the next tick. It signals that capital has been committed and the position is now being monitored.</p>
<p><strong>Characteristics:</strong></p>
<ul>
<li>Position just created (market order or scheduled activation)</li>
<li><code>pendingAt</code> timestamp set to current time</li>
<li>Risk capital now allocated (tracked via <code>addSignal()</code>)</li>
<li>Callback: <code>onOpen(symbol, data, currentPrice, backtest)</code> triggered</li>
<li>Next tick will transition to <strong>active</strong> state</li>
</ul>
<p><strong>Creation Paths:</strong></p>
<ol>
<li><strong>Immediate Market Order:</strong> <code>getSignal()</code> returns signal without <code>priceOpen</code> → opens at current VWAP</li>
<li><strong>Scheduled Activation:</strong> Scheduled signal reaches <code>priceOpen</code> and passes risk re-check</li>
</ol>
<p><strong>Type Definition:</strong></p>
<pre><code class="typescript"><span class="hl-6">interface</span><span class="hl-1"> </span><span class="hl-10">IStrategyTickResultOpened</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-4">action</span><span class="hl-1">: </span><span class="hl-2">&quot;opened&quot;</span><span class="hl-1">;</span><br/><span class="hl-1">  </span><span class="hl-4">signal</span><span class="hl-1">: </span><span class="hl-10">ISignalRow</span><span class="hl-1">;</span><br/><span class="hl-1">  </span><span class="hl-4">strategyName</span><span class="hl-1">: </span><span class="hl-10">StrategyName</span><span class="hl-1">;</span><br/><span class="hl-1">  </span><span class="hl-4">exchangeName</span><span class="hl-1">: </span><span class="hl-10">ExchangeName</span><span class="hl-1">;</span><br/><span class="hl-1">  </span><span class="hl-4">symbol</span><span class="hl-1">: </span><span class="hl-10">string</span><span class="hl-1">;</span><br/><span class="hl-1">  </span><span class="hl-4">currentPrice</span><span class="hl-1">: </span><span class="hl-10">number</span><span class="hl-1">;</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<ul>
<li><a href="">src/interfaces/Strategy.interface.ts:211-224</a></li>
<li><a href="">src/client/ClientStrategy.ts:765-815</a></li>
<li><a href="">src/client/ClientStrategy.ts:601-693</a></li>
<li><a href="">types.d.ts:887-903</a></li>
</ul>
<hr>
<a id="4-active-state" class="tsd-anchor"></a><h3 class="tsd-anchor-link">4. Active State<a href="#4-active-state" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><strong>Discriminator:</strong> <code>action: &quot;active&quot;</code></p>
<p>The active state represents ongoing position monitoring. The strategy continuously checks market price against Take Profit, Stop Loss, and time expiration conditions. This state persists until one of the exit conditions is met.</p>
<p><strong>Characteristics:</strong></p>
<ul>
<li>Position opened and being monitored</li>
<li>VWAP calculated on every tick via <code>getAveragePrice()</code></li>
<li>TP/SL/timeout conditions checked continuously</li>
<li>Partial profit/loss tracking active (10%, 20%, 30% milestones)</li>
<li>Callback: <code>onActive(symbol, data, currentPrice, backtest)</code> triggered</li>
<li>Callbacks: <code>onPartialProfit()</code> / <code>onPartialLoss()</code> triggered at milestones</li>
</ul>
<p><strong>Exit Condition Checks:</strong></p>
<pre><code class="typescript"><span class="hl-5">// Time expiration</span><br/><span class="hl-3">if</span><span class="hl-1"> ((</span><span class="hl-4">currentTime</span><span class="hl-1"> - </span><span class="hl-4">signal</span><span class="hl-1">.</span><span class="hl-4">pendingAt</span><span class="hl-1">) &gt;= </span><span class="hl-4">signal</span><span class="hl-1">.</span><span class="hl-4">minuteEstimatedTime</span><span class="hl-1"> * </span><span class="hl-8">60000</span><span class="hl-1">) {</span><br/><span class="hl-1">  </span><span class="hl-5">// Close with reason: &quot;time_expired&quot;</span><br/><span class="hl-1">}</span><br/><br/><span class="hl-5">// Take Profit</span><br/><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-4">signal</span><span class="hl-1">.</span><span class="hl-4">position</span><span class="hl-1"> === </span><span class="hl-2">&quot;long&quot;</span><span class="hl-1"> &amp;&amp; </span><span class="hl-4">currentPrice</span><span class="hl-1"> &gt;= </span><span class="hl-4">signal</span><span class="hl-1">.</span><span class="hl-4">priceTakeProfit</span><span class="hl-1">) {</span><br/><span class="hl-1">  </span><span class="hl-5">// Close with reason: &quot;take_profit&quot;</span><br/><span class="hl-1">}</span><br/><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-4">signal</span><span class="hl-1">.</span><span class="hl-4">position</span><span class="hl-1"> === </span><span class="hl-2">&quot;short&quot;</span><span class="hl-1"> &amp;&amp; </span><span class="hl-4">currentPrice</span><span class="hl-1"> &lt;= </span><span class="hl-4">signal</span><span class="hl-1">.</span><span class="hl-4">priceTakeProfit</span><span class="hl-1">) {</span><br/><span class="hl-1">  </span><span class="hl-5">// Close with reason: &quot;take_profit&quot;</span><br/><span class="hl-1">}</span><br/><br/><span class="hl-5">// Stop Loss</span><br/><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-4">signal</span><span class="hl-1">.</span><span class="hl-4">position</span><span class="hl-1"> === </span><span class="hl-2">&quot;long&quot;</span><span class="hl-1"> &amp;&amp; </span><span class="hl-4">currentPrice</span><span class="hl-1"> &lt;= </span><span class="hl-4">signal</span><span class="hl-1">.</span><span class="hl-4">priceStopLoss</span><span class="hl-1">) {</span><br/><span class="hl-1">  </span><span class="hl-5">// Close with reason: &quot;stop_loss&quot;</span><br/><span class="hl-1">}</span><br/><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-4">signal</span><span class="hl-1">.</span><span class="hl-4">position</span><span class="hl-1"> === </span><span class="hl-2">&quot;short&quot;</span><span class="hl-1"> &amp;&amp; </span><span class="hl-4">currentPrice</span><span class="hl-1"> &gt;= </span><span class="hl-4">signal</span><span class="hl-1">.</span><span class="hl-4">priceStopLoss</span><span class="hl-1">) {</span><br/><span class="hl-1">  </span><span class="hl-5">// Close with reason: &quot;stop_loss&quot;</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<p><strong>Type Definition:</strong></p>
<pre><code class="typescript"><span class="hl-6">interface</span><span class="hl-1"> </span><span class="hl-10">IStrategyTickResultActive</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-4">action</span><span class="hl-1">: </span><span class="hl-2">&quot;active&quot;</span><span class="hl-1">;</span><br/><span class="hl-1">  </span><span class="hl-4">signal</span><span class="hl-1">: </span><span class="hl-10">ISignalRow</span><span class="hl-1">;</span><br/><span class="hl-1">  </span><span class="hl-4">currentPrice</span><span class="hl-1">: </span><span class="hl-10">number</span><span class="hl-1">;</span><br/><span class="hl-1">  </span><span class="hl-4">strategyName</span><span class="hl-1">: </span><span class="hl-10">StrategyName</span><span class="hl-1">;</span><br/><span class="hl-1">  </span><span class="hl-4">exchangeName</span><span class="hl-1">: </span><span class="hl-10">ExchangeName</span><span class="hl-1">;</span><br/><span class="hl-1">  </span><span class="hl-4">symbol</span><span class="hl-1">: </span><span class="hl-10">string</span><span class="hl-1">;</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<ul>
<li><a href="">src/interfaces/Strategy.interface.ts:230-243</a></li>
<li><a href="">src/client/ClientStrategy.ts:817-876</a></li>
<li><a href="">src/client/ClientStrategy.ts:917-959</a></li>
<li><a href="">types.d.ts:905-922</a></li>
</ul>
<hr>
<a id="5-closed-state" class="tsd-anchor"></a><h3 class="tsd-anchor-link">5. Closed State<a href="#5-closed-state" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><strong>Discriminator:</strong> <code>action: &quot;closed&quot;</code></p>
<p>The closed state is a terminal state indicating the position has been closed with realized profit or loss. This state includes the final close price, close reason, and calculated PnL with fees and slippage.</p>
<p><strong>Characteristics:</strong></p>
<ul>
<li>Position closed and capital released</li>
<li><code>closeReason</code> specifies why closure occurred</li>
<li><code>pnl</code> object contains realized profit/loss percentage</li>
<li>Risk capital deallocated (tracked via <code>removeSignal()</code>)</li>
<li>Callback: <code>onClose(symbol, data, priceClose, backtest)</code> triggered</li>
<li>Partial profit/loss state cleared via <code>partial.clear()</code></li>
<li>Returns to <strong>idle</strong> state on next tick</li>
</ul>
<p><strong>Close Reasons:</strong></p>
<ul>
<li><code>&quot;take_profit&quot;</code> - Price reached <code>priceTakeProfit</code> target</li>
<li><code>&quot;stop_loss&quot;</code> - Price hit <code>priceStopLoss</code> exit</li>
<li><code>&quot;time_expired&quot;</code> - Signal exceeded <code>minuteEstimatedTime</code> duration</li>
</ul>
<p><strong>PnL Calculation:</strong>
The <code>pnl</code> object includes:</p>
<ul>
<li><code>pnlPercentage</code> - Profit/loss as percentage (e.g., +1.5% or -2.3%)</li>
<li><code>priceOpen</code> - Entry price adjusted with fees (0.1%) and slippage (0.1%)</li>
<li><code>priceClose</code> - Exit price adjusted with fees (0.1%) and slippage (0.1%)</li>
</ul>
<p><strong>Type Definition:</strong></p>
<pre><code class="typescript"><span class="hl-6">interface</span><span class="hl-1"> </span><span class="hl-10">IStrategyTickResultClosed</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-4">action</span><span class="hl-1">: </span><span class="hl-2">&quot;closed&quot;</span><span class="hl-1">;</span><br/><span class="hl-1">  </span><span class="hl-4">signal</span><span class="hl-1">: </span><span class="hl-10">ISignalRow</span><span class="hl-1">;</span><br/><span class="hl-1">  </span><span class="hl-4">currentPrice</span><span class="hl-1">: </span><span class="hl-10">number</span><span class="hl-1">;</span><br/><span class="hl-1">  </span><span class="hl-4">closeReason</span><span class="hl-1">: </span><span class="hl-2">&quot;time_expired&quot;</span><span class="hl-1"> | </span><span class="hl-2">&quot;take_profit&quot;</span><span class="hl-1"> | </span><span class="hl-2">&quot;stop_loss&quot;</span><span class="hl-1">;</span><br/><span class="hl-1">  </span><span class="hl-4">closeTimestamp</span><span class="hl-1">: </span><span class="hl-10">number</span><span class="hl-1">;</span><br/><span class="hl-1">  </span><span class="hl-4">pnl</span><span class="hl-1">: </span><span class="hl-10">IStrategyPnL</span><span class="hl-1">;</span><br/><span class="hl-1">  </span><span class="hl-4">strategyName</span><span class="hl-1">: </span><span class="hl-10">StrategyName</span><span class="hl-1">;</span><br/><span class="hl-1">  </span><span class="hl-4">exchangeName</span><span class="hl-1">: </span><span class="hl-10">ExchangeName</span><span class="hl-1">;</span><br/><span class="hl-1">  </span><span class="hl-4">symbol</span><span class="hl-1">: </span><span class="hl-10">string</span><span class="hl-1">;</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<ul>
<li><a href="">src/interfaces/Strategy.interface.ts:249-268</a></li>
<li><a href="">src/client/ClientStrategy.ts:878-959</a></li>
<li><a href="">src/helpers/toProfitLossDto.ts:1-50</a></li>
<li><a href="">types.d.ts:924-945</a></li>
</ul>
<hr>
<a id="6-cancelled-state" class="tsd-anchor"></a><h3 class="tsd-anchor-link">6. Cancelled State<a href="#6-cancelled-state" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><strong>Discriminator:</strong> <code>action: &quot;cancelled&quot;</code></p>
<p>The cancelled state is a terminal state for scheduled signals that were cancelled without opening a position. This occurs when the scheduled signal fails to activate within the timeout window or is invalidated by pre-activation Stop Loss.</p>
<p><strong>Characteristics:</strong></p>
<ul>
<li>Scheduled signal cancelled before opening</li>
<li>No capital was committed (no trade executed)</li>
<li>No PnL impact (no fees paid)</li>
<li>Callback: <code>onCancel(symbol, data, currentPrice, backtest)</code> triggered</li>
<li>Returns to <strong>idle</strong> state on next tick</li>
</ul>
<p><strong>Cancellation Reasons:</strong></p>
<ol>
<li><strong>Timeout:</strong> Signal waited longer than <code>CC_SCHEDULE_AWAIT_MINUTES</code> (default: 120 minutes)</li>
<li><strong>Pre-activation SL:</strong> Price crossed Stop Loss before reaching <code>priceOpen</code></li>
<li><strong>Risk rejection:</strong> Risk check failed at activation time (signal destroyed without callback)</li>
</ol>
<p><strong>Pre-activation SL Logic:</strong></p>
<pre><code class="typescript"><span class="hl-5">// LONG: cancel if price drops below SL before reaching priceOpen</span><br/><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-4">signal</span><span class="hl-1">.</span><span class="hl-4">position</span><span class="hl-1"> === </span><span class="hl-2">&quot;long&quot;</span><span class="hl-1"> &amp;&amp; </span><span class="hl-4">currentPrice</span><span class="hl-1"> &lt;= </span><span class="hl-4">signal</span><span class="hl-1">.</span><span class="hl-4">priceStopLoss</span><span class="hl-1">) {</span><br/><span class="hl-1">  </span><span class="hl-5">// Cancel without opening</span><br/><span class="hl-1">}</span><br/><br/><span class="hl-5">// SHORT: cancel if price rises above SL before reaching priceOpen</span><br/><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-4">signal</span><span class="hl-1">.</span><span class="hl-4">position</span><span class="hl-1"> === </span><span class="hl-2">&quot;short&quot;</span><span class="hl-1"> &amp;&amp; </span><span class="hl-4">currentPrice</span><span class="hl-1"> &gt;= </span><span class="hl-4">signal</span><span class="hl-1">.</span><span class="hl-4">priceStopLoss</span><span class="hl-1">) {</span><br/><span class="hl-1">  </span><span class="hl-5">// Cancel without opening</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<p><strong>Type Definition:</strong></p>
<pre><code class="typescript"><span class="hl-6">interface</span><span class="hl-1"> </span><span class="hl-10">IStrategyTickResultCancelled</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-4">action</span><span class="hl-1">: </span><span class="hl-2">&quot;cancelled&quot;</span><span class="hl-1">;</span><br/><span class="hl-1">  </span><span class="hl-4">signal</span><span class="hl-1">: </span><span class="hl-10">IScheduledSignalRow</span><span class="hl-1">;</span><br/><span class="hl-1">  </span><span class="hl-4">currentPrice</span><span class="hl-1">: </span><span class="hl-10">number</span><span class="hl-1">;</span><br/><span class="hl-1">  </span><span class="hl-4">closeTimestamp</span><span class="hl-1">: </span><span class="hl-10">number</span><span class="hl-1">;</span><br/><span class="hl-1">  </span><span class="hl-4">strategyName</span><span class="hl-1">: </span><span class="hl-10">StrategyName</span><span class="hl-1">;</span><br/><span class="hl-1">  </span><span class="hl-4">exchangeName</span><span class="hl-1">: </span><span class="hl-10">ExchangeName</span><span class="hl-1">;</span><br/><span class="hl-1">  </span><span class="hl-4">symbol</span><span class="hl-1">: </span><span class="hl-10">string</span><span class="hl-1">;</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<ul>
<li><a href="">src/interfaces/Strategy.interface.ts:274-289</a></li>
<li><a href="">src/client/ClientStrategy.ts:474-528</a></li>
<li><a href="">src/client/ClientStrategy.ts:566-599</a></li>
<li><a href="">types.d.ts:947-965</a></li>
</ul>
<hr>
<a id="state-machine-diagram" class="tsd-anchor"></a><h2 class="tsd-anchor-link">State Machine Diagram<a href="#state-machine-diagram" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p><img src="../media/47_Signal_States_0.svg" alt="Mermaid Diagram"></p>
<p><strong>State Transition Summary:</strong></p>
<table>
<thead>
<tr>
<th>From State</th>
<th>To State</th>
<th>Trigger</th>
</tr>
</thead>
<tbody>
<tr>
<td>idle → scheduled</td>
<td><code>getSignal()</code> returns signal with <code>priceOpen ≠ currentPrice</code></td>
<td></td>
</tr>
<tr>
<td>idle → opened</td>
<td><code>getSignal()</code> returns signal without <code>priceOpen</code> or <code>priceOpen = currentPrice</code></td>
<td></td>
</tr>
<tr>
<td>scheduled → opened</td>
<td>Price reaches <code>priceOpen</code> AND risk check passes</td>
<td></td>
</tr>
<tr>
<td>scheduled → cancelled</td>
<td>Timeout OR pre-activation SL OR risk rejection</td>
<td></td>
</tr>
<tr>
<td>opened → active</td>
<td>Next tick after signal creation</td>
<td></td>
</tr>
<tr>
<td>active → closed</td>
<td>TP/SL/timeout condition met</td>
<td></td>
</tr>
<tr>
<td>closed → idle</td>
<td>Next tick after closure</td>
<td></td>
</tr>
<tr>
<td>cancelled → idle</td>
<td>Next tick after cancellation</td>
<td></td>
</tr>
</tbody>
</table>
<ul>
<li><a href="">src/client/ClientStrategy.ts:960-1100</a></li>
<li>Diagram 2 from high-level architecture</li>
</ul>
<hr>
<a id="internal-state-tracking" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Internal State Tracking<a href="#internal-state-tracking" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p><code>ClientStrategy</code> maintains two nullable fields to track signal state:</p>
<a id="_pendingsignal" class="tsd-anchor"></a><h3 class="tsd-anchor-link">_pendingSignal<a href="#_pendingsignal" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><pre><code class="typescript"><span class="hl-4">private</span><span class="hl-1"> </span><span class="hl-12">_pendingSignal</span><span class="hl-1">: </span><span class="hl-4">ISignalRow</span><span class="hl-1"> | </span><span class="hl-6">null</span><span class="hl-1"> = </span><span class="hl-6">null</span><span class="hl-1">;</span>
</code><button type="button">Copy</button></pre>

<p>Stores the currently active position being monitored. Non-null during <strong>opened</strong> and <strong>active</strong> states. Set via <code>setPendingSignal()</code> method which performs atomic persistence in live mode.</p>
<p><strong>Lifecycle:</strong></p>
<ul>
<li>Set to <code>ISignalRow</code> when signal opens (market order or scheduled activation)</li>
<li>Remains populated during position monitoring</li>
<li>Cleared to <code>null</code> when position closes (TP/SL/timeout)</li>
</ul>
<p><strong>Persistence:</strong>
In live mode (non-backtest), state is persisted via <code>PersistSignalAdapter.writeSignalData()</code> for crash recovery.</p>
<ul>
<li><a href="">src/client/ClientStrategy.ts:133-145</a></li>
<li><a href="">src/client/ClientStrategy.ts:147-167</a></li>
</ul>
<a id="_scheduledsignal" class="tsd-anchor"></a><h3 class="tsd-anchor-link">_scheduledSignal<a href="#_scheduledsignal" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><pre><code class="typescript"><span class="hl-4">private</span><span class="hl-1"> </span><span class="hl-12">_scheduledSignal</span><span class="hl-1">: </span><span class="hl-4">IScheduledSignalRow</span><span class="hl-1"> | </span><span class="hl-6">null</span><span class="hl-1"> = </span><span class="hl-6">null</span><span class="hl-1">;</span>
</code><button type="button">Copy</button></pre>

<p>Stores the pending limit order awaiting activation. Non-null only during <strong>scheduled</strong> state. Set via <code>setScheduledSignal()</code> method which performs atomic persistence in live mode.</p>
<p><strong>Lifecycle:</strong></p>
<ul>
<li>Set to <code>IScheduledSignalRow</code> when limit order created</li>
<li>Remains populated during activation wait</li>
<li>Cleared to <code>null</code> when activated (transitions to <code>_pendingSignal</code>) or cancelled</li>
</ul>
<p><strong>Persistence:</strong>
In live mode, state is persisted via <code>PersistScheduleAdapter.writeScheduleData()</code> for crash recovery.</p>
<ul>
<li><a href="">src/client/ClientStrategy.ts:169-181</a></li>
<li><a href="">src/client/ClientStrategy.ts:183-203</a></li>
</ul>
<hr>
<a id="discriminated-union-type" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Discriminated Union Type<a href="#discriminated-union-type" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>All signal states are represented as a discriminated union type <code>IStrategyTickResult</code> with the <code>action</code> field as the discriminator:</p>
<pre><code class="typescript"><span class="hl-6">type</span><span class="hl-1"> </span><span class="hl-10">IStrategyTickResult</span><span class="hl-1"> =</span><br/><span class="hl-1">  | </span><span class="hl-10">IStrategyTickResultIdle</span><br/><span class="hl-1">  | </span><span class="hl-10">IStrategyTickResultScheduled</span><br/><span class="hl-1">  | </span><span class="hl-10">IStrategyTickResultOpened</span><br/><span class="hl-1">  | </span><span class="hl-10">IStrategyTickResultActive</span><br/><span class="hl-1">  | </span><span class="hl-10">IStrategyTickResultClosed</span><br/><span class="hl-1">  | </span><span class="hl-10">IStrategyTickResultCancelled</span><span class="hl-1">;</span>
</code><button type="button">Copy</button></pre>

<p>This enables type-safe state handling via TypeScript type guards:</p>
<pre><code class="typescript"><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">result</span><span class="hl-1"> = </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-4">strategy</span><span class="hl-1">.</span><span class="hl-0">tick</span><span class="hl-1">(</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">strategyName</span><span class="hl-1">);</span><br/><br/><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-4">result</span><span class="hl-1">.</span><span class="hl-4">action</span><span class="hl-1"> === </span><span class="hl-2">&quot;closed&quot;</span><span class="hl-1">) {</span><br/><span class="hl-1">  </span><span class="hl-5">// TypeScript narrows type to IStrategyTickResultClosed</span><br/><span class="hl-1">  </span><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">pnl</span><span class="hl-1"> = </span><span class="hl-4">result</span><span class="hl-1">.</span><span class="hl-4">pnl</span><span class="hl-1">.</span><span class="hl-4">pnlPercentage</span><span class="hl-1">;</span><br/><span class="hl-1">  </span><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">reason</span><span class="hl-1"> = </span><span class="hl-4">result</span><span class="hl-1">.</span><span class="hl-4">closeReason</span><span class="hl-1">; </span><span class="hl-5">// &quot;take_profit&quot; | &quot;stop_loss&quot; | &quot;time_expired&quot;</span><br/><span class="hl-1">}</span><br/><br/><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-4">result</span><span class="hl-1">.</span><span class="hl-4">action</span><span class="hl-1"> === </span><span class="hl-2">&quot;scheduled&quot;</span><span class="hl-1">) {</span><br/><span class="hl-1">  </span><span class="hl-5">// TypeScript narrows type to IStrategyTickResultScheduled</span><br/><span class="hl-1">  </span><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">priceOpen</span><span class="hl-1"> = </span><span class="hl-4">result</span><span class="hl-1">.</span><span class="hl-4">signal</span><span class="hl-1">.</span><span class="hl-4">priceOpen</span><span class="hl-1">;</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<p><strong>Backtest-Specific Type:</strong></p>
<p>The <code>backtest()</code> method returns a subset of states (only terminal states):</p>
<pre><code class="typescript"><span class="hl-6">type</span><span class="hl-1"> </span><span class="hl-10">IStrategyBacktestResult</span><span class="hl-1"> = </span><br/><span class="hl-1">  | </span><span class="hl-10">IStrategyTickResultClosed</span><span class="hl-1"> </span><br/><span class="hl-1">  | </span><span class="hl-10">IStrategyTickResultCancelled</span><span class="hl-1">;</span>
</code><button type="button">Copy</button></pre>

<p>This is because backtesting fast-forwards through the entire signal lifecycle and always returns a terminal state (either closed with PnL or cancelled without execution).</p>
<ul>
<li><a href="">src/interfaces/Strategy.interface.ts:295-306</a></li>
<li><a href="">types.d.ts:966-975</a></li>
</ul>
<hr>
<a id="state-transition-conditions" class="tsd-anchor"></a><h2 class="tsd-anchor-link">State Transition Conditions<a href="#state-transition-conditions" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><a id="idle-→-scheduled" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Idle → Scheduled<a href="#idle-→-scheduled" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><strong>Condition:</strong> <code>getSignal()</code> returns signal with <code>priceOpen</code> explicitly set, and activation check determines price has not yet reached entry point.</p>
<pre><code class="typescript"><span class="hl-5">// GET_SIGNAL_FN logic</span><br/><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-4">signal</span><span class="hl-1">.</span><span class="hl-4">priceOpen</span><span class="hl-1"> !== </span><span class="hl-6">undefined</span><span class="hl-1">) {</span><br/><span class="hl-1">  </span><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">shouldActivateImmediately</span><span class="hl-1"> =</span><br/><span class="hl-1">    (</span><span class="hl-4">signal</span><span class="hl-1">.</span><span class="hl-4">position</span><span class="hl-1"> === </span><span class="hl-2">&quot;long&quot;</span><span class="hl-1"> &amp;&amp; </span><span class="hl-4">currentPrice</span><span class="hl-1"> &lt;= </span><span class="hl-4">signal</span><span class="hl-1">.</span><span class="hl-4">priceOpen</span><span class="hl-1">) ||</span><br/><span class="hl-1">    (</span><span class="hl-4">signal</span><span class="hl-1">.</span><span class="hl-4">position</span><span class="hl-1"> === </span><span class="hl-2">&quot;short&quot;</span><span class="hl-1"> &amp;&amp; </span><span class="hl-4">currentPrice</span><span class="hl-1"> &gt;= </span><span class="hl-4">signal</span><span class="hl-1">.</span><span class="hl-4">priceOpen</span><span class="hl-1">);</span><br/><span class="hl-1">    </span><br/><span class="hl-1">  </span><span class="hl-3">if</span><span class="hl-1"> (!</span><span class="hl-4">shouldActivateImmediately</span><span class="hl-1">) {</span><br/><span class="hl-1">    </span><span class="hl-5">// Create scheduled signal</span><br/><span class="hl-1">    </span><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">scheduledSignalRow</span><span class="hl-1">: </span><span class="hl-10">IScheduledSignalRow</span><span class="hl-1"> = {</span><br/><span class="hl-1">      </span><span class="hl-4">id:</span><span class="hl-1"> </span><span class="hl-0">randomString</span><span class="hl-1">(),</span><br/><span class="hl-1">      </span><span class="hl-4">priceOpen:</span><span class="hl-1"> </span><span class="hl-4">signal</span><span class="hl-1">.</span><span class="hl-4">priceOpen</span><span class="hl-1">,</span><br/><span class="hl-1">      </span><span class="hl-5">// ... other fields</span><br/><span class="hl-1">      </span><span class="hl-4">_isScheduled:</span><span class="hl-1"> </span><span class="hl-6">true</span><span class="hl-1">,</span><br/><span class="hl-1">    };</span><br/><span class="hl-1">    </span><span class="hl-3">return</span><span class="hl-1"> </span><span class="hl-4">scheduledSignalRow</span><span class="hl-1">;</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<ul>
<li><a href="">src/client/ClientStrategy.ts:312-367</a></li>
</ul>
<a id="idle-→-opened" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Idle → Opened<a href="#idle-→-opened" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><strong>Condition:</strong> <code>getSignal()</code> returns signal without <code>priceOpen</code> OR with <code>priceOpen</code> already reached, and risk check passes.</p>
<pre><code class="typescript"><span class="hl-5">// Market order (no priceOpen specified)</span><br/><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">signalRow</span><span class="hl-1">: </span><span class="hl-10">ISignalRow</span><span class="hl-1"> = {</span><br/><span class="hl-1">  </span><span class="hl-4">id:</span><span class="hl-1"> </span><span class="hl-0">randomString</span><span class="hl-1">(),</span><br/><span class="hl-1">  </span><span class="hl-4">priceOpen:</span><span class="hl-1"> </span><span class="hl-4">currentPrice</span><span class="hl-1">, </span><span class="hl-5">// Use current VWAP</span><br/><span class="hl-1">  </span><span class="hl-5">// ... other fields</span><br/><span class="hl-1">  </span><span class="hl-4">_isScheduled:</span><span class="hl-1"> </span><span class="hl-6">false</span><span class="hl-1">,</span><br/><span class="hl-1">};</span><br/><br/><span class="hl-5">// Immediate activation (priceOpen already reached)</span><br/><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-4">shouldActivateImmediately</span><span class="hl-1">) {</span><br/><span class="hl-1">  </span><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">signalRow</span><span class="hl-1">: </span><span class="hl-10">ISignalRow</span><span class="hl-1"> = {</span><br/><span class="hl-1">    </span><span class="hl-4">id:</span><span class="hl-1"> </span><span class="hl-0">randomString</span><span class="hl-1">(),</span><br/><span class="hl-1">    </span><span class="hl-4">priceOpen:</span><span class="hl-1"> </span><span class="hl-4">signal</span><span class="hl-1">.</span><span class="hl-4">priceOpen</span><span class="hl-1">, </span><span class="hl-5">// Use specified priceOpen</span><br/><span class="hl-1">    </span><span class="hl-5">// ... other fields</span><br/><span class="hl-1">    </span><span class="hl-4">_isScheduled:</span><span class="hl-1"> </span><span class="hl-6">false</span><span class="hl-1">,</span><br/><span class="hl-1">  };</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<ul>
<li><a href="">src/client/ClientStrategy.ts:323-344</a></li>
<li><a href="">src/client/ClientStrategy.ts:369-384</a></li>
</ul>
<a id="scheduled-→-opened" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Scheduled → Opened<a href="#scheduled-→-opened" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><strong>Condition:</strong> Market price reaches <code>priceOpen</code> activation point AND risk check passes at activation time.</p>
<pre><code class="typescript"><span class="hl-5">// CHECK_SCHEDULED_SIGNAL_PRICE_ACTIVATION_FN</span><br/><span class="hl-6">const</span><span class="hl-1"> { </span><span class="hl-7">shouldActivate</span><span class="hl-1">, </span><span class="hl-7">shouldCancel</span><span class="hl-1"> } = </span><br/><span class="hl-1">  </span><span class="hl-0">CHECK_SCHEDULED_SIGNAL_PRICE_ACTIVATION_FN</span><span class="hl-1">(</span><span class="hl-4">scheduled</span><span class="hl-1">, </span><span class="hl-4">currentPrice</span><span class="hl-1">);</span><br/><br/><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-4">shouldActivate</span><span class="hl-1"> &amp;&amp; !</span><span class="hl-4">shouldCancel</span><span class="hl-1">) {</span><br/><span class="hl-1">  </span><span class="hl-5">// Re-run risk check at activation time</span><br/><span class="hl-1">  </span><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-4">risk</span><span class="hl-1">.</span><span class="hl-0">checkSignal</span><span class="hl-1">({ ... })) {</span><br/><span class="hl-1">    </span><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">activatedSignal</span><span class="hl-1">: </span><span class="hl-10">ISignalRow</span><span class="hl-1"> = {</span><br/><span class="hl-1">      ...</span><span class="hl-4">scheduled</span><span class="hl-1">,</span><br/><span class="hl-1">      </span><span class="hl-4">pendingAt:</span><span class="hl-1"> </span><span class="hl-4">activationTime</span><span class="hl-1">, </span><span class="hl-5">// Update to actual activation time</span><br/><span class="hl-1">      </span><span class="hl-4">_isScheduled:</span><span class="hl-1"> </span><span class="hl-6">false</span><span class="hl-1">,</span><br/><span class="hl-1">    };</span><br/><span class="hl-1">    </span><span class="hl-5">// Transition to opened</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<ul>
<li><a href="">src/client/ClientStrategy.ts:530-564</a></li>
<li><a href="">src/client/ClientStrategy.ts:601-693</a></li>
</ul>
<a id="scheduled-→-cancelled" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Scheduled → Cancelled<a href="#scheduled-→-cancelled" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><strong>Condition:</strong> Timeout expires OR pre-activation Stop Loss hit OR risk check fails at activation.</p>
<pre><code class="typescript"><span class="hl-5">// Timeout check</span><br/><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">currentTime</span><span class="hl-1"> = </span><span class="hl-4">when</span><span class="hl-1">.</span><span class="hl-0">getTime</span><span class="hl-1">();</span><br/><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">signalTime</span><span class="hl-1"> = </span><span class="hl-4">scheduled</span><span class="hl-1">.</span><span class="hl-4">scheduledAt</span><span class="hl-1">;</span><br/><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">maxTimeToWait</span><span class="hl-1"> = </span><span class="hl-7">CC_SCHEDULE_AWAIT_MINUTES</span><span class="hl-1"> * </span><span class="hl-8">60</span><span class="hl-1"> * </span><span class="hl-8">1000</span><span class="hl-1">;</span><br/><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">elapsedTime</span><span class="hl-1"> = </span><span class="hl-4">currentTime</span><span class="hl-1"> - </span><span class="hl-4">signalTime</span><span class="hl-1">;</span><br/><br/><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-4">elapsedTime</span><span class="hl-1"> &gt;= </span><span class="hl-4">maxTimeToWait</span><span class="hl-1">) {</span><br/><span class="hl-1">  </span><span class="hl-5">// Cancel by timeout</span><br/><span class="hl-1">  </span><span class="hl-3">return</span><span class="hl-1"> { </span><span class="hl-4">action:</span><span class="hl-1"> </span><span class="hl-2">&quot;cancelled&quot;</span><span class="hl-1">, ... };</span><br/><span class="hl-1">}</span><br/><br/><span class="hl-5">// Pre-activation SL check (LONG)</span><br/><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-4">scheduled</span><span class="hl-1">.</span><span class="hl-4">position</span><span class="hl-1"> === </span><span class="hl-2">&quot;long&quot;</span><span class="hl-1"> &amp;&amp; </span><span class="hl-4">currentPrice</span><span class="hl-1"> &lt;= </span><span class="hl-4">scheduled</span><span class="hl-1">.</span><span class="hl-4">priceStopLoss</span><span class="hl-1">) {</span><br/><span class="hl-1">  </span><span class="hl-5">// Cancel by SL (price fell too far before activation)</span><br/><span class="hl-1">  </span><span class="hl-3">return</span><span class="hl-1"> { </span><span class="hl-4">action:</span><span class="hl-1"> </span><span class="hl-2">&quot;cancelled&quot;</span><span class="hl-1">, ... };</span><br/><span class="hl-1">}</span><br/><br/><span class="hl-5">// Pre-activation SL check (SHORT)</span><br/><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-4">scheduled</span><span class="hl-1">.</span><span class="hl-4">position</span><span class="hl-1"> === </span><span class="hl-2">&quot;short&quot;</span><span class="hl-1"> &amp;&amp; </span><span class="hl-4">currentPrice</span><span class="hl-1"> &gt;= </span><span class="hl-4">scheduled</span><span class="hl-1">.</span><span class="hl-4">priceStopLoss</span><span class="hl-1">) {</span><br/><span class="hl-1">  </span><span class="hl-5">// Cancel by SL (price rose too far before activation)</span><br/><span class="hl-1">  </span><span class="hl-3">return</span><span class="hl-1"> { </span><span class="hl-4">action:</span><span class="hl-1"> </span><span class="hl-2">&quot;cancelled&quot;</span><span class="hl-1">, ... };</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<ul>
<li><a href="">src/client/ClientStrategy.ts:474-528</a></li>
<li><a href="">src/client/ClientStrategy.ts:530-564</a></li>
<li><a href="">test/e2e/defend.test.mjs:446-537</a></li>
</ul>
<a id="opened-→-active" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Opened → Active<a href="#opened-→-active" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><strong>Condition:</strong> Automatic transition on next tick after signal opening. No explicit condition checked.</p>
<ul>
<li><a href="">src/client/ClientStrategy.ts:960-1020</a></li>
</ul>
<a id="active-→-closed" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Active → Closed<a href="#active-→-closed" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><strong>Condition:</strong> Price reaches Take Profit, Stop Loss, or time expires.</p>
<pre><code class="typescript"><span class="hl-5">// CHECK_PENDING_SIGNAL_COMPLETION_FN</span><br/><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">currentTime</span><span class="hl-1"> = </span><span class="hl-4">when</span><span class="hl-1">.</span><span class="hl-0">getTime</span><span class="hl-1">();</span><br/><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">signalTime</span><span class="hl-1"> = </span><span class="hl-4">signal</span><span class="hl-1">.</span><span class="hl-4">pendingAt</span><span class="hl-1">; </span><span class="hl-5">// Use pendingAt, not scheduledAt!</span><br/><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">maxTimeToWait</span><span class="hl-1"> = </span><span class="hl-4">signal</span><span class="hl-1">.</span><span class="hl-4">minuteEstimatedTime</span><span class="hl-1"> * </span><span class="hl-8">60</span><span class="hl-1"> * </span><span class="hl-8">1000</span><span class="hl-1">;</span><br/><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">elapsedTime</span><span class="hl-1"> = </span><span class="hl-4">currentTime</span><span class="hl-1"> - </span><span class="hl-4">signalTime</span><span class="hl-1">;</span><br/><br/><span class="hl-5">// Time expiration</span><br/><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-4">elapsedTime</span><span class="hl-1"> &gt;= </span><span class="hl-4">maxTimeToWait</span><span class="hl-1">) {</span><br/><span class="hl-1">  </span><span class="hl-3">return</span><span class="hl-1"> </span><span class="hl-0">CLOSE_PENDING_SIGNAL_FN</span><span class="hl-1">(</span><span class="hl-4">self</span><span class="hl-1">, </span><span class="hl-4">signal</span><span class="hl-1">, </span><span class="hl-4">averagePrice</span><span class="hl-1">, </span><span class="hl-2">&quot;time_expired&quot;</span><span class="hl-1">);</span><br/><span class="hl-1">}</span><br/><br/><span class="hl-5">// Take Profit (LONG)</span><br/><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-4">signal</span><span class="hl-1">.</span><span class="hl-4">position</span><span class="hl-1"> === </span><span class="hl-2">&quot;long&quot;</span><span class="hl-1"> &amp;&amp; </span><span class="hl-4">averagePrice</span><span class="hl-1"> &gt;= </span><span class="hl-4">signal</span><span class="hl-1">.</span><span class="hl-4">priceTakeProfit</span><span class="hl-1">) {</span><br/><span class="hl-1">  </span><span class="hl-3">return</span><span class="hl-1"> </span><span class="hl-0">CLOSE_PENDING_SIGNAL_FN</span><span class="hl-1">(</span><span class="hl-4">self</span><span class="hl-1">, </span><span class="hl-4">signal</span><span class="hl-1">, </span><span class="hl-4">signal</span><span class="hl-1">.</span><span class="hl-4">priceTakeProfit</span><span class="hl-1">, </span><span class="hl-2">&quot;take_profit&quot;</span><span class="hl-1">);</span><br/><span class="hl-1">}</span><br/><br/><span class="hl-5">// Take Profit (SHORT)</span><br/><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-4">signal</span><span class="hl-1">.</span><span class="hl-4">position</span><span class="hl-1"> === </span><span class="hl-2">&quot;short&quot;</span><span class="hl-1"> &amp;&amp; </span><span class="hl-4">averagePrice</span><span class="hl-1"> &lt;= </span><span class="hl-4">signal</span><span class="hl-1">.</span><span class="hl-4">priceTakeProfit</span><span class="hl-1">) {</span><br/><span class="hl-1">  </span><span class="hl-3">return</span><span class="hl-1"> </span><span class="hl-0">CLOSE_PENDING_SIGNAL_FN</span><span class="hl-1">(</span><span class="hl-4">self</span><span class="hl-1">, </span><span class="hl-4">signal</span><span class="hl-1">, </span><span class="hl-4">signal</span><span class="hl-1">.</span><span class="hl-4">priceTakeProfit</span><span class="hl-1">, </span><span class="hl-2">&quot;take_profit&quot;</span><span class="hl-1">);</span><br/><span class="hl-1">}</span><br/><br/><span class="hl-5">// Stop Loss (LONG)</span><br/><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-4">signal</span><span class="hl-1">.</span><span class="hl-4">position</span><span class="hl-1"> === </span><span class="hl-2">&quot;long&quot;</span><span class="hl-1"> &amp;&amp; </span><span class="hl-4">averagePrice</span><span class="hl-1"> &lt;= </span><span class="hl-4">signal</span><span class="hl-1">.</span><span class="hl-4">priceStopLoss</span><span class="hl-1">) {</span><br/><span class="hl-1">  </span><span class="hl-3">return</span><span class="hl-1"> </span><span class="hl-0">CLOSE_PENDING_SIGNAL_FN</span><span class="hl-1">(</span><span class="hl-4">self</span><span class="hl-1">, </span><span class="hl-4">signal</span><span class="hl-1">, </span><span class="hl-4">signal</span><span class="hl-1">.</span><span class="hl-4">priceStopLoss</span><span class="hl-1">, </span><span class="hl-2">&quot;stop_loss&quot;</span><span class="hl-1">);</span><br/><span class="hl-1">}</span><br/><br/><span class="hl-5">// Stop Loss (SHORT)</span><br/><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-4">signal</span><span class="hl-1">.</span><span class="hl-4">position</span><span class="hl-1"> === </span><span class="hl-2">&quot;short&quot;</span><span class="hl-1"> &amp;&amp; </span><span class="hl-4">averagePrice</span><span class="hl-1"> &gt;= </span><span class="hl-4">signal</span><span class="hl-1">.</span><span class="hl-4">priceStopLoss</span><span class="hl-1">) {</span><br/><span class="hl-1">  </span><span class="hl-3">return</span><span class="hl-1"> </span><span class="hl-0">CLOSE_PENDING_SIGNAL_FN</span><span class="hl-1">(</span><span class="hl-4">self</span><span class="hl-1">, </span><span class="hl-4">signal</span><span class="hl-1">, </span><span class="hl-4">signal</span><span class="hl-1">.</span><span class="hl-4">priceStopLoss</span><span class="hl-1">, </span><span class="hl-2">&quot;stop_loss&quot;</span><span class="hl-1">);</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<ul>
<li><a href="">src/client/ClientStrategy.ts:817-876</a></li>
<li><a href="">src/client/ClientStrategy.ts:878-915</a></li>
</ul>
<a id="closed-→-idle" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Closed → Idle<a href="#closed-→-idle" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><strong>Condition:</strong> Automatic transition on next tick after signal closure. <code>_pendingSignal</code> cleared to <code>null</code>.</p>
<ul>
<li><a href="">src/client/ClientStrategy.ts:960-1020</a></li>
</ul>
<a id="cancelled-→-idle" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Cancelled → Idle<a href="#cancelled-→-idle" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><strong>Condition:</strong> Automatic transition on next tick after cancellation. <code>_scheduledSignal</code> cleared to <code>null</code>.</p>
<ul>
<li><a href="">src/client/ClientStrategy.ts:960-1020</a></li>
</ul>
<hr>
<a id="example-state-flow-scheduled-signal-with-activation" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Example State Flow: Scheduled Signal with Activation<a href="#example-state-flow-scheduled-signal-with-activation" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p><img src="../media/47_Signal_States_1.svg" alt="Mermaid Diagram"></p>
<ul>
<li><a href="">src/client/ClientStrategy.ts:960-1100</a></li>
<li><a href="">test/e2e/defend.test.mjs:291-439</a></li>
</ul>
<hr>
<a id="example-state-flow-pre-activation-cancellation" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Example State Flow: Pre-activation Cancellation<a href="#example-state-flow-pre-activation-cancellation" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p><img src="../media/47_Signal_States_2.svg" alt="Mermaid Diagram"></p>
<p><strong>Key Difference from Opened→Closed:</strong></p>
<ul>
<li>
<p><code>onCancel()</code> fired instead of <code>onClose()</code></p>
</li>
<li>
<p>No <code>pnl</code> object (no trade executed, no fees paid)</p>
</li>
<li>
<p>Action is <code>&quot;cancelled&quot;</code> not <code>&quot;closed&quot;</code></p>
</li>
<li>
<p><a href="">src/client/ClientStrategy.ts:530-564</a></p>
</li>
<li>
<p><a href="">src/client/ClientStrategy.ts:566-599</a></p>
</li>
<li>
<p><a href="">test/e2e/defend.test.mjs:1393-1507</a></p>
</li>
</ul>
</div></div><div class="col-sidebar"><div class="page-menu"><div class="tsd-navigation settings"><details class="tsd-accordion"><summary class="tsd-accordion-summary"><h3><svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-chevronDown"></use></svg>Settings</h3></summary><div class="tsd-accordion-details"><div class="tsd-filter-visibility"><span class="settings-label">Member Visibility</span><ul id="tsd-filter-options"><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-protected" name="protected"/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Protected</span></label></li><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-inherited" name="inherited" checked/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Inherited</span></label></li><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-external" name="external"/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>External</span></label></li></ul></div><div class="tsd-theme-toggle"><label class="settings-label" for="tsd-theme">Theme</label><select id="tsd-theme"><option value="os">OS</option><option value="light">Light</option><option value="dark">Dark</option></select></div></div></details></div><details open class="tsd-accordion tsd-page-navigation"><summary class="tsd-accordion-summary"><h3><svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-chevronDown"></use></svg>On This Page</h3></summary><div class="tsd-accordion-details"><a href="#signal-states"><span>Signal <wbr/>States</span></a><ul><li><a href="#state-overview"><span>State <wbr/>Overview</span></a></li><li><a href="#state-definitions"><span>State <wbr/>Definitions</span></a></li><li><ul><li><a href="#1-idle-state"><span>1. <wbr/>Idle <wbr/>State</span></a></li><li><a href="#2-scheduled-state"><span>2. <wbr/>Scheduled <wbr/>State</span></a></li><li><a href="#3-opened-state"><span>3. <wbr/>Opened <wbr/>State</span></a></li><li><a href="#4-active-state"><span>4. <wbr/>Active <wbr/>State</span></a></li><li><a href="#5-closed-state"><span>5. <wbr/>Closed <wbr/>State</span></a></li><li><a href="#6-cancelled-state"><span>6. <wbr/>Cancelled <wbr/>State</span></a></li></ul></li><li><a href="#state-machine-diagram"><span>State <wbr/>Machine <wbr/>Diagram</span></a></li><li><a href="#internal-state-tracking"><span>Internal <wbr/>State <wbr/>Tracking</span></a></li><li><ul><li><a href="#_pendingsignal"><span>_pending<wbr/>Signal</span></a></li><li><a href="#_scheduledsignal"><span>_scheduled<wbr/>Signal</span></a></li></ul></li><li><a href="#discriminated-union-type"><span>Discriminated <wbr/>Union <wbr/>Type</span></a></li><li><a href="#state-transition-conditions"><span>State <wbr/>Transition <wbr/>Conditions</span></a></li><li><ul><li><a href="#idle-→-scheduled"><span>Idle → <wbr/>Scheduled</span></a></li><li><a href="#idle-→-opened"><span>Idle → <wbr/>Opened</span></a></li><li><a href="#scheduled-→-opened"><span>Scheduled → <wbr/>Opened</span></a></li><li><a href="#scheduled-→-cancelled"><span>Scheduled → <wbr/>Cancelled</span></a></li><li><a href="#opened-→-active"><span>Opened → <wbr/>Active</span></a></li><li><a href="#active-→-closed"><span>Active → <wbr/>Closed</span></a></li><li><a href="#closed-→-idle"><span>Closed → <wbr/>Idle</span></a></li><li><a href="#cancelled-→-idle"><span>Cancelled → <wbr/>Idle</span></a></li></ul></li><li><a href="#example-state-flow-scheduled-signal-with-activation"><span>Example <wbr/>State <wbr/>Flow: <wbr/>Scheduled <wbr/>Signal with <wbr/>Activation</span></a></li><li><a href="#example-state-flow-pre-activation-cancellation"><span>Example <wbr/>State <wbr/>Flow: <wbr/>Pre-<wbr/>activation <wbr/>Cancellation</span></a></li></ul></div></details></div><div class="site-menu"><nav class="tsd-navigation"><a href="../modules.html">backtest-kit</a><ul class="tsd-small-nested-navigation" id="tsd-nav-container"><li>Loading...</li></ul></nav></div></div></div><footer><p class="tsd-generator">Generated using <a href="https://typedoc.org/" target="_blank">TypeDoc</a></p></footer><div class="overlay"></div></body></html>

<!-- Yandex.Metrika counter -->
<script type="text/javascript">
    (function(m,e,t,r,i,k,a){
        m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
        m[i].l=1*new Date();
        for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }}
        k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)
    })(window, document,'script','https://mc.yandex.ru/metrika/tag.js?id=105455585', 'ym');

    ym(105455585, 'init', {ssr:true, webvisor:true, clickmap:true, ecommerce:"dataLayer", accurateTrackBounce:true, trackLinks:true});
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/105455585" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
<!-- /Yandex.Metrika counter -->

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-3MQZEBBDDR"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-3MQZEBBDDR');
</script>
