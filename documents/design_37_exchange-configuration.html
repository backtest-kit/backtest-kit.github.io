<!DOCTYPE html><html class="default" lang="en" data-base=".."><head><meta charset="utf-8"/><meta http-equiv="x-ua-compatible" content="IE=edge"/><title>design/37_exchange-configuration | backtest-kit</title><meta name="description" content="Documentation for backtest-kit"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="stylesheet" href="../assets/style.css"/><link rel="stylesheet" href="../assets/highlight.css"/><script defer src="../assets/main.js"></script><script async src="../assets/icons.js" id="tsd-icons-script"></script><script async src="../assets/search.js" id="tsd-search-script"></script><script async src="../assets/navigation.js" id="tsd-nav-script"></script><script async src="../assets/hierarchy.js" id="tsd-hierarchy-script"></script></head><body><script>document.documentElement.dataset.theme = localStorage.getItem("tsd-theme") || "os";document.body.style.display="none";setTimeout(() => app?app.showPage():document.body.style.removeProperty("display"),500)</script><header class="tsd-page-toolbar"><div class="tsd-toolbar-contents container"><div class="table-cell" id="tsd-search"><div class="field"><label for="tsd-search-field" class="tsd-widget tsd-toolbar-icon search no-caption"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-search"></use></svg></label><input type="text" id="tsd-search-field" aria-label="Search"/></div><div class="field"><div id="tsd-toolbar-links"></div></div><ul class="results"><li class="state loading">Preparing search index...</li><li class="state failure">The search index is not available</li></ul><a href="../index.html" class="title">backtest-kit</a></div><div class="table-cell" id="tsd-widgets"><a href="#" class="tsd-widget tsd-toolbar-icon menu no-caption" data-toggle="menu" aria-label="Menu"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-menu"></use></svg></a></div></div></header><div class="container container-main"><div class="col-content"><div class="tsd-page-title"><ul class="tsd-breadcrumb"><li><a href="../modules.html">backtest-kit</a></li><li><a href="design_37_exchange-configuration.html">design/37_exchange-configuration</a></li></ul></div><div class="tsd-panel tsd-typography"><a id="exchange-configuration" class="tsd-anchor"></a><h1 class="tsd-anchor-link">Exchange Configuration<a href="#exchange-configuration" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h1><a id="purpose" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Purpose<a href="#purpose" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>This document describes how to configure exchange data sources in Backtest Kit using the <code>IExchangeSchema</code> interface. An exchange configuration defines how the framework fetches historical candle data, formats prices and quantities, and calculates VWAP for realistic trade execution.</p>
<p>For information about candle data structure and validation, see <a href="design_36_exchanges-data-sources.html">Candle Data &amp; Validation</a>. For CCXT-specific integration patterns, see <a href="design_36_exchanges-data-sources.html">CCXT Integration</a>.</p>
<hr>
<a id="overview" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Overview<a href="#overview" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>The exchange system provides market data abstraction through three key components:</p>
<table>
<thead>
<tr>
<th>Component</th>
<th>Purpose</th>
<th>Location</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>IExchangeSchema</code></td>
<td>User-defined configuration schema</td>
<td><code>types.d.ts:122-155</code></td>
</tr>
<tr>
<td><code>addExchange()</code></td>
<td>Registration function</td>
<td><code>src/function/add.ts</code></td>
</tr>
<tr>
<td><code>ClientExchange</code></td>
<td>Internal client implementation</td>
<td><code>src/client/ClientExchange.ts</code></td>
</tr>
</tbody>
</table>
<p>An exchange schema must implement methods for fetching candles (<code>getCandles</code>), formatting prices and quantities according to exchange precision rules, and optionally handling lifecycle callbacks.</p>
<hr>
<a id="configuration-flow" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Configuration Flow<a href="#configuration-flow" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p><img src="../media/37_exchange-configuration_0.svg" alt="Mermaid Diagram"></p>
<p><strong>Diagram: Exchange Configuration and Usage Flow</strong></p>
<p>The user defines an <code>IExchangeSchema</code> and registers it via <code>addExchange()</code>. The system validates uniqueness, stores the schema in <code>ToolRegistry</code>, and creates a memoized <code>ClientExchange</code> instance during execution. Strategies access exchange methods through <code>getCandles()</code> and <code>getAveragePrice()</code> helper functions.</p>
<hr>
<a id="iexchangeschema-interface" class="tsd-anchor"></a><h2 class="tsd-anchor-link">IExchangeSchema Interface<a href="#iexchangeschema-interface" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p><img src="../media/37_exchange-configuration_1.svg" alt="Mermaid Diagram"></p>
<p><strong>Diagram: IExchangeSchema Structure</strong></p>
<p>The schema consists of four required methods and one optional callbacks object. All methods are async to support API calls or database queries.</p>
<hr>
<a id="required-methods" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Required Methods<a href="#required-methods" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><a id="getcandles" class="tsd-anchor"></a><h3 class="tsd-anchor-link">getCandles()<a href="#getcandles" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Fetches historical OHLCV candle data from the exchange API or database.</p>
<p><strong>Signature:</strong></p>
<pre><code class="typescript"><span class="hl-10">getCandles</span><span class="hl-1">: (</span><br/><span class="hl-1">  </span><span class="hl-4">symbol</span><span class="hl-1">: </span><span class="hl-4">string</span><span class="hl-1">,      </span><span class="hl-5">// Trading pair (e.g., &quot;BTCUSDT&quot;)</span><br/><span class="hl-1">  </span><span class="hl-4">interval</span><span class="hl-1">: </span><span class="hl-4">CandleInterval</span><span class="hl-1">,  </span><span class="hl-5">// Time interval (e.g., &quot;1m&quot;, &quot;1h&quot;)</span><br/><span class="hl-1">  </span><span class="hl-4">since</span><span class="hl-1">: </span><span class="hl-4">Date</span><span class="hl-1">,         </span><span class="hl-5">// Start date for data fetching</span><br/><span class="hl-1">  </span><span class="hl-4">limit</span><span class="hl-1">: </span><span class="hl-4">number</span><span class="hl-1">        </span><span class="hl-5">// Maximum number of candles to return</span><br/><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> </span><span class="hl-11">Promise</span><span class="hl-1">&lt;</span><span class="hl-4">ICandleData</span><span class="hl-1">[]&gt;</span>
</code><button type="button">Copy</button></pre>

<p><strong>Requirements:</strong></p>
<ul>
<li>Return candles sorted by timestamp ascending</li>
<li>Each candle must have all OHLCV fields populated</li>
<li>Timestamps should be in milliseconds (Unix epoch)</li>
<li>Handle API rate limits and retry logic internally</li>
<li>Return empty array if no data available</li>
</ul>
<p><strong>Example Implementation:</strong></p>
<pre><code class="typescript"><span class="hl-5">// From README.md example</span><br/><span class="hl-10">getCandles</span><span class="hl-1">: </span><span class="hl-7">async</span><span class="hl-1"> (</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">interval</span><span class="hl-1">, </span><span class="hl-4">since</span><span class="hl-1">, </span><span class="hl-4">limit</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">exchange</span><span class="hl-1"> = </span><span class="hl-7">new</span><span class="hl-1"> </span><span class="hl-4">ccxt</span><span class="hl-1">.</span><span class="hl-0">binance</span><span class="hl-1">();</span><br/><span class="hl-1">  </span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">ohlcv</span><span class="hl-1"> = </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-4">exchange</span><span class="hl-1">.</span><span class="hl-0">fetchOHLCV</span><span class="hl-1">(</span><br/><span class="hl-1">    </span><span class="hl-4">symbol</span><span class="hl-1">, </span><br/><span class="hl-1">    </span><span class="hl-4">interval</span><span class="hl-1">, </span><br/><span class="hl-1">    </span><span class="hl-4">since</span><span class="hl-1">.</span><span class="hl-0">getTime</span><span class="hl-1">(), </span><br/><span class="hl-1">    </span><span class="hl-4">limit</span><br/><span class="hl-1">  );</span><br/><span class="hl-1">  </span><span class="hl-3">return</span><span class="hl-1"> </span><span class="hl-4">ohlcv</span><span class="hl-1">.</span><span class="hl-0">map</span><span class="hl-1">(([</span><span class="hl-4">timestamp</span><span class="hl-1">, </span><span class="hl-4">open</span><span class="hl-1">, </span><span class="hl-4">high</span><span class="hl-1">, </span><span class="hl-4">low</span><span class="hl-1">, </span><span class="hl-4">close</span><span class="hl-1">, </span><span class="hl-4">volume</span><span class="hl-1">]) </span><span class="hl-7">=&gt;</span><span class="hl-1"> ({</span><br/><span class="hl-1">    </span><span class="hl-4">timestamp</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-4">open</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-4">high</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-4">low</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-4">close</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-4">volume</span><br/><span class="hl-1">  }));</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<hr>
<a id="formatprice" class="tsd-anchor"></a><h3 class="tsd-anchor-link">formatPrice()<a href="#formatprice" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Formats price values according to exchange precision rules (e.g., 2 decimals for BTC pairs, 8 for altcoins).</p>
<p><strong>Signature:</strong></p>
<pre><code class="typescript"><span class="hl-10">formatPrice</span><span class="hl-1">: (</span><br/><span class="hl-1">  </span><span class="hl-4">symbol</span><span class="hl-1">: </span><span class="hl-4">string</span><span class="hl-1">,  </span><span class="hl-5">// Trading pair</span><br/><span class="hl-1">  </span><span class="hl-4">price</span><span class="hl-1">: </span><span class="hl-4">number</span><span class="hl-1">    </span><span class="hl-5">// Raw price value</span><br/><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> </span><span class="hl-11">Promise</span><span class="hl-1">&lt;</span><span class="hl-4">string</span><span class="hl-1">&gt;  </span><span class="hl-5">// Formatted price string</span>
</code><button type="button">Copy</button></pre>

<p><strong>Purpose:</strong></p>
<ul>
<li>Ensure prices meet exchange precision requirements</li>
<li>Prevent order rejection due to invalid price formatting</li>
<li>Used when logging signals and calculating PNL</li>
</ul>
<p><strong>Example Implementation:</strong></p>
<pre><code class="typescript"><span class="hl-10">formatPrice</span><span class="hl-1">: </span><span class="hl-7">async</span><span class="hl-1"> (</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">price</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-5">// Simple fixed decimal approach</span><br/><span class="hl-1">  </span><span class="hl-3">return</span><span class="hl-1"> </span><span class="hl-4">price</span><span class="hl-1">.</span><span class="hl-0">toFixed</span><span class="hl-1">(</span><span class="hl-6">2</span><span class="hl-1">);</span><br/><span class="hl-1">  </span><br/><span class="hl-1">  </span><span class="hl-5">// Or use exchange-specific precision</span><br/><span class="hl-1">  </span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">market</span><span class="hl-1"> = </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-4">exchange</span><span class="hl-1">.</span><span class="hl-0">loadMarkets</span><span class="hl-1">();</span><br/><span class="hl-1">  </span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">precision</span><span class="hl-1"> = </span><span class="hl-4">market</span><span class="hl-1">[</span><span class="hl-4">symbol</span><span class="hl-1">].</span><span class="hl-4">precision</span><span class="hl-1">.</span><span class="hl-4">price</span><span class="hl-1">;</span><br/><span class="hl-1">  </span><span class="hl-3">return</span><span class="hl-1"> </span><span class="hl-4">price</span><span class="hl-1">.</span><span class="hl-0">toFixed</span><span class="hl-1">(</span><span class="hl-4">precision</span><span class="hl-1">);</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<hr>
<a id="formatquantity" class="tsd-anchor"></a><h3 class="tsd-anchor-link">formatQuantity()<a href="#formatquantity" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Formats quantity/size values according to exchange lot size rules.</p>
<p><strong>Signature:</strong></p>
<pre><code class="typescript"><span class="hl-10">formatQuantity</span><span class="hl-1">: (</span><br/><span class="hl-1">  </span><span class="hl-4">symbol</span><span class="hl-1">: </span><span class="hl-4">string</span><span class="hl-1">,    </span><span class="hl-5">// Trading pair</span><br/><span class="hl-1">  </span><span class="hl-4">quantity</span><span class="hl-1">: </span><span class="hl-4">number</span><span class="hl-1">   </span><span class="hl-5">// Raw quantity value</span><br/><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> </span><span class="hl-11">Promise</span><span class="hl-1">&lt;</span><span class="hl-4">string</span><span class="hl-1">&gt;  </span><span class="hl-5">// Formatted quantity string</span>
</code><button type="button">Copy</button></pre>

<p><strong>Purpose:</strong></p>
<ul>
<li>Ensure quantities meet exchange minimum/maximum size requirements</li>
<li>Apply lot size increments correctly</li>
<li>Prevent order rejection due to invalid quantity formatting</li>
</ul>
<p><strong>Example Implementation:</strong></p>
<pre><code class="typescript"><span class="hl-10">formatQuantity</span><span class="hl-1">: </span><span class="hl-7">async</span><span class="hl-1"> (</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">quantity</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-5">// Fixed decimal approach</span><br/><span class="hl-1">  </span><span class="hl-3">return</span><span class="hl-1"> </span><span class="hl-4">quantity</span><span class="hl-1">.</span><span class="hl-0">toFixed</span><span class="hl-1">(</span><span class="hl-6">8</span><span class="hl-1">);</span><br/><span class="hl-1">  </span><br/><span class="hl-1">  </span><span class="hl-5">// Or use exchange-specific precision</span><br/><span class="hl-1">  </span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">market</span><span class="hl-1"> = </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-4">exchange</span><span class="hl-1">.</span><span class="hl-0">loadMarkets</span><span class="hl-1">();</span><br/><span class="hl-1">  </span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">precision</span><span class="hl-1"> = </span><span class="hl-4">market</span><span class="hl-1">[</span><span class="hl-4">symbol</span><span class="hl-1">].</span><span class="hl-4">precision</span><span class="hl-1">.</span><span class="hl-4">amount</span><span class="hl-1">;</span><br/><span class="hl-1">  </span><span class="hl-3">return</span><span class="hl-1"> </span><span class="hl-4">quantity</span><span class="hl-1">.</span><span class="hl-0">toFixed</span><span class="hl-1">(</span><span class="hl-4">precision</span><span class="hl-1">);</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<hr>
<a id="optional-callbacks" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Optional Callbacks<a href="#optional-callbacks" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>The <code>callbacks</code> field enables lifecycle event hooks for monitoring and debugging.</p>
<a id="iexchangecallbacks" class="tsd-anchor"></a><h3 class="tsd-anchor-link">IExchangeCallbacks<a href="#iexchangecallbacks" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><table>
<thead>
<tr>
<th>Callback</th>
<th>Trigger</th>
<th>Parameters</th>
<th>Use Case</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>onCandleData</code></td>
<td>After <code>getCandles()</code> completes</td>
<td><code>symbol</code>, <code>interval</code>, <code>since</code>, <code>limit</code>, <code>data</code></td>
<td>Logging, debugging, cache invalidation</td>
</tr>
</tbody>
</table>
<p><strong>Example:</strong></p>
<pre><code class="typescript"><span class="hl-0">addExchange</span><span class="hl-1">({</span><br/><span class="hl-1">  </span><span class="hl-4">exchangeName:</span><span class="hl-1"> </span><span class="hl-2">&#39;binance&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-0">getCandles</span><span class="hl-4">:</span><span class="hl-1"> </span><span class="hl-7">async</span><span class="hl-1"> (</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">interval</span><span class="hl-1">, </span><span class="hl-4">since</span><span class="hl-1">, </span><span class="hl-4">limit</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-5">// ... fetch implementation</span><br/><span class="hl-1">  },</span><br/><span class="hl-1">  </span><span class="hl-4">callbacks:</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-0">onCandleData</span><span class="hl-4">:</span><span class="hl-1"> (</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">interval</span><span class="hl-1">, </span><span class="hl-4">since</span><span class="hl-1">, </span><span class="hl-4">limit</span><span class="hl-1">, </span><span class="hl-4">data</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">      </span><span class="hl-4">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-2">`Fetched </span><span class="hl-7">${</span><span class="hl-4">data</span><span class="hl-9">.</span><span class="hl-4">length</span><span class="hl-7">}</span><span class="hl-2"> candles for </span><span class="hl-7">${</span><span class="hl-4">symbol</span><span class="hl-7">}</span><span class="hl-2"> (</span><span class="hl-7">${</span><span class="hl-4">interval</span><span class="hl-7">}</span><span class="hl-2">)`</span><span class="hl-1">);</span><br/><span class="hl-1">      </span><span class="hl-4">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-2">`Date range: </span><span class="hl-7">${</span><span class="hl-4">since</span><span class="hl-7">}</span><span class="hl-2"> to </span><span class="hl-7">${</span><span class="hl-4">data</span><span class="hl-9">[</span><span class="hl-4">data</span><span class="hl-9">.</span><span class="hl-4">length</span><span class="hl-9"> </span><span class="hl-1">-</span><span class="hl-9"> </span><span class="hl-6">1</span><span class="hl-9">]?.</span><span class="hl-4">timestamp</span><span class="hl-7">}</span><span class="hl-2">`</span><span class="hl-1">);</span><br/><span class="hl-1">    }</span><br/><span class="hl-1">  },</span><br/><span class="hl-1">  </span><span class="hl-5">// ... other methods</span><br/><span class="hl-1">});</span>
</code><button type="button">Copy</button></pre>

<hr>
<a id="registration-with-addexchange" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Registration with addExchange()<a href="#registration-with-addexchange" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p><img src="../media/37_exchange-configuration_2.svg" alt="Mermaid Diagram"></p>
<p><strong>Diagram: addExchange() Registration Flow</strong></p>
<p>The registration process validates uniqueness to prevent accidental overwrites, then stores the schema in <code>ToolRegistry</code> for retrieval during execution.</p>
<p><strong>Validation Rules:</strong></p>
<ul>
<li><code>exchangeName</code> must be unique across all registered exchanges</li>
<li>All required methods (<code>getCandles</code>, <code>formatPrice</code>, <code>formatQuantity</code>) must be provided</li>
<li>Callbacks are optional</li>
</ul>
<hr>
<a id="clientexchange-implementation" class="tsd-anchor"></a><h2 class="tsd-anchor-link">ClientExchange Implementation<a href="#clientexchange-implementation" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>The framework instantiates <code>ClientExchange</code> using the provided schema. This client implements additional logic around the user-defined methods.</p>
<p><img src="../media/37_exchange-configuration_3.svg" alt="Mermaid Diagram"></p>
<p><strong>Diagram: ClientExchange Method Structure</strong></p>
<p><code>ClientExchange</code> wraps the user-defined schema and adds execution context awareness. The <code>getCandles()</code> method automatically respects the temporal context to prevent look-ahead bias.</p>
<p><strong>Key Implementation Details:</strong></p>
<ul>
<li><strong>Temporal Context:</strong> <code>getCandles()</code> uses <code>ExecutionContextService.context.when</code> to limit data to current backtest time</li>
<li><strong>Memoization:</strong> One <code>ClientExchange</code> instance per <code>exchangeName</code> (via <code>ExchangeConnectionService</code>)</li>
<li><strong>VWAP Calculation:</strong> Default uses 5 one-minute candles (configurable via <code>CC_AVG_PRICE_CANDLES_COUNT</code>)</li>
<li><strong>Callback Invocation:</strong> <code>onCandleData</code> triggered after successful <code>getCandles()</code> execution</li>
</ul>
<hr>
<a id="vwap-pricing-for-realistic-execution" class="tsd-anchor"></a><h2 class="tsd-anchor-link">VWAP Pricing for Realistic Execution<a href="#vwap-pricing-for-realistic-execution" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>The <code>getAveragePrice()</code> method calculates Volume Weighted Average Price to simulate realistic entry/exit prices.</p>
<a id="vwap-formula" class="tsd-anchor"></a><h3 class="tsd-anchor-link">VWAP Formula<a href="#vwap-formula" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><pre><code><span class="hl-4">Typical</span><span class="hl-1"> </span><span class="hl-0">Price</span><span class="hl-1"> (</span><span class="hl-8">TP</span><span class="hl-1">) = (</span><span class="hl-4">High</span><span class="hl-1"> + </span><span class="hl-4">Low</span><span class="hl-1"> + </span><span class="hl-4">Close</span><span class="hl-1">) / </span><span class="hl-6">3</span><br/><br/><span class="hl-8">VWAP</span><span class="hl-1"> = </span><span class="hl-0">Σ</span><span class="hl-1">(</span><span class="hl-8">TP</span><span class="hl-1"> × </span><span class="hl-4">Volume</span><span class="hl-1">) / </span><span class="hl-0">Σ</span><span class="hl-1">(</span><span class="hl-4">Volume</span><span class="hl-1">)</span>
</code><button>Copy</button></pre>

<a id="configuration" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Configuration<a href="#configuration" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><table>
<thead>
<tr>
<th>Parameter</th>
<th>Default</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>CC_AVG_PRICE_CANDLES_COUNT</code></td>
<td>5</td>
<td>Number of 1-minute candles to use for VWAP</td>
</tr>
</tbody>
</table>
<p><strong>Example:</strong></p>
<pre><code class="typescript"><span class="hl-3">import</span><span class="hl-1"> { </span><span class="hl-4">setConfig</span><span class="hl-1"> } </span><span class="hl-3">from</span><span class="hl-1"> </span><span class="hl-2">&#39;backtest-kit&#39;</span><span class="hl-1">;</span><br/><br/><span class="hl-0">setConfig</span><span class="hl-1">({</span><br/><span class="hl-1">  </span><span class="hl-4">CC_AVG_PRICE_CANDLES_COUNT:</span><span class="hl-1"> </span><span class="hl-6">10</span><span class="hl-1">  </span><span class="hl-5">// Use 10 candles instead of 5</span><br/><span class="hl-1">});</span>
</code><button type="button">Copy</button></pre>

<a id="when-vwap-is-used" class="tsd-anchor"></a><h3 class="tsd-anchor-link">When VWAP is Used<a href="#when-vwap-is-used" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><ul>
<li><strong>Signal Opening:</strong> When <code>priceOpen</code> is not specified (immediate market entry)</li>
<li><strong>Signal Monitoring:</strong> Checking take profit and stop loss conditions</li>
<li><strong>Scheduled Signal Activation:</strong> Determining when <code>priceOpen</code> is reached</li>
</ul>
<hr>
<a id="integration-with-strategy-execution" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Integration with Strategy Execution<a href="#integration-with-strategy-execution" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>Strategies access exchange functionality through helper functions that automatically resolve the correct exchange instance.</p>
<p><img src="../media/37_exchange-configuration_4.svg" alt="Mermaid Diagram"></p>
<p><strong>Diagram: Strategy to Exchange Data Flow</strong></p>
<p>The framework uses dependency injection to automatically route strategy calls to the correct exchange instance based on execution context.</p>
<p><strong>Helper Functions:</strong></p>
<ul>
<li><code>getCandles(symbol, interval, limit)</code> - Fetch historical candles</li>
<li><code>getAveragePrice(symbol)</code> - Calculate current VWAP</li>
<li><code>formatPrice(symbol, price)</code> - Format price for logging</li>
<li><code>formatQuantity(symbol, quantity)</code> - Format quantity for logging</li>
</ul>
<hr>
<a id="complete-configuration-example" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Complete Configuration Example<a href="#complete-configuration-example" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><a id="basic-ccxt-integration" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Basic CCXT Integration<a href="#basic-ccxt-integration" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><pre><code class="typescript"><span class="hl-3">import</span><span class="hl-1"> </span><span class="hl-4">ccxt</span><span class="hl-1"> </span><span class="hl-3">from</span><span class="hl-1"> </span><span class="hl-2">&#39;ccxt&#39;</span><span class="hl-1">;</span><br/><span class="hl-3">import</span><span class="hl-1"> { </span><span class="hl-4">addExchange</span><span class="hl-1"> } </span><span class="hl-3">from</span><span class="hl-1"> </span><span class="hl-2">&#39;backtest-kit&#39;</span><span class="hl-1">;</span><br/><br/><span class="hl-0">addExchange</span><span class="hl-1">({</span><br/><span class="hl-1">  </span><span class="hl-4">exchangeName:</span><span class="hl-1"> </span><span class="hl-2">&#39;binance&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">note:</span><span class="hl-1"> </span><span class="hl-2">&#39;Binance exchange for BTC/USDT pairs&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><br/><span class="hl-1">  </span><span class="hl-0">getCandles</span><span class="hl-4">:</span><span class="hl-1"> </span><span class="hl-7">async</span><span class="hl-1"> (</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">interval</span><span class="hl-1">, </span><span class="hl-4">since</span><span class="hl-1">, </span><span class="hl-4">limit</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">exchange</span><span class="hl-1"> = </span><span class="hl-7">new</span><span class="hl-1"> </span><span class="hl-4">ccxt</span><span class="hl-1">.</span><span class="hl-0">binance</span><span class="hl-1">();</span><br/><span class="hl-1">    </span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">ohlcv</span><span class="hl-1"> = </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-4">exchange</span><span class="hl-1">.</span><span class="hl-0">fetchOHLCV</span><span class="hl-1">(</span><br/><span class="hl-1">      </span><span class="hl-4">symbol</span><span class="hl-1">,</span><br/><span class="hl-1">      </span><span class="hl-4">interval</span><span class="hl-1">,</span><br/><span class="hl-1">      </span><span class="hl-4">since</span><span class="hl-1">.</span><span class="hl-0">getTime</span><span class="hl-1">(),</span><br/><span class="hl-1">      </span><span class="hl-4">limit</span><br/><span class="hl-1">    );</span><br/><span class="hl-1">    </span><span class="hl-3">return</span><span class="hl-1"> </span><span class="hl-4">ohlcv</span><span class="hl-1">.</span><span class="hl-0">map</span><span class="hl-1">(([</span><span class="hl-4">timestamp</span><span class="hl-1">, </span><span class="hl-4">open</span><span class="hl-1">, </span><span class="hl-4">high</span><span class="hl-1">, </span><span class="hl-4">low</span><span class="hl-1">, </span><span class="hl-4">close</span><span class="hl-1">, </span><span class="hl-4">volume</span><span class="hl-1">]) </span><span class="hl-7">=&gt;</span><span class="hl-1"> ({</span><br/><span class="hl-1">      </span><span class="hl-4">timestamp</span><span class="hl-1">,</span><br/><span class="hl-1">      </span><span class="hl-4">open</span><span class="hl-1">,</span><br/><span class="hl-1">      </span><span class="hl-4">high</span><span class="hl-1">,</span><br/><span class="hl-1">      </span><span class="hl-4">low</span><span class="hl-1">,</span><br/><span class="hl-1">      </span><span class="hl-4">close</span><span class="hl-1">,</span><br/><span class="hl-1">      </span><span class="hl-4">volume</span><br/><span class="hl-1">    }));</span><br/><span class="hl-1">  },</span><br/><span class="hl-1">  </span><br/><span class="hl-1">  </span><span class="hl-0">formatPrice</span><span class="hl-4">:</span><span class="hl-1"> </span><span class="hl-7">async</span><span class="hl-1"> (</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">price</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-3">return</span><span class="hl-1"> </span><span class="hl-4">price</span><span class="hl-1">.</span><span class="hl-0">toFixed</span><span class="hl-1">(</span><span class="hl-6">2</span><span class="hl-1">);</span><br/><span class="hl-1">  },</span><br/><span class="hl-1">  </span><br/><span class="hl-1">  </span><span class="hl-0">formatQuantity</span><span class="hl-4">:</span><span class="hl-1"> </span><span class="hl-7">async</span><span class="hl-1"> (</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">quantity</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-3">return</span><span class="hl-1"> </span><span class="hl-4">quantity</span><span class="hl-1">.</span><span class="hl-0">toFixed</span><span class="hl-1">(</span><span class="hl-6">8</span><span class="hl-1">);</span><br/><span class="hl-1">  },</span><br/><span class="hl-1">  </span><br/><span class="hl-1">  </span><span class="hl-4">callbacks:</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-0">onCandleData</span><span class="hl-4">:</span><span class="hl-1"> (</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">interval</span><span class="hl-1">, </span><span class="hl-4">since</span><span class="hl-1">, </span><span class="hl-4">limit</span><span class="hl-1">, </span><span class="hl-4">data</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">      </span><span class="hl-4">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-2">`[EXCHANGE] Fetched </span><span class="hl-7">${</span><span class="hl-4">data</span><span class="hl-9">.</span><span class="hl-4">length</span><span class="hl-7">}</span><span class="hl-2">/</span><span class="hl-7">${</span><span class="hl-4">limit</span><span class="hl-7">}</span><span class="hl-2"> candles for </span><span class="hl-7">${</span><span class="hl-4">symbol</span><span class="hl-7">}</span><span class="hl-2">`</span><span class="hl-1">);</span><br/><span class="hl-1">    }</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">});</span>
</code><button type="button">Copy</button></pre>

<a id="custom-database-integration" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Custom Database Integration<a href="#custom-database-integration" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><pre><code class="typescript"><span class="hl-3">import</span><span class="hl-1"> { </span><span class="hl-4">addExchange</span><span class="hl-1"> } </span><span class="hl-3">from</span><span class="hl-1"> </span><span class="hl-2">&#39;backtest-kit&#39;</span><span class="hl-1">;</span><br/><span class="hl-3">import</span><span class="hl-1"> { </span><span class="hl-4">db</span><span class="hl-1"> } </span><span class="hl-3">from</span><span class="hl-1"> </span><span class="hl-2">&#39;./database&#39;</span><span class="hl-1">;</span><br/><br/><span class="hl-0">addExchange</span><span class="hl-1">({</span><br/><span class="hl-1">  </span><span class="hl-4">exchangeName:</span><span class="hl-1"> </span><span class="hl-2">&#39;historical-db&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">note:</span><span class="hl-1"> </span><span class="hl-2">&#39;Local database with historical OHLCV data&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><br/><span class="hl-1">  </span><span class="hl-0">getCandles</span><span class="hl-4">:</span><span class="hl-1"> </span><span class="hl-7">async</span><span class="hl-1"> (</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">interval</span><span class="hl-1">, </span><span class="hl-4">since</span><span class="hl-1">, </span><span class="hl-4">limit</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-5">// Query local database</span><br/><span class="hl-1">    </span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">candles</span><span class="hl-1"> = </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-4">db</span><span class="hl-1">.</span><span class="hl-0">query</span><span class="hl-1">(</span><br/><span class="hl-1">      </span><span class="hl-2">`SELECT timestamp, open, high, low, close, volume</span><br/><span class="hl-2">       FROM candles</span><br/><span class="hl-2">       WHERE symbol = ? AND interval = ? AND timestamp &gt;= ?</span><br/><span class="hl-2">       ORDER BY timestamp ASC</span><br/><span class="hl-2">       LIMIT ?`</span><span class="hl-1">,</span><br/><span class="hl-1">      [</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">interval</span><span class="hl-1">, </span><span class="hl-4">since</span><span class="hl-1">.</span><span class="hl-0">getTime</span><span class="hl-1">(), </span><span class="hl-4">limit</span><span class="hl-1">]</span><br/><span class="hl-1">    );</span><br/><span class="hl-1">    </span><span class="hl-3">return</span><span class="hl-1"> </span><span class="hl-4">candles</span><span class="hl-1">;</span><br/><span class="hl-1">  },</span><br/><span class="hl-1">  </span><br/><span class="hl-1">  </span><span class="hl-0">formatPrice</span><span class="hl-4">:</span><span class="hl-1"> </span><span class="hl-7">async</span><span class="hl-1"> (</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">price</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-5">// Lookup precision from database</span><br/><span class="hl-1">    </span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">precision</span><span class="hl-1"> = </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-4">db</span><span class="hl-1">.</span><span class="hl-0">getPricePrecision</span><span class="hl-1">(</span><span class="hl-4">symbol</span><span class="hl-1">);</span><br/><span class="hl-1">    </span><span class="hl-3">return</span><span class="hl-1"> </span><span class="hl-4">price</span><span class="hl-1">.</span><span class="hl-0">toFixed</span><span class="hl-1">(</span><span class="hl-4">precision</span><span class="hl-1">);</span><br/><span class="hl-1">  },</span><br/><span class="hl-1">  </span><br/><span class="hl-1">  </span><span class="hl-0">formatQuantity</span><span class="hl-4">:</span><span class="hl-1"> </span><span class="hl-7">async</span><span class="hl-1"> (</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">quantity</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">precision</span><span class="hl-1"> = </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-4">db</span><span class="hl-1">.</span><span class="hl-0">getQuantityPrecision</span><span class="hl-1">(</span><span class="hl-4">symbol</span><span class="hl-1">);</span><br/><span class="hl-1">    </span><span class="hl-3">return</span><span class="hl-1"> </span><span class="hl-4">quantity</span><span class="hl-1">.</span><span class="hl-0">toFixed</span><span class="hl-1">(</span><span class="hl-4">precision</span><span class="hl-1">);</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">});</span>
</code><button type="button">Copy</button></pre>

<hr>
<a id="common-configuration-patterns" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Common Configuration Patterns<a href="#common-configuration-patterns" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><a id="retry-logic-for-api-failures" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Retry Logic for API Failures<a href="#retry-logic-for-api-failures" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><pre><code class="typescript"><span class="hl-7">async</span><span class="hl-1"> </span><span class="hl-7">function</span><span class="hl-1"> </span><span class="hl-0">fetchWithRetry</span><span class="hl-1">(</span><span class="hl-4">fn</span><span class="hl-1">, </span><span class="hl-4">retries</span><span class="hl-1"> = </span><span class="hl-6">3</span><span class="hl-1">) {</span><br/><span class="hl-1">  </span><span class="hl-3">for</span><span class="hl-1"> (</span><span class="hl-7">let</span><span class="hl-1"> </span><span class="hl-4">i</span><span class="hl-1"> = </span><span class="hl-6">0</span><span class="hl-1">; </span><span class="hl-4">i</span><span class="hl-1"> &lt; </span><span class="hl-4">retries</span><span class="hl-1">; </span><span class="hl-4">i</span><span class="hl-1">++) {</span><br/><span class="hl-1">    </span><span class="hl-3">try</span><span class="hl-1"> {</span><br/><span class="hl-1">      </span><span class="hl-3">return</span><span class="hl-1"> </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-0">fn</span><span class="hl-1">();</span><br/><span class="hl-1">    } </span><span class="hl-3">catch</span><span class="hl-1"> (</span><span class="hl-4">error</span><span class="hl-1">) {</span><br/><span class="hl-1">      </span><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-4">i</span><span class="hl-1"> === </span><span class="hl-4">retries</span><span class="hl-1"> - </span><span class="hl-6">1</span><span class="hl-1">) </span><span class="hl-3">throw</span><span class="hl-1"> </span><span class="hl-4">error</span><span class="hl-1">;</span><br/><span class="hl-1">      </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-7">new</span><span class="hl-1"> </span><span class="hl-11">Promise</span><span class="hl-1">(</span><span class="hl-4">resolve</span><span class="hl-1"> </span><span class="hl-7">=&gt;</span><span class="hl-1"> </span><span class="hl-0">setTimeout</span><span class="hl-1">(</span><span class="hl-4">resolve</span><span class="hl-1">, </span><span class="hl-6">1000</span><span class="hl-1"> * (</span><span class="hl-4">i</span><span class="hl-1"> + </span><span class="hl-6">1</span><span class="hl-1">)));</span><br/><span class="hl-1">    }</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">}</span><br/><br/><span class="hl-0">addExchange</span><span class="hl-1">({</span><br/><span class="hl-1">  </span><span class="hl-4">exchangeName:</span><span class="hl-1"> </span><span class="hl-2">&#39;robust-exchange&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-0">getCandles</span><span class="hl-4">:</span><span class="hl-1"> </span><span class="hl-7">async</span><span class="hl-1"> (</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">interval</span><span class="hl-1">, </span><span class="hl-4">since</span><span class="hl-1">, </span><span class="hl-4">limit</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-3">return</span><span class="hl-1"> </span><span class="hl-0">fetchWithRetry</span><span class="hl-1">(</span><span class="hl-7">async</span><span class="hl-1"> () </span><span class="hl-7">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">      </span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">exchange</span><span class="hl-1"> = </span><span class="hl-7">new</span><span class="hl-1"> </span><span class="hl-4">ccxt</span><span class="hl-1">.</span><span class="hl-0">binance</span><span class="hl-1">();</span><br/><span class="hl-1">      </span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">ohlcv</span><span class="hl-1"> = </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-4">exchange</span><span class="hl-1">.</span><span class="hl-0">fetchOHLCV</span><span class="hl-1">(</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">interval</span><span class="hl-1">, </span><span class="hl-4">since</span><span class="hl-1">.</span><span class="hl-0">getTime</span><span class="hl-1">(), </span><span class="hl-4">limit</span><span class="hl-1">);</span><br/><span class="hl-1">      </span><span class="hl-5">// ... map to ICandleData</span><br/><span class="hl-1">    });</span><br/><span class="hl-1">  },</span><br/><span class="hl-1">  </span><span class="hl-5">// ... other methods</span><br/><span class="hl-1">});</span>
</code><button type="button">Copy</button></pre>

<a id="caching-candle-data" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Caching Candle Data<a href="#caching-candle-data" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><pre><code class="typescript"><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">candleCache</span><span class="hl-1"> = </span><span class="hl-7">new</span><span class="hl-1"> </span><span class="hl-0">Map</span><span class="hl-1">();</span><br/><br/><span class="hl-0">addExchange</span><span class="hl-1">({</span><br/><span class="hl-1">  </span><span class="hl-4">exchangeName:</span><span class="hl-1"> </span><span class="hl-2">&#39;cached-exchange&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-0">getCandles</span><span class="hl-4">:</span><span class="hl-1"> </span><span class="hl-7">async</span><span class="hl-1"> (</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">interval</span><span class="hl-1">, </span><span class="hl-4">since</span><span class="hl-1">, </span><span class="hl-4">limit</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">cacheKey</span><span class="hl-1"> = </span><span class="hl-2">`</span><span class="hl-7">${</span><span class="hl-4">symbol</span><span class="hl-7">}</span><span class="hl-2">-</span><span class="hl-7">${</span><span class="hl-4">interval</span><span class="hl-7">}</span><span class="hl-2">-</span><span class="hl-7">${</span><span class="hl-4">since</span><span class="hl-9">.</span><span class="hl-0">getTime</span><span class="hl-9">()</span><span class="hl-7">}</span><span class="hl-2">-</span><span class="hl-7">${</span><span class="hl-4">limit</span><span class="hl-7">}</span><span class="hl-2">`</span><span class="hl-1">;</span><br/><span class="hl-1">    </span><br/><span class="hl-1">    </span><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-4">candleCache</span><span class="hl-1">.</span><span class="hl-0">has</span><span class="hl-1">(</span><span class="hl-4">cacheKey</span><span class="hl-1">)) {</span><br/><span class="hl-1">      </span><span class="hl-3">return</span><span class="hl-1"> </span><span class="hl-4">candleCache</span><span class="hl-1">.</span><span class="hl-0">get</span><span class="hl-1">(</span><span class="hl-4">cacheKey</span><span class="hl-1">);</span><br/><span class="hl-1">    }</span><br/><span class="hl-1">    </span><br/><span class="hl-1">    </span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">exchange</span><span class="hl-1"> = </span><span class="hl-7">new</span><span class="hl-1"> </span><span class="hl-4">ccxt</span><span class="hl-1">.</span><span class="hl-0">binance</span><span class="hl-1">();</span><br/><span class="hl-1">    </span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">ohlcv</span><span class="hl-1"> = </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-4">exchange</span><span class="hl-1">.</span><span class="hl-0">fetchOHLCV</span><span class="hl-1">(</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">interval</span><span class="hl-1">, </span><span class="hl-4">since</span><span class="hl-1">.</span><span class="hl-0">getTime</span><span class="hl-1">(), </span><span class="hl-4">limit</span><span class="hl-1">);</span><br/><span class="hl-1">    </span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">candles</span><span class="hl-1"> = </span><span class="hl-4">ohlcv</span><span class="hl-1">.</span><span class="hl-0">map</span><span class="hl-1">(([</span><span class="hl-4">timestamp</span><span class="hl-1">, </span><span class="hl-4">open</span><span class="hl-1">, </span><span class="hl-4">high</span><span class="hl-1">, </span><span class="hl-4">low</span><span class="hl-1">, </span><span class="hl-4">close</span><span class="hl-1">, </span><span class="hl-4">volume</span><span class="hl-1">]) </span><span class="hl-7">=&gt;</span><span class="hl-1"> ({</span><br/><span class="hl-1">      </span><span class="hl-4">timestamp</span><span class="hl-1">, </span><span class="hl-4">open</span><span class="hl-1">, </span><span class="hl-4">high</span><span class="hl-1">, </span><span class="hl-4">low</span><span class="hl-1">, </span><span class="hl-4">close</span><span class="hl-1">, </span><span class="hl-4">volume</span><br/><span class="hl-1">    }));</span><br/><span class="hl-1">    </span><br/><span class="hl-1">    </span><span class="hl-4">candleCache</span><span class="hl-1">.</span><span class="hl-0">set</span><span class="hl-1">(</span><span class="hl-4">cacheKey</span><span class="hl-1">, </span><span class="hl-4">candles</span><span class="hl-1">);</span><br/><span class="hl-1">    </span><span class="hl-3">return</span><span class="hl-1"> </span><span class="hl-4">candles</span><span class="hl-1">;</span><br/><span class="hl-1">  },</span><br/><span class="hl-1">  </span><span class="hl-4">callbacks:</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-0">onCandleData</span><span class="hl-4">:</span><span class="hl-1"> (</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">interval</span><span class="hl-1">, </span><span class="hl-4">since</span><span class="hl-1">, </span><span class="hl-4">limit</span><span class="hl-1">, </span><span class="hl-4">data</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">      </span><span class="hl-5">// Clear cache on new data</span><br/><span class="hl-1">      </span><span class="hl-4">candleCache</span><span class="hl-1">.</span><span class="hl-0">clear</span><span class="hl-1">();</span><br/><span class="hl-1">    }</span><br/><span class="hl-1">  },</span><br/><span class="hl-1">  </span><span class="hl-5">// ... other methods</span><br/><span class="hl-1">});</span>
</code><button type="button">Copy</button></pre>

<a id="multiple-exchange-support" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Multiple Exchange Support<a href="#multiple-exchange-support" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><pre><code class="typescript"><span class="hl-5">// Configure multiple exchanges for arbitrage or comparison</span><br/><span class="hl-0">addExchange</span><span class="hl-1">({ </span><span class="hl-4">exchangeName:</span><span class="hl-1"> </span><span class="hl-2">&#39;binance&#39;</span><span class="hl-1">, </span><span class="hl-5">/* ... */</span><span class="hl-1"> });</span><br/><span class="hl-0">addExchange</span><span class="hl-1">({ </span><span class="hl-4">exchangeName:</span><span class="hl-1"> </span><span class="hl-2">&#39;coinbase&#39;</span><span class="hl-1">, </span><span class="hl-5">/* ... */</span><span class="hl-1"> });</span><br/><span class="hl-0">addExchange</span><span class="hl-1">({ </span><span class="hl-4">exchangeName:</span><span class="hl-1"> </span><span class="hl-2">&#39;kraken&#39;</span><span class="hl-1">, </span><span class="hl-5">/* ... */</span><span class="hl-1"> });</span><br/><br/><span class="hl-5">// Use different exchanges in strategies</span><br/><span class="hl-0">addStrategy</span><span class="hl-1">({</span><br/><span class="hl-1">  </span><span class="hl-4">strategyName:</span><span class="hl-1"> </span><span class="hl-2">&#39;binance-strategy&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">interval:</span><span class="hl-1"> </span><span class="hl-2">&#39;5m&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-0">getSignal</span><span class="hl-4">:</span><span class="hl-1"> </span><span class="hl-7">async</span><span class="hl-1"> (</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">when</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">candles</span><span class="hl-1"> = </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-0">getCandles</span><span class="hl-1">(</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-2">&#39;1h&#39;</span><span class="hl-1">, </span><span class="hl-6">24</span><span class="hl-1">);</span><br/><span class="hl-1">    </span><span class="hl-5">// Uses &#39;binance&#39; exchange (from execution context)</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">});</span>
</code><button type="button">Copy</button></pre>

<hr>
<a id="summary" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Summary<a href="#summary" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>The exchange configuration system provides flexible market data abstraction through:</p>
<ol>
<li><strong>Schema-Based Configuration:</strong> Define data sources via <code>IExchangeSchema</code> interface</li>
<li><strong>Required Methods:</strong> Implement <code>getCandles()</code>, <code>formatPrice()</code>, <code>formatQuantity()</code></li>
<li><strong>Optional Callbacks:</strong> Monitor data fetching via <code>onCandleData</code> lifecycle hook</li>
<li><strong>Temporal Context:</strong> Automatic look-ahead bias prevention through <code>ExecutionContextService</code></li>
<li><strong>VWAP Pricing:</strong> Realistic entry/exit simulation using volume-weighted prices</li>
<li><strong>Memoization:</strong> Efficient instance caching per exchange name</li>
</ol>
<p>For specific integration patterns with CCXT, see <a href="design_36_exchanges-data-sources.html">CCXT Integration</a>. For details on candle data structure and validation, see <a href="design_36_exchanges-data-sources.html">Candle Data &amp; Validation</a>.</p>
</div></div><div class="col-sidebar"><div class="page-menu"><div class="tsd-navigation settings"><details class="tsd-accordion"><summary class="tsd-accordion-summary"><h3><svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-chevronDown"></use></svg>Settings</h3></summary><div class="tsd-accordion-details"><div class="tsd-filter-visibility"><span class="settings-label">Member Visibility</span><ul id="tsd-filter-options"><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-protected" name="protected"/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Protected</span></label></li><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-inherited" name="inherited" checked/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Inherited</span></label></li><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-external" name="external"/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>External</span></label></li></ul></div><div class="tsd-theme-toggle"><label class="settings-label" for="tsd-theme">Theme</label><select id="tsd-theme"><option value="os">OS</option><option value="light">Light</option><option value="dark">Dark</option></select></div></div></details></div><details open class="tsd-accordion tsd-page-navigation"><summary class="tsd-accordion-summary"><h3><svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-chevronDown"></use></svg>On This Page</h3></summary><div class="tsd-accordion-details"><a href="#exchange-configuration"><span>Exchange <wbr/>Configuration</span></a><ul><li><a href="#purpose"><span>Purpose</span></a></li><li><a href="#overview"><span>Overview</span></a></li><li><a href="#configuration-flow"><span>Configuration <wbr/>Flow</span></a></li><li><a href="#iexchangeschema-interface"><span>IExchange<wbr/>Schema <wbr/>Interface</span></a></li><li><a href="#required-methods"><span>Required <wbr/>Methods</span></a></li><li><ul><li><a href="#getcandles"><span>get<wbr/>Candles()</span></a></li><li><a href="#formatprice"><span>format<wbr/>Price()</span></a></li><li><a href="#formatquantity"><span>format<wbr/>Quantity()</span></a></li></ul></li><li><a href="#optional-callbacks"><span>Optional <wbr/>Callbacks</span></a></li><li><ul><li><a href="#iexchangecallbacks"><span>IExchange<wbr/>Callbacks</span></a></li></ul></li><li><a href="#registration-with-addexchange"><span>Registration with add<wbr/>Exchange()</span></a></li><li><a href="#clientexchange-implementation"><span>Client<wbr/>Exchange <wbr/>Implementation</span></a></li><li><a href="#vwap-pricing-for-realistic-execution"><span>VWAP <wbr/>Pricing for <wbr/>Realistic <wbr/>Execution</span></a></li><li><ul><li><a href="#vwap-formula"><span>VWAP <wbr/>Formula</span></a></li><li><a href="#configuration"><span>Configuration</span></a></li><li><a href="#when-vwap-is-used"><span>When VWAP is <wbr/>Used</span></a></li></ul></li><li><a href="#integration-with-strategy-execution"><span>Integration with <wbr/>Strategy <wbr/>Execution</span></a></li><li><a href="#complete-configuration-example"><span>Complete <wbr/>Configuration <wbr/>Example</span></a></li><li><ul><li><a href="#basic-ccxt-integration"><span>Basic CCXT <wbr/>Integration</span></a></li><li><a href="#custom-database-integration"><span>Custom <wbr/>Database <wbr/>Integration</span></a></li></ul></li><li><a href="#common-configuration-patterns"><span>Common <wbr/>Configuration <wbr/>Patterns</span></a></li><li><ul><li><a href="#retry-logic-for-api-failures"><span>Retry <wbr/>Logic for API <wbr/>Failures</span></a></li><li><a href="#caching-candle-data"><span>Caching <wbr/>Candle <wbr/>Data</span></a></li><li><a href="#multiple-exchange-support"><span>Multiple <wbr/>Exchange <wbr/>Support</span></a></li></ul></li><li><a href="#summary"><span>Summary</span></a></li></ul></div></details></div><div class="site-menu"><nav class="tsd-navigation"><a href="../modules.html">backtest-kit</a><ul class="tsd-small-nested-navigation" id="tsd-nav-container"><li>Loading...</li></ul></nav></div></div></div><footer><p class="tsd-generator">Generated using <a href="https://typedoc.org/" target="_blank">TypeDoc</a></p></footer><div class="overlay"></div></body></html>

<!-- Yandex.Metrika counter -->
<script type="text/javascript">
    (function(m,e,t,r,i,k,a){
        m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
        m[i].l=1*new Date();
        for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }}
        k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)
    })(window, document,'script','https://mc.yandex.ru/metrika/tag.js?id=105455585', 'ym');

    ym(105455585, 'init', {ssr:true, webvisor:true, clickmap:true, ecommerce:"dataLayer", accurateTrackBounce:true, trackLinks:true});
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/105455585" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
<!-- /Yandex.Metrika counter -->

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-3MQZEBBDDR"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-3MQZEBBDDR');
</script>
