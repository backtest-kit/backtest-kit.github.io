<!DOCTYPE html><html class="default" lang="en" data-base=".."><head><meta charset="utf-8"/><meta http-equiv="x-ua-compatible" content="IE=edge"/><title>design/09_architecture | backtest-kit</title><meta name="description" content="Documentation for backtest-kit"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="stylesheet" href="../assets/style.css"/><link rel="stylesheet" href="../assets/highlight.css"/><script defer src="../assets/main.js"></script><script async src="../assets/icons.js" id="tsd-icons-script"></script><script async src="../assets/search.js" id="tsd-search-script"></script><script async src="../assets/navigation.js" id="tsd-nav-script"></script><script async src="../assets/hierarchy.js" id="tsd-hierarchy-script"></script></head><body><script>document.documentElement.dataset.theme = localStorage.getItem("tsd-theme") || "os";document.body.style.display="none";setTimeout(() => app?app.showPage():document.body.style.removeProperty("display"),500)</script><header class="tsd-page-toolbar"><div class="tsd-toolbar-contents container"><div class="table-cell" id="tsd-search"><div class="field"><label for="tsd-search-field" class="tsd-widget tsd-toolbar-icon search no-caption"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-search"></use></svg></label><input type="text" id="tsd-search-field" aria-label="Search"/></div><div class="field"><div id="tsd-toolbar-links"></div></div><ul class="results"><li class="state loading">Preparing search index...</li><li class="state failure">The search index is not available</li></ul><a href="../index.html" class="title">backtest-kit</a></div><div class="table-cell" id="tsd-widgets"><a href="#" class="tsd-widget tsd-toolbar-icon menu no-caption" data-toggle="menu" aria-label="Menu"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-menu"></use></svg></a></div></div></header><div class="container container-main"><div class="col-content"><div class="tsd-page-title"><ul class="tsd-breadcrumb"><li><a href="../modules.html">backtest-kit</a></li><li><a href="design_09_architecture.html">design/09_architecture</a></li></ul></div><div class="tsd-panel tsd-typography"><a id="architecture" class="tsd-anchor"></a><h1 class="tsd-anchor-link">Architecture<a href="#architecture" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h1><a id="purpose-and-scope" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Purpose and Scope<a href="#purpose-and-scope" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>This document provides a comprehensive overview of backtest-kit's system architecture, focusing on its layered design, dependency injection infrastructure, and cross-cutting concerns. The architecture implements a modular service-oriented design where approximately 60 services are organized into 10 functional categories and wired together through constructor injection.</p>
<p>This page covers the high-level architectural patterns and structural organization. For detailed information about specific subsystems:</p>
<ul>
<li>Component registration patterns: see <a href="design_08_component_registration.html">Component Registration</a></li>
<li>Execution mode implementations: see <a href="design_06_execution_modes.html">Execution Modes</a></li>
<li>Service layer details: see <a href="design_38_service_layer.html">Service Layer</a></li>
<li>Event system implementation: see <a href="design_13_event_system.html">Event System</a></li>
</ul>
<hr>
<a id="layered-architecture-overview" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Layered Architecture Overview<a href="#layered-architecture-overview" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>The system implements a seven-layer architecture where each layer has distinct responsibilities and clear boundaries. Layers communicate through well-defined interfaces and dependency injection, preventing tight coupling between implementation details.</p>
<a id="system-layers-diagram" class="tsd-anchor"></a><h3 class="tsd-anchor-link">System Layers Diagram<a href="#system-layers-diagram" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><img src="../media/09_Architecture_0.svg" alt="Mermaid Diagram"></p>
<p><strong>Layer 1: Public API</strong> provides user-facing functions exported from <a href="">src/index.ts:1-184</a>. The <code>add.ts</code> functions register components (<a href="">src/function/add.ts:1-445</a>), while <code>event.ts</code> functions subscribe to system events (<a href="">src/function/event.ts:1-892</a>). Utility classes like <code>Backtest</code>, <code>Live</code>, and <code>Walker</code> provide high-level execution control.</p>
<p><strong>Layer 2: Command Services</strong> implement validation and delegation for execution modes. They validate parameters, set up execution context, and delegate to Logic Services.</p>
<p><strong>Layer 3: Logic Services</strong> come in two variants: Private services implement core execution logic with AsyncGenerator streaming, while Public services wrap Private services with external-facing contracts.</p>
<p><strong>Layer 4: Global Services</strong> inject execution context (symbol, timestamp, backtest flag) into lower-layer services, enabling implicit parameter passing without polluting method signatures.</p>
<p><strong>Layer 5: Connection Services</strong> manage lifecycle and memoization of Client class instances. They create instances on-demand and cache them by unique keys (symbol, strategyName, exchangeName combinations).</p>
<p><strong>Layer 6: Business Logic</strong> contains the core trading logic implemented in Client classes like <code>ClientStrategy</code>, <code>ClientExchange</code>, <code>ClientRisk</code>. These classes are framework-agnostic and focus purely on trading domain logic.</p>
<p><strong>Layer 7: Schema &amp; Validation</strong> stores registered component configurations and validates them against framework rules. Schema Services provide name-based lookup, while Validation Services enforce 30+ validation rules per component type.</p>
<hr>
<a id="service-organization-and-categories" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Service Organization and Categories<a href="#service-organization-and-categories" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>Services are organized into 10 functional categories following a matrix pattern where most component types (Strategy, Exchange, Frame, Risk, Sizing) have corresponding Connection, Schema, Global, and Validation services.</p>
<a id="service-category-matrix" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Service Category Matrix<a href="#service-category-matrix" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><img src="../media/09_Architecture_1.svg" alt="Mermaid Diagram"></p>
<a id="service-category-responsibilities" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Service Category Responsibilities<a href="#service-category-responsibilities" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><table>
<thead>
<tr>
<th>Category</th>
<th>Responsibility</th>
<th>Example Services</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Base Services</strong></td>
<td>Cross-cutting infrastructure like logging</td>
<td><code>LoggerService</code></td>
</tr>
<tr>
<td><strong>Context Services</strong></td>
<td>Store execution context (symbol, timestamp, mode) for implicit parameter passing</td>
<td><code>ExecutionContextService</code>, <code>MethodContextService</code></td>
</tr>
<tr>
<td><strong>Connection Services</strong></td>
<td>Create and memoize Client class instances by unique keys</td>
<td><code>StrategyConnectionService</code>, <code>ExchangeConnectionService</code></td>
</tr>
<tr>
<td><strong>Schema Services</strong></td>
<td>Store and retrieve registered component configurations</td>
<td><code>StrategySchemaService</code>, <code>ExchangeSchemaService</code></td>
</tr>
<tr>
<td><strong>Global Services</strong></td>
<td>Inject context into Connection Services and orchestrate component interactions</td>
<td><code>StrategyGlobalService</code>, <code>ExchangeGlobalService</code></td>
</tr>
<tr>
<td><strong>Command Services</strong></td>
<td>Validate parameters and delegate to Logic Services for execution modes</td>
<td><code>BacktestCommandService</code>, <code>LiveCommandService</code></td>
</tr>
<tr>
<td><strong>Logic Services</strong></td>
<td>Implement core execution logic with Private/Public separation</td>
<td><code>BacktestLogicPrivateService</code>, <code>LiveLogicPrivateService</code></td>
</tr>
<tr>
<td><strong>Markdown Services</strong></td>
<td>Accumulate events and generate reports with statistical calculations</td>
<td><code>BacktestMarkdownService</code>, <code>LiveMarkdownService</code></td>
</tr>
<tr>
<td><strong>Validation Services</strong></td>
<td>Enforce 30+ validation rules per component type during registration</td>
<td><code>StrategyValidationService</code>, <code>ExchangeValidationService</code></td>
</tr>
<tr>
<td><strong>Template Services</strong></td>
<td>Generate code templates for AI-powered optimizer</td>
<td><code>OptimizerTemplateService</code></td>
</tr>
</tbody>
</table>
<p>The matrix pattern creates consistency across component types: if a new component type is added (e.g., <code>Filter</code>), it follows the same pattern with <code>FilterConnectionService</code>, <code>FilterSchemaService</code>, <code>FilterGlobalService</code>, and <code>FilterValidationService</code>.</p>
<hr>
<a id="dependency-injection-system" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Dependency Injection System<a href="#dependency-injection-system" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>The system implements a lightweight dependency injection container that wires approximately 60 services together at startup. The DI system uses three core primitives: <code>TYPES</code> symbol registry, <code>provide()</code> registration, and <code>inject()</code> retrieval.</p>
<a id="di-system-flow-diagram" class="tsd-anchor"></a><h3 class="tsd-anchor-link">DI System Flow Diagram<a href="#di-system-flow-diagram" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><img src="../media/09_Architecture_2.svg" alt="Mermaid Diagram"></p>
<a id="service-registration-example" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Service Registration Example<a href="#service-registration-example" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>The registration flow in <a href="">src/lib/core/provide.ts:52-131</a> follows a consistent pattern:</p>
<pre><code class="typescript"><span class="hl-5">// Base services</span><br/><span class="hl-0">provide</span><span class="hl-1">(</span><span class="hl-8">TYPES</span><span class="hl-1">.</span><span class="hl-4">loggerService</span><span class="hl-1">, () </span><span class="hl-7">=&gt;</span><span class="hl-1"> </span><span class="hl-7">new</span><span class="hl-1"> </span><span class="hl-0">LoggerService</span><span class="hl-1">());</span><br/><br/><span class="hl-5">// Context services</span><br/><span class="hl-0">provide</span><span class="hl-1">(</span><span class="hl-8">TYPES</span><span class="hl-1">.</span><span class="hl-4">executionContextService</span><span class="hl-1">, () </span><span class="hl-7">=&gt;</span><span class="hl-1"> </span><span class="hl-7">new</span><span class="hl-1"> </span><span class="hl-0">ExecutionContextService</span><span class="hl-1">());</span><br/><span class="hl-0">provide</span><span class="hl-1">(</span><span class="hl-8">TYPES</span><span class="hl-1">.</span><span class="hl-4">methodContextService</span><span class="hl-1">, () </span><span class="hl-7">=&gt;</span><span class="hl-1"> </span><span class="hl-7">new</span><span class="hl-1"> </span><span class="hl-0">MethodContextService</span><span class="hl-1">());</span><br/><br/><span class="hl-5">// Connection services (7 total)</span><br/><span class="hl-0">provide</span><span class="hl-1">(</span><span class="hl-8">TYPES</span><span class="hl-1">.</span><span class="hl-4">strategyConnectionService</span><span class="hl-1">, () </span><span class="hl-7">=&gt;</span><span class="hl-1"> </span><span class="hl-7">new</span><span class="hl-1"> </span><span class="hl-0">StrategyConnectionService</span><span class="hl-1">());</span><br/><span class="hl-0">provide</span><span class="hl-1">(</span><span class="hl-8">TYPES</span><span class="hl-1">.</span><span class="hl-4">exchangeConnectionService</span><span class="hl-1">, () </span><span class="hl-7">=&gt;</span><span class="hl-1"> </span><span class="hl-7">new</span><span class="hl-1"> </span><span class="hl-0">ExchangeConnectionService</span><span class="hl-1">());</span><br/><span class="hl-5">// ... 5 more</span><br/><br/><span class="hl-5">// Schema services (7 total)</span><br/><span class="hl-0">provide</span><span class="hl-1">(</span><span class="hl-8">TYPES</span><span class="hl-1">.</span><span class="hl-4">strategySchemaService</span><span class="hl-1">, () </span><span class="hl-7">=&gt;</span><span class="hl-1"> </span><span class="hl-7">new</span><span class="hl-1"> </span><span class="hl-0">StrategySchemaService</span><span class="hl-1">());</span><br/><span class="hl-0">provide</span><span class="hl-1">(</span><span class="hl-8">TYPES</span><span class="hl-1">.</span><span class="hl-4">exchangeSchemaService</span><span class="hl-1">, () </span><span class="hl-7">=&gt;</span><span class="hl-1"> </span><span class="hl-7">new</span><span class="hl-1"> </span><span class="hl-0">ExchangeSchemaService</span><span class="hl-1">());</span><br/><span class="hl-5">// ... 5 more</span>
</code><button type="button">Copy</button></pre>

<p>Each service's constructor declares its dependencies, which are automatically resolved by the DI container. For example, <code>StrategyConnectionService</code> receives <code>LoggerService</code>, <code>ExecutionContextService</code>, and <code>StrategySchemaService</code> through constructor injection.</p>
<a id="the-backtest-aggregation-object" class="tsd-anchor"></a><h3 class="tsd-anchor-link">The Backtest Aggregation Object<a href="#the-backtest-aggregation-object" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>All services are aggregated into a single <code>backtest</code> object in <a href="">src/lib/index.ts:212-224</a> for discoverability:</p>
<pre><code class="typescript"><span class="hl-3">export</span><span class="hl-1"> </span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">backtest</span><span class="hl-1"> = {</span><br/><span class="hl-1">  ...</span><span class="hl-4">baseServices</span><span class="hl-1">,           </span><span class="hl-5">// loggerService</span><br/><span class="hl-1">  ...</span><span class="hl-4">contextServices</span><span class="hl-1">,        </span><span class="hl-5">// executionContextService, methodContextService</span><br/><span class="hl-1">  ...</span><span class="hl-4">connectionServices</span><span class="hl-1">,     </span><span class="hl-5">// 7 Connection Services</span><br/><span class="hl-1">  ...</span><span class="hl-4">schemaServices</span><span class="hl-1">,         </span><span class="hl-5">// 7 Schema Services</span><br/><span class="hl-1">  ...</span><span class="hl-4">globalServices</span><span class="hl-1">,         </span><span class="hl-5">// 7 Global Services</span><br/><span class="hl-1">  ...</span><span class="hl-4">commandServices</span><span class="hl-1">,        </span><span class="hl-5">// 3 Command Services</span><br/><span class="hl-1">  ...</span><span class="hl-4">logicPrivateServices</span><span class="hl-1">,   </span><span class="hl-5">// 3 Logic Private Services</span><br/><span class="hl-1">  ...</span><span class="hl-4">logicPublicServices</span><span class="hl-1">,    </span><span class="hl-5">// 3 Logic Public Services</span><br/><span class="hl-1">  ...</span><span class="hl-4">markdownServices</span><span class="hl-1">,       </span><span class="hl-5">// 7 Markdown Services</span><br/><span class="hl-1">  ...</span><span class="hl-4">validationServices</span><span class="hl-1">,     </span><span class="hl-5">// 7 Validation Services</span><br/><span class="hl-1">  ...</span><span class="hl-4">templateServices</span><span class="hl-1">,       </span><span class="hl-5">// 1 Template Service</span><br/><span class="hl-1">};</span>
</code><button type="button">Copy</button></pre>

<p>This flattened structure enables easy access: <code>backtest.strategyConnectionService.getStrategy(...)</code> instead of navigating nested categories. The object is exported as <code>lib</code> in <a href="">src/index.ts:183</a> for external use.</p>
<hr>
<a id="context-propagation-architecture" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Context Propagation Architecture<a href="#context-propagation-architecture" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>The system uses two context services to propagate execution state through service layers without explicit parameter passing. This pattern reduces method signature pollution and enables consistent context access across the service graph.</p>
<a id="context-services" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Context Services<a href="#context-services" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><strong>ExecutionContextService</strong> (<a href="">src/lib/services/context/ExecutionContextService.ts</a>) stores three execution-level parameters:</p>
<table>
<thead>
<tr>
<th>Property</th>
<th>Type</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>symbol</code></td>
<td><code>string</code></td>
<td>Trading symbol (e.g., &quot;BTCUSDT&quot;) for current execution</td>
</tr>
<tr>
<td><code>when</code></td>
<td><code>Date</code></td>
<td>Current timestamp (backtest: historical, live: real-time)</td>
</tr>
<tr>
<td><code>backtest</code></td>
<td><code>boolean</code></td>
<td>Execution mode flag (true: backtest, false: live)</td>
</tr>
</tbody>
</table>
<p><strong>MethodContextService</strong> (<a href="">src/lib/services/context/MethodContextService.ts</a>) stores component-level parameters:</p>
<table>
<thead>
<tr>
<th>Property</th>
<th>Type</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>strategyName</code></td>
<td><code>string</code></td>
<td>Active strategy identifier</td>
</tr>
<tr>
<td><code>exchangeName</code></td>
<td><code>string</code></td>
<td>Active exchange identifier</td>
</tr>
<tr>
<td><code>frameName</code></td>
<td><code>string</code></td>
<td>Active frame identifier (backtest only)</td>
</tr>
</tbody>
</table>
<a id="context-injection-flow" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Context Injection Flow<a href="#context-injection-flow" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><img src="../media/09_Architecture_3.svg" alt="Mermaid Diagram"></p>
<p><strong>Flow Description:</strong></p>
<ol>
<li><strong>Context Initialization</strong>: Logic Services set execution context before each operation</li>
<li><strong>Context Propagation</strong>: Global Services read context and pass to Connection Services</li>
<li><strong>Instance Creation</strong>: Connection Services inject context into Client class constructors</li>
<li><strong>Context Cleanup</strong>: Logic Services clear context after operation completes</li>
</ol>
<p>This pattern ensures that methods like <code>getStrategy(symbol, strategyName, exchangeName)</code> don't need to pass <code>when</code> and <code>backtest</code> parameters explicitly - they're available through context services.</p>
<a id="context-scoping" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Context Scoping<a href="#context-scoping" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Context follows a request-scoped lifecycle:</p>
<ol>
<li>Set at operation start in Logic Services</li>
<li>Accessed during service chain execution</li>
<li>Cleared at operation end to prevent leakage</li>
</ol>
<p>The system is single-threaded (Node.js event loop), so context state is safe without synchronization primitives.</p>
<hr>
<a id="event-system-architecture" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Event System Architecture<a href="#event-system-architecture" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>The event system implements a comprehensive publish-subscribe pattern with 16 distinct event channels. Events are emitted by Logic Services and Client classes during execution, enabling observability without coupling core logic to monitoring concerns.</p>
<a id="event-emitter-registry" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Event Emitter Registry<a href="#event-emitter-registry" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>All event emitters are defined in <a href="">src/config/emitters.ts:1-122</a> using the <code>Subject</code> pattern from <code>functools-kit</code>:</p>
<p><img src="../media/09_Architecture_4.svg" alt="Mermaid Diagram"></p>
<a id="event-emitter-types-and-purposes" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Event Emitter Types and Purposes<a href="#event-emitter-types-and-purposes" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><table>
<thead>
<tr>
<th>Emitter</th>
<th>Type</th>
<th>Purpose</th>
<th>Emitted By</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>signalEmitter</code></td>
<td>Universal</td>
<td>All signal lifecycle events (idle, opened, active, closed, cancelled)</td>
<td><code>ClientStrategy</code></td>
</tr>
<tr>
<td><code>signalLiveEmitter</code></td>
<td>Live-only</td>
<td>Signal events during live trading</td>
<td><code>LiveLogicPrivateService</code></td>
</tr>
<tr>
<td><code>signalBacktestEmitter</code></td>
<td>Backtest-only</td>
<td>Signal events during backtesting</td>
<td><code>BacktestLogicPrivateService</code></td>
</tr>
<tr>
<td><code>progressBacktestEmitter</code></td>
<td>Progress</td>
<td>Frame processing progress (frames/total)</td>
<td><code>BacktestLogicPrivateService</code></td>
</tr>
<tr>
<td><code>progressWalkerEmitter</code></td>
<td>Progress</td>
<td>Strategy testing progress (strategies/total)</td>
<td><code>WalkerLogicPrivateService</code></td>
</tr>
<tr>
<td><code>progressOptimizerEmitter</code></td>
<td>Progress</td>
<td>Data source processing progress (sources/total)</td>
<td><code>ClientOptimizer</code></td>
</tr>
<tr>
<td><code>doneLiveSubject</code></td>
<td>Completion</td>
<td>Live execution finished</td>
<td><code>LiveLogicPrivateService</code></td>
</tr>
<tr>
<td><code>doneBacktestSubject</code></td>
<td>Completion</td>
<td>Backtest execution finished</td>
<td><code>BacktestLogicPrivateService</code></td>
</tr>
<tr>
<td><code>doneWalkerSubject</code></td>
<td>Completion</td>
<td>Walker execution finished</td>
<td><code>WalkerLogicPrivateService</code></td>
</tr>
<tr>
<td><code>walkerCompleteSubject</code></td>
<td>Completion</td>
<td>Walker results with best strategy</td>
<td><code>WalkerLogicPrivateService</code></td>
</tr>
<tr>
<td><code>performanceEmitter</code></td>
<td>Monitoring</td>
<td>Operation timing metrics for profiling</td>
<td>All Logic Services</td>
</tr>
<tr>
<td><code>errorEmitter</code></td>
<td>Monitoring</td>
<td>Recoverable errors (execution continues)</td>
<td>All Logic Services</td>
</tr>
<tr>
<td><code>exitEmitter</code></td>
<td>Monitoring</td>
<td>Fatal errors (execution terminates)</td>
<td>Background execution methods</td>
</tr>
<tr>
<td><code>walkerEmitter</code></td>
<td>Analysis</td>
<td>Current best strategy during walker</td>
<td><code>WalkerLogicPrivateService</code></td>
</tr>
<tr>
<td><code>partialProfitSubject</code></td>
<td>Analysis</td>
<td>Profit milestone reached (10%, 20%, 30%)</td>
<td><code>ClientStrategy</code></td>
</tr>
<tr>
<td><code>partialLossSubject</code></td>
<td>Analysis</td>
<td>Loss milestone reached (10%, 20%, 30%)</td>
<td><code>ClientStrategy</code></td>
</tr>
</tbody>
</table>
<a id="listener-api-pattern" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Listener API Pattern<a href="#listener-api-pattern" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Event consumers use listener functions from <a href="">src/function/event.ts:1-892</a> that implement a consistent API pattern:</p>
<p><img src="../media/09_Architecture_5.svg" alt="Mermaid Diagram"></p>
<a id="queued-callback-processing" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Queued Callback Processing<a href="#queued-callback-processing" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>All listener functions use the <code>queued()</code> wrapper from <code>functools-kit</code> (<a href="">src/function/event.ts:69</a>) to ensure sequential processing of async callbacks:</p>
<pre><code class="typescript"><span class="hl-3">export</span><span class="hl-1"> </span><span class="hl-7">function</span><span class="hl-1"> </span><span class="hl-0">listenSignal</span><span class="hl-1">(</span><span class="hl-0">fn</span><span class="hl-1">: (</span><span class="hl-4">event</span><span class="hl-1">: </span><span class="hl-13">IStrategyTickResult</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> </span><span class="hl-13">void</span><span class="hl-1">) {</span><br/><span class="hl-1">  </span><span class="hl-4">backtest</span><span class="hl-1">.</span><span class="hl-4">loggerService</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-8">LISTEN_SIGNAL_METHOD_NAME</span><span class="hl-1">);</span><br/><span class="hl-1">  </span><span class="hl-3">return</span><span class="hl-1"> </span><span class="hl-4">signalEmitter</span><span class="hl-1">.</span><span class="hl-0">subscribe</span><span class="hl-1">(</span><span class="hl-0">queued</span><span class="hl-1">(</span><span class="hl-7">async</span><span class="hl-1"> (</span><span class="hl-4">event</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> </span><span class="hl-0">fn</span><span class="hl-1">(</span><span class="hl-4">event</span><span class="hl-1">)));</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<p>The <code>queued()</code> wrapper guarantees:</p>
<ol>
<li>Callbacks execute in order of event emission</li>
<li>Each callback completes before the next starts</li>
<li>Async callbacks are awaited properly</li>
<li>No concurrent execution of the same callback</li>
</ol>
<p>This prevents race conditions when callbacks have side effects (e.g., writing to database, updating UI state).</p>
<a id="event-emission-example" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Event Emission Example<a href="#event-emission-example" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Logic Services emit events at key lifecycle points:</p>
<pre><code class="typescript"><span class="hl-5">// In BacktestLogicPrivateService</span><br/><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">result</span><span class="hl-1"> = </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-7">this</span><span class="hl-1">.</span><span class="hl-4">strategyGlobalService</span><span class="hl-1">.</span><span class="hl-0">tick</span><span class="hl-1">(</span><br/><span class="hl-1">  </span><span class="hl-4">strategyName</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">exchangeName</span><br/><span class="hl-1">);</span><br/><br/><span class="hl-5">// Emit to all three signal channels</span><br/><span class="hl-4">signalEmitter</span><span class="hl-1">.</span><span class="hl-0">next</span><span class="hl-1">(</span><span class="hl-4">result</span><span class="hl-1">);</span><br/><span class="hl-4">signalBacktestEmitter</span><span class="hl-1">.</span><span class="hl-0">next</span><span class="hl-1">(</span><span class="hl-4">result</span><span class="hl-1">);</span><br/><br/><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-4">result</span><span class="hl-1">.</span><span class="hl-4">action</span><span class="hl-1"> === </span><span class="hl-2">&quot;opened&quot;</span><span class="hl-1">) {</span><br/><span class="hl-1">  </span><span class="hl-5">// Also emit to markdown service for report accumulation</span><br/><span class="hl-1">  </span><span class="hl-7">this</span><span class="hl-1">.</span><span class="hl-4">backtestMarkdownService</span><span class="hl-1">.</span><span class="hl-0">addSignal</span><span class="hl-1">(</span><span class="hl-4">result</span><span class="hl-1">);</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<hr>
<a id="module-boundaries-and-interactions" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Module Boundaries and Interactions<a href="#module-boundaries-and-interactions" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>The system maintains clear module boundaries with well-defined interaction patterns. Modules communicate through interfaces and abstractions rather than concrete implementations.</p>
<a id="primary-module-boundaries" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Primary Module Boundaries<a href="#primary-module-boundaries" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><img src="../media/09_Architecture_6.svg" alt="Mermaid Diagram"></p>
<a id="interaction-patterns-by-layer" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Interaction Patterns by Layer<a href="#interaction-patterns-by-layer" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><strong>API Layer → Service Layer</strong>:</p>
<ul>
<li>Validates user input through Validation Services</li>
<li>Registers configurations through Schema Services</li>
<li>Delegates execution through Command Services</li>
<li>Never directly instantiates service classes (uses DI)</li>
</ul>
<p><strong>Service Layer → Business Logic Layer</strong>:</p>
<ul>
<li>Global Services orchestrate Connection Services</li>
<li>Connection Services create and cache Client instances</li>
<li>Services inject context and dependencies via constructors</li>
<li>No direct instantiation - uses factory pattern</li>
</ul>
<p><strong>Business Logic Layer → Infrastructure Layer</strong>:</p>
<ul>
<li>Client classes emit events to Subject instances</li>
<li>Client classes write state to Persistence Adapters</li>
<li>Client classes read context from Context Services</li>
<li>No infrastructure knowledge in business logic</li>
</ul>
<p><strong>Cross-Layer Communication</strong>:</p>
<ul>
<li>All layers use event emitters for loose coupling</li>
<li>Context services provide implicit parameter passing</li>
<li>DI container resolves all dependencies at startup</li>
<li>No circular dependencies between modules</li>
</ul>
<hr>
<a id="testing-and-extensibility-patterns" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Testing and Extensibility Patterns<a href="#testing-and-extensibility-patterns" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>The architecture supports testing and customization through strategic injection points.</p>
<a id="persistence-adapter-customization" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Persistence Adapter Customization<a href="#persistence-adapter-customization" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>The system provides four persistence adapters that can be replaced with custom implementations (<a href="">test/config/setup.mjs:6-64</a>):</p>
<pre><code class="typescript"><span class="hl-4">PersistSignalAdapter</span><span class="hl-1">.</span><span class="hl-0">usePersistSignalAdapter</span><span class="hl-1">(</span><span class="hl-7">class</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-7">async</span><span class="hl-1"> </span><span class="hl-0">waitForInit</span><span class="hl-1">() { </span><span class="hl-5">/* Initialize connection */</span><span class="hl-1"> }</span><br/><span class="hl-1">  </span><span class="hl-7">async</span><span class="hl-1"> </span><span class="hl-0">readValue</span><span class="hl-1">(</span><span class="hl-4">id</span><span class="hl-1">) { </span><span class="hl-5">/* Read from Redis/MongoDB */</span><span class="hl-1"> }</span><br/><span class="hl-1">  </span><span class="hl-7">async</span><span class="hl-1"> </span><span class="hl-0">hasValue</span><span class="hl-1">(</span><span class="hl-4">id</span><span class="hl-1">) { </span><span class="hl-5">/* Check existence */</span><span class="hl-1"> }</span><br/><span class="hl-1">  </span><span class="hl-7">async</span><span class="hl-1"> </span><span class="hl-0">writeValue</span><span class="hl-1">(</span><span class="hl-4">id</span><span class="hl-1">, </span><span class="hl-4">value</span><span class="hl-1">) { </span><span class="hl-5">/* Atomic write */</span><span class="hl-1"> }</span><br/><span class="hl-1">});</span><br/><br/><span class="hl-4">PersistRiskAdapter</span><span class="hl-1">.</span><span class="hl-0">usePersistRiskAdapter</span><span class="hl-1">(</span><span class="hl-7">class</span><span class="hl-1"> { </span><span class="hl-5">/* ... */</span><span class="hl-1"> });</span><br/><span class="hl-4">PersistScheduleAdapter</span><span class="hl-1">.</span><span class="hl-0">usePersistScheduleAdapter</span><span class="hl-1">(</span><span class="hl-7">class</span><span class="hl-1"> { </span><span class="hl-5">/* ... */</span><span class="hl-1"> });</span><br/><span class="hl-4">PersistPartialAdapter</span><span class="hl-1">.</span><span class="hl-0">usePersistPartialAdapter</span><span class="hl-1">(</span><span class="hl-7">class</span><span class="hl-1"> { </span><span class="hl-5">/* ... */</span><span class="hl-1"> });</span>
</code><button type="button">Copy</button></pre>

<p>This enables testing with mock adapters (as shown in test setup) or production deployment with Redis/PostgreSQL backends without modifying core logic.</p>
<a id="logger-customization" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Logger Customization<a href="#logger-customization" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>The <code>setLogger()</code> function (<a href="">src/function/setup.ts</a>) replaces the default logger with custom implementations:</p>
<pre><code class="typescript"><span class="hl-0">setLogger</span><span class="hl-1">({</span><br/><span class="hl-1">  </span><span class="hl-0">log</span><span class="hl-4">:</span><span class="hl-1"> (</span><span class="hl-4">message</span><span class="hl-1">, ...</span><span class="hl-4">args</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> { </span><span class="hl-5">/* Custom logging */</span><span class="hl-1"> },</span><br/><span class="hl-1">  </span><span class="hl-0">info</span><span class="hl-4">:</span><span class="hl-1"> (</span><span class="hl-4">message</span><span class="hl-1">, ...</span><span class="hl-4">args</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> { </span><span class="hl-5">/* Custom info */</span><span class="hl-1"> },</span><br/><span class="hl-1">  </span><span class="hl-0">warn</span><span class="hl-4">:</span><span class="hl-1"> (</span><span class="hl-4">message</span><span class="hl-1">, ...</span><span class="hl-4">args</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> { </span><span class="hl-5">/* Custom warnings */</span><span class="hl-1"> },</span><br/><span class="hl-1">  </span><span class="hl-0">error</span><span class="hl-4">:</span><span class="hl-1"> (</span><span class="hl-4">message</span><span class="hl-1">, ...</span><span class="hl-4">args</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> { </span><span class="hl-5">/* Custom errors */</span><span class="hl-1"> },</span><br/><span class="hl-1">});</span>
</code><button type="button">Copy</button></pre>

<a id="configuration-override" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Configuration Override<a href="#configuration-override" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>The <code>setConfig()</code> function (<a href="">test/config/setup.mjs:66-73</a>) modifies validation parameters and execution settings:</p>
<pre><code class="typescript"><span class="hl-0">setConfig</span><span class="hl-1">({</span><br/><span class="hl-1">  </span><span class="hl-4">CC_MIN_TAKEPROFIT_DISTANCE_PERCENT:</span><span class="hl-1"> </span><span class="hl-6">0.5</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">CC_MAX_STOPLOSS_DISTANCE_PERCENT:</span><span class="hl-1"> </span><span class="hl-6">15</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">CC_MAX_SIGNAL_LIFETIME_MINUTES:</span><span class="hl-1"> </span><span class="hl-6">1440</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">CC_GET_CANDLES_RETRY_COUNT:</span><span class="hl-1"> </span><span class="hl-6">3</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">CC_GET_CANDLES_RETRY_DELAY_MS:</span><span class="hl-1"> </span><span class="hl-6">1000</span><span class="hl-1">,</span><br/><span class="hl-1">});</span>
</code><button type="button">Copy</button></pre>

<p>These injection points enable customization without forking the codebase or modifying core services.</p>
</div></div><div class="col-sidebar"><div class="page-menu"><div class="tsd-navigation settings"><details class="tsd-accordion"><summary class="tsd-accordion-summary"><h3><svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-chevronDown"></use></svg>Settings</h3></summary><div class="tsd-accordion-details"><div class="tsd-filter-visibility"><span class="settings-label">Member Visibility</span><ul id="tsd-filter-options"><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-protected" name="protected"/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Protected</span></label></li><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-inherited" name="inherited" checked/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Inherited</span></label></li><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-external" name="external"/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>External</span></label></li></ul></div><div class="tsd-theme-toggle"><label class="settings-label" for="tsd-theme">Theme</label><select id="tsd-theme"><option value="os">OS</option><option value="light">Light</option><option value="dark">Dark</option></select></div></div></details></div><details open class="tsd-accordion tsd-page-navigation"><summary class="tsd-accordion-summary"><h3><svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-chevronDown"></use></svg>On This Page</h3></summary><div class="tsd-accordion-details"><a href="#architecture"><span>Architecture</span></a><ul><li><a href="#purpose-and-scope"><span>Purpose and <wbr/>Scope</span></a></li><li><a href="#layered-architecture-overview"><span>Layered <wbr/>Architecture <wbr/>Overview</span></a></li><li><ul><li><a href="#system-layers-diagram"><span>System <wbr/>Layers <wbr/>Diagram</span></a></li></ul></li><li><a href="#service-organization-and-categories"><span>Service <wbr/>Organization and <wbr/>Categories</span></a></li><li><ul><li><a href="#service-category-matrix"><span>Service <wbr/>Category <wbr/>Matrix</span></a></li><li><a href="#service-category-responsibilities"><span>Service <wbr/>Category <wbr/>Responsibilities</span></a></li></ul></li><li><a href="#dependency-injection-system"><span>Dependency <wbr/>Injection <wbr/>System</span></a></li><li><ul><li><a href="#di-system-flow-diagram"><span>DI <wbr/>System <wbr/>Flow <wbr/>Diagram</span></a></li><li><a href="#service-registration-example"><span>Service <wbr/>Registration <wbr/>Example</span></a></li><li><a href="#the-backtest-aggregation-object"><span>The <wbr/>Backtest <wbr/>Aggregation <wbr/>Object</span></a></li></ul></li><li><a href="#context-propagation-architecture"><span>Context <wbr/>Propagation <wbr/>Architecture</span></a></li><li><ul><li><a href="#context-services"><span>Context <wbr/>Services</span></a></li><li><a href="#context-injection-flow"><span>Context <wbr/>Injection <wbr/>Flow</span></a></li><li><a href="#context-scoping"><span>Context <wbr/>Scoping</span></a></li></ul></li><li><a href="#event-system-architecture"><span>Event <wbr/>System <wbr/>Architecture</span></a></li><li><ul><li><a href="#event-emitter-registry"><span>Event <wbr/>Emitter <wbr/>Registry</span></a></li><li><a href="#event-emitter-types-and-purposes"><span>Event <wbr/>Emitter <wbr/>Types and <wbr/>Purposes</span></a></li><li><a href="#listener-api-pattern"><span>Listener API <wbr/>Pattern</span></a></li><li><a href="#queued-callback-processing"><span>Queued <wbr/>Callback <wbr/>Processing</span></a></li><li><a href="#event-emission-example"><span>Event <wbr/>Emission <wbr/>Example</span></a></li></ul></li><li><a href="#module-boundaries-and-interactions"><span>Module <wbr/>Boundaries and <wbr/>Interactions</span></a></li><li><ul><li><a href="#primary-module-boundaries"><span>Primary <wbr/>Module <wbr/>Boundaries</span></a></li><li><a href="#interaction-patterns-by-layer"><span>Interaction <wbr/>Patterns by <wbr/>Layer</span></a></li></ul></li><li><a href="#testing-and-extensibility-patterns"><span>Testing and <wbr/>Extensibility <wbr/>Patterns</span></a></li><li><ul><li><a href="#persistence-adapter-customization"><span>Persistence <wbr/>Adapter <wbr/>Customization</span></a></li><li><a href="#logger-customization"><span>Logger <wbr/>Customization</span></a></li><li><a href="#configuration-override"><span>Configuration <wbr/>Override</span></a></li></ul></li></ul></div></details></div><div class="site-menu"><nav class="tsd-navigation"><a href="../modules.html">backtest-kit</a><ul class="tsd-small-nested-navigation" id="tsd-nav-container"><li>Loading...</li></ul></nav></div></div></div><footer><p class="tsd-generator">Generated using <a href="https://typedoc.org/" target="_blank">TypeDoc</a></p></footer><div class="overlay"></div></body></html>

<!-- Yandex.Metrika counter -->
<script type="text/javascript">
    (function(m,e,t,r,i,k,a){
        m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
        m[i].l=1*new Date();
        for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }}
        k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)
    })(window, document,'script','https://mc.yandex.ru/metrika/tag.js?id=105455585', 'ym');

    ym(105455585, 'init', {ssr:true, webvisor:true, clickmap:true, ecommerce:"dataLayer", accurateTrackBounce:true, trackLinks:true});
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/105455585" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
<!-- /Yandex.Metrika counter -->

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-3MQZEBBDDR"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-3MQZEBBDDR');
</script>
