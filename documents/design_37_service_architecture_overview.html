<!DOCTYPE html><html class="default" lang="en" data-base=".."><head><meta charset="utf-8"/><meta http-equiv="x-ua-compatible" content="IE=edge"/><title>design/37_service_architecture_overview | backtest-kit</title><meta name="description" content="Documentation for backtest-kit"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="stylesheet" href="../assets/style.css"/><link rel="stylesheet" href="../assets/highlight.css"/><script defer src="../assets/main.js"></script><script async src="../assets/icons.js" id="tsd-icons-script"></script><script async src="../assets/search.js" id="tsd-search-script"></script><script async src="../assets/navigation.js" id="tsd-nav-script"></script><script async src="../assets/hierarchy.js" id="tsd-hierarchy-script"></script></head><body><script>document.documentElement.dataset.theme = localStorage.getItem("tsd-theme") || "os";document.body.style.display="none";setTimeout(() => app?app.showPage():document.body.style.removeProperty("display"),500)</script><header class="tsd-page-toolbar"><div class="tsd-toolbar-contents container"><div class="table-cell" id="tsd-search"><div class="field"><label for="tsd-search-field" class="tsd-widget tsd-toolbar-icon search no-caption"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-search"></use></svg></label><input type="text" id="tsd-search-field" aria-label="Search"/></div><div class="field"><div id="tsd-toolbar-links"></div></div><ul class="results"><li class="state loading">Preparing search index...</li><li class="state failure">The search index is not available</li></ul><a href="../index.html" class="title">backtest-kit</a></div><div class="table-cell" id="tsd-widgets"><a href="#" class="tsd-widget tsd-toolbar-icon menu no-caption" data-toggle="menu" aria-label="Menu"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-menu"></use></svg></a></div></div></header><div class="container container-main"><div class="col-content"><div class="tsd-page-title"><ul class="tsd-breadcrumb"><li><a href="../modules.html">backtest-kit</a></li><li><a href="design_37_service_architecture_overview.html">design/37_service_architecture_overview</a></li></ul></div><div class="tsd-panel tsd-typography"><a id="service-architecture-overview" class="tsd-anchor"></a><h1 class="tsd-anchor-link">Service Architecture Overview<a href="#service-architecture-overview" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h1><a id="purpose-and-scope" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Purpose and Scope<a href="#purpose-and-scope" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>This document explains the service layer architecture in backtest-kit, which sits between the Public API and Client classes. The service layer provides dependency injection, context management, validation, and orchestration logic. This page covers the six service type categories and their relationships. For implementation details of specific service types, see <a href="design_38_connection_services.html">Connection Services</a>, <a href="design_39_schema_services.html">Schema Services</a>, <a href="design_40_validation_services.html">Validation Services</a>, <a href="design_41_global_services.html">Global Services</a>, <a href="design_42_logic_services.html">Logic Services</a>, and <a href="design_43_markdown_services.html">Markdown Services</a>.</p>
<a id="service-layer-pattern" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Service Layer Pattern<a href="#service-layer-pattern" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>The service layer implements a 6-layer architecture where each layer has a specific responsibility in the framework's execution pipeline. Services use dependency injection via <code>di-kit</code> with Symbol-based tokens for type-safe resolution. All services are registered in <a href="">src/lib/core/provide.ts</a> and injected in <a href="">src/lib/index.ts</a>.</p>
<p>The service layer isolates business logic (Client classes) from framework concerns (validation, context propagation, persistence, reporting). Client classes have no DI dependencies and receive all parameters explicitly, while services handle cross-cutting concerns through dependency injection.</p>
<a id="service-type-hierarchy" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Service Type Hierarchy<a href="#service-type-hierarchy" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>The framework organizes services into six categories, each with a distinct purpose in the execution flow:</p>
<p><img src="../media/37_Service_Architecture_Overview_0.svg" alt="Mermaid Diagram"></p>
<a id="service-organization-in-code" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Service Organization in Code<a href="#service-organization-in-code" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>Services are organized into nine groups in the codebase, with each group containing related service instances:</p>
<table>
<thead>
<tr>
<th>Group</th>
<th>Symbol Prefix</th>
<th>File Location</th>
<th>Count</th>
</tr>
</thead>
<tbody>
<tr>
<td>Base Services</td>
<td><code>loggerService</code></td>
<td><a href="">src/lib/services/base/</a></td>
<td>1</td>
</tr>
<tr>
<td>Context Services</td>
<td><code>*ContextService</code></td>
<td><a href="">src/lib/services/context/</a></td>
<td>2</td>
</tr>
<tr>
<td>Connection Services</td>
<td><code>*ConnectionService</code></td>
<td><a href="">src/lib/services/connection/</a></td>
<td>5</td>
</tr>
<tr>
<td>Schema Services</td>
<td><code>*SchemaService</code></td>
<td><a href="">src/lib/services/schema/</a></td>
<td>6</td>
</tr>
<tr>
<td>Global Services</td>
<td><code>*GlobalService</code></td>
<td><a href="">src/lib/services/global/</a></td>
<td>8</td>
</tr>
<tr>
<td>Logic Private Services</td>
<td><code>*LogicPrivateService</code></td>
<td><a href="">src/lib/services/logic/private/</a></td>
<td>3</td>
</tr>
<tr>
<td>Logic Public Services</td>
<td><code>*LogicPublicService</code></td>
<td><a href="">src/lib/services/logic/public/</a></td>
<td>3</td>
</tr>
<tr>
<td>Markdown Services</td>
<td><code>*MarkdownService</code></td>
<td><a href="">src/lib/services/markdown/</a></td>
<td>6</td>
</tr>
<tr>
<td>Validation Services</td>
<td><code>*ValidationService</code></td>
<td><a href="">src/lib/services/validation/</a></td>
<td>6</td>
</tr>
</tbody>
</table>
<p>The dependency injection container is initialized through three files:</p>
<ol>
<li><strong><a href="">src/lib/core/types.ts</a></strong>: Defines Symbol-based tokens for all services</li>
<li><strong><a href="">src/lib/core/provide.ts</a></strong>: Binds service implementations to tokens using <code>provide()</code></li>
<li><strong><a href="">src/lib/index.ts</a></strong>: Injects services using <code>inject&lt;T&gt;()</code> and exports the unified <code>backtest</code> object</li>
</ol>
<a id="dependency-injection-system" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Dependency Injection System<a href="#dependency-injection-system" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>Services use Symbol-based dependency injection for type-safe resolution. Each service type has a unique Symbol defined in <a href="">src/lib/core/types.ts</a>:</p>
<p><img src="../media/37_Service_Architecture_Overview_1.svg" alt="Mermaid Diagram"></p>
<p>Services receive dependencies through constructor injection. The DI container resolves the dependency graph at initialization time via <code>init()</code> called in <a href="">src/lib/index.ts:164</a>.</p>
<a id="service-type-responsibilities" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Service Type Responsibilities<a href="#service-type-responsibilities" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>Each service type has a specific role in the framework's execution flow:</p>
<a id="schema-services" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Schema Services<a href="#schema-services" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Store component configurations using the ToolRegistry pattern from <code>functools-kit</code>. Schema services provide a typed registry for strategies, exchanges, frames, walkers, sizing, and risk profiles. They perform shallow validation during registration and allow runtime retrieval by name.</p>
<p><strong>Key Methods:</strong> <code>register()</code>, <code>get()</code>, <code>override()</code>, <code>validateShallow()</code></p>
<p><strong>Implementations:</strong> <code>StrategySchemaService</code>, <code>ExchangeSchemaService</code>, <code>FrameSchemaService</code>, <code>WalkerSchemaService</code>, <code>SizingSchemaService</code>, <code>RiskSchemaService</code></p>
<a id="validation-services" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Validation Services<a href="#validation-services" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Perform runtime existence checks and cross-component validation. Validation services use memoization to cache validation results and prevent redundant checks. They verify that referenced components exist before execution begins.</p>
<p><strong>Key Methods:</strong> <code>addStrategy()</code>, <code>addExchange()</code>, <code>addFrame()</code>, <code>validate()</code>, <code>list()</code></p>
<p><strong>Implementations:</strong> <code>StrategyValidationService</code>, <code>ExchangeValidationService</code>, <code>FrameValidationService</code>, <code>WalkerValidationService</code>, <code>SizingValidationService</code>, <code>RiskValidationService</code></p>
<a id="connection-services" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Connection Services<a href="#connection-services" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Create and memoize Client class instances. Connection services act as factories for <code>ClientStrategy</code>, <code>ClientExchange</code>, <code>ClientFrame</code>, <code>ClientRisk</code>, and <code>ClientSizing</code>. They use <code>functools-kit</code>'s <code>memoize()</code> to ensure one instance per component name.</p>
<p><strong>Key Methods:</strong> <code>get()</code> (memoized)</p>
<p><strong>Implementations:</strong> <code>StrategyConnectionService</code>, <code>ExchangeConnectionService</code>, <code>FrameConnectionService</code>, <code>SizingConnectionService</code>, <code>RiskConnectionService</code></p>
<a id="global-services" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Global Services<a href="#global-services" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Provide public API entry points with validation and context setup. Global services wrap lower-level logic services and ensure all prerequisites are met before execution. They orchestrate validation, context propagation, and delegation to logic services.</p>
<p><strong>Key Methods:</strong> <code>tick()</code>, <code>backtest()</code>, <code>getTimeframe()</code>, <code>checkSignal()</code></p>
<p><strong>Implementations:</strong> <code>StrategyGlobalService</code>, <code>ExchangeGlobalService</code>, <code>FrameGlobalService</code>, <code>BacktestGlobalService</code>, <code>LiveGlobalService</code>, <code>WalkerGlobalService</code>, <code>SizingGlobalService</code>, <code>RiskGlobalService</code></p>
<a id="logic-services" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Logic Services<a href="#logic-services" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Orchestrate execution loops and async generator flows. Logic services are split into Public (context management) and Private (core logic) layers. Public services wrap generators with <code>MethodContextService.runAsyncIterator()</code>, while Private services contain the actual backtest/live/walker execution logic.</p>
<p><strong>Key Methods:</strong> <code>run()</code> (async generator)</p>
<p><strong>Implementations:</strong> <code>BacktestLogicPublicService</code>, <code>BacktestLogicPrivateService</code>, <code>LiveLogicPublicService</code>, <code>LiveLogicPrivateService</code>, <code>WalkerLogicPublicService</code>, <code>WalkerLogicPrivateService</code></p>
<a id="markdown-services" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Markdown Services<a href="#markdown-services" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Subscribe to event emitters and generate performance reports. Markdown services accumulate signal events, calculate statistics, and format results as markdown tables. They use memoization per strategy/exchange/frame to maintain separate report storage.</p>
<p><strong>Key Methods:</strong> <code>getData()</code>, <code>getReport()</code>, <code>dump()</code></p>
<p><strong>Implementations:</strong> <code>BacktestMarkdownService</code>, <code>LiveMarkdownService</code>, <code>ScheduleMarkdownService</code>, <code>PerformanceMarkdownService</code>, <code>WalkerMarkdownService</code>, <code>HeatMarkdownService</code></p>
<a id="service-dependency-flow" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Service Dependency Flow<a href="#service-dependency-flow" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>Services form a dependency chain from public API to Client classes:</p>
<p><img src="../media/37_Service_Architecture_Overview_2.svg" alt="Mermaid Diagram"></p>
<a id="component-specific-service-groups" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Component-Specific Service Groups<a href="#component-specific-service-groups" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>Services are organized around six component types (Strategy, Exchange, Frame, Walker, Sizing, Risk). Each component has a complete service stack:</p>
<p><img src="../media/37_Service_Architecture_Overview_3.svg" alt="Mermaid Diagram"></p>
<p>The pattern is consistent across all components: Global → Validation/Logic → Connection → Schema → Client. This uniformity makes the codebase predictable and maintainable.</p>
<a id="context-propagation-through-services" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Context Propagation Through Services<a href="#context-propagation-through-services" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>Services use <code>MethodContextService</code> and <code>ExecutionContextService</code> from <code>di-scoped</code> to propagate context without explicit parameters. The context flows through the service stack:</p>
<p><img src="../media/37_Service_Architecture_Overview_4.svg" alt="Mermaid Diagram"></p>
<p>Services at any depth can resolve <code>MethodContextService</code> or <code>ExecutionContextService</code> via DI to access context without it being passed as parameters. This enables clean APIs where strategy authors call <code>getCandles(symbol, interval, limit)</code> instead of <code>getCandles(symbol, interval, limit, context)</code>.</p>
</div></div><div class="col-sidebar"><div class="page-menu"><div class="tsd-navigation settings"><details class="tsd-accordion"><summary class="tsd-accordion-summary"><h3><svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-chevronDown"></use></svg>Settings</h3></summary><div class="tsd-accordion-details"><div class="tsd-filter-visibility"><span class="settings-label">Member Visibility</span><ul id="tsd-filter-options"><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-protected" name="protected"/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Protected</span></label></li><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-inherited" name="inherited" checked/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Inherited</span></label></li><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-external" name="external"/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>External</span></label></li></ul></div><div class="tsd-theme-toggle"><label class="settings-label" for="tsd-theme">Theme</label><select id="tsd-theme"><option value="os">OS</option><option value="light">Light</option><option value="dark">Dark</option></select></div></div></details></div><details open class="tsd-accordion tsd-page-navigation"><summary class="tsd-accordion-summary"><h3><svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-chevronDown"></use></svg>On This Page</h3></summary><div class="tsd-accordion-details"><a href="#service-architecture-overview"><span>Service <wbr/>Architecture <wbr/>Overview</span></a><ul><li><a href="#purpose-and-scope"><span>Purpose and <wbr/>Scope</span></a></li><li><a href="#service-layer-pattern"><span>Service <wbr/>Layer <wbr/>Pattern</span></a></li><li><a href="#service-type-hierarchy"><span>Service <wbr/>Type <wbr/>Hierarchy</span></a></li><li><a href="#service-organization-in-code"><span>Service <wbr/>Organization in <wbr/>Code</span></a></li><li><a href="#dependency-injection-system"><span>Dependency <wbr/>Injection <wbr/>System</span></a></li><li><a href="#service-type-responsibilities"><span>Service <wbr/>Type <wbr/>Responsibilities</span></a></li><li><ul><li><a href="#schema-services"><span>Schema <wbr/>Services</span></a></li><li><a href="#validation-services"><span>Validation <wbr/>Services</span></a></li><li><a href="#connection-services"><span>Connection <wbr/>Services</span></a></li><li><a href="#global-services"><span>Global <wbr/>Services</span></a></li><li><a href="#logic-services"><span>Logic <wbr/>Services</span></a></li><li><a href="#markdown-services"><span>Markdown <wbr/>Services</span></a></li></ul></li><li><a href="#service-dependency-flow"><span>Service <wbr/>Dependency <wbr/>Flow</span></a></li><li><a href="#component-specific-service-groups"><span>Component-<wbr/>Specific <wbr/>Service <wbr/>Groups</span></a></li><li><a href="#context-propagation-through-services"><span>Context <wbr/>Propagation <wbr/>Through <wbr/>Services</span></a></li></ul></div></details></div><div class="site-menu"><nav class="tsd-navigation"><a href="../modules.html">backtest-kit</a><ul class="tsd-small-nested-navigation" id="tsd-nav-container"><li>Loading...</li></ul></nav></div></div></div><footer><p class="tsd-generator">Generated using <a href="https://typedoc.org/" target="_blank">TypeDoc</a></p></footer><div class="overlay"></div></body></html>

<!-- Yandex.Metrika counter -->
<script type="text/javascript">
    (function(m,e,t,r,i,k,a){
        m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
        m[i].l=1*new Date();
        for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }}
        k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)
    })(window, document,'script','https://mc.yandex.ru/metrika/tag.js?id=105455585', 'ym');

    ym(105455585, 'init', {ssr:true, webvisor:true, clickmap:true, ecommerce:"dataLayer", accurateTrackBounce:true, trackLinks:true});
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/105455585" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
<!-- /Yandex.Metrika counter -->

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-3MQZEBBDDR"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-3MQZEBBDDR');
</script>
