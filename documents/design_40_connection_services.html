<!DOCTYPE html><html class="default" lang="en" data-base=".."><head><meta charset="utf-8"/><meta http-equiv="x-ua-compatible" content="IE=edge"/><title>design/40_connection_services | backtest-kit</title><meta name="description" content="Documentation for backtest-kit"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="stylesheet" href="../assets/style.css"/><link rel="stylesheet" href="../assets/highlight.css"/><script defer src="../assets/main.js"></script><script async src="../assets/icons.js" id="tsd-icons-script"></script><script async src="../assets/search.js" id="tsd-search-script"></script><script async src="../assets/navigation.js" id="tsd-nav-script"></script><script async src="../assets/hierarchy.js" id="tsd-hierarchy-script"></script></head><body><script>document.documentElement.dataset.theme = localStorage.getItem("tsd-theme") || "os";document.body.style.display="none";setTimeout(() => app?app.showPage():document.body.style.removeProperty("display"),500)</script><header class="tsd-page-toolbar"><div class="tsd-toolbar-contents container"><div class="table-cell" id="tsd-search"><div class="field"><label for="tsd-search-field" class="tsd-widget tsd-toolbar-icon search no-caption"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-search"></use></svg></label><input type="text" id="tsd-search-field" aria-label="Search"/></div><div class="field"><div id="tsd-toolbar-links"></div></div><ul class="results"><li class="state loading">Preparing search index...</li><li class="state failure">The search index is not available</li></ul><a href="../index.html" class="title">backtest-kit</a></div><div class="table-cell" id="tsd-widgets"><a href="#" class="tsd-widget tsd-toolbar-icon menu no-caption" data-toggle="menu" aria-label="Menu"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-menu"></use></svg></a></div></div></header><div class="container container-main"><div class="col-content"><div class="tsd-page-title"><ul class="tsd-breadcrumb"><li><a href="../modules.html">backtest-kit</a></li><li><a href="design_40_connection_services.html">design/40_connection_services</a></li></ul></div><div class="tsd-panel tsd-typography"><a id="connection-services" class="tsd-anchor"></a><h1 class="tsd-anchor-link">Connection Services<a href="#connection-services" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h1><a id="purpose-and-scope" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Purpose and Scope<a href="#purpose-and-scope" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>Connection Services implement memoized client instance management within the service layer architecture. Each Connection Service is responsible for creating and caching client instances (ClientStrategy, ClientExchange, ClientFrame, ClientRisk, ClientSizing) based on their respective schema names. These services inject required dependencies into client constructors and ensure one instance exists per registered schema name.</p>
<p>This document covers all five Connection Services: <code>StrategyConnectionService</code>, <code>ExchangeConnectionService</code>, <code>FrameConnectionService</code>, <code>RiskConnectionService</code>, and <code>SizingConnectionService</code>. For schema registration, see page 7.3 Schema Services. For client implementations, see page 6 Core Business Logic. For routing context, see page 3.3 Context Propagation.</p>
<hr>
<a id="architecture-overview" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Architecture Overview<a href="#architecture-overview" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>Connection Services implement the factory pattern with memoization to manage client instance lifecycles. Each service injects dependencies from Schema Services and other infrastructure services into client constructors, then caches the resulting instances by name.</p>
<a id="connection-services-and-their-clients" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Connection Services and Their Clients<a href="#connection-services-and-their-clients" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><table>
<thead>
<tr>
<th>Connection Service</th>
<th>Client Class</th>
<th>Cache Key</th>
<th>Interface Implemented</th>
</tr>
</thead>
<tbody>
<tr>
<td>StrategyConnectionService</td>
<td>ClientStrategy</td>
<td>strategyName</td>
<td>IStrategy</td>
</tr>
<tr>
<td>ExchangeConnectionService</td>
<td>ClientExchange</td>
<td>exchangeName</td>
<td>IExchange</td>
</tr>
<tr>
<td>FrameConnectionService</td>
<td>ClientFrame</td>
<td>frameName</td>
<td>IFrame</td>
</tr>
<tr>
<td>RiskConnectionService</td>
<td>ClientRisk</td>
<td>riskName</td>
<td>IRisk</td>
</tr>
<tr>
<td>SizingConnectionService</td>
<td>ClientSizing</td>
<td>sizingName</td>
<td>ISizing</td>
</tr>
</tbody>
</table>
<a id="instance-management-architecture" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Instance Management Architecture<a href="#instance-management-architecture" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><img src="../media/40_Connection_Services_0.svg" alt="Mermaid Diagram"></p>
<hr>
<a id="memoization-pattern" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Memoization Pattern<a href="#memoization-pattern" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>All Connection Services use <code>memoize</code> from <code>functools-kit</code> to cache client instances. The pattern ensures each schema name maps to exactly one client instance for the application lifetime.</p>
<a id="memoization-structure" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Memoization Structure<a href="#memoization-structure" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><img src="../media/40_Connection_Services_1.svg" alt="Mermaid Diagram"></p>
<a id="memoize-key-function-pattern" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Memoize Key Function Pattern<a href="#memoize-key-function-pattern" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Each Connection Service defines a key function that extracts the cache key from arguments:</p>
<p><strong>Example from StrategyConnectionService <a href="">src/lib/services/connection/StrategyConnectionService.ts:76-94</a>:</strong></p>
<pre><code class="typescript"><span class="hl-4">private</span><span class="hl-1"> </span><span class="hl-4">getStrategy</span><span class="hl-1"> = </span><span class="hl-0">memoize</span><span class="hl-1">(</span><br/><span class="hl-1">  ([</span><span class="hl-4">strategyName</span><span class="hl-1">]) </span><span class="hl-7">=&gt;</span><span class="hl-1"> </span><span class="hl-2">`</span><span class="hl-7">${</span><span class="hl-4">strategyName</span><span class="hl-7">}</span><span class="hl-2">`</span><span class="hl-1">,  </span><span class="hl-5">// Key function: extracts strategyName</span><br/><span class="hl-1">  (</span><span class="hl-4">strategyName</span><span class="hl-1">: </span><span class="hl-13">StrategyName</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> {       </span><span class="hl-5">// Factory function: creates instance</span><br/><span class="hl-1">    </span><span class="hl-7">const</span><span class="hl-1"> { </span><span class="hl-8">riskName</span><span class="hl-1">, </span><span class="hl-8">getSignal</span><span class="hl-1">, </span><span class="hl-8">interval</span><span class="hl-1">, </span><span class="hl-8">callbacks</span><span class="hl-1"> } =</span><br/><span class="hl-1">      </span><span class="hl-7">this</span><span class="hl-1">.</span><span class="hl-4">strategySchemaService</span><span class="hl-1">.</span><span class="hl-0">get</span><span class="hl-1">(</span><span class="hl-4">strategyName</span><span class="hl-1">);</span><br/><span class="hl-1">    </span><span class="hl-3">return</span><span class="hl-1"> </span><span class="hl-7">new</span><span class="hl-1"> </span><span class="hl-0">ClientStrategy</span><span class="hl-1">({</span><br/><span class="hl-1">      </span><span class="hl-4">interval</span><span class="hl-1">,</span><br/><span class="hl-1">      </span><span class="hl-4">execution:</span><span class="hl-1"> </span><span class="hl-7">this</span><span class="hl-1">.</span><span class="hl-4">executionContextService</span><span class="hl-1">,</span><br/><span class="hl-1">      </span><span class="hl-4">method:</span><span class="hl-1"> </span><span class="hl-7">this</span><span class="hl-1">.</span><span class="hl-4">methodContextService</span><span class="hl-1">,</span><br/><span class="hl-1">      </span><span class="hl-4">logger:</span><span class="hl-1"> </span><span class="hl-7">this</span><span class="hl-1">.</span><span class="hl-4">loggerService</span><span class="hl-1">,</span><br/><span class="hl-1">      </span><span class="hl-4">exchange:</span><span class="hl-1"> </span><span class="hl-7">this</span><span class="hl-1">.</span><span class="hl-4">exchangeConnectionService</span><span class="hl-1">,</span><br/><span class="hl-1">      </span><span class="hl-4">risk:</span><span class="hl-1"> </span><span class="hl-4">riskName</span><span class="hl-1"> ? </span><span class="hl-7">this</span><span class="hl-1">.</span><span class="hl-4">riskConnectionService</span><span class="hl-1">.</span><span class="hl-0">getRisk</span><span class="hl-1">(</span><span class="hl-4">riskName</span><span class="hl-1">) : </span><span class="hl-8">NOOP_RISK</span><span class="hl-1">,</span><br/><span class="hl-1">      </span><span class="hl-4">riskName</span><span class="hl-1">,</span><br/><span class="hl-1">      </span><span class="hl-4">strategyName</span><span class="hl-1">,</span><br/><span class="hl-1">      </span><span class="hl-4">getSignal</span><span class="hl-1">,</span><br/><span class="hl-1">      </span><span class="hl-4">callbacks</span><span class="hl-1">,</span><br/><span class="hl-1">    });</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">);</span>
</code><button type="button">Copy</button></pre>

<p><strong>Example from RiskConnectionService <a href="">src/lib/services/connection/RiskConnectionService.ts:56-65</a>:</strong></p>
<pre><code class="typescript"><span class="hl-4">public</span><span class="hl-1"> </span><span class="hl-4">getRisk</span><span class="hl-1"> = </span><span class="hl-0">memoize</span><span class="hl-1">(</span><br/><span class="hl-1">  ([</span><span class="hl-4">riskName</span><span class="hl-1">]) </span><span class="hl-7">=&gt;</span><span class="hl-1"> </span><span class="hl-2">`</span><span class="hl-7">${</span><span class="hl-4">riskName</span><span class="hl-7">}</span><span class="hl-2">`</span><span class="hl-1">,         </span><span class="hl-5">// Key function</span><br/><span class="hl-1">  (</span><span class="hl-4">riskName</span><span class="hl-1">: </span><span class="hl-13">RiskName</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> {              </span><span class="hl-5">// Factory function</span><br/><span class="hl-1">    </span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">schema</span><span class="hl-1"> = </span><span class="hl-7">this</span><span class="hl-1">.</span><span class="hl-4">riskSchemaService</span><span class="hl-1">.</span><span class="hl-0">get</span><span class="hl-1">(</span><span class="hl-4">riskName</span><span class="hl-1">);</span><br/><span class="hl-1">    </span><span class="hl-3">return</span><span class="hl-1"> </span><span class="hl-7">new</span><span class="hl-1"> </span><span class="hl-0">ClientRisk</span><span class="hl-1">({</span><br/><span class="hl-1">      ...</span><span class="hl-4">schema</span><span class="hl-1">,</span><br/><span class="hl-1">      </span><span class="hl-4">logger:</span><span class="hl-1"> </span><span class="hl-7">this</span><span class="hl-1">.</span><span class="hl-4">loggerService</span><span class="hl-1">,</span><br/><span class="hl-1">    });</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">);</span>
</code><button type="button">Copy</button></pre>

<hr>
<a id="dependency-injection-into-clients" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Dependency Injection into Clients<a href="#dependency-injection-into-clients" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>Connection Services inject dependencies into client constructors, combining schema configuration with infrastructure services.</p>
<a id="dependency-injection-patterns" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Dependency Injection Patterns<a href="#dependency-injection-patterns" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><strong>StrategyConnectionService <a href="">src/lib/services/connection/StrategyConnectionService.ts:76-94</a>:</strong></p>
<table>
<thead>
<tr>
<th>Injected Dependency</th>
<th>Type</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>interval</code></td>
<td>SignalInterval</td>
<td>From schema: throttling interval</td>
</tr>
<tr>
<td><code>getSignal</code></td>
<td>Function</td>
<td>From schema: signal generation logic</td>
</tr>
<tr>
<td><code>callbacks</code></td>
<td>Partial<IStrategyCallbacks></td>
<td>From schema: lifecycle hooks</td>
</tr>
<tr>
<td><code>riskName</code></td>
<td>RiskName</td>
<td>From schema: risk profile identifier</td>
</tr>
<tr>
<td><code>strategyName</code></td>
<td>StrategyName</td>
<td>From schema: instance identifier</td>
</tr>
<tr>
<td><code>logger</code></td>
<td>LoggerService</td>
<td>Service layer: logging</td>
</tr>
<tr>
<td><code>execution</code></td>
<td>ExecutionContextService</td>
<td>Service layer: when/symbol/backtest</td>
</tr>
<tr>
<td><code>method</code></td>
<td>MethodContextService</td>
<td>Service layer: strategy/exchange/frame names</td>
</tr>
<tr>
<td><code>exchange</code></td>
<td>ExchangeConnectionService</td>
<td>Service layer: market data access</td>
</tr>
<tr>
<td><code>risk</code></td>
<td>IRisk</td>
<td>Service layer: risk checking (via RiskConnectionService)</td>
</tr>
</tbody>
</table>
<p><strong>RiskConnectionService <a href="">src/lib/services/connection/RiskConnectionService.ts:56-65</a>:</strong></p>
<table>
<thead>
<tr>
<th>Injected Dependency</th>
<th>Type</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>riskName</code></td>
<td>RiskName</td>
<td>From schema: instance identifier</td>
</tr>
<tr>
<td><code>validations</code></td>
<td>Array</td>
<td>From schema: custom validation functions</td>
</tr>
<tr>
<td><code>callbacks</code></td>
<td>Partial<IRiskCallbacks></td>
<td>From schema: lifecycle hooks</td>
</tr>
<tr>
<td><code>logger</code></td>
<td>LoggerService</td>
<td>Service layer: logging</td>
</tr>
</tbody>
</table>
<a id="injection-flow" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Injection Flow<a href="#injection-flow" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><img src="../media/40_Connection_Services_2.svg" alt="Mermaid Diagram"></p>
<hr>
<a id="strategyconnectionservice" class="tsd-anchor"></a><h2 class="tsd-anchor-link">StrategyConnectionService<a href="#strategyconnectionservice" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>Manages <code>ClientStrategy</code> instances by strategyName. Implements the <code>IStrategy</code> interface <a href="">src/interfaces/Strategy.interface.ts:298-344</a> and routes all strategy operations to memoized instances.</p>
<a id="constructor-dependencies" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Constructor Dependencies<a href="#constructor-dependencies" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><img src="../media/40_Connection_Services_3.svg" alt="Mermaid Diagram"></p>
<a id="public-methods" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Public Methods<a href="#public-methods" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><a id="tick" class="tsd-anchor"></a><h4 class="tsd-anchor-link">tick()<a href="#tick" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><p>Calls <code>ClientStrategy.tick()</code> for the current strategy. Routes to memoized instance via <code>methodContextService.context.strategyName</code>.</p>
<p><strong>Returns:</strong> <code>Promise&lt;IStrategyTickResult&gt;</code></p>
<p><strong>Flow:</strong></p>
<ol>
<li>Get strategyName from context <a href="">src/lib/services/connection/StrategyConnectionService.ts:106-108</a></li>
<li>Call <code>getStrategy(strategyName)</code> to get cached instance</li>
<li>Call <code>strategy.waitForInit()</code> for persistence recovery <a href="">src/lib/services/connection/StrategyConnectionService.ts:109</a></li>
<li>Call <code>strategy.tick()</code> <a href="">src/lib/services/connection/StrategyConnectionService.ts:110</a></li>
<li>Emit result to signalEmitter, signalBacktestEmitter, signalLiveEmitter <a href="">src/lib/services/connection/StrategyConnectionService.ts:111-119</a></li>
</ol>
<a id="backtestcandles" class="tsd-anchor"></a><h4 class="tsd-anchor-link">backtest(candles)<a href="#backtestcandles" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><p>Calls <code>ClientStrategy.backtest(candles)</code> for the current strategy. Fast-forwards through historical candles.</p>
<p><strong>Parameters:</strong> <code>candles: ICandleData[]</code></p>
<p><strong>Returns:</strong> <code>Promise&lt;IStrategyBacktestResult&gt;</code></p>
<p><strong>Flow:</strong> Similar to tick() but calls <code>strategy.backtest(candles)</code> <a href="">src/lib/services/connection/StrategyConnectionService.ts:132-150</a></p>
<a id="stopstrategyname" class="tsd-anchor"></a><h4 class="tsd-anchor-link">stop(strategyName)<a href="#stopstrategyname" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><p>Calls <code>ClientStrategy.stop()</code> to prevent new signal generation. Active signals continue monitoring.</p>
<p><strong>Parameters:</strong> <code>strategyName: StrategyName</code></p>
<a id="noop_risk-fallback" class="tsd-anchor"></a><h3 class="tsd-anchor-link">NOOP_RISK Fallback<a href="#noop_risk-fallback" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>When a strategy has no <code>riskName</code>, a no-op risk implementation is injected <a href="">src/lib/services/connection/StrategyConnectionService.ts:25-29</a>:</p>
<pre><code class="typescript"><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">NOOP_RISK</span><span class="hl-1">: </span><span class="hl-13">IRisk</span><span class="hl-1"> = {</span><br/><span class="hl-1">  </span><span class="hl-0">checkSignal</span><span class="hl-4">:</span><span class="hl-1"> () </span><span class="hl-7">=&gt;</span><span class="hl-1"> </span><span class="hl-13">Promise</span><span class="hl-1">.</span><span class="hl-0">resolve</span><span class="hl-1">(</span><span class="hl-7">true</span><span class="hl-1">),</span><br/><span class="hl-1">  </span><span class="hl-0">addSignal</span><span class="hl-4">:</span><span class="hl-1"> () </span><span class="hl-7">=&gt;</span><span class="hl-1"> </span><span class="hl-13">Promise</span><span class="hl-1">.</span><span class="hl-0">resolve</span><span class="hl-1">(),</span><br/><span class="hl-1">  </span><span class="hl-0">removeSignal</span><span class="hl-4">:</span><span class="hl-1"> () </span><span class="hl-7">=&gt;</span><span class="hl-1"> </span><span class="hl-13">Promise</span><span class="hl-1">.</span><span class="hl-0">resolve</span><span class="hl-1">(),</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<hr>
<a id="riskconnectionservice" class="tsd-anchor"></a><h2 class="tsd-anchor-link">RiskConnectionService<a href="#riskconnectionservice" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>Manages <code>ClientRisk</code> instances by riskName. Implements <code>IRisk</code> interface methods and routes risk validation operations to memoized instances. Multiple strategies can share the same ClientRisk instance by specifying the same riskName.</p>
<a id="constructor-dependencies-1" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Constructor Dependencies<a href="#constructor-dependencies-1" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><img src="../media/40_Connection_Services_4.svg" alt="Mermaid Diagram"></p>
<a id="instance-creation-pattern" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Instance Creation Pattern<a href="#instance-creation-pattern" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>The <code>getRisk</code> method <a href="">src/lib/services/connection/RiskConnectionService.ts:56-65</a> creates ClientRisk instances with minimal dependencies:</p>
<pre><code class="typescript"><span class="hl-4">public</span><span class="hl-1"> </span><span class="hl-4">getRisk</span><span class="hl-1"> = </span><span class="hl-0">memoize</span><span class="hl-1">(</span><br/><span class="hl-1">  ([</span><span class="hl-4">riskName</span><span class="hl-1">]) </span><span class="hl-7">=&gt;</span><span class="hl-1"> </span><span class="hl-2">`</span><span class="hl-7">${</span><span class="hl-4">riskName</span><span class="hl-7">}</span><span class="hl-2">`</span><span class="hl-1">,</span><br/><span class="hl-1">  (</span><span class="hl-4">riskName</span><span class="hl-1">: </span><span class="hl-13">RiskName</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">schema</span><span class="hl-1"> = </span><span class="hl-7">this</span><span class="hl-1">.</span><span class="hl-4">riskSchemaService</span><span class="hl-1">.</span><span class="hl-0">get</span><span class="hl-1">(</span><span class="hl-4">riskName</span><span class="hl-1">);</span><br/><span class="hl-1">    </span><span class="hl-3">return</span><span class="hl-1"> </span><span class="hl-7">new</span><span class="hl-1"> </span><span class="hl-0">ClientRisk</span><span class="hl-1">({</span><br/><span class="hl-1">      ...</span><span class="hl-4">schema</span><span class="hl-1">,          </span><span class="hl-5">// Spreads: riskName, validations, callbacks</span><br/><span class="hl-1">      </span><span class="hl-4">logger:</span><span class="hl-1"> </span><span class="hl-7">this</span><span class="hl-1">.</span><span class="hl-4">loggerService</span><span class="hl-1">,</span><br/><span class="hl-1">    });</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">);</span>
</code><button type="button">Copy</button></pre>

<a id="public-methods-1" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Public Methods<a href="#public-methods-1" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><a id="checksignalparams-context" class="tsd-anchor"></a><h4 class="tsd-anchor-link">checkSignal(params, context)<a href="#checksignalparams-context" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><p>Validates if a signal should be allowed based on risk limits. Delegates to <code>ClientRisk.checkSignal()</code>.</p>
<p><strong>Parameters:</strong></p>
<ul>
<li><code>params: IRiskCheckArgs</code> - Contains symbol, strategyName, exchangeName, currentPrice, timestamp</li>
<li><code>context: { riskName: RiskName }</code> - Identifies which risk instance to use</li>
</ul>
<p><strong>Returns:</strong> <code>Promise&lt;boolean&gt;</code> - true if allowed, false if rejected</p>
<a id="addsignalsymbol-context" class="tsd-anchor"></a><h4 class="tsd-anchor-link">addSignal(symbol, context)<a href="#addsignalsymbol-context" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><p>Registers an opened position in the risk tracker. Called after signal is opened.</p>
<p><strong>Parameters:</strong></p>
<ul>
<li><code>symbol: string</code></li>
<li><code>context: { strategyName: string; riskName: RiskName }</code></li>
</ul>
<a id="removesignalsymbol-context" class="tsd-anchor"></a><h4 class="tsd-anchor-link">removeSignal(symbol, context)<a href="#removesignalsymbol-context" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><p>Removes a closed position from the risk tracker. Called after signal is closed.</p>
<p><strong>Parameters:</strong></p>
<ul>
<li><code>symbol: string</code></li>
<li><code>context: { strategyName: string; riskName: RiskName }</code></li>
</ul>
<a id="shared-risk-instance-pattern" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Shared Risk Instance Pattern<a href="#shared-risk-instance-pattern" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Multiple strategies with the same <code>riskName</code> share one ClientRisk instance <a href="">src/lib/services/connection/RiskConnectionService.ts:56-65</a>. This enables cross-strategy position tracking:</p>
<p><img src="../media/40_Connection_Services_5.svg" alt="Mermaid Diagram"></p>
<hr>
<a id="exchangeconnectionservice-frameconnectionservice-sizingconnectionservice" class="tsd-anchor"></a><h2 class="tsd-anchor-link">ExchangeConnectionService, FrameConnectionService, SizingConnectionService<a href="#exchangeconnectionservice-frameconnectionservice-sizingconnectionservice" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>The remaining Connection Services follow identical patterns to StrategyConnectionService and RiskConnectionService.</p>
<a id="exchangeconnectionservice" class="tsd-anchor"></a><h3 class="tsd-anchor-link">ExchangeConnectionService<a href="#exchangeconnectionservice" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Manages <code>ClientExchange</code> instances by exchangeName. Routes market data operations (getCandles, getAveragePrice, formatPrice, formatQuantity).</p>
<p><strong>Injected Dependencies:</strong></p>
<ul>
<li>LoggerService</li>
<li>ExecutionContextService</li>
<li>MethodContextService</li>
<li>ExchangeSchemaService</li>
</ul>
<p><strong>Memoized Method:</strong> <code>getExchange(exchangeName)</code> creates ClientExchange instances</p>
<a id="frameconnectionservice" class="tsd-anchor"></a><h3 class="tsd-anchor-link">FrameConnectionService<a href="#frameconnectionservice" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Manages <code>ClientFrame</code> instances by frameName. Routes timeframe generation for backtest periods.</p>
<p><strong>Injected Dependencies:</strong></p>
<ul>
<li>LoggerService</li>
<li>MethodContextService</li>
<li>FrameSchemaService</li>
</ul>
<p><strong>Memoized Method:</strong> <code>getFrame(frameName)</code> creates ClientFrame instances</p>
<p><strong>Note:</strong> Not used in live mode where frameName is empty string.</p>
<a id="sizingconnectionservice" class="tsd-anchor"></a><h3 class="tsd-anchor-link">SizingConnectionService<a href="#sizingconnectionservice" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Manages <code>ClientSizing</code> instances by sizingName. Routes position size calculations (fixed-percentage, kelly-criterion, atr-based).</p>
<p><strong>Injected Dependencies:</strong></p>
<ul>
<li>LoggerService</li>
<li>SizingSchemaService</li>
</ul>
<p><strong>Memoized Method:</strong> <code>getSizing(sizingName)</code> creates ClientSizing instances</p>
<hr>
<a id="integration-points" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Integration Points<a href="#integration-points" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>Connection Services integrate with multiple layers of the architecture, serving as the critical routing infrastructure.</p>
<a id="service-dependencies" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Service Dependencies<a href="#service-dependencies" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><img src="../media/40_Connection_Services_6.svg" alt="Mermaid Diagram"></p>
<a id="data-flow-through-connection-layer" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Data Flow Through Connection Layer<a href="#data-flow-through-connection-layer" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><table>
<thead>
<tr>
<th>Source</th>
<th>Connection Service</th>
<th>Destination</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td>Logic Services</td>
<td>StrategyConnectionService</td>
<td>ClientStrategy</td>
<td>Signal evaluation and backtest</td>
</tr>
<tr>
<td>ClientStrategy</td>
<td>ExchangeConnectionService</td>
<td>ClientExchange</td>
<td>Candle data and VWAP</td>
</tr>
<tr>
<td>Logic Services</td>
<td>ExchangeConnectionService</td>
<td>ClientExchange</td>
<td>Price formatting</td>
</tr>
<tr>
<td>Logic Services</td>
<td>FrameConnectionService</td>
<td>ClientFrame</td>
<td>Timeframe generation</td>
</tr>
</tbody>
</table>
<a id="logging-integration" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Logging Integration<a href="#logging-integration" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>All Connection Services inject <code>LoggerService</code> and log operations with context-enriched metadata <a href="">src/lib/services/connection/StrategyConnectionService.ts:45</a>, <a href="">src/lib/services/connection/ExchangeConnectionService.ts:39</a>, <a href="">src/lib/services/connection/FrameConnectionService.ts:33</a>:</p>
<ul>
<li><code>StrategyConnectionService</code>: Logs tick and backtest operations with candle counts</li>
<li><code>ExchangeConnectionService</code>: Logs all data fetching with symbol, interval, and limits</li>
<li><code>FrameConnectionService</code>: Logs timeframe retrieval with symbol</li>
</ul>
</div></div><div class="col-sidebar"><div class="page-menu"><div class="tsd-navigation settings"><details class="tsd-accordion"><summary class="tsd-accordion-summary"><h3><svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-chevronDown"></use></svg>Settings</h3></summary><div class="tsd-accordion-details"><div class="tsd-filter-visibility"><span class="settings-label">Member Visibility</span><ul id="tsd-filter-options"><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-protected" name="protected"/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Protected</span></label></li><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-inherited" name="inherited" checked/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Inherited</span></label></li><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-external" name="external"/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>External</span></label></li></ul></div><div class="tsd-theme-toggle"><label class="settings-label" for="tsd-theme">Theme</label><select id="tsd-theme"><option value="os">OS</option><option value="light">Light</option><option value="dark">Dark</option></select></div></div></details></div><details open class="tsd-accordion tsd-page-navigation"><summary class="tsd-accordion-summary"><h3><svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-chevronDown"></use></svg>On This Page</h3></summary><div class="tsd-accordion-details"><a href="#connection-services"><span>Connection <wbr/>Services</span></a><ul><li><a href="#purpose-and-scope"><span>Purpose and <wbr/>Scope</span></a></li><li><a href="#architecture-overview"><span>Architecture <wbr/>Overview</span></a></li><li><ul><li><a href="#connection-services-and-their-clients"><span>Connection <wbr/>Services and <wbr/>Their <wbr/>Clients</span></a></li><li><a href="#instance-management-architecture"><span>Instance <wbr/>Management <wbr/>Architecture</span></a></li></ul></li><li><a href="#memoization-pattern"><span>Memoization <wbr/>Pattern</span></a></li><li><ul><li><a href="#memoization-structure"><span>Memoization <wbr/>Structure</span></a></li><li><a href="#memoize-key-function-pattern"><span>Memoize <wbr/>Key <wbr/>Function <wbr/>Pattern</span></a></li></ul></li><li><a href="#dependency-injection-into-clients"><span>Dependency <wbr/>Injection into <wbr/>Clients</span></a></li><li><ul><li><a href="#dependency-injection-patterns"><span>Dependency <wbr/>Injection <wbr/>Patterns</span></a></li><li><a href="#injection-flow"><span>Injection <wbr/>Flow</span></a></li></ul></li><li><a href="#strategyconnectionservice"><span>Strategy<wbr/>Connection<wbr/>Service</span></a></li><li><ul><li><a href="#constructor-dependencies"><span>Constructor <wbr/>Dependencies</span></a></li><li><a href="#public-methods"><span>Public <wbr/>Methods</span></a></li><li><ul><li><a href="#tick"><span>tick()</span></a></li><li><a href="#backtestcandles"><span>backtest(candles)</span></a></li><li><a href="#stopstrategyname"><span>stop(strategy<wbr/>Name)</span></a></li></ul></li><li><a href="#noop_risk-fallback"><span>NOOP_<wbr/>RISK <wbr/>Fallback</span></a></li></ul></li><li><a href="#riskconnectionservice"><span>Risk<wbr/>Connection<wbr/>Service</span></a></li><li><ul><li><a href="#constructor-dependencies-1"><span>Constructor <wbr/>Dependencies</span></a></li><li><a href="#instance-creation-pattern"><span>Instance <wbr/>Creation <wbr/>Pattern</span></a></li><li><a href="#public-methods-1"><span>Public <wbr/>Methods</span></a></li><li><ul><li><a href="#checksignalparams-context"><span>check<wbr/>Signal(params, context)</span></a></li><li><a href="#addsignalsymbol-context"><span>add<wbr/>Signal(symbol, context)</span></a></li><li><a href="#removesignalsymbol-context"><span>remove<wbr/>Signal(symbol, context)</span></a></li></ul></li><li><a href="#shared-risk-instance-pattern"><span>Shared <wbr/>Risk <wbr/>Instance <wbr/>Pattern</span></a></li></ul></li><li><a href="#exchangeconnectionservice-frameconnectionservice-sizingconnectionservice"><span>Exchange<wbr/>Connection<wbr/>Service, <wbr/>Frame<wbr/>Connection<wbr/>Service, <wbr/>Sizing<wbr/>Connection<wbr/>Service</span></a></li><li><ul><li><a href="#exchangeconnectionservice"><span>Exchange<wbr/>Connection<wbr/>Service</span></a></li><li><a href="#frameconnectionservice"><span>Frame<wbr/>Connection<wbr/>Service</span></a></li><li><a href="#sizingconnectionservice"><span>Sizing<wbr/>Connection<wbr/>Service</span></a></li></ul></li><li><a href="#integration-points"><span>Integration <wbr/>Points</span></a></li><li><ul><li><a href="#service-dependencies"><span>Service <wbr/>Dependencies</span></a></li><li><a href="#data-flow-through-connection-layer"><span>Data <wbr/>Flow <wbr/>Through <wbr/>Connection <wbr/>Layer</span></a></li><li><a href="#logging-integration"><span>Logging <wbr/>Integration</span></a></li></ul></li></ul></div></details></div><div class="site-menu"><nav class="tsd-navigation"><a href="../modules.html">backtest-kit</a><ul class="tsd-small-nested-navigation" id="tsd-nav-container"><li>Loading...</li></ul></nav></div></div></div><footer><p class="tsd-generator">Generated using <a href="https://typedoc.org/" target="_blank">TypeDoc</a></p></footer><div class="overlay"></div></body></html>

<!-- Yandex.Metrika counter -->
<script type="text/javascript">
    (function(m,e,t,r,i,k,a){
        m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
        m[i].l=1*new Date();
        for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }}
        k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)
    })(window, document,'script','https://mc.yandex.ru/metrika/tag.js?id=105455585', 'ym');

    ym(105455585, 'init', {ssr:true, webvisor:true, clickmap:true, ecommerce:"dataLayer", accurateTrackBounce:true, trackLinks:true});
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/105455585" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
<!-- /Yandex.Metrika counter -->

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-3MQZEBBDDR"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-3MQZEBBDDR');
</script>
