<!DOCTYPE html><html class="default" lang="en" data-base=".."><head><meta charset="utf-8"/><meta http-equiv="x-ua-compatible" content="IE=edge"/><title>design/17_backtest_api | backtest-kit</title><meta name="description" content="Documentation for backtest-kit"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="stylesheet" href="../assets/style.css"/><link rel="stylesheet" href="../assets/highlight.css"/><script defer src="../assets/main.js"></script><script async src="../assets/icons.js" id="tsd-icons-script"></script><script async src="../assets/search.js" id="tsd-search-script"></script><script async src="../assets/navigation.js" id="tsd-nav-script"></script><script async src="../assets/hierarchy.js" id="tsd-hierarchy-script"></script></head><body><script>document.documentElement.dataset.theme = localStorage.getItem("tsd-theme") || "os";document.body.style.display="none";setTimeout(() => app?app.showPage():document.body.style.removeProperty("display"),500)</script><header class="tsd-page-toolbar"><div class="tsd-toolbar-contents container"><div class="table-cell" id="tsd-search"><div class="field"><label for="tsd-search-field" class="tsd-widget tsd-toolbar-icon search no-caption"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-search"></use></svg></label><input type="text" id="tsd-search-field" aria-label="Search"/></div><div class="field"><div id="tsd-toolbar-links"></div></div><ul class="results"><li class="state loading">Preparing search index...</li><li class="state failure">The search index is not available</li></ul><a href="../index.html" class="title">backtest-kit</a></div><div class="table-cell" id="tsd-widgets"><a href="#" class="tsd-widget tsd-toolbar-icon menu no-caption" data-toggle="menu" aria-label="Menu"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-menu"></use></svg></a></div></div></header><div class="container container-main"><div class="col-content"><div class="tsd-page-title"><ul class="tsd-breadcrumb"><li><a href="../modules.html">backtest-kit</a></li><li><a href="design_17_backtest_api.html">design/17_backtest_api</a></li></ul></div><div class="tsd-panel tsd-typography"><a id="backtest-api" class="tsd-anchor"></a><h1 class="tsd-anchor-link">Backtest API<a href="#backtest-api" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h1><p>This page documents the public API for running backtests via the <code>Backtest</code> utility class. The Backtest API provides methods for executing historical strategy simulations and retrieving performance statistics.</p>
<p>For live trading operations, see <a href="design_18_live_trading_api.html">Live Trading API</a>. For multi-strategy comparison, see <a href="design_19_walker_api.html">Walker API</a>. For event subscription patterns, see <a href="design_22_event_listeners.html">Event Listeners</a>.</p>
<a id="overview" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Overview<a href="#overview" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>The <code>Backtest</code> class is a singleton utility that provides simplified access to backtest execution and report generation. It delegates to <code>BacktestGlobalService</code> for execution and <code>BacktestMarkdownService</code> for statistics and reporting.</p>
<p><strong>Backtest API Service Architecture</strong></p>
<p><img src="../media/17_Backtest_API_0.svg" alt="Mermaid Diagram"></p>
<a id="backtest-class-methods" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Backtest Class Methods<a href="#backtest-class-methods" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>The <code>Backtest</code> class exposes five public methods organized into two categories: execution methods and reporting methods.</p>
<table>
<thead>
<tr>
<th>Method</th>
<th>Return Type</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>run(symbol, context)</code></td>
<td><code>AsyncGenerator&lt;IStrategyBacktestResult&gt;</code></td>
<td>Execute backtest with manual iteration control</td>
</tr>
<tr>
<td><code>background(symbol, context)</code></td>
<td><code>() =&gt; void</code></td>
<td>Execute backtest in background, return cancel function</td>
</tr>
<tr>
<td><code>getData(strategyName)</code></td>
<td><code>Promise&lt;BacktestStatistics&gt;</code></td>
<td>Retrieve statistical data for completed backtest</td>
</tr>
<tr>
<td><code>getReport(strategyName)</code></td>
<td><code>Promise&lt;string&gt;</code></td>
<td>Generate markdown report with all signals</td>
</tr>
<tr>
<td><code>dump(strategyName, path?)</code></td>
<td><code>Promise&lt;void&gt;</code></td>
<td>Save markdown report to disk</td>
</tr>
</tbody>
</table>
<a id="backtestrun" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Backtest.run()<a href="#backtestrun" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>The <code>run()</code> method executes a backtest for a symbol and returns an async generator that yields closed signals. This provides fine-grained control over iteration and allows early termination.</p>
<pre><code class="typescript"><span class="hl-4">public</span><span class="hl-1"> </span><span class="hl-0">run</span><span class="hl-1"> = (</span><br/><span class="hl-1">  </span><span class="hl-4">symbol</span><span class="hl-1">: </span><span class="hl-10">string</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">context</span><span class="hl-1">: {</span><br/><span class="hl-1">    </span><span class="hl-4">strategyName</span><span class="hl-1">: </span><span class="hl-10">string</span><span class="hl-1">;</span><br/><span class="hl-1">    </span><span class="hl-4">exchangeName</span><span class="hl-1">: </span><span class="hl-10">string</span><span class="hl-1">;</span><br/><span class="hl-1">    </span><span class="hl-4">frameName</span><span class="hl-1">: </span><span class="hl-10">string</span><span class="hl-1">;</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">) </span><span class="hl-6">=&gt;</span><span class="hl-1"> </span><span class="hl-4">AsyncGenerator</span><span class="hl-1">&lt;</span><span class="hl-4">IStrategyBacktestResult</span><span class="hl-1">&gt;</span>
</code><button type="button">Copy</button></pre>

<p><strong>Execution Context</strong>: The method requires three context parameters:</p>
<ul>
<li><code>strategyName</code> - Must reference a strategy registered via <code>addStrategy()</code> (see <a href="design_08_component_registration.html">Component Registration</a>)</li>
<li><code>exchangeName</code> - Must reference an exchange registered via <code>addExchange()</code> (see <a href="design_25_exchange_schemas.html">Exchange Schemas</a>)</li>
<li><code>frameName</code> - Must reference a frame registered via <code>addFrame()</code> (see <a href="design_26_frame_schemas.html">Frame Schemas</a>)</li>
</ul>
<p><strong>State Clearing</strong>: Before execution, <code>run()</code> clears accumulated state for the strategy:</p>
<ol>
<li>Clears <code>BacktestMarkdownService</code> accumulated signals for the strategy <a href="">src/classes/Backtest.ts:52</a></li>
<li>Clears <code>ScheduleMarkdownService</code> accumulated scheduled signals <a href="">src/classes/Backtest.ts:53</a></li>
<li>Clears <code>StrategyGlobalService</code> internal strategy state <a href="">src/classes/Backtest.ts:57</a></li>
<li>Clears <code>RiskGlobalService</code> active positions if strategy has a <code>riskName</code> <a href="">src/classes/Backtest.ts:61-63</a></li>
</ol>
<p><strong>Yielded Results</strong>: Each iteration yields a closed signal of type <code>IStrategyTickResultClosed</code>:</p>
<pre><code class="typescript"><span class="hl-6">interface</span><span class="hl-1"> </span><span class="hl-10">IStrategyTickResultClosed</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-4">action</span><span class="hl-1">: </span><span class="hl-2">&quot;closed&quot;</span><span class="hl-1">;</span><br/><span class="hl-1">  </span><span class="hl-4">strategyName</span><span class="hl-1">: </span><span class="hl-10">string</span><span class="hl-1">;</span><br/><span class="hl-1">  </span><span class="hl-4">signal</span><span class="hl-1">: </span><span class="hl-10">ISignalRow</span><span class="hl-1">;</span><br/><span class="hl-1">  </span><span class="hl-4">currentPrice</span><span class="hl-1">: </span><span class="hl-10">number</span><span class="hl-1">;</span><br/><span class="hl-1">  </span><span class="hl-4">closeTimestamp</span><span class="hl-1">: </span><span class="hl-10">number</span><span class="hl-1">;</span><br/><span class="hl-1">  </span><span class="hl-4">closeReason</span><span class="hl-1">: </span><span class="hl-2">&quot;take_profit&quot;</span><span class="hl-1"> | </span><span class="hl-2">&quot;stop_loss&quot;</span><span class="hl-1"> | </span><span class="hl-2">&quot;max_lifetime&quot;</span><span class="hl-1">;</span><br/><span class="hl-1">  </span><span class="hl-4">pnl</span><span class="hl-1">: </span><span class="hl-10">IStrategyPnL</span><span class="hl-1">;</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<a id="backtestbackground" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Backtest.background()<a href="#backtestbackground" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>The <code>background()</code> method executes a backtest in the background without yielding results. It consumes all results internally and emits completion events via <code>doneBacktestSubject</code>.</p>
<pre><code class="typescript"><span class="hl-4">public</span><span class="hl-1"> </span><span class="hl-0">background</span><span class="hl-1"> = (</span><br/><span class="hl-1">  </span><span class="hl-4">symbol</span><span class="hl-1">: </span><span class="hl-10">string</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">context</span><span class="hl-1">: {</span><br/><span class="hl-1">    </span><span class="hl-4">strategyName</span><span class="hl-1">: </span><span class="hl-10">string</span><span class="hl-1">;</span><br/><span class="hl-1">    </span><span class="hl-4">exchangeName</span><span class="hl-1">: </span><span class="hl-10">string</span><span class="hl-1">;</span><br/><span class="hl-1">    </span><span class="hl-4">frameName</span><span class="hl-1">: </span><span class="hl-10">string</span><span class="hl-1">;</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">) </span><span class="hl-6">=&gt;</span><span class="hl-1"> () </span><span class="hl-6">=&gt;</span><span class="hl-1"> </span><span class="hl-6">void</span>
</code><button type="button">Copy</button></pre>

<p><strong>Cancellation Pattern</strong>: The method returns a cancellation function that can be called to stop execution. The cancellation function:</p>
<ol>
<li>Calls <code>strategyGlobalService.stop(strategyName)</code> <a href="">src/classes/Backtest.ts:119</a></li>
<li>Sets <code>isStopped</code> flag to break iteration loop <a href="">src/classes/Backtest.ts:101-106</a></li>
</ol>
<p><strong>Completion Event</strong>: When iteration completes (normally or via cancellation), the method emits a completion event to <code>doneBacktestSubject</code> <a href="">src/classes/Backtest.ts:108-113</a>:</p>
<pre><code class="typescript"><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-4">doneBacktestSubject</span><span class="hl-1">.</span><span class="hl-0">next</span><span class="hl-1">({</span><br/><span class="hl-1">  </span><span class="hl-4">exchangeName:</span><span class="hl-1"> </span><span class="hl-4">context</span><span class="hl-1">.</span><span class="hl-4">exchangeName</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">strategyName:</span><span class="hl-1"> </span><span class="hl-4">context</span><span class="hl-1">.</span><span class="hl-4">strategyName</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">backtest:</span><span class="hl-1"> </span><span class="hl-6">true</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">symbol</span><span class="hl-1">,</span><br/><span class="hl-1">});</span>
</code><button type="button">Copy</button></pre>

<p><strong>Error Handling</strong>: Errors during background execution are caught and emitted to <code>errorEmitter</code> <a href="">src/classes/Backtest.ts:115-117</a>.</p>
<a id="backtestgetdata" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Backtest.getData()<a href="#backtestgetdata" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>The <code>getData()</code> method retrieves statistical data for a strategy after backtest execution. It delegates to <code>BacktestMarkdownService.getData()</code>.</p>
<pre><code class="typescript"><span class="hl-4">public</span><span class="hl-1"> </span><span class="hl-0">getData</span><span class="hl-1"> = </span><span class="hl-6">async</span><span class="hl-1"> (</span><span class="hl-4">strategyName</span><span class="hl-1">: </span><span class="hl-10">StrategyName</span><span class="hl-1">) </span><span class="hl-6">=&gt;</span><span class="hl-1"> </span><span class="hl-10">Promise</span><span class="hl-1">&lt;</span><span class="hl-4">BacktestStatistics</span><span class="hl-1">&gt;</span>
</code><button type="button">Copy</button></pre>

<p><strong>BacktestStatistics Interface</strong>: Returns an object with comprehensive performance metrics:</p>
<pre><code class="typescript"><span class="hl-6">interface</span><span class="hl-1"> </span><span class="hl-10">BacktestStatistics</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-4">signalList</span><span class="hl-1">: </span><span class="hl-10">IStrategyTickResultClosed</span><span class="hl-1">[];</span><br/><span class="hl-1">  </span><span class="hl-4">totalSignals</span><span class="hl-1">: </span><span class="hl-10">number</span><span class="hl-1">;</span><br/><span class="hl-1">  </span><span class="hl-4">winCount</span><span class="hl-1">: </span><span class="hl-10">number</span><span class="hl-1">;</span><br/><span class="hl-1">  </span><span class="hl-4">lossCount</span><span class="hl-1">: </span><span class="hl-10">number</span><span class="hl-1">;</span><br/><span class="hl-1">  </span><span class="hl-4">winRate</span><span class="hl-1">: </span><span class="hl-10">number</span><span class="hl-1"> | </span><span class="hl-10">null</span><span class="hl-1">;           </span><span class="hl-5">// Percentage (0-100), higher is better</span><br/><span class="hl-1">  </span><span class="hl-4">avgPnl</span><span class="hl-1">: </span><span class="hl-10">number</span><span class="hl-1"> | </span><span class="hl-10">null</span><span class="hl-1">;             </span><span class="hl-5">// Percentage, higher is better</span><br/><span class="hl-1">  </span><span class="hl-4">totalPnl</span><span class="hl-1">: </span><span class="hl-10">number</span><span class="hl-1"> | </span><span class="hl-10">null</span><span class="hl-1">;           </span><span class="hl-5">// Cumulative percentage, higher is better</span><br/><span class="hl-1">  </span><span class="hl-4">stdDev</span><span class="hl-1">: </span><span class="hl-10">number</span><span class="hl-1"> | </span><span class="hl-10">null</span><span class="hl-1">;             </span><span class="hl-5">// Volatility metric, lower is better</span><br/><span class="hl-1">  </span><span class="hl-4">sharpeRatio</span><span class="hl-1">: </span><span class="hl-10">number</span><span class="hl-1"> | </span><span class="hl-10">null</span><span class="hl-1">;        </span><span class="hl-5">// Risk-adjusted return, higher is better</span><br/><span class="hl-1">  </span><span class="hl-4">annualizedSharpeRatio</span><span class="hl-1">: </span><span class="hl-10">number</span><span class="hl-1"> | </span><span class="hl-10">null</span><span class="hl-1">;  </span><span class="hl-5">// Sharpe × √365, higher is better</span><br/><span class="hl-1">  </span><span class="hl-4">certaintyRatio</span><span class="hl-1">: </span><span class="hl-10">number</span><span class="hl-1"> | </span><span class="hl-10">null</span><span class="hl-1">;     </span><span class="hl-5">// avgWin / |avgLoss|, higher is better</span><br/><span class="hl-1">  </span><span class="hl-4">expectedYearlyReturns</span><span class="hl-1">: </span><span class="hl-10">number</span><span class="hl-1"> | </span><span class="hl-10">null</span><span class="hl-1">;  </span><span class="hl-5">// Projected annual return, higher is better</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<p><strong>Safe Math</strong>: All numeric metrics return <code>null</code> if calculation produces <code>NaN</code> or <code>Infinity</code> <a href="">src/lib/services/markdown/BacktestMarkdownService.ts:33-44</a>.</p>
<a id="backtestgetreport" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Backtest.getReport()<a href="#backtestgetreport" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>The <code>getReport()</code> method generates a markdown-formatted report with all closed signals and statistics.</p>
<pre><code class="typescript"><span class="hl-4">public</span><span class="hl-1"> </span><span class="hl-0">getReport</span><span class="hl-1"> = </span><span class="hl-6">async</span><span class="hl-1"> (</span><span class="hl-4">strategyName</span><span class="hl-1">: </span><span class="hl-10">StrategyName</span><span class="hl-1">) </span><span class="hl-6">=&gt;</span><span class="hl-1"> </span><span class="hl-10">Promise</span><span class="hl-1">&lt;</span><span class="hl-4">string</span><span class="hl-1">&gt;</span>
</code><button type="button">Copy</button></pre>

<p><strong>Report Structure</strong>: The generated markdown includes:</p>
<ol>
<li>Report title with strategy name <a href="">src/lib/services/markdown/BacktestMarkdownService.ts:299</a></li>
<li>Markdown table with columns defined in <code>columns</code> array <a href="">src/lib/services/markdown/BacktestMarkdownService.ts:104-177</a>:
<ul>
<li>Signal ID, Symbol, Position, Note</li>
<li>Open Price, Close Price, Take Profit, Stop Loss</li>
<li>PNL (net), Close Reason, Duration (minutes)</li>
<li>Open Time, Close Time</li>
</ul>
</li>
<li>Statistical summary with all metrics <a href="">src/lib/services/markdown/BacktestMarkdownService.ts:303-312</a></li>
</ol>
<p><strong>Empty State</strong>: Returns message &quot;No signals closed yet&quot; if no data <a href="">src/lib/services/markdown/BacktestMarkdownService.ts:282-286</a>.</p>
<a id="backtestdump" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Backtest.dump()<a href="#backtestdump" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>The <code>dump()</code> method saves the markdown report to disk in the specified directory.</p>
<pre><code class="typescript"><span class="hl-4">public</span><span class="hl-1"> </span><span class="hl-0">dump</span><span class="hl-1"> = </span><span class="hl-6">async</span><span class="hl-1"> (</span><br/><span class="hl-1">  </span><span class="hl-4">strategyName</span><span class="hl-1">: </span><span class="hl-10">StrategyName</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">path</span><span class="hl-1">?: </span><span class="hl-10">string</span><span class="hl-1">  </span><span class="hl-5">// Default: &quot;./logs/backtest&quot;</span><br/><span class="hl-1">) </span><span class="hl-6">=&gt;</span><span class="hl-1"> </span><span class="hl-10">Promise</span><span class="hl-1">&lt;</span><span class="hl-6">void</span><span class="hl-1">&gt;</span>
</code><button type="button">Copy</button></pre>

<p><strong>File Structure</strong>: The method:</p>
<ol>
<li>Creates directory recursively if it doesn't exist <a href="">src/lib/services/markdown/BacktestMarkdownService.ts:330</a></li>
<li>Generates filename as <code>{strategyName}.md</code> <a href="">src/lib/services/markdown/BacktestMarkdownService.ts:332</a></li>
<li>Writes markdown content to file <a href="">src/lib/services/markdown/BacktestMarkdownService.ts:335</a></li>
</ol>
<p><strong>Default Path</strong>: If <code>path</code> parameter is omitted, reports are saved to <code>./logs/backtest/</code> directory <a href="">src/lib/services/markdown/BacktestMarkdownService.ts:324</a>.</p>
<a id="statistics-calculation-details" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Statistics Calculation Details<a href="#statistics-calculation-details" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>The <code>BacktestMarkdownService</code> calculates statistics using the <code>ReportStorage</code> class which accumulates closed signals.</p>
<p><strong>Statistics Calculation Flow</strong></p>
<p><img src="../media/17_Backtest_API_1.svg" alt="Mermaid Diagram"></p>
<a id="metric-calculations" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Metric Calculations<a href="#metric-calculations" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>The following formulas are used for statistical calculations:</p>
<p><strong>Basic Metrics</strong>:</p>
<ul>
<li><code>winRate = (winCount / totalSignals) × 100</code></li>
<li><code>avgPnl = sum(pnl) / totalSignals</code></li>
<li><code>totalPnl = sum(pnl)</code></li>
</ul>
<p><strong>Risk Metrics</strong>:</p>
<ul>
<li><code>variance = sum((pnl - avgPnl)²) / totalSignals</code></li>
<li><code>stdDev = sqrt(variance)</code></li>
<li><code>sharpeRatio = avgPnl / stdDev</code> (assuming risk-free rate = 0)</li>
<li><code>annualizedSharpeRatio = sharpeRatio × sqrt(365)</code></li>
</ul>
<p><strong>Win/Loss Analysis</strong>:</p>
<ul>
<li><code>avgWin = sum(wins) / winCount</code></li>
<li><code>avgLoss = sum(losses) / lossCount</code></li>
<li><code>certaintyRatio = avgWin / |avgLoss|</code></li>
</ul>
<p><strong>Projected Returns</strong>:</p>
<ul>
<li><code>avgDurationDays = avgDurationMs / (1000 × 60 × 60 × 24)</code></li>
<li><code>tradesPerYear = 365 / avgDurationDays</code></li>
<li><code>expectedYearlyReturns = avgPnl × tradesPerYear</code></li>
</ul>
<a id="execution-flow-comparison" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Execution Flow Comparison<a href="#execution-flow-comparison" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>The following diagram contrasts the execution patterns of <code>run()</code> and <code>background()</code> methods:</p>
<p><strong>run() vs background() Execution Flow</strong></p>
<p><img src="../media/17_Backtest_API_2.svg" alt="Mermaid Diagram"></p>
<a id="state-management" class="tsd-anchor"></a><h2 class="tsd-anchor-link">State Management<a href="#state-management" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>The Backtest API clears multiple service states before execution to ensure clean runs:</p>
<table>
<thead>
<tr>
<th>Service</th>
<th>Cleared Data</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>BacktestMarkdownService</code></td>
<td><code>_signalList[]</code> per strategy</td>
<td>Remove accumulated closed signals</td>
</tr>
<tr>
<td><code>ScheduleMarkdownService</code></td>
<td><code>_eventList[]</code> per strategy</td>
<td>Remove accumulated scheduled/cancelled events</td>
</tr>
<tr>
<td><code>StrategyGlobalService</code></td>
<td>Strategy internal state</td>
<td>Reset <code>_lastSignalTimestamp</code>, signal cache</td>
</tr>
<tr>
<td><code>RiskGlobalService</code></td>
<td><code>_activePositions</code> Map</td>
<td>Clear portfolio position tracking</td>
</tr>
</tbody>
</table>
<p><strong>Clearing Implementation</strong>: The clearing sequence is executed in <code>Backtest.run()</code>:</p>
<pre><code class="typescript"><span class="hl-5">// Clear markdown services</span><br/><span class="hl-4">backtest</span><span class="hl-1">.</span><span class="hl-4">backtestMarkdownService</span><span class="hl-1">.</span><span class="hl-0">clear</span><span class="hl-1">(</span><span class="hl-4">context</span><span class="hl-1">.</span><span class="hl-4">strategyName</span><span class="hl-1">);</span><br/><span class="hl-4">backtest</span><span class="hl-1">.</span><span class="hl-4">scheduleMarkdownService</span><span class="hl-1">.</span><span class="hl-0">clear</span><span class="hl-1">(</span><span class="hl-4">context</span><span class="hl-1">.</span><span class="hl-4">strategyName</span><span class="hl-1">);</span><br/><br/><span class="hl-5">// Clear strategy state</span><br/><span class="hl-4">backtest</span><span class="hl-1">.</span><span class="hl-4">strategyGlobalService</span><span class="hl-1">.</span><span class="hl-0">clear</span><span class="hl-1">(</span><span class="hl-4">context</span><span class="hl-1">.</span><span class="hl-4">strategyName</span><span class="hl-1">);</span><br/><br/><span class="hl-5">// Clear risk state if strategy has risk profile</span><br/><span class="hl-6">const</span><span class="hl-1"> { </span><span class="hl-7">riskName</span><span class="hl-1"> } = </span><span class="hl-4">backtest</span><span class="hl-1">.</span><span class="hl-4">strategySchemaService</span><span class="hl-1">.</span><span class="hl-0">get</span><span class="hl-1">(</span><span class="hl-4">context</span><span class="hl-1">.</span><span class="hl-4">strategyName</span><span class="hl-1">);</span><br/><span class="hl-4">riskName</span><span class="hl-1"> &amp;&amp; </span><span class="hl-4">backtest</span><span class="hl-1">.</span><span class="hl-4">riskGlobalService</span><span class="hl-1">.</span><span class="hl-0">clear</span><span class="hl-1">(</span><span class="hl-4">riskName</span><span class="hl-1">);</span>
</code><button type="button">Copy</button></pre>

<a id="event-integration" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Event Integration<a href="#event-integration" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>The Backtest API integrates with the event system through multiple emitters:</p>
<p><strong>Backtest Event Emission Flow</strong></p>
<p><img src="../media/17_Backtest_API_3.svg" alt="Mermaid Diagram"></p>
<p><strong>Emitter Initialization</strong>: Event emitters are initialized in <a href="">src/config/emitters.ts:1-80</a>:</p>
<ul>
<li><code>signalEmitter</code> - All signal events (live + backtest)</li>
<li><code>signalBacktestEmitter</code> - Backtest-only signal events</li>
<li><code>doneBacktestSubject</code> - Backtest completion events</li>
<li><code>progressEmitter</code> - Progress updates during execution</li>
</ul>
<a id="usage-examples" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Usage Examples<a href="#usage-examples" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><a id="example-1-manual-iteration-with-early-termination" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Example 1: Manual Iteration with Early Termination<a href="#example-1-manual-iteration-with-early-termination" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><pre><code class="typescript"><span class="hl-3">import</span><span class="hl-1"> { </span><span class="hl-4">Backtest</span><span class="hl-1"> } </span><span class="hl-3">from</span><span class="hl-1"> </span><span class="hl-2">&quot;backtest-kit&quot;</span><span class="hl-1">;</span><br/><br/><span class="hl-3">for</span><span class="hl-1"> </span><span class="hl-3">await</span><span class="hl-1"> (</span><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">result</span><span class="hl-1"> </span><span class="hl-6">of</span><span class="hl-1"> </span><span class="hl-4">Backtest</span><span class="hl-1">.</span><span class="hl-0">run</span><span class="hl-1">(</span><span class="hl-2">&quot;BTCUSDT&quot;</span><span class="hl-1">, {</span><br/><span class="hl-1">  </span><span class="hl-4">strategyName:</span><span class="hl-1"> </span><span class="hl-2">&quot;my-strategy&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">exchangeName:</span><span class="hl-1"> </span><span class="hl-2">&quot;binance&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">frameName:</span><span class="hl-1"> </span><span class="hl-2">&quot;1d-backtest&quot;</span><br/><span class="hl-1">})) {</span><br/><span class="hl-1">  </span><span class="hl-4">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-2">&quot;Signal closed:&quot;</span><span class="hl-1">, </span><span class="hl-4">result</span><span class="hl-1">.</span><span class="hl-4">signal</span><span class="hl-1">.</span><span class="hl-4">id</span><span class="hl-1">);</span><br/><span class="hl-1">  </span><span class="hl-4">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-2">&quot;PNL:&quot;</span><span class="hl-1">, </span><span class="hl-4">result</span><span class="hl-1">.</span><span class="hl-4">pnl</span><span class="hl-1">.</span><span class="hl-4">pnlPercentage</span><span class="hl-1">);</span><br/><span class="hl-1">  </span><br/><span class="hl-1">  </span><span class="hl-5">// Early termination on large loss</span><br/><span class="hl-1">  </span><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-4">result</span><span class="hl-1">.</span><span class="hl-4">pnl</span><span class="hl-1">.</span><span class="hl-4">pnlPercentage</span><span class="hl-1"> &lt; -</span><span class="hl-8">5</span><span class="hl-1">) {</span><br/><span class="hl-1">    </span><span class="hl-4">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-2">&quot;Stopping due to large loss&quot;</span><span class="hl-1">);</span><br/><span class="hl-1">    </span><span class="hl-3">break</span><span class="hl-1">;</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">}</span><br/><br/><span class="hl-5">// Get final statistics</span><br/><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">stats</span><span class="hl-1"> = </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-4">Backtest</span><span class="hl-1">.</span><span class="hl-0">getData</span><span class="hl-1">(</span><span class="hl-2">&quot;my-strategy&quot;</span><span class="hl-1">);</span><br/><span class="hl-4">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-2">&quot;Final Sharpe Ratio:&quot;</span><span class="hl-1">, </span><span class="hl-4">stats</span><span class="hl-1">.</span><span class="hl-4">sharpeRatio</span><span class="hl-1">);</span>
</code><button type="button">Copy</button></pre>

<a id="example-2-background-execution-with-event-listeners" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Example 2: Background Execution with Event Listeners<a href="#example-2-background-execution-with-event-listeners" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><pre><code class="typescript"><span class="hl-3">import</span><span class="hl-1"> { </span><span class="hl-4">Backtest</span><span class="hl-1">, </span><span class="hl-4">listenSignalBacktest</span><span class="hl-1">, </span><span class="hl-4">listenDoneBacktest</span><span class="hl-1"> } </span><span class="hl-3">from</span><span class="hl-1"> </span><span class="hl-2">&quot;backtest-kit&quot;</span><span class="hl-1">;</span><br/><br/><span class="hl-5">// Subscribe to events before starting</span><br/><span class="hl-0">listenSignalBacktest</span><span class="hl-1">((</span><span class="hl-4">event</span><span class="hl-1">) </span><span class="hl-6">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-4">event</span><span class="hl-1">.</span><span class="hl-4">action</span><span class="hl-1"> === </span><span class="hl-2">&quot;closed&quot;</span><span class="hl-1">) {</span><br/><span class="hl-1">    </span><span class="hl-4">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-2">&quot;PNL:&quot;</span><span class="hl-1">, </span><span class="hl-4">event</span><span class="hl-1">.</span><span class="hl-4">pnl</span><span class="hl-1">.</span><span class="hl-4">pnlPercentage</span><span class="hl-1">);</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">});</span><br/><br/><span class="hl-0">listenDoneBacktest</span><span class="hl-1">((</span><span class="hl-4">event</span><span class="hl-1">) </span><span class="hl-6">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-4">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-2">&quot;Backtest completed for:&quot;</span><span class="hl-1">, </span><span class="hl-4">event</span><span class="hl-1">.</span><span class="hl-4">symbol</span><span class="hl-1">);</span><br/><span class="hl-1">  </span><span class="hl-4">Backtest</span><span class="hl-1">.</span><span class="hl-0">dump</span><span class="hl-1">(</span><span class="hl-4">event</span><span class="hl-1">.</span><span class="hl-4">strategyName</span><span class="hl-1">);  </span><span class="hl-5">// Auto-save report</span><br/><span class="hl-1">});</span><br/><br/><span class="hl-5">// Run in background</span><br/><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">stop</span><span class="hl-1"> = </span><span class="hl-4">Backtest</span><span class="hl-1">.</span><span class="hl-0">background</span><span class="hl-1">(</span><span class="hl-2">&quot;BTCUSDT&quot;</span><span class="hl-1">, {</span><br/><span class="hl-1">  </span><span class="hl-4">strategyName:</span><span class="hl-1"> </span><span class="hl-2">&quot;my-strategy&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">exchangeName:</span><span class="hl-1"> </span><span class="hl-2">&quot;binance&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">frameName:</span><span class="hl-1"> </span><span class="hl-2">&quot;1d-backtest&quot;</span><br/><span class="hl-1">});</span><br/><br/><span class="hl-5">// Can cancel anytime</span><br/><span class="hl-5">// stop();</span>
</code><button type="button">Copy</button></pre>

<a id="example-3-multi-symbol-portfolio-analysis" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Example 3: Multi-Symbol Portfolio Analysis<a href="#example-3-multi-symbol-portfolio-analysis" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><pre><code class="typescript"><span class="hl-3">import</span><span class="hl-1"> { </span><span class="hl-4">Backtest</span><span class="hl-1"> } </span><span class="hl-3">from</span><span class="hl-1"> </span><span class="hl-2">&quot;backtest-kit&quot;</span><span class="hl-1">;</span><br/><br/><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">symbols</span><span class="hl-1"> = [</span><span class="hl-2">&quot;BTCUSDT&quot;</span><span class="hl-1">, </span><span class="hl-2">&quot;ETHUSDT&quot;</span><span class="hl-1">, </span><span class="hl-2">&quot;SOLUSDT&quot;</span><span class="hl-1">];</span><br/><br/><span class="hl-3">for</span><span class="hl-1"> (</span><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">symbol</span><span class="hl-1"> </span><span class="hl-6">of</span><span class="hl-1"> </span><span class="hl-4">symbols</span><span class="hl-1">) {</span><br/><span class="hl-1">  </span><span class="hl-3">for</span><span class="hl-1"> </span><span class="hl-3">await</span><span class="hl-1"> (</span><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">_</span><span class="hl-1"> </span><span class="hl-6">of</span><span class="hl-1"> </span><span class="hl-4">Backtest</span><span class="hl-1">.</span><span class="hl-0">run</span><span class="hl-1">(</span><span class="hl-4">symbol</span><span class="hl-1">, {</span><br/><span class="hl-1">    </span><span class="hl-4">strategyName:</span><span class="hl-1"> </span><span class="hl-2">&quot;my-strategy&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-4">exchangeName:</span><span class="hl-1"> </span><span class="hl-2">&quot;binance&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-4">frameName:</span><span class="hl-1"> </span><span class="hl-2">&quot;2024-backtest&quot;</span><br/><span class="hl-1">  })) {</span><br/><span class="hl-1">    </span><span class="hl-5">// Consume results</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">  </span><br/><span class="hl-1">  </span><span class="hl-5">// Generate report per symbol</span><br/><span class="hl-1">  </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-4">Backtest</span><span class="hl-1">.</span><span class="hl-0">dump</span><span class="hl-1">(</span><span class="hl-2">&quot;my-strategy&quot;</span><span class="hl-1">, </span><span class="hl-2">`./logs/backtest/</span><span class="hl-6">${</span><span class="hl-4">symbol</span><span class="hl-6">}</span><span class="hl-2">`</span><span class="hl-1">);</span><br/><span class="hl-1">}</span><br/><br/><span class="hl-5">// Get aggregated statistics</span><br/><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">stats</span><span class="hl-1"> = </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-4">Backtest</span><span class="hl-1">.</span><span class="hl-0">getData</span><span class="hl-1">(</span><span class="hl-2">&quot;my-strategy&quot;</span><span class="hl-1">);</span><br/><span class="hl-4">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-2">&quot;Portfolio metrics:&quot;</span><span class="hl-1">, {</span><br/><span class="hl-1">  </span><span class="hl-4">totalSignals:</span><span class="hl-1"> </span><span class="hl-4">stats</span><span class="hl-1">.</span><span class="hl-4">totalSignals</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">winRate:</span><span class="hl-1"> </span><span class="hl-4">stats</span><span class="hl-1">.</span><span class="hl-4">winRate</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">sharpeRatio:</span><span class="hl-1"> </span><span class="hl-4">stats</span><span class="hl-1">.</span><span class="hl-4">sharpeRatio</span><br/><span class="hl-1">});</span>
</code><button type="button">Copy</button></pre>

<a id="related-apis" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Related APIs<a href="#related-apis" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>For scheduled signals tracking, use the <code>Schedule</code> utility class documented in <a href="design_20_schedule_api.html">Schedule API</a>. The Schedule API tracks <code>priceOpen</code> scheduled signals that may be cancelled before activation.</p>
<p>For live trading execution, see <a href="design_18_live_trading_api.html">Live Trading API</a>. The Live API provides crash-safe persistence and real-time monitoring with a similar interface pattern.</p>
<p>For comparing multiple strategies in parallel, see <a href="design_19_walker_api.html">Walker API</a>. The Walker API internally uses <code>Backtest.run()</code> to execute each strategy and rank results by selected metrics.</p>
</div></div><div class="col-sidebar"><div class="page-menu"><div class="tsd-navigation settings"><details class="tsd-accordion"><summary class="tsd-accordion-summary"><h3><svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-chevronDown"></use></svg>Settings</h3></summary><div class="tsd-accordion-details"><div class="tsd-filter-visibility"><span class="settings-label">Member Visibility</span><ul id="tsd-filter-options"><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-protected" name="protected"/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Protected</span></label></li><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-inherited" name="inherited" checked/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Inherited</span></label></li><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-external" name="external"/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>External</span></label></li></ul></div><div class="tsd-theme-toggle"><label class="settings-label" for="tsd-theme">Theme</label><select id="tsd-theme"><option value="os">OS</option><option value="light">Light</option><option value="dark">Dark</option></select></div></div></details></div><details open class="tsd-accordion tsd-page-navigation"><summary class="tsd-accordion-summary"><h3><svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-chevronDown"></use></svg>On This Page</h3></summary><div class="tsd-accordion-details"><a href="#backtest-api"><span>Backtest API</span></a><ul><li><a href="#overview"><span>Overview</span></a></li><li><a href="#backtest-class-methods"><span>Backtest <wbr/>Class <wbr/>Methods</span></a></li><li><ul><li><a href="#backtestrun"><span>Backtest.run()</span></a></li><li><a href="#backtestbackground"><span>Backtest.background()</span></a></li><li><a href="#backtestgetdata"><span>Backtest.get<wbr/>Data()</span></a></li><li><a href="#backtestgetreport"><span>Backtest.get<wbr/>Report()</span></a></li><li><a href="#backtestdump"><span>Backtest.dump()</span></a></li></ul></li><li><a href="#statistics-calculation-details"><span>Statistics <wbr/>Calculation <wbr/>Details</span></a></li><li><ul><li><a href="#metric-calculations"><span>Metric <wbr/>Calculations</span></a></li></ul></li><li><a href="#execution-flow-comparison"><span>Execution <wbr/>Flow <wbr/>Comparison</span></a></li><li><a href="#state-management"><span>State <wbr/>Management</span></a></li><li><a href="#event-integration"><span>Event <wbr/>Integration</span></a></li><li><a href="#usage-examples"><span>Usage <wbr/>Examples</span></a></li><li><ul><li><a href="#example-1-manual-iteration-with-early-termination"><span>Example 1: <wbr/>Manual <wbr/>Iteration with <wbr/>Early <wbr/>Termination</span></a></li><li><a href="#example-2-background-execution-with-event-listeners"><span>Example 2: <wbr/>Background <wbr/>Execution with <wbr/>Event <wbr/>Listeners</span></a></li><li><a href="#example-3-multi-symbol-portfolio-analysis"><span>Example 3: <wbr/>Multi-<wbr/>Symbol <wbr/>Portfolio <wbr/>Analysis</span></a></li></ul></li><li><a href="#related-apis"><span>Related APIs</span></a></li></ul></div></details></div><div class="site-menu"><nav class="tsd-navigation"><a href="../modules.html">backtest-kit</a><ul class="tsd-small-nested-navigation" id="tsd-nav-container"><li>Loading...</li></ul></nav></div></div></div><footer><p class="tsd-generator">Generated using <a href="https://typedoc.org/" target="_blank">TypeDoc</a></p></footer><div class="overlay"></div></body></html>

<!-- Yandex.Metrika counter -->
<script type="text/javascript">
    (function(m,e,t,r,i,k,a){
        m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
        m[i].l=1*new Date();
        for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }}
        k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)
    })(window, document,'script','https://mc.yandex.ru/metrika/tag.js?id=105455585', 'ym');

    ym(105455585, 'init', {ssr:true, webvisor:true, clickmap:true, ecommerce:"dataLayer", accurateTrackBounce:true, trackLinks:true});
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/105455585" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
<!-- /Yandex.Metrika counter -->

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-3MQZEBBDDR"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-3MQZEBBDDR');
</script>
