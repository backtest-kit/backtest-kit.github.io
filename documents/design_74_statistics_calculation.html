<!DOCTYPE html><html class="default" lang="en" data-base=".."><head><meta charset="utf-8"/><meta http-equiv="x-ua-compatible" content="IE=edge"/><title>design/74_statistics_calculation | backtest-kit</title><meta name="description" content="Documentation for backtest-kit"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="stylesheet" href="../assets/style.css"/><link rel="stylesheet" href="../assets/highlight.css"/><script defer src="../assets/main.js"></script><script async src="../assets/icons.js" id="tsd-icons-script"></script><script async src="../assets/search.js" id="tsd-search-script"></script><script async src="../assets/navigation.js" id="tsd-nav-script"></script><script async src="../assets/hierarchy.js" id="tsd-hierarchy-script"></script></head><body><script>document.documentElement.dataset.theme = localStorage.getItem("tsd-theme") || "os";document.body.style.display="none";setTimeout(() => app?app.showPage():document.body.style.removeProperty("display"),500)</script><header class="tsd-page-toolbar"><div class="tsd-toolbar-contents container"><div class="table-cell" id="tsd-search"><div class="field"><label for="tsd-search-field" class="tsd-widget tsd-toolbar-icon search no-caption"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-search"></use></svg></label><input type="text" id="tsd-search-field" aria-label="Search"/></div><div class="field"><div id="tsd-toolbar-links"></div></div><ul class="results"><li class="state loading">Preparing search index...</li><li class="state failure">The search index is not available</li></ul><a href="../index.html" class="title">backtest-kit</a></div><div class="table-cell" id="tsd-widgets"><a href="#" class="tsd-widget tsd-toolbar-icon menu no-caption" data-toggle="menu" aria-label="Menu"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-menu"></use></svg></a></div></div></header><div class="container container-main"><div class="col-content"><div class="tsd-page-title"><ul class="tsd-breadcrumb"><li><a href="../modules.html">backtest-kit</a></li><li><a href="design_74_statistics_calculation.html">design/74_statistics_calculation</a></li></ul></div><div class="tsd-panel tsd-typography"><a id="statistics-calculation" class="tsd-anchor"></a><h1 class="tsd-anchor-link">Statistics Calculation<a href="#statistics-calculation" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h1><a id="purpose-and-scope" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Purpose and Scope<a href="#purpose-and-scope" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>This page explains how trading performance statistics are calculated from closed signals in the backtest-kit framework. It covers the mathematical formulas, implementation details, and safe math handling for all metrics exposed through the reporting system.</p>
<p>For information about generating markdown reports from these statistics, see <a href="design_72_markdown_report_generation.html">Markdown Report Generation</a>. For tracking partial profit/loss milestones during signal execution, see <a href="design_75_partial_profit_loss_tracking.html">Partial Profit/Loss Tracking</a>. For portfolio-level aggregation across multiple symbols, see <a href="design_76_heatmap_analytics.html">Heatmap Analytics</a>.</p>
<p><strong>Scope:</strong> This page covers only the calculation logic for statistics. It does not cover event collection, report formatting, or storage mechanisms.</p>
<hr>
<a id="statistics-types-overview" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Statistics Types Overview<a href="#statistics-types-overview" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>The framework calculates statistics at three levels:</p>
<table>
<thead>
<tr>
<th>Level</th>
<th>Interface</th>
<th>Service</th>
<th>Use Case</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Signal-level</strong></td>
<td><code>BacktestStatistics</code>, <code>LiveStatistics</code></td>
<td><code>BacktestMarkdownService</code>, <code>LiveMarkdownService</code></td>
<td>Individual strategy performance</td>
</tr>
<tr>
<td><strong>Portfolio-level</strong></td>
<td><code>IHeatmapStatistics</code>, <code>IHeatmapRow</code></td>
<td><code>HeatMarkdownService</code></td>
<td>Multi-symbol aggregation</td>
</tr>
<tr>
<td><strong>Comparison</strong></td>
<td><code>WalkerStatistics</code></td>
<td><code>WalkerMarkdownService</code></td>
<td>Strategy ranking</td>
</tr>
<tr>
<td><strong>Partial</strong></td>
<td><code>PartialStatistics</code></td>
<td><code>PartialMarkdownService</code></td>
<td>Milestone tracking</td>
</tr>
<tr>
<td><strong>Performance</strong></td>
<td><code>PerformanceStatistics</code></td>
<td><code>PerformanceMarkdownService</code></td>
<td>Timing analysis</td>
</tr>
</tbody>
</table>
<p><strong>Statistics Calculation Flow</strong></p>
<p><img src="../media/74_Statistics_Calculation_0.svg" alt="Mermaid Diagram"></p>
<hr>
<a id="core-metrics" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Core Metrics<a href="#core-metrics" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><a id="win-rate" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Win Rate<a href="#win-rate" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><strong>Formula:</strong></p>
<pre><code><span class="hl-6">winRate</span><span class="hl-2"> = (</span><span class="hl-6">winCount</span><span class="hl-2"> / </span><span class="hl-6">totalSignals</span><span class="hl-2">) × </span><span class="hl-7">100</span>
</code><button>Copy</button></pre>

<p>Where:</p>
<ul>
<li><code>winCount</code>: Number of signals with <code>pnlPercentage &gt; 0</code></li>
<li><code>totalSignals</code>: Total number of closed signals</li>
<li>Result: Percentage (0-100)</li>
</ul>
<p><strong>Implementation:</strong></p>
<p>The win rate is calculated by filtering closed signals and counting wins:</p>
<p><a href="">src/lib/services/markdown/BacktestMarkdownService.ts:246-252</a></p>
<pre><code class="typescript"><span class="hl-3">const</span><span class="hl-2"> </span><span class="hl-8">winCount</span><span class="hl-2"> = </span><span class="hl-3">this</span><span class="hl-2">.</span><span class="hl-6">_signalList</span><span class="hl-2">.</span><span class="hl-1">filter</span><span class="hl-2">((</span><span class="hl-6">s</span><span class="hl-2">) </span><span class="hl-3">=&gt;</span><span class="hl-2"> </span><span class="hl-6">s</span><span class="hl-2">.</span><span class="hl-6">pnl</span><span class="hl-2">.</span><span class="hl-6">pnlPercentage</span><span class="hl-2"> &gt; </span><span class="hl-7">0</span><span class="hl-2">).</span><span class="hl-6">length</span><span class="hl-2">;</span><br/><span class="hl-3">const</span><span class="hl-2"> </span><span class="hl-8">lossCount</span><span class="hl-2"> = </span><span class="hl-3">this</span><span class="hl-2">.</span><span class="hl-6">_signalList</span><span class="hl-2">.</span><span class="hl-1">filter</span><span class="hl-2">((</span><span class="hl-6">s</span><span class="hl-2">) </span><span class="hl-3">=&gt;</span><span class="hl-2"> </span><span class="hl-6">s</span><span class="hl-2">.</span><span class="hl-6">pnl</span><span class="hl-2">.</span><span class="hl-6">pnlPercentage</span><span class="hl-2"> &lt; </span><span class="hl-7">0</span><span class="hl-2">).</span><span class="hl-6">length</span><span class="hl-2">;</span><br/><span class="hl-3">const</span><span class="hl-2"> </span><span class="hl-8">winRate</span><span class="hl-2"> = (</span><span class="hl-6">winCount</span><span class="hl-2"> / </span><span class="hl-6">totalSignals</span><span class="hl-2">) * </span><span class="hl-7">100</span><span class="hl-2">;</span>
</code><button type="button">Copy</button></pre>

<p><strong>Safe Math:</strong> Returns <code>null</code> if <code>isUnsafe(winRate)</code> evaluates to <code>true</code> <a href="">src/lib/services/markdown/BacktestMarkdownService.ts:286</a>.</p>
<hr>
<a id="average-pnl" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Average PNL<a href="#average-pnl" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><strong>Formula:</strong></p>
<pre><code><span class="hl-6">avgPnl</span><span class="hl-2"> = </span><span class="hl-1">Σ</span><span class="hl-2">(</span><span class="hl-6">pnlPercentage</span><span class="hl-2">) / </span><span class="hl-6">totalSignals</span>
</code><button>Copy</button></pre>

<p>Where:</p>
<ul>
<li><code>pnlPercentage</code>: Net profit/loss percentage for each closed signal (includes fees and slippage)</li>
<li><code>totalSignals</code>: Total number of closed signals</li>
<li>Result: Average percentage per trade</li>
</ul>
<p><strong>Implementation:</strong></p>
<p><a href="">src/lib/services/markdown/BacktestMarkdownService.ts:250</a></p>
<pre><code class="typescript"><span class="hl-3">const</span><span class="hl-2"> </span><span class="hl-8">avgPnl</span><span class="hl-2"> = </span><span class="hl-3">this</span><span class="hl-2">.</span><span class="hl-6">_signalList</span><span class="hl-2">.</span><span class="hl-1">reduce</span><span class="hl-2">((</span><span class="hl-6">sum</span><span class="hl-2">, </span><span class="hl-6">s</span><span class="hl-2">) </span><span class="hl-3">=&gt;</span><span class="hl-2"> </span><span class="hl-6">sum</span><span class="hl-2"> + </span><span class="hl-6">s</span><span class="hl-2">.</span><span class="hl-6">pnl</span><span class="hl-2">.</span><span class="hl-6">pnlPercentage</span><span class="hl-2">, </span><span class="hl-7">0</span><span class="hl-2">) / </span><span class="hl-6">totalSignals</span><span class="hl-2">;</span>
</code><button type="button">Copy</button></pre>

<hr>
<a id="total-pnl" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Total PNL<a href="#total-pnl" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><strong>Formula:</strong></p>
<pre><code><span class="hl-6">totalPnl</span><span class="hl-2"> = </span><span class="hl-1">Σ</span><span class="hl-2">(</span><span class="hl-6">pnlPercentage</span><span class="hl-2">)</span>
</code><button>Copy</button></pre>

<p>Where:</p>
<ul>
<li><code>pnlPercentage</code>: Net profit/loss percentage for each closed signal</li>
<li>Result: Cumulative percentage across all trades</li>
</ul>
<p><strong>Implementation:</strong></p>
<p><a href="">src/lib/services/markdown/BacktestMarkdownService.ts:251</a></p>
<pre><code class="typescript"><span class="hl-3">const</span><span class="hl-2"> </span><span class="hl-8">totalPnl</span><span class="hl-2"> = </span><span class="hl-3">this</span><span class="hl-2">.</span><span class="hl-6">_signalList</span><span class="hl-2">.</span><span class="hl-1">reduce</span><span class="hl-2">((</span><span class="hl-6">sum</span><span class="hl-2">, </span><span class="hl-6">s</span><span class="hl-2">) </span><span class="hl-3">=&gt;</span><span class="hl-2"> </span><span class="hl-6">sum</span><span class="hl-2"> + </span><span class="hl-6">s</span><span class="hl-2">.</span><span class="hl-6">pnl</span><span class="hl-2">.</span><span class="hl-6">pnlPercentage</span><span class="hl-2">, </span><span class="hl-7">0</span><span class="hl-2">);</span>
</code><button type="button">Copy</button></pre>

<hr>
<a id="standard-deviation" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Standard Deviation<a href="#standard-deviation" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><strong>Formula:</strong></p>
<pre><code><span class="hl-6">variance</span><span class="hl-2"> = </span><span class="hl-1">Σ</span><span class="hl-2">((</span><span class="hl-6">pnlᵢ</span><span class="hl-2"> - </span><span class="hl-6">avgPnl</span><span class="hl-2">)²) / </span><span class="hl-6">n</span><br/><span class="hl-6">stdDev</span><span class="hl-2"> = √</span><span class="hl-6">variance</span>
</code><button>Copy</button></pre>

<p>Where:</p>
<ul>
<li><code>pnlᵢ</code>: PNL percentage of signal <code>i</code></li>
<li><code>avgPnl</code>: Average PNL across all signals</li>
<li><code>n</code>: Total number of signals</li>
<li>Result: Volatility measure in percentage points</li>
</ul>
<p><strong>Implementation:</strong></p>
<p><a href="">src/lib/services/markdown/BacktestMarkdownService.ts:255-257</a></p>
<pre><code class="typescript"><span class="hl-3">const</span><span class="hl-2"> </span><span class="hl-8">returns</span><span class="hl-2"> = </span><span class="hl-3">this</span><span class="hl-2">.</span><span class="hl-6">_signalList</span><span class="hl-2">.</span><span class="hl-1">map</span><span class="hl-2">((</span><span class="hl-6">s</span><span class="hl-2">) </span><span class="hl-3">=&gt;</span><span class="hl-2"> </span><span class="hl-6">s</span><span class="hl-2">.</span><span class="hl-6">pnl</span><span class="hl-2">.</span><span class="hl-6">pnlPercentage</span><span class="hl-2">);</span><br/><span class="hl-3">const</span><span class="hl-2"> </span><span class="hl-8">variance</span><span class="hl-2"> = </span><span class="hl-6">returns</span><span class="hl-2">.</span><span class="hl-1">reduce</span><span class="hl-2">((</span><span class="hl-6">sum</span><span class="hl-2">, </span><span class="hl-6">r</span><span class="hl-2">) </span><span class="hl-3">=&gt;</span><span class="hl-2"> </span><span class="hl-6">sum</span><span class="hl-2"> + </span><span class="hl-6">Math</span><span class="hl-2">.</span><span class="hl-1">pow</span><span class="hl-2">(</span><span class="hl-6">r</span><span class="hl-2"> - </span><span class="hl-6">avgPnl</span><span class="hl-2">, </span><span class="hl-7">2</span><span class="hl-2">), </span><span class="hl-7">0</span><span class="hl-2">) / </span><span class="hl-6">totalSignals</span><span class="hl-2">;</span><br/><span class="hl-3">const</span><span class="hl-2"> </span><span class="hl-8">stdDev</span><span class="hl-2"> = </span><span class="hl-6">Math</span><span class="hl-2">.</span><span class="hl-1">sqrt</span><span class="hl-2">(</span><span class="hl-6">variance</span><span class="hl-2">);</span>
</code><button type="button">Copy</button></pre>

<hr>
<a id="sharpe-ratio" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Sharpe Ratio<a href="#sharpe-ratio" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><strong>Formula:</strong></p>
<pre><code><span class="hl-6">sharpeRatio</span><span class="hl-2"> = </span><span class="hl-6">avgPnl</span><span class="hl-2"> / </span><span class="hl-1">stdDev</span><span class="hl-2">  (</span><span class="hl-6">if</span><span class="hl-2"> </span><span class="hl-6">stdDev</span><span class="hl-2"> &gt; </span><span class="hl-7">0</span><span class="hl-2">)</span><br/><span class="hl-2">            = </span><span class="hl-7">0</span><span class="hl-2">                 (</span><span class="hl-6">if</span><span class="hl-2"> </span><span class="hl-6">stdDev</span><span class="hl-2"> = </span><span class="hl-7">0</span><span class="hl-2">)</span>
</code><button>Copy</button></pre>

<p>Where:</p>
<ul>
<li><code>avgPnl</code>: Average PNL percentage</li>
<li><code>stdDev</code>: Standard deviation of returns</li>
<li><strong>Assumption:</strong> Risk-free rate = 0%</li>
<li>Result: Risk-adjusted return metric</li>
</ul>
<p><strong>Interpretation:</strong></p>
<ul>
<li><strong>&gt; 1.0</strong>: Good risk-adjusted returns</li>
<li><strong>&gt; 2.0</strong>: Excellent risk-adjusted returns</li>
<li><strong>&lt; 0</strong>: Negative returns</li>
</ul>
<p><strong>Implementation:</strong></p>
<p><a href="">src/lib/services/markdown/BacktestMarkdownService.ts:258</a></p>
<pre><code class="typescript"><span class="hl-3">const</span><span class="hl-2"> </span><span class="hl-8">sharpeRatio</span><span class="hl-2"> = </span><span class="hl-6">stdDev</span><span class="hl-2"> &gt; </span><span class="hl-7">0</span><span class="hl-2"> ? </span><span class="hl-6">avgPnl</span><span class="hl-2"> / </span><span class="hl-6">stdDev</span><span class="hl-2"> : </span><span class="hl-7">0</span><span class="hl-2">;</span>
</code><button type="button">Copy</button></pre>

<p><strong>Note:</strong> The framework uses a simplified Sharpe Ratio calculation assuming zero risk-free rate. Traditional Sharpe Ratio formula:</p>
<pre><code><span class="hl-6">sharpeRatio</span><span class="hl-2"> = (</span><span class="hl-6">avgReturn</span><span class="hl-2"> - </span><span class="hl-6">riskFreeRate</span><span class="hl-2">) / </span><span class="hl-6">stdDev</span>
</code><button>Copy</button></pre>

<hr>
<a id="annualized-sharpe-ratio" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Annualized Sharpe Ratio<a href="#annualized-sharpe-ratio" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><strong>Formula:</strong></p>
<pre><code><span class="hl-6">annualizedSharpeRatio</span><span class="hl-2"> = </span><span class="hl-6">sharpeRatio</span><span class="hl-2"> × √</span><span class="hl-7">365</span>
</code><button>Copy</button></pre>

<p>Where:</p>
<ul>
<li><code>sharpeRatio</code>: Non-annualized Sharpe Ratio</li>
<li><code>365</code>: Days per year (annualization factor)</li>
<li>Result: Annualized risk-adjusted return metric</li>
</ul>
<p><strong>Rationale:</strong> Multiplying by √365 scales the Sharpe Ratio from the strategy's timeframe to an annual basis.</p>
<p><strong>Implementation:</strong></p>
<p><a href="">src/lib/services/markdown/BacktestMarkdownService.ts:259</a></p>
<pre><code class="typescript"><span class="hl-3">const</span><span class="hl-2"> </span><span class="hl-8">annualizedSharpeRatio</span><span class="hl-2"> = </span><span class="hl-6">sharpeRatio</span><span class="hl-2"> * </span><span class="hl-6">Math</span><span class="hl-2">.</span><span class="hl-1">sqrt</span><span class="hl-2">(</span><span class="hl-7">365</span><span class="hl-2">);</span>
</code><button type="button">Copy</button></pre>

<hr>
<a id="certainty-ratio" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Certainty Ratio<a href="#certainty-ratio" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><strong>Formula:</strong></p>
<pre><code><span class="hl-6">avgWin</span><span class="hl-2"> = </span><span class="hl-1">Σ</span><span class="hl-2">(</span><span class="hl-6">pnl</span><span class="hl-2"> </span><span class="hl-6">where</span><span class="hl-2"> </span><span class="hl-6">pnl</span><span class="hl-2"> &gt; </span><span class="hl-7">0</span><span class="hl-2">) / </span><span class="hl-6">winCount</span><br/><span class="hl-6">avgLoss</span><span class="hl-2"> = </span><span class="hl-1">Σ</span><span class="hl-2">(</span><span class="hl-6">pnl</span><span class="hl-2"> </span><span class="hl-6">where</span><span class="hl-2"> </span><span class="hl-6">pnl</span><span class="hl-2"> &lt; </span><span class="hl-7">0</span><span class="hl-2">) / </span><span class="hl-6">lossCount</span><br/><span class="hl-6">certaintyRatio</span><span class="hl-2"> = </span><span class="hl-6">avgWin</span><span class="hl-2"> / |</span><span class="hl-6">avgLoss</span><span class="hl-2">|  (</span><span class="hl-6">if</span><span class="hl-2"> </span><span class="hl-6">avgLoss</span><span class="hl-2"> &lt; </span><span class="hl-7">0</span><span class="hl-2">)</span><br/><span class="hl-2">               = </span><span class="hl-7">0</span><span class="hl-2">                   (</span><span class="hl-6">otherwise</span><span class="hl-2">)</span>
</code><button>Copy</button></pre>

<p>Where:</p>
<ul>
<li><code>avgWin</code>: Average profit on winning trades</li>
<li><code>avgLoss</code>: Average loss on losing trades (negative value)</li>
<li>Result: Win/loss ratio metric</li>
</ul>
<p><strong>Interpretation:</strong></p>
<ul>
<li><strong>&gt; 1.0</strong>: Average wins are larger than average losses</li>
<li><strong>= 1.0</strong>: Average wins equal average losses</li>
<li><strong>&lt; 1.0</strong>: Average wins are smaller than average losses</li>
</ul>
<p><strong>Implementation:</strong></p>
<p><a href="">src/lib/services/markdown/BacktestMarkdownService.ts:262-270</a></p>
<pre><code class="typescript"><span class="hl-3">const</span><span class="hl-2"> </span><span class="hl-8">wins</span><span class="hl-2"> = </span><span class="hl-3">this</span><span class="hl-2">.</span><span class="hl-6">_signalList</span><span class="hl-2">.</span><span class="hl-1">filter</span><span class="hl-2">((</span><span class="hl-6">s</span><span class="hl-2">) </span><span class="hl-3">=&gt;</span><span class="hl-2"> </span><span class="hl-6">s</span><span class="hl-2">.</span><span class="hl-6">pnl</span><span class="hl-2">.</span><span class="hl-6">pnlPercentage</span><span class="hl-2"> &gt; </span><span class="hl-7">0</span><span class="hl-2">);</span><br/><span class="hl-3">const</span><span class="hl-2"> </span><span class="hl-8">losses</span><span class="hl-2"> = </span><span class="hl-3">this</span><span class="hl-2">.</span><span class="hl-6">_signalList</span><span class="hl-2">.</span><span class="hl-1">filter</span><span class="hl-2">((</span><span class="hl-6">s</span><span class="hl-2">) </span><span class="hl-3">=&gt;</span><span class="hl-2"> </span><span class="hl-6">s</span><span class="hl-2">.</span><span class="hl-6">pnl</span><span class="hl-2">.</span><span class="hl-6">pnlPercentage</span><span class="hl-2"> &lt; </span><span class="hl-7">0</span><span class="hl-2">);</span><br/><span class="hl-3">const</span><span class="hl-2"> </span><span class="hl-8">avgWin</span><span class="hl-2"> = </span><span class="hl-6">wins</span><span class="hl-2">.</span><span class="hl-6">length</span><span class="hl-2"> &gt; </span><span class="hl-7">0</span><br/><span class="hl-2">  ? </span><span class="hl-6">wins</span><span class="hl-2">.</span><span class="hl-1">reduce</span><span class="hl-2">((</span><span class="hl-6">sum</span><span class="hl-2">, </span><span class="hl-6">s</span><span class="hl-2">) </span><span class="hl-3">=&gt;</span><span class="hl-2"> </span><span class="hl-6">sum</span><span class="hl-2"> + </span><span class="hl-6">s</span><span class="hl-2">.</span><span class="hl-6">pnl</span><span class="hl-2">.</span><span class="hl-6">pnlPercentage</span><span class="hl-2">, </span><span class="hl-7">0</span><span class="hl-2">) / </span><span class="hl-6">wins</span><span class="hl-2">.</span><span class="hl-6">length</span><br/><span class="hl-2">  : </span><span class="hl-7">0</span><span class="hl-2">;</span><br/><span class="hl-3">const</span><span class="hl-2"> </span><span class="hl-8">avgLoss</span><span class="hl-2"> = </span><span class="hl-6">losses</span><span class="hl-2">.</span><span class="hl-6">length</span><span class="hl-2"> &gt; </span><span class="hl-7">0</span><br/><span class="hl-2">  ? </span><span class="hl-6">losses</span><span class="hl-2">.</span><span class="hl-1">reduce</span><span class="hl-2">((</span><span class="hl-6">sum</span><span class="hl-2">, </span><span class="hl-6">s</span><span class="hl-2">) </span><span class="hl-3">=&gt;</span><span class="hl-2"> </span><span class="hl-6">sum</span><span class="hl-2"> + </span><span class="hl-6">s</span><span class="hl-2">.</span><span class="hl-6">pnl</span><span class="hl-2">.</span><span class="hl-6">pnlPercentage</span><span class="hl-2">, </span><span class="hl-7">0</span><span class="hl-2">) / </span><span class="hl-6">losses</span><span class="hl-2">.</span><span class="hl-6">length</span><br/><span class="hl-2">  : </span><span class="hl-7">0</span><span class="hl-2">;</span><br/><span class="hl-3">const</span><span class="hl-2"> </span><span class="hl-8">certaintyRatio</span><span class="hl-2"> = </span><span class="hl-6">avgLoss</span><span class="hl-2"> &lt; </span><span class="hl-7">0</span><span class="hl-2"> ? </span><span class="hl-6">avgWin</span><span class="hl-2"> / </span><span class="hl-6">Math</span><span class="hl-2">.</span><span class="hl-1">abs</span><span class="hl-2">(</span><span class="hl-6">avgLoss</span><span class="hl-2">) : </span><span class="hl-7">0</span><span class="hl-2">;</span>
</code><button type="button">Copy</button></pre>

<hr>
<a id="expected-yearly-returns" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Expected Yearly Returns<a href="#expected-yearly-returns" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><strong>Formula:</strong></p>
<pre><code><span class="hl-6">avgDurationMs</span><span class="hl-2"> = </span><span class="hl-1">Σ</span><span class="hl-2">(</span><span class="hl-6">closeTimestamp</span><span class="hl-2"> - </span><span class="hl-6">pendingAt</span><span class="hl-2">) / </span><span class="hl-6">totalSignals</span><br/><span class="hl-6">avgDurationDays</span><span class="hl-2"> = </span><span class="hl-6">avgDurationMs</span><span class="hl-2"> / (</span><span class="hl-7">1000</span><span class="hl-2"> × </span><span class="hl-7">60</span><span class="hl-2"> × </span><span class="hl-7">60</span><span class="hl-2"> × </span><span class="hl-7">24</span><span class="hl-2">)</span><br/><span class="hl-6">tradesPerYear</span><span class="hl-2"> = </span><span class="hl-7">365</span><span class="hl-2"> / </span><span class="hl-1">avgDurationDays</span><span class="hl-2">  (</span><span class="hl-6">if</span><span class="hl-2"> </span><span class="hl-6">avgDurationDays</span><span class="hl-2"> &gt; </span><span class="hl-7">0</span><span class="hl-2">)</span><br/><span class="hl-2">              = </span><span class="hl-7">0</span><span class="hl-2">                      (</span><span class="hl-6">otherwise</span><span class="hl-2">)</span><br/><span class="hl-6">expectedYearlyReturns</span><span class="hl-2"> = </span><span class="hl-6">avgPnl</span><span class="hl-2"> × </span><span class="hl-6">tradesPerYear</span>
</code><button>Copy</button></pre>

<p>Where:</p>
<ul>
<li><code>avgDurationMs</code>: Average trade duration in milliseconds</li>
<li><code>avgDurationDays</code>: Average trade duration in days</li>
<li><code>tradesPerYear</code>: Estimated number of trades per year</li>
<li><code>avgPnl</code>: Average PNL per trade</li>
<li>Result: Projected annual returns as percentage</li>
</ul>
<p><strong>Assumptions:</strong></p>
<ul>
<li>Trade frequency remains constant</li>
<li>Market conditions remain similar</li>
<li>Strategy continues to generate signals at the same rate</li>
</ul>
<p><strong>Implementation:</strong></p>
<p><a href="">src/lib/services/markdown/BacktestMarkdownService.ts:273-279</a></p>
<pre><code class="typescript"><span class="hl-3">const</span><span class="hl-2"> </span><span class="hl-8">avgDurationMs</span><span class="hl-2"> = </span><span class="hl-3">this</span><span class="hl-2">.</span><span class="hl-6">_signalList</span><span class="hl-2">.</span><span class="hl-1">reduce</span><span class="hl-2">(</span><br/><span class="hl-2">  (</span><span class="hl-6">sum</span><span class="hl-2">, </span><span class="hl-6">s</span><span class="hl-2">) </span><span class="hl-3">=&gt;</span><span class="hl-2"> </span><span class="hl-6">sum</span><span class="hl-2"> + (</span><span class="hl-6">s</span><span class="hl-2">.</span><span class="hl-6">closeTimestamp</span><span class="hl-2"> - </span><span class="hl-6">s</span><span class="hl-2">.</span><span class="hl-6">signal</span><span class="hl-2">.</span><span class="hl-6">pendingAt</span><span class="hl-2">),</span><br/><span class="hl-2">  </span><span class="hl-7">0</span><br/><span class="hl-2">) / </span><span class="hl-6">totalSignals</span><span class="hl-2">;</span><br/><span class="hl-3">const</span><span class="hl-2"> </span><span class="hl-8">avgDurationDays</span><span class="hl-2"> = </span><span class="hl-6">avgDurationMs</span><span class="hl-2"> / (</span><span class="hl-7">1000</span><span class="hl-2"> * </span><span class="hl-7">60</span><span class="hl-2"> * </span><span class="hl-7">60</span><span class="hl-2"> * </span><span class="hl-7">24</span><span class="hl-2">);</span><br/><span class="hl-3">const</span><span class="hl-2"> </span><span class="hl-8">tradesPerYear</span><span class="hl-2"> = </span><span class="hl-6">avgDurationDays</span><span class="hl-2"> &gt; </span><span class="hl-7">0</span><span class="hl-2"> ? </span><span class="hl-7">365</span><span class="hl-2"> / </span><span class="hl-6">avgDurationDays</span><span class="hl-2"> : </span><span class="hl-7">0</span><span class="hl-2">;</span><br/><span class="hl-3">const</span><span class="hl-2"> </span><span class="hl-8">expectedYearlyReturns</span><span class="hl-2"> = </span><span class="hl-6">avgPnl</span><span class="hl-2"> * </span><span class="hl-6">tradesPerYear</span><span class="hl-2">;</span>
</code><button type="button">Copy</button></pre>

<hr>
<a id="portfolio-metrics" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Portfolio Metrics<a href="#portfolio-metrics" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>The following metrics are calculated only in <code>HeatMarkdownService</code> for portfolio-level analysis across multiple symbols.</p>
<a id="profit-factor" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Profit Factor<a href="#profit-factor" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><strong>Formula:</strong></p>
<pre><code><span class="hl-6">sumWins</span><span class="hl-2"> = </span><span class="hl-1">Σ</span><span class="hl-2">(</span><span class="hl-6">pnl</span><span class="hl-2"> </span><span class="hl-6">where</span><span class="hl-2"> </span><span class="hl-6">pnl</span><span class="hl-2"> &gt; </span><span class="hl-7">0</span><span class="hl-2">)</span><br/><span class="hl-6">sumLosses</span><span class="hl-2"> = |</span><span class="hl-1">Σ</span><span class="hl-2">(</span><span class="hl-6">pnl</span><span class="hl-2"> </span><span class="hl-6">where</span><span class="hl-2"> </span><span class="hl-6">pnl</span><span class="hl-2"> &lt; </span><span class="hl-7">0</span><span class="hl-2">)|</span><br/><span class="hl-6">profitFactor</span><span class="hl-2"> = </span><span class="hl-6">sumWins</span><span class="hl-2"> / </span><span class="hl-1">sumLosses</span><span class="hl-2">  (</span><span class="hl-6">if</span><span class="hl-2"> </span><span class="hl-6">sumLosses</span><span class="hl-2"> &gt; </span><span class="hl-7">0</span><span class="hl-2">)</span><br/><span class="hl-2">             = </span><span class="hl-3">null</span><span class="hl-2">                  (</span><span class="hl-6">otherwise</span><span class="hl-2">)</span>
</code><button>Copy</button></pre>

<p>Where:</p>
<ul>
<li><code>sumWins</code>: Total profit from winning trades</li>
<li><code>sumLosses</code>: Absolute value of total loss from losing trades</li>
<li>Result: Gross wins to gross losses ratio</li>
</ul>
<p><strong>Interpretation:</strong></p>
<ul>
<li><strong>&gt; 1.0</strong>: Strategy is profitable</li>
<li><strong>= 1.0</strong>: Break-even</li>
<li><strong>&lt; 1.0</strong>: Strategy is losing money</li>
<li><strong>&gt; 2.0</strong>: Strong profitability</li>
</ul>
<p><strong>Implementation:</strong></p>
<p><a href="">src/lib/services/markdown/HeatMarkdownService.ts:246-259</a></p>
<pre><code class="typescript"><span class="hl-3">let</span><span class="hl-2"> </span><span class="hl-6">profitFactor</span><span class="hl-2">: </span><span class="hl-11">number</span><span class="hl-2"> | </span><span class="hl-11">null</span><span class="hl-2"> = </span><span class="hl-3">null</span><span class="hl-2">;</span><br/><span class="hl-5">if</span><span class="hl-2"> (</span><span class="hl-6">winCount</span><span class="hl-2"> &gt; </span><span class="hl-7">0</span><span class="hl-2"> &amp;&amp; </span><span class="hl-6">lossCount</span><span class="hl-2"> &gt; </span><span class="hl-7">0</span><span class="hl-2">) {</span><br/><span class="hl-2">  </span><span class="hl-3">const</span><span class="hl-2"> </span><span class="hl-8">sumWins</span><span class="hl-2"> = </span><span class="hl-6">signals</span><br/><span class="hl-2">    .</span><span class="hl-1">filter</span><span class="hl-2">((</span><span class="hl-6">s</span><span class="hl-2">) </span><span class="hl-3">=&gt;</span><span class="hl-2"> </span><span class="hl-6">s</span><span class="hl-2">.</span><span class="hl-6">pnl</span><span class="hl-2">.</span><span class="hl-6">pnlPercentage</span><span class="hl-2"> &gt; </span><span class="hl-7">0</span><span class="hl-2">)</span><br/><span class="hl-2">    .</span><span class="hl-1">reduce</span><span class="hl-2">((</span><span class="hl-6">acc</span><span class="hl-2">, </span><span class="hl-6">s</span><span class="hl-2">) </span><span class="hl-3">=&gt;</span><span class="hl-2"> </span><span class="hl-6">acc</span><span class="hl-2"> + </span><span class="hl-6">s</span><span class="hl-2">.</span><span class="hl-6">pnl</span><span class="hl-2">.</span><span class="hl-6">pnlPercentage</span><span class="hl-2">, </span><span class="hl-7">0</span><span class="hl-2">);</span><br/><span class="hl-2">  </span><span class="hl-3">const</span><span class="hl-2"> </span><span class="hl-8">sumLosses</span><span class="hl-2"> = </span><span class="hl-6">Math</span><span class="hl-2">.</span><span class="hl-1">abs</span><span class="hl-2">(</span><br/><span class="hl-2">    </span><span class="hl-6">signals</span><br/><span class="hl-2">      .</span><span class="hl-1">filter</span><span class="hl-2">((</span><span class="hl-6">s</span><span class="hl-2">) </span><span class="hl-3">=&gt;</span><span class="hl-2"> </span><span class="hl-6">s</span><span class="hl-2">.</span><span class="hl-6">pnl</span><span class="hl-2">.</span><span class="hl-6">pnlPercentage</span><span class="hl-2"> &lt; </span><span class="hl-7">0</span><span class="hl-2">)</span><br/><span class="hl-2">      .</span><span class="hl-1">reduce</span><span class="hl-2">((</span><span class="hl-6">acc</span><span class="hl-2">, </span><span class="hl-6">s</span><span class="hl-2">) </span><span class="hl-3">=&gt;</span><span class="hl-2"> </span><span class="hl-6">acc</span><span class="hl-2"> + </span><span class="hl-6">s</span><span class="hl-2">.</span><span class="hl-6">pnl</span><span class="hl-2">.</span><span class="hl-6">pnlPercentage</span><span class="hl-2">, </span><span class="hl-7">0</span><span class="hl-2">)</span><br/><span class="hl-2">  );</span><br/><span class="hl-2">  </span><span class="hl-5">if</span><span class="hl-2"> (</span><span class="hl-6">sumLosses</span><span class="hl-2"> &gt; </span><span class="hl-7">0</span><span class="hl-2">) {</span><br/><span class="hl-2">    </span><span class="hl-6">profitFactor</span><span class="hl-2"> = </span><span class="hl-6">sumWins</span><span class="hl-2"> / </span><span class="hl-6">sumLosses</span><span class="hl-2">;</span><br/><span class="hl-2">  }</span><br/><span class="hl-2">}</span>
</code><button type="button">Copy</button></pre>

<hr>
<a id="expectancy" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Expectancy<a href="#expectancy" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><strong>Formula:</strong></p>
<pre><code><span class="hl-6">expectancy</span><span class="hl-2"> = (</span><span class="hl-6">winRate</span><span class="hl-2"> / </span><span class="hl-7">100</span><span class="hl-2">) × </span><span class="hl-6">avgWin</span><span class="hl-2"> + (</span><span class="hl-6">lossRate</span><span class="hl-2"> / </span><span class="hl-7">100</span><span class="hl-2">) × </span><span class="hl-6">avgLoss</span>
</code><button>Copy</button></pre>

<p>Where:</p>
<ul>
<li><code>winRate</code>: Win rate percentage</li>
<li><code>lossRate</code>: Loss rate percentage (100 - winRate)</li>
<li><code>avgWin</code>: Average profit on winning trades</li>
<li><code>avgLoss</code>: Average loss on losing trades (negative value)</li>
<li>Result: Expected value per trade</li>
</ul>
<p><strong>Interpretation:</strong></p>
<ul>
<li><strong>&gt; 0</strong>: Positive expectancy (profitable over time)</li>
<li><strong>= 0</strong>: Zero expectancy (break-even)</li>
<li><strong>&lt; 0</strong>: Negative expectancy (losing over time)</li>
</ul>
<p><strong>Implementation:</strong></p>
<p><a href="">src/lib/services/markdown/HeatMarkdownService.ts:300-304</a></p>
<pre><code class="typescript"><span class="hl-3">let</span><span class="hl-2"> </span><span class="hl-6">expectancy</span><span class="hl-2">: </span><span class="hl-11">number</span><span class="hl-2"> | </span><span class="hl-11">null</span><span class="hl-2"> = </span><span class="hl-3">null</span><span class="hl-2">;</span><br/><span class="hl-5">if</span><span class="hl-2"> (</span><span class="hl-6">winRate</span><span class="hl-2"> !== </span><span class="hl-3">null</span><span class="hl-2"> &amp;&amp; </span><span class="hl-6">avgWin</span><span class="hl-2"> !== </span><span class="hl-3">null</span><span class="hl-2"> &amp;&amp; </span><span class="hl-6">avgLoss</span><span class="hl-2"> !== </span><span class="hl-3">null</span><span class="hl-2">) {</span><br/><span class="hl-2">  </span><span class="hl-3">const</span><span class="hl-2"> </span><span class="hl-8">lossRate</span><span class="hl-2"> = </span><span class="hl-7">100</span><span class="hl-2"> - </span><span class="hl-6">winRate</span><span class="hl-2">;</span><br/><span class="hl-2">  </span><span class="hl-6">expectancy</span><span class="hl-2"> = (</span><span class="hl-6">winRate</span><span class="hl-2"> / </span><span class="hl-7">100</span><span class="hl-2">) * </span><span class="hl-6">avgWin</span><span class="hl-2"> + (</span><span class="hl-6">lossRate</span><span class="hl-2"> / </span><span class="hl-7">100</span><span class="hl-2">) * </span><span class="hl-6">avgLoss</span><span class="hl-2">;</span><br/><span class="hl-2">}</span>
</code><button type="button">Copy</button></pre>

<hr>
<a id="maximum-drawdown" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Maximum Drawdown<a href="#maximum-drawdown" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><strong>Formula:</strong></p>
<pre><code><span class="hl-6">For</span><span class="hl-2"> </span><span class="hl-6">each</span><span class="hl-2"> </span><span class="hl-6">signal</span><span class="hl-2"> </span><span class="hl-10">i</span><span class="hl-2">:</span><br/><span class="hl-2">  </span><span class="hl-6">cumulativePnl</span><span class="hl-2">[</span><span class="hl-6">i</span><span class="hl-2">] = </span><span class="hl-6">cumulativePnl</span><span class="hl-2">[</span><span class="hl-6">i</span><span class="hl-2">-</span><span class="hl-7">1</span><span class="hl-2">] + </span><span class="hl-6">pnl</span><span class="hl-2">[</span><span class="hl-6">i</span><span class="hl-2">]</span><br/><span class="hl-2">  </span><span class="hl-6">peak</span><span class="hl-2">[</span><span class="hl-6">i</span><span class="hl-2">] = </span><span class="hl-1">max</span><span class="hl-2">(</span><span class="hl-6">peak</span><span class="hl-2">[</span><span class="hl-6">i</span><span class="hl-2">-</span><span class="hl-7">1</span><span class="hl-2">], </span><span class="hl-6">cumulativePnl</span><span class="hl-2">[</span><span class="hl-6">i</span><span class="hl-2">])</span><br/><span class="hl-2">  </span><span class="hl-6">drawdown</span><span class="hl-2">[</span><span class="hl-6">i</span><span class="hl-2">] = </span><span class="hl-6">peak</span><span class="hl-2">[</span><span class="hl-6">i</span><span class="hl-2">] - </span><span class="hl-6">cumulativePnl</span><span class="hl-2">[</span><span class="hl-6">i</span><span class="hl-2">]</span><br/><span class="hl-6">maxDrawdown</span><span class="hl-2"> = </span><span class="hl-1">max</span><span class="hl-2">(</span><span class="hl-6">drawdown</span><span class="hl-2">[</span><span class="hl-6">i</span><span class="hl-2">] </span><span class="hl-6">for</span><span class="hl-2"> </span><span class="hl-6">all</span><span class="hl-2"> </span><span class="hl-6">i</span><span class="hl-2">)</span>
</code><button>Copy</button></pre>

<p>Where:</p>
<ul>
<li><code>cumulativePnl</code>: Running sum of PNL</li>
<li><code>peak</code>: Highest cumulative PNL reached</li>
<li><code>drawdown</code>: Distance from peak to current value</li>
<li>Result: Maximum drawdown as positive percentage</li>
</ul>
<p><strong>Implementation:</strong></p>
<p><a href="">src/lib/services/markdown/HeatMarkdownService.ts:224-243</a></p>
<pre><code class="typescript"><span class="hl-3">let</span><span class="hl-2"> </span><span class="hl-6">maxDrawdown</span><span class="hl-2">: </span><span class="hl-11">number</span><span class="hl-2"> | </span><span class="hl-11">null</span><span class="hl-2"> = </span><span class="hl-3">null</span><span class="hl-2">;</span><br/><span class="hl-5">if</span><span class="hl-2"> (</span><span class="hl-6">signals</span><span class="hl-2">.</span><span class="hl-6">length</span><span class="hl-2"> &gt; </span><span class="hl-7">0</span><span class="hl-2">) {</span><br/><span class="hl-2">  </span><span class="hl-3">let</span><span class="hl-2"> </span><span class="hl-6">peak</span><span class="hl-2"> = </span><span class="hl-7">0</span><span class="hl-2">;</span><br/><span class="hl-2">  </span><span class="hl-3">let</span><span class="hl-2"> </span><span class="hl-6">currentDrawdown</span><span class="hl-2"> = </span><span class="hl-7">0</span><span class="hl-2">;</span><br/><span class="hl-2">  </span><span class="hl-3">let</span><span class="hl-2"> </span><span class="hl-6">maxDD</span><span class="hl-2"> = </span><span class="hl-7">0</span><span class="hl-2">;</span><br/><br/><span class="hl-2">  </span><span class="hl-5">for</span><span class="hl-2"> (</span><span class="hl-3">const</span><span class="hl-2"> </span><span class="hl-8">signal</span><span class="hl-2"> </span><span class="hl-3">of</span><span class="hl-2"> </span><span class="hl-6">signals</span><span class="hl-2">) {</span><br/><span class="hl-2">    </span><span class="hl-6">peak</span><span class="hl-2"> += </span><span class="hl-6">signal</span><span class="hl-2">.</span><span class="hl-6">pnl</span><span class="hl-2">.</span><span class="hl-6">pnlPercentage</span><span class="hl-2">;</span><br/><span class="hl-2">    </span><span class="hl-5">if</span><span class="hl-2"> (</span><span class="hl-6">peak</span><span class="hl-2"> &gt; </span><span class="hl-7">0</span><span class="hl-2">) {</span><br/><span class="hl-2">      </span><span class="hl-6">currentDrawdown</span><span class="hl-2"> = </span><span class="hl-7">0</span><span class="hl-2">;</span><br/><span class="hl-2">    } </span><span class="hl-5">else</span><span class="hl-2"> {</span><br/><span class="hl-2">      </span><span class="hl-6">currentDrawdown</span><span class="hl-2"> = </span><span class="hl-6">Math</span><span class="hl-2">.</span><span class="hl-1">abs</span><span class="hl-2">(</span><span class="hl-6">peak</span><span class="hl-2">);</span><br/><span class="hl-2">      </span><span class="hl-5">if</span><span class="hl-2"> (</span><span class="hl-6">currentDrawdown</span><span class="hl-2"> &gt; </span><span class="hl-6">maxDD</span><span class="hl-2">) {</span><br/><span class="hl-2">        </span><span class="hl-6">maxDD</span><span class="hl-2"> = </span><span class="hl-6">currentDrawdown</span><span class="hl-2">;</span><br/><span class="hl-2">      }</span><br/><span class="hl-2">    }</span><br/><span class="hl-2">  }</span><br/><br/><span class="hl-2">  </span><span class="hl-6">maxDrawdown</span><span class="hl-2"> = </span><span class="hl-6">maxDD</span><span class="hl-2">;</span><br/><span class="hl-2">}</span>
</code><button type="button">Copy</button></pre>

<hr>
<a id="winloss-streaks" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Win/Loss Streaks<a href="#winloss-streaks" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><strong>Formula:</strong></p>
<pre><code><span class="hl-6">currentWinStreak</span><span class="hl-2"> = </span><span class="hl-7">0</span><br/><span class="hl-6">currentLossStreak</span><span class="hl-2"> = </span><span class="hl-7">0</span><br/><span class="hl-6">maxWinStreak</span><span class="hl-2"> = </span><span class="hl-7">0</span><br/><span class="hl-6">maxLossStreak</span><span class="hl-2"> = </span><span class="hl-7">0</span><br/><br/><span class="hl-6">For</span><span class="hl-2"> </span><span class="hl-6">each</span><span class="hl-2"> </span><span class="hl-10">signal</span><span class="hl-2">:</span><br/><span class="hl-2">  </span><span class="hl-5">if</span><span class="hl-2"> </span><span class="hl-6">pnl</span><span class="hl-2"> &gt; </span><span class="hl-7">0</span><span class="hl-2">:</span><br/><span class="hl-2">    </span><span class="hl-6">currentWinStreak</span><span class="hl-2">++</span><br/><span class="hl-2">    </span><span class="hl-6">currentLossStreak</span><span class="hl-2"> = </span><span class="hl-7">0</span><br/><span class="hl-2">    </span><span class="hl-6">maxWinStreak</span><span class="hl-2"> = </span><span class="hl-1">max</span><span class="hl-2">(</span><span class="hl-6">maxWinStreak</span><span class="hl-2">, </span><span class="hl-6">currentWinStreak</span><span class="hl-2">)</span><br/><span class="hl-2">  </span><span class="hl-5">else</span><span class="hl-2"> </span><span class="hl-5">if</span><span class="hl-2"> </span><span class="hl-6">pnl</span><span class="hl-2"> &lt; </span><span class="hl-7">0</span><span class="hl-2">:</span><br/><span class="hl-2">    </span><span class="hl-6">currentLossStreak</span><span class="hl-2">++</span><br/><span class="hl-2">    </span><span class="hl-6">currentWinStreak</span><span class="hl-2"> = </span><span class="hl-7">0</span><br/><span class="hl-2">    </span><span class="hl-6">maxLossStreak</span><span class="hl-2"> = </span><span class="hl-1">max</span><span class="hl-2">(</span><span class="hl-6">maxLossStreak</span><span class="hl-2">, </span><span class="hl-6">currentLossStreak</span><span class="hl-2">)</span>
</code><button>Copy</button></pre>

<p>Where:</p>
<ul>
<li><code>currentWinStreak</code>: Consecutive wins counter</li>
<li><code>currentLossStreak</code>: Consecutive losses counter</li>
<li>Result: Maximum consecutive wins/losses observed</li>
</ul>
<p><strong>Implementation:</strong></p>
<p><a href="">src/lib/services/markdown/HeatMarkdownService.ts:278-297</a></p>
<pre><code class="typescript"><span class="hl-3">let</span><span class="hl-2"> </span><span class="hl-6">maxWinStreak</span><span class="hl-2"> = </span><span class="hl-7">0</span><span class="hl-2">;</span><br/><span class="hl-3">let</span><span class="hl-2"> </span><span class="hl-6">maxLossStreak</span><span class="hl-2"> = </span><span class="hl-7">0</span><span class="hl-2">;</span><br/><span class="hl-3">let</span><span class="hl-2"> </span><span class="hl-6">currentWinStreak</span><span class="hl-2"> = </span><span class="hl-7">0</span><span class="hl-2">;</span><br/><span class="hl-3">let</span><span class="hl-2"> </span><span class="hl-6">currentLossStreak</span><span class="hl-2"> = </span><span class="hl-7">0</span><span class="hl-2">;</span><br/><br/><span class="hl-5">for</span><span class="hl-2"> (</span><span class="hl-3">const</span><span class="hl-2"> </span><span class="hl-8">signal</span><span class="hl-2"> </span><span class="hl-3">of</span><span class="hl-2"> </span><span class="hl-6">signals</span><span class="hl-2">) {</span><br/><span class="hl-2">  </span><span class="hl-5">if</span><span class="hl-2"> (</span><span class="hl-6">signal</span><span class="hl-2">.</span><span class="hl-6">pnl</span><span class="hl-2">.</span><span class="hl-6">pnlPercentage</span><span class="hl-2"> &gt; </span><span class="hl-7">0</span><span class="hl-2">) {</span><br/><span class="hl-2">    </span><span class="hl-6">currentWinStreak</span><span class="hl-2">++;</span><br/><span class="hl-2">    </span><span class="hl-6">currentLossStreak</span><span class="hl-2"> = </span><span class="hl-7">0</span><span class="hl-2">;</span><br/><span class="hl-2">    </span><span class="hl-5">if</span><span class="hl-2"> (</span><span class="hl-6">currentWinStreak</span><span class="hl-2"> &gt; </span><span class="hl-6">maxWinStreak</span><span class="hl-2">) {</span><br/><span class="hl-2">      </span><span class="hl-6">maxWinStreak</span><span class="hl-2"> = </span><span class="hl-6">currentWinStreak</span><span class="hl-2">;</span><br/><span class="hl-2">    }</span><br/><span class="hl-2">  } </span><span class="hl-5">else</span><span class="hl-2"> </span><span class="hl-5">if</span><span class="hl-2"> (</span><span class="hl-6">signal</span><span class="hl-2">.</span><span class="hl-6">pnl</span><span class="hl-2">.</span><span class="hl-6">pnlPercentage</span><span class="hl-2"> &lt; </span><span class="hl-7">0</span><span class="hl-2">) {</span><br/><span class="hl-2">    </span><span class="hl-6">currentLossStreak</span><span class="hl-2">++;</span><br/><span class="hl-2">    </span><span class="hl-6">currentWinStreak</span><span class="hl-2"> = </span><span class="hl-7">0</span><span class="hl-2">;</span><br/><span class="hl-2">    </span><span class="hl-5">if</span><span class="hl-2"> (</span><span class="hl-6">currentLossStreak</span><span class="hl-2"> &gt; </span><span class="hl-6">maxLossStreak</span><span class="hl-2">) {</span><br/><span class="hl-2">      </span><span class="hl-6">maxLossStreak</span><span class="hl-2"> = </span><span class="hl-6">currentLossStreak</span><span class="hl-2">;</span><br/><span class="hl-2">    }</span><br/><span class="hl-2">  }</span><br/><span class="hl-2">}</span>
</code><button type="button">Copy</button></pre>

<hr>
<a id="safe-math-implementation" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Safe Math Implementation<a href="#safe-math-implementation" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>All numeric statistics are validated using the <code>isUnsafe()</code> function to prevent display of invalid values.</p>
<p><strong>Safe Math Validation Logic</strong></p>
<p><img src="../media/74_Statistics_Calculation_1.svg" alt="Mermaid Diagram"></p>
<p><strong>Implementation:</strong></p>
<p><a href="">src/lib/services/markdown/BacktestMarkdownService.ts:37-48</a></p>
<pre><code class="typescript"><span class="hl-3">function</span><span class="hl-2"> </span><span class="hl-1">isUnsafe</span><span class="hl-2">(</span><span class="hl-6">value</span><span class="hl-2">: </span><span class="hl-11">number</span><span class="hl-2"> | </span><span class="hl-11">null</span><span class="hl-2">): </span><span class="hl-11">boolean</span><span class="hl-2"> {</span><br/><span class="hl-2">  </span><span class="hl-5">if</span><span class="hl-2"> (</span><span class="hl-3">typeof</span><span class="hl-2"> </span><span class="hl-6">value</span><span class="hl-2"> !== </span><span class="hl-4">&quot;number&quot;</span><span class="hl-2">) {</span><br/><span class="hl-2">    </span><span class="hl-5">return</span><span class="hl-2"> </span><span class="hl-3">true</span><span class="hl-2">;</span><br/><span class="hl-2">  }</span><br/><span class="hl-2">  </span><span class="hl-5">if</span><span class="hl-2"> (</span><span class="hl-1">isNaN</span><span class="hl-2">(</span><span class="hl-6">value</span><span class="hl-2">)) {</span><br/><span class="hl-2">    </span><span class="hl-5">return</span><span class="hl-2"> </span><span class="hl-3">true</span><span class="hl-2">;</span><br/><span class="hl-2">  }</span><br/><span class="hl-2">  </span><span class="hl-5">if</span><span class="hl-2"> (!</span><span class="hl-1">isFinite</span><span class="hl-2">(</span><span class="hl-6">value</span><span class="hl-2">)) {</span><br/><span class="hl-2">    </span><span class="hl-5">return</span><span class="hl-2"> </span><span class="hl-3">true</span><span class="hl-2">;</span><br/><span class="hl-2">  }</span><br/><span class="hl-2">  </span><span class="hl-5">return</span><span class="hl-2"> </span><span class="hl-3">false</span><span class="hl-2">;</span><br/><span class="hl-2">}</span>
</code><button type="button">Copy</button></pre>

<p><strong>Application:</strong></p>
<p><a href="">src/lib/services/markdown/BacktestMarkdownService.ts:286-293</a></p>
<pre><code class="typescript"><span class="hl-10">winRate</span><span class="hl-2">: </span><span class="hl-1">isUnsafe</span><span class="hl-2">(</span><span class="hl-6">winRate</span><span class="hl-2">) ? </span><span class="hl-3">null</span><span class="hl-2"> : </span><span class="hl-6">winRate</span><span class="hl-2">,</span><br/><span class="hl-10">avgPnl</span><span class="hl-2">: </span><span class="hl-1">isUnsafe</span><span class="hl-2">(</span><span class="hl-6">avgPnl</span><span class="hl-2">) ? </span><span class="hl-3">null</span><span class="hl-2"> : </span><span class="hl-6">avgPnl</span><span class="hl-2">,</span><br/><span class="hl-10">totalPnl</span><span class="hl-2">: </span><span class="hl-1">isUnsafe</span><span class="hl-2">(</span><span class="hl-6">totalPnl</span><span class="hl-2">) ? </span><span class="hl-3">null</span><span class="hl-2"> : </span><span class="hl-6">totalPnl</span><span class="hl-2">,</span><br/><span class="hl-10">stdDev</span><span class="hl-2">: </span><span class="hl-1">isUnsafe</span><span class="hl-2">(</span><span class="hl-6">stdDev</span><span class="hl-2">) ? </span><span class="hl-3">null</span><span class="hl-2"> : </span><span class="hl-6">stdDev</span><span class="hl-2">,</span><br/><span class="hl-10">sharpeRatio</span><span class="hl-2">: </span><span class="hl-1">isUnsafe</span><span class="hl-2">(</span><span class="hl-6">sharpeRatio</span><span class="hl-2">) ? </span><span class="hl-3">null</span><span class="hl-2"> : </span><span class="hl-6">sharpeRatio</span><span class="hl-2">,</span><br/><span class="hl-10">annualizedSharpeRatio</span><span class="hl-2">: </span><span class="hl-1">isUnsafe</span><span class="hl-2">(</span><span class="hl-6">annualizedSharpeRatio</span><span class="hl-2">) ? </span><span class="hl-3">null</span><span class="hl-2"> : </span><span class="hl-6">annualizedSharpeRatio</span><span class="hl-2">,</span><br/><span class="hl-10">certaintyRatio</span><span class="hl-2">: </span><span class="hl-1">isUnsafe</span><span class="hl-2">(</span><span class="hl-6">certaintyRatio</span><span class="hl-2">) ? </span><span class="hl-3">null</span><span class="hl-2"> : </span><span class="hl-6">certaintyRatio</span><span class="hl-2">,</span><br/><span class="hl-10">expectedYearlyReturns</span><span class="hl-2">: </span><span class="hl-1">isUnsafe</span><span class="hl-2">(</span><span class="hl-6">expectedYearlyReturns</span><span class="hl-2">) ? </span><span class="hl-3">null</span><span class="hl-2"> : </span><span class="hl-6">expectedYearlyReturns</span><span class="hl-2">,</span>
</code><button type="button">Copy</button></pre>

<p><strong>Edge Cases Handled:</strong></p>
<ul>
<li>Division by zero (e.g., <code>avgPnl / stdDev</code> when <code>stdDev = 0</code>)</li>
<li>Empty signal lists (returns default null values)</li>
<li>Non-numeric types from calculation errors</li>
<li><code>NaN</code> from invalid mathematical operations</li>
<li><code>Infinity</code> or <code>-Infinity</code> from overflow</li>
</ul>
<hr>
<a id="statistics-by-execution-mode" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Statistics by Execution Mode<a href="#statistics-by-execution-mode" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>Different execution modes calculate statistics with mode-specific nuances:</p>
<p><strong>Statistics Comparison Table</strong></p>
<table>
<thead>
<tr>
<th>Metric</th>
<th>Backtest Mode</th>
<th>Live Mode</th>
<th>Portfolio (Heat)</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Win Rate</strong></td>
<td>Closed signals only</td>
<td>Closed signals only</td>
<td>Per-symbol aggregation</td>
<td>Identical calculation</td>
</tr>
<tr>
<td><strong>Avg PNL</strong></td>
<td>Closed signals only</td>
<td>Closed signals only</td>
<td>Per-symbol aggregation</td>
<td>Identical calculation</td>
</tr>
<tr>
<td><strong>Total PNL</strong></td>
<td>Cumulative sum</td>
<td>Cumulative sum</td>
<td>Portfolio sum</td>
<td>Identical calculation</td>
</tr>
<tr>
<td><strong>Sharpe Ratio</strong></td>
<td>Single value</td>
<td>Single value</td>
<td>Weighted by trade count</td>
<td>Portfolio uses weighted average</td>
</tr>
<tr>
<td><strong>Duration</strong></td>
<td><code>closeTimestamp - pendingAt</code></td>
<td><code>closeTimestamp - pendingAt</code></td>
<td>Per-symbol average</td>
<td>Same calculation</td>
</tr>
<tr>
<td><strong>Profit Factor</strong></td>
<td>❌ Not calculated</td>
<td>❌ Not calculated</td>
<td>✅ Calculated</td>
<td>Heat-only metric</td>
</tr>
<tr>
<td><strong>Expectancy</strong></td>
<td>❌ Not calculated</td>
<td>❌ Not calculated</td>
<td>✅ Calculated</td>
<td>Heat-only metric</td>
</tr>
<tr>
<td><strong>Max Drawdown</strong></td>
<td>❌ Not calculated</td>
<td>❌ Not calculated</td>
<td>✅ Calculated</td>
<td>Heat-only metric</td>
</tr>
<tr>
<td><strong>Streaks</strong></td>
<td>❌ Not calculated</td>
<td>❌ Not calculated</td>
<td>✅ Calculated</td>
<td>Heat-only metric</td>
</tr>
</tbody>
</table>
<p><strong>Backtest vs Live Statistics Interfaces</strong></p>
<p><img src="../media/74_Statistics_Calculation_2.svg" alt="Mermaid Diagram"></p>
<p><strong>Key Differences:</strong></p>
<ol>
<li>
<p><strong>Event Scope:</strong></p>
<ul>
<li>Backtest: Only stores <code>closed</code> signals <a href="">src/lib/services/markdown/BacktestMarkdownService.ts:433-435</a></li>
<li>Live: Stores all event types (<code>idle</code>, <code>opened</code>, <code>active</code>, <code>closed</code>) <a href="">src/lib/services/markdown/LiveMarkdownService.ts:637-645</a></li>
</ul>
</li>
<li>
<p><strong>Statistics Calculation:</strong></p>
<ul>
<li>Both modes filter for closed signals before calculation</li>
<li>Backtest: <code>this._signalList</code> is already filtered <a href="">src/lib/services/markdown/BacktestMarkdownService.ts:245</a></li>
<li>Live: Filters <code>closedEvents = this._eventList.filter((e) =&gt; e.action === &quot;closed&quot;)</code> <a href="">src/lib/services/markdown/LiveMarkdownService.ts:428</a></li>
</ul>
</li>
<li>
<p><strong>Extended Metrics:</strong></p>
<ul>
<li>Portfolio (Heat) calculates additional metrics not available in individual strategy statistics</li>
<li>Heat calculates weighted Sharpe Ratio across symbols <a href="">src/lib/services/markdown/HeatMarkdownService.ts:373-382</a></li>
</ul>
</li>
</ol>
<hr>
<a id="calculation-flow-by-service" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Calculation Flow by Service<a href="#calculation-flow-by-service" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p><strong>Service-to-Statistics Mapping</strong></p>
<p><img src="../media/74_Statistics_Calculation_3.svg" alt="Mermaid Diagram"></p>
<hr>
<a id="performance-statistics" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Performance Statistics<a href="#performance-statistics" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>Performance statistics track execution timing rather than trading results. These are calculated in <code>PerformanceMarkdownService</code>.</p>
<p><strong>Performance Metrics Table</strong></p>
<table>
<thead>
<tr>
<th>Metric</th>
<th>Formula</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Count</strong></td>
<td>Number of events</td>
<td>Sample size</td>
</tr>
<tr>
<td><strong>Total Duration</strong></td>
<td><code>Σ(duration)</code></td>
<td>Total execution time</td>
</tr>
<tr>
<td><strong>Average Duration</strong></td>
<td><code>totalDuration / count</code></td>
<td>Mean execution time</td>
</tr>
<tr>
<td><strong>Min Duration</strong></td>
<td><code>min(duration[])</code></td>
<td>Best-case performance</td>
</tr>
<tr>
<td><strong>Max Duration</strong></td>
<td><code>max(duration[])</code></td>
<td>Worst-case performance</td>
</tr>
<tr>
<td><strong>Std Dev</strong></td>
<td><code>√(Σ(duration - avg)² / n)</code></td>
<td>Timing variance</td>
</tr>
<tr>
<td><strong>Median</strong></td>
<td><code>percentile(50)</code></td>
<td>Typical performance</td>
</tr>
<tr>
<td><strong>P95</strong></td>
<td><code>percentile(95)</code></td>
<td>95th percentile</td>
</tr>
<tr>
<td><strong>P99</strong></td>
<td><code>percentile(99)</code></td>
<td>99th percentile</td>
</tr>
<tr>
<td><strong>Avg Wait Time</strong></td>
<td>Average interval between events</td>
<td>Event frequency</td>
</tr>
</tbody>
</table>
<p><strong>Percentile Calculation:</strong></p>
<p><a href="">src/lib/services/markdown/PerformanceMarkdownService.ts:96-100</a></p>
<pre><code class="typescript"><span class="hl-3">function</span><span class="hl-2"> </span><span class="hl-1">percentile</span><span class="hl-2">(</span><span class="hl-6">sortedArray</span><span class="hl-2">: </span><span class="hl-11">number</span><span class="hl-2">[], </span><span class="hl-6">p</span><span class="hl-2">: </span><span class="hl-11">number</span><span class="hl-2">): </span><span class="hl-11">number</span><span class="hl-2"> {</span><br/><span class="hl-2">  </span><span class="hl-5">if</span><span class="hl-2"> (</span><span class="hl-6">sortedArray</span><span class="hl-2">.</span><span class="hl-6">length</span><span class="hl-2"> === </span><span class="hl-7">0</span><span class="hl-2">) </span><span class="hl-5">return</span><span class="hl-2"> </span><span class="hl-7">0</span><span class="hl-2">;</span><br/><span class="hl-2">  </span><span class="hl-3">const</span><span class="hl-2"> </span><span class="hl-8">index</span><span class="hl-2"> = </span><span class="hl-6">Math</span><span class="hl-2">.</span><span class="hl-1">ceil</span><span class="hl-2">((</span><span class="hl-6">sortedArray</span><span class="hl-2">.</span><span class="hl-6">length</span><span class="hl-2"> * </span><span class="hl-6">p</span><span class="hl-2">) / </span><span class="hl-7">100</span><span class="hl-2">) - </span><span class="hl-7">1</span><span class="hl-2">;</span><br/><span class="hl-2">  </span><span class="hl-5">return</span><span class="hl-2"> </span><span class="hl-6">sortedArray</span><span class="hl-2">[</span><span class="hl-6">Math</span><span class="hl-2">.</span><span class="hl-1">max</span><span class="hl-2">(</span><span class="hl-7">0</span><span class="hl-2">, </span><span class="hl-6">index</span><span class="hl-2">)];</span><br/><span class="hl-2">}</span>
</code><button type="button">Copy</button></pre>

<p><strong>Wait Time Calculation:</strong></p>
<p><a href="">src/lib/services/markdown/PerformanceMarkdownService.ts:264-282</a></p>
<pre><code class="typescript"><span class="hl-3">const</span><span class="hl-2"> </span><span class="hl-8">waitTimes</span><span class="hl-2">: </span><span class="hl-11">number</span><span class="hl-2">[] = [];</span><br/><span class="hl-5">for</span><span class="hl-2"> (</span><span class="hl-3">let</span><span class="hl-2"> </span><span class="hl-6">i</span><span class="hl-2"> = </span><span class="hl-7">0</span><span class="hl-2">; </span><span class="hl-6">i</span><span class="hl-2"> &lt; </span><span class="hl-6">events</span><span class="hl-2">.</span><span class="hl-6">length</span><span class="hl-2">; </span><span class="hl-6">i</span><span class="hl-2">++) {</span><br/><span class="hl-2">  </span><span class="hl-5">if</span><span class="hl-2"> (</span><span class="hl-6">events</span><span class="hl-2">[</span><span class="hl-6">i</span><span class="hl-2">].</span><span class="hl-6">previousTimestamp</span><span class="hl-2"> !== </span><span class="hl-3">null</span><span class="hl-2">) {</span><br/><span class="hl-2">    </span><span class="hl-3">const</span><span class="hl-2"> </span><span class="hl-8">waitTime</span><span class="hl-2"> = </span><span class="hl-6">events</span><span class="hl-2">[</span><span class="hl-6">i</span><span class="hl-2">].</span><span class="hl-6">timestamp</span><span class="hl-2"> - </span><span class="hl-6">events</span><span class="hl-2">[</span><span class="hl-6">i</span><span class="hl-2">].</span><span class="hl-6">previousTimestamp</span><span class="hl-2">!;</span><br/><span class="hl-2">    </span><span class="hl-6">waitTimes</span><span class="hl-2">.</span><span class="hl-1">push</span><span class="hl-2">(</span><span class="hl-6">waitTime</span><span class="hl-2">);</span><br/><span class="hl-2">  }</span><br/><span class="hl-2">}</span><br/><br/><span class="hl-3">const</span><span class="hl-2"> </span><span class="hl-8">sortedWaitTimes</span><span class="hl-2"> = </span><span class="hl-6">waitTimes</span><span class="hl-2">.</span><span class="hl-1">sort</span><span class="hl-2">((</span><span class="hl-6">a</span><span class="hl-2">, </span><span class="hl-6">b</span><span class="hl-2">) </span><span class="hl-3">=&gt;</span><span class="hl-2"> </span><span class="hl-6">a</span><span class="hl-2"> - </span><span class="hl-6">b</span><span class="hl-2">);</span><br/><span class="hl-3">const</span><span class="hl-2"> </span><span class="hl-8">avgWaitTime</span><span class="hl-2"> =</span><br/><span class="hl-2">  </span><span class="hl-6">sortedWaitTimes</span><span class="hl-2">.</span><span class="hl-6">length</span><span class="hl-2"> &gt; </span><span class="hl-7">0</span><br/><span class="hl-2">    ? </span><span class="hl-6">sortedWaitTimes</span><span class="hl-2">.</span><span class="hl-1">reduce</span><span class="hl-2">((</span><span class="hl-6">sum</span><span class="hl-2">, </span><span class="hl-6">w</span><span class="hl-2">) </span><span class="hl-3">=&gt;</span><span class="hl-2"> </span><span class="hl-6">sum</span><span class="hl-2"> + </span><span class="hl-6">w</span><span class="hl-2">, </span><span class="hl-7">0</span><span class="hl-2">) / </span><span class="hl-6">sortedWaitTimes</span><span class="hl-2">.</span><span class="hl-6">length</span><br/><span class="hl-2">    : </span><span class="hl-7">0</span><span class="hl-2">;</span>
</code><button type="button">Copy</button></pre>

<hr>
<a id="summary" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Summary<a href="#summary" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>The statistics calculation system provides comprehensive performance metrics through a layered architecture:</p>
<ol>
<li><strong>Core metrics</strong> (win rate, PNL, Sharpe ratio) are calculated identically across backtest and live modes</li>
<li><strong>Portfolio metrics</strong> (profit factor, expectancy, drawdown) are exclusive to heatmap analytics</li>
<li><strong>Safe math</strong> ensures all calculations handle edge cases gracefully by returning <code>null</code> for unsafe values</li>
<li><strong>Performance metrics</strong> track execution timing separately from trading results</li>
</ol>
<p>All statistics are calculated from closed signals stored in memoized storage instances, with results exposed through typed interfaces for type-safe consumption.</p>
</div></div><div class="col-sidebar"><div class="page-menu"><div class="tsd-navigation settings"><details class="tsd-accordion"><summary class="tsd-accordion-summary"><h3><svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-chevronDown"></use></svg>Settings</h3></summary><div class="tsd-accordion-details"><div class="tsd-filter-visibility"><span class="settings-label">Member Visibility</span><ul id="tsd-filter-options"><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-protected" name="protected"/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Protected</span></label></li><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-inherited" name="inherited" checked/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Inherited</span></label></li><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-external" name="external"/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>External</span></label></li></ul></div><div class="tsd-theme-toggle"><label class="settings-label" for="tsd-theme">Theme</label><select id="tsd-theme"><option value="os">OS</option><option value="light">Light</option><option value="dark">Dark</option></select></div></div></details></div><details open class="tsd-accordion tsd-page-navigation"><summary class="tsd-accordion-summary"><h3><svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-chevronDown"></use></svg>On This Page</h3></summary><div class="tsd-accordion-details"><a href="#statistics-calculation"><span>Statistics <wbr/>Calculation</span></a><ul><li><a href="#purpose-and-scope"><span>Purpose and <wbr/>Scope</span></a></li><li><a href="#statistics-types-overview"><span>Statistics <wbr/>Types <wbr/>Overview</span></a></li><li><a href="#core-metrics"><span>Core <wbr/>Metrics</span></a></li><li><ul><li><a href="#win-rate"><span>Win <wbr/>Rate</span></a></li><li><a href="#average-pnl"><span>Average PNL</span></a></li><li><a href="#total-pnl"><span>Total PNL</span></a></li><li><a href="#standard-deviation"><span>Standard <wbr/>Deviation</span></a></li><li><a href="#sharpe-ratio"><span>Sharpe <wbr/>Ratio</span></a></li><li><a href="#annualized-sharpe-ratio"><span>Annualized <wbr/>Sharpe <wbr/>Ratio</span></a></li><li><a href="#certainty-ratio"><span>Certainty <wbr/>Ratio</span></a></li><li><a href="#expected-yearly-returns"><span>Expected <wbr/>Yearly <wbr/>Returns</span></a></li></ul></li><li><a href="#portfolio-metrics"><span>Portfolio <wbr/>Metrics</span></a></li><li><ul><li><a href="#profit-factor"><span>Profit <wbr/>Factor</span></a></li><li><a href="#expectancy"><span>Expectancy</span></a></li><li><a href="#maximum-drawdown"><span>Maximum <wbr/>Drawdown</span></a></li><li><a href="#winloss-streaks"><span>Win/<wbr/>Loss <wbr/>Streaks</span></a></li></ul></li><li><a href="#safe-math-implementation"><span>Safe <wbr/>Math <wbr/>Implementation</span></a></li><li><a href="#statistics-by-execution-mode"><span>Statistics by <wbr/>Execution <wbr/>Mode</span></a></li><li><a href="#calculation-flow-by-service"><span>Calculation <wbr/>Flow by <wbr/>Service</span></a></li><li><a href="#performance-statistics"><span>Performance <wbr/>Statistics</span></a></li><li><a href="#summary"><span>Summary</span></a></li></ul></div></details></div><div class="site-menu"><nav class="tsd-navigation"><a href="../modules.html">backtest-kit</a><ul class="tsd-small-nested-navigation" id="tsd-nav-container"><li>Loading...</li></ul></nav></div></div></div><footer><p class="tsd-generator">Generated using <a href="https://typedoc.org/" target="_blank">TypeDoc</a></p></footer><div class="overlay"></div></body></html>

<!-- Yandex.Metrika counter -->
<script type="text/javascript">
    (function(m,e,t,r,i,k,a){
        m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
        m[i].l=1*new Date();
        for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }}
        k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)
    })(window, document,'script','https://mc.yandex.ru/metrika/tag.js?id=105455585', 'ym');

    ym(105455585, 'init', {ssr:true, webvisor:true, clickmap:true, ecommerce:"dataLayer", accurateTrackBounce:true, trackLinks:true});
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/105455585" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
<!-- /Yandex.Metrika counter -->

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-3MQZEBBDDR"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-3MQZEBBDDR');
</script>
