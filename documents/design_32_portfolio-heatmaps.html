<!DOCTYPE html><html class="default" lang="en" data-base=".."><head><meta charset="utf-8"/><meta http-equiv="x-ua-compatible" content="IE=edge"/><title>design/32_portfolio-heatmaps | backtest-kit</title><meta name="description" content="Documentation for backtest-kit"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="stylesheet" href="../assets/style.css"/><link rel="stylesheet" href="../assets/highlight.css"/><script defer src="../assets/main.js"></script><script async src="../assets/icons.js" id="tsd-icons-script"></script><script async src="../assets/search.js" id="tsd-search-script"></script><script async src="../assets/navigation.js" id="tsd-nav-script"></script><script async src="../assets/hierarchy.js" id="tsd-hierarchy-script"></script></head><body><script>document.documentElement.dataset.theme = localStorage.getItem("tsd-theme") || "os";document.body.style.display="none";setTimeout(() => app?app.showPage():document.body.style.removeProperty("display"),500)</script><header class="tsd-page-toolbar"><div class="tsd-toolbar-contents container"><div class="table-cell" id="tsd-search"><div class="field"><label for="tsd-search-field" class="tsd-widget tsd-toolbar-icon search no-caption"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-search"></use></svg></label><input type="text" id="tsd-search-field" aria-label="Search"/></div><div class="field"><div id="tsd-toolbar-links"></div></div><ul class="results"><li class="state loading">Preparing search index...</li><li class="state failure">The search index is not available</li></ul><a href="../index.html" class="title">backtest-kit</a></div><div class="table-cell" id="tsd-widgets"><a href="#" class="tsd-widget tsd-toolbar-icon menu no-caption" data-toggle="menu" aria-label="Menu"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-menu"></use></svg></a></div></div></header><div class="container container-main"><div class="col-content"><div class="tsd-page-title"><ul class="tsd-breadcrumb"><li><a href="../modules.html">backtest-kit</a></li><li><a href="design_32_portfolio-heatmaps.html">design/32_portfolio-heatmaps</a></li></ul></div><div class="tsd-panel tsd-typography"><a id="portfolio-heatmaps" class="tsd-anchor"></a><h1 class="tsd-anchor-link">Portfolio Heatmaps<a href="#portfolio-heatmaps" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h1><p>Portfolio heatmaps provide symbol-level performance analysis across all trading strategies. This system aggregates closed signals by trading pair (symbol) and calculates comprehensive statistics for each symbol, enabling portfolio-wide comparison and risk assessment. Unlike per-strategy reports (see <a href="design_31_performance-statistics.html">Performance Statistics</a>), heatmaps focus on symbol-level aggregation, answering questions like &quot;Which symbols perform best across all strategies?&quot; and &quot;What is the portfolio's total exposure per symbol?&quot;.</p>
<p>For individual strategy performance metrics, see <a href="design_31_performance-statistics.html">Performance Statistics</a>. For live trading reports, see <a href="design_29_reporting-and-analytics.html">Reporting and Analytics</a>.</p>
<hr>
<a id="heatmap-data-structure" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Heatmap Data Structure<a href="#heatmap-data-structure" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>The heatmap system uses two primary interfaces: <code>IHeatmapRow</code> for per-symbol statistics and <code>IHeatmapStatistics</code> for portfolio-wide aggregation.</p>
<a id="per-symbol-statistics-iheatmaprow" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Per-Symbol Statistics (IHeatmapRow)<a href="#per-symbol-statistics-iheatmaprow" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Each symbol in the portfolio is represented by an <code>IHeatmapRow</code> containing 17 metrics:</p>
<table>
<thead>
<tr>
<th>Metric</th>
<th>Type</th>
<th>Description</th>
<th>Interpretation</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>symbol</code></td>
<td><code>string</code></td>
<td>Trading pair identifier (e.g., &quot;BTCUSDT&quot;)</td>
<td>Primary key for grouping</td>
</tr>
<tr>
<td><code>totalPnl</code></td>
<td><code>number | null</code></td>
<td>Cumulative profit/loss percentage</td>
<td>Higher is better</td>
</tr>
<tr>
<td><code>sharpeRatio</code></td>
<td><code>number | null</code></td>
<td>Risk-adjusted return (avgPnl / stdDev)</td>
<td>Higher is better</td>
</tr>
<tr>
<td><code>maxDrawdown</code></td>
<td><code>number | null</code></td>
<td>Largest peak-to-trough decline</td>
<td>Lower is better</td>
</tr>
<tr>
<td><code>totalTrades</code></td>
<td><code>number</code></td>
<td>Number of closed trades</td>
<td>Volume indicator</td>
</tr>
<tr>
<td><code>winCount</code></td>
<td><code>number</code></td>
<td>Number of winning trades</td>
<td>Win frequency</td>
</tr>
<tr>
<td><code>lossCount</code></td>
<td><code>number</code></td>
<td>Number of losing trades</td>
<td>Loss frequency</td>
</tr>
<tr>
<td><code>winRate</code></td>
<td><code>number | null</code></td>
<td>Percentage of winning trades (0-100)</td>
<td>Higher is better</td>
</tr>
<tr>
<td><code>avgPnl</code></td>
<td><code>number | null</code></td>
<td>Average profit/loss per trade</td>
<td>Higher is better</td>
</tr>
<tr>
<td><code>stdDev</code></td>
<td><code>number | null</code></td>
<td>Standard deviation of returns</td>
<td>Volatility measure</td>
</tr>
<tr>
<td><code>profitFactor</code></td>
<td><code>number | null</code></td>
<td>Sum of wins / sum of losses</td>
<td>&gt;1 is profitable</td>
</tr>
<tr>
<td><code>avgWin</code></td>
<td><code>number | null</code></td>
<td>Average profit on winning trades</td>
<td>Upside magnitude</td>
</tr>
<tr>
<td><code>avgLoss</code></td>
<td><code>number | null</code></td>
<td>Average loss on losing trades</td>
<td>Downside magnitude</td>
</tr>
<tr>
<td><code>maxWinStreak</code></td>
<td><code>number</code></td>
<td>Maximum consecutive wins</td>
<td>Best streak</td>
</tr>
<tr>
<td><code>maxLossStreak</code></td>
<td><code>number</code></td>
<td>Maximum consecutive losses</td>
<td>Worst streak</td>
</tr>
<tr>
<td><code>expectancy</code></td>
<td><code>number | null</code></td>
<td>(winRate × avgWin) - (lossRate × avgLoss)</td>
<td>Expected return per trade</td>
</tr>
</tbody>
</table>
<p>All percentage-based metrics can be <code>null</code> if calculation is unsafe (division by zero, NaN, Infinity).</p>
<a id="portfolio-wide-statistics-iheatmapstatistics" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Portfolio-Wide Statistics (IHeatmapStatistics)<a href="#portfolio-wide-statistics-iheatmapstatistics" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Portfolio aggregation combines all symbols into summary metrics:</p>
<pre><code class="typescript"><span class="hl-7">interface</span><span class="hl-1"> </span><span class="hl-13">IHeatmapStatistics</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-4">symbols</span><span class="hl-1">: </span><span class="hl-13">IHeatmapRow</span><span class="hl-1">[];           </span><span class="hl-5">// Array of all symbol statistics</span><br/><span class="hl-1">  </span><span class="hl-4">totalSymbols</span><span class="hl-1">: </span><span class="hl-13">number</span><span class="hl-1">;             </span><span class="hl-5">// Count of unique symbols</span><br/><span class="hl-1">  </span><span class="hl-4">portfolioTotalPnl</span><span class="hl-1">: </span><span class="hl-13">number</span><span class="hl-1"> | </span><span class="hl-13">null</span><span class="hl-1">; </span><span class="hl-5">// Sum of all symbol PNLs</span><br/><span class="hl-1">  </span><span class="hl-4">portfolioSharpeRatio</span><span class="hl-1">: </span><span class="hl-13">number</span><span class="hl-1"> | </span><span class="hl-13">null</span><span class="hl-1">; </span><span class="hl-5">// Portfolio-wide Sharpe ratio</span><br/><span class="hl-1">  </span><span class="hl-4">portfolioTotalTrades</span><span class="hl-1">: </span><span class="hl-13">number</span><span class="hl-1">;     </span><span class="hl-5">// Total trades across all symbols</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<hr>
<a id="heatmarkdownservice-architecture" class="tsd-anchor"></a><h2 class="tsd-anchor-link">HeatMarkdownService Architecture<a href="#heatmarkdownservice-architecture" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>The <code>HeatMarkdownService</code> class implements the heatmap generation pipeline using the ReportStorage pattern.</p>
<a id="component-overview" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Component Overview<a href="#component-overview" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><img src="../media/32-portfolio-heatmaps_0.svg" alt="Mermaid Diagram"></p>
<a id="key-classes-and-methods" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Key Classes and Methods<a href="#key-classes-and-methods" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><a id="heatmarkdownservice" class="tsd-anchor"></a><h4 class="tsd-anchor-link">HeatMarkdownService<a href="#heatmarkdownservice" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><p>Located at <a href="">src/lib/services/markdown/HeatMarkdownService.ts:442-596</a>, this service:</p>
<ul>
<li><strong>Subscribes to events</strong>: <code>signalEmitter.subscribe(this.tick)</code> at <a href="">line 582</a></li>
<li><strong>Memoizes storage</strong>: <code>getStorage = memoize&lt;(strategyName: string) =&gt; HeatmapStorage&gt;</code> at <a href="">line 460</a></li>
<li><strong>Filters closed signals</strong>: Only processes <code>action === &quot;closed&quot;</code> at <a href="">line 475</a></li>
<li><strong>Provides public API</strong>: <code>getData()</code>, <code>getReport()</code>, <code>dump()</code>, <code>clear()</code> methods</li>
</ul>
<a id="heatmapstorage" class="tsd-anchor"></a><h4 class="tsd-anchor-link">HeatmapStorage<a href="#heatmapstorage" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><p>Located at <a href="">src/lib/services/markdown/HeatMarkdownService.ts:147-442</a>, this class:</p>
<ul>
<li><strong>Stores signals per symbol</strong>: <code>symbolData: Map&lt;string, IStrategyTickResultClosed[]&gt;</code> at <a href="">line 149</a></li>
<li><strong>Enforces MAX_EVENTS</strong>: Limits to 250 signals per symbol at <a href="">line 141, 165-170</a></li>
<li><strong>Calculates symbol stats</strong>: <code>calculateSymbolStats()</code> at <a href="">line 180-296</a></li>
<li><strong>Aggregates portfolio</strong>: <code>getData()</code> at <a href="">line 305-442</a></li>
</ul>
<hr>
<a id="data-flow-signal-to-heatmap" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Data Flow: Signal to Heatmap<a href="#data-flow-signal-to-heatmap" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>The following diagram shows how closed signals are processed into portfolio heatmap statistics:</p>
<p><img src="../media/32-portfolio-heatmaps_1.svg" alt="Mermaid Diagram"></p>
<hr>
<a id="metric-calculation-details" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Metric Calculation Details<a href="#metric-calculation-details" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><a id="per-symbol-metrics" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Per-Symbol Metrics<a href="#per-symbol-metrics" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>The <code>calculateSymbolStats()</code> method at <a href="">src/lib/services/markdown/HeatMarkdownService.ts:180-296</a> computes all 17 metrics for a single symbol:</p>
<a id="basic-counts" class="tsd-anchor"></a><h4 class="tsd-anchor-link">Basic Counts<a href="#basic-counts" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><pre><code><span class="hl-4">totalTrades</span><span class="hl-1"> = </span><span class="hl-4">signals</span><span class="hl-1">.</span><span class="hl-4">length</span><br/><span class="hl-4">winCount</span><span class="hl-1"> = </span><span class="hl-4">signals</span><span class="hl-1">.</span><span class="hl-0">filter</span><span class="hl-1">(</span><span class="hl-4">s</span><span class="hl-1"> </span><span class="hl-7">=&gt;</span><span class="hl-1"> </span><span class="hl-4">s</span><span class="hl-1">.</span><span class="hl-4">pnl</span><span class="hl-1">.</span><span class="hl-4">pnlPercentage</span><span class="hl-1"> &gt; </span><span class="hl-6">0</span><span class="hl-1">).</span><span class="hl-4">length</span><br/><span class="hl-4">lossCount</span><span class="hl-1"> = </span><span class="hl-4">signals</span><span class="hl-1">.</span><span class="hl-0">filter</span><span class="hl-1">(</span><span class="hl-4">s</span><span class="hl-1"> </span><span class="hl-7">=&gt;</span><span class="hl-1"> </span><span class="hl-4">s</span><span class="hl-1">.</span><span class="hl-4">pnl</span><span class="hl-1">.</span><span class="hl-4">pnlPercentage</span><span class="hl-1"> &lt; </span><span class="hl-6">0</span><span class="hl-1">).</span><span class="hl-4">length</span>
</code><button>Copy</button></pre>

<a id="win-rate-and-pnl" class="tsd-anchor"></a><h4 class="tsd-anchor-link">Win Rate and PNL<a href="#win-rate-and-pnl" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><pre><code><span class="hl-4">winRate</span><span class="hl-1"> = (</span><span class="hl-4">winCount</span><span class="hl-1"> / </span><span class="hl-4">totalTrades</span><span class="hl-1">) × </span><span class="hl-6">100</span><br/><span class="hl-4">totalPnl</span><span class="hl-1"> = </span><span class="hl-0">sum</span><span class="hl-1">(</span><span class="hl-4">signals</span><span class="hl-1">.</span><span class="hl-0">map</span><span class="hl-1">(</span><span class="hl-4">s</span><span class="hl-1"> </span><span class="hl-7">=&gt;</span><span class="hl-1"> </span><span class="hl-4">s</span><span class="hl-1">.</span><span class="hl-4">pnl</span><span class="hl-1">.</span><span class="hl-4">pnlPercentage</span><span class="hl-1">))</span><br/><span class="hl-4">avgPnl</span><span class="hl-1"> = </span><span class="hl-4">totalPnl</span><span class="hl-1"> / </span><span class="hl-4">totalTrades</span>
</code><button>Copy</button></pre>

<a id="risk-metrics" class="tsd-anchor"></a><h4 class="tsd-anchor-link">Risk Metrics<a href="#risk-metrics" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><pre><code><span class="hl-4">variance</span><span class="hl-1"> = </span><span class="hl-0">sum</span><span class="hl-1">((</span><span class="hl-4">pnl</span><span class="hl-1"> - </span><span class="hl-4">avgPnl</span><span class="hl-1">)²) / </span><span class="hl-4">totalTrades</span><br/><span class="hl-4">stdDev</span><span class="hl-1"> = </span><span class="hl-0">sqrt</span><span class="hl-1">(</span><span class="hl-4">variance</span><span class="hl-1">)</span><br/><span class="hl-4">sharpeRatio</span><span class="hl-1"> = </span><span class="hl-4">avgPnl</span><span class="hl-1"> / </span><span class="hl-0">stdDev</span><span class="hl-1">  (</span><span class="hl-4">if</span><span class="hl-1"> </span><span class="hl-4">stdDev</span><span class="hl-1"> &gt; </span><span class="hl-6">0</span><span class="hl-1">)</span>
</code><button>Copy</button></pre>

<a id="profit-factor" class="tsd-anchor"></a><h4 class="tsd-anchor-link">Profit Factor<a href="#profit-factor" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><pre><code><span class="hl-4">sumWins</span><span class="hl-1"> = </span><span class="hl-0">sum</span><span class="hl-1">(</span><span class="hl-4">winning</span><span class="hl-1"> </span><span class="hl-4">trades</span><span class="hl-1"> </span><span class="hl-8">PNL</span><span class="hl-1">)</span><br/><span class="hl-4">sumLosses</span><span class="hl-1"> = </span><span class="hl-0">sum</span><span class="hl-1">(</span><span class="hl-4">losing</span><span class="hl-1"> </span><span class="hl-4">trades</span><span class="hl-1"> </span><span class="hl-8">PNL</span><span class="hl-1">)  </span><span class="hl-5">// Negative value</span><br/><span class="hl-4">profitFactor</span><span class="hl-1"> = </span><span class="hl-4">sumWins</span><span class="hl-1"> / </span><span class="hl-0">abs</span><span class="hl-1">(</span><span class="hl-4">sumLosses</span><span class="hl-1">)  (</span><span class="hl-4">if</span><span class="hl-1"> </span><span class="hl-4">sumLosses</span><span class="hl-1"> &lt; </span><span class="hl-6">0</span><span class="hl-1">)</span>
</code><button>Copy</button></pre>

<a id="drawdown-calculation" class="tsd-anchor"></a><h4 class="tsd-anchor-link">Drawdown Calculation<a href="#drawdown-calculation" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><p>Maximum drawdown tracks the largest peak-to-trough decline:</p>
<pre><code><span class="hl-4">peakEquity</span><span class="hl-1"> = </span><span class="hl-6">0</span><br/><span class="hl-4">currentEquity</span><span class="hl-1"> = </span><span class="hl-6">0</span><br/><span class="hl-4">maxDrawdown</span><span class="hl-1"> = </span><span class="hl-6">0</span><br/><br/><span class="hl-4">for</span><span class="hl-1"> </span><span class="hl-4">each</span><span class="hl-1"> </span><span class="hl-4">signal</span><span class="hl-1"> </span><span class="hl-7">in</span><span class="hl-1"> </span><span class="hl-4">chronological</span><span class="hl-1"> </span><span class="hl-10">order</span><span class="hl-1">:</span><br/><span class="hl-1">  </span><span class="hl-4">currentEquity</span><span class="hl-1"> += </span><span class="hl-4">signal</span><span class="hl-1">.</span><span class="hl-4">pnl</span><span class="hl-1">.</span><span class="hl-4">pnlPercentage</span><br/><span class="hl-1">  </span><span class="hl-3">if</span><span class="hl-1"> </span><span class="hl-4">currentEquity</span><span class="hl-1"> &gt; </span><span class="hl-10">peakEquity</span><span class="hl-1">:</span><br/><span class="hl-1">    </span><span class="hl-4">peakEquity</span><span class="hl-1"> = </span><span class="hl-4">currentEquity</span><br/><span class="hl-1">  </span><span class="hl-4">drawdown</span><span class="hl-1"> = </span><span class="hl-4">peakEquity</span><span class="hl-1"> - </span><span class="hl-4">currentEquity</span><br/><span class="hl-1">  </span><span class="hl-3">if</span><span class="hl-1"> </span><span class="hl-4">drawdown</span><span class="hl-1"> &gt; </span><span class="hl-10">maxDrawdown</span><span class="hl-1">:</span><br/><span class="hl-1">    </span><span class="hl-4">maxDrawdown</span><span class="hl-1"> = </span><span class="hl-4">drawdown</span>
</code><button>Copy</button></pre>

<p>Implemented at <a href="">src/lib/services/markdown/HeatMarkdownService.ts:248-262</a>.</p>
<a id="winloss-streaks" class="tsd-anchor"></a><h4 class="tsd-anchor-link">Win/Loss Streaks<a href="#winloss-streaks" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><p>Consecutive win/loss tracking:</p>
<pre><code><span class="hl-4">currentWinStreak</span><span class="hl-1"> = </span><span class="hl-6">0</span><br/><span class="hl-4">currentLossStreak</span><span class="hl-1"> = </span><span class="hl-6">0</span><br/><span class="hl-4">maxWinStreak</span><span class="hl-1"> = </span><span class="hl-6">0</span><br/><span class="hl-4">maxLossStreak</span><span class="hl-1"> = </span><span class="hl-6">0</span><br/><br/><span class="hl-4">for</span><span class="hl-1"> </span><span class="hl-4">each</span><span class="hl-1"> </span><span class="hl-10">signal</span><span class="hl-1">:</span><br/><span class="hl-1">  </span><span class="hl-3">if</span><span class="hl-1"> </span><span class="hl-4">signal</span><span class="hl-1">.</span><span class="hl-4">pnl</span><span class="hl-1"> &gt; </span><span class="hl-6">0</span><span class="hl-1">:</span><br/><span class="hl-1">    </span><span class="hl-4">currentWinStreak</span><span class="hl-1">++</span><br/><span class="hl-1">    </span><span class="hl-4">currentLossStreak</span><span class="hl-1"> = </span><span class="hl-6">0</span><br/><span class="hl-1">    </span><span class="hl-4">maxWinStreak</span><span class="hl-1"> = </span><span class="hl-0">max</span><span class="hl-1">(</span><span class="hl-4">maxWinStreak</span><span class="hl-1">, </span><span class="hl-4">currentWinStreak</span><span class="hl-1">)</span><br/><span class="hl-1">  </span><span class="hl-3">else</span><span class="hl-1"> </span><span class="hl-3">if</span><span class="hl-1"> </span><span class="hl-4">signal</span><span class="hl-1">.</span><span class="hl-4">pnl</span><span class="hl-1"> &lt; </span><span class="hl-6">0</span><span class="hl-1">:</span><br/><span class="hl-1">    </span><span class="hl-4">currentLossStreak</span><span class="hl-1">++</span><br/><span class="hl-1">    </span><span class="hl-4">currentWinStreak</span><span class="hl-1"> = </span><span class="hl-6">0</span><br/><span class="hl-1">    </span><span class="hl-4">maxLossStreak</span><span class="hl-1"> = </span><span class="hl-0">max</span><span class="hl-1">(</span><span class="hl-4">maxLossStreak</span><span class="hl-1">, </span><span class="hl-4">currentLossStreak</span><span class="hl-1">)</span>
</code><button>Copy</button></pre>

<p>Implemented at <a href="">src/lib/services/markdown/HeatMarkdownService.ts:264-281</a>.</p>
<a id="expectancy" class="tsd-anchor"></a><h4 class="tsd-anchor-link">Expectancy<a href="#expectancy" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><p>Expected return per trade:</p>
<pre><code><span class="hl-4">lossRate</span><span class="hl-1"> = </span><span class="hl-6">100</span><span class="hl-1"> - </span><span class="hl-4">winRate</span><br/><span class="hl-4">expectancy</span><span class="hl-1"> = (</span><span class="hl-4">winRate</span><span class="hl-1"> / </span><span class="hl-6">100</span><span class="hl-1">) × </span><span class="hl-4">avgWin</span><span class="hl-1"> - (</span><span class="hl-4">lossRate</span><span class="hl-1"> / </span><span class="hl-6">100</span><span class="hl-1">) × </span><span class="hl-0">abs</span><span class="hl-1">(</span><span class="hl-4">avgLoss</span><span class="hl-1">)</span>
</code><button>Copy</button></pre>

<p>Implemented at <a href="">src/lib/services/markdown/HeatMarkdownService.ts:283-291</a>.</p>
<a id="portfolio-wide-metrics" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Portfolio-Wide Metrics<a href="#portfolio-wide-metrics" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>The <code>getData()</code> method at <a href="">src/lib/services/markdown/HeatMarkdownService.ts:305-442</a> aggregates symbol statistics into portfolio metrics:</p>
<a id="portfolio-total-pnl" class="tsd-anchor"></a><h4 class="tsd-anchor-link">Portfolio Total PNL<a href="#portfolio-total-pnl" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><p>Sum of all symbol PNLs:</p>
<pre><code><span class="hl-4">portfolioTotalPnl</span><span class="hl-1"> = </span><span class="hl-4">symbols</span><span class="hl-1">.</span><span class="hl-0">reduce</span><span class="hl-1">((</span><span class="hl-4">sum</span><span class="hl-1">, </span><span class="hl-4">row</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> </span><br/><span class="hl-1">  </span><span class="hl-4">sum</span><span class="hl-1"> + (</span><span class="hl-4">row</span><span class="hl-1">.</span><span class="hl-4">totalPnl</span><span class="hl-1"> ?? </span><span class="hl-6">0</span><span class="hl-1">), </span><span class="hl-6">0</span><br/><span class="hl-1">)</span>
</code><button>Copy</button></pre>

<p>Implemented at <a href="">src/lib/services/markdown/HeatMarkdownService.ts:373-379</a>.</p>
<a id="portfolio-sharpe-ratio" class="tsd-anchor"></a><h4 class="tsd-anchor-link">Portfolio Sharpe Ratio<a href="#portfolio-sharpe-ratio" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><p>Portfolio-level risk-adjusted return:</p>
<pre><code><span class="hl-5">// Collect all individual trade PNLs across all symbols</span><br/><span class="hl-4">allPnls</span><span class="hl-1"> = []</span><br/><span class="hl-4">for</span><span class="hl-1"> </span><span class="hl-4">each</span><span class="hl-1"> </span><span class="hl-10">symbol</span><span class="hl-1">:</span><br/><span class="hl-1">  </span><span class="hl-4">for</span><span class="hl-1"> </span><span class="hl-4">each</span><span class="hl-1"> </span><span class="hl-4">signal</span><span class="hl-1"> </span><span class="hl-7">in</span><span class="hl-1"> </span><span class="hl-10">symbol</span><span class="hl-1">:</span><br/><span class="hl-1">    </span><span class="hl-4">allPnls</span><span class="hl-1">.</span><span class="hl-0">push</span><span class="hl-1">(</span><span class="hl-4">signal</span><span class="hl-1">.</span><span class="hl-4">pnl</span><span class="hl-1">.</span><span class="hl-4">pnlPercentage</span><span class="hl-1">)</span><br/><br/><span class="hl-5">// Calculate portfolio-level statistics</span><br/><span class="hl-4">portfolioAvgPnl</span><span class="hl-1"> = </span><span class="hl-0">sum</span><span class="hl-1">(</span><span class="hl-4">allPnls</span><span class="hl-1">) / </span><span class="hl-4">allPnls</span><span class="hl-1">.</span><span class="hl-4">length</span><br/><span class="hl-4">portfolioVariance</span><span class="hl-1"> = </span><span class="hl-0">sum</span><span class="hl-1">((</span><span class="hl-4">pnl</span><span class="hl-1"> - </span><span class="hl-4">portfolioAvgPnl</span><span class="hl-1">)²) / </span><span class="hl-4">allPnls</span><span class="hl-1">.</span><span class="hl-4">length</span><br/><span class="hl-4">portfolioStdDev</span><span class="hl-1"> = </span><span class="hl-0">sqrt</span><span class="hl-1">(</span><span class="hl-4">portfolioVariance</span><span class="hl-1">)</span><br/><span class="hl-4">portfolioSharpeRatio</span><span class="hl-1"> = </span><span class="hl-4">portfolioAvgPnl</span><span class="hl-1"> / </span><span class="hl-4">portfolioStdDev</span>
</code><button>Copy</button></pre>

<p>Implemented at <a href="">src/lib/services/markdown/HeatMarkdownService.ts:381-407</a>.</p>
<a id="portfolio-total-trades" class="tsd-anchor"></a><h4 class="tsd-anchor-link">Portfolio Total Trades<a href="#portfolio-total-trades" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><p>Count of all closed trades:</p>
<pre><code><span class="hl-4">portfolioTotalTrades</span><span class="hl-1"> = </span><span class="hl-4">symbols</span><span class="hl-1">.</span><span class="hl-0">reduce</span><span class="hl-1">((</span><span class="hl-4">sum</span><span class="hl-1">, </span><span class="hl-4">row</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> </span><br/><span class="hl-1">  </span><span class="hl-4">sum</span><span class="hl-1"> + </span><span class="hl-4">row</span><span class="hl-1">.</span><span class="hl-4">totalTrades</span><span class="hl-1">, </span><span class="hl-6">0</span><br/><span class="hl-1">)</span>
</code><button>Copy</button></pre>

<p>Implemented at <a href="">src/lib/services/markdown/HeatMarkdownService.ts:410-411</a>.</p>
<hr>
<a id="heat-facade-api" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Heat Facade API<a href="#heat-facade-api" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>The <code>Heat</code> class at <a href="">src/classes/Heat.ts</a> provides a simplified public API for accessing heatmap data. All methods delegate to <code>HeatMarkdownService</code> via dependency injection.</p>
<a id="api-methods" class="tsd-anchor"></a><h3 class="tsd-anchor-link">API Methods<a href="#api-methods" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><img src="../media/32-portfolio-heatmaps_2.svg" alt="Mermaid Diagram"></p>
<a id="method-details" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Method Details<a href="#method-details" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><a id="getdatastrategyname-string-promise" class="tsd-anchor"></a><h4 class="tsd-anchor-link">getData(strategyName: string): Promise&lt;IHeatmapStatistics&gt;<a href="#getdatastrategyname-string-promise" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><p>Returns raw heatmap statistics for programmatic access. Useful for custom analysis or visualization.</p>
<pre><code class="typescript"><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">stats</span><span class="hl-1"> = </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-4">Heat</span><span class="hl-1">.</span><span class="hl-0">getData</span><span class="hl-1">(</span><span class="hl-2">&quot;my-strategy&quot;</span><span class="hl-1">);</span><br/><br/><span class="hl-4">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-2">`Portfolio total PNL: </span><span class="hl-7">${</span><span class="hl-4">stats</span><span class="hl-9">.</span><span class="hl-4">portfolioTotalPnl</span><span class="hl-7">}</span><span class="hl-2">%`</span><span class="hl-1">);</span><br/><span class="hl-4">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-2">`Portfolio Sharpe: </span><span class="hl-7">${</span><span class="hl-4">stats</span><span class="hl-9">.</span><span class="hl-4">portfolioSharpeRatio</span><span class="hl-7">}</span><span class="hl-2">`</span><span class="hl-1">);</span><br/><span class="hl-4">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-2">`Symbols tracked: </span><span class="hl-7">${</span><span class="hl-4">stats</span><span class="hl-9">.</span><span class="hl-4">totalSymbols</span><span class="hl-7">}</span><span class="hl-2">`</span><span class="hl-1">);</span><br/><br/><span class="hl-5">// Find best performing symbol</span><br/><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">bestSymbol</span><span class="hl-1"> = </span><span class="hl-4">stats</span><span class="hl-1">.</span><span class="hl-4">symbols</span><span class="hl-1">.</span><span class="hl-0">reduce</span><span class="hl-1">((</span><span class="hl-4">best</span><span class="hl-1">, </span><span class="hl-4">current</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> </span><br/><span class="hl-1">  (</span><span class="hl-4">current</span><span class="hl-1">.</span><span class="hl-4">totalPnl</span><span class="hl-1"> ?? -</span><span class="hl-7">Infinity</span><span class="hl-1">) &gt; (</span><span class="hl-4">best</span><span class="hl-1">.</span><span class="hl-4">totalPnl</span><span class="hl-1"> ?? -</span><span class="hl-7">Infinity</span><span class="hl-1">) ? </span><span class="hl-4">current</span><span class="hl-1"> : </span><span class="hl-4">best</span><br/><span class="hl-1">);</span><br/><span class="hl-4">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-2">`Best symbol: </span><span class="hl-7">${</span><span class="hl-4">bestSymbol</span><span class="hl-9">.</span><span class="hl-4">symbol</span><span class="hl-7">}</span><span class="hl-2"> (</span><span class="hl-7">${</span><span class="hl-4">bestSymbol</span><span class="hl-9">.</span><span class="hl-4">totalPnl</span><span class="hl-7">}</span><span class="hl-2">%)`</span><span class="hl-1">);</span>
</code><button type="button">Copy</button></pre>

<p>Implemented at <a href="">src/lib/services/markdown/HeatMarkdownService.ts:505-531</a>.</p>
<a id="getreportstrategyname-string-promise" class="tsd-anchor"></a><h4 class="tsd-anchor-link">getReport(strategyName: string): Promise&lt;string&gt;<a href="#getreportstrategyname-string-promise" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><p>Generates a markdown-formatted report with two tables:</p>
<ol>
<li><strong>Symbol Comparison Table</strong>: All symbols sorted by totalPnl (descending)</li>
<li><strong>Portfolio Summary</strong>: Aggregated metrics</li>
</ol>
<pre><code class="typescript"><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">markdown</span><span class="hl-1"> = </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-4">Heat</span><span class="hl-1">.</span><span class="hl-0">getReport</span><span class="hl-1">(</span><span class="hl-2">&quot;my-strategy&quot;</span><span class="hl-1">);</span><br/><span class="hl-4">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-4">markdown</span><span class="hl-1">);</span>
</code><button type="button">Copy</button></pre>

<p>Report format at <a href="">src/lib/services/markdown/HeatMarkdownService.ts:345-442</a>:</p>
<ul>
<li>Header with strategy name</li>
<li>Symbol comparison table with 12 columns</li>
<li>Portfolio summary section</li>
<li>Bottom notes explaining metrics</li>
</ul>
<a id="dumpstrategyname-string-path-string-promise" class="tsd-anchor"></a><h4 class="tsd-anchor-link">dump(strategyName: string, path?: string): Promise&lt;void&gt;<a href="#dumpstrategyname-string-path-string-promise" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><p>Saves the markdown report to disk. Default path: <code>./dump/heat/{strategyName}.md</code>.</p>
<pre><code class="typescript"><span class="hl-5">// Save to default location</span><br/><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-4">Heat</span><span class="hl-1">.</span><span class="hl-0">dump</span><span class="hl-1">(</span><span class="hl-2">&quot;my-strategy&quot;</span><span class="hl-1">);</span><br/><span class="hl-5">// Saved to: ./dump/heat/my-strategy.md</span><br/><br/><span class="hl-5">// Save to custom location</span><br/><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-4">Heat</span><span class="hl-1">.</span><span class="hl-0">dump</span><span class="hl-1">(</span><span class="hl-2">&quot;my-strategy&quot;</span><span class="hl-1">, </span><span class="hl-2">&quot;./reports/portfolio&quot;</span><span class="hl-1">);</span><br/><span class="hl-5">// Saved to: ./reports/portfolio/my-strategy.md</span>
</code><button type="button">Copy</button></pre>

<p>Implemented at <a href="">src/lib/services/markdown/HeatMarkdownService.ts:543-569</a>.</p>
<a id="clearstrategyname-string-promise" class="tsd-anchor"></a><h4 class="tsd-anchor-link">clear(strategyName?: string): Promise&lt;void&gt;<a href="#clearstrategyname-string-promise" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><p>Clears accumulated data from memory. If <code>strategyName</code> provided, clears only that strategy's data. Otherwise, clears all strategies.</p>
<pre><code class="typescript"><span class="hl-5">// Clear specific strategy</span><br/><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-4">Heat</span><span class="hl-1">.</span><span class="hl-0">clear</span><span class="hl-1">(</span><span class="hl-2">&quot;my-strategy&quot;</span><span class="hl-1">);</span><br/><br/><span class="hl-5">// Clear all strategies</span><br/><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-4">Heat</span><span class="hl-1">.</span><span class="hl-0">clear</span><span class="hl-1">();</span>
</code><button type="button">Copy</button></pre>

<p>Implemented at <a href="">src/lib/services/markdown/HeatMarkdownService.ts:571-578</a>.</p>
<hr>
<a id="report-format" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Report Format<a href="#report-format" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>The markdown report generated by <code>getReport()</code> includes a symbol comparison table and portfolio summary.</p>
<a id="symbol-comparison-table" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Symbol Comparison Table<a href="#symbol-comparison-table" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Columns (12 total):</p>
<table>
<thead>
<tr>
<th>Column</th>
<th>Label</th>
<th>Format</th>
<th>Source</th>
</tr>
</thead>
<tbody>
<tr>
<td>Symbol</td>
<td>&quot;Symbol&quot;</td>
<td><code>symbol</code></td>
<td><a href="">line 59-62</a></td>
</tr>
<tr>
<td>Total PNL</td>
<td>&quot;Total PNL&quot;</td>
<td><code>+X.XX%</code> or <code>N/A</code></td>
<td><a href="">line 64-68</a></td>
</tr>
<tr>
<td>Sharpe</td>
<td>&quot;Sharpe&quot;</td>
<td><code>X.XX</code> or <code>N/A</code></td>
<td><a href="">line 70-75</a></td>
</tr>
<tr>
<td>PF</td>
<td>&quot;PF&quot;</td>
<td><code>X.XX</code> or <code>N/A</code></td>
<td><a href="">line 77-82</a></td>
</tr>
<tr>
<td>Expect</td>
<td>&quot;Expect&quot;</td>
<td><code>+X.XX%</code> or <code>N/A</code></td>
<td><a href="">line 84-89</a></td>
</tr>
<tr>
<td>WR</td>
<td>&quot;WR&quot;</td>
<td><code>XX.X%</code> or <code>N/A</code></td>
<td><a href="">line 91-96</a></td>
</tr>
<tr>
<td>Avg Win</td>
<td>&quot;Avg Win&quot;</td>
<td><code>+X.XX%</code> or <code>N/A</code></td>
<td><a href="">line 98-103</a></td>
</tr>
<tr>
<td>Avg Loss</td>
<td>&quot;Avg Loss&quot;</td>
<td><code>-X.XX%</code> or <code>N/A</code></td>
<td><a href="">line 105-110</a></td>
</tr>
<tr>
<td>Max DD</td>
<td>&quot;Max DD&quot;</td>
<td><code>XX.XX%</code> or <code>N/A</code></td>
<td><a href="">line 112-117</a></td>
</tr>
<tr>
<td>W Streak</td>
<td>&quot;W Streak&quot;</td>
<td><code>N</code></td>
<td><a href="">line 119-124</a></td>
</tr>
<tr>
<td>L Streak</td>
<td>&quot;L Streak&quot;</td>
<td><code>N</code></td>
<td><a href="">line 126-131</a></td>
</tr>
<tr>
<td>Trades</td>
<td>&quot;Trades&quot;</td>
<td><code>N</code></td>
<td><a href="">line 133-138</a></td>
</tr>
</tbody>
</table>
<p>Sorting: Symbols are sorted by <code>totalPnl</code> in descending order (best first) at <a href="">line 423</a>.</p>
<a id="portfolio-summary-section" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Portfolio Summary Section<a href="#portfolio-summary-section" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Appears after the table at <a href="">line 432-436</a>:</p>
<pre><code><span class="hl-1">**</span><span class="hl-4">Total</span><span class="hl-1"> </span><span class="hl-10">Symbols</span><span class="hl-1">:** </span><span class="hl-6">5</span><br/><span class="hl-1">**</span><span class="hl-4">Portfolio</span><span class="hl-1"> </span><span class="hl-4">Total</span><span class="hl-1"> </span><span class="hl-10">PNL</span><span class="hl-1">:** +</span><span class="hl-6">42.50</span><span class="hl-1">%</span><br/><span class="hl-1">**</span><span class="hl-4">Portfolio</span><span class="hl-1"> </span><span class="hl-4">Sharpe</span><span class="hl-1"> </span><span class="hl-10">Ratio</span><span class="hl-1">:** </span><span class="hl-6">1.85</span><br/><span class="hl-1">**</span><span class="hl-4">Portfolio</span><span class="hl-1"> </span><span class="hl-4">Total</span><span class="hl-1"> </span><span class="hl-10">Trades</span><span class="hl-1">:** </span><span class="hl-6">127</span>
</code><button>Copy</button></pre>

<hr>
<a id="usage-examples" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Usage Examples<a href="#usage-examples" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><a id="basic-backtest-heatmap" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Basic Backtest Heatmap<a href="#basic-backtest-heatmap" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Run multiple backtests on different symbols, then view portfolio heatmap:</p>
<pre><code class="typescript"><span class="hl-3">import</span><span class="hl-1"> { </span><span class="hl-4">addStrategy</span><span class="hl-1">, </span><span class="hl-4">addExchange</span><span class="hl-1">, </span><span class="hl-4">addFrame</span><span class="hl-1">, </span><span class="hl-4">Backtest</span><span class="hl-1">, </span><span class="hl-4">Heat</span><span class="hl-1"> } </span><span class="hl-3">from</span><span class="hl-1"> </span><span class="hl-2">&quot;backtest-kit&quot;</span><span class="hl-1">;</span><br/><br/><span class="hl-5">// Register strategy, exchange, frame (omitted for brevity)</span><br/><span class="hl-5">// ...</span><br/><br/><span class="hl-5">// Run backtests on multiple symbols</span><br/><span class="hl-3">for</span><span class="hl-1"> </span><span class="hl-3">await</span><span class="hl-1"> (</span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">_</span><span class="hl-1"> </span><span class="hl-7">of</span><span class="hl-1"> </span><span class="hl-4">Backtest</span><span class="hl-1">.</span><span class="hl-0">run</span><span class="hl-1">(</span><span class="hl-2">&quot;BTCUSDT&quot;</span><span class="hl-1">, {</span><br/><span class="hl-1">  </span><span class="hl-4">strategyName:</span><span class="hl-1"> </span><span class="hl-2">&quot;trend-follow&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">exchangeName:</span><span class="hl-1"> </span><span class="hl-2">&quot;binance&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">frameName:</span><span class="hl-1"> </span><span class="hl-2">&quot;30d-test&quot;</span><br/><span class="hl-1">})) {}</span><br/><br/><span class="hl-3">for</span><span class="hl-1"> </span><span class="hl-3">await</span><span class="hl-1"> (</span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">_</span><span class="hl-1"> </span><span class="hl-7">of</span><span class="hl-1"> </span><span class="hl-4">Backtest</span><span class="hl-1">.</span><span class="hl-0">run</span><span class="hl-1">(</span><span class="hl-2">&quot;ETHUSDT&quot;</span><span class="hl-1">, {</span><br/><span class="hl-1">  </span><span class="hl-4">strategyName:</span><span class="hl-1"> </span><span class="hl-2">&quot;trend-follow&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">exchangeName:</span><span class="hl-1"> </span><span class="hl-2">&quot;binance&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">frameName:</span><span class="hl-1"> </span><span class="hl-2">&quot;30d-test&quot;</span><br/><span class="hl-1">})) {}</span><br/><br/><span class="hl-5">// Get heatmap data</span><br/><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">stats</span><span class="hl-1"> = </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-4">Heat</span><span class="hl-1">.</span><span class="hl-0">getData</span><span class="hl-1">(</span><span class="hl-2">&quot;trend-follow&quot;</span><span class="hl-1">);</span><br/><br/><span class="hl-4">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-2">`Portfolio: </span><span class="hl-7">${</span><span class="hl-4">stats</span><span class="hl-9">.</span><span class="hl-4">portfolioTotalPnl</span><span class="hl-7">}</span><span class="hl-2">% PNL`</span><span class="hl-1">);</span><br/><span class="hl-4">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-2">`Best symbol: </span><span class="hl-7">${</span><span class="hl-4">stats</span><span class="hl-9">.</span><span class="hl-4">symbols</span><span class="hl-9">[</span><span class="hl-6">0</span><span class="hl-9">].</span><span class="hl-4">symbol</span><span class="hl-7">}</span><span class="hl-2">`</span><span class="hl-1">);</span><br/><br/><span class="hl-5">// Save report</span><br/><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-4">Heat</span><span class="hl-1">.</span><span class="hl-0">dump</span><span class="hl-1">(</span><span class="hl-2">&quot;trend-follow&quot;</span><span class="hl-1">);</span>
</code><button type="button">Copy</button></pre>

<a id="multi-symbol-portfolio-analysis" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Multi-Symbol Portfolio Analysis<a href="#multi-symbol-portfolio-analysis" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Analyze portfolio distribution and risk:</p>
<pre><code class="typescript"><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">stats</span><span class="hl-1"> = </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-4">Heat</span><span class="hl-1">.</span><span class="hl-0">getData</span><span class="hl-1">(</span><span class="hl-2">&quot;my-portfolio-strategy&quot;</span><span class="hl-1">);</span><br/><br/><span class="hl-5">// Find high-risk symbols (high std dev, low Sharpe)</span><br/><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">riskySymbols</span><span class="hl-1"> = </span><span class="hl-4">stats</span><span class="hl-1">.</span><span class="hl-4">symbols</span><span class="hl-1">.</span><span class="hl-0">filter</span><span class="hl-1">(</span><span class="hl-4">row</span><span class="hl-1"> </span><span class="hl-7">=&gt;</span><span class="hl-1"> </span><br/><span class="hl-1">  (</span><span class="hl-4">row</span><span class="hl-1">.</span><span class="hl-4">sharpeRatio</span><span class="hl-1"> ?? </span><span class="hl-6">0</span><span class="hl-1">) &lt; </span><span class="hl-6">1.0</span><span class="hl-1"> &amp;&amp; </span><br/><span class="hl-1">  (</span><span class="hl-4">row</span><span class="hl-1">.</span><span class="hl-4">stdDev</span><span class="hl-1"> ?? </span><span class="hl-6">0</span><span class="hl-1">) &gt; </span><span class="hl-6">5.0</span><br/><span class="hl-1">);</span><br/><br/><span class="hl-4">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-2">&quot;High-risk symbols:&quot;</span><span class="hl-1">, </span><span class="hl-4">riskySymbols</span><span class="hl-1">.</span><span class="hl-0">map</span><span class="hl-1">(</span><span class="hl-4">s</span><span class="hl-1"> </span><span class="hl-7">=&gt;</span><span class="hl-1"> </span><span class="hl-4">s</span><span class="hl-1">.</span><span class="hl-4">symbol</span><span class="hl-1">));</span><br/><br/><span class="hl-5">// Find symbols with large drawdowns</span><br/><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">highDrawdown</span><span class="hl-1"> = </span><span class="hl-4">stats</span><span class="hl-1">.</span><span class="hl-4">symbols</span><span class="hl-1">.</span><span class="hl-0">filter</span><span class="hl-1">(</span><span class="hl-4">row</span><span class="hl-1"> </span><span class="hl-7">=&gt;</span><br/><span class="hl-1">  (</span><span class="hl-4">row</span><span class="hl-1">.</span><span class="hl-4">maxDrawdown</span><span class="hl-1"> ?? </span><span class="hl-6">0</span><span class="hl-1">) &gt; </span><span class="hl-6">10.0</span><br/><span class="hl-1">);</span><br/><br/><span class="hl-4">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-2">&quot;Symbols with &gt;10% drawdown:&quot;</span><span class="hl-1">, </span><br/><span class="hl-1">  </span><span class="hl-4">highDrawdown</span><span class="hl-1">.</span><span class="hl-0">map</span><span class="hl-1">(</span><span class="hl-4">s</span><span class="hl-1"> </span><span class="hl-7">=&gt;</span><span class="hl-1"> </span><span class="hl-2">`</span><span class="hl-7">${</span><span class="hl-4">s</span><span class="hl-9">.</span><span class="hl-4">symbol</span><span class="hl-7">}</span><span class="hl-2">: </span><span class="hl-7">${</span><span class="hl-4">s</span><span class="hl-9">.</span><span class="hl-4">maxDrawdown</span><span class="hl-7">}</span><span class="hl-2">%`</span><span class="hl-1">)</span><br/><span class="hl-1">);</span><br/><br/><span class="hl-5">// Calculate portfolio concentration</span><br/><span class="hl-4">stats</span><span class="hl-1">.</span><span class="hl-4">symbols</span><span class="hl-1">.</span><span class="hl-0">forEach</span><span class="hl-1">(</span><span class="hl-4">row</span><span class="hl-1"> </span><span class="hl-7">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">concentration</span><span class="hl-1"> = (</span><span class="hl-4">row</span><span class="hl-1">.</span><span class="hl-4">totalTrades</span><span class="hl-1"> / </span><span class="hl-4">stats</span><span class="hl-1">.</span><span class="hl-4">portfolioTotalTrades</span><span class="hl-1">) * </span><span class="hl-6">100</span><span class="hl-1">;</span><br/><span class="hl-1">  </span><span class="hl-4">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-2">`</span><span class="hl-7">${</span><span class="hl-4">row</span><span class="hl-9">.</span><span class="hl-4">symbol</span><span class="hl-7">}</span><span class="hl-2">: </span><span class="hl-7">${</span><span class="hl-4">concentration</span><span class="hl-9">.</span><span class="hl-0">toFixed</span><span class="hl-9">(</span><span class="hl-6">1</span><span class="hl-9">)</span><span class="hl-7">}</span><span class="hl-2">% of trades`</span><span class="hl-1">);</span><br/><span class="hl-1">});</span>
</code><button type="button">Copy</button></pre>

<a id="live-trading-portfolio-monitoring" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Live Trading Portfolio Monitoring<a href="#live-trading-portfolio-monitoring" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Track portfolio performance in real-time:</p>
<pre><code class="typescript"><span class="hl-3">import</span><span class="hl-1"> { </span><span class="hl-4">Live</span><span class="hl-1">, </span><span class="hl-4">Heat</span><span class="hl-1">, </span><span class="hl-4">listenDoneLive</span><span class="hl-1"> } </span><span class="hl-3">from</span><span class="hl-1"> </span><span class="hl-2">&quot;backtest-kit&quot;</span><span class="hl-1">;</span><br/><br/><span class="hl-5">// Start live trading on multiple symbols</span><br/><span class="hl-4">Live</span><span class="hl-1">.</span><span class="hl-0">background</span><span class="hl-1">(</span><span class="hl-2">&quot;BTCUSDT&quot;</span><span class="hl-1">, {</span><br/><span class="hl-1">  </span><span class="hl-4">strategyName:</span><span class="hl-1"> </span><span class="hl-2">&quot;live-strategy&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">exchangeName:</span><span class="hl-1"> </span><span class="hl-2">&quot;binance&quot;</span><br/><span class="hl-1">});</span><br/><br/><span class="hl-4">Live</span><span class="hl-1">.</span><span class="hl-0">background</span><span class="hl-1">(</span><span class="hl-2">&quot;ETHUSDT&quot;</span><span class="hl-1">, {</span><br/><span class="hl-1">  </span><span class="hl-4">strategyName:</span><span class="hl-1"> </span><span class="hl-2">&quot;live-strategy&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">exchangeName:</span><span class="hl-1"> </span><span class="hl-2">&quot;binance&quot;</span><br/><span class="hl-1">});</span><br/><br/><span class="hl-5">// Periodically check portfolio health</span><br/><span class="hl-0">setInterval</span><span class="hl-1">(</span><span class="hl-7">async</span><span class="hl-1"> () </span><span class="hl-7">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">stats</span><span class="hl-1"> = </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-4">Heat</span><span class="hl-1">.</span><span class="hl-0">getData</span><span class="hl-1">(</span><span class="hl-2">&quot;live-strategy&quot;</span><span class="hl-1">);</span><br/><span class="hl-1">  </span><br/><span class="hl-1">  </span><span class="hl-3">if</span><span class="hl-1"> ((</span><span class="hl-4">stats</span><span class="hl-1">.</span><span class="hl-4">portfolioSharpeRatio</span><span class="hl-1"> ?? </span><span class="hl-6">0</span><span class="hl-1">) &lt; </span><span class="hl-6">0.5</span><span class="hl-1">) {</span><br/><span class="hl-1">    </span><span class="hl-4">console</span><span class="hl-1">.</span><span class="hl-0">warn</span><span class="hl-1">(</span><span class="hl-2">&quot;Portfolio Sharpe ratio degraded!&quot;</span><span class="hl-1">);</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">  </span><br/><span class="hl-1">  </span><span class="hl-5">// Save snapshot</span><br/><span class="hl-1">  </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-4">Heat</span><span class="hl-1">.</span><span class="hl-0">dump</span><span class="hl-1">(</span><span class="hl-2">&quot;live-strategy&quot;</span><span class="hl-1">, </span><span class="hl-2">&quot;./live-reports&quot;</span><span class="hl-1">);</span><br/><span class="hl-1">}, </span><span class="hl-6">60000</span><span class="hl-1">); </span><span class="hl-5">// Every minute</span>
</code><button type="button">Copy</button></pre>

<a id="comparing-strategies-by-symbol-performance" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Comparing Strategies by Symbol Performance<a href="#comparing-strategies-by-symbol-performance" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Use heatmaps to compare which strategy performs best per symbol:</p>
<pre><code class="typescript"><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">strategy1</span><span class="hl-1"> = </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-4">Heat</span><span class="hl-1">.</span><span class="hl-0">getData</span><span class="hl-1">(</span><span class="hl-2">&quot;momentum-strategy&quot;</span><span class="hl-1">);</span><br/><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">strategy2</span><span class="hl-1"> = </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-4">Heat</span><span class="hl-1">.</span><span class="hl-0">getData</span><span class="hl-1">(</span><span class="hl-2">&quot;mean-reversion-strategy&quot;</span><span class="hl-1">);</span><br/><br/><span class="hl-5">// Compare BTCUSDT performance</span><br/><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">btc1</span><span class="hl-1"> = </span><span class="hl-4">strategy1</span><span class="hl-1">.</span><span class="hl-4">symbols</span><span class="hl-1">.</span><span class="hl-0">find</span><span class="hl-1">(</span><span class="hl-4">s</span><span class="hl-1"> </span><span class="hl-7">=&gt;</span><span class="hl-1"> </span><span class="hl-4">s</span><span class="hl-1">.</span><span class="hl-4">symbol</span><span class="hl-1"> === </span><span class="hl-2">&quot;BTCUSDT&quot;</span><span class="hl-1">);</span><br/><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">btc2</span><span class="hl-1"> = </span><span class="hl-4">strategy2</span><span class="hl-1">.</span><span class="hl-4">symbols</span><span class="hl-1">.</span><span class="hl-0">find</span><span class="hl-1">(</span><span class="hl-4">s</span><span class="hl-1"> </span><span class="hl-7">=&gt;</span><span class="hl-1"> </span><span class="hl-4">s</span><span class="hl-1">.</span><span class="hl-4">symbol</span><span class="hl-1"> === </span><span class="hl-2">&quot;BTCUSDT&quot;</span><span class="hl-1">);</span><br/><br/><span class="hl-4">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-2">`BTCUSDT Momentum: </span><span class="hl-7">${</span><span class="hl-4">btc1</span><span class="hl-9">?.</span><span class="hl-4">totalPnl</span><span class="hl-7">}</span><span class="hl-2">% PNL, </span><span class="hl-7">${</span><span class="hl-4">btc1</span><span class="hl-9">?.</span><span class="hl-4">sharpeRatio</span><span class="hl-7">}</span><span class="hl-2"> Sharpe`</span><span class="hl-1">);</span><br/><span class="hl-4">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-2">`BTCUSDT Mean-Rev: </span><span class="hl-7">${</span><span class="hl-4">btc2</span><span class="hl-9">?.</span><span class="hl-4">totalPnl</span><span class="hl-7">}</span><span class="hl-2">% PNL, </span><span class="hl-7">${</span><span class="hl-4">btc2</span><span class="hl-9">?.</span><span class="hl-4">sharpeRatio</span><span class="hl-7">}</span><span class="hl-2"> Sharpe`</span><span class="hl-1">);</span><br/><br/><span class="hl-5">// Find symbols where strategy1 outperforms</span><br/><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">strategy1Wins</span><span class="hl-1"> = </span><span class="hl-4">strategy1</span><span class="hl-1">.</span><span class="hl-4">symbols</span><span class="hl-1">.</span><span class="hl-0">filter</span><span class="hl-1">(</span><span class="hl-4">row1</span><span class="hl-1"> </span><span class="hl-7">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">row2</span><span class="hl-1"> = </span><span class="hl-4">strategy2</span><span class="hl-1">.</span><span class="hl-4">symbols</span><span class="hl-1">.</span><span class="hl-0">find</span><span class="hl-1">(</span><span class="hl-4">r</span><span class="hl-1"> </span><span class="hl-7">=&gt;</span><span class="hl-1"> </span><span class="hl-4">r</span><span class="hl-1">.</span><span class="hl-4">symbol</span><span class="hl-1"> === </span><span class="hl-4">row1</span><span class="hl-1">.</span><span class="hl-4">symbol</span><span class="hl-1">);</span><br/><span class="hl-1">  </span><span class="hl-3">return</span><span class="hl-1"> (</span><span class="hl-4">row1</span><span class="hl-1">.</span><span class="hl-4">totalPnl</span><span class="hl-1"> ?? </span><span class="hl-6">0</span><span class="hl-1">) &gt; (</span><span class="hl-4">row2</span><span class="hl-1">?.</span><span class="hl-4">totalPnl</span><span class="hl-1"> ?? </span><span class="hl-6">0</span><span class="hl-1">);</span><br/><span class="hl-1">});</span><br/><br/><span class="hl-4">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-2">`Strategy 1 wins on: </span><span class="hl-7">${</span><span class="hl-4">strategy1Wins</span><span class="hl-9">.</span><span class="hl-0">map</span><span class="hl-9">(</span><span class="hl-4">s</span><span class="hl-9"> </span><span class="hl-7">=&gt;</span><span class="hl-9"> </span><span class="hl-4">s</span><span class="hl-9">.</span><span class="hl-4">symbol</span><span class="hl-9">)</span><span class="hl-7">}</span><span class="hl-2">`</span><span class="hl-1">);</span>
</code><button type="button">Copy</button></pre>

<hr>
<a id="integration-with-event-system" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Integration with Event System<a href="#integration-with-event-system" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>The heatmap service subscribes to the global <code>signalEmitter</code> at initialization, capturing all closed signals from both backtest and live modes.</p>
<a id="event-subscription-flow" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Event Subscription Flow<a href="#event-subscription-flow" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><img src="../media/32-portfolio-heatmaps_3.svg" alt="Mermaid Diagram"></p>
<a id="initialization" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Initialization<a href="#initialization" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>The service uses the <code>singleshot</code> pattern to ensure subscription happens only once:</p>
<pre><code class="typescript"><span class="hl-4">protected</span><span class="hl-1"> </span><span class="hl-4">init</span><span class="hl-1"> = </span><span class="hl-0">singleshot</span><span class="hl-1">(</span><span class="hl-7">async</span><span class="hl-1"> () </span><span class="hl-7">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-7">this</span><span class="hl-1">.</span><span class="hl-4">loggerService</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-2">&quot;heatMarkdownService init&quot;</span><span class="hl-1">);</span><br/><span class="hl-1">  </span><span class="hl-4">signalEmitter</span><span class="hl-1">.</span><span class="hl-0">subscribe</span><span class="hl-1">(</span><span class="hl-7">this</span><span class="hl-1">.</span><span class="hl-4">tick</span><span class="hl-1">);</span><br/><span class="hl-1">});</span>
</code><button type="button">Copy</button></pre>

<p>At <a href="">src/lib/services/markdown/HeatMarkdownService.ts:580-584</a>.</p>
<p>This <code>init()</code> method is automatically called on first access to any public method (getData, getReport, dump) via the service pattern.</p>
<a id="tick-processing" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Tick Processing<a href="#tick-processing" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>The <code>tick()</code> method filters for closed signals only:</p>
<pre><code class="typescript"><span class="hl-4">private</span><span class="hl-1"> </span><span class="hl-0">tick</span><span class="hl-1"> = </span><span class="hl-7">async</span><span class="hl-1"> (</span><span class="hl-4">data</span><span class="hl-1">: </span><span class="hl-13">IStrategyTickResult</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-7">this</span><span class="hl-1">.</span><span class="hl-4">loggerService</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-2">&quot;heatMarkdownService tick&quot;</span><span class="hl-1">, { </span><span class="hl-4">data</span><span class="hl-1"> });</span><br/><span class="hl-1">  </span><br/><span class="hl-1">  </span><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-4">data</span><span class="hl-1">.</span><span class="hl-4">action</span><span class="hl-1"> !== </span><span class="hl-2">&quot;closed&quot;</span><span class="hl-1">) {</span><br/><span class="hl-1">    </span><span class="hl-3">return</span><span class="hl-1">; </span><span class="hl-5">// Ignore idle, opened, active, scheduled, cancelled</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">  </span><br/><span class="hl-1">  </span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">storage</span><span class="hl-1"> = </span><span class="hl-7">this</span><span class="hl-1">.</span><span class="hl-0">getStorage</span><span class="hl-1">(</span><span class="hl-4">data</span><span class="hl-1">.</span><span class="hl-4">strategyName</span><span class="hl-1">);</span><br/><span class="hl-1">  </span><span class="hl-4">storage</span><span class="hl-1">.</span><span class="hl-0">addSignal</span><span class="hl-1">(</span><span class="hl-4">data</span><span class="hl-1">);</span><br/><span class="hl-1">};</span>
</code><button type="button">Copy</button></pre>

<p>At <a href="">src/lib/services/markdown/HeatMarkdownService.ts:470-494</a>.</p>
<hr>
<a id="memory-management" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Memory Management<a href="#memory-management" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>The heatmap service implements bounded storage to prevent memory leaks in long-running processes.</p>
<a id="max_events-limit" class="tsd-anchor"></a><h3 class="tsd-anchor-link">MAX_EVENTS Limit<a href="#max_events-limit" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Each symbol is limited to 250 closed signals:</p>
<pre><code class="typescript"><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">MAX_EVENTS</span><span class="hl-1"> = </span><span class="hl-6">250</span><span class="hl-1">; </span><span class="hl-5">// At line 141</span><br/><br/><span class="hl-4">public</span><span class="hl-1"> </span><span class="hl-0">addSignal</span><span class="hl-1">(</span><span class="hl-4">data</span><span class="hl-1">: </span><span class="hl-4">IStrategyTickResultClosed</span><span class="hl-1">) {</span><br/><span class="hl-1">  </span><span class="hl-7">const</span><span class="hl-1"> { </span><span class="hl-8">symbol</span><span class="hl-1"> } = </span><span class="hl-4">data</span><span class="hl-1">;</span><br/><span class="hl-1">  </span><br/><span class="hl-1">  </span><span class="hl-3">if</span><span class="hl-1"> (!</span><span class="hl-7">this</span><span class="hl-1">.</span><span class="hl-4">symbolData</span><span class="hl-1">.</span><span class="hl-0">has</span><span class="hl-1">(</span><span class="hl-4">symbol</span><span class="hl-1">)) {</span><br/><span class="hl-1">    </span><span class="hl-7">this</span><span class="hl-1">.</span><span class="hl-4">symbolData</span><span class="hl-1">.</span><span class="hl-0">set</span><span class="hl-1">(</span><span class="hl-4">symbol</span><span class="hl-1">, []);</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">  </span><br/><span class="hl-1">  </span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">signals</span><span class="hl-1"> = </span><span class="hl-7">this</span><span class="hl-1">.</span><span class="hl-4">symbolData</span><span class="hl-1">.</span><span class="hl-0">get</span><span class="hl-1">(</span><span class="hl-4">symbol</span><span class="hl-1">)!;</span><br/><span class="hl-1">  </span><span class="hl-4">signals</span><span class="hl-1">.</span><span class="hl-0">unshift</span><span class="hl-1">(</span><span class="hl-4">data</span><span class="hl-1">); </span><span class="hl-5">// Add to front</span><br/><span class="hl-1">  </span><br/><span class="hl-1">  </span><span class="hl-5">// Trim queue if exceeded MAX_EVENTS per symbol</span><br/><span class="hl-1">  </span><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-4">signals</span><span class="hl-1">.</span><span class="hl-4">length</span><span class="hl-1"> &gt; </span><span class="hl-8">MAX_EVENTS</span><span class="hl-1">) {</span><br/><span class="hl-1">    </span><span class="hl-4">signals</span><span class="hl-1">.</span><span class="hl-0">pop</span><span class="hl-1">(); </span><span class="hl-5">// Remove oldest</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<p>At <a href="">src/lib/services/markdown/HeatMarkdownService.ts:155-170</a>.</p>
<a id="storage-clearing" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Storage Clearing<a href="#storage-clearing" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>The <code>clear()</code> method allows manual memory management:</p>
<pre><code class="typescript"><span class="hl-5">// Clear specific strategy</span><br/><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">key</span><span class="hl-1"> = </span><span class="hl-2">`</span><span class="hl-7">${</span><span class="hl-4">strategyName</span><span class="hl-7">}</span><span class="hl-2">`</span><span class="hl-1">;</span><br/><span class="hl-7">this</span><span class="hl-1">.</span><span class="hl-4">getStorage</span><span class="hl-1">.</span><span class="hl-0">clear</span><span class="hl-1">(</span><span class="hl-4">key</span><span class="hl-1">); </span><span class="hl-5">// Removes memoized instance</span><br/><br/><span class="hl-5">// Clear all strategies</span><br/><span class="hl-7">this</span><span class="hl-1">.</span><span class="hl-4">getStorage</span><span class="hl-1">.</span><span class="hl-0">clear</span><span class="hl-1">(); </span><span class="hl-5">// Removes all memoized instances</span>
</code><button type="button">Copy</button></pre>

<p>At <a href="">src/lib/services/markdown/HeatMarkdownService.ts:571-578</a>.</p>
<a id="memoization-key" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Memoization Key<a href="#memoization-key" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>The <code>getStorage</code> function uses strategy name as the memoization key:</p>
<pre><code class="typescript"><span class="hl-4">private</span><span class="hl-1"> </span><span class="hl-4">getStorage</span><span class="hl-1"> = </span><span class="hl-0">memoize</span><span class="hl-1">&lt;(</span><span class="hl-4">strategyName</span><span class="hl-1">: </span><span class="hl-13">string</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> </span><span class="hl-13">HeatmapStorage</span><span class="hl-1">&gt;(</span><br/><span class="hl-1">  (</span><span class="hl-4">strategyName</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> </span><span class="hl-4">strategyName</span><span class="hl-1">, </span><span class="hl-5">// Key function</span><br/><span class="hl-1">  (</span><span class="hl-4">strategyName</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> </span><span class="hl-7">new</span><span class="hl-1"> </span><span class="hl-0">HeatmapStorage</span><span class="hl-1">() </span><span class="hl-5">// Factory function</span><br/><span class="hl-1">);</span>
</code><button type="button">Copy</button></pre>

<p>At <a href="">src/lib/services/markdown/HeatMarkdownService.ts:460-463</a>.</p>
<p>This ensures each strategy gets its own isolated <code>HeatmapStorage</code> instance, preventing cross-contamination of data.</p>
</div></div><div class="col-sidebar"><div class="page-menu"><div class="tsd-navigation settings"><details class="tsd-accordion"><summary class="tsd-accordion-summary"><h3><svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-chevronDown"></use></svg>Settings</h3></summary><div class="tsd-accordion-details"><div class="tsd-filter-visibility"><span class="settings-label">Member Visibility</span><ul id="tsd-filter-options"><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-protected" name="protected"/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Protected</span></label></li><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-inherited" name="inherited" checked/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Inherited</span></label></li><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-external" name="external"/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>External</span></label></li></ul></div><div class="tsd-theme-toggle"><label class="settings-label" for="tsd-theme">Theme</label><select id="tsd-theme"><option value="os">OS</option><option value="light">Light</option><option value="dark">Dark</option></select></div></div></details></div><details open class="tsd-accordion tsd-page-navigation"><summary class="tsd-accordion-summary"><h3><svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-chevronDown"></use></svg>On This Page</h3></summary><div class="tsd-accordion-details"><a href="#portfolio-heatmaps"><span>Portfolio <wbr/>Heatmaps</span></a><ul><li><a href="#heatmap-data-structure"><span>Heatmap <wbr/>Data <wbr/>Structure</span></a></li><li><ul><li><a href="#per-symbol-statistics-iheatmaprow"><span>Per-<wbr/>Symbol <wbr/>Statistics (IHeatmap<wbr/>Row)</span></a></li><li><a href="#portfolio-wide-statistics-iheatmapstatistics"><span>Portfolio-<wbr/>Wide <wbr/>Statistics (IHeatmap<wbr/>Statistics)</span></a></li></ul></li><li><a href="#heatmarkdownservice-architecture"><span>Heat<wbr/>Markdown<wbr/>Service <wbr/>Architecture</span></a></li><li><ul><li><a href="#component-overview"><span>Component <wbr/>Overview</span></a></li><li><a href="#key-classes-and-methods"><span>Key <wbr/>Classes and <wbr/>Methods</span></a></li><li><ul><li><a href="#heatmarkdownservice"><span>Heat<wbr/>Markdown<wbr/>Service</span></a></li><li><a href="#heatmapstorage"><span>Heatmap<wbr/>Storage</span></a></li></ul></li></ul></li><li><a href="#data-flow-signal-to-heatmap"><span>Data <wbr/>Flow: <wbr/>Signal to <wbr/>Heatmap</span></a></li><li><a href="#metric-calculation-details"><span>Metric <wbr/>Calculation <wbr/>Details</span></a></li><li><ul><li><a href="#per-symbol-metrics"><span>Per-<wbr/>Symbol <wbr/>Metrics</span></a></li><li><ul><li><a href="#basic-counts"><span>Basic <wbr/>Counts</span></a></li><li><a href="#win-rate-and-pnl"><span>Win <wbr/>Rate and PNL</span></a></li><li><a href="#risk-metrics"><span>Risk <wbr/>Metrics</span></a></li><li><a href="#profit-factor"><span>Profit <wbr/>Factor</span></a></li><li><a href="#drawdown-calculation"><span>Drawdown <wbr/>Calculation</span></a></li><li><a href="#winloss-streaks"><span>Win/<wbr/>Loss <wbr/>Streaks</span></a></li><li><a href="#expectancy"><span>Expectancy</span></a></li></ul></li><li><a href="#portfolio-wide-metrics"><span>Portfolio-<wbr/>Wide <wbr/>Metrics</span></a></li><li><ul><li><a href="#portfolio-total-pnl"><span>Portfolio <wbr/>Total PNL</span></a></li><li><a href="#portfolio-sharpe-ratio"><span>Portfolio <wbr/>Sharpe <wbr/>Ratio</span></a></li><li><a href="#portfolio-total-trades"><span>Portfolio <wbr/>Total <wbr/>Trades</span></a></li></ul></li></ul></li><li><a href="#heat-facade-api"><span>Heat <wbr/>Facade API</span></a></li><li><ul><li><a href="#api-methods"><span>API <wbr/>Methods</span></a></li><li><a href="#method-details"><span>Method <wbr/>Details</span></a></li><li><ul><li><a href="#getdatastrategyname-string-promise"><span>get<wbr/>Data(strategy<wbr/>Name: string): <wbr/>Promise&lt;IHeatmap<wbr/>Statistics&gt;</span></a></li><li><a href="#getreportstrategyname-string-promise"><span>get<wbr/>Report(strategy<wbr/>Name: string): <wbr/>Promise&lt;string&gt;</span></a></li><li><a href="#dumpstrategyname-string-path-string-promise"><span>dump(strategy<wbr/>Name: string, path?: string): <wbr/>Promise&lt;void&gt;</span></a></li><li><a href="#clearstrategyname-string-promise"><span>clear(strategy<wbr/>Name?: string): <wbr/>Promise&lt;void&gt;</span></a></li></ul></li></ul></li><li><a href="#report-format"><span>Report <wbr/>Format</span></a></li><li><ul><li><a href="#symbol-comparison-table"><span>Symbol <wbr/>Comparison <wbr/>Table</span></a></li><li><a href="#portfolio-summary-section"><span>Portfolio <wbr/>Summary <wbr/>Section</span></a></li></ul></li><li><a href="#usage-examples"><span>Usage <wbr/>Examples</span></a></li><li><ul><li><a href="#basic-backtest-heatmap"><span>Basic <wbr/>Backtest <wbr/>Heatmap</span></a></li><li><a href="#multi-symbol-portfolio-analysis"><span>Multi-<wbr/>Symbol <wbr/>Portfolio <wbr/>Analysis</span></a></li><li><a href="#live-trading-portfolio-monitoring"><span>Live <wbr/>Trading <wbr/>Portfolio <wbr/>Monitoring</span></a></li><li><a href="#comparing-strategies-by-symbol-performance"><span>Comparing <wbr/>Strategies by <wbr/>Symbol <wbr/>Performance</span></a></li></ul></li><li><a href="#integration-with-event-system"><span>Integration with <wbr/>Event <wbr/>System</span></a></li><li><ul><li><a href="#event-subscription-flow"><span>Event <wbr/>Subscription <wbr/>Flow</span></a></li><li><a href="#initialization"><span>Initialization</span></a></li><li><a href="#tick-processing"><span>Tick <wbr/>Processing</span></a></li></ul></li><li><a href="#memory-management"><span>Memory <wbr/>Management</span></a></li><li><ul><li><a href="#max_events-limit"><span>MAX_<wbr/>EVENTS <wbr/>Limit</span></a></li><li><a href="#storage-clearing"><span>Storage <wbr/>Clearing</span></a></li><li><a href="#memoization-key"><span>Memoization <wbr/>Key</span></a></li></ul></li></ul></div></details></div><div class="site-menu"><nav class="tsd-navigation"><a href="../modules.html">backtest-kit</a><ul class="tsd-small-nested-navigation" id="tsd-nav-container"><li>Loading...</li></ul></nav></div></div></div><footer><p class="tsd-generator">Generated using <a href="https://typedoc.org/" target="_blank">TypeDoc</a></p></footer><div class="overlay"></div></body></html>

<!-- Yandex.Metrika counter -->
<script type="text/javascript">
    (function(m,e,t,r,i,k,a){
        m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
        m[i].l=1*new Date();
        for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }}
        k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)
    })(window, document,'script','https://mc.yandex.ru/metrika/tag.js?id=105455585', 'ym');

    ym(105455585, 'init', {ssr:true, webvisor:true, clickmap:true, ecommerce:"dataLayer", accurateTrackBounce:true, trackLinks:true});
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/105455585" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
<!-- /Yandex.Metrika counter -->

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-3MQZEBBDDR"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-3MQZEBBDDR');
</script>
