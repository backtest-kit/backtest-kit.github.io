<!DOCTYPE html><html class="default" lang="en" data-base=".."><head><meta charset="utf-8"/><meta http-equiv="x-ua-compatible" content="IE=edge"/><title>design/49_code-generation-templates | backtest-kit</title><meta name="description" content="Documentation for backtest-kit"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="stylesheet" href="../assets/style.css"/><link rel="stylesheet" href="../assets/highlight.css"/><script defer src="../assets/main.js"></script><script async src="../assets/icons.js" id="tsd-icons-script"></script><script async src="../assets/search.js" id="tsd-search-script"></script><script async src="../assets/navigation.js" id="tsd-nav-script"></script><script async src="../assets/hierarchy.js" id="tsd-hierarchy-script"></script></head><body><script>document.documentElement.dataset.theme = localStorage.getItem("tsd-theme") || "os";document.body.style.display="none";setTimeout(() => app?app.showPage():document.body.style.removeProperty("display"),500)</script><header class="tsd-page-toolbar"><div class="tsd-toolbar-contents container"><div class="table-cell" id="tsd-search"><div class="field"><label for="tsd-search-field" class="tsd-widget tsd-toolbar-icon search no-caption"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-search"></use></svg></label><input type="text" id="tsd-search-field" aria-label="Search"/></div><div class="field"><div id="tsd-toolbar-links"></div></div><ul class="results"><li class="state loading">Preparing search index...</li><li class="state failure">The search index is not available</li></ul><a href="../index.html" class="title">backtest-kit</a></div><div class="table-cell" id="tsd-widgets"><a href="#" class="tsd-widget tsd-toolbar-icon menu no-caption" data-toggle="menu" aria-label="Menu"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-menu"></use></svg></a></div></div></header><div class="container container-main"><div class="col-content"><div class="tsd-page-title"><ul class="tsd-breadcrumb"><li><a href="../modules.html">backtest-kit</a></li><li><a href="design_49_code-generation-templates.html">design/49_code-generation-templates</a></li></ul></div><div class="tsd-panel tsd-typography"><a id="code-generation--templates" class="tsd-anchor"></a><h1 class="tsd-anchor-link">Code Generation &amp; Templates<a href="#code-generation--templates" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h1><p>This document covers the template system used by the Optimizer to generate executable strategy code. It explains the <code>IOptimizerTemplate</code> interface, the default <code>OptimizerTemplateService</code> implementation, how templates are assembled into complete <code>.mjs</code> files, and how to customize code generation for specific use cases.</p>
<p>For information about the overall optimizer system and data collection, see <a href="design_46_advanced-features.html">Optimizer System</a>. For details on LLM integration and prompt engineering, see <a href="design_46_advanced-features.html">LLM-Powered Strategy Generation</a>.</p>
<hr>
<a id="template-system-overview" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Template System Overview<a href="#template-system-overview" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>The template system transforms optimizer data (market analysis, backtest results, etc.) into executable Node.js modules that run Walker-based strategy comparisons with integrated LLM decision-making. Templates are TypeScript/JavaScript code generators that return strings of code.</p>
<p><strong>Template Workflow Diagram</strong></p>
<p><img src="../media/49_code-generation-templates_0.svg" alt="Mermaid Diagram"></p>
<hr>
<a id="ioptimizertemplate-interface" class="tsd-anchor"></a><h2 class="tsd-anchor-link">IOptimizerTemplate Interface<a href="#ioptimizertemplate-interface" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>The <code>IOptimizerTemplate</code> interface defines 11 template methods that generate different sections of the final strategy code. Each method returns a string (or Promise<string>) containing valid TypeScript/JavaScript code.</p>
<p><strong>Template Methods Table</strong></p>
<table>
<thead>
<tr>
<th>Method</th>
<th>Parameters</th>
<th>Purpose</th>
<th>Output</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>getTopBanner</code></td>
<td>symbol</td>
<td>Imports and initialization</td>
<td>Shebang, imports, constants</td>
</tr>
<tr>
<td><code>getUserMessage</code></td>
<td>symbol, data, name</td>
<td>Default LLM user message</td>
<td>Formatted data prompt</td>
</tr>
<tr>
<td><code>getAssistantMessage</code></td>
<td>symbol, data, name</td>
<td>Default LLM assistant response</td>
<td>Acknowledgment message</td>
</tr>
<tr>
<td><code>getWalkerTemplate</code></td>
<td>walkerName, exchangeName, frameName, strategies</td>
<td>Walker configuration</td>
<td><code>addWalker()</code> call</td>
</tr>
<tr>
<td><code>getExchangeTemplate</code></td>
<td>symbol, exchangeName</td>
<td>Exchange configuration</td>
<td><code>addExchange()</code> with CCXT</td>
</tr>
<tr>
<td><code>getFrameTemplate</code></td>
<td>symbol, frameName, interval, startDate, endDate</td>
<td>Timeframe configuration</td>
<td><code>addFrame()</code> call</td>
</tr>
<tr>
<td><code>getStrategyTemplate</code></td>
<td>strategyName, interval, prompt</td>
<td>Strategy with LLM logic</td>
<td><code>addStrategy()</code> with getSignal</td>
</tr>
<tr>
<td><code>getLauncherTemplate</code></td>
<td>symbol, walkerName</td>
<td>Walker execution</td>
<td><code>Walker.background()</code> + listeners</td>
</tr>
<tr>
<td><code>getTextTemplate</code></td>
<td>symbol</td>
<td>LLM text generation helper</td>
<td><code>async text()</code> function</td>
</tr>
<tr>
<td><code>getJsonTemplate</code></td>
<td>symbol</td>
<td>LLM JSON generation helper</td>
<td><code>async json()</code> function with schema</td>
</tr>
<tr>
<td><code>getJsonDumpTemplate</code></td>
<td>symbol</td>
<td>Debug output helper</td>
<td><code>async dumpJson()</code> function</td>
</tr>
</tbody>
</table>
<p><strong>Template Method Dependencies</strong></p>
<p><img src="../media/49_code-generation-templates_1.svg" alt="Mermaid Diagram"></p>
<hr>
<a id="optimizertemplateservice-default-implementation" class="tsd-anchor"></a><h2 class="tsd-anchor-link">OptimizerTemplateService Default Implementation<a href="#optimizertemplateservice-default-implementation" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>The <code>OptimizerTemplateService</code> class provides default implementations for all <code>IOptimizerTemplate</code> methods. It generates code optimized for multi-timeframe analysis (1m, 5m, 15m, 1h) with Ollama LLM integration and comprehensive debugging.</p>
<p><strong>Key Features</strong></p>
<ul>
<li><strong>Multi-Timeframe Analysis</strong>: Loads candles from 4 timeframes and formats them for LLM context <code>src/lib/services/template/OptimizerTemplateService.ts:202-276</code></li>
<li><strong>JSON Structured Output</strong>: Uses Ollama's <code>format</code> parameter with strict schema for trading signals <code>src/lib/services/template/OptimizerTemplateService.ts:675-705</code></li>
<li><strong>Debug Logging</strong>: Saves LLM conversations and results to <code>./dump/strategy/{resultId}/</code> <code>src/lib/services/template/OptimizerTemplateService.ts:457-544</code></li>
<li><strong>Code Injection Prevention</strong>: Escapes special characters in all string interpolations <code>src/lib/services/template/OptimizerTemplateService.ts:136-147</code>, <code>src/lib/services/template/OptimizerTemplateService.ts:183-192</code></li>
<li><strong>CCXT Integration</strong>: Default exchange uses <code>ccxt.binance()</code> with standard formatters <code>src/lib/services/template/OptimizerTemplateService.ts:328-341</code></li>
</ul>
<p><strong>Default Template Method Implementations</strong></p>
<table>
<thead>
<tr>
<th>Method</th>
<th>Implementation Details</th>
<th>Key Escaping</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>getTopBanner</code></td>
<td>Returns shebang + imports (Ollama, ccxt, backtest-kit, fs, uuid, path) + <code>WARN_KB</code> constant</td>
<td>None (static)</td>
</tr>
<tr>
<td><code>getStrategyTemplate</code></td>
<td>Generates 5-message conversation: 1h analysis → 15m analysis → 5m analysis → 1m analysis → signal request</td>
<td>strategyName, interval, prompt (backticks, $)</td>
</tr>
<tr>
<td><code>getExchangeTemplate</code></td>
<td>CCXT Binance with fetchOHLCV, price/quantity formatters</td>
<td>exchangeName</td>
</tr>
<tr>
<td><code>getFrameTemplate</code></td>
<td>addFrame with ISO date strings</td>
<td>frameName, interval</td>
</tr>
<tr>
<td><code>getWalkerTemplate</code></td>
<td>addWalker with strategy array</td>
<td>walkerName, exchangeName, frameName, strategies[]</td>
</tr>
<tr>
<td><code>getLauncherTemplate</code></td>
<td>Walker.background + 7 event listeners (signal, progress, complete, done, error)</td>
<td>symbol, walkerName</td>
</tr>
<tr>
<td><code>getTextTemplate</code></td>
<td>Ollama chat with market analysis prompt, returns escaped text</td>
<td>symbol (in prompt)</td>
</tr>
<tr>
<td><code>getJsonTemplate</code></td>
<td>Ollama chat with signal schema (position, note, prices, time)</td>
<td>None (static schema)</td>
</tr>
<tr>
<td><code>getJsonDumpTemplate</code></td>
<td>Saves messages to numbered markdown files with size warnings</td>
<td>None (dynamic paths)</td>
</tr>
</tbody>
</table>
<p><strong>getStrategyTemplate Multi-Timeframe Flow</strong></p>
<p><img src="../media/49_code-generation-templates_2.svg" alt="Mermaid Diagram"></p>
<hr>
<a id="code-generation-workflow-in-clientoptimizer" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Code Generation Workflow in ClientOptimizer<a href="#code-generation-workflow-in-clientoptimizer" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>The <code>ClientOptimizer.getCode</code> method orchestrates template calls to assemble a complete executable strategy file. The <code>GET_STRATEGY_CODE_FN</code> function <code>src/client/ClientOptimizer.ts:225-350</code> performs the following steps:</p>
<p><strong>Code Assembly Process</strong></p>
<ol>
<li><strong>Fetch Strategy Data</strong>: Call <code>getData(symbol)</code> to collect LLM conversation history <code>src/client/ClientOptimizer.ts:226</code></li>
<li><strong>Generate Prefix</strong>: Create random prefix for unique naming (e.g., <code>&quot;a1b2c3&quot;</code>) <code>src/client/ClientOptimizer.ts:228</code></li>
<li><strong>Initialize Sections Array</strong>: Accumulate code strings <code>src/client/ClientOptimizer.ts:229</code></li>
<li><strong>Top Banner</strong>: Imports and constants <code>src/client/ClientOptimizer.ts:233-236</code></li>
<li><strong>JSON Dump Helper</strong>: Debug output function <code>src/client/ClientOptimizer.ts:238-242</code></li>
<li><strong>Helper Functions</strong>: <code>text()</code> and <code>json()</code> LLM wrappers <code>src/client/ClientOptimizer.ts:244-253</code></li>
<li><strong>Exchange Configuration</strong>: CCXT integration <code>src/client/ClientOptimizer.ts:256-264</code></li>
<li><strong>Train Frames</strong>: One frame per training range <code>src/client/ClientOptimizer.ts:267-282</code></li>
<li><strong>Test Frame</strong>: Single validation timeframe <code>src/client/ClientOptimizer.ts:285-297</code></li>
<li><strong>Strategies</strong>: One strategy per training range × source combination <code>src/client/ClientOptimizer.ts:300-314</code></li>
<li><strong>Walker Configuration</strong>: Compare all strategies <code>src/client/ClientOptimizer.ts:317-332</code></li>
<li><strong>Launcher</strong>: Execute Walker with event listeners <code>src/client/ClientOptimizer.ts:335-341</code></li>
<li><strong>Join and Callback</strong>: Combine sections, trigger <code>onCode</code> callback <code>src/client/ClientOptimizer.ts:343-348</code></li>
</ol>
<p><strong>Generated File Naming Convention</strong></p>
<ul>
<li><strong>Exchange</strong>: <code>{prefix}_exchange</code> (e.g., <code>&quot;a1b2c3_exchange&quot;</code>)</li>
<li><strong>Train Frames</strong>: <code>{prefix}_train_frame-{N}</code> (e.g., <code>&quot;a1b2c3_train_frame-1&quot;</code>, <code>&quot;a1b2c3_train_frame-2&quot;</code>)</li>
<li><strong>Test Frame</strong>: <code>{prefix}_test_frame</code></li>
<li><strong>Strategies</strong>: <code>{prefix}_strategy-{N}</code> (e.g., <code>&quot;a1b2c3_strategy-1&quot;</code>)</li>
<li><strong>Walker</strong>: <code>{prefix}_walker</code></li>
</ul>
<p><strong>Code Generation Data Flow</strong></p>
<p><img src="../media/49_code-generation-templates_3.svg" alt="Mermaid Diagram"></p>
<hr>
<a id="template-customization" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Template Customization<a href="#template-customization" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>Users can override individual template methods in the <code>IOptimizerSchema.template</code> property. The <code>OptimizerConnectionService</code> merges custom overrides with defaults from <code>OptimizerTemplateService</code>.</p>
<p><strong>Template Merging Process</strong></p>
<p><img src="../media/49_code-generation-templates_4.svg" alt="Mermaid Diagram"></p>
<p><strong>Custom Template Example</strong></p>
<pre><code class="typescript"><span class="hl-0">addOptimizer</span><span class="hl-1">({</span><br/><span class="hl-1">  </span><span class="hl-4">optimizerName:</span><span class="hl-1"> </span><span class="hl-2">&quot;custom-template-optimizer&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">rangeTrain:</span><span class="hl-1"> [...],</span><br/><span class="hl-1">  </span><span class="hl-4">rangeTest:</span><span class="hl-1"> {...},</span><br/><span class="hl-1">  </span><span class="hl-4">source:</span><span class="hl-1"> [...],</span><br/><span class="hl-1">  </span><span class="hl-0">getPrompt</span><span class="hl-4">:</span><span class="hl-1"> </span><span class="hl-7">async</span><span class="hl-1"> (</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">messages</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> {...},</span><br/><span class="hl-1">  </span><br/><span class="hl-1">  </span><span class="hl-5">// Override specific templates</span><br/><span class="hl-1">  </span><span class="hl-4">template:</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-5">// Custom strategy template with different timeframes</span><br/><span class="hl-1">    </span><span class="hl-0">getStrategyTemplate</span><span class="hl-4">:</span><span class="hl-1"> </span><span class="hl-7">async</span><span class="hl-1"> (</span><span class="hl-4">strategyName</span><span class="hl-1">, </span><span class="hl-4">interval</span><span class="hl-1">, </span><span class="hl-4">prompt</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">      </span><span class="hl-3">return</span><span class="hl-1"> [</span><br/><span class="hl-1">        </span><span class="hl-2">`addStrategy({`</span><span class="hl-1">,</span><br/><span class="hl-1">        </span><span class="hl-2">`    strategyName: &quot;</span><span class="hl-7">${</span><span class="hl-4">strategyName</span><span class="hl-7">}</span><span class="hl-2">&quot;,`</span><span class="hl-1">,</span><br/><span class="hl-1">        </span><span class="hl-2">`    interval: &quot;</span><span class="hl-7">${</span><span class="hl-4">interval</span><span class="hl-7">}</span><span class="hl-2">&quot;,`</span><span class="hl-1">,</span><br/><span class="hl-1">        </span><span class="hl-2">`    getSignal: async (symbol) =&gt; {`</span><span class="hl-1">,</span><br/><span class="hl-1">        </span><span class="hl-2">`        // Load only 15m and 1h candles`</span><span class="hl-1">,</span><br/><span class="hl-1">        </span><span class="hl-2">`        const shortTerm = await getCandles(symbol, &quot;15m&quot;, 12);`</span><span class="hl-1">,</span><br/><span class="hl-1">        </span><span class="hl-2">`        const mediumTerm = await getCandles(symbol, &quot;1h&quot;, 12);`</span><span class="hl-1">,</span><br/><span class="hl-1">        </span><span class="hl-2">`        `</span><span class="hl-1">,</span><br/><span class="hl-1">        </span><span class="hl-2">`        // Custom analysis logic`</span><span class="hl-1">,</span><br/><span class="hl-1">        </span><span class="hl-2">`        const signal = await analyzeCustom(shortTerm, mediumTerm);`</span><span class="hl-1">,</span><br/><span class="hl-1">        </span><span class="hl-2">`        return signal;`</span><span class="hl-1">,</span><br/><span class="hl-1">        </span><span class="hl-2">`    },`</span><span class="hl-1">,</span><br/><span class="hl-1">        </span><span class="hl-2">`});`</span><br/><span class="hl-1">      ].</span><span class="hl-0">join</span><span class="hl-1">(</span><span class="hl-2">&quot;</span><span class="hl-12">\n</span><span class="hl-2">&quot;</span><span class="hl-1">);</span><br/><span class="hl-1">    },</span><br/><span class="hl-1">    </span><br/><span class="hl-1">    </span><span class="hl-5">// Custom exchange with different CCXT exchange</span><br/><span class="hl-1">    </span><span class="hl-0">getExchangeTemplate</span><span class="hl-4">:</span><span class="hl-1"> </span><span class="hl-7">async</span><span class="hl-1"> (</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">exchangeName</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">      </span><span class="hl-3">return</span><span class="hl-1"> [</span><br/><span class="hl-1">        </span><span class="hl-2">`addExchange({`</span><span class="hl-1">,</span><br/><span class="hl-1">        </span><span class="hl-2">`    exchangeName: &quot;</span><span class="hl-7">${</span><span class="hl-4">exchangeName</span><span class="hl-7">}</span><span class="hl-2">&quot;,`</span><span class="hl-1">,</span><br/><span class="hl-1">        </span><span class="hl-2">`    getCandles: async (symbol, interval, since, limit) =&gt; {`</span><span class="hl-1">,</span><br/><span class="hl-1">        </span><span class="hl-2">`        const exchange = new ccxt.kraken(); // Use Kraken instead`</span><span class="hl-1">,</span><br/><span class="hl-1">        </span><span class="hl-2">`        const ohlcv = await exchange.fetchOHLCV(symbol, interval, since.getTime(), limit);`</span><span class="hl-1">,</span><br/><span class="hl-1">        </span><span class="hl-2">`        return ohlcv.map(([timestamp, open, high, low, close, volume]) =&gt; ({`</span><span class="hl-1">,</span><br/><span class="hl-1">        </span><span class="hl-2">`            timestamp, open, high, low, close, volume`</span><span class="hl-1">,</span><br/><span class="hl-1">        </span><span class="hl-2">`        }));`</span><span class="hl-1">,</span><br/><span class="hl-1">        </span><span class="hl-2">`    },`</span><span class="hl-1">,</span><br/><span class="hl-1">        </span><span class="hl-2">`    formatPrice: async (symbol, price) =&gt; price.toFixed(4), // Different precision`</span><span class="hl-1">,</span><br/><span class="hl-1">        </span><span class="hl-2">`    formatQuantity: async (symbol, quantity) =&gt; quantity.toFixed(6),`</span><span class="hl-1">,</span><br/><span class="hl-1">        </span><span class="hl-2">`});`</span><br/><span class="hl-1">      ].</span><span class="hl-0">join</span><span class="hl-1">(</span><span class="hl-2">&quot;</span><span class="hl-12">\n</span><span class="hl-2">&quot;</span><span class="hl-1">);</span><br/><span class="hl-1">    },</span><br/><span class="hl-1">    </span><br/><span class="hl-1">    </span><span class="hl-5">// All other methods use defaults from OptimizerTemplateService</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">});</span>
</code><button type="button">Copy</button></pre>

<p><strong>Partial Override Behavior</strong></p>
<p>The merging logic in <code>OptimizerConnectionService.getOptimizer</code> <code>src/lib/services/connection/OptimizerConnectionService.ts:72-97</code> uses destructuring with default fallbacks:</p>
<pre><code class="typescript"><span class="hl-7">const</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-8">getAssistantMessage</span><span class="hl-1"> = </span><span class="hl-7">this</span><span class="hl-1">.</span><span class="hl-4">optimizerTemplateService</span><span class="hl-1">.</span><span class="hl-4">getAssistantMessage</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-8">getExchangeTemplate</span><span class="hl-1"> = </span><span class="hl-7">this</span><span class="hl-1">.</span><span class="hl-4">optimizerTemplateService</span><span class="hl-1">.</span><span class="hl-4">getExchangeTemplate</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-8">getFrameTemplate</span><span class="hl-1"> = </span><span class="hl-7">this</span><span class="hl-1">.</span><span class="hl-4">optimizerTemplateService</span><span class="hl-1">.</span><span class="hl-4">getFrameTemplate</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-5">// ... all 11 methods</span><br/><span class="hl-1">} = </span><span class="hl-4">rawTemplate</span><span class="hl-1">;</span>
</code><button type="button">Copy</button></pre>

<p>Any method not provided in <code>schema.template</code> automatically uses the default implementation.</p>
<hr>
<a id="generated-code-structure" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Generated Code Structure<a href="#generated-code-structure" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>The final <code>.mjs</code> file produced by <code>ClientOptimizer.getCode</code> follows a 10-section structure with strict ordering to ensure correct dependency resolution.</p>
<p><strong>Complete File Structure</strong></p>
<pre><code class="javascript"><span class="hl-5">#!/usr/bin/env node</span><br/><br/><span class="hl-5">// ===== SECTION 1: Top Banner =====</span><br/><span class="hl-3">import</span><span class="hl-1"> { </span><span class="hl-4">Ollama</span><span class="hl-1"> } </span><span class="hl-3">from</span><span class="hl-1"> </span><span class="hl-2">&quot;ollama&quot;</span><span class="hl-1">;</span><br/><span class="hl-3">import</span><span class="hl-1"> </span><span class="hl-4">ccxt</span><span class="hl-1"> </span><span class="hl-3">from</span><span class="hl-1"> </span><span class="hl-2">&quot;ccxt&quot;</span><span class="hl-1">;</span><br/><span class="hl-3">import</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-4">addExchange</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-4">addStrategy</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-4">addFrame</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-4">addWalker</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-4">Walker</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-4">Backtest</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-4">getCandles</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-4">listenSignalBacktest</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-4">listenWalkerComplete</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-4">listenDoneBacktest</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-4">listenBacktestProgress</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-4">listenWalkerProgress</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-4">listenError</span><span class="hl-1">,</span><br/><span class="hl-1">} </span><span class="hl-3">from</span><span class="hl-1"> </span><span class="hl-2">&quot;backtest-kit&quot;</span><span class="hl-1">;</span><br/><span class="hl-3">import</span><span class="hl-1"> { </span><span class="hl-4">promises</span><span class="hl-1"> </span><span class="hl-3">as</span><span class="hl-1"> </span><span class="hl-4">fs</span><span class="hl-1"> } </span><span class="hl-3">from</span><span class="hl-1"> </span><span class="hl-2">&quot;fs&quot;</span><span class="hl-1">;</span><br/><span class="hl-3">import</span><span class="hl-1"> { </span><span class="hl-4">v4</span><span class="hl-1"> </span><span class="hl-3">as</span><span class="hl-1"> </span><span class="hl-4">uuid</span><span class="hl-1"> } </span><span class="hl-3">from</span><span class="hl-1"> </span><span class="hl-2">&quot;uuid&quot;</span><span class="hl-1">;</span><br/><span class="hl-3">import</span><span class="hl-1"> </span><span class="hl-4">path</span><span class="hl-1"> </span><span class="hl-3">from</span><span class="hl-1"> </span><span class="hl-2">&quot;path&quot;</span><span class="hl-1">;</span><br/><br/><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">WARN_KB</span><span class="hl-1"> = </span><span class="hl-6">100</span><span class="hl-1">;</span><br/><br/><span class="hl-5">// ===== SECTION 2: dumpJson Helper =====</span><br/><span class="hl-7">async</span><span class="hl-1"> </span><span class="hl-7">function</span><span class="hl-1"> </span><span class="hl-0">dumpJson</span><span class="hl-1">(</span><span class="hl-4">resultId</span><span class="hl-1">, </span><span class="hl-4">history</span><span class="hl-1">, </span><span class="hl-4">result</span><span class="hl-1">, </span><span class="hl-4">outputDir</span><span class="hl-1"> = </span><span class="hl-2">&quot;./dump/strategy&quot;</span><span class="hl-1">) {</span><br/><span class="hl-1">    </span><span class="hl-5">// Saves to ./dump/strategy/{resultId}/00_system_prompt.md</span><br/><span class="hl-1">    </span><span class="hl-5">// Saves to ./dump/strategy/{resultId}/01_user_message.md</span><br/><span class="hl-1">    </span><span class="hl-5">// ... etc</span><br/><span class="hl-1">}</span><br/><br/><span class="hl-5">// ===== SECTION 3: text Helper =====</span><br/><span class="hl-7">async</span><span class="hl-1"> </span><span class="hl-7">function</span><span class="hl-1"> </span><span class="hl-0">text</span><span class="hl-1">(</span><span class="hl-4">messages</span><span class="hl-1">) {</span><br/><span class="hl-1">    </span><span class="hl-5">// Ollama chat for text generation</span><br/><span class="hl-1">    </span><span class="hl-5">// Returns escaped string</span><br/><span class="hl-1">}</span><br/><br/><span class="hl-5">// ===== SECTION 4: json Helper =====</span><br/><span class="hl-7">async</span><span class="hl-1"> </span><span class="hl-7">function</span><span class="hl-1"> </span><span class="hl-0">json</span><span class="hl-1">(</span><span class="hl-4">messages</span><span class="hl-1">) {</span><br/><span class="hl-1">    </span><span class="hl-5">// Ollama chat with JSON schema</span><br/><span class="hl-1">    </span><span class="hl-5">// Returns parsed signal object</span><br/><span class="hl-1">}</span><br/><br/><span class="hl-5">// ===== SECTION 5: Exchange Configuration =====</span><br/><span class="hl-0">addExchange</span><span class="hl-1">({</span><br/><span class="hl-1">    </span><span class="hl-4">exchangeName:</span><span class="hl-1"> </span><span class="hl-2">&quot;a1b2c3_exchange&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-0">getCandles</span><span class="hl-4">:</span><span class="hl-1"> </span><span class="hl-7">async</span><span class="hl-1"> (</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">interval</span><span class="hl-1">, </span><span class="hl-4">since</span><span class="hl-1">, </span><span class="hl-4">limit</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">        </span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">exchange</span><span class="hl-1"> = </span><span class="hl-7">new</span><span class="hl-1"> </span><span class="hl-4">ccxt</span><span class="hl-1">.</span><span class="hl-0">binance</span><span class="hl-1">();</span><br/><span class="hl-1">        </span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">ohlcv</span><span class="hl-1"> = </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-4">exchange</span><span class="hl-1">.</span><span class="hl-0">fetchOHLCV</span><span class="hl-1">(</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">interval</span><span class="hl-1">, </span><span class="hl-4">since</span><span class="hl-1">.</span><span class="hl-0">getTime</span><span class="hl-1">(), </span><span class="hl-4">limit</span><span class="hl-1">);</span><br/><span class="hl-1">        </span><span class="hl-3">return</span><span class="hl-1"> </span><span class="hl-4">ohlcv</span><span class="hl-1">.</span><span class="hl-0">map</span><span class="hl-1">(([</span><span class="hl-4">timestamp</span><span class="hl-1">, </span><span class="hl-4">open</span><span class="hl-1">, </span><span class="hl-4">high</span><span class="hl-1">, </span><span class="hl-4">low</span><span class="hl-1">, </span><span class="hl-4">close</span><span class="hl-1">, </span><span class="hl-4">volume</span><span class="hl-1">]) </span><span class="hl-7">=&gt;</span><span class="hl-1"> ({</span><br/><span class="hl-1">            </span><span class="hl-4">timestamp</span><span class="hl-1">, </span><span class="hl-4">open</span><span class="hl-1">, </span><span class="hl-4">high</span><span class="hl-1">, </span><span class="hl-4">low</span><span class="hl-1">, </span><span class="hl-4">close</span><span class="hl-1">, </span><span class="hl-4">volume</span><br/><span class="hl-1">        }));</span><br/><span class="hl-1">    },</span><br/><span class="hl-1">    </span><span class="hl-0">formatPrice</span><span class="hl-4">:</span><span class="hl-1"> </span><span class="hl-7">async</span><span class="hl-1"> (</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">price</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> </span><span class="hl-4">price</span><span class="hl-1">.</span><span class="hl-0">toFixed</span><span class="hl-1">(</span><span class="hl-6">2</span><span class="hl-1">),</span><br/><span class="hl-1">    </span><span class="hl-0">formatQuantity</span><span class="hl-4">:</span><span class="hl-1"> </span><span class="hl-7">async</span><span class="hl-1"> (</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">quantity</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> </span><span class="hl-4">quantity</span><span class="hl-1">.</span><span class="hl-0">toFixed</span><span class="hl-1">(</span><span class="hl-6">8</span><span class="hl-1">),</span><br/><span class="hl-1">});</span><br/><br/><span class="hl-5">// ===== SECTION 6: Train Frames (one per training range) =====</span><br/><span class="hl-0">addFrame</span><span class="hl-1">({</span><br/><span class="hl-1">    </span><span class="hl-4">frameName:</span><span class="hl-1"> </span><span class="hl-2">&quot;a1b2c3_train_frame-1&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-4">interval:</span><span class="hl-1"> </span><span class="hl-2">&quot;1m&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-4">startDate:</span><span class="hl-1"> </span><span class="hl-7">new</span><span class="hl-1"> </span><span class="hl-0">Date</span><span class="hl-1">(</span><span class="hl-2">&quot;2024-01-01T00:00:00.000Z&quot;</span><span class="hl-1">),</span><br/><span class="hl-1">    </span><span class="hl-4">endDate:</span><span class="hl-1"> </span><span class="hl-7">new</span><span class="hl-1"> </span><span class="hl-0">Date</span><span class="hl-1">(</span><span class="hl-2">&quot;2024-02-01T00:00:00.000Z&quot;</span><span class="hl-1">),</span><br/><span class="hl-1">});</span><br/><br/><span class="hl-0">addFrame</span><span class="hl-1">({</span><br/><span class="hl-1">    </span><span class="hl-4">frameName:</span><span class="hl-1"> </span><span class="hl-2">&quot;a1b2c3_train_frame-2&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-4">interval:</span><span class="hl-1"> </span><span class="hl-2">&quot;1m&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-4">startDate:</span><span class="hl-1"> </span><span class="hl-7">new</span><span class="hl-1"> </span><span class="hl-0">Date</span><span class="hl-1">(</span><span class="hl-2">&quot;2024-02-01T00:00:00.000Z&quot;</span><span class="hl-1">),</span><br/><span class="hl-1">    </span><span class="hl-4">endDate:</span><span class="hl-1"> </span><span class="hl-7">new</span><span class="hl-1"> </span><span class="hl-0">Date</span><span class="hl-1">(</span><span class="hl-2">&quot;2024-03-01T00:00:00.000Z&quot;</span><span class="hl-1">),</span><br/><span class="hl-1">});</span><br/><br/><span class="hl-5">// ===== SECTION 7: Test Frame =====</span><br/><span class="hl-0">addFrame</span><span class="hl-1">({</span><br/><span class="hl-1">    </span><span class="hl-4">frameName:</span><span class="hl-1"> </span><span class="hl-2">&quot;a1b2c3_test_frame&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-4">interval:</span><span class="hl-1"> </span><span class="hl-2">&quot;1m&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-4">startDate:</span><span class="hl-1"> </span><span class="hl-7">new</span><span class="hl-1"> </span><span class="hl-0">Date</span><span class="hl-1">(</span><span class="hl-2">&quot;2024-03-01T00:00:00.000Z&quot;</span><span class="hl-1">),</span><br/><span class="hl-1">    </span><span class="hl-4">endDate:</span><span class="hl-1"> </span><span class="hl-7">new</span><span class="hl-1"> </span><span class="hl-0">Date</span><span class="hl-1">(</span><span class="hl-2">&quot;2024-04-01T00:00:00.000Z&quot;</span><span class="hl-1">),</span><br/><span class="hl-1">});</span><br/><br/><span class="hl-5">// ===== SECTION 8: Strategies (one per training range) =====</span><br/><span class="hl-0">addStrategy</span><span class="hl-1">({</span><br/><span class="hl-1">    </span><span class="hl-4">strategyName:</span><span class="hl-1"> </span><span class="hl-2">&quot;a1b2c3_strategy-1&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-4">interval:</span><span class="hl-1"> </span><span class="hl-2">&quot;5m&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-0">getSignal</span><span class="hl-4">:</span><span class="hl-1"> </span><span class="hl-7">async</span><span class="hl-1"> (</span><span class="hl-4">symbol</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">        </span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">messages</span><span class="hl-1"> = [];</span><br/><span class="hl-1">        </span><br/><span class="hl-1">        </span><span class="hl-5">// Load 4 timeframes</span><br/><span class="hl-1">        </span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">microTermCandles</span><span class="hl-1"> = </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-0">getCandles</span><span class="hl-1">(</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-2">&quot;1m&quot;</span><span class="hl-1">, </span><span class="hl-6">30</span><span class="hl-1">);</span><br/><span class="hl-1">        </span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">mainTermCandles</span><span class="hl-1"> = </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-0">getCandles</span><span class="hl-1">(</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-2">&quot;5m&quot;</span><span class="hl-1">, </span><span class="hl-6">24</span><span class="hl-1">);</span><br/><span class="hl-1">        </span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">shortTermCandles</span><span class="hl-1"> = </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-0">getCandles</span><span class="hl-1">(</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-2">&quot;15m&quot;</span><span class="hl-1">, </span><span class="hl-6">24</span><span class="hl-1">);</span><br/><span class="hl-1">        </span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">mediumTermCandles</span><span class="hl-1"> = </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-0">getCandles</span><span class="hl-1">(</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-2">&quot;1h&quot;</span><span class="hl-1">, </span><span class="hl-6">24</span><span class="hl-1">);</span><br/><span class="hl-1">        </span><br/><span class="hl-1">        </span><span class="hl-7">function</span><span class="hl-1"> </span><span class="hl-0">formatCandles</span><span class="hl-1">(</span><span class="hl-4">candles</span><span class="hl-1">, </span><span class="hl-4">timeframe</span><span class="hl-1">) {</span><br/><span class="hl-1">            </span><span class="hl-3">return</span><span class="hl-1"> </span><span class="hl-4">candles</span><span class="hl-1">.</span><span class="hl-0">map</span><span class="hl-1">((</span><span class="hl-4">c</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><br/><span class="hl-1">                </span><span class="hl-2">`</span><span class="hl-7">${</span><span class="hl-7">new</span><span class="hl-9"> </span><span class="hl-0">Date</span><span class="hl-9">(</span><span class="hl-4">c</span><span class="hl-9">.</span><span class="hl-4">timestamp</span><span class="hl-9">).</span><span class="hl-0">toISOString</span><span class="hl-9">()</span><span class="hl-7">}</span><span class="hl-2">[</span><span class="hl-7">${</span><span class="hl-4">timeframe</span><span class="hl-7">}</span><span class="hl-2">]: O:</span><span class="hl-7">${</span><span class="hl-4">c</span><span class="hl-9">.</span><span class="hl-4">open</span><span class="hl-7">}</span><span class="hl-2"> H:</span><span class="hl-7">${</span><span class="hl-4">c</span><span class="hl-9">.</span><span class="hl-4">high</span><span class="hl-7">}</span><span class="hl-2"> L:</span><span class="hl-7">${</span><span class="hl-4">c</span><span class="hl-9">.</span><span class="hl-4">low</span><span class="hl-7">}</span><span class="hl-2"> C:</span><span class="hl-7">${</span><span class="hl-4">c</span><span class="hl-9">.</span><span class="hl-4">close</span><span class="hl-7">}</span><span class="hl-2"> V:</span><span class="hl-7">${</span><span class="hl-4">c</span><span class="hl-9">.</span><span class="hl-4">volume</span><span class="hl-7">}</span><span class="hl-2">`</span><br/><span class="hl-1">            ).</span><span class="hl-0">join</span><span class="hl-1">(</span><span class="hl-2">&quot;</span><span class="hl-12">\n</span><span class="hl-2">&quot;</span><span class="hl-1">);</span><br/><span class="hl-1">        }</span><br/><span class="hl-1">        </span><br/><span class="hl-1">        </span><span class="hl-5">// Build 5-message conversation</span><br/><span class="hl-1">        </span><span class="hl-4">messages</span><span class="hl-1">.</span><span class="hl-0">push</span><span class="hl-1">(</span><br/><span class="hl-1">            { </span><span class="hl-4">role:</span><span class="hl-1"> </span><span class="hl-2">&quot;user&quot;</span><span class="hl-1">, </span><span class="hl-4">content:</span><span class="hl-1"> </span><span class="hl-2">&quot;Analyze 1h candles:</span><span class="hl-12">\n\n</span><span class="hl-2">&quot;</span><span class="hl-1"> + </span><span class="hl-0">formatCandles</span><span class="hl-1">(</span><span class="hl-4">mediumTermCandles</span><span class="hl-1">, </span><span class="hl-2">&quot;1h&quot;</span><span class="hl-1">) },</span><br/><span class="hl-1">            { </span><span class="hl-4">role:</span><span class="hl-1"> </span><span class="hl-2">&quot;assistant&quot;</span><span class="hl-1">, </span><span class="hl-4">content:</span><span class="hl-1"> </span><span class="hl-2">&quot;1h trend analyzed&quot;</span><span class="hl-1"> }</span><br/><span class="hl-1">        );</span><br/><span class="hl-1">        </span><span class="hl-4">messages</span><span class="hl-1">.</span><span class="hl-0">push</span><span class="hl-1">(</span><br/><span class="hl-1">            { </span><span class="hl-4">role:</span><span class="hl-1"> </span><span class="hl-2">&quot;user&quot;</span><span class="hl-1">, </span><span class="hl-4">content:</span><span class="hl-1"> </span><span class="hl-2">&quot;Analyze 15m candles:</span><span class="hl-12">\n\n</span><span class="hl-2">&quot;</span><span class="hl-1"> + </span><span class="hl-0">formatCandles</span><span class="hl-1">(</span><span class="hl-4">shortTermCandles</span><span class="hl-1">, </span><span class="hl-2">&quot;15m&quot;</span><span class="hl-1">) },</span><br/><span class="hl-1">            { </span><span class="hl-4">role:</span><span class="hl-1"> </span><span class="hl-2">&quot;assistant&quot;</span><span class="hl-1">, </span><span class="hl-4">content:</span><span class="hl-1"> </span><span class="hl-2">&quot;15m trend analyzed&quot;</span><span class="hl-1"> }</span><br/><span class="hl-1">        );</span><br/><span class="hl-1">        </span><span class="hl-4">messages</span><span class="hl-1">.</span><span class="hl-0">push</span><span class="hl-1">(</span><br/><span class="hl-1">            { </span><span class="hl-4">role:</span><span class="hl-1"> </span><span class="hl-2">&quot;user&quot;</span><span class="hl-1">, </span><span class="hl-4">content:</span><span class="hl-1"> </span><span class="hl-2">&quot;Analyze 5m candles:</span><span class="hl-12">\n\n</span><span class="hl-2">&quot;</span><span class="hl-1"> + </span><span class="hl-0">formatCandles</span><span class="hl-1">(</span><span class="hl-4">mainTermCandles</span><span class="hl-1">, </span><span class="hl-2">&quot;5m&quot;</span><span class="hl-1">) },</span><br/><span class="hl-1">            { </span><span class="hl-4">role:</span><span class="hl-1"> </span><span class="hl-2">&quot;assistant&quot;</span><span class="hl-1">, </span><span class="hl-4">content:</span><span class="hl-1"> </span><span class="hl-2">&quot;5m timeframe analyzed&quot;</span><span class="hl-1"> }</span><br/><span class="hl-1">        );</span><br/><span class="hl-1">        </span><span class="hl-4">messages</span><span class="hl-1">.</span><span class="hl-0">push</span><span class="hl-1">(</span><br/><span class="hl-1">            { </span><span class="hl-4">role:</span><span class="hl-1"> </span><span class="hl-2">&quot;user&quot;</span><span class="hl-1">, </span><span class="hl-4">content:</span><span class="hl-1"> </span><span class="hl-2">&quot;Analyze 1m candles:</span><span class="hl-12">\n\n</span><span class="hl-2">&quot;</span><span class="hl-1"> + </span><span class="hl-0">formatCandles</span><span class="hl-1">(</span><span class="hl-4">microTermCandles</span><span class="hl-1">, </span><span class="hl-2">&quot;1m&quot;</span><span class="hl-1">) },</span><br/><span class="hl-1">            { </span><span class="hl-4">role:</span><span class="hl-1"> </span><span class="hl-2">&quot;assistant&quot;</span><span class="hl-1">, </span><span class="hl-4">content:</span><span class="hl-1"> </span><span class="hl-2">&quot;1m microstructure analyzed&quot;</span><span class="hl-1"> }</span><br/><span class="hl-1">        );</span><br/><span class="hl-1">        </span><span class="hl-4">messages</span><span class="hl-1">.</span><span class="hl-0">push</span><span class="hl-1">({</span><br/><span class="hl-1">            </span><span class="hl-4">role:</span><span class="hl-1"> </span><span class="hl-2">&quot;user&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">            </span><span class="hl-4">content:</span><span class="hl-1"> </span><span class="hl-2">&quot;Generate signal according to strategy:</span><span class="hl-12">\n\n</span><span class="hl-2">[STRATEGY_PROMPT_HERE]</span><span class="hl-12">\n\n</span><span class="hl-2">If conflicting, wait&quot;</span><br/><span class="hl-1">        });</span><br/><span class="hl-1">        </span><br/><span class="hl-1">        </span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">resultId</span><span class="hl-1"> = </span><span class="hl-0">uuid</span><span class="hl-1">();</span><br/><span class="hl-1">        </span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">result</span><span class="hl-1"> = </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-0">json</span><span class="hl-1">(</span><span class="hl-4">messages</span><span class="hl-1">);</span><br/><span class="hl-1">        </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-0">dumpJson</span><span class="hl-1">(</span><span class="hl-4">resultId</span><span class="hl-1">, </span><span class="hl-4">messages</span><span class="hl-1">, </span><span class="hl-4">result</span><span class="hl-1">);</span><br/><span class="hl-1">        </span><span class="hl-4">result</span><span class="hl-1">.</span><span class="hl-4">id</span><span class="hl-1"> = </span><span class="hl-4">resultId</span><span class="hl-1">;</span><br/><span class="hl-1">        </span><br/><span class="hl-1">        </span><span class="hl-3">return</span><span class="hl-1"> </span><span class="hl-4">result</span><span class="hl-1">;</span><br/><span class="hl-1">    },</span><br/><span class="hl-1">});</span><br/><br/><span class="hl-0">addStrategy</span><span class="hl-1">({</span><br/><span class="hl-1">    </span><span class="hl-4">strategyName:</span><span class="hl-1"> </span><span class="hl-2">&quot;a1b2c3_strategy-2&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-4">interval:</span><span class="hl-1"> </span><span class="hl-2">&quot;5m&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-0">getSignal</span><span class="hl-4">:</span><span class="hl-1"> </span><span class="hl-7">async</span><span class="hl-1"> (</span><span class="hl-4">symbol</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">        </span><span class="hl-5">// Same structure, different strategy prompt</span><br/><span class="hl-1">    },</span><br/><span class="hl-1">});</span><br/><br/><span class="hl-5">// ===== SECTION 9: Walker Configuration =====</span><br/><span class="hl-0">addWalker</span><span class="hl-1">({</span><br/><span class="hl-1">    </span><span class="hl-4">walkerName:</span><span class="hl-1"> </span><span class="hl-2">&quot;a1b2c3_walker&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-4">exchangeName:</span><span class="hl-1"> </span><span class="hl-2">&quot;a1b2c3_exchange&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-4">frameName:</span><span class="hl-1"> </span><span class="hl-2">&quot;a1b2c3_test_frame&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-4">strategies:</span><span class="hl-1"> [</span><span class="hl-2">&quot;a1b2c3_strategy-1&quot;</span><span class="hl-1">, </span><span class="hl-2">&quot;a1b2c3_strategy-2&quot;</span><span class="hl-1">],</span><br/><span class="hl-1">});</span><br/><br/><span class="hl-5">// ===== SECTION 10: Launcher =====</span><br/><span class="hl-4">Walker</span><span class="hl-1">.</span><span class="hl-0">background</span><span class="hl-1">(</span><span class="hl-2">&quot;BTCUSDT&quot;</span><span class="hl-1">, {</span><br/><span class="hl-1">    </span><span class="hl-4">walkerName:</span><span class="hl-1"> </span><span class="hl-2">&quot;a1b2c3_walker&quot;</span><br/><span class="hl-1">});</span><br/><br/><span class="hl-0">listenSignalBacktest</span><span class="hl-1">((</span><span class="hl-4">event</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-4">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-4">event</span><span class="hl-1">);</span><br/><span class="hl-1">});</span><br/><br/><span class="hl-0">listenBacktestProgress</span><span class="hl-1">((</span><span class="hl-4">event</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-4">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-2">`Progress: </span><span class="hl-7">${</span><span class="hl-9">(</span><span class="hl-4">event</span><span class="hl-9">.</span><span class="hl-4">progress</span><span class="hl-9"> </span><span class="hl-1">*</span><span class="hl-9"> </span><span class="hl-6">100</span><span class="hl-9">).</span><span class="hl-0">toFixed</span><span class="hl-9">(</span><span class="hl-6">2</span><span class="hl-9">)</span><span class="hl-7">}</span><span class="hl-2">%`</span><span class="hl-1">);</span><br/><span class="hl-1">    </span><span class="hl-4">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-2">`Processed: </span><span class="hl-7">${</span><span class="hl-4">event</span><span class="hl-9">.</span><span class="hl-4">processedFrames</span><span class="hl-7">}</span><span class="hl-2"> / </span><span class="hl-7">${</span><span class="hl-4">event</span><span class="hl-9">.</span><span class="hl-4">totalFrames</span><span class="hl-7">}</span><span class="hl-2">`</span><span class="hl-1">);</span><br/><span class="hl-1">});</span><br/><br/><span class="hl-0">listenWalkerProgress</span><span class="hl-1">((</span><span class="hl-4">event</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-4">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-2">`Progress: </span><span class="hl-7">${</span><span class="hl-9">(</span><span class="hl-4">event</span><span class="hl-9">.</span><span class="hl-4">progress</span><span class="hl-9"> </span><span class="hl-1">*</span><span class="hl-9"> </span><span class="hl-6">100</span><span class="hl-9">).</span><span class="hl-0">toFixed</span><span class="hl-9">(</span><span class="hl-6">2</span><span class="hl-9">)</span><span class="hl-7">}</span><span class="hl-2">%`</span><span class="hl-1">);</span><br/><span class="hl-1">    </span><span class="hl-4">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-2">`</span><span class="hl-7">${</span><span class="hl-4">event</span><span class="hl-9">.</span><span class="hl-4">processedStrategies</span><span class="hl-7">}</span><span class="hl-2"> / </span><span class="hl-7">${</span><span class="hl-4">event</span><span class="hl-9">.</span><span class="hl-4">totalStrategies</span><span class="hl-7">}</span><span class="hl-2"> strategies`</span><span class="hl-1">);</span><br/><span class="hl-1">    </span><span class="hl-4">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-2">`Walker: </span><span class="hl-7">${</span><span class="hl-4">event</span><span class="hl-9">.</span><span class="hl-4">walkerName</span><span class="hl-7">}</span><span class="hl-2">, Symbol: </span><span class="hl-7">${</span><span class="hl-4">event</span><span class="hl-9">.</span><span class="hl-4">symbol</span><span class="hl-7">}</span><span class="hl-2">`</span><span class="hl-1">);</span><br/><span class="hl-1">});</span><br/><br/><span class="hl-0">listenWalkerComplete</span><span class="hl-1">((</span><span class="hl-4">results</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-4">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-2">&quot;Walker completed:&quot;</span><span class="hl-1">, </span><span class="hl-4">results</span><span class="hl-1">.</span><span class="hl-4">bestStrategy</span><span class="hl-1">);</span><br/><span class="hl-1">    </span><span class="hl-4">Walker</span><span class="hl-1">.</span><span class="hl-0">dump</span><span class="hl-1">(</span><span class="hl-2">&quot;BTCUSDT&quot;</span><span class="hl-1">, </span><span class="hl-4">results</span><span class="hl-1">.</span><span class="hl-4">walkerName</span><span class="hl-1">);</span><br/><span class="hl-1">});</span><br/><br/><span class="hl-0">listenDoneBacktest</span><span class="hl-1">((</span><span class="hl-4">event</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-4">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-2">&quot;Backtest completed:&quot;</span><span class="hl-1">, </span><span class="hl-4">event</span><span class="hl-1">.</span><span class="hl-4">symbol</span><span class="hl-1">);</span><br/><span class="hl-1">    </span><span class="hl-4">Backtest</span><span class="hl-1">.</span><span class="hl-0">dump</span><span class="hl-1">(</span><span class="hl-4">event</span><span class="hl-1">.</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">event</span><span class="hl-1">.</span><span class="hl-4">strategyName</span><span class="hl-1">);</span><br/><span class="hl-1">});</span><br/><br/><span class="hl-0">listenError</span><span class="hl-1">((</span><span class="hl-4">error</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-4">console</span><span class="hl-1">.</span><span class="hl-0">error</span><span class="hl-1">(</span><span class="hl-2">&quot;Error occurred:&quot;</span><span class="hl-1">, </span><span class="hl-4">error</span><span class="hl-1">);</span><br/><span class="hl-1">});</span>
</code><button type="button">Copy</button></pre>

<p><strong>Section Dependencies</strong></p>
<p><img src="../media/49_code-generation-templates_5.svg" alt="Mermaid Diagram"></p>
<hr>
<a id="llm-integration-templates" class="tsd-anchor"></a><h2 class="tsd-anchor-link">LLM Integration Templates<a href="#llm-integration-templates" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>The <code>getTextTemplate</code>, <code>getJsonTemplate</code>, and <code>getJsonDumpTemplate</code> methods generate helper functions that integrate Ollama LLM into the strategy's <code>getSignal</code> function.</p>
<p><strong>JSON Template Signal Schema</strong></p>
<p>The <code>json()</code> helper enforces a strict signal schema using Ollama's <code>format</code> parameter <code>src/lib/services/template/OptimizerTemplateService.ts:675-705</code>:</p>
<pre><code class="json"><span class="hl-1">{</span><br/><span class="hl-1">  </span><span class="hl-11">&quot;type&quot;</span><span class="hl-1">: </span><span class="hl-2">&quot;object&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-11">&quot;properties&quot;</span><span class="hl-1">: {</span><br/><span class="hl-1">    </span><span class="hl-11">&quot;position&quot;</span><span class="hl-1">: {</span><br/><span class="hl-1">      </span><span class="hl-11">&quot;type&quot;</span><span class="hl-1">: </span><span class="hl-2">&quot;string&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">      </span><span class="hl-11">&quot;enum&quot;</span><span class="hl-1">: [</span><span class="hl-2">&quot;wait&quot;</span><span class="hl-1">, </span><span class="hl-2">&quot;long&quot;</span><span class="hl-1">, </span><span class="hl-2">&quot;short&quot;</span><span class="hl-1">],</span><br/><span class="hl-1">      </span><span class="hl-11">&quot;description&quot;</span><span class="hl-1">: </span><span class="hl-2">&quot;Trade decision: wait (no signal), long (buy), or short (sell)&quot;</span><br/><span class="hl-1">    },</span><br/><span class="hl-1">    </span><span class="hl-11">&quot;note&quot;</span><span class="hl-1">: {</span><br/><span class="hl-1">      </span><span class="hl-11">&quot;type&quot;</span><span class="hl-1">: </span><span class="hl-2">&quot;string&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">      </span><span class="hl-11">&quot;description&quot;</span><span class="hl-1">: </span><span class="hl-2">&quot;Professional trading recommendation with price levels&quot;</span><br/><span class="hl-1">    },</span><br/><span class="hl-1">    </span><span class="hl-11">&quot;priceOpen&quot;</span><span class="hl-1">: {</span><br/><span class="hl-1">      </span><span class="hl-11">&quot;type&quot;</span><span class="hl-1">: </span><span class="hl-2">&quot;number&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">      </span><span class="hl-11">&quot;description&quot;</span><span class="hl-1">: </span><span class="hl-2">&quot;Entry price (current market price or limit order price)&quot;</span><br/><span class="hl-1">    },</span><br/><span class="hl-1">    </span><span class="hl-11">&quot;priceTakeProfit&quot;</span><span class="hl-1">: {</span><br/><span class="hl-1">      </span><span class="hl-11">&quot;type&quot;</span><span class="hl-1">: </span><span class="hl-2">&quot;number&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">      </span><span class="hl-11">&quot;description&quot;</span><span class="hl-1">: </span><span class="hl-2">&quot;Take profit target price&quot;</span><br/><span class="hl-1">    },</span><br/><span class="hl-1">    </span><span class="hl-11">&quot;priceStopLoss&quot;</span><span class="hl-1">: {</span><br/><span class="hl-1">      </span><span class="hl-11">&quot;type&quot;</span><span class="hl-1">: </span><span class="hl-2">&quot;number&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">      </span><span class="hl-11">&quot;description&quot;</span><span class="hl-1">: </span><span class="hl-2">&quot;Stop loss exit price&quot;</span><br/><span class="hl-1">    },</span><br/><span class="hl-1">    </span><span class="hl-11">&quot;minuteEstimatedTime&quot;</span><span class="hl-1">: {</span><br/><span class="hl-1">      </span><span class="hl-11">&quot;type&quot;</span><span class="hl-1">: </span><span class="hl-2">&quot;number&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">      </span><span class="hl-11">&quot;description&quot;</span><span class="hl-1">: </span><span class="hl-2">&quot;Expected time to reach TP in minutes (max 360)&quot;</span><br/><span class="hl-1">    }</span><br/><span class="hl-1">  },</span><br/><span class="hl-1">  </span><span class="hl-11">&quot;required&quot;</span><span class="hl-1">: [</span><span class="hl-2">&quot;position&quot;</span><span class="hl-1">, </span><span class="hl-2">&quot;note&quot;</span><span class="hl-1">, </span><span class="hl-2">&quot;priceOpen&quot;</span><span class="hl-1">, </span><span class="hl-2">&quot;priceTakeProfit&quot;</span><span class="hl-1">, </span><span class="hl-2">&quot;priceStopLoss&quot;</span><span class="hl-1">, </span><span class="hl-2">&quot;minuteEstimatedTime&quot;</span><span class="hl-1">]</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<p><strong>System Prompt for JSON Signals</strong></p>
<p>The system message defines position opening rules <code>src/lib/services/template/OptimizerTemplateService.ts:646-671</code>:</p>
<ul>
<li>Position types: <code>wait</code> (no clear signal), <code>long</code> (bullish), <code>short</code> (bearish)</li>
<li>Entry price: can be immediate (market) or delayed (limit order)</li>
<li>Exit levels: must have technical justification (Fibonacci, S/R, Bollinger)</li>
<li>Time estimates: based on ATR, ADX, MACD, Momentum, Slope (max 360 minutes)</li>
<li>TP/SL logic validation: LONG requires <code>priceTakeProfit &gt; priceOpen &gt; priceStopLoss</code>, SHORT requires <code>priceStopLoss &gt; priceOpen &gt; priceTakeProfit</code></li>
</ul>
<p><strong>Debug Output Structure</strong></p>
<p>The <code>dumpJson()</code> function saves three types of files to <code>./dump/strategy/{resultId}/</code> <code>src/lib/services/template/OptimizerTemplateService.ts:457-544</code>:</p>
<ol>
<li><code>00_system_prompt.md</code>: System messages + output JSON + result ID</li>
<li><code>{NN}_user_message.md</code>: Each user message with size warning if &gt; 100 KB</li>
<li><code>{NN+1}_llm_output.md</code>: Final LLM JSON output with result ID</li>
</ol>
<p><strong>LLM Template Workflow</strong></p>
<p><img src="../media/49_code-generation-templates_6.svg" alt="Mermaid Diagram"></p>
<hr>
<a id="code-escaping-and-security" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Code Escaping and Security<a href="#code-escaping-and-security" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>All template methods that interpolate user-provided strings perform escaping to prevent code injection. The escaping strategy varies by context:</p>
<p><strong>Escaping Patterns</strong></p>
<table>
<thead>
<tr>
<th>Context</th>
<th>Special Characters</th>
<th>Escape Method</th>
<th>Example</th>
</tr>
</thead>
<tbody>
<tr>
<td>Double-quoted strings</td>
<td><code>\</code> <code>&quot;</code></td>
<td>Backslash prefix</td>
<td><code>\&quot;optimizerName\&quot;</code></td>
</tr>
<tr>
<td>Template literals</td>
<td><code>`</code> <code>$</code></td>
<td>Backslash prefix</td>
<td><code>`symbol`</code></td>
</tr>
<tr>
<td>Plain strings</td>
<td>None</td>
<td>None</td>
<td>Used for ISO dates, static code</td>
</tr>
</tbody>
</table>
<p><strong>Escape Implementation Examples</strong></p>
<p>Strategy name escaping <code>src/lib/services/template/OptimizerTemplateService.ts:183-186</code>:</p>
<pre><code class="typescript"><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">escapedStrategyName</span><span class="hl-1"> = </span><span class="hl-0">String</span><span class="hl-1">(</span><span class="hl-4">strategyName</span><span class="hl-1">)</span><br/><span class="hl-1">  .</span><span class="hl-0">replace</span><span class="hl-1">(</span><span class="hl-15">/</span><span class="hl-12">\\</span><span class="hl-15">/</span><span class="hl-7">g</span><span class="hl-1">, </span><span class="hl-2">&#39;</span><span class="hl-12">\\\\</span><span class="hl-2">&#39;</span><span class="hl-1">)</span><br/><span class="hl-1">  .</span><span class="hl-0">replace</span><span class="hl-1">(</span><span class="hl-15">/&quot;/</span><span class="hl-7">g</span><span class="hl-1">, </span><span class="hl-2">&#39;</span><span class="hl-12">\\</span><span class="hl-2">&quot;&#39;</span><span class="hl-1">);</span>
</code><button type="button">Copy</button></pre>

<p>Prompt content escaping <code>src/lib/services/template/OptimizerTemplateService.ts:189-192</code>:</p>
<pre><code class="typescript"><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">escapedPrompt</span><span class="hl-1"> = </span><span class="hl-0">String</span><span class="hl-1">(</span><span class="hl-4">plainPrompt</span><span class="hl-1">)</span><br/><span class="hl-1">  .</span><span class="hl-0">replace</span><span class="hl-1">(</span><span class="hl-15">/</span><span class="hl-12">\\</span><span class="hl-15">/</span><span class="hl-7">g</span><span class="hl-1">, </span><span class="hl-2">&#39;</span><span class="hl-12">\\\\</span><span class="hl-2">&#39;</span><span class="hl-1">)</span><br/><span class="hl-1">  .</span><span class="hl-0">replace</span><span class="hl-1">(</span><span class="hl-15">/`/</span><span class="hl-7">g</span><span class="hl-1">, </span><span class="hl-2">&#39;</span><span class="hl-12">\\</span><span class="hl-2">`&#39;</span><span class="hl-1">)</span><br/><span class="hl-1">  .</span><span class="hl-0">replace</span><span class="hl-1">(</span><span class="hl-15">/</span><span class="hl-12">\$</span><span class="hl-15">/</span><span class="hl-7">g</span><span class="hl-1">, </span><span class="hl-2">&#39;</span><span class="hl-12">\\</span><span class="hl-2">$&#39;</span><span class="hl-1">);</span>
</code><button type="button">Copy</button></pre>

<p>Symbol escaping for template literals <code>src/lib/services/template/OptimizerTemplateService.ts:561-565</code>:</p>
<pre><code class="typescript"><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">escapedSymbol</span><span class="hl-1"> = </span><span class="hl-0">String</span><span class="hl-1">(</span><span class="hl-4">symbol</span><span class="hl-1">)</span><br/><span class="hl-1">  .</span><span class="hl-0">replace</span><span class="hl-1">(</span><span class="hl-15">/</span><span class="hl-12">\\</span><span class="hl-15">/</span><span class="hl-7">g</span><span class="hl-1">, </span><span class="hl-2">&#39;</span><span class="hl-12">\\\\</span><span class="hl-2">&#39;</span><span class="hl-1">)</span><br/><span class="hl-1">  .</span><span class="hl-0">replace</span><span class="hl-1">(</span><span class="hl-15">/`/</span><span class="hl-7">g</span><span class="hl-1">, </span><span class="hl-2">&#39;</span><span class="hl-12">\\</span><span class="hl-2">`&#39;</span><span class="hl-1">)</span><br/><span class="hl-1">  .</span><span class="hl-0">replace</span><span class="hl-1">(</span><span class="hl-15">/</span><span class="hl-12">\$</span><span class="hl-15">/</span><span class="hl-7">g</span><span class="hl-1">, </span><span class="hl-2">&#39;</span><span class="hl-12">\\</span><span class="hl-2">$&#39;</span><span class="hl-1">)</span><br/><span class="hl-1">  .</span><span class="hl-0">toUpperCase</span><span class="hl-1">();</span>
</code><button type="button">Copy</button></pre>

<p><strong>Injection Prevention</strong></p>
<p>The escaping prevents several attack vectors:</p>
<ul>
<li><strong>Command injection</strong>: Escaped backslashes prevent shell command expansion</li>
<li><strong>String termination</strong>: Escaped quotes prevent breaking out of string literals</li>
<li><strong>Variable interpolation</strong>: Escaped <code>$</code> prevents unintended template variable expansion</li>
<li><strong>Template literal escape</strong>: Escaped backticks prevent breaking out of template literals</li>
</ul>
<p>All user-controlled inputs (names, prompts, symbols) are escaped before code generation.</p>
<hr>
<a id="file-output-and-persistence" class="tsd-anchor"></a><h2 class="tsd-anchor-link">File Output and Persistence<a href="#file-output-and-persistence" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>The <code>ClientOptimizer.dump</code> method saves generated code to the file system using the <code>GET_STRATEGY_DUMP_FN</code> function <code>src/client/ClientOptimizer.ts:360-384</code>.</p>
<p><strong>Dump Workflow</strong></p>
<p><img src="../media/49_code-generation-templates_7.svg" alt="Mermaid Diagram"></p>
<p><strong>File Naming Convention</strong></p>
<p>Format: <code>{optimizerName}_{symbol}.mjs</code></p>
<p>Examples:</p>
<ul>
<li><code>&quot;momentum-optimizer_BTCUSDT.mjs&quot;</code></li>
<li><code>&quot;reversal-strategy_ETHUSDT.mjs&quot;</code></li>
<li><code>&quot;trend-following_BNBUSDT.mjs&quot;</code></li>
</ul>
<p>The <code>.mjs</code> extension indicates ES module format, allowing the file to be executed directly:</p>
<pre><code class="bash"><span class="hl-0">chmod</span><span class="hl-1"> </span><span class="hl-2">+x</span><span class="hl-1"> </span><span class="hl-2">momentum-optimizer_BTCUSDT.mjs</span><br/><span class="hl-0">./momentum-optimizer_BTCUSDT.mjs</span>
</code><button type="button">Copy</button></pre>

<p>Or with Node.js:</p>
<pre><code class="bash"><span class="hl-0">node</span><span class="hl-1"> </span><span class="hl-2">momentum-optimizer_BTCUSDT.mjs</span>
</code><button type="button">Copy</button></pre>

<p><strong>Directory Creation</strong></p>
<p>The <code>mkdir</code> call uses <code>{ recursive: true }</code> to create parent directories if they don't exist <code>src/client/ClientOptimizer.ts:369</code>. This allows paths like:</p>
<ul>
<li><code>&quot;./output/optimizers/&quot;</code> (creates <code>output</code> then <code>optimizers</code>)</li>
<li><code>&quot;./strategies/2024/Q1/&quot;</code> (creates entire nested structure)</li>
</ul>
<p><strong>Callback Integration</strong></p>
<p>After successful write, the <code>onDump</code> callback is invoked <code>src/client/ClientOptimizer.ts:377-379</code>:</p>
<pre><code class="typescript"><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-4">self</span><span class="hl-1">.</span><span class="hl-4">params</span><span class="hl-1">.</span><span class="hl-4">callbacks</span><span class="hl-1">?.</span><span class="hl-4">onDump</span><span class="hl-1">) {</span><br/><span class="hl-1">  </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-4">self</span><span class="hl-1">.</span><span class="hl-4">params</span><span class="hl-1">.</span><span class="hl-4">callbacks</span><span class="hl-1">.</span><span class="hl-0">onDump</span><span class="hl-1">(</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">filepath</span><span class="hl-1">);</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<p>This enables users to:</p>
<ul>
<li>Log to external systems</li>
<li>Trigger CI/CD pipelines</li>
<li>Update strategy registries</li>
<li>Send notifications</li>
</ul>
<hr>
<a id="public-api-usage" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Public API Usage<a href="#public-api-usage" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>Users interact with the template system through three primary methods on the <code>Optimizer</code> class.</p>
<p><strong>Optimizer API Methods</strong></p>
<table>
<thead>
<tr>
<th>Method</th>
<th>Parameters</th>
<th>Returns</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>getData</code></td>
<td>symbol, { optimizerName }</td>
<td>Promise&lt;IOptimizerStrategy[]&gt;</td>
<td>Collects data from sources, returns strategies with conversation history</td>
</tr>
<tr>
<td><code>getCode</code></td>
<td>symbol, { optimizerName }</td>
<td>Promise<string></td>
<td>Generates complete executable code</td>
</tr>
<tr>
<td><code>dump</code></td>
<td>symbol, { optimizerName }, path?</td>
<td>Promise<void></td>
<td>Saves code to file (default: <code>&quot;./&quot;</code>)</td>
</tr>
</tbody>
</table>
<p><strong>Usage Example</strong></p>
<pre><code class="typescript"><span class="hl-3">import</span><span class="hl-1"> { </span><span class="hl-4">addOptimizer</span><span class="hl-1">, </span><span class="hl-4">Optimizer</span><span class="hl-1"> } </span><span class="hl-3">from</span><span class="hl-1"> </span><span class="hl-2">&quot;backtest-kit&quot;</span><span class="hl-1">;</span><br/><br/><span class="hl-5">// 1. Register optimizer with custom templates</span><br/><span class="hl-0">addOptimizer</span><span class="hl-1">({</span><br/><span class="hl-1">  </span><span class="hl-4">optimizerName:</span><span class="hl-1"> </span><span class="hl-2">&quot;my-optimizer&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">rangeTrain:</span><span class="hl-1"> [</span><br/><span class="hl-1">    { </span><span class="hl-4">startDate:</span><span class="hl-1"> </span><span class="hl-7">new</span><span class="hl-1"> </span><span class="hl-0">Date</span><span class="hl-1">(</span><span class="hl-2">&quot;2024-01-01&quot;</span><span class="hl-1">), </span><span class="hl-4">endDate:</span><span class="hl-1"> </span><span class="hl-7">new</span><span class="hl-1"> </span><span class="hl-0">Date</span><span class="hl-1">(</span><span class="hl-2">&quot;2024-02-01&quot;</span><span class="hl-1">) }</span><br/><span class="hl-1">  ],</span><br/><span class="hl-1">  </span><span class="hl-4">rangeTest:</span><span class="hl-1"> { </span><span class="hl-4">startDate:</span><span class="hl-1"> </span><span class="hl-7">new</span><span class="hl-1"> </span><span class="hl-0">Date</span><span class="hl-1">(</span><span class="hl-2">&quot;2024-03-01&quot;</span><span class="hl-1">), </span><span class="hl-4">endDate:</span><span class="hl-1"> </span><span class="hl-7">new</span><span class="hl-1"> </span><span class="hl-0">Date</span><span class="hl-1">(</span><span class="hl-2">&quot;2024-04-01&quot;</span><span class="hl-1">) },</span><br/><span class="hl-1">  </span><span class="hl-4">source:</span><span class="hl-1"> [</span><br/><span class="hl-1">    {</span><br/><span class="hl-1">      </span><span class="hl-4">name:</span><span class="hl-1"> </span><span class="hl-2">&quot;backtest-results&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">      </span><span class="hl-0">fetch</span><span class="hl-4">:</span><span class="hl-1"> </span><span class="hl-7">async</span><span class="hl-1"> ({ </span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">startDate</span><span class="hl-1">, </span><span class="hl-4">endDate</span><span class="hl-1">, </span><span class="hl-4">limit</span><span class="hl-1">, </span><span class="hl-4">offset</span><span class="hl-1"> }) </span><span class="hl-7">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">        </span><span class="hl-5">// Fetch your training data</span><br/><span class="hl-1">        </span><span class="hl-3">return</span><span class="hl-1"> </span><span class="hl-4">data</span><span class="hl-1">;</span><br/><span class="hl-1">      }</span><br/><span class="hl-1">    }</span><br/><span class="hl-1">  ],</span><br/><span class="hl-1">  </span><span class="hl-0">getPrompt</span><span class="hl-4">:</span><span class="hl-1"> </span><span class="hl-7">async</span><span class="hl-1"> (</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">messages</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-5">// Generate strategy description from conversation</span><br/><span class="hl-1">    </span><span class="hl-3">return</span><span class="hl-1"> </span><span class="hl-2">&quot;Buy when RSI &lt; 30, sell when RSI &gt; 70&quot;</span><span class="hl-1">;</span><br/><span class="hl-1">  },</span><br/><span class="hl-1">  </span><span class="hl-4">template:</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-5">// Optional: override specific templates</span><br/><span class="hl-1">    </span><span class="hl-0">getStrategyTemplate</span><span class="hl-4">:</span><span class="hl-1"> </span><span class="hl-7">async</span><span class="hl-1"> (</span><span class="hl-4">strategyName</span><span class="hl-1">, </span><span class="hl-4">interval</span><span class="hl-1">, </span><span class="hl-4">prompt</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">      </span><span class="hl-3">return</span><span class="hl-1"> </span><span class="hl-2">`addStrategy({ strategyName: &quot;</span><span class="hl-7">${</span><span class="hl-4">strategyName</span><span class="hl-7">}</span><span class="hl-2">&quot;, ... })`</span><span class="hl-1">;</span><br/><span class="hl-1">    }</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">});</span><br/><br/><span class="hl-5">// 2. Generate and view code</span><br/><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">code</span><span class="hl-1"> = </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-4">Optimizer</span><span class="hl-1">.</span><span class="hl-0">getCode</span><span class="hl-1">(</span><span class="hl-2">&quot;BTCUSDT&quot;</span><span class="hl-1">, {</span><br/><span class="hl-1">  </span><span class="hl-4">optimizerName:</span><span class="hl-1"> </span><span class="hl-2">&quot;my-optimizer&quot;</span><br/><span class="hl-1">});</span><br/><span class="hl-4">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-4">code</span><span class="hl-1">);</span><br/><br/><span class="hl-5">// 3. Save to file</span><br/><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-4">Optimizer</span><span class="hl-1">.</span><span class="hl-0">dump</span><span class="hl-1">(</span><span class="hl-2">&quot;BTCUSDT&quot;</span><span class="hl-1">, {</span><br/><span class="hl-1">  </span><span class="hl-4">optimizerName:</span><span class="hl-1"> </span><span class="hl-2">&quot;my-optimizer&quot;</span><br/><span class="hl-1">}, </span><span class="hl-2">&quot;./output&quot;</span><span class="hl-1">);</span><br/><span class="hl-5">// Creates: ./output/my-optimizer_BTCUSDT.mjs</span><br/><br/><span class="hl-5">// 4. Get strategy data (for debugging/analysis)</span><br/><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">strategies</span><span class="hl-1"> = </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-4">Optimizer</span><span class="hl-1">.</span><span class="hl-0">getData</span><span class="hl-1">(</span><span class="hl-2">&quot;BTCUSDT&quot;</span><span class="hl-1">, {</span><br/><span class="hl-1">  </span><span class="hl-4">optimizerName:</span><span class="hl-1"> </span><span class="hl-2">&quot;my-optimizer&quot;</span><br/><span class="hl-1">});</span><br/><span class="hl-4">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-4">strategies</span><span class="hl-1">[</span><span class="hl-6">0</span><span class="hl-1">].</span><span class="hl-4">messages</span><span class="hl-1">); </span><span class="hl-5">// View LLM conversation</span><br/><span class="hl-4">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-4">strategies</span><span class="hl-1">[</span><span class="hl-6">0</span><span class="hl-1">].</span><span class="hl-4">strategy</span><span class="hl-1">); </span><span class="hl-5">// View generated strategy prompt</span>
</code><button type="button">Copy</button></pre>

<p><strong>Method Call Flow</strong></p>
<p><img src="../media/49_code-generation-templates_8.svg" alt="Mermaid Diagram"></p>
<hr>
<a id="template-system-design-rationale" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Template System Design Rationale<a href="#template-system-design-rationale" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>The template system follows several key design principles:</p>
<p><strong>1. Composability</strong>: Each template method generates a self-contained code section. Users can override individual methods without affecting others.</p>
<p><strong>2. Safety</strong>: All user inputs are escaped before code generation, preventing injection attacks.</p>
<p><strong>3. Debuggability</strong>: The <code>dumpJson</code> helper saves complete LLM conversations for analysis. Generated files include unique IDs linking signals to debug logs.</p>
<p><strong>4. Flexibility</strong>: Default templates work for common cases (CCXT + Ollama), but all methods can be overridden for custom integrations.</p>
<p><strong>5. Memoization</strong>: <code>OptimizerConnectionService</code> caches optimizer instances, so template merging happens only once per optimizer name.</p>
<p><strong>6. Separation of Concerns</strong>: Templates generate code; ClientOptimizer orchestrates assembly; ConnectionService handles instantiation; GlobalService validates.</p>
<p><strong>Architecture Alignment</strong></p>
<p>The template system integrates with the broader optimizer architecture as follows:</p>
<ul>
<li><strong>Schema Layer</strong>: <code>IOptimizerSchema</code> defines <code>template?: Partial&lt;IOptimizerTemplate&gt;</code> for customization</li>
<li><strong>Connection Layer</strong>: <code>OptimizerConnectionService</code> merges custom and default templates</li>
<li><strong>Client Layer</strong>: <code>ClientOptimizer</code> calls template methods to generate code sections</li>
<li><strong>Template Layer</strong>: <code>OptimizerTemplateService</code> provides sensible defaults</li>
<li><strong>Validation Layer</strong>: <code>OptimizerValidationService</code> ensures optimizer exists before template usage</li>
</ul>
</div></div><div class="col-sidebar"><div class="page-menu"><div class="tsd-navigation settings"><details class="tsd-accordion"><summary class="tsd-accordion-summary"><h3><svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-chevronDown"></use></svg>Settings</h3></summary><div class="tsd-accordion-details"><div class="tsd-filter-visibility"><span class="settings-label">Member Visibility</span><ul id="tsd-filter-options"><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-protected" name="protected"/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Protected</span></label></li><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-inherited" name="inherited" checked/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Inherited</span></label></li><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-external" name="external"/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>External</span></label></li></ul></div><div class="tsd-theme-toggle"><label class="settings-label" for="tsd-theme">Theme</label><select id="tsd-theme"><option value="os">OS</option><option value="light">Light</option><option value="dark">Dark</option></select></div></div></details></div><details open class="tsd-accordion tsd-page-navigation"><summary class="tsd-accordion-summary"><h3><svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-chevronDown"></use></svg>On This Page</h3></summary><div class="tsd-accordion-details"><a href="#code-generation--templates"><span>Code <wbr/>Generation &amp; <wbr/>Templates</span></a><ul><li><a href="#template-system-overview"><span>Template <wbr/>System <wbr/>Overview</span></a></li><li><a href="#ioptimizertemplate-interface"><span>IOptimizer<wbr/>Template <wbr/>Interface</span></a></li><li><a href="#optimizertemplateservice-default-implementation"><span>Optimizer<wbr/>Template<wbr/>Service <wbr/>Default <wbr/>Implementation</span></a></li><li><a href="#code-generation-workflow-in-clientoptimizer"><span>Code <wbr/>Generation <wbr/>Workflow in <wbr/>Client<wbr/>Optimizer</span></a></li><li><a href="#template-customization"><span>Template <wbr/>Customization</span></a></li><li><a href="#generated-code-structure"><span>Generated <wbr/>Code <wbr/>Structure</span></a></li><li><a href="#llm-integration-templates"><span>LLM <wbr/>Integration <wbr/>Templates</span></a></li><li><a href="#code-escaping-and-security"><span>Code <wbr/>Escaping and <wbr/>Security</span></a></li><li><a href="#file-output-and-persistence"><span>File <wbr/>Output and <wbr/>Persistence</span></a></li><li><a href="#public-api-usage"><span>Public API <wbr/>Usage</span></a></li><li><a href="#template-system-design-rationale"><span>Template <wbr/>System <wbr/>Design <wbr/>Rationale</span></a></li></ul></div></details></div><div class="site-menu"><nav class="tsd-navigation"><a href="../modules.html">backtest-kit</a><ul class="tsd-small-nested-navigation" id="tsd-nav-container"><li>Loading...</li></ul></nav></div></div></div><footer><p class="tsd-generator">Generated using <a href="https://typedoc.org/" target="_blank">TypeDoc</a></p></footer><div class="overlay"></div></body></html>

<!-- Yandex.Metrika counter -->
<script type="text/javascript">
    (function(m,e,t,r,i,k,a){
        m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
        m[i].l=1*new Date();
        for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }}
        k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)
    })(window, document,'script','https://mc.yandex.ru/metrika/tag.js?id=105455585', 'ym');

    ym(105455585, 'init', {ssr:true, webvisor:true, clickmap:true, ecommerce:"dataLayer", accurateTrackBounce:true, trackLinks:true});
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/105455585" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
<!-- /Yandex.Metrika counter -->

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-3MQZEBBDDR"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-3MQZEBBDDR');
</script>
