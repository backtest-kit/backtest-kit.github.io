<!DOCTYPE html><html class="default" lang="en" data-base=".."><head><meta charset="utf-8"/><meta http-equiv="x-ua-compatible" content="IE=edge"/><title>design/33_signal-validation-pipeline | backtest-kit</title><meta name="description" content="Documentation for backtest-kit"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="stylesheet" href="../assets/style.css"/><link rel="stylesheet" href="../assets/highlight.css"/><script defer src="../assets/main.js"></script><script async src="../assets/icons.js" id="tsd-icons-script"></script><script async src="../assets/search.js" id="tsd-search-script"></script><script async src="../assets/navigation.js" id="tsd-nav-script"></script><script async src="../assets/hierarchy.js" id="tsd-hierarchy-script"></script></head><body><script>document.documentElement.dataset.theme = localStorage.getItem("tsd-theme") || "os";document.body.style.display="none";setTimeout(() => app?app.showPage():document.body.style.removeProperty("display"),500)</script><header class="tsd-page-toolbar"><div class="tsd-toolbar-contents container"><div class="table-cell" id="tsd-search"><div class="field"><label for="tsd-search-field" class="tsd-widget tsd-toolbar-icon search no-caption"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-search"></use></svg></label><input type="text" id="tsd-search-field" aria-label="Search"/></div><div class="field"><div id="tsd-toolbar-links"></div></div><ul class="results"><li class="state loading">Preparing search index...</li><li class="state failure">The search index is not available</li></ul><a href="../index.html" class="title">backtest-kit</a></div><div class="table-cell" id="tsd-widgets"><a href="#" class="tsd-widget tsd-toolbar-icon menu no-caption" data-toggle="menu" aria-label="Menu"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-menu"></use></svg></a></div></div></header><div class="container container-main"><div class="col-content"><div class="tsd-page-title"><ul class="tsd-breadcrumb"><li><a href="../modules.html">backtest-kit</a></li><li><a href="design_33_signal-validation-pipeline.html">design/33_signal-validation-pipeline</a></li></ul></div><div class="tsd-panel tsd-typography"><a id="signal-validation-pipeline" class="tsd-anchor"></a><h1 class="tsd-anchor-link">Signal Validation Pipeline<a href="#signal-validation-pipeline" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h1><a id="purpose-and-scope" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Purpose and Scope<a href="#purpose-and-scope" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>This page documents the multi-stage validation pipeline that every trading signal passes through before execution. The validation system ensures signals meet structural, logical, and risk requirements to prevent catastrophic losses from malformed signals, protect capital from extreme risk exposure, and enforce profitability constraints that account for trading costs.</p>
<p>For information about defining custom risk validation rules beyond the built-in checks, see <a href="design_31_risk-management.html">Risk Profiles &amp; Validation</a>. For portfolio-wide position limits and concurrent signal management, see <a href="design_31_risk-management.html">Portfolio-Wide Limits</a>.</p>
<hr>
<a id="validation-pipeline-overview" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Validation Pipeline Overview<a href="#validation-pipeline-overview" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p><img src="../media/33_signal-validation-pipeline_0.svg" alt="Mermaid Diagram"></p>
<p><strong>Validation Pipeline Stages</strong></p>
<p>The validation occurs in <code>VALIDATE_SIGNAL_FN</code> within <code>ClientStrategy</code>, called from <code>GET_SIGNAL_FN</code> before signal creation. Each stage checks specific constraints and accumulates error messages. If any validation fails, an error with all violation descriptions is thrown, preventing signal execution.</p>
<hr>
<a id="schema-and-type-validation" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Schema and Type Validation<a href="#schema-and-type-validation" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><a id="required-fields" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Required Fields<a href="#required-fields" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>The first validation stage ensures all required <code>ISignalRow</code> fields are present and non-empty:</p>
<table>
<thead>
<tr>
<th>Field</th>
<th>Requirement</th>
<th>Error if Invalid</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>id</code></td>
<td>Non-empty string</td>
<td>&quot;id is required and must be a non-empty string&quot;</td>
</tr>
<tr>
<td><code>exchangeName</code></td>
<td>Non-empty string</td>
<td>&quot;exchangeName is required&quot;</td>
</tr>
<tr>
<td><code>strategyName</code></td>
<td>Non-empty string</td>
<td>&quot;strategyName is required&quot;</td>
</tr>
<tr>
<td><code>symbol</code></td>
<td>Non-empty string</td>
<td>&quot;symbol is required and must be a non-empty string&quot;</td>
</tr>
<tr>
<td><code>_isScheduled</code></td>
<td>Boolean (not null/undefined)</td>
<td>&quot;_isScheduled is required&quot;</td>
</tr>
<tr>
<td><code>position</code></td>
<td>&quot;long&quot; or &quot;short&quot;</td>
<td>'position must be &quot;long&quot; or &quot;short&quot;'</td>
</tr>
</tbody>
</table>
<hr>
<a id="price-validation" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Price Validation<a href="#price-validation" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><a id="nan-and-infinity-protection" class="tsd-anchor"></a><h3 class="tsd-anchor-link">NaN and Infinity Protection<a href="#nan-and-infinity-protection" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><strong>Critical</strong>: All prices must be finite numbers. Incomplete candle data from exchanges can contain <code>NaN</code>, <code>Infinity</code>, or near-zero prices that would corrupt PNL calculations.</p>
<p><img src="../media/33_signal-validation-pipeline_1.svg" alt="Mermaid Diagram"></p>
<p><strong>Checks performed:</strong></p>
<ol>
<li>
<p><strong>Finite Number Check</strong>: <code>isFinite(price)</code> must be true</p>
<ul>
<li>Rejects <code>NaN</code>: &quot;must be a finite number, got NaN&quot;</li>
<li>Rejects <code>Infinity</code>: &quot;must be a finite number, got Infinity&quot;</li>
</ul>
</li>
<li>
<p><strong>Positive Price Check</strong>: <code>price &gt; 0</code> must be true</p>
<ul>
<li>Rejects zero: &quot;must be positive, got 0&quot;</li>
<li>Rejects negative: &quot;must be positive, got -1234&quot;</li>
</ul>
</li>
</ol>
<hr>
<a id="position-logic-validation" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Position Logic Validation<a href="#position-logic-validation" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><a id="long-position-requirements" class="tsd-anchor"></a><h3 class="tsd-anchor-link">LONG Position Requirements<a href="#long-position-requirements" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>For <code>position: &quot;long&quot;</code> signals, the price order must be: <strong>priceStopLoss &lt; priceOpen &lt; priceTakeProfit</strong></p>
<pre><code class="typescript"><span class="hl-5">// LONG validation checks</span><br/><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-4">priceTakeProfit</span><span class="hl-1"> &lt;= </span><span class="hl-4">priceOpen</span><span class="hl-1">) {</span><br/><span class="hl-1">  </span><span class="hl-4">errors</span><span class="hl-1">.</span><span class="hl-0">push</span><span class="hl-1">(</span><span class="hl-2">&quot;Long: priceTakeProfit must be &gt; priceOpen&quot;</span><span class="hl-1">);</span><br/><span class="hl-1">}</span><br/><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-4">priceStopLoss</span><span class="hl-1"> &gt;= </span><span class="hl-4">priceOpen</span><span class="hl-1">) {</span><br/><span class="hl-1">  </span><span class="hl-4">errors</span><span class="hl-1">.</span><span class="hl-0">push</span><span class="hl-1">(</span><span class="hl-2">&quot;Long: priceStopLoss must be &lt; priceOpen&quot;</span><span class="hl-1">);</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<p><strong>Rationale</strong>: For long positions, profit is made when price rises above entry, losses occur when price falls below entry.</p>
<a id="short-position-requirements" class="tsd-anchor"></a><h3 class="tsd-anchor-link">SHORT Position Requirements<a href="#short-position-requirements" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>For <code>position: &quot;short&quot;</code> signals, the price order must be: <strong>priceTakeProfit &lt; priceOpen &lt; priceStopLoss</strong></p>
<pre><code class="typescript"><span class="hl-5">// SHORT validation checks</span><br/><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-4">priceTakeProfit</span><span class="hl-1"> &gt;= </span><span class="hl-4">priceOpen</span><span class="hl-1">) {</span><br/><span class="hl-1">  </span><span class="hl-4">errors</span><span class="hl-1">.</span><span class="hl-0">push</span><span class="hl-1">(</span><span class="hl-2">&quot;Short: priceTakeProfit must be &lt; priceOpen&quot;</span><span class="hl-1">);</span><br/><span class="hl-1">}</span><br/><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-4">priceStopLoss</span><span class="hl-1"> &lt;= </span><span class="hl-4">priceOpen</span><span class="hl-1">) {</span><br/><span class="hl-1">  </span><span class="hl-4">errors</span><span class="hl-1">.</span><span class="hl-0">push</span><span class="hl-1">(</span><span class="hl-2">&quot;Short: priceStopLoss must be &gt; priceOpen&quot;</span><span class="hl-1">);</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<p><strong>Rationale</strong>: For short positions, profit is made when price falls below entry, losses occur when price rises above entry.</p>
<hr>
<a id="immediate-closure-prevention" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Immediate Closure Prevention<a href="#immediate-closure-prevention" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><a id="for-immediate-market-signals" class="tsd-anchor"></a><h3 class="tsd-anchor-link">For Immediate (Market) Signals<a href="#for-immediate-market-signals" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>When <code>priceOpen</code> equals <code>currentPrice</code> (or is omitted), the signal opens immediately. The system prevents &quot;open-and-immediately-close&quot; scenarios:</p>
<p><strong>LONG Immediate Signal Checks:</strong></p>
<pre><code class="typescript"><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-4">currentPrice</span><span class="hl-1"> &lt;= </span><span class="hl-4">priceStopLoss</span><span class="hl-1">) {</span><br/><span class="hl-1">  </span><span class="hl-4">errors</span><span class="hl-1">.</span><span class="hl-0">push</span><span class="hl-1">(</span><span class="hl-2">&quot;Long immediate: currentPrice &lt;= priceStopLoss. &quot;</span><span class="hl-1"> +</span><br/><span class="hl-1">    </span><span class="hl-2">&quot;Signal would be immediately closed by stop loss.&quot;</span><span class="hl-1">);</span><br/><span class="hl-1">}</span><br/><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-4">currentPrice</span><span class="hl-1"> &gt;= </span><span class="hl-4">priceTakeProfit</span><span class="hl-1">) {</span><br/><span class="hl-1">  </span><span class="hl-4">errors</span><span class="hl-1">.</span><span class="hl-0">push</span><span class="hl-1">(</span><span class="hl-2">&quot;Long immediate: currentPrice &gt;= priceTakeProfit. &quot;</span><span class="hl-1"> +</span><br/><span class="hl-1">    </span><span class="hl-2">&quot;The profit opportunity has already passed.&quot;</span><span class="hl-1">);</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<p><strong>Valid state for LONG</strong>: <code>priceStopLoss &lt; currentPrice &lt; priceTakeProfit</code></p>
<p><strong>SHORT Immediate Signal Checks:</strong></p>
<pre><code class="typescript"><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-4">currentPrice</span><span class="hl-1"> &gt;= </span><span class="hl-4">priceStopLoss</span><span class="hl-1">) {</span><br/><span class="hl-1">  </span><span class="hl-4">errors</span><span class="hl-1">.</span><span class="hl-0">push</span><span class="hl-1">(</span><span class="hl-2">&quot;Short immediate: currentPrice &gt;= priceStopLoss. &quot;</span><span class="hl-1"> +</span><br/><span class="hl-1">    </span><span class="hl-2">&quot;Signal would be immediately closed by stop loss.&quot;</span><span class="hl-1">);</span><br/><span class="hl-1">}</span><br/><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-4">currentPrice</span><span class="hl-1"> &lt;= </span><span class="hl-4">priceTakeProfit</span><span class="hl-1">) {</span><br/><span class="hl-1">  </span><span class="hl-4">errors</span><span class="hl-1">.</span><span class="hl-0">push</span><span class="hl-1">(</span><span class="hl-2">&quot;Short immediate: currentPrice &lt;= priceTakeProfit. &quot;</span><span class="hl-1"> +</span><br/><span class="hl-1">    </span><span class="hl-2">&quot;The profit opportunity has already passed.&quot;</span><span class="hl-1">);</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<p><strong>Valid state for SHORT</strong>: <code>priceTakeProfit &lt; currentPrice &lt; priceStopLoss</code></p>
<a id="for-scheduled-limit-signals" class="tsd-anchor"></a><h3 class="tsd-anchor-link">For Scheduled (Limit) Signals<a href="#for-scheduled-limit-signals" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>When <code>priceOpen</code> differs from <code>currentPrice</code>, the signal enters scheduled state. The system validates that <code>priceOpen</code> itself won't trigger immediate closure upon activation:</p>
<p><strong>LONG Scheduled Signal Checks:</strong></p>
<pre><code class="typescript"><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-4">priceOpen</span><span class="hl-1"> &lt;= </span><span class="hl-4">priceStopLoss</span><span class="hl-1">) {</span><br/><span class="hl-1">  </span><span class="hl-4">errors</span><span class="hl-1">.</span><span class="hl-0">push</span><span class="hl-1">(</span><span class="hl-2">&quot;Long scheduled: priceOpen &lt;= priceStopLoss. &quot;</span><span class="hl-1"> +</span><br/><span class="hl-1">    </span><span class="hl-2">&quot;Signal would be immediately cancelled on activation.&quot;</span><span class="hl-1">);</span><br/><span class="hl-1">}</span><br/><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-4">priceOpen</span><span class="hl-1"> &gt;= </span><span class="hl-4">priceTakeProfit</span><span class="hl-1">) {</span><br/><span class="hl-1">  </span><span class="hl-4">errors</span><span class="hl-1">.</span><span class="hl-0">push</span><span class="hl-1">(</span><span class="hl-2">&quot;Long scheduled: priceOpen &gt;= priceTakeProfit. &quot;</span><span class="hl-1"> +</span><br/><span class="hl-1">    </span><span class="hl-2">&quot;This is logically impossible for LONG position.&quot;</span><span class="hl-1">);</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<p><strong>SHORT Scheduled Signal Checks:</strong></p>
<pre><code class="typescript"><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-4">priceOpen</span><span class="hl-1"> &gt;= </span><span class="hl-4">priceStopLoss</span><span class="hl-1">) {</span><br/><span class="hl-1">  </span><span class="hl-4">errors</span><span class="hl-1">.</span><span class="hl-0">push</span><span class="hl-1">(</span><span class="hl-2">&quot;Short scheduled: priceOpen &gt;= priceStopLoss. &quot;</span><span class="hl-1"> +</span><br/><span class="hl-1">    </span><span class="hl-2">&quot;Signal would be immediately cancelled on activation.&quot;</span><span class="hl-1">);</span><br/><span class="hl-1">}</span><br/><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-4">priceOpen</span><span class="hl-1"> &lt;= </span><span class="hl-4">priceTakeProfit</span><span class="hl-1">) {</span><br/><span class="hl-1">  </span><span class="hl-4">errors</span><span class="hl-1">.</span><span class="hl-0">push</span><span class="hl-1">(</span><span class="hl-2">&quot;Short scheduled: priceOpen &lt;= priceTakeProfit. &quot;</span><span class="hl-1"> +</span><br/><span class="hl-1">    </span><span class="hl-2">&quot;This is logically impossible for SHORT position.&quot;</span><span class="hl-1">);</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<hr>
<a id="distance-requirements" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Distance Requirements<a href="#distance-requirements" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><a id="minimum-takeprofit-distance" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Minimum TakeProfit Distance<a href="#minimum-takeprofit-distance" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><strong>Purpose</strong>: Ensures profit target is far enough to cover trading costs (fees + slippage).</p>
<p><strong>Configuration</strong>: <code>GLOBAL_CONFIG.CC_MIN_TAKEPROFIT_DISTANCE_PERCENT</code> (default: 0.5%)</p>
<p><strong>Trading Cost Breakdown:</strong></p>
<ul>
<li>Entry fee: 0.1%</li>
<li>Exit fee: 0.1%</li>
<li>Entry slippage: ~0.1%</li>
<li>Exit slippage: ~0.1%</li>
<li><strong>Total overhead</strong>: ~0.4%</li>
</ul>
<p>The default 0.5% minimum ensures at least 0.1% net profit margin after costs.</p>
<p><strong>LONG TP Distance Calculation:</strong></p>
<pre><code class="typescript"><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">tpDistancePercent</span><span class="hl-1"> = ((</span><span class="hl-4">priceTakeProfit</span><span class="hl-1"> - </span><span class="hl-4">priceOpen</span><span class="hl-1">) / </span><span class="hl-4">priceOpen</span><span class="hl-1">) * </span><span class="hl-6">100</span><span class="hl-1">;</span><br/><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-4">tpDistancePercent</span><span class="hl-1"> &lt; </span><span class="hl-8">CC_MIN_TAKEPROFIT_DISTANCE_PERCENT</span><span class="hl-1">) {</span><br/><span class="hl-1">  </span><span class="hl-4">errors</span><span class="hl-1">.</span><span class="hl-0">push</span><span class="hl-1">(</span><span class="hl-2">`Long: TakeProfit too close to priceOpen (</span><span class="hl-7">${</span><span class="hl-4">tpDistancePercent</span><span class="hl-9">.</span><span class="hl-0">toFixed</span><span class="hl-9">(</span><span class="hl-6">3</span><span class="hl-9">)</span><span class="hl-7">}</span><span class="hl-2">%). `</span><span class="hl-1"> +</span><br/><span class="hl-1">    </span><span class="hl-2">`Minimum distance: </span><span class="hl-7">${</span><span class="hl-8">CC_MIN_TAKEPROFIT_DISTANCE_PERCENT</span><span class="hl-7">}</span><span class="hl-2">% to cover trading fees.`</span><span class="hl-1">);</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<p><strong>SHORT TP Distance Calculation:</strong></p>
<pre><code class="typescript"><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">tpDistancePercent</span><span class="hl-1"> = ((</span><span class="hl-4">priceOpen</span><span class="hl-1"> - </span><span class="hl-4">priceTakeProfit</span><span class="hl-1">) / </span><span class="hl-4">priceOpen</span><span class="hl-1">) * </span><span class="hl-6">100</span><span class="hl-1">;</span><br/><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-4">tpDistancePercent</span><span class="hl-1"> &lt; </span><span class="hl-8">CC_MIN_TAKEPROFIT_DISTANCE_PERCENT</span><span class="hl-1">) {</span><br/><span class="hl-1">  </span><span class="hl-4">errors</span><span class="hl-1">.</span><span class="hl-0">push</span><span class="hl-1">(</span><span class="hl-2">`Short: TakeProfit too close to priceOpen (</span><span class="hl-7">${</span><span class="hl-4">tpDistancePercent</span><span class="hl-9">.</span><span class="hl-0">toFixed</span><span class="hl-9">(</span><span class="hl-6">3</span><span class="hl-9">)</span><span class="hl-7">}</span><span class="hl-2">%). `</span><span class="hl-1"> +</span><br/><span class="hl-1">    </span><span class="hl-2">`Minimum distance: </span><span class="hl-7">${</span><span class="hl-8">CC_MIN_TAKEPROFIT_DISTANCE_PERCENT</span><span class="hl-7">}</span><span class="hl-2">% to cover trading fees.`</span><span class="hl-1">);</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<a id="minimum-stoploss-distance" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Minimum StopLoss Distance<a href="#minimum-stoploss-distance" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><strong>Purpose</strong>: Prevents instant stop-out from normal market volatility.</p>
<p><strong>Configuration</strong>: <code>GLOBAL_CONFIG.CC_MIN_STOPLOSS_DISTANCE_PERCENT</code> (default: 0.5%)</p>
<p><strong>LONG SL Distance Calculation:</strong></p>
<pre><code class="typescript"><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">slDistancePercent</span><span class="hl-1"> = ((</span><span class="hl-4">priceOpen</span><span class="hl-1"> - </span><span class="hl-4">priceStopLoss</span><span class="hl-1">) / </span><span class="hl-4">priceOpen</span><span class="hl-1">) * </span><span class="hl-6">100</span><span class="hl-1">;</span><br/><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-4">slDistancePercent</span><span class="hl-1"> &lt; </span><span class="hl-8">CC_MIN_STOPLOSS_DISTANCE_PERCENT</span><span class="hl-1">) {</span><br/><span class="hl-1">  </span><span class="hl-4">errors</span><span class="hl-1">.</span><span class="hl-0">push</span><span class="hl-1">(</span><span class="hl-2">`Long: StopLoss too close to priceOpen (</span><span class="hl-7">${</span><span class="hl-4">slDistancePercent</span><span class="hl-9">.</span><span class="hl-0">toFixed</span><span class="hl-9">(</span><span class="hl-6">3</span><span class="hl-9">)</span><span class="hl-7">}</span><span class="hl-2">%). `</span><span class="hl-1"> +</span><br/><span class="hl-1">    </span><span class="hl-2">`Minimum distance: </span><span class="hl-7">${</span><span class="hl-8">CC_MIN_STOPLOSS_DISTANCE_PERCENT</span><span class="hl-7">}</span><span class="hl-2">% to avoid instant stop out.`</span><span class="hl-1">);</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<p><strong>SHORT SL Distance Calculation:</strong></p>
<pre><code class="typescript"><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">slDistancePercent</span><span class="hl-1"> = ((</span><span class="hl-4">priceStopLoss</span><span class="hl-1"> - </span><span class="hl-4">priceOpen</span><span class="hl-1">) / </span><span class="hl-4">priceOpen</span><span class="hl-1">) * </span><span class="hl-6">100</span><span class="hl-1">;</span><br/><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-4">slDistancePercent</span><span class="hl-1"> &lt; </span><span class="hl-8">CC_MIN_STOPLOSS_DISTANCE_PERCENT</span><span class="hl-1">) {</span><br/><span class="hl-1">  </span><span class="hl-4">errors</span><span class="hl-1">.</span><span class="hl-0">push</span><span class="hl-1">(</span><span class="hl-2">`Short: StopLoss too close to priceOpen (</span><span class="hl-7">${</span><span class="hl-4">slDistancePercent</span><span class="hl-9">.</span><span class="hl-0">toFixed</span><span class="hl-9">(</span><span class="hl-6">3</span><span class="hl-9">)</span><span class="hl-7">}</span><span class="hl-2">%). `</span><span class="hl-1"> +</span><br/><span class="hl-1">    </span><span class="hl-2">`Minimum distance: </span><span class="hl-7">${</span><span class="hl-8">CC_MIN_STOPLOSS_DISTANCE_PERCENT</span><span class="hl-7">}</span><span class="hl-2">% to avoid instant stop out.`</span><span class="hl-1">);</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<a id="maximum-stoploss-distance" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Maximum StopLoss Distance<a href="#maximum-stoploss-distance" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><strong>Purpose</strong>: Caps maximum loss per signal to protect capital from catastrophic single-trade losses.</p>
<p><strong>Configuration</strong>: <code>GLOBAL_CONFIG.CC_MAX_STOPLOSS_DISTANCE_PERCENT</code> (default: 20%)</p>
<p><strong>Example</strong>: With 20% limit, a single signal cannot lose more than 20% of position size, even if price drops 50%.</p>
<p><strong>LONG Max SL Check:</strong></p>
<pre><code class="typescript"><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">slDistancePercent</span><span class="hl-1"> = ((</span><span class="hl-4">priceOpen</span><span class="hl-1"> - </span><span class="hl-4">priceStopLoss</span><span class="hl-1">) / </span><span class="hl-4">priceOpen</span><span class="hl-1">) * </span><span class="hl-6">100</span><span class="hl-1">;</span><br/><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-4">slDistancePercent</span><span class="hl-1"> &gt; </span><span class="hl-8">CC_MAX_STOPLOSS_DISTANCE_PERCENT</span><span class="hl-1">) {</span><br/><span class="hl-1">  </span><span class="hl-4">errors</span><span class="hl-1">.</span><span class="hl-0">push</span><span class="hl-1">(</span><span class="hl-2">`Long: StopLoss too far from priceOpen (</span><span class="hl-7">${</span><span class="hl-4">slDistancePercent</span><span class="hl-9">.</span><span class="hl-0">toFixed</span><span class="hl-9">(</span><span class="hl-6">3</span><span class="hl-9">)</span><span class="hl-7">}</span><span class="hl-2">%). `</span><span class="hl-1"> +</span><br/><span class="hl-1">    </span><span class="hl-2">`Maximum distance: </span><span class="hl-7">${</span><span class="hl-8">CC_MAX_STOPLOSS_DISTANCE_PERCENT</span><span class="hl-7">}</span><span class="hl-2">% to protect capital.`</span><span class="hl-1">);</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<p><strong>SHORT Max SL Check:</strong></p>
<pre><code class="typescript"><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">slDistancePercent</span><span class="hl-1"> = ((</span><span class="hl-4">priceStopLoss</span><span class="hl-1"> - </span><span class="hl-4">priceOpen</span><span class="hl-1">) / </span><span class="hl-4">priceOpen</span><span class="hl-1">) * </span><span class="hl-6">100</span><span class="hl-1">;</span><br/><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-4">slDistancePercent</span><span class="hl-1"> &gt; </span><span class="hl-8">CC_MAX_STOPLOSS_DISTANCE_PERCENT</span><span class="hl-1">) {</span><br/><span class="hl-1">  </span><span class="hl-4">errors</span><span class="hl-1">.</span><span class="hl-0">push</span><span class="hl-1">(</span><span class="hl-2">`Short: StopLoss too far from priceOpen (</span><span class="hl-7">${</span><span class="hl-4">slDistancePercent</span><span class="hl-9">.</span><span class="hl-0">toFixed</span><span class="hl-9">(</span><span class="hl-6">3</span><span class="hl-9">)</span><span class="hl-7">}</span><span class="hl-2">%). `</span><span class="hl-1"> +</span><br/><span class="hl-1">    </span><span class="hl-2">`Maximum distance: </span><span class="hl-7">${</span><span class="hl-8">CC_MAX_STOPLOSS_DISTANCE_PERCENT</span><span class="hl-7">}</span><span class="hl-2">% to protect capital.`</span><span class="hl-1">);</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<hr>
<a id="lifetime-limits" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Lifetime Limits<a href="#lifetime-limits" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><a id="maximum-signal-lifetime" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Maximum Signal Lifetime<a href="#maximum-signal-lifetime" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><strong>Purpose</strong>: Prevents &quot;eternal signals&quot; that block risk limits indefinitely, causing strategy deadlock.</p>
<p><strong>Configuration</strong>: <code>GLOBAL_CONFIG.CC_MAX_SIGNAL_LIFETIME_MINUTES</code> (default: 1,440 minutes = 1 day)</p>
<p><strong>Problem Scenario</strong>: A signal with <code>minuteEstimatedTime: 50000</code> (34 days) occupies risk limits for over a month, preventing new signals from executing even when opportunities arise.</p>
<p><strong>Validation:</strong></p>
<pre><code class="typescript"><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-4">minuteEstimatedTime</span><span class="hl-1"> &gt; </span><span class="hl-8">CC_MAX_SIGNAL_LIFETIME_MINUTES</span><span class="hl-1">) {</span><br/><span class="hl-1">  </span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">days</span><span class="hl-1"> = (</span><span class="hl-4">minuteEstimatedTime</span><span class="hl-1"> / </span><span class="hl-6">60</span><span class="hl-1"> / </span><span class="hl-6">24</span><span class="hl-1">).</span><span class="hl-0">toFixed</span><span class="hl-1">(</span><span class="hl-6">1</span><span class="hl-1">);</span><br/><span class="hl-1">  </span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">maxDays</span><span class="hl-1"> = (</span><span class="hl-8">CC_MAX_SIGNAL_LIFETIME_MINUTES</span><span class="hl-1"> / </span><span class="hl-6">60</span><span class="hl-1"> / </span><span class="hl-6">24</span><span class="hl-1">).</span><span class="hl-0">toFixed</span><span class="hl-1">(</span><span class="hl-6">0</span><span class="hl-1">);</span><br/><span class="hl-1">  </span><span class="hl-4">errors</span><span class="hl-1">.</span><span class="hl-0">push</span><span class="hl-1">(</span><br/><span class="hl-1">    </span><span class="hl-2">`minuteEstimatedTime too large (</span><span class="hl-7">${</span><span class="hl-4">minuteEstimatedTime</span><span class="hl-7">}</span><span class="hl-2"> minutes = </span><span class="hl-7">${</span><span class="hl-4">days</span><span class="hl-7">}</span><span class="hl-2"> days). `</span><span class="hl-1"> +</span><br/><span class="hl-1">    </span><span class="hl-2">`Maximum: </span><span class="hl-7">${</span><span class="hl-8">CC_MAX_SIGNAL_LIFETIME_MINUTES</span><span class="hl-7">}</span><span class="hl-2"> minutes (</span><span class="hl-7">${</span><span class="hl-4">maxDays</span><span class="hl-7">}</span><span class="hl-2"> days) to prevent strategy deadlock. `</span><span class="hl-1"> +</span><br/><span class="hl-1">    </span><span class="hl-2">`Eternal signals block risk limits and prevent new trades.`</span><br/><span class="hl-1">  );</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<a id="time-parameter-validation" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Time Parameter Validation<a href="#time-parameter-validation" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><strong>minuteEstimatedTime Requirements:</strong></p>
<ul>
<li>Must be positive: <code>minuteEstimatedTime &gt; 0</code></li>
<li>Must be integer: <code>Number.isInteger(minuteEstimatedTime)</code></li>
</ul>
<p><strong>scheduledAt and pendingAt Requirements:</strong></p>
<ul>
<li>Must be positive timestamps: <code>&gt; 0</code></li>
</ul>
<hr>
<a id="global_config-parameters" class="tsd-anchor"></a><h2 class="tsd-anchor-link">GLOBAL_CONFIG Parameters<a href="#global_config-parameters" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><a id="validation-threshold-reference" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Validation Threshold Reference<a href="#validation-threshold-reference" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><table>
<thead>
<tr>
<th>Parameter</th>
<th>Default</th>
<th>Purpose</th>
<th>Impact if Violated</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>CC_MIN_TAKEPROFIT_DISTANCE_PERCENT</code></td>
<td>0.5%</td>
<td>Cover trading costs</td>
<td>Signal rejected (TP too close)</td>
</tr>
<tr>
<td><code>CC_MIN_STOPLOSS_DISTANCE_PERCENT</code></td>
<td>0.5%</td>
<td>Avoid instant stop-out</td>
<td>Signal rejected (SL too close)</td>
</tr>
<tr>
<td><code>CC_MAX_STOPLOSS_DISTANCE_PERCENT</code></td>
<td>20%</td>
<td>Cap maximum loss</td>
<td>Signal rejected (SL too far)</td>
</tr>
<tr>
<td><code>CC_MAX_SIGNAL_LIFETIME_MINUTES</code></td>
<td>1,440</td>
<td>Prevent eternal signals</td>
<td>Signal rejected (lifetime too long)</td>
</tr>
<tr>
<td><code>CC_PERCENT_FEE</code></td>
<td>0.1%</td>
<td>Fee per transaction</td>
<td>Used in TP distance calc</td>
</tr>
<tr>
<td><code>CC_PERCENT_SLIPPAGE</code></td>
<td>0.1%</td>
<td>Slippage per transaction</td>
<td>Used in TP distance calc</td>
</tr>
</tbody>
</table>
<p><strong>Setting Custom Thresholds:</strong></p>
<pre><code class="typescript"><span class="hl-3">import</span><span class="hl-1"> { </span><span class="hl-4">setConfig</span><span class="hl-1"> } </span><span class="hl-3">from</span><span class="hl-1"> </span><span class="hl-2">&#39;backtest-kit&#39;</span><span class="hl-1">;</span><br/><br/><span class="hl-0">setConfig</span><span class="hl-1">({</span><br/><span class="hl-1">  </span><span class="hl-4">CC_MIN_TAKEPROFIT_DISTANCE_PERCENT:</span><span class="hl-1"> </span><span class="hl-6">1.0</span><span class="hl-1">,  </span><span class="hl-5">// Require 1% min TP</span><br/><span class="hl-1">  </span><span class="hl-4">CC_MAX_STOPLOSS_DISTANCE_PERCENT:</span><span class="hl-1"> </span><span class="hl-6">10</span><span class="hl-1">,     </span><span class="hl-5">// Limit SL to 10%</span><br/><span class="hl-1">  </span><span class="hl-4">CC_MAX_SIGNAL_LIFETIME_MINUTES:</span><span class="hl-1"> </span><span class="hl-6">720</span><span class="hl-1">,      </span><span class="hl-5">// Max 12 hours per signal</span><br/><span class="hl-1">});</span>
</code><button type="button">Copy</button></pre>

<hr>
<a id="risk-validation-integration" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Risk Validation Integration<a href="#risk-validation-integration" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><a id="iriskchecksignal-execution" class="tsd-anchor"></a><h3 class="tsd-anchor-link">IRisk.checkSignal Execution<a href="#iriskchecksignal-execution" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>After passing all built-in validation stages, signals undergo custom risk validation via <code>IRisk.checkSignal()</code>:</p>
<p><img src="../media/33_signal-validation-pipeline_2.svg" alt="Mermaid Diagram"></p>
<p><strong>Risk Check Parameters:</strong></p>
<pre><code class="typescript"><span class="hl-7">interface</span><span class="hl-1"> </span><span class="hl-11">RiskCheckParams</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-4">pendingSignal</span><span class="hl-1">: </span><span class="hl-11">ISignalDto</span><span class="hl-1">;</span><br/><span class="hl-1">  </span><span class="hl-4">symbol</span><span class="hl-1">: </span><span class="hl-11">string</span><span class="hl-1">;</span><br/><span class="hl-1">  </span><span class="hl-4">strategyName</span><span class="hl-1">: </span><span class="hl-11">string</span><span class="hl-1">;</span><br/><span class="hl-1">  </span><span class="hl-4">exchangeName</span><span class="hl-1">: </span><span class="hl-11">string</span><span class="hl-1">;</span><br/><span class="hl-1">  </span><span class="hl-4">currentPrice</span><span class="hl-1">: </span><span class="hl-11">number</span><span class="hl-1">;</span><br/><span class="hl-1">  </span><span class="hl-4">timestamp</span><span class="hl-1">: </span><span class="hl-11">number</span><span class="hl-1">;</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<p><strong>Integration Point in GET_SIGNAL_FN:</strong></p>
<pre><code class="typescript"><span class="hl-5">// After VALIDATE_SIGNAL_FN passes</span><br/><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-0">not</span><span class="hl-1">(</span><br/><span class="hl-1">  </span><span class="hl-4">self</span><span class="hl-1">.</span><span class="hl-4">params</span><span class="hl-1">.</span><span class="hl-4">risk</span><span class="hl-1">.</span><span class="hl-0">checkSignal</span><span class="hl-1">({</span><br/><span class="hl-1">    </span><span class="hl-4">pendingSignal:</span><span class="hl-1"> </span><span class="hl-4">signal</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-4">symbol:</span><span class="hl-1"> </span><span class="hl-4">self</span><span class="hl-1">.</span><span class="hl-4">params</span><span class="hl-1">.</span><span class="hl-4">execution</span><span class="hl-1">.</span><span class="hl-4">context</span><span class="hl-1">.</span><span class="hl-4">symbol</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-4">strategyName:</span><span class="hl-1"> </span><span class="hl-4">self</span><span class="hl-1">.</span><span class="hl-4">params</span><span class="hl-1">.</span><span class="hl-4">method</span><span class="hl-1">.</span><span class="hl-4">context</span><span class="hl-1">.</span><span class="hl-4">strategyName</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-4">exchangeName:</span><span class="hl-1"> </span><span class="hl-4">self</span><span class="hl-1">.</span><span class="hl-4">params</span><span class="hl-1">.</span><span class="hl-4">method</span><span class="hl-1">.</span><span class="hl-4">context</span><span class="hl-1">.</span><span class="hl-4">exchangeName</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-4">currentPrice</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-4">timestamp:</span><span class="hl-1"> </span><span class="hl-4">currentTime</span><span class="hl-1">,</span><br/><span class="hl-1">  })</span><br/><span class="hl-1">)) {</span><br/><span class="hl-1">  </span><span class="hl-3">return</span><span class="hl-1"> </span><span class="hl-7">null</span><span class="hl-1">;  </span><span class="hl-5">// Risk check failed</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<p>For details on implementing custom risk validation logic, see <a href="design_31_risk-management.html">Risk Profiles &amp; Validation</a>.</p>
<hr>
<a id="candle-data-validation" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Candle Data Validation<a href="#candle-data-validation" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><a id="price-anomaly-detection" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Price Anomaly Detection<a href="#price-anomaly-detection" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><strong>Purpose</strong>: Detect and reject incomplete/corrupt candle data from exchanges that would corrupt VWAP calculations and signal execution.</p>
<p><strong>Common Exchange Issues:</strong></p>
<ul>
<li>Incomplete candles with prices near $0 (e.g., $0.01-$1.00 for BTC)</li>
<li>Missing volume data</li>
<li>Duplicate timestamps</li>
<li>Out-of-order candles</li>
</ul>
<a id="anomaly-detection-algorithm" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Anomaly Detection Algorithm<a href="#anomaly-detection-algorithm" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><img src="../media/33_signal-validation-pipeline_3.svg" alt="Mermaid Diagram"></p>
<p><strong>Parameters:</strong></p>
<ul>
<li><code>CC_GET_CANDLES_PRICE_ANOMALY_THRESHOLD_FACTOR</code>: Default 1,000</li>
<li><code>CC_GET_CANDLES_MIN_CANDLES_FOR_MEDIAN</code>: Default 5 candles</li>
</ul>
<p><strong>Example Detection:</strong></p>
<pre><code class="typescript"><span class="hl-5">// Normal BTC candles: $50,000 median</span><br/><span class="hl-5">// Threshold: $50,000 / 1,000 = $50</span><br/><span class="hl-5">// Any candle with price &lt; $50 is rejected as anomalous</span><br/><br/><span class="hl-5">// Incomplete candle: { low: 0.01, high: 0.02 } → REJECTED</span><br/><span class="hl-5">// Valid candle: { low: 49,900, high: 50,100 } → ACCEPTED</span>
</code><button type="button">Copy</button></pre>

<p><strong>Implementation Location:</strong> <code>ExchangeCoreService.getCandles()</code> performs anomaly detection before returning candles to strategies.</p>
<hr>
<a id="complete-validation-flow" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Complete Validation Flow<a href="#complete-validation-flow" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><a id="from-signal-generation-to-acceptance" class="tsd-anchor"></a><h3 class="tsd-anchor-link">From Signal Generation to Acceptance<a href="#from-signal-generation-to-acceptance" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><img src="../media/33_signal-validation-pipeline_4.svg" alt="Mermaid Diagram"></p>
<p><strong>Key Validation Points:</strong></p>
<ol>
<li><strong>Timeout Guard</strong>: <code>CC_MAX_SIGNAL_GENERATION_SECONDS</code> (default: 180s) prevents hung signal generation</li>
<li><strong>Schema Validation</strong>: <code>VALIDATE_SIGNAL_FN</code> enforces 10 stages of built-in checks</li>
<li><strong>Risk Validation</strong>: <code>IRisk.checkSignal</code> applies custom portfolio/strategy rules</li>
<li><strong>Persistence</strong>: Only opened signals persist; scheduled signals remain ephemeral until activation</li>
</ol>
<hr>
<a id="validation-error-handling" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Validation Error Handling<a href="#validation-error-handling" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><a id="error-accumulation-pattern" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Error Accumulation Pattern<a href="#error-accumulation-pattern" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><pre><code class="typescript"><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">errors</span><span class="hl-1">: </span><span class="hl-11">string</span><span class="hl-1">[] = [];</span><br/><br/><span class="hl-5">// Collect all violations</span><br/><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-4">signal</span><span class="hl-1">.</span><span class="hl-4">id</span><span class="hl-1"> === </span><span class="hl-2">&#39;&#39;</span><span class="hl-1">) {</span><br/><span class="hl-1">  </span><span class="hl-4">errors</span><span class="hl-1">.</span><span class="hl-0">push</span><span class="hl-1">(</span><span class="hl-2">&#39;id is required and must be a non-empty string&#39;</span><span class="hl-1">);</span><br/><span class="hl-1">}</span><br/><span class="hl-3">if</span><span class="hl-1"> (!</span><span class="hl-0">isFinite</span><span class="hl-1">(</span><span class="hl-4">currentPrice</span><span class="hl-1">)) {</span><br/><span class="hl-1">  </span><span class="hl-4">errors</span><span class="hl-1">.</span><span class="hl-0">push</span><span class="hl-1">(</span><span class="hl-2">`currentPrice must be a finite number, got </span><span class="hl-7">${</span><span class="hl-4">currentPrice</span><span class="hl-7">}</span><span class="hl-2">`</span><span class="hl-1">);</span><br/><span class="hl-1">}</span><br/><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-4">signal</span><span class="hl-1">.</span><span class="hl-4">position</span><span class="hl-1"> === </span><span class="hl-2">&quot;long&quot;</span><span class="hl-1"> &amp;&amp; </span><span class="hl-4">signal</span><span class="hl-1">.</span><span class="hl-4">priceTakeProfit</span><span class="hl-1"> &lt;= </span><span class="hl-4">signal</span><span class="hl-1">.</span><span class="hl-4">priceOpen</span><span class="hl-1">) {</span><br/><span class="hl-1">  </span><span class="hl-4">errors</span><span class="hl-1">.</span><span class="hl-0">push</span><span class="hl-1">(</span><span class="hl-2">`Long: priceTakeProfit (</span><span class="hl-7">${</span><span class="hl-4">signal</span><span class="hl-9">.</span><span class="hl-4">priceTakeProfit</span><span class="hl-7">}</span><span class="hl-2">) must be &gt; priceOpen (</span><span class="hl-7">${</span><span class="hl-4">signal</span><span class="hl-9">.</span><span class="hl-4">priceOpen</span><span class="hl-7">}</span><span class="hl-2">)`</span><span class="hl-1">);</span><br/><span class="hl-1">}</span><br/><br/><span class="hl-5">// Throw comprehensive error if any violations found</span><br/><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-4">errors</span><span class="hl-1">.</span><span class="hl-4">length</span><span class="hl-1"> &gt; </span><span class="hl-6">0</span><span class="hl-1">) {</span><br/><span class="hl-1">  </span><span class="hl-3">throw</span><span class="hl-1"> </span><span class="hl-7">new</span><span class="hl-1"> </span><span class="hl-0">Error</span><span class="hl-1">(</span><br/><span class="hl-1">    </span><span class="hl-2">`Invalid signal for </span><span class="hl-7">${</span><span class="hl-4">signal</span><span class="hl-9">.</span><span class="hl-4">position</span><span class="hl-7">}</span><span class="hl-2"> position:</span><span class="hl-14">\n</span><span class="hl-7">${</span><span class="hl-4">errors</span><span class="hl-9">.</span><span class="hl-0">join</span><span class="hl-9">(</span><span class="hl-2">&quot;</span><span class="hl-14">\n</span><span class="hl-2">&quot;</span><span class="hl-9">)</span><span class="hl-7">}</span><span class="hl-2">`</span><br/><span class="hl-1">  );</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<p><strong>Error Format:</strong></p>
<pre><code><span class="hl-4">Invalid</span><span class="hl-1"> </span><span class="hl-4">signal</span><span class="hl-1"> </span><span class="hl-4">for</span><span class="hl-1"> </span><span class="hl-4">long</span><span class="hl-1"> </span><span class="hl-10">position</span><span class="hl-1">:</span><br/><span class="hl-10">Long</span><span class="hl-1">: </span><span class="hl-0">priceTakeProfit</span><span class="hl-1"> (</span><span class="hl-6">42010</span><span class="hl-1">) </span><span class="hl-4">must</span><span class="hl-1"> </span><span class="hl-4">be</span><span class="hl-1"> &gt; </span><span class="hl-0">priceOpen</span><span class="hl-1"> (</span><span class="hl-6">42000</span><span class="hl-1">)</span><br/><span class="hl-10">Long</span><span class="hl-1">: </span><span class="hl-4">TakeProfit</span><span class="hl-1"> </span><span class="hl-4">too</span><span class="hl-1"> </span><span class="hl-4">close</span><span class="hl-1"> </span><span class="hl-4">to</span><span class="hl-1"> </span><span class="hl-0">priceOpen</span><span class="hl-1"> (</span><span class="hl-6">0.024</span><span class="hl-1">%). </span><span class="hl-4">Minimum</span><span class="hl-1"> </span><span class="hl-10">distance</span><span class="hl-1">: </span><span class="hl-6">0.5</span><span class="hl-1">% </span><span class="hl-4">to</span><span class="hl-1"> </span><span class="hl-4">cover</span><span class="hl-1"> </span><span class="hl-4">trading</span><span class="hl-1"> </span><span class="hl-4">fees</span><span class="hl-1">.</span><br/><span class="hl-4">minuteEstimatedTime</span><span class="hl-1"> </span><span class="hl-4">too</span><span class="hl-1"> </span><span class="hl-0">large</span><span class="hl-1"> (</span><span class="hl-6">50000</span><span class="hl-1"> </span><span class="hl-4">minutes</span><span class="hl-1"> = </span><span class="hl-6">34.7</span><span class="hl-1"> </span><span class="hl-4">days</span><span class="hl-1">). </span><span class="hl-4">Maximum</span><span class="hl-1">: </span><span class="hl-6">1440</span><span class="hl-1"> </span><span class="hl-0">minutes</span><span class="hl-1"> (</span><span class="hl-6">1</span><span class="hl-1"> </span><span class="hl-4">days</span><span class="hl-1">) </span><span class="hl-4">to</span><span class="hl-1"> </span><span class="hl-4">prevent</span><span class="hl-1"> </span><span class="hl-4">strategy</span><span class="hl-1"> </span><span class="hl-4">deadlock</span><span class="hl-1">.</span>
</code><button>Copy</button></pre>

<p><strong>Handling</strong>: Errors are caught in <code>GET_SIGNAL_FN</code>, logged via <code>errorEmitter</code>, and signal is rejected (returns <code>null</code>).</p>
<hr>
<a id="test-coverage" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Test Coverage<a href="#test-coverage" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><a id="validation-test-suites" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Validation Test Suites<a href="#validation-test-suites" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>The validation pipeline has extensive test coverage ensuring correctness:</p>
<table>
<thead>
<tr>
<th>Test Category</th>
<th>Test File</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td>Micro-profit rejection</td>
<td><code>test/e2e/sanitize.test.mjs:27-122</code></td>
<td>TP too close to cover fees</td>
</tr>
<tr>
<td>Extreme SL rejection</td>
<td><code>test/e2e/sanitize.test.mjs:134-229</code></td>
<td>SL exceeds max distance</td>
</tr>
<tr>
<td>Eternal signal rejection</td>
<td><code>test/e2e/sanitize.test.mjs:241-340</code></td>
<td>Lifetime exceeds limit</td>
</tr>
<tr>
<td>Immediate closure prevention</td>
<td><code>test/e2e/edge.test.mjs</code></td>
<td>Prevents open-and-close scenarios</td>
</tr>
<tr>
<td>Price anomaly detection</td>
<td><code>test/spec/validation.test.mjs</code></td>
<td>Corrupt candle data handling</td>
</tr>
</tbody>
</table>
<p><strong>Example Test: Micro-Profit Rejection:</strong></p>
<pre><code class="typescript"><span class="hl-5">// Signal: priceOpen=42000, TP=42010 (0.024% profit)</span><br/><span class="hl-5">// After fees (0.2%) and slippage (0.2%), net PNL would be NEGATIVE</span><br/><span class="hl-5">// Expected: Signal rejected by VALIDATE_SIGNAL_FN</span><br/><br/><span class="hl-0">setConfig</span><span class="hl-1">({</span><br/><span class="hl-1">  </span><span class="hl-4">CC_MIN_TAKEPROFIT_DISTANCE_PERCENT:</span><span class="hl-1"> </span><span class="hl-6">0.3</span><span class="hl-1">,</span><br/><span class="hl-1">}, </span><span class="hl-7">true</span><span class="hl-1">);</span><br/><br/><span class="hl-5">// Signal should be rejected, scheduledCount and openedCount remain 0</span>
</code><button type="button">Copy</button></pre>

</div></div><div class="col-sidebar"><div class="page-menu"><div class="tsd-navigation settings"><details class="tsd-accordion"><summary class="tsd-accordion-summary"><h3><svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-chevronDown"></use></svg>Settings</h3></summary><div class="tsd-accordion-details"><div class="tsd-filter-visibility"><span class="settings-label">Member Visibility</span><ul id="tsd-filter-options"><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-protected" name="protected"/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Protected</span></label></li><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-inherited" name="inherited" checked/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Inherited</span></label></li><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-external" name="external"/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>External</span></label></li></ul></div><div class="tsd-theme-toggle"><label class="settings-label" for="tsd-theme">Theme</label><select id="tsd-theme"><option value="os">OS</option><option value="light">Light</option><option value="dark">Dark</option></select></div></div></details></div><details open class="tsd-accordion tsd-page-navigation"><summary class="tsd-accordion-summary"><h3><svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-chevronDown"></use></svg>On This Page</h3></summary><div class="tsd-accordion-details"><a href="#signal-validation-pipeline"><span>Signal <wbr/>Validation <wbr/>Pipeline</span></a><ul><li><a href="#purpose-and-scope"><span>Purpose and <wbr/>Scope</span></a></li><li><a href="#validation-pipeline-overview"><span>Validation <wbr/>Pipeline <wbr/>Overview</span></a></li><li><a href="#schema-and-type-validation"><span>Schema and <wbr/>Type <wbr/>Validation</span></a></li><li><ul><li><a href="#required-fields"><span>Required <wbr/>Fields</span></a></li></ul></li><li><a href="#price-validation"><span>Price <wbr/>Validation</span></a></li><li><ul><li><a href="#nan-and-infinity-protection"><span>Na<wbr/>N and <wbr/>Infinity <wbr/>Protection</span></a></li></ul></li><li><a href="#position-logic-validation"><span>Position <wbr/>Logic <wbr/>Validation</span></a></li><li><ul><li><a href="#long-position-requirements"><span>LONG <wbr/>Position <wbr/>Requirements</span></a></li><li><a href="#short-position-requirements"><span>SHORT <wbr/>Position <wbr/>Requirements</span></a></li></ul></li><li><a href="#immediate-closure-prevention"><span>Immediate <wbr/>Closure <wbr/>Prevention</span></a></li><li><ul><li><a href="#for-immediate-market-signals"><span>For <wbr/>Immediate (<wbr/>Market) <wbr/>Signals</span></a></li><li><a href="#for-scheduled-limit-signals"><span>For <wbr/>Scheduled (<wbr/>Limit) <wbr/>Signals</span></a></li></ul></li><li><a href="#distance-requirements"><span>Distance <wbr/>Requirements</span></a></li><li><ul><li><a href="#minimum-takeprofit-distance"><span>Minimum <wbr/>Take<wbr/>Profit <wbr/>Distance</span></a></li><li><a href="#minimum-stoploss-distance"><span>Minimum <wbr/>Stop<wbr/>Loss <wbr/>Distance</span></a></li><li><a href="#maximum-stoploss-distance"><span>Maximum <wbr/>Stop<wbr/>Loss <wbr/>Distance</span></a></li></ul></li><li><a href="#lifetime-limits"><span>Lifetime <wbr/>Limits</span></a></li><li><ul><li><a href="#maximum-signal-lifetime"><span>Maximum <wbr/>Signal <wbr/>Lifetime</span></a></li><li><a href="#time-parameter-validation"><span>Time <wbr/>Parameter <wbr/>Validation</span></a></li></ul></li><li><a href="#global_config-parameters"><span>GLOBAL_<wbr/>CONFIG <wbr/>Parameters</span></a></li><li><ul><li><a href="#validation-threshold-reference"><span>Validation <wbr/>Threshold <wbr/>Reference</span></a></li></ul></li><li><a href="#risk-validation-integration"><span>Risk <wbr/>Validation <wbr/>Integration</span></a></li><li><ul><li><a href="#iriskchecksignal-execution"><span>IRisk.check<wbr/>Signal <wbr/>Execution</span></a></li></ul></li><li><a href="#candle-data-validation"><span>Candle <wbr/>Data <wbr/>Validation</span></a></li><li><ul><li><a href="#price-anomaly-detection"><span>Price <wbr/>Anomaly <wbr/>Detection</span></a></li><li><a href="#anomaly-detection-algorithm"><span>Anomaly <wbr/>Detection <wbr/>Algorithm</span></a></li></ul></li><li><a href="#complete-validation-flow"><span>Complete <wbr/>Validation <wbr/>Flow</span></a></li><li><ul><li><a href="#from-signal-generation-to-acceptance"><span>From <wbr/>Signal <wbr/>Generation to <wbr/>Acceptance</span></a></li></ul></li><li><a href="#validation-error-handling"><span>Validation <wbr/>Error <wbr/>Handling</span></a></li><li><ul><li><a href="#error-accumulation-pattern"><span>Error <wbr/>Accumulation <wbr/>Pattern</span></a></li></ul></li><li><a href="#test-coverage"><span>Test <wbr/>Coverage</span></a></li><li><ul><li><a href="#validation-test-suites"><span>Validation <wbr/>Test <wbr/>Suites</span></a></li></ul></li></ul></div></details></div><div class="site-menu"><nav class="tsd-navigation"><a href="../modules.html">backtest-kit</a><ul class="tsd-small-nested-navigation" id="tsd-nav-container"><li>Loading...</li></ul></nav></div></div></div><footer><p class="tsd-generator">Generated using <a href="https://typedoc.org/" target="_blank">TypeDoc</a></p></footer><div class="overlay"></div></body></html>

<!-- Yandex.Metrika counter -->
<script type="text/javascript">
    (function(m,e,t,r,i,k,a){
        m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
        m[i].l=1*new Date();
        for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }}
        k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)
    })(window, document,'script','https://mc.yandex.ru/metrika/tag.js?id=105455585', 'ym');

    ym(105455585, 'init', {ssr:true, webvisor:true, clickmap:true, ecommerce:"dataLayer", accurateTrackBounce:true, trackLinks:true});
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/105455585" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
<!-- /Yandex.Metrika counter -->

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-3MQZEBBDDR"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-3MQZEBBDDR');
</script>
