<!DOCTYPE html><html class="default" lang="en" data-base=".."><head><meta charset="utf-8"/><meta http-equiv="x-ua-compatible" content="IE=edge"/><title>design/09_signals-signal-lifecycle | backtest-kit</title><meta name="description" content="Documentation for backtest-kit"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="stylesheet" href="../assets/style.css"/><link rel="stylesheet" href="../assets/highlight.css"/><script defer src="../assets/main.js"></script><script async src="../assets/icons.js" id="tsd-icons-script"></script><script async src="../assets/search.js" id="tsd-search-script"></script><script async src="../assets/navigation.js" id="tsd-nav-script"></script><script async src="../assets/hierarchy.js" id="tsd-hierarchy-script"></script></head><body><script>document.documentElement.dataset.theme = localStorage.getItem("tsd-theme") || "os";document.body.style.display="none";setTimeout(() => app?app.showPage():document.body.style.removeProperty("display"),500)</script><header class="tsd-page-toolbar"><div class="tsd-toolbar-contents container"><div class="table-cell" id="tsd-search"><div class="field"><label for="tsd-search-field" class="tsd-widget tsd-toolbar-icon search no-caption"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-search"></use></svg></label><input type="text" id="tsd-search-field" aria-label="Search"/></div><div class="field"><div id="tsd-toolbar-links"></div></div><ul class="results"><li class="state loading">Preparing search index...</li><li class="state failure">The search index is not available</li></ul><a href="../index.html" class="title">backtest-kit</a></div><div class="table-cell" id="tsd-widgets"><a href="#" class="tsd-widget tsd-toolbar-icon menu no-caption" data-toggle="menu" aria-label="Menu"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-menu"></use></svg></a></div></div></header><div class="container container-main"><div class="col-content"><div class="tsd-page-title"><ul class="tsd-breadcrumb"><li><a href="../modules.html">backtest-kit</a></li><li><a href="design_09_signals-signal-lifecycle.html">design/09_signals-signal-lifecycle</a></li></ul></div><div class="tsd-panel tsd-typography"><a id="signals--signal-lifecycle" class="tsd-anchor"></a><h1 class="tsd-anchor-link">Signals &amp; Signal Lifecycle<a href="#signals--signal-lifecycle" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h1><a id="purpose-and-scope" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Purpose and Scope<a href="#purpose-and-scope" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>This document explains the signal system in Backtest Kit: what signals are, how they progress through their lifecycle, validation rules, and persistence mechanisms. Signals are the fundamental unit of trading action in the framework, representing entry/exit positions with take profit (TP), stop loss (SL), and time-based expiration.</p>
<p>For information about how strategies generate signals, see <a href="design_08_core-concepts.html">Strategies</a>. For execution context propagation, see <a href="design_08_core-concepts.html">Execution Contexts</a>. For the time execution engine that processes signals, see <a href="design_08_core-concepts.html">Time Execution Engine</a>.</p>
<hr>
<a id="core-signal-types" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Core Signal Types<a href="#core-signal-types" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>The framework defines three distinct signal types that represent different stages of signal maturity:</p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Interface</th>
<th>Description</th>
<th>When Created</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Signal DTO</strong></td>
<td><code>ISignalDto</code></td>
<td>User-provided signal from <code>getSignal()</code></td>
<td>Strategy generates signal</td>
</tr>
<tr>
<td><strong>Signal Row</strong></td>
<td><code>ISignalRow</code></td>
<td>Validated signal with auto-generated ID</td>
<td>After validation passes</td>
</tr>
<tr>
<td><strong>Scheduled Signal</strong></td>
<td><code>IScheduledSignalRow</code></td>
<td>Signal waiting for price activation</td>
<td>When <code>priceOpen</code> not yet reached</td>
</tr>
</tbody>
</table>
<a id="isignaldto-structure" class="tsd-anchor"></a><h3 class="tsd-anchor-link">ISignalDto Structure<a href="#isignaldto-structure" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><pre><code class="typescript"><span class="hl-7">interface</span><span class="hl-1"> </span><span class="hl-11">ISignalDto</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-4">id</span><span class="hl-1">?: </span><span class="hl-11">string</span><span class="hl-1">;                    </span><span class="hl-5">// Optional (auto-generated if omitted)</span><br/><span class="hl-1">  </span><span class="hl-4">position</span><span class="hl-1">: </span><span class="hl-2">&quot;long&quot;</span><span class="hl-1"> | </span><span class="hl-2">&quot;short&quot;</span><span class="hl-1">;     </span><span class="hl-5">// Trade direction</span><br/><span class="hl-1">  </span><span class="hl-4">note</span><span class="hl-1">?: </span><span class="hl-11">string</span><span class="hl-1">;                  </span><span class="hl-5">// Human-readable reason</span><br/><span class="hl-1">  </span><span class="hl-4">priceOpen</span><span class="hl-1">?: </span><span class="hl-11">number</span><span class="hl-1">;             </span><span class="hl-5">// Entry price (creates scheduled signal if specified)</span><br/><span class="hl-1">  </span><span class="hl-4">priceTakeProfit</span><span class="hl-1">: </span><span class="hl-11">number</span><span class="hl-1">;        </span><span class="hl-5">// Target exit price</span><br/><span class="hl-1">  </span><span class="hl-4">priceStopLoss</span><span class="hl-1">: </span><span class="hl-11">number</span><span class="hl-1">;          </span><span class="hl-5">// Risk exit price</span><br/><span class="hl-1">  </span><span class="hl-4">minuteEstimatedTime</span><span class="hl-1">: </span><span class="hl-11">number</span><span class="hl-1">;    </span><span class="hl-5">// Max lifetime before time_expired</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<a id="isignalrow-structure" class="tsd-anchor"></a><h3 class="tsd-anchor-link">ISignalRow Structure<a href="#isignalrow-structure" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>After validation, signals are augmented with runtime metadata:</p>
<pre><code class="typescript"><span class="hl-7">interface</span><span class="hl-1"> </span><span class="hl-11">ISignalRow</span><span class="hl-1"> </span><span class="hl-7">extends</span><span class="hl-1"> </span><span class="hl-11">ISignalDto</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-4">id</span><span class="hl-1">: </span><span class="hl-11">string</span><span class="hl-1">;                     </span><span class="hl-5">// UUID v4 (required)</span><br/><span class="hl-1">  </span><span class="hl-4">priceOpen</span><span class="hl-1">: </span><span class="hl-11">number</span><span class="hl-1">;              </span><span class="hl-5">// Entry price (required)</span><br/><span class="hl-1">  </span><span class="hl-4">exchangeName</span><span class="hl-1">: </span><span class="hl-11">ExchangeName</span><span class="hl-1">;     </span><span class="hl-5">// Exchange identifier</span><br/><span class="hl-1">  </span><span class="hl-4">strategyName</span><span class="hl-1">: </span><span class="hl-11">StrategyName</span><span class="hl-1">;     </span><span class="hl-5">// Strategy identifier</span><br/><span class="hl-1">  </span><span class="hl-4">scheduledAt</span><span class="hl-1">: </span><span class="hl-11">number</span><span class="hl-1">;            </span><span class="hl-5">// Creation timestamp (milliseconds)</span><br/><span class="hl-1">  </span><span class="hl-4">pendingAt</span><span class="hl-1">: </span><span class="hl-11">number</span><span class="hl-1">;              </span><span class="hl-5">// Activation timestamp (milliseconds)</span><br/><span class="hl-1">  </span><span class="hl-4">symbol</span><span class="hl-1">: </span><span class="hl-11">string</span><span class="hl-1">;                 </span><span class="hl-5">// Trading pair (e.g., &quot;BTCUSDT&quot;)</span><br/><span class="hl-1">  </span><span class="hl-4">_isScheduled</span><span class="hl-1">: </span><span class="hl-11">boolean</span><span class="hl-1">;          </span><span class="hl-5">// Internal flag for delayed entry</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<p><strong>Scheduled vs Opened Timing:</strong></p>
<ul>
<li><code>scheduledAt</code>: Always set when signal is created</li>
<li><code>pendingAt</code>: Set to <code>scheduledAt</code> initially, updated to actual activation time when scheduled signal activates</li>
</ul>
<hr>
<a id="signal-lifecycle-state-machine" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Signal Lifecycle State Machine<a href="#signal-lifecycle-state-machine" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><a id="state-overview" class="tsd-anchor"></a><h3 class="tsd-anchor-link">State Overview<a href="#state-overview" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><img src="../media/09_signals-signal-lifecycle_0.svg" alt="Mermaid Diagram"></p>
<a id="state-descriptions" class="tsd-anchor"></a><h3 class="tsd-anchor-link">State Descriptions<a href="#state-descriptions" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><table>
<thead>
<tr>
<th>State</th>
<th>Action</th>
<th>Signal Value</th>
<th>Persisted</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>idle</code></td>
<td><code>&quot;idle&quot;</code></td>
<td><code>null</code></td>
<td>No</td>
<td>No active signal exists</td>
</tr>
<tr>
<td><code>scheduled</code></td>
<td><code>&quot;scheduled&quot;</code></td>
<td><code>IScheduledSignalRow</code></td>
<td>Yes (Schedule)</td>
<td>Waiting for <code>priceOpen</code></td>
</tr>
<tr>
<td><code>opened</code></td>
<td><code>&quot;opened&quot;</code></td>
<td><code>ISignalRow</code></td>
<td>Yes (Signal)</td>
<td>Just activated</td>
</tr>
<tr>
<td><code>active</code></td>
<td><code>&quot;active&quot;</code></td>
<td><code>ISignalRow</code></td>
<td>Yes (Signal)</td>
<td>Monitoring TP/SL</td>
</tr>
<tr>
<td><code>closed</code></td>
<td><code>&quot;closed&quot;</code></td>
<td><code>ISignalRow</code></td>
<td>No</td>
<td>Completed with PNL</td>
</tr>
<tr>
<td><code>cancelled</code></td>
<td><code>&quot;cancelled&quot;</code></td>
<td><code>IScheduledSignalRow</code></td>
<td>No</td>
<td>Scheduled signal expired</td>
</tr>
</tbody>
</table>
<p><strong>Critical Constraint:</strong> Only ONE active signal per symbol at any time. New signals wait until current signal closes.</p>
<hr>
<a id="validation-pipeline" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Validation Pipeline<a href="#validation-pipeline" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><a id="seven-stage-validation" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Seven-Stage Validation<a href="#seven-stage-validation" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>All signals pass through comprehensive validation before activation:</p>
<p><img src="../media/09_signals-signal-lifecycle_1.svg" alt="Mermaid Diagram"></p>
<a id="stage-details" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Stage Details<a href="#stage-details" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><a id="stage-1-schema-validation" class="tsd-anchor"></a><h4 class="tsd-anchor-link">Stage 1: Schema Validation<a href="#stage-1-schema-validation" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><p>Checks all required fields exist and have correct types:</p>
<ul>
<li><code>id</code>, <code>position</code>, <code>priceOpen</code>, <code>priceTakeProfit</code>, <code>priceStopLoss</code></li>
<li><code>exchangeName</code>, <code>strategyName</code>, <code>symbol</code>, <code>scheduledAt</code>, <code>pendingAt</code></li>
<li><code>minuteEstimatedTime</code>, <code>_isScheduled</code></li>
</ul>
<pre><code class="typescript"><span class="hl-5">// Example failure</span><br/><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-4">signal</span><span class="hl-1">.</span><span class="hl-4">position</span><span class="hl-1"> !== </span><span class="hl-2">&quot;long&quot;</span><span class="hl-1"> &amp;&amp; </span><span class="hl-4">signal</span><span class="hl-1">.</span><span class="hl-4">position</span><span class="hl-1"> !== </span><span class="hl-2">&quot;short&quot;</span><span class="hl-1">) {</span><br/><span class="hl-1">  </span><span class="hl-3">throw</span><span class="hl-1"> </span><span class="hl-7">new</span><span class="hl-1"> </span><span class="hl-0">Error</span><span class="hl-1">(</span><span class="hl-2">`position must be &quot;long&quot; or &quot;short&quot;, got &quot;</span><span class="hl-7">${</span><span class="hl-4">signal</span><span class="hl-9">.</span><span class="hl-4">position</span><span class="hl-7">}</span><span class="hl-2">&quot;`</span><span class="hl-1">);</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<a id="stage-2-positive-price-check" class="tsd-anchor"></a><h4 class="tsd-anchor-link">Stage 2: Positive Price Check<a href="#stage-2-positive-price-check" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><p>Ensures all prices are finite, positive numbers (prevents NaN/Infinity):</p>
<pre><code class="typescript"><span class="hl-3">if</span><span class="hl-1"> (!</span><span class="hl-0">isFinite</span><span class="hl-1">(</span><span class="hl-4">currentPrice</span><span class="hl-1">) || </span><span class="hl-4">currentPrice</span><span class="hl-1"> &lt;= </span><span class="hl-6">0</span><span class="hl-1">) {</span><br/><span class="hl-1">  </span><span class="hl-4">errors</span><span class="hl-1">.</span><span class="hl-0">push</span><span class="hl-1">(</span><span class="hl-2">`currentPrice must be positive, got </span><span class="hl-7">${</span><span class="hl-4">currentPrice</span><span class="hl-7">}</span><span class="hl-2">`</span><span class="hl-1">);</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<a id="stage-3-tpsl-logic-validation" class="tsd-anchor"></a><h4 class="tsd-anchor-link">Stage 3: TP/SL Logic Validation<a href="#stage-3-tpsl-logic-validation" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><p>Validates take profit and stop loss relative to position direction:</p>
<p><strong>LONG Position:</strong></p>
<ul>
<li><code>priceTakeProfit &gt; priceOpen &gt; priceStopLoss</code></li>
<li>Current price must be between SL and TP (prevents immediate closure)</li>
</ul>
<p><strong>SHORT Position:</strong></p>
<ul>
<li><code>priceStopLoss &gt; priceOpen &gt; priceTakeProfit</code></li>
<li>Current price must be between TP and SL (prevents immediate closure)</li>
</ul>
<pre><code class="typescript"><span class="hl-5">// LONG validation</span><br/><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-4">signal</span><span class="hl-1">.</span><span class="hl-4">position</span><span class="hl-1"> === </span><span class="hl-2">&quot;long&quot;</span><span class="hl-1">) {</span><br/><span class="hl-1">  </span><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-4">signal</span><span class="hl-1">.</span><span class="hl-4">priceTakeProfit</span><span class="hl-1"> &lt;= </span><span class="hl-4">signal</span><span class="hl-1">.</span><span class="hl-4">priceOpen</span><span class="hl-1">) {</span><br/><span class="hl-1">    </span><span class="hl-4">errors</span><span class="hl-1">.</span><span class="hl-0">push</span><span class="hl-1">(</span><span class="hl-2">`Long: priceTakeProfit (</span><span class="hl-7">${</span><span class="hl-4">signal</span><span class="hl-9">.</span><span class="hl-4">priceTakeProfit</span><span class="hl-7">}</span><span class="hl-2">) must be &gt; priceOpen (</span><span class="hl-7">${</span><span class="hl-4">signal</span><span class="hl-9">.</span><span class="hl-4">priceOpen</span><span class="hl-7">}</span><span class="hl-2">)`</span><span class="hl-1">);</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">  </span><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-4">currentPrice</span><span class="hl-1"> &lt;= </span><span class="hl-4">signal</span><span class="hl-1">.</span><span class="hl-4">priceStopLoss</span><span class="hl-1">) {</span><br/><span class="hl-1">    </span><span class="hl-4">errors</span><span class="hl-1">.</span><span class="hl-0">push</span><span class="hl-1">(</span><span class="hl-2">`Long immediate: currentPrice (</span><span class="hl-7">${</span><span class="hl-4">currentPrice</span><span class="hl-7">}</span><span class="hl-2">) &lt;= priceStopLoss. Signal would be immediately closed.`</span><span class="hl-1">);</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<a id="stage-4-minimum-tp-distance" class="tsd-anchor"></a><h4 class="tsd-anchor-link">Stage 4: Minimum TP Distance<a href="#stage-4-minimum-tp-distance" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><p>Enforces <code>CC_MIN_TAKEPROFIT_DISTANCE_PERCENT</code> (default 0.5%) to ensure profits cover fees and slippage:</p>
<p><strong>Cost Breakdown:</strong></p>
<ul>
<li>Entry slippage: 0.1%</li>
<li>Entry fee: 0.1%</li>
<li>Exit slippage: 0.1%</li>
<li>Exit fee: 0.1%</li>
<li><strong>Total costs: 0.4%</strong></li>
<li>Minimum buffer: 0.1%</li>
<li><strong>Required TP distance: 0.5%</strong></li>
</ul>
<pre><code class="typescript"><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">tpDistancePercent</span><span class="hl-1"> = ((</span><span class="hl-4">signal</span><span class="hl-1">.</span><span class="hl-4">priceTakeProfit</span><span class="hl-1"> - </span><span class="hl-4">signal</span><span class="hl-1">.</span><span class="hl-4">priceOpen</span><span class="hl-1">) / </span><span class="hl-4">signal</span><span class="hl-1">.</span><span class="hl-4">priceOpen</span><span class="hl-1">) * </span><span class="hl-6">100</span><span class="hl-1">;</span><br/><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-4">tpDistancePercent</span><span class="hl-1"> &lt; </span><span class="hl-8">GLOBAL_CONFIG</span><span class="hl-1">.</span><span class="hl-8">CC_MIN_TAKEPROFIT_DISTANCE_PERCENT</span><span class="hl-1">) {</span><br/><span class="hl-1">  </span><span class="hl-4">errors</span><span class="hl-1">.</span><span class="hl-0">push</span><span class="hl-1">(</span><span class="hl-2">`Long: TakeProfit too close (</span><span class="hl-7">${</span><span class="hl-4">tpDistancePercent</span><span class="hl-9">.</span><span class="hl-0">toFixed</span><span class="hl-9">(</span><span class="hl-6">3</span><span class="hl-9">)</span><span class="hl-7">}</span><span class="hl-2">%). Minimum: </span><span class="hl-7">${</span><span class="hl-8">GLOBAL_CONFIG</span><span class="hl-9">.</span><span class="hl-8">CC_MIN_TAKEPROFIT_DISTANCE_PERCENT</span><span class="hl-7">}</span><span class="hl-2">%`</span><span class="hl-1">);</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<a id="stage-5-sl-range-validation" class="tsd-anchor"></a><h4 class="tsd-anchor-link">Stage 5: SL Range Validation<a href="#stage-5-sl-range-validation" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><p>Enforces both minimum and maximum SL distances:</p>
<p><strong>Minimum SL Distance</strong> (<code>CC_MIN_STOPLOSS_DISTANCE_PERCENT</code>, default 0.5%):</p>
<ul>
<li>Prevents instant stop-out from normal market volatility</li>
</ul>
<p><strong>Maximum SL Distance</strong> (<code>CC_MAX_STOPLOSS_DISTANCE_PERCENT</code>, default 20%):</p>
<ul>
<li>Prevents catastrophic losses from extreme SL values</li>
</ul>
<pre><code class="typescript"><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">slDistancePercent</span><span class="hl-1"> = ((</span><span class="hl-4">signal</span><span class="hl-1">.</span><span class="hl-4">priceOpen</span><span class="hl-1"> - </span><span class="hl-4">signal</span><span class="hl-1">.</span><span class="hl-4">priceStopLoss</span><span class="hl-1">) / </span><span class="hl-4">signal</span><span class="hl-1">.</span><span class="hl-4">priceOpen</span><span class="hl-1">) * </span><span class="hl-6">100</span><span class="hl-1">;</span><br/><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-4">slDistancePercent</span><span class="hl-1"> &lt; </span><span class="hl-8">GLOBAL_CONFIG</span><span class="hl-1">.</span><span class="hl-8">CC_MIN_STOPLOSS_DISTANCE_PERCENT</span><span class="hl-1">) {</span><br/><span class="hl-1">  </span><span class="hl-4">errors</span><span class="hl-1">.</span><span class="hl-0">push</span><span class="hl-1">(</span><span class="hl-2">`Long: StopLoss too close (</span><span class="hl-7">${</span><span class="hl-4">slDistancePercent</span><span class="hl-9">.</span><span class="hl-0">toFixed</span><span class="hl-9">(</span><span class="hl-6">3</span><span class="hl-9">)</span><span class="hl-7">}</span><span class="hl-2">%)`</span><span class="hl-1">);</span><br/><span class="hl-1">}</span><br/><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-4">slDistancePercent</span><span class="hl-1"> &gt; </span><span class="hl-8">GLOBAL_CONFIG</span><span class="hl-1">.</span><span class="hl-8">CC_MAX_STOPLOSS_DISTANCE_PERCENT</span><span class="hl-1">) {</span><br/><span class="hl-1">  </span><span class="hl-4">errors</span><span class="hl-1">.</span><span class="hl-0">push</span><span class="hl-1">(</span><span class="hl-2">`Long: StopLoss too far (</span><span class="hl-7">${</span><span class="hl-4">slDistancePercent</span><span class="hl-9">.</span><span class="hl-0">toFixed</span><span class="hl-9">(</span><span class="hl-6">3</span><span class="hl-9">)</span><span class="hl-7">}</span><span class="hl-2">%)`</span><span class="hl-1">);</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<a id="stage-6-lifetime-limit" class="tsd-anchor"></a><h4 class="tsd-anchor-link">Stage 6: Lifetime Limit<a href="#stage-6-lifetime-limit" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><p>Enforces <code>CC_MAX_SIGNAL_LIFETIME_MINUTES</code> (default 1440 minutes = 1 day):</p>
<p>Prevents &quot;eternal signals&quot; that block risk limits indefinitely:</p>
<pre><code class="typescript"><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-4">signal</span><span class="hl-1">.</span><span class="hl-4">minuteEstimatedTime</span><span class="hl-1"> &gt; </span><span class="hl-8">GLOBAL_CONFIG</span><span class="hl-1">.</span><span class="hl-8">CC_MAX_SIGNAL_LIFETIME_MINUTES</span><span class="hl-1">) {</span><br/><span class="hl-1">  </span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">days</span><span class="hl-1"> = (</span><span class="hl-4">signal</span><span class="hl-1">.</span><span class="hl-4">minuteEstimatedTime</span><span class="hl-1"> / </span><span class="hl-6">60</span><span class="hl-1"> / </span><span class="hl-6">24</span><span class="hl-1">).</span><span class="hl-0">toFixed</span><span class="hl-1">(</span><span class="hl-6">1</span><span class="hl-1">);</span><br/><span class="hl-1">  </span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">maxDays</span><span class="hl-1"> = (</span><span class="hl-8">GLOBAL_CONFIG</span><span class="hl-1">.</span><span class="hl-8">CC_MAX_SIGNAL_LIFETIME_MINUTES</span><span class="hl-1"> / </span><span class="hl-6">60</span><span class="hl-1"> / </span><span class="hl-6">24</span><span class="hl-1">).</span><span class="hl-0">toFixed</span><span class="hl-1">(</span><span class="hl-6">0</span><span class="hl-1">);</span><br/><span class="hl-1">  </span><span class="hl-4">errors</span><span class="hl-1">.</span><span class="hl-0">push</span><span class="hl-1">(</span><span class="hl-2">`minuteEstimatedTime too large (</span><span class="hl-7">${</span><span class="hl-4">signal</span><span class="hl-9">.</span><span class="hl-4">minuteEstimatedTime</span><span class="hl-7">}</span><span class="hl-2"> minutes = </span><span class="hl-7">${</span><span class="hl-4">days</span><span class="hl-7">}</span><span class="hl-2"> days). Maximum: </span><span class="hl-7">${</span><span class="hl-4">maxDays</span><span class="hl-7">}</span><span class="hl-2"> days`</span><span class="hl-1">);</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<a id="stage-7-risk-validation" class="tsd-anchor"></a><h4 class="tsd-anchor-link">Stage 7: Risk Validation<a href="#stage-7-risk-validation" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><p>Calls <code>IRisk.checkSignal()</code> with portfolio context:</p>
<pre><code class="typescript"><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">riskPassed</span><span class="hl-1"> = </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-4">self</span><span class="hl-1">.</span><span class="hl-4">params</span><span class="hl-1">.</span><span class="hl-4">risk</span><span class="hl-1">.</span><span class="hl-0">checkSignal</span><span class="hl-1">({</span><br/><span class="hl-1">  </span><span class="hl-4">pendingSignal:</span><span class="hl-1"> </span><span class="hl-4">signal</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">symbol:</span><span class="hl-1"> </span><span class="hl-4">self</span><span class="hl-1">.</span><span class="hl-4">params</span><span class="hl-1">.</span><span class="hl-4">execution</span><span class="hl-1">.</span><span class="hl-4">context</span><span class="hl-1">.</span><span class="hl-4">symbol</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">strategyName:</span><span class="hl-1"> </span><span class="hl-4">self</span><span class="hl-1">.</span><span class="hl-4">params</span><span class="hl-1">.</span><span class="hl-4">method</span><span class="hl-1">.</span><span class="hl-4">context</span><span class="hl-1">.</span><span class="hl-4">strategyName</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">exchangeName:</span><span class="hl-1"> </span><span class="hl-4">self</span><span class="hl-1">.</span><span class="hl-4">params</span><span class="hl-1">.</span><span class="hl-4">method</span><span class="hl-1">.</span><span class="hl-4">context</span><span class="hl-1">.</span><span class="hl-4">exchangeName</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">currentPrice</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">timestamp:</span><span class="hl-1"> </span><span class="hl-4">currentTime</span><span class="hl-1">,</span><br/><span class="hl-1">});</span><br/><span class="hl-3">if</span><span class="hl-1"> (!</span><span class="hl-4">riskPassed</span><span class="hl-1">) {</span><br/><span class="hl-1">  </span><span class="hl-3">return</span><span class="hl-1"> </span><span class="hl-7">null</span><span class="hl-1">; </span><span class="hl-5">// Signal rejected</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<hr>
<a id="state-transitions-in-detail" class="tsd-anchor"></a><h2 class="tsd-anchor-link">State Transitions in Detail<a href="#state-transitions-in-detail" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><a id="immediate-vs-scheduled-signals" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Immediate vs Scheduled Signals<a href="#immediate-vs-scheduled-signals" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>When <code>getSignal()</code> returns a signal, the framework determines activation path:</p>
<p><img src="../media/09_signals-signal-lifecycle_2.svg" alt="Mermaid Diagram"></p>
<p><strong>LONG Position Activation Logic:</strong></p>
<pre><code class="typescript"><span class="hl-5">// LONG = buy lower, wait for price to drop TO priceOpen</span><br/><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-4">signal</span><span class="hl-1">.</span><span class="hl-4">position</span><span class="hl-1"> === </span><span class="hl-2">&quot;long&quot;</span><span class="hl-1"> &amp;&amp; </span><span class="hl-4">currentPrice</span><span class="hl-1"> &lt;= </span><span class="hl-4">signal</span><span class="hl-1">.</span><span class="hl-4">priceOpen</span><span class="hl-1">) {</span><br/><span class="hl-1">  </span><span class="hl-4">shouldActivateImmediately</span><span class="hl-1"> = </span><span class="hl-7">true</span><span class="hl-1">;</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<p><strong>SHORT Position Activation Logic:</strong></p>
<pre><code class="typescript"><span class="hl-5">// SHORT = sell higher, wait for price to rise TO priceOpen</span><br/><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-4">signal</span><span class="hl-1">.</span><span class="hl-4">position</span><span class="hl-1"> === </span><span class="hl-2">&quot;short&quot;</span><span class="hl-1"> &amp;&amp; </span><span class="hl-4">currentPrice</span><span class="hl-1"> &gt;= </span><span class="hl-4">signal</span><span class="hl-1">.</span><span class="hl-4">priceOpen</span><span class="hl-1">) {</span><br/><span class="hl-1">  </span><span class="hl-4">shouldActivateImmediately</span><span class="hl-1"> = </span><span class="hl-7">true</span><span class="hl-1">;</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<a id="scheduled-signal-monitoring" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Scheduled Signal Monitoring<a href="#scheduled-signal-monitoring" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Scheduled signals are monitored every tick for three conditions:</p>
<p><img src="../media/09_signals-signal-lifecycle_3.svg" alt="Mermaid Diagram"></p>
<p><strong>Critical Order:</strong> SL check BEFORE activation check prevents &quot;open-and-immediately-stop&quot; scenarios.</p>
<p><strong>LONG Scheduled Monitoring:</strong></p>
<pre><code class="typescript"><span class="hl-5">// Priority 1: Check StopLoss (CANCELLATION)</span><br/><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-4">currentPrice</span><span class="hl-1"> &lt;= </span><span class="hl-4">scheduled</span><span class="hl-1">.</span><span class="hl-4">priceStopLoss</span><span class="hl-1">) {</span><br/><span class="hl-1">  </span><span class="hl-4">shouldCancel</span><span class="hl-1"> = </span><span class="hl-7">true</span><span class="hl-1">;</span><br/><span class="hl-1">}</span><br/><span class="hl-5">// Priority 2: Check Activation (only if SL not breached)</span><br/><span class="hl-3">else</span><span class="hl-1"> </span><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-4">currentPrice</span><span class="hl-1"> &lt;= </span><span class="hl-4">scheduled</span><span class="hl-1">.</span><span class="hl-4">priceOpen</span><span class="hl-1">) {</span><br/><span class="hl-1">  </span><span class="hl-4">shouldActivate</span><span class="hl-1"> = </span><span class="hl-7">true</span><span class="hl-1">;</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<p><strong>SHORT Scheduled Monitoring:</strong></p>
<pre><code class="typescript"><span class="hl-5">// Priority 1: Check StopLoss (CANCELLATION)</span><br/><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-4">currentPrice</span><span class="hl-1"> &gt;= </span><span class="hl-4">scheduled</span><span class="hl-1">.</span><span class="hl-4">priceStopLoss</span><span class="hl-1">) {</span><br/><span class="hl-1">  </span><span class="hl-4">shouldCancel</span><span class="hl-1"> = </span><span class="hl-7">true</span><span class="hl-1">;</span><br/><span class="hl-1">}</span><br/><span class="hl-5">// Priority 2: Check Activation (only if SL not breached)</span><br/><span class="hl-3">else</span><span class="hl-1"> </span><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-4">currentPrice</span><span class="hl-1"> &gt;= </span><span class="hl-4">scheduled</span><span class="hl-1">.</span><span class="hl-4">priceOpen</span><span class="hl-1">) {</span><br/><span class="hl-1">  </span><span class="hl-4">shouldActivate</span><span class="hl-1"> = </span><span class="hl-7">true</span><span class="hl-1">;</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<a id="active-signal-monitoring" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Active Signal Monitoring<a href="#active-signal-monitoring" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Once opened, signals are monitored for three exit conditions:</p>
<p><img src="../media/09_signals-signal-lifecycle_4.svg" alt="Mermaid Diagram"></p>
<p><strong>Partial Profit/Loss Tracking:</strong></p>
<p>During active monitoring, the framework tracks milestones:</p>
<ul>
<li>Profit: 10%, 20%, 30%, ..., 100%</li>
<li>Loss: -10%, -20%, -30%, ..., -100%</li>
</ul>
<p>Each level emitted once per signal via <code>ClientPartial</code> deduplication.</p>
<hr>
<a id="persistence--crash-recovery" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Persistence &amp; Crash Recovery<a href="#persistence--crash-recovery" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><a id="persistence-strategy" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Persistence Strategy<a href="#persistence-strategy" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>The framework uses two separate persistence adapters:</p>
<table>
<thead>
<tr>
<th>Adapter</th>
<th>Stores</th>
<th>When</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>PersistScheduleAdapter</code></td>
<td><code>IScheduledSignalRow</code></td>
<td>Scheduled signals</td>
<td>Restore pending limit orders</td>
</tr>
<tr>
<td><code>PersistSignalAdapter</code></td>
<td><code>ISignalRow</code></td>
<td>Opened/active signals</td>
<td>Restore active positions</td>
</tr>
</tbody>
</table>
<p><strong>Critical:</strong> Scheduled signals NOT persisted to <code>PersistSignalAdapter</code> until activation.</p>
<a id="crash-recovery-flow" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Crash Recovery Flow<a href="#crash-recovery-flow" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><img src="../media/09_signals-signal-lifecycle_5.svg" alt="Mermaid Diagram"></p>
<p><strong>Implementation:</strong></p>
<p>The <code>waitForInit()</code> method (called before first tick) restores state:</p>
<pre><code class="typescript"><span class="hl-4">async</span><span class="hl-1"> </span><span class="hl-0">waitForInit</span><span class="hl-1">() {</span><br/><span class="hl-1">  </span><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-4">backtest</span><span class="hl-1">) </span><span class="hl-3">return</span><span class="hl-1">; </span><span class="hl-5">// Only for live mode</span><br/><span class="hl-1">  </span><br/><span class="hl-1">  </span><span class="hl-5">// Restore pending signal</span><br/><span class="hl-1">  </span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">pendingSignal</span><span class="hl-1"> = </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-4">PersistSignalAdapter</span><span class="hl-1">.</span><span class="hl-0">readSignalData</span><span class="hl-1">(</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">strategyName</span><span class="hl-1">);</span><br/><span class="hl-1">  </span><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-4">pendingSignal</span><span class="hl-1">) {</span><br/><span class="hl-1">    </span><span class="hl-7">this</span><span class="hl-1">.</span><span class="hl-4">_pendingSignal</span><span class="hl-1"> = </span><span class="hl-4">pendingSignal</span><span class="hl-1">;</span><br/><span class="hl-1">    </span><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-4">callbacks</span><span class="hl-1">?.</span><span class="hl-4">onActive</span><span class="hl-1">) {</span><br/><span class="hl-1">      </span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">currentPrice</span><span class="hl-1"> = </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-4">exchange</span><span class="hl-1">.</span><span class="hl-0">getAveragePrice</span><span class="hl-1">(</span><span class="hl-4">symbol</span><span class="hl-1">);</span><br/><span class="hl-1">      </span><span class="hl-4">callbacks</span><span class="hl-1">.</span><span class="hl-0">onActive</span><span class="hl-1">(</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">pendingSignal</span><span class="hl-1">, </span><span class="hl-4">currentPrice</span><span class="hl-1">, </span><span class="hl-7">false</span><span class="hl-1">);</span><br/><span class="hl-1">    }</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">  </span><br/><span class="hl-1">  </span><span class="hl-5">// Restore scheduled signal</span><br/><span class="hl-1">  </span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">scheduledSignal</span><span class="hl-1"> = </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-4">PersistScheduleAdapter</span><span class="hl-1">.</span><span class="hl-0">readScheduleData</span><span class="hl-1">(</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">strategyName</span><span class="hl-1">);</span><br/><span class="hl-1">  </span><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-4">scheduledSignal</span><span class="hl-1">) {</span><br/><span class="hl-1">    </span><span class="hl-7">this</span><span class="hl-1">.</span><span class="hl-4">_scheduledSignal</span><span class="hl-1"> = </span><span class="hl-4">scheduledSignal</span><span class="hl-1">;</span><br/><span class="hl-1">    </span><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-4">callbacks</span><span class="hl-1">?.</span><span class="hl-4">onSchedule</span><span class="hl-1">) {</span><br/><span class="hl-1">      </span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">currentPrice</span><span class="hl-1"> = </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-4">exchange</span><span class="hl-1">.</span><span class="hl-0">getAveragePrice</span><span class="hl-1">(</span><span class="hl-4">symbol</span><span class="hl-1">);</span><br/><span class="hl-1">      </span><span class="hl-4">callbacks</span><span class="hl-1">.</span><span class="hl-0">onSchedule</span><span class="hl-1">(</span><span class="hl-4">symbol</span><span class="hl-1">, </span><span class="hl-4">scheduledSignal</span><span class="hl-1">, </span><span class="hl-4">currentPrice</span><span class="hl-1">, </span><span class="hl-7">false</span><span class="hl-1">);</span><br/><span class="hl-1">    }</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<p><strong>Atomic Write Operations:</strong></p>
<p>All persistence operations are atomic (write-delete patterns):</p>
<ol>
<li><strong>Signal Opens:</strong> Write to <code>PersistSignalAdapter</code></li>
<li><strong>Signal Closes:</strong> Delete from <code>PersistSignalAdapter</code></li>
<li><strong>Scheduled Created:</strong> Write to <code>PersistScheduleAdapter</code></li>
<li><strong>Scheduled Activates:</strong> Delete from <code>PersistScheduleAdapter</code> → Write to <code>PersistSignalAdapter</code></li>
<li><strong>Scheduled Cancels:</strong> Delete from <code>PersistScheduleAdapter</code></li>
</ol>
<hr>
<a id="practical-examples" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Practical Examples<a href="#practical-examples" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><a id="example-1-immediate-long-signal" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Example 1: Immediate LONG Signal<a href="#example-1-immediate-long-signal" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><pre><code class="typescript"><span class="hl-5">// User&#39;s getSignal() returns:</span><br/><span class="hl-1">{</span><br/><span class="hl-1">  </span><span class="hl-10">position</span><span class="hl-1">: </span><span class="hl-2">&quot;long&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-10">priceTakeProfit</span><span class="hl-1">: </span><span class="hl-6">51000</span><span class="hl-1">,  </span><span class="hl-5">// 2% profit target</span><br/><span class="hl-1">  </span><span class="hl-10">priceStopLoss</span><span class="hl-1">: </span><span class="hl-6">49000</span><span class="hl-1">,    </span><span class="hl-5">// 2% risk</span><br/><span class="hl-1">  </span><span class="hl-10">minuteEstimatedTime</span><span class="hl-1">: </span><span class="hl-6">120</span><span class="hl-1"> </span><span class="hl-5">// 2 hours max</span><br/><span class="hl-1">  </span><span class="hl-5">// priceOpen omitted → immediate entry</span><br/><span class="hl-1">}</span><br/><br/><span class="hl-5">// System behavior:</span><br/><span class="hl-5">// 1. Current price: 50000 (VWAP)</span><br/><span class="hl-5">// 2. Set priceOpen = 50000</span><br/><span class="hl-5">// 3. Validate:</span><br/><span class="hl-5">//    - TP distance: (51000-50000)/50000 = 2% ✓ (&gt;0.5% minimum)</span><br/><span class="hl-5">//    - SL distance: (50000-49000)/50000 = 2% ✓ (between 0.5%-20%)</span><br/><span class="hl-5">// 4. Create ISignalRow with _isScheduled=false</span><br/><span class="hl-5">// 5. Persist to PersistSignalAdapter</span><br/><span class="hl-5">// 6. Emit &quot;opened&quot; event</span><br/><span class="hl-5">// 7. Monitor for TP/SL/time_expired</span>
</code><button type="button">Copy</button></pre>

<a id="example-2-scheduled-short-signal" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Example 2: Scheduled SHORT Signal<a href="#example-2-scheduled-short-signal" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><pre><code class="typescript"><span class="hl-5">// User&#39;s getSignal() returns:</span><br/><span class="hl-1">{</span><br/><span class="hl-1">  </span><span class="hl-10">position</span><span class="hl-1">: </span><span class="hl-2">&quot;short&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-10">priceOpen</span><span class="hl-1">: </span><span class="hl-6">51000</span><span class="hl-1">,        </span><span class="hl-5">// Wait for price to rise to 51000</span><br/><span class="hl-1">  </span><span class="hl-10">priceTakeProfit</span><span class="hl-1">: </span><span class="hl-6">49000</span><span class="hl-1">,  </span><span class="hl-5">// Exit at 49000 (profit)</span><br/><span class="hl-1">  </span><span class="hl-10">priceStopLoss</span><span class="hl-1">: </span><span class="hl-6">52000</span><span class="hl-1">,    </span><span class="hl-5">// Exit at 52000 (loss)</span><br/><span class="hl-1">  </span><span class="hl-10">minuteEstimatedTime</span><span class="hl-1">: </span><span class="hl-6">60</span><br/><span class="hl-1">}</span><br/><br/><span class="hl-5">// Current price: 50000 (below priceOpen)</span><br/><br/><span class="hl-5">// System behavior:</span><br/><span class="hl-5">// 1. Price 50000 &lt; priceOpen 51000 → Create scheduled signal</span><br/><span class="hl-5">// 2. Validate with scheduled=true</span><br/><span class="hl-5">// 3. Create IScheduledSignalRow with _isScheduled=true</span><br/><span class="hl-5">// 4. Persist to PersistScheduleAdapter</span><br/><span class="hl-5">// 5. Emit &quot;scheduled&quot; event</span><br/><span class="hl-5">// 6. Monitor every tick:</span><br/><span class="hl-5">//    - If price &gt;= 52000 (SL) → Cancel</span><br/><span class="hl-5">//    - If price &gt;= 51000 (priceOpen) → Activate</span><br/><span class="hl-5">// 7. On activation:</span><br/><span class="hl-5">//    - Delete from PersistScheduleAdapter</span><br/><span class="hl-5">//    - Create ISignalRow</span><br/><span class="hl-5">//    - Persist to PersistSignalAdapter</span><br/><span class="hl-5">//    - Emit &quot;opened&quot; event</span>
</code><button type="button">Copy</button></pre>

<a id="example-3-scheduled-signal-cancellation" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Example 3: Scheduled Signal Cancellation<a href="#example-3-scheduled-signal-cancellation" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><pre><code class="typescript"><span class="hl-5">// Scheduled LONG signal:</span><br/><span class="hl-1">{</span><br/><span class="hl-1">  </span><span class="hl-10">position</span><span class="hl-1">: </span><span class="hl-2">&quot;long&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-10">priceOpen</span><span class="hl-1">: </span><span class="hl-6">49000</span><span class="hl-1">,        </span><span class="hl-5">// Wait for price drop</span><br/><span class="hl-1">  </span><span class="hl-10">priceTakeProfit</span><span class="hl-1">: </span><span class="hl-6">51000</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-10">priceStopLoss</span><span class="hl-1">: </span><span class="hl-6">48000</span><span class="hl-1">,    </span><span class="hl-5">// Cancel if price drops too far</span><br/><span class="hl-1">  </span><span class="hl-10">minuteEstimatedTime</span><span class="hl-1">: </span><span class="hl-6">30</span><br/><span class="hl-1">}</span><br/><br/><span class="hl-5">// Current price: 50000 (above priceOpen)</span><br/><br/><span class="hl-5">// Cancellation scenarios:</span><br/><br/><span class="hl-5">// Scenario A: Price drops PAST stop loss</span><br/><span class="hl-5">// Tick 1: price=50000 → scheduled (waiting)</span><br/><span class="hl-5">// Tick 2: price=49500 → scheduled (waiting)</span><br/><span class="hl-5">// Tick 3: price=47500 → CANCELLED (SL=48000 breached before priceOpen reached)</span><br/><br/><span class="hl-5">// Scenario B: Timeout</span><br/><span class="hl-5">// Price stays above 49000 for 120 minutes (CC_SCHEDULE_AWAIT_MINUTES)</span><br/><span class="hl-5">// → CANCELLED (exceeded wait time)</span>
</code><button type="button">Copy</button></pre>

<a id="example-4-validation-failure---micro-profit" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Example 4: Validation Failure - Micro-Profit<a href="#example-4-validation-failure---micro-profit" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><pre><code class="typescript"><span class="hl-5">// User returns signal with tiny profit margin:</span><br/><span class="hl-1">{</span><br/><span class="hl-1">  </span><span class="hl-10">position</span><span class="hl-1">: </span><span class="hl-2">&quot;long&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-10">priceOpen</span><span class="hl-1">: </span><span class="hl-6">42000</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-10">priceTakeProfit</span><span class="hl-1">: </span><span class="hl-6">42010</span><span class="hl-1">,  </span><span class="hl-5">// Only 0.024% profit!</span><br/><span class="hl-1">  </span><span class="hl-10">priceStopLoss</span><span class="hl-1">: </span><span class="hl-6">41000</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-10">minuteEstimatedTime</span><span class="hl-1">: </span><span class="hl-6">60</span><br/><span class="hl-1">}</span><br/><br/><span class="hl-5">// Validation fails at Stage 4:</span><br/><span class="hl-5">// TP distance: (42010-42000)/42000 = 0.024%</span><br/><span class="hl-5">// Minimum required: 0.5% (to cover 0.4% fees/slippage + 0.1% buffer)</span><br/><span class="hl-5">// Error: &quot;Long: TakeProfit too close to priceOpen (0.024%). Minimum distance: 0.5%&quot;</span><br/><span class="hl-5">// Signal rejected, no position opened</span>
</code><button type="button">Copy</button></pre>

<hr>
<a id="signal-sequencing-constraint" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Signal Sequencing Constraint<a href="#signal-sequencing-constraint" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p><strong>Critical Design Principle:</strong> Only ONE active signal per symbol at any time.</p>
<a id="queue-behavior" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Queue Behavior<a href="#queue-behavior" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><img src="../media/09_signals-signal-lifecycle_6.svg" alt="Mermaid Diagram"></p>
<p><strong>Rationale:</strong></p>
<ul>
<li>Prevents position size explosions</li>
<li>Maintains predictable risk exposure</li>
<li>Simplifies state management</li>
<li>Enables reliable crash recovery</li>
</ul>
<p><strong>Implementation:</strong> The <code>tick()</code> method checks for active signal before calling <code>getSignal()</code>:</p>
<pre><code class="typescript"><span class="hl-4">async</span><span class="hl-1"> </span><span class="hl-0">tick</span><span class="hl-1">() {</span><br/><span class="hl-1">  </span><span class="hl-5">// Check for existing active signal</span><br/><span class="hl-1">  </span><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-7">this</span><span class="hl-1">.</span><span class="hl-4">_pendingSignal</span><span class="hl-1">) {</span><br/><span class="hl-1">    </span><span class="hl-3">return</span><span class="hl-1"> </span><span class="hl-0">monitorActiveSignal</span><span class="hl-1">();</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">  </span><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-7">this</span><span class="hl-1">.</span><span class="hl-4">_scheduledSignal</span><span class="hl-1">) {</span><br/><span class="hl-1">    </span><span class="hl-3">return</span><span class="hl-1"> </span><span class="hl-0">monitorScheduledSignal</span><span class="hl-1">();</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">  </span><br/><span class="hl-1">  </span><span class="hl-5">// Only call getSignal() when idle</span><br/><span class="hl-1">  </span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">newSignal</span><span class="hl-1"> = </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-0">GET_SIGNAL_FN</span><span class="hl-1">(</span><span class="hl-7">this</span><span class="hl-1">);</span><br/><span class="hl-1">  </span><span class="hl-3">if</span><span class="hl-1"> (!</span><span class="hl-4">newSignal</span><span class="hl-1">) {</span><br/><span class="hl-1">    </span><span class="hl-3">return</span><span class="hl-1"> </span><span class="hl-0">idleResult</span><span class="hl-1">();</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">  </span><br/><span class="hl-1">  </span><span class="hl-3">return</span><span class="hl-1"> </span><span class="hl-0">processNewSignal</span><span class="hl-1">(</span><span class="hl-4">newSignal</span><span class="hl-1">);</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

</div></div><div class="col-sidebar"><div class="page-menu"><div class="tsd-navigation settings"><details class="tsd-accordion"><summary class="tsd-accordion-summary"><h3><svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-chevronDown"></use></svg>Settings</h3></summary><div class="tsd-accordion-details"><div class="tsd-filter-visibility"><span class="settings-label">Member Visibility</span><ul id="tsd-filter-options"><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-protected" name="protected"/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Protected</span></label></li><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-inherited" name="inherited" checked/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Inherited</span></label></li><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-external" name="external"/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>External</span></label></li></ul></div><div class="tsd-theme-toggle"><label class="settings-label" for="tsd-theme">Theme</label><select id="tsd-theme"><option value="os">OS</option><option value="light">Light</option><option value="dark">Dark</option></select></div></div></details></div><details open class="tsd-accordion tsd-page-navigation"><summary class="tsd-accordion-summary"><h3><svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-chevronDown"></use></svg>On This Page</h3></summary><div class="tsd-accordion-details"><a href="#signals--signal-lifecycle"><span>Signals &amp; <wbr/>Signal <wbr/>Lifecycle</span></a><ul><li><a href="#purpose-and-scope"><span>Purpose and <wbr/>Scope</span></a></li><li><a href="#core-signal-types"><span>Core <wbr/>Signal <wbr/>Types</span></a></li><li><ul><li><a href="#isignaldto-structure"><span>ISignal<wbr/>Dto <wbr/>Structure</span></a></li><li><a href="#isignalrow-structure"><span>ISignal<wbr/>Row <wbr/>Structure</span></a></li></ul></li><li><a href="#signal-lifecycle-state-machine"><span>Signal <wbr/>Lifecycle <wbr/>State <wbr/>Machine</span></a></li><li><ul><li><a href="#state-overview"><span>State <wbr/>Overview</span></a></li><li><a href="#state-descriptions"><span>State <wbr/>Descriptions</span></a></li></ul></li><li><a href="#validation-pipeline"><span>Validation <wbr/>Pipeline</span></a></li><li><ul><li><a href="#seven-stage-validation"><span>Seven-<wbr/>Stage <wbr/>Validation</span></a></li><li><a href="#stage-details"><span>Stage <wbr/>Details</span></a></li><li><ul><li><a href="#stage-1-schema-validation"><span>Stage 1: <wbr/>Schema <wbr/>Validation</span></a></li><li><a href="#stage-2-positive-price-check"><span>Stage 2: <wbr/>Positive <wbr/>Price <wbr/>Check</span></a></li><li><a href="#stage-3-tpsl-logic-validation"><span>Stage 3: TP/SL <wbr/>Logic <wbr/>Validation</span></a></li><li><a href="#stage-4-minimum-tp-distance"><span>Stage 4: <wbr/>Minimum TP <wbr/>Distance</span></a></li><li><a href="#stage-5-sl-range-validation"><span>Stage 5: SL <wbr/>Range <wbr/>Validation</span></a></li><li><a href="#stage-6-lifetime-limit"><span>Stage 6: <wbr/>Lifetime <wbr/>Limit</span></a></li><li><a href="#stage-7-risk-validation"><span>Stage 7: <wbr/>Risk <wbr/>Validation</span></a></li></ul></li></ul></li><li><a href="#state-transitions-in-detail"><span>State <wbr/>Transitions in <wbr/>Detail</span></a></li><li><ul><li><a href="#immediate-vs-scheduled-signals"><span>Immediate vs <wbr/>Scheduled <wbr/>Signals</span></a></li><li><a href="#scheduled-signal-monitoring"><span>Scheduled <wbr/>Signal <wbr/>Monitoring</span></a></li><li><a href="#active-signal-monitoring"><span>Active <wbr/>Signal <wbr/>Monitoring</span></a></li></ul></li><li><a href="#persistence--crash-recovery"><span>Persistence &amp; <wbr/>Crash <wbr/>Recovery</span></a></li><li><ul><li><a href="#persistence-strategy"><span>Persistence <wbr/>Strategy</span></a></li><li><a href="#crash-recovery-flow"><span>Crash <wbr/>Recovery <wbr/>Flow</span></a></li></ul></li><li><a href="#practical-examples"><span>Practical <wbr/>Examples</span></a></li><li><ul><li><a href="#example-1-immediate-long-signal"><span>Example 1: <wbr/>Immediate LONG <wbr/>Signal</span></a></li><li><a href="#example-2-scheduled-short-signal"><span>Example 2: <wbr/>Scheduled SHORT <wbr/>Signal</span></a></li><li><a href="#example-3-scheduled-signal-cancellation"><span>Example 3: <wbr/>Scheduled <wbr/>Signal <wbr/>Cancellation</span></a></li><li><a href="#example-4-validation-failure---micro-profit"><span>Example 4: <wbr/>Validation <wbr/>Failure -<wbr/> <wbr/>Micro-<wbr/>Profit</span></a></li></ul></li><li><a href="#signal-sequencing-constraint"><span>Signal <wbr/>Sequencing <wbr/>Constraint</span></a></li><li><ul><li><a href="#queue-behavior"><span>Queue <wbr/>Behavior</span></a></li></ul></li></ul></div></details></div><div class="site-menu"><nav class="tsd-navigation"><a href="../modules.html">backtest-kit</a><ul class="tsd-small-nested-navigation" id="tsd-nav-container"><li>Loading...</li></ul></nav></div></div></div><footer><p class="tsd-generator">Generated using <a href="https://typedoc.org/" target="_blank">TypeDoc</a></p></footer><div class="overlay"></div></body></html>

<!-- Yandex.Metrika counter -->
<script type="text/javascript">
    (function(m,e,t,r,i,k,a){
        m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
        m[i].l=1*new Date();
        for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }}
        k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)
    })(window, document,'script','https://mc.yandex.ru/metrika/tag.js?id=105455585', 'ym');

    ym(105455585, 'init', {ssr:true, webvisor:true, clickmap:true, ecommerce:"dataLayer", accurateTrackBounce:true, trackLinks:true});
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/105455585" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
<!-- /Yandex.Metrika counter -->

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-3MQZEBBDDR"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-3MQZEBBDDR');
</script>
