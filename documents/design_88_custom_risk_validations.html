<!DOCTYPE html><html class="default" lang="en" data-base=".."><head><meta charset="utf-8"/><meta http-equiv="x-ua-compatible" content="IE=edge"/><title>design/88_custom_risk_validations | backtest-kit</title><meta name="description" content="Documentation for backtest-kit"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="stylesheet" href="../assets/style.css"/><link rel="stylesheet" href="../assets/highlight.css"/><script defer src="../assets/main.js"></script><script async src="../assets/icons.js" id="tsd-icons-script"></script><script async src="../assets/search.js" id="tsd-search-script"></script><script async src="../assets/navigation.js" id="tsd-nav-script"></script><script async src="../assets/hierarchy.js" id="tsd-hierarchy-script"></script></head><body><script>document.documentElement.dataset.theme = localStorage.getItem("tsd-theme") || "os";document.body.style.display="none";setTimeout(() => app?app.showPage():document.body.style.removeProperty("display"),500)</script><header class="tsd-page-toolbar"><div class="tsd-toolbar-contents container"><div class="table-cell" id="tsd-search"><div class="field"><label for="tsd-search-field" class="tsd-widget tsd-toolbar-icon search no-caption"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-search"></use></svg></label><input type="text" id="tsd-search-field" aria-label="Search"/></div><div class="field"><div id="tsd-toolbar-links"></div></div><ul class="results"><li class="state loading">Preparing search index...</li><li class="state failure">The search index is not available</li></ul><a href="../index.html" class="title">backtest-kit</a></div><div class="table-cell" id="tsd-widgets"><a href="#" class="tsd-widget tsd-toolbar-icon menu no-caption" data-toggle="menu" aria-label="Menu"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-menu"></use></svg></a></div></div></header><div class="container container-main"><div class="col-content"><div class="tsd-page-title"><ul class="tsd-breadcrumb"><li><a href="../modules.html">backtest-kit</a></li><li><a href="design_88_custom_risk_validations.html">design/88_custom_risk_validations</a></li></ul></div><div class="tsd-panel tsd-typography"><a id="custom-risk-validations" class="tsd-anchor"></a><h1 class="tsd-anchor-link">Custom Risk Validations<a href="#custom-risk-validations" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h1><p>Custom risk validations allow you to define portfolio-level constraints and business rules that prevent signals from opening positions when specific conditions are not met. This guide covers how to implement custom validation functions using the <code>IRiskValidation</code> interface with access to <code>IRiskValidationPayload</code>.</p>
<p>For risk profile configuration basics, see <a href="design_68_risk_profiles.html">Risk Profiles</a>. For position tracking implementation, see <a href="design_70_position_tracking.html">Position Tracking</a>. For risk validation chain execution, see <a href="design_69_risk_validation.html">Risk Validation</a>.</p>
<hr>
<a id="purpose-and-scope" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Purpose and Scope<a href="#purpose-and-scope" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>Custom risk validations provide a declarative way to enforce trading constraints at the portfolio level before positions are opened. Each validation function receives comprehensive context including:</p>
<ul>
<li>The pending signal to be opened</li>
<li>Current market price and timestamp</li>
<li>Active positions across all strategies</li>
<li>Strategy and exchange identifiers</li>
</ul>
<p>Validations execute synchronously in the order defined and can reject signals by throwing errors. This system prevents capital deployment that violates risk limits, ensuring disciplined execution.</p>
<hr>
<a id="risk-validation-architecture" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Risk Validation Architecture<a href="#risk-validation-architecture" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p><img src="../media/88_Custom_Risk_Validations_0.svg" alt="Mermaid Diagram"></p>
<p><strong>Validation Timing</strong>: Risk validations execute <strong>after</strong> signal generation but <strong>before</strong> position opening. This ensures that portfolio state is current and no capital is committed until all checks pass.</p>
<hr>
<a id="iriskvalidation-interface" class="tsd-anchor"></a><h2 class="tsd-anchor-link">IRiskValidation Interface<a href="#iriskvalidation-interface" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><a id="core-structure" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Core Structure<a href="#core-structure" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><pre><code class="typescript"><span class="hl-3">interface</span><span class="hl-2"> </span><span class="hl-11">IRiskValidation</span><span class="hl-2"> {</span><br/><span class="hl-2">  </span><span class="hl-6">validate</span><span class="hl-2">: </span><span class="hl-11">IRiskValidationFn</span><span class="hl-2">;</span><br/><span class="hl-2">  </span><span class="hl-6">note</span><span class="hl-2">?: </span><span class="hl-11">string</span><span class="hl-2">;</span><br/><span class="hl-2">}</span><br/><br/><span class="hl-3">interface</span><span class="hl-2"> </span><span class="hl-11">IRiskValidationFn</span><span class="hl-2"> {</span><br/><span class="hl-2">  (</span><span class="hl-6">payload</span><span class="hl-2">: </span><span class="hl-11">IRiskValidationPayload</span><span class="hl-2">): </span><span class="hl-11">void</span><span class="hl-2"> | </span><span class="hl-11">Promise</span><span class="hl-2">&lt;</span><span class="hl-11">void</span><span class="hl-2">&gt;;</span><br/><span class="hl-2">}</span>
</code><button type="button">Copy</button></pre>

<p>The <code>IRiskValidation</code> interface has two properties:</p>
<table>
<thead>
<tr>
<th>Property</th>
<th>Type</th>
<th>Required</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>validate</code></td>
<td><code>IRiskValidationFn</code></td>
<td>Yes</td>
<td>Validation logic function</td>
</tr>
<tr>
<td><code>note</code></td>
<td><code>string</code></td>
<td>No</td>
<td>Human-readable description for logging/debugging</td>
</tr>
</tbody>
</table>
<p><strong>Key Characteristics</strong>:</p>
<ol>
<li><strong>Synchronous or Async</strong>: Validation functions can be sync or return <code>Promise&lt;void&gt;</code></li>
<li><strong>Exception-Based</strong>: Throw errors to reject signals; return normally to allow</li>
<li><strong>Sequential Execution</strong>: Validations run in array order; first error stops the chain</li>
<li><strong>No Return Value</strong>: Functions return <code>void</code> - all communication via exceptions</li>
</ol>
<hr>
<a id="iriskvalidationpayload-structure" class="tsd-anchor"></a><h2 class="tsd-anchor-link">IRiskValidationPayload Structure<a href="#iriskvalidationpayload-structure" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p><img src="../media/88_Custom_Risk_Validations_1.svg" alt="Mermaid Diagram"></p>
<a id="payload-properties" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Payload Properties<a href="#payload-properties" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><a id="from-iriskcheckargs-base-context" class="tsd-anchor"></a><h4 class="tsd-anchor-link">From IRiskCheckArgs (Base Context)<a href="#from-iriskcheckargs-base-context" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><table>
<thead>
<tr>
<th>Property</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>symbol</code></td>
<td><code>string</code></td>
<td>Trading pair (e.g., <code>&quot;BTCUSDT&quot;</code>)</td>
</tr>
<tr>
<td><code>pendingSignal</code></td>
<td><code>ISignalDto</code></td>
<td>Signal to be validated</td>
</tr>
<tr>
<td><code>strategyName</code></td>
<td><code>string</code></td>
<td>Strategy requesting position</td>
</tr>
<tr>
<td><code>exchangeName</code></td>
<td><code>string</code></td>
<td>Exchange identifier</td>
</tr>
<tr>
<td><code>currentPrice</code></td>
<td><code>number</code></td>
<td>Current VWAP price</td>
</tr>
<tr>
<td><code>timestamp</code></td>
<td><code>number</code></td>
<td>Unix timestamp in milliseconds</td>
</tr>
</tbody>
</table>
<a id="portfolio-state-extensions" class="tsd-anchor"></a><h4 class="tsd-anchor-link">Portfolio State Extensions<a href="#portfolio-state-extensions" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><table>
<thead>
<tr>
<th>Property</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>activePositionCount</code></td>
<td><code>number</code></td>
<td>Total open positions across all strategies</td>
</tr>
<tr>
<td><code>activePositions</code></td>
<td><code>IRiskActivePosition[]</code></td>
<td>Full list of active positions with details</td>
</tr>
</tbody>
</table>
<a id="iriskactiveposition-structure" class="tsd-anchor"></a><h4 class="tsd-anchor-link">IRiskActivePosition Structure<a href="#iriskactiveposition-structure" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><p>Each active position contains:</p>
<pre><code class="typescript"><span class="hl-3">interface</span><span class="hl-2"> </span><span class="hl-11">IRiskActivePosition</span><span class="hl-2"> {</span><br/><span class="hl-2">  </span><span class="hl-6">signal</span><span class="hl-2">: </span><span class="hl-11">ISignalRow</span><span class="hl-2">;          </span><span class="hl-0">// Full signal details</span><br/><span class="hl-2">  </span><span class="hl-6">strategyName</span><span class="hl-2">: </span><span class="hl-11">string</span><span class="hl-2">;        </span><span class="hl-0">// Owning strategy</span><br/><span class="hl-2">  </span><span class="hl-6">exchangeName</span><span class="hl-2">: </span><span class="hl-11">string</span><span class="hl-2">;        </span><span class="hl-0">// Exchange used</span><br/><span class="hl-2">  </span><span class="hl-6">openTimestamp</span><span class="hl-2">: </span><span class="hl-11">number</span><span class="hl-2">;       </span><span class="hl-0">// When position opened (ms)</span><br/><span class="hl-2">}</span>
</code><button type="button">Copy</button></pre>

<hr>
<a id="validation-function-registration" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Validation Function Registration<a href="#validation-function-registration" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><a id="short-form-function-only" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Short Form (Function Only)<a href="#short-form-function-only" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><pre><code class="typescript"><span class="hl-1">addRisk</span><span class="hl-2">({</span><br/><span class="hl-2">  </span><span class="hl-6">riskName:</span><span class="hl-2"> </span><span class="hl-4">&quot;my-risk&quot;</span><span class="hl-2">,</span><br/><span class="hl-2">  </span><span class="hl-6">validations:</span><span class="hl-2"> [</span><br/><span class="hl-2">    </span><span class="hl-0">// Direct function - no note</span><br/><span class="hl-2">    ({ </span><span class="hl-6">activePositionCount</span><span class="hl-2"> }) </span><span class="hl-3">=&gt;</span><span class="hl-2"> {</span><br/><span class="hl-2">      </span><span class="hl-5">if</span><span class="hl-2"> (</span><span class="hl-6">activePositionCount</span><span class="hl-2"> &gt;= </span><span class="hl-7">3</span><span class="hl-2">) {</span><br/><span class="hl-2">        </span><span class="hl-5">throw</span><span class="hl-2"> </span><span class="hl-3">new</span><span class="hl-2"> </span><span class="hl-1">Error</span><span class="hl-2">(</span><span class="hl-4">&quot;Max 3 concurrent positions&quot;</span><span class="hl-2">);</span><br/><span class="hl-2">      }</span><br/><span class="hl-2">    }</span><br/><span class="hl-2">  ]</span><br/><span class="hl-2">});</span>
</code><button type="button">Copy</button></pre>

<a id="long-form-iriskvalidation-object" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Long Form (IRiskValidation Object)<a href="#long-form-iriskvalidation-object" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><pre><code class="typescript"><span class="hl-1">addRisk</span><span class="hl-2">({</span><br/><span class="hl-2">  </span><span class="hl-6">riskName:</span><span class="hl-2"> </span><span class="hl-4">&quot;my-risk&quot;</span><span class="hl-2">,</span><br/><span class="hl-2">  </span><span class="hl-6">validations:</span><span class="hl-2"> [</span><br/><span class="hl-2">    {</span><br/><span class="hl-2">      </span><span class="hl-1">validate</span><span class="hl-6">:</span><span class="hl-2"> ({ </span><span class="hl-6">activePositionCount</span><span class="hl-2"> }) </span><span class="hl-3">=&gt;</span><span class="hl-2"> {</span><br/><span class="hl-2">        </span><span class="hl-5">if</span><span class="hl-2"> (</span><span class="hl-6">activePositionCount</span><span class="hl-2"> &gt;= </span><span class="hl-7">3</span><span class="hl-2">) {</span><br/><span class="hl-2">          </span><span class="hl-5">throw</span><span class="hl-2"> </span><span class="hl-3">new</span><span class="hl-2"> </span><span class="hl-1">Error</span><span class="hl-2">(</span><span class="hl-4">&quot;Max 3 concurrent positions&quot;</span><span class="hl-2">);</span><br/><span class="hl-2">        }</span><br/><span class="hl-2">      },</span><br/><span class="hl-2">      </span><span class="hl-6">note:</span><span class="hl-2"> </span><span class="hl-4">&quot;Limit portfolio to 3 concurrent positions for capital preservation&quot;</span><br/><span class="hl-2">    }</span><br/><span class="hl-2">  ]</span><br/><span class="hl-2">});</span>
</code><button type="button">Copy</button></pre>

<p><strong>Note Benefits</strong>:</p>
<ul>
<li>Appears in rejection events via <code>riskSubject</code></li>
<li>Logged when validation fails</li>
<li>Aids debugging and monitoring</li>
</ul>
<hr>
<a id="common-validation-patterns" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Common Validation Patterns<a href="#common-validation-patterns" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><a id="pattern-1-position-count-limits" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Pattern 1: Position Count Limits<a href="#pattern-1-position-count-limits" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Prevent over-leveraging by limiting concurrent positions:</p>
<pre><code class="typescript"><span class="hl-2">{</span><br/><span class="hl-2">  </span><span class="hl-10">validate</span><span class="hl-2">: ({ </span><span class="hl-6">activePositionCount</span><span class="hl-2"> }) </span><span class="hl-3">=&gt;</span><span class="hl-2"> {</span><br/><span class="hl-2">    </span><span class="hl-3">const</span><span class="hl-2"> </span><span class="hl-8">MAX_POSITIONS</span><span class="hl-2"> = </span><span class="hl-7">5</span><span class="hl-2">;</span><br/><span class="hl-2">    </span><span class="hl-5">if</span><span class="hl-2"> (</span><span class="hl-6">activePositionCount</span><span class="hl-2"> &gt;= </span><span class="hl-8">MAX_POSITIONS</span><span class="hl-2">) {</span><br/><span class="hl-2">      </span><span class="hl-5">throw</span><span class="hl-2"> </span><span class="hl-3">new</span><span class="hl-2"> </span><span class="hl-1">Error</span><span class="hl-2">(</span><span class="hl-4">`Position limit reached: </span><span class="hl-3">${</span><span class="hl-6">activePositionCount</span><span class="hl-3">}</span><span class="hl-4">/</span><span class="hl-3">${</span><span class="hl-8">MAX_POSITIONS</span><span class="hl-3">}</span><span class="hl-4">`</span><span class="hl-2">);</span><br/><span class="hl-2">    }</span><br/><span class="hl-2">  },</span><br/><span class="hl-2">  </span><span class="hl-10">note</span><span class="hl-2">: </span><span class="hl-4">&quot;Enforce maximum 5 concurrent positions&quot;</span><br/><span class="hl-2">}</span>
</code><button type="button">Copy</button></pre>

<a id="pattern-2-riskreward-ratio-enforcement" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Pattern 2: Risk/Reward Ratio Enforcement<a href="#pattern-2-riskreward-ratio-enforcement" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Ensure minimum risk/reward ratio (e.g., 2:1):</p>
<pre><code class="typescript"><span class="hl-2">{</span><br/><span class="hl-2">  </span><span class="hl-10">validate</span><span class="hl-2">: ({ </span><span class="hl-6">pendingSignal</span><span class="hl-2">, </span><span class="hl-6">currentPrice</span><span class="hl-2"> }) </span><span class="hl-3">=&gt;</span><span class="hl-2"> {</span><br/><span class="hl-2">    </span><span class="hl-3">const</span><span class="hl-2"> { </span><span class="hl-8">priceOpen</span><span class="hl-2"> = </span><span class="hl-6">currentPrice</span><span class="hl-2">, </span><span class="hl-8">priceTakeProfit</span><span class="hl-2">, </span><span class="hl-8">priceStopLoss</span><span class="hl-2">, </span><span class="hl-8">position</span><span class="hl-2"> } = </span><span class="hl-6">pendingSignal</span><span class="hl-2">;</span><br/><span class="hl-2">    </span><br/><span class="hl-2">    </span><span class="hl-3">const</span><span class="hl-2"> </span><span class="hl-8">reward</span><span class="hl-2"> = </span><span class="hl-6">position</span><span class="hl-2"> === </span><span class="hl-4">&quot;long&quot;</span><span class="hl-2"> </span><br/><span class="hl-2">      ? </span><span class="hl-6">priceTakeProfit</span><span class="hl-2"> - </span><span class="hl-6">priceOpen</span><span class="hl-2"> </span><br/><span class="hl-2">      : </span><span class="hl-6">priceOpen</span><span class="hl-2"> - </span><span class="hl-6">priceTakeProfit</span><span class="hl-2">;</span><br/><span class="hl-2">      </span><br/><span class="hl-2">    </span><span class="hl-3">const</span><span class="hl-2"> </span><span class="hl-8">risk</span><span class="hl-2"> = </span><span class="hl-6">position</span><span class="hl-2"> === </span><span class="hl-4">&quot;long&quot;</span><br/><span class="hl-2">      ? </span><span class="hl-6">priceOpen</span><span class="hl-2"> - </span><span class="hl-6">priceStopLoss</span><br/><span class="hl-2">      : </span><span class="hl-6">priceStopLoss</span><span class="hl-2"> - </span><span class="hl-6">priceOpen</span><span class="hl-2">;</span><br/><span class="hl-2">    </span><br/><span class="hl-2">    </span><span class="hl-3">const</span><span class="hl-2"> </span><span class="hl-8">ratio</span><span class="hl-2"> = </span><span class="hl-6">reward</span><span class="hl-2"> / </span><span class="hl-6">risk</span><span class="hl-2">;</span><br/><span class="hl-2">    </span><br/><span class="hl-2">    </span><span class="hl-5">if</span><span class="hl-2"> (</span><span class="hl-6">ratio</span><span class="hl-2"> &lt; </span><span class="hl-7">2.0</span><span class="hl-2">) {</span><br/><span class="hl-2">      </span><span class="hl-5">throw</span><span class="hl-2"> </span><span class="hl-3">new</span><span class="hl-2"> </span><span class="hl-1">Error</span><span class="hl-2">(</span><span class="hl-4">`Poor R/R ratio: </span><span class="hl-3">${</span><span class="hl-6">ratio</span><span class="hl-9">.</span><span class="hl-1">toFixed</span><span class="hl-9">(</span><span class="hl-7">2</span><span class="hl-9">)</span><span class="hl-3">}</span><span class="hl-4">:1 (minimum 2:1 required)`</span><span class="hl-2">);</span><br/><span class="hl-2">    }</span><br/><span class="hl-2">  },</span><br/><span class="hl-2">  </span><span class="hl-10">note</span><span class="hl-2">: </span><span class="hl-4">&quot;Enforce minimum 2:1 risk/reward ratio&quot;</span><br/><span class="hl-2">}</span>
</code><button type="button">Copy</button></pre>

<a id="pattern-3-minimum-take-profit-distance" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Pattern 3: Minimum Take Profit Distance<a href="#pattern-3-minimum-take-profit-distance" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Ensure take profit covers trading fees:</p>
<pre><code class="typescript"><span class="hl-2">{</span><br/><span class="hl-2">  </span><span class="hl-10">validate</span><span class="hl-2">: ({ </span><span class="hl-6">pendingSignal</span><span class="hl-2">, </span><span class="hl-6">currentPrice</span><span class="hl-2"> }) </span><span class="hl-3">=&gt;</span><span class="hl-2"> {</span><br/><span class="hl-2">    </span><span class="hl-3">const</span><span class="hl-2"> { </span><span class="hl-8">priceOpen</span><span class="hl-2"> = </span><span class="hl-6">currentPrice</span><span class="hl-2">, </span><span class="hl-8">priceTakeProfit</span><span class="hl-2">, </span><span class="hl-8">position</span><span class="hl-2"> } = </span><span class="hl-6">pendingSignal</span><span class="hl-2">;</span><br/><span class="hl-2">    </span><br/><span class="hl-2">    </span><span class="hl-3">const</span><span class="hl-2"> </span><span class="hl-8">tpDistance</span><span class="hl-2"> = </span><span class="hl-6">position</span><span class="hl-2"> === </span><span class="hl-4">&quot;long&quot;</span><br/><span class="hl-2">      ? ((</span><span class="hl-6">priceTakeProfit</span><span class="hl-2"> - </span><span class="hl-6">priceOpen</span><span class="hl-2">) / </span><span class="hl-6">priceOpen</span><span class="hl-2">) * </span><span class="hl-7">100</span><br/><span class="hl-2">      : ((</span><span class="hl-6">priceOpen</span><span class="hl-2"> - </span><span class="hl-6">priceTakeProfit</span><span class="hl-2">) / </span><span class="hl-6">priceOpen</span><span class="hl-2">) * </span><span class="hl-7">100</span><span class="hl-2">;</span><br/><span class="hl-2">    </span><br/><span class="hl-2">    </span><span class="hl-3">const</span><span class="hl-2"> </span><span class="hl-8">MIN_TP_PERCENT</span><span class="hl-2"> = </span><span class="hl-7">1.0</span><span class="hl-2">; </span><span class="hl-0">// 1% minimum to cover fees</span><br/><span class="hl-2">    </span><br/><span class="hl-2">    </span><span class="hl-5">if</span><span class="hl-2"> (</span><span class="hl-6">tpDistance</span><span class="hl-2"> &lt; </span><span class="hl-8">MIN_TP_PERCENT</span><span class="hl-2">) {</span><br/><span class="hl-2">      </span><span class="hl-5">throw</span><span class="hl-2"> </span><span class="hl-3">new</span><span class="hl-2"> </span><span class="hl-1">Error</span><span class="hl-2">(</span><span class="hl-4">`TP too close: </span><span class="hl-3">${</span><span class="hl-6">tpDistance</span><span class="hl-9">.</span><span class="hl-1">toFixed</span><span class="hl-9">(</span><span class="hl-7">2</span><span class="hl-9">)</span><span class="hl-3">}</span><span class="hl-4">% (minimum </span><span class="hl-3">${</span><span class="hl-8">MIN_TP_PERCENT</span><span class="hl-3">}</span><span class="hl-4">%)`</span><span class="hl-2">);</span><br/><span class="hl-2">    }</span><br/><span class="hl-2">  },</span><br/><span class="hl-2">  </span><span class="hl-10">note</span><span class="hl-2">: </span><span class="hl-4">&quot;Ensure TP distance covers trading fees (1% minimum)&quot;</span><br/><span class="hl-2">}</span>
</code><button type="button">Copy</button></pre>

<a id="pattern-4-symbol-specific-position-limits" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Pattern 4: Symbol-Specific Position Limits<a href="#pattern-4-symbol-specific-position-limits" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Limit exposure per trading pair:</p>
<pre><code class="typescript"><span class="hl-2">{</span><br/><span class="hl-2">  </span><span class="hl-10">validate</span><span class="hl-2">: ({ </span><span class="hl-6">symbol</span><span class="hl-2">, </span><span class="hl-6">activePositions</span><span class="hl-2"> }) </span><span class="hl-3">=&gt;</span><span class="hl-2"> {</span><br/><span class="hl-2">    </span><span class="hl-3">const</span><span class="hl-2"> </span><span class="hl-8">MAX_PER_SYMBOL</span><span class="hl-2"> = </span><span class="hl-7">2</span><span class="hl-2">;</span><br/><span class="hl-2">    </span><span class="hl-3">const</span><span class="hl-2"> </span><span class="hl-8">symbolCount</span><span class="hl-2"> = </span><span class="hl-6">activePositions</span><span class="hl-2">.</span><span class="hl-1">filter</span><span class="hl-2">(</span><span class="hl-6">p</span><span class="hl-2"> </span><span class="hl-3">=&gt;</span><span class="hl-2"> </span><span class="hl-6">p</span><span class="hl-2">.</span><span class="hl-6">signal</span><span class="hl-2">.</span><span class="hl-6">symbol</span><span class="hl-2"> === </span><span class="hl-6">symbol</span><span class="hl-2">).</span><span class="hl-6">length</span><span class="hl-2">;</span><br/><span class="hl-2">    </span><br/><span class="hl-2">    </span><span class="hl-5">if</span><span class="hl-2"> (</span><span class="hl-6">symbolCount</span><span class="hl-2"> &gt;= </span><span class="hl-8">MAX_PER_SYMBOL</span><span class="hl-2">) {</span><br/><span class="hl-2">      </span><span class="hl-5">throw</span><span class="hl-2"> </span><span class="hl-3">new</span><span class="hl-2"> </span><span class="hl-1">Error</span><span class="hl-2">(</span><span class="hl-4">`Max </span><span class="hl-3">${</span><span class="hl-8">MAX_PER_SYMBOL</span><span class="hl-3">}</span><span class="hl-4"> positions per symbol (</span><span class="hl-3">${</span><span class="hl-6">symbol</span><span class="hl-3">}</span><span class="hl-4"> has </span><span class="hl-3">${</span><span class="hl-6">symbolCount</span><span class="hl-3">}</span><span class="hl-4">)`</span><span class="hl-2">);</span><br/><span class="hl-2">    }</span><br/><span class="hl-2">  },</span><br/><span class="hl-2">  </span><span class="hl-10">note</span><span class="hl-2">: </span><span class="hl-4">&quot;Limit to 2 concurrent positions per trading pair&quot;</span><br/><span class="hl-2">}</span>
</code><button type="button">Copy</button></pre>

<a id="pattern-5-strategy-diversification" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Pattern 5: Strategy Diversification<a href="#pattern-5-strategy-diversification" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Prevent single strategy from dominating portfolio:</p>
<pre><code class="typescript"><span class="hl-2">{</span><br/><span class="hl-2">  </span><span class="hl-10">validate</span><span class="hl-2">: ({ </span><span class="hl-6">strategyName</span><span class="hl-2">, </span><span class="hl-6">activePositions</span><span class="hl-2">, </span><span class="hl-6">activePositionCount</span><span class="hl-2"> }) </span><span class="hl-3">=&gt;</span><span class="hl-2"> {</span><br/><span class="hl-2">    </span><span class="hl-5">if</span><span class="hl-2"> (</span><span class="hl-6">activePositionCount</span><span class="hl-2"> === </span><span class="hl-7">0</span><span class="hl-2">) </span><span class="hl-5">return</span><span class="hl-2">; </span><span class="hl-0">// Allow first position</span><br/><span class="hl-2">    </span><br/><span class="hl-2">    </span><span class="hl-3">const</span><span class="hl-2"> </span><span class="hl-8">strategyCount</span><span class="hl-2"> = </span><span class="hl-6">activePositions</span><span class="hl-2">.</span><span class="hl-1">filter</span><span class="hl-2">(</span><span class="hl-6">p</span><span class="hl-2"> </span><span class="hl-3">=&gt;</span><span class="hl-2"> </span><span class="hl-6">p</span><span class="hl-2">.</span><span class="hl-6">strategyName</span><span class="hl-2"> === </span><span class="hl-6">strategyName</span><span class="hl-2">).</span><span class="hl-6">length</span><span class="hl-2">;</span><br/><span class="hl-2">    </span><span class="hl-3">const</span><span class="hl-2"> </span><span class="hl-8">strategyPercent</span><span class="hl-2"> = (</span><span class="hl-6">strategyCount</span><span class="hl-2"> / </span><span class="hl-6">activePositionCount</span><span class="hl-2">) * </span><span class="hl-7">100</span><span class="hl-2">;</span><br/><span class="hl-2">    </span><br/><span class="hl-2">    </span><span class="hl-3">const</span><span class="hl-2"> </span><span class="hl-8">MAX_STRATEGY_PERCENT</span><span class="hl-2"> = </span><span class="hl-7">40</span><span class="hl-2">; </span><span class="hl-0">// 40% max per strategy</span><br/><span class="hl-2">    </span><br/><span class="hl-2">    </span><span class="hl-5">if</span><span class="hl-2"> (</span><span class="hl-6">strategyPercent</span><span class="hl-2"> &gt;= </span><span class="hl-8">MAX_STRATEGY_PERCENT</span><span class="hl-2">) {</span><br/><span class="hl-2">      </span><span class="hl-5">throw</span><span class="hl-2"> </span><span class="hl-3">new</span><span class="hl-2"> </span><span class="hl-1">Error</span><span class="hl-2">(</span><span class="hl-4">`Strategy </span><span class="hl-3">${</span><span class="hl-6">strategyName</span><span class="hl-3">}</span><span class="hl-4"> over-exposed: </span><span class="hl-3">${</span><span class="hl-6">strategyPercent</span><span class="hl-9">.</span><span class="hl-1">toFixed</span><span class="hl-9">(</span><span class="hl-7">0</span><span class="hl-9">)</span><span class="hl-3">}</span><span class="hl-4">% (max </span><span class="hl-3">${</span><span class="hl-8">MAX_STRATEGY_PERCENT</span><span class="hl-3">}</span><span class="hl-4">%)`</span><span class="hl-2">);</span><br/><span class="hl-2">    }</span><br/><span class="hl-2">  },</span><br/><span class="hl-2">  </span><span class="hl-10">note</span><span class="hl-2">: </span><span class="hl-4">&quot;Prevent single strategy from exceeding 40% of portfolio&quot;</span><br/><span class="hl-2">}</span>
</code><button type="button">Copy</button></pre>

<a id="pattern-6-position-direction-hedging" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Pattern 6: Position Direction Hedging<a href="#pattern-6-position-direction-hedging" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Allow or forbid opposing positions on same symbol:</p>
<pre><code class="typescript"><span class="hl-2">{</span><br/><span class="hl-2">  </span><span class="hl-10">validate</span><span class="hl-2">: ({ </span><span class="hl-6">symbol</span><span class="hl-2">, </span><span class="hl-6">pendingSignal</span><span class="hl-2">, </span><span class="hl-6">activePositions</span><span class="hl-2"> }) </span><span class="hl-3">=&gt;</span><span class="hl-2"> {</span><br/><span class="hl-2">    </span><span class="hl-3">const</span><span class="hl-2"> </span><span class="hl-8">existingPosition</span><span class="hl-2"> = </span><span class="hl-6">activePositions</span><span class="hl-2">.</span><span class="hl-1">find</span><span class="hl-2">(</span><span class="hl-6">p</span><span class="hl-2"> </span><span class="hl-3">=&gt;</span><span class="hl-2"> </span><span class="hl-6">p</span><span class="hl-2">.</span><span class="hl-6">signal</span><span class="hl-2">.</span><span class="hl-6">symbol</span><span class="hl-2"> === </span><span class="hl-6">symbol</span><span class="hl-2">);</span><br/><span class="hl-2">    </span><br/><span class="hl-2">    </span><span class="hl-5">if</span><span class="hl-2"> (</span><span class="hl-6">existingPosition</span><span class="hl-2"> &amp;&amp; </span><span class="hl-6">existingPosition</span><span class="hl-2">.</span><span class="hl-6">signal</span><span class="hl-2">.</span><span class="hl-6">position</span><span class="hl-2"> !== </span><span class="hl-6">pendingSignal</span><span class="hl-2">.</span><span class="hl-6">position</span><span class="hl-2">) {</span><br/><span class="hl-2">      </span><span class="hl-5">throw</span><span class="hl-2"> </span><span class="hl-3">new</span><span class="hl-2"> </span><span class="hl-1">Error</span><span class="hl-2">(</span><span class="hl-4">`Cannot open </span><span class="hl-3">${</span><span class="hl-6">pendingSignal</span><span class="hl-9">.</span><span class="hl-6">position</span><span class="hl-3">}</span><span class="hl-4"> on </span><span class="hl-3">${</span><span class="hl-6">symbol</span><span class="hl-3">}</span><span class="hl-4"> - existing </span><span class="hl-3">${</span><span class="hl-6">existingPosition</span><span class="hl-9">.</span><span class="hl-6">signal</span><span class="hl-9">.</span><span class="hl-6">position</span><span class="hl-3">}</span><span class="hl-4"> position conflicts`</span><span class="hl-2">);</span><br/><span class="hl-2">    }</span><br/><span class="hl-2">  },</span><br/><span class="hl-2">  </span><span class="hl-10">note</span><span class="hl-2">: </span><span class="hl-4">&quot;Prevent opposing positions on same symbol (no hedging)&quot;</span><br/><span class="hl-2">}</span>
</code><button type="button">Copy</button></pre>

<hr>
<a id="validation-execution-sequence" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Validation Execution Sequence<a href="#validation-execution-sequence" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p><img src="../media/88_Custom_Risk_Validations_2.svg" alt="Mermaid Diagram"></p>
<p><strong>Execution Rules</strong>:</p>
<ol>
<li><strong>Sequential Processing</strong>: Validations run in array order (index 0 â†’ n)</li>
<li><strong>Short-Circuit on Failure</strong>: First error stops execution; remaining validations skip</li>
<li><strong>All-or-Nothing</strong>: All validations must pass for signal to proceed</li>
<li><strong>Error Capture</strong>: Thrown errors are caught and converted to rejection events</li>
<li><strong>Async Support</strong>: Async validations are <code>await</code>ed before proceeding</li>
</ol>
<hr>
<a id="error-handling-and-rejection-events" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Error Handling and Rejection Events<a href="#error-handling-and-rejection-events" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><a id="throwing-errors" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Throwing Errors<a href="#throwing-errors" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Validation functions communicate rejection by throwing errors:</p>
<pre><code class="typescript"><span class="hl-2">{</span><br/><span class="hl-2">  </span><span class="hl-10">validate</span><span class="hl-2">: ({ </span><span class="hl-6">activePositionCount</span><span class="hl-2"> }) </span><span class="hl-3">=&gt;</span><span class="hl-2"> {</span><br/><span class="hl-2">    </span><span class="hl-5">if</span><span class="hl-2"> (</span><span class="hl-6">activePositionCount</span><span class="hl-2"> &gt;= </span><span class="hl-7">10</span><span class="hl-2">) {</span><br/><span class="hl-2">      </span><span class="hl-0">// Error message appears in logs and rejection events</span><br/><span class="hl-2">      </span><span class="hl-5">throw</span><span class="hl-2"> </span><span class="hl-3">new</span><span class="hl-2"> </span><span class="hl-1">Error</span><span class="hl-2">(</span><span class="hl-4">&quot;Portfolio limit: 10 concurrent positions maximum&quot;</span><span class="hl-2">);</span><br/><span class="hl-2">    }</span><br/><span class="hl-2">    </span><span class="hl-0">// No throw = validation passes</span><br/><span class="hl-2">  }</span><br/><span class="hl-2">}</span>
</code><button type="button">Copy</button></pre>

<p><strong>Error Message Best Practices</strong>:</p>
<ul>
<li>Include the rejected value (e.g., <code>&quot;activePositionCount=11&quot;</code>)</li>
<li>State the limit or threshold (e.g., <code>&quot;maximum 10&quot;</code>)</li>
<li>Be specific about the rule violated</li>
<li>Use consistent formatting for parsing</li>
</ul>
<a id="listening-to-rejection-events" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Listening to Rejection Events<a href="#listening-to-rejection-events" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Subscribe to <code>riskSubject</code> to monitor rejected signals:</p>
<pre><code class="typescript"><span class="hl-5">import</span><span class="hl-2"> { </span><span class="hl-6">listenRisk</span><span class="hl-2"> } </span><span class="hl-5">from</span><span class="hl-2"> </span><span class="hl-4">&quot;backtest-kit&quot;</span><span class="hl-2">;</span><br/><br/><span class="hl-1">listenRisk</span><span class="hl-2">((</span><span class="hl-6">event</span><span class="hl-2">) </span><span class="hl-3">=&gt;</span><span class="hl-2"> {</span><br/><span class="hl-2">  </span><span class="hl-6">console</span><span class="hl-2">.</span><span class="hl-1">log</span><span class="hl-2">(</span><span class="hl-4">`[RISK REJECTED] </span><span class="hl-3">${</span><span class="hl-6">event</span><span class="hl-9">.</span><span class="hl-6">symbol</span><span class="hl-3">}</span><span class="hl-4">`</span><span class="hl-2">);</span><br/><span class="hl-2">  </span><span class="hl-6">console</span><span class="hl-2">.</span><span class="hl-1">log</span><span class="hl-2">(</span><span class="hl-4">`Strategy: </span><span class="hl-3">${</span><span class="hl-6">event</span><span class="hl-9">.</span><span class="hl-6">strategyName</span><span class="hl-3">}</span><span class="hl-4">`</span><span class="hl-2">);</span><br/><span class="hl-2">  </span><span class="hl-6">console</span><span class="hl-2">.</span><span class="hl-1">log</span><span class="hl-2">(</span><span class="hl-4">`Position: </span><span class="hl-3">${</span><span class="hl-6">event</span><span class="hl-9">.</span><span class="hl-6">pendingSignal</span><span class="hl-9">.</span><span class="hl-6">position</span><span class="hl-3">}</span><span class="hl-4">`</span><span class="hl-2">);</span><br/><span class="hl-2">  </span><span class="hl-6">console</span><span class="hl-2">.</span><span class="hl-1">log</span><span class="hl-2">(</span><span class="hl-4">`Active positions: </span><span class="hl-3">${</span><span class="hl-6">event</span><span class="hl-9">.</span><span class="hl-6">activePositionCount</span><span class="hl-3">}</span><span class="hl-4">`</span><span class="hl-2">);</span><br/><span class="hl-2">  </span><span class="hl-6">console</span><span class="hl-2">.</span><span class="hl-1">log</span><span class="hl-2">(</span><span class="hl-4">`Reason: </span><span class="hl-3">${</span><span class="hl-6">event</span><span class="hl-9">.</span><span class="hl-6">comment</span><span class="hl-3">}</span><span class="hl-4">`</span><span class="hl-2">); </span><span class="hl-0">// From validation note or &quot;N/A&quot;</span><br/><span class="hl-2">  </span><span class="hl-6">console</span><span class="hl-2">.</span><span class="hl-1">log</span><span class="hl-2">(</span><span class="hl-4">`Price: </span><span class="hl-3">${</span><span class="hl-6">event</span><span class="hl-9">.</span><span class="hl-6">currentPrice</span><span class="hl-3">}</span><span class="hl-4">`</span><span class="hl-2">);</span><br/><span class="hl-2">});</span>
</code><button type="button">Copy</button></pre>

<p><strong>RiskContract Structure</strong>:</p>
<table>
<thead>
<tr>
<th>Property</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>symbol</code></td>
<td><code>string</code></td>
<td>Trading pair</td>
</tr>
<tr>
<td><code>strategyName</code></td>
<td><code>string</code></td>
<td>Strategy that generated signal</td>
</tr>
<tr>
<td><code>exchangeName</code></td>
<td><code>string</code></td>
<td>Exchange identifier</td>
</tr>
<tr>
<td><code>pendingSignal</code></td>
<td><code>ISignalDto</code></td>
<td>Rejected signal details</td>
</tr>
<tr>
<td><code>currentPrice</code></td>
<td><code>number</code></td>
<td>VWAP at rejection time</td>
</tr>
<tr>
<td><code>activePositionCount</code></td>
<td><code>number</code></td>
<td>Position count at rejection</td>
</tr>
<tr>
<td><code>comment</code></td>
<td><code>string</code></td>
<td>Validation note or error message</td>
</tr>
<tr>
<td><code>timestamp</code></td>
<td><code>number</code></td>
<td>Rejection timestamp (ms)</td>
</tr>
</tbody>
</table>
<hr>
<a id="async-validations" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Async Validations<a href="#async-validations" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>Validations can be async for external lookups:</p>
<pre><code class="typescript"><span class="hl-2">{</span><br/><span class="hl-2">  </span><span class="hl-10">validate</span><span class="hl-2">: </span><span class="hl-3">async</span><span class="hl-2"> ({ </span><span class="hl-6">symbol</span><span class="hl-2">, </span><span class="hl-6">pendingSignal</span><span class="hl-2"> }) </span><span class="hl-3">=&gt;</span><span class="hl-2"> {</span><br/><span class="hl-2">    </span><span class="hl-0">// Example: Check external API for symbol volatility</span><br/><span class="hl-2">    </span><span class="hl-3">const</span><span class="hl-2"> </span><span class="hl-8">volatility</span><span class="hl-2"> = </span><span class="hl-5">await</span><span class="hl-2"> </span><span class="hl-1">fetch</span><span class="hl-2">(</span><span class="hl-4">`https://api.example.com/volatility/</span><span class="hl-3">${</span><span class="hl-6">symbol</span><span class="hl-3">}</span><span class="hl-4">`</span><span class="hl-2">)</span><br/><span class="hl-2">      .</span><span class="hl-1">then</span><span class="hl-2">(</span><span class="hl-6">r</span><span class="hl-2"> </span><span class="hl-3">=&gt;</span><span class="hl-2"> </span><span class="hl-6">r</span><span class="hl-2">.</span><span class="hl-1">json</span><span class="hl-2">())</span><br/><span class="hl-2">      .</span><span class="hl-1">then</span><span class="hl-2">(</span><span class="hl-6">d</span><span class="hl-2"> </span><span class="hl-3">=&gt;</span><span class="hl-2"> </span><span class="hl-6">d</span><span class="hl-2">.</span><span class="hl-6">volatility</span><span class="hl-2">);</span><br/><span class="hl-2">    </span><br/><span class="hl-2">    </span><span class="hl-3">const</span><span class="hl-2"> </span><span class="hl-8">MAX_VOLATILITY</span><span class="hl-2"> = </span><span class="hl-7">0.05</span><span class="hl-2">; </span><span class="hl-0">// 5%</span><br/><span class="hl-2">    </span><br/><span class="hl-2">    </span><span class="hl-5">if</span><span class="hl-2"> (</span><span class="hl-6">volatility</span><span class="hl-2"> &gt; </span><span class="hl-8">MAX_VOLATILITY</span><span class="hl-2">) {</span><br/><span class="hl-2">      </span><span class="hl-5">throw</span><span class="hl-2"> </span><span class="hl-3">new</span><span class="hl-2"> </span><span class="hl-1">Error</span><span class="hl-2">(</span><span class="hl-4">`High volatility: </span><span class="hl-3">${</span><span class="hl-9">(</span><span class="hl-6">volatility</span><span class="hl-9"> </span><span class="hl-2">*</span><span class="hl-9"> </span><span class="hl-7">100</span><span class="hl-9">).</span><span class="hl-1">toFixed</span><span class="hl-9">(</span><span class="hl-7">2</span><span class="hl-9">)</span><span class="hl-3">}</span><span class="hl-4">% (max </span><span class="hl-3">${</span><span class="hl-9">(</span><span class="hl-8">MAX_VOLATILITY</span><span class="hl-9"> </span><span class="hl-2">*</span><span class="hl-9"> </span><span class="hl-7">100</span><span class="hl-9">).</span><span class="hl-1">toFixed</span><span class="hl-9">(</span><span class="hl-7">2</span><span class="hl-9">)</span><span class="hl-3">}</span><span class="hl-4">%)`</span><span class="hl-2">);</span><br/><span class="hl-2">    }</span><br/><span class="hl-2">  },</span><br/><span class="hl-2">  </span><span class="hl-10">note</span><span class="hl-2">: </span><span class="hl-4">&quot;Block signals during high volatility periods&quot;</span><br/><span class="hl-2">}</span>
</code><button type="button">Copy</button></pre>

<p><strong>Async Considerations</strong>:</p>
<ul>
<li>Validations are <code>await</code>ed sequentially</li>
<li>High latency can delay signal processing</li>
<li>Consider caching external data to reduce API calls</li>
<li>Timeout long-running validations to prevent hangs</li>
</ul>
<hr>
<a id="integration-with-position-lifecycle" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Integration with Position Lifecycle<a href="#integration-with-position-lifecycle" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p><img src="../media/88_Custom_Risk_Validations_3.svg" alt="Mermaid Diagram"></p>
<p><strong>Lifecycle Integration Points</strong>:</p>
<ol>
<li><strong>Pre-Opening Validation</strong>: Validations run <strong>before</strong> <code>addSignal()</code> - rejected signals never enter <code>_activePositionsMap</code></li>
<li><strong>Position Tracking</strong>: Passing signals are added to <code>_activePositionsMap</code> and persisted atomically</li>
<li><strong>Monitoring Phase</strong>: Active positions count toward <code>activePositionCount</code> in future validations</li>
<li><strong>Position Closure</strong>: Closed positions are removed from <code>_activePositionsMap</code> via <code>removeSignal()</code></li>
<li><strong>Crash Recovery</strong>: Persisted positions restore <code>_activePositionsMap</code> on restart</li>
</ol>
<hr>
<a id="testing-custom-validations" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Testing Custom Validations<a href="#testing-custom-validations" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><a id="unit-testing-validation-logic" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Unit Testing Validation Logic<a href="#unit-testing-validation-logic" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Test validation functions in isolation:</p>
<pre><code class="typescript"><span class="hl-5">import</span><span class="hl-2"> { </span><span class="hl-6">test</span><span class="hl-2"> } </span><span class="hl-5">from</span><span class="hl-2"> </span><span class="hl-4">&quot;worker-testbed&quot;</span><span class="hl-2">;</span><br/><br/><span class="hl-3">const</span><span class="hl-2"> </span><span class="hl-8">myValidation</span><span class="hl-2"> = {</span><br/><span class="hl-2">  </span><span class="hl-1">validate</span><span class="hl-6">:</span><span class="hl-2"> ({ </span><span class="hl-6">activePositionCount</span><span class="hl-2"> }) </span><span class="hl-3">=&gt;</span><span class="hl-2"> {</span><br/><span class="hl-2">    </span><span class="hl-5">if</span><span class="hl-2"> (</span><span class="hl-6">activePositionCount</span><span class="hl-2"> &gt;= </span><span class="hl-7">3</span><span class="hl-2">) {</span><br/><span class="hl-2">      </span><span class="hl-5">throw</span><span class="hl-2"> </span><span class="hl-3">new</span><span class="hl-2"> </span><span class="hl-1">Error</span><span class="hl-2">(</span><span class="hl-4">&quot;Max 3 positions&quot;</span><span class="hl-2">);</span><br/><span class="hl-2">    }</span><br/><span class="hl-2">  },</span><br/><span class="hl-2">  </span><span class="hl-6">note:</span><span class="hl-2"> </span><span class="hl-4">&quot;Position limit test&quot;</span><br/><span class="hl-2">};</span><br/><br/><span class="hl-1">test</span><span class="hl-2">(</span><span class="hl-4">&quot;Validation rejects when limit reached&quot;</span><span class="hl-2">, </span><span class="hl-3">async</span><span class="hl-2"> ({ </span><span class="hl-6">pass</span><span class="hl-2">, </span><span class="hl-6">fail</span><span class="hl-2"> }) </span><span class="hl-3">=&gt;</span><span class="hl-2"> {</span><br/><span class="hl-2">  </span><span class="hl-3">const</span><span class="hl-2"> </span><span class="hl-8">payload</span><span class="hl-2"> = {</span><br/><span class="hl-2">    </span><span class="hl-6">symbol:</span><span class="hl-2"> </span><span class="hl-4">&quot;BTCUSDT&quot;</span><span class="hl-2">,</span><br/><span class="hl-2">    </span><span class="hl-6">pendingSignal:</span><span class="hl-2"> {</span><br/><span class="hl-2">      </span><span class="hl-6">position:</span><span class="hl-2"> </span><span class="hl-4">&quot;long&quot;</span><span class="hl-2">,</span><br/><span class="hl-2">      </span><span class="hl-6">priceTakeProfit:</span><span class="hl-2"> </span><span class="hl-7">42000</span><span class="hl-2">,</span><br/><span class="hl-2">      </span><span class="hl-6">priceStopLoss:</span><span class="hl-2"> </span><span class="hl-7">40000</span><span class="hl-2">,</span><br/><span class="hl-2">      </span><span class="hl-6">minuteEstimatedTime:</span><span class="hl-2"> </span><span class="hl-7">60</span><br/><span class="hl-2">    },</span><br/><span class="hl-2">    </span><span class="hl-6">strategyName:</span><span class="hl-2"> </span><span class="hl-4">&quot;test-strategy&quot;</span><span class="hl-2">,</span><br/><span class="hl-2">    </span><span class="hl-6">exchangeName:</span><span class="hl-2"> </span><span class="hl-4">&quot;test-exchange&quot;</span><span class="hl-2">,</span><br/><span class="hl-2">    </span><span class="hl-6">currentPrice:</span><span class="hl-2"> </span><span class="hl-7">41000</span><span class="hl-2">,</span><br/><span class="hl-2">    </span><span class="hl-6">timestamp:</span><span class="hl-2"> </span><span class="hl-6">Date</span><span class="hl-2">.</span><span class="hl-1">now</span><span class="hl-2">(),</span><br/><span class="hl-2">    </span><span class="hl-6">activePositionCount:</span><span class="hl-2"> </span><span class="hl-7">3</span><span class="hl-2">, </span><span class="hl-0">// At limit</span><br/><span class="hl-2">    </span><span class="hl-6">activePositions:</span><span class="hl-2"> []</span><br/><span class="hl-2">  };</span><br/><span class="hl-2">  </span><br/><span class="hl-2">  </span><span class="hl-5">try</span><span class="hl-2"> {</span><br/><span class="hl-2">    </span><span class="hl-5">await</span><span class="hl-2"> </span><span class="hl-6">myValidation</span><span class="hl-2">.</span><span class="hl-1">validate</span><span class="hl-2">(</span><span class="hl-6">payload</span><span class="hl-2">);</span><br/><span class="hl-2">    </span><span class="hl-1">fail</span><span class="hl-2">(</span><span class="hl-4">&quot;Should have thrown error&quot;</span><span class="hl-2">);</span><br/><span class="hl-2">  } </span><span class="hl-5">catch</span><span class="hl-2"> (</span><span class="hl-6">error</span><span class="hl-2">) {</span><br/><span class="hl-2">    </span><span class="hl-5">if</span><span class="hl-2"> (</span><span class="hl-6">error</span><span class="hl-2">.</span><span class="hl-6">message</span><span class="hl-2">.</span><span class="hl-1">includes</span><span class="hl-2">(</span><span class="hl-4">&quot;Max 3 positions&quot;</span><span class="hl-2">)) {</span><br/><span class="hl-2">      </span><span class="hl-1">pass</span><span class="hl-2">(</span><span class="hl-4">&quot;Validation rejected correctly&quot;</span><span class="hl-2">);</span><br/><span class="hl-2">    } </span><span class="hl-5">else</span><span class="hl-2"> {</span><br/><span class="hl-2">      </span><span class="hl-1">fail</span><span class="hl-2">(</span><span class="hl-4">`Unexpected error: </span><span class="hl-3">${</span><span class="hl-6">error</span><span class="hl-9">.</span><span class="hl-6">message</span><span class="hl-3">}</span><span class="hl-4">`</span><span class="hl-2">);</span><br/><span class="hl-2">    }</span><br/><span class="hl-2">  }</span><br/><span class="hl-2">});</span>
</code><button type="button">Copy</button></pre>

<a id="integration-testing-with-backtest" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Integration Testing with Backtest<a href="#integration-testing-with-backtest" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Test validations with full backtest execution:</p>
<pre><code class="typescript"><span class="hl-5">import</span><span class="hl-2"> { </span><span class="hl-6">addRisk</span><span class="hl-2">, </span><span class="hl-6">addStrategy</span><span class="hl-2">, </span><span class="hl-6">addExchange</span><span class="hl-2">, </span><span class="hl-6">addFrame</span><span class="hl-2">, </span><span class="hl-6">Backtest</span><span class="hl-2">, </span><span class="hl-6">listenRisk</span><span class="hl-2"> } </span><span class="hl-5">from</span><span class="hl-2"> </span><span class="hl-4">&quot;backtest-kit&quot;</span><span class="hl-2">;</span><br/><span class="hl-5">import</span><span class="hl-2"> { </span><span class="hl-6">Subject</span><span class="hl-2"> } </span><span class="hl-5">from</span><span class="hl-2"> </span><span class="hl-4">&quot;functools-kit&quot;</span><span class="hl-2">;</span><br/><br/><span class="hl-1">test</span><span class="hl-2">(</span><span class="hl-4">&quot;Risk validation blocks signal in backtest&quot;</span><span class="hl-2">, </span><span class="hl-3">async</span><span class="hl-2"> ({ </span><span class="hl-6">pass</span><span class="hl-2">, </span><span class="hl-6">fail</span><span class="hl-2"> }) </span><span class="hl-3">=&gt;</span><span class="hl-2"> {</span><br/><span class="hl-2">  </span><span class="hl-3">let</span><span class="hl-2"> </span><span class="hl-6">rejectionCount</span><span class="hl-2"> = </span><span class="hl-7">0</span><span class="hl-2">;</span><br/><span class="hl-2">  </span><br/><span class="hl-2">  </span><span class="hl-1">addRisk</span><span class="hl-2">({</span><br/><span class="hl-2">    </span><span class="hl-6">riskName:</span><span class="hl-2"> </span><span class="hl-4">&quot;test-risk&quot;</span><span class="hl-2">,</span><br/><span class="hl-2">    </span><span class="hl-6">validations:</span><span class="hl-2"> [</span><br/><span class="hl-2">      {</span><br/><span class="hl-2">        </span><span class="hl-1">validate</span><span class="hl-6">:</span><span class="hl-2"> ({ </span><span class="hl-6">currentPrice</span><span class="hl-2">, </span><span class="hl-6">pendingSignal</span><span class="hl-2"> }) </span><span class="hl-3">=&gt;</span><span class="hl-2"> {</span><br/><span class="hl-2">          </span><span class="hl-0">// Reject signals below 42000</span><br/><span class="hl-2">          </span><span class="hl-5">if</span><span class="hl-2"> (</span><span class="hl-6">currentPrice</span><span class="hl-2"> &lt; </span><span class="hl-7">42000</span><span class="hl-2">) {</span><br/><span class="hl-2">            </span><span class="hl-5">throw</span><span class="hl-2"> </span><span class="hl-3">new</span><span class="hl-2"> </span><span class="hl-1">Error</span><span class="hl-2">(</span><span class="hl-4">`Price too low: </span><span class="hl-3">${</span><span class="hl-6">currentPrice</span><span class="hl-3">}</span><span class="hl-4">`</span><span class="hl-2">);</span><br/><span class="hl-2">          }</span><br/><span class="hl-2">        },</span><br/><span class="hl-2">        </span><span class="hl-6">note:</span><span class="hl-2"> </span><span class="hl-4">&quot;Min price validation&quot;</span><br/><span class="hl-2">      }</span><br/><span class="hl-2">    ]</span><br/><span class="hl-2">  });</span><br/><span class="hl-2">  </span><br/><span class="hl-2">  </span><span class="hl-1">addStrategy</span><span class="hl-2">({</span><br/><span class="hl-2">    </span><span class="hl-6">strategyName:</span><span class="hl-2"> </span><span class="hl-4">&quot;test-strategy&quot;</span><span class="hl-2">,</span><br/><span class="hl-2">    </span><span class="hl-6">interval:</span><span class="hl-2"> </span><span class="hl-4">&quot;1m&quot;</span><span class="hl-2">,</span><br/><span class="hl-2">    </span><span class="hl-6">riskName:</span><span class="hl-2"> </span><span class="hl-4">&quot;test-risk&quot;</span><span class="hl-2">,</span><br/><span class="hl-2">    </span><span class="hl-1">getSignal</span><span class="hl-6">:</span><span class="hl-2"> </span><span class="hl-3">async</span><span class="hl-2"> () </span><span class="hl-3">=&gt;</span><span class="hl-2"> ({</span><br/><span class="hl-2">      </span><span class="hl-6">position:</span><span class="hl-2"> </span><span class="hl-4">&quot;long&quot;</span><span class="hl-2">,</span><br/><span class="hl-2">      </span><span class="hl-6">priceTakeProfit:</span><span class="hl-2"> </span><span class="hl-7">43000</span><span class="hl-2">,</span><br/><span class="hl-2">      </span><span class="hl-6">priceStopLoss:</span><span class="hl-2"> </span><span class="hl-7">40000</span><span class="hl-2">,</span><br/><span class="hl-2">      </span><span class="hl-6">minuteEstimatedTime:</span><span class="hl-2"> </span><span class="hl-7">60</span><br/><span class="hl-2">    })</span><br/><span class="hl-2">  });</span><br/><span class="hl-2">  </span><br/><span class="hl-2">  </span><span class="hl-0">// ... add exchange and frame ...</span><br/><span class="hl-2">  </span><br/><span class="hl-2">  </span><span class="hl-3">const</span><span class="hl-2"> </span><span class="hl-8">awaitSubject</span><span class="hl-2"> = </span><span class="hl-3">new</span><span class="hl-2"> </span><span class="hl-1">Subject</span><span class="hl-2">();</span><br/><span class="hl-2">  </span><br/><span class="hl-2">  </span><span class="hl-1">listenRisk</span><span class="hl-2">((</span><span class="hl-6">event</span><span class="hl-2">) </span><span class="hl-3">=&gt;</span><span class="hl-2"> {</span><br/><span class="hl-2">    </span><span class="hl-6">rejectionCount</span><span class="hl-2">++;</span><br/><span class="hl-2">    </span><span class="hl-5">if</span><span class="hl-2"> (</span><span class="hl-6">event</span><span class="hl-2">.</span><span class="hl-6">comment</span><span class="hl-2">.</span><span class="hl-1">includes</span><span class="hl-2">(</span><span class="hl-4">&quot;Min price validation&quot;</span><span class="hl-2">)) {</span><br/><span class="hl-2">      </span><span class="hl-6">awaitSubject</span><span class="hl-2">.</span><span class="hl-1">next</span><span class="hl-2">();</span><br/><span class="hl-2">    }</span><br/><span class="hl-2">  });</span><br/><span class="hl-2">  </span><br/><span class="hl-2">  </span><span class="hl-6">Backtest</span><span class="hl-2">.</span><span class="hl-1">background</span><span class="hl-2">(</span><span class="hl-4">&quot;BTCUSDT&quot;</span><span class="hl-2">, {</span><br/><span class="hl-2">    </span><span class="hl-6">strategyName:</span><span class="hl-2"> </span><span class="hl-4">&quot;test-strategy&quot;</span><span class="hl-2">,</span><br/><span class="hl-2">    </span><span class="hl-6">exchangeName:</span><span class="hl-2"> </span><span class="hl-4">&quot;test-exchange&quot;</span><span class="hl-2">,</span><br/><span class="hl-2">    </span><span class="hl-6">frameName:</span><span class="hl-2"> </span><span class="hl-4">&quot;test-frame&quot;</span><br/><span class="hl-2">  });</span><br/><span class="hl-2">  </span><br/><span class="hl-2">  </span><span class="hl-5">await</span><span class="hl-2"> </span><span class="hl-6">awaitSubject</span><span class="hl-2">.</span><span class="hl-1">toPromise</span><span class="hl-2">();</span><br/><span class="hl-2">  </span><br/><span class="hl-2">  </span><span class="hl-5">if</span><span class="hl-2"> (</span><span class="hl-6">rejectionCount</span><span class="hl-2"> &gt; </span><span class="hl-7">0</span><span class="hl-2">) {</span><br/><span class="hl-2">    </span><span class="hl-1">pass</span><span class="hl-2">(</span><span class="hl-4">`Validation rejected </span><span class="hl-3">${</span><span class="hl-6">rejectionCount</span><span class="hl-3">}</span><span class="hl-4"> signals`</span><span class="hl-2">);</span><br/><span class="hl-2">  } </span><span class="hl-5">else</span><span class="hl-2"> {</span><br/><span class="hl-2">    </span><span class="hl-1">fail</span><span class="hl-2">(</span><span class="hl-4">&quot;No rejections detected&quot;</span><span class="hl-2">);</span><br/><span class="hl-2">  }</span><br/><span class="hl-2">});</span>
</code><button type="button">Copy</button></pre>

<hr>
<a id="advanced-validation-examples" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Advanced Validation Examples<a href="#advanced-validation-examples" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><a id="time-based-trading-windows" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Time-Based Trading Windows<a href="#time-based-trading-windows" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Restrict trading to specific hours:</p>
<pre><code class="typescript"><span class="hl-2">{</span><br/><span class="hl-2">  </span><span class="hl-10">validate</span><span class="hl-2">: ({ </span><span class="hl-6">timestamp</span><span class="hl-2"> }) </span><span class="hl-3">=&gt;</span><span class="hl-2"> {</span><br/><span class="hl-2">    </span><span class="hl-3">const</span><span class="hl-2"> </span><span class="hl-8">date</span><span class="hl-2"> = </span><span class="hl-3">new</span><span class="hl-2"> </span><span class="hl-1">Date</span><span class="hl-2">(</span><span class="hl-6">timestamp</span><span class="hl-2">);</span><br/><span class="hl-2">    </span><span class="hl-3">const</span><span class="hl-2"> </span><span class="hl-8">hour</span><span class="hl-2"> = </span><span class="hl-6">date</span><span class="hl-2">.</span><span class="hl-1">getUTCHours</span><span class="hl-2">();</span><br/><span class="hl-2">    </span><br/><span class="hl-2">    </span><span class="hl-3">const</span><span class="hl-2"> </span><span class="hl-8">MARKET_OPEN</span><span class="hl-2"> = </span><span class="hl-7">9</span><span class="hl-2">;  </span><span class="hl-0">// 09:00 UTC</span><br/><span class="hl-2">    </span><span class="hl-3">const</span><span class="hl-2"> </span><span class="hl-8">MARKET_CLOSE</span><span class="hl-2"> = </span><span class="hl-7">16</span><span class="hl-2">; </span><span class="hl-0">// 16:00 UTC</span><br/><span class="hl-2">    </span><br/><span class="hl-2">    </span><span class="hl-5">if</span><span class="hl-2"> (</span><span class="hl-6">hour</span><span class="hl-2"> &lt; </span><span class="hl-8">MARKET_OPEN</span><span class="hl-2"> || </span><span class="hl-6">hour</span><span class="hl-2"> &gt;= </span><span class="hl-8">MARKET_CLOSE</span><span class="hl-2">) {</span><br/><span class="hl-2">      </span><span class="hl-5">throw</span><span class="hl-2"> </span><span class="hl-3">new</span><span class="hl-2"> </span><span class="hl-1">Error</span><span class="hl-2">(</span><span class="hl-4">`Outside trading hours: </span><span class="hl-3">${</span><span class="hl-6">hour</span><span class="hl-3">}</span><span class="hl-4">:00 UTC (</span><span class="hl-3">${</span><span class="hl-8">MARKET_OPEN</span><span class="hl-3">}</span><span class="hl-4">:00-</span><span class="hl-3">${</span><span class="hl-8">MARKET_CLOSE</span><span class="hl-3">}</span><span class="hl-4">:00 only)`</span><span class="hl-2">);</span><br/><span class="hl-2">    }</span><br/><span class="hl-2">  },</span><br/><span class="hl-2">  </span><span class="hl-10">note</span><span class="hl-2">: </span><span class="hl-4">&quot;Restrict trading to 09:00-16:00 UTC&quot;</span><br/><span class="hl-2">}</span>
</code><button type="button">Copy</button></pre>

<a id="correlation-based-position-limits" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Correlation-Based Position Limits<a href="#correlation-based-position-limits" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Prevent correlated positions:</p>
<pre><code class="typescript"><span class="hl-2">{</span><br/><span class="hl-2">  </span><span class="hl-10">validate</span><span class="hl-2">: ({ </span><span class="hl-6">symbol</span><span class="hl-2">, </span><span class="hl-6">activePositions</span><span class="hl-2"> }) </span><span class="hl-3">=&gt;</span><span class="hl-2"> {</span><br/><span class="hl-2">    </span><span class="hl-0">// Define correlated pairs</span><br/><span class="hl-2">    </span><span class="hl-3">const</span><span class="hl-2"> </span><span class="hl-8">correlations</span><span class="hl-2"> = {</span><br/><span class="hl-2">      </span><span class="hl-4">&quot;BTCUSDT&quot;</span><span class="hl-6">:</span><span class="hl-2"> [</span><span class="hl-4">&quot;ETHUSDT&quot;</span><span class="hl-2">, </span><span class="hl-4">&quot;BNBUSDT&quot;</span><span class="hl-2">],</span><br/><span class="hl-2">      </span><span class="hl-4">&quot;ETHUSDT&quot;</span><span class="hl-6">:</span><span class="hl-2"> [</span><span class="hl-4">&quot;BTCUSDT&quot;</span><span class="hl-2">, </span><span class="hl-4">&quot;MATICUSDT&quot;</span><span class="hl-2">],</span><br/><span class="hl-2">      </span><span class="hl-0">// ... more correlations</span><br/><span class="hl-2">    };</span><br/><span class="hl-2">    </span><br/><span class="hl-2">    </span><span class="hl-3">const</span><span class="hl-2"> </span><span class="hl-8">correlated</span><span class="hl-2"> = </span><span class="hl-6">correlations</span><span class="hl-2">[</span><span class="hl-6">symbol</span><span class="hl-2">] || [];</span><br/><span class="hl-2">    </span><span class="hl-3">const</span><span class="hl-2"> </span><span class="hl-8">hasCorrelatedPosition</span><span class="hl-2"> = </span><span class="hl-6">activePositions</span><span class="hl-2">.</span><span class="hl-1">some</span><span class="hl-2">(</span><span class="hl-6">p</span><span class="hl-2"> </span><span class="hl-3">=&gt;</span><span class="hl-2"> </span><br/><span class="hl-2">      </span><span class="hl-6">correlated</span><span class="hl-2">.</span><span class="hl-1">includes</span><span class="hl-2">(</span><span class="hl-6">p</span><span class="hl-2">.</span><span class="hl-6">signal</span><span class="hl-2">.</span><span class="hl-6">symbol</span><span class="hl-2">)</span><br/><span class="hl-2">    );</span><br/><span class="hl-2">    </span><br/><span class="hl-2">    </span><span class="hl-5">if</span><span class="hl-2"> (</span><span class="hl-6">hasCorrelatedPosition</span><span class="hl-2">) {</span><br/><span class="hl-2">      </span><span class="hl-5">throw</span><span class="hl-2"> </span><span class="hl-3">new</span><span class="hl-2"> </span><span class="hl-1">Error</span><span class="hl-2">(</span><span class="hl-4">`Correlated position exists - cannot open </span><span class="hl-3">${</span><span class="hl-6">symbol</span><span class="hl-3">}</span><span class="hl-4">`</span><span class="hl-2">);</span><br/><span class="hl-2">    }</span><br/><span class="hl-2">  },</span><br/><span class="hl-2">  </span><span class="hl-10">note</span><span class="hl-2">: </span><span class="hl-4">&quot;Prevent correlated positions for diversification&quot;</span><br/><span class="hl-2">}</span>
</code><button type="button">Copy</button></pre>

<a id="dynamic-stop-loss-validation" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Dynamic Stop Loss Validation<a href="#dynamic-stop-loss-validation" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Enforce stricter stop loss during high volatility:</p>
<pre><code class="typescript"><span class="hl-2">{</span><br/><span class="hl-2">  </span><span class="hl-10">validate</span><span class="hl-2">: ({ </span><span class="hl-6">pendingSignal</span><span class="hl-2">, </span><span class="hl-6">currentPrice</span><span class="hl-2">, </span><span class="hl-6">activePositions</span><span class="hl-2"> }) </span><span class="hl-3">=&gt;</span><span class="hl-2"> {</span><br/><span class="hl-2">    </span><span class="hl-3">const</span><span class="hl-2"> { </span><span class="hl-8">priceOpen</span><span class="hl-2"> = </span><span class="hl-6">currentPrice</span><span class="hl-2">, </span><span class="hl-8">priceStopLoss</span><span class="hl-2">, </span><span class="hl-8">position</span><span class="hl-2"> } = </span><span class="hl-6">pendingSignal</span><span class="hl-2">;</span><br/><span class="hl-2">    </span><br/><span class="hl-2">    </span><span class="hl-0">// Calculate average position size to estimate volatility</span><br/><span class="hl-2">    </span><span class="hl-3">const</span><span class="hl-2"> </span><span class="hl-8">avgPositionTime</span><span class="hl-2"> = </span><span class="hl-6">activePositions</span><span class="hl-2">.</span><span class="hl-6">length</span><span class="hl-2"> &gt; </span><span class="hl-7">0</span><br/><span class="hl-2">      ? </span><span class="hl-6">activePositions</span><span class="hl-2">.</span><span class="hl-1">reduce</span><span class="hl-2">((</span><span class="hl-6">sum</span><span class="hl-2">, </span><span class="hl-6">p</span><span class="hl-2">) </span><span class="hl-3">=&gt;</span><span class="hl-2"> </span><span class="hl-6">sum</span><span class="hl-2"> + (</span><span class="hl-6">Date</span><span class="hl-2">.</span><span class="hl-1">now</span><span class="hl-2">() - </span><span class="hl-6">p</span><span class="hl-2">.</span><span class="hl-6">openTimestamp</span><span class="hl-2">), </span><span class="hl-7">0</span><span class="hl-2">) / </span><span class="hl-6">activePositions</span><span class="hl-2">.</span><span class="hl-6">length</span><br/><span class="hl-2">      : </span><span class="hl-7">0</span><span class="hl-2">;</span><br/><span class="hl-2">    </span><br/><span class="hl-2">    </span><span class="hl-3">const</span><span class="hl-2"> </span><span class="hl-8">avgMinutes</span><span class="hl-2"> = </span><span class="hl-6">avgPositionTime</span><span class="hl-2"> / </span><span class="hl-7">60000</span><span class="hl-2">;</span><br/><span class="hl-2">    </span><span class="hl-3">const</span><span class="hl-2"> </span><span class="hl-8">isHighVolatility</span><span class="hl-2"> = </span><span class="hl-6">avgMinutes</span><span class="hl-2"> &lt; </span><span class="hl-7">30</span><span class="hl-2">; </span><span class="hl-0">// Positions closing fast = high volatility</span><br/><span class="hl-2">    </span><br/><span class="hl-2">    </span><span class="hl-3">const</span><span class="hl-2"> </span><span class="hl-8">slDistance</span><span class="hl-2"> = </span><span class="hl-6">position</span><span class="hl-2"> === </span><span class="hl-4">&quot;long&quot;</span><br/><span class="hl-2">      ? ((</span><span class="hl-6">priceOpen</span><span class="hl-2"> - </span><span class="hl-6">priceStopLoss</span><span class="hl-2">) / </span><span class="hl-6">priceOpen</span><span class="hl-2">) * </span><span class="hl-7">100</span><br/><span class="hl-2">      : ((</span><span class="hl-6">priceStopLoss</span><span class="hl-2"> - </span><span class="hl-6">priceOpen</span><span class="hl-2">) / </span><span class="hl-6">priceOpen</span><span class="hl-2">) * </span><span class="hl-7">100</span><span class="hl-2">;</span><br/><span class="hl-2">    </span><br/><span class="hl-2">    </span><span class="hl-3">const</span><span class="hl-2"> </span><span class="hl-8">maxSL</span><span class="hl-2"> = </span><span class="hl-6">isHighVolatility</span><span class="hl-2"> ? </span><span class="hl-7">2.0</span><span class="hl-2"> : </span><span class="hl-7">5.0</span><span class="hl-2">; </span><span class="hl-0">// Tighter SL during volatility</span><br/><span class="hl-2">    </span><br/><span class="hl-2">    </span><span class="hl-5">if</span><span class="hl-2"> (</span><span class="hl-6">slDistance</span><span class="hl-2"> &gt; </span><span class="hl-6">maxSL</span><span class="hl-2">) {</span><br/><span class="hl-2">      </span><span class="hl-5">throw</span><span class="hl-2"> </span><span class="hl-3">new</span><span class="hl-2"> </span><span class="hl-1">Error</span><span class="hl-2">(</span><span class="hl-4">`SL too wide: </span><span class="hl-3">${</span><span class="hl-6">slDistance</span><span class="hl-9">.</span><span class="hl-1">toFixed</span><span class="hl-9">(</span><span class="hl-7">2</span><span class="hl-9">)</span><span class="hl-3">}</span><span class="hl-4">% (max </span><span class="hl-3">${</span><span class="hl-6">maxSL</span><span class="hl-3">}</span><span class="hl-4">% in </span><span class="hl-3">${</span><span class="hl-6">isHighVolatility</span><span class="hl-9"> </span><span class="hl-2">?</span><span class="hl-9"> </span><span class="hl-4">&#39;high&#39;</span><span class="hl-9"> </span><span class="hl-2">:</span><span class="hl-9"> </span><span class="hl-4">&#39;normal&#39;</span><span class="hl-3">}</span><span class="hl-4"> volatility)`</span><span class="hl-2">);</span><br/><span class="hl-2">    }</span><br/><span class="hl-2">  },</span><br/><span class="hl-2">  </span><span class="hl-10">note</span><span class="hl-2">: </span><span class="hl-4">&quot;Enforce tighter stop loss during high volatility&quot;</span><br/><span class="hl-2">}</span>
</code><button type="button">Copy</button></pre>

<a id="cross-strategy-position-balance" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Cross-Strategy Position Balance<a href="#cross-strategy-position-balance" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Ensure no single strategy dominates:</p>
<pre><code class="typescript"><span class="hl-2">{</span><br/><span class="hl-2">  </span><span class="hl-10">validate</span><span class="hl-2">: ({ </span><span class="hl-6">strategyName</span><span class="hl-2">, </span><span class="hl-6">activePositions</span><span class="hl-2">, </span><span class="hl-6">activePositionCount</span><span class="hl-2"> }) </span><span class="hl-3">=&gt;</span><span class="hl-2"> {</span><br/><span class="hl-2">    </span><span class="hl-5">if</span><span class="hl-2"> (</span><span class="hl-6">activePositionCount</span><span class="hl-2"> &lt; </span><span class="hl-7">3</span><span class="hl-2">) </span><span class="hl-5">return</span><span class="hl-2">; </span><span class="hl-0">// Allow until 3 positions</span><br/><span class="hl-2">    </span><br/><span class="hl-2">    </span><span class="hl-3">const</span><span class="hl-2"> </span><span class="hl-8">strategyPositions</span><span class="hl-2"> = </span><span class="hl-6">activePositions</span><span class="hl-2">.</span><span class="hl-1">filter</span><span class="hl-2">(</span><span class="hl-6">p</span><span class="hl-2"> </span><span class="hl-3">=&gt;</span><span class="hl-2"> </span><span class="hl-6">p</span><span class="hl-2">.</span><span class="hl-6">strategyName</span><span class="hl-2"> === </span><span class="hl-6">strategyName</span><span class="hl-2">);</span><br/><span class="hl-2">    </span><span class="hl-3">const</span><span class="hl-2"> </span><span class="hl-8">newCount</span><span class="hl-2"> = </span><span class="hl-6">strategyPositions</span><span class="hl-2">.</span><span class="hl-6">length</span><span class="hl-2"> + </span><span class="hl-7">1</span><span class="hl-2">; </span><span class="hl-0">// Including this signal</span><br/><span class="hl-2">    </span><br/><span class="hl-2">    </span><span class="hl-3">const</span><span class="hl-2"> </span><span class="hl-8">newPercent</span><span class="hl-2"> = (</span><span class="hl-6">newCount</span><span class="hl-2"> / (</span><span class="hl-6">activePositionCount</span><span class="hl-2"> + </span><span class="hl-7">1</span><span class="hl-2">)) * </span><span class="hl-7">100</span><span class="hl-2">;</span><br/><span class="hl-2">    </span><span class="hl-3">const</span><span class="hl-2"> </span><span class="hl-8">MAX_PERCENT</span><span class="hl-2"> = </span><span class="hl-7">50</span><span class="hl-2">;</span><br/><span class="hl-2">    </span><br/><span class="hl-2">    </span><span class="hl-5">if</span><span class="hl-2"> (</span><span class="hl-6">newPercent</span><span class="hl-2"> &gt; </span><span class="hl-8">MAX_PERCENT</span><span class="hl-2">) {</span><br/><span class="hl-2">      </span><span class="hl-5">throw</span><span class="hl-2"> </span><span class="hl-3">new</span><span class="hl-2"> </span><span class="hl-1">Error</span><span class="hl-2">(</span><span class="hl-4">`Strategy </span><span class="hl-3">${</span><span class="hl-6">strategyName</span><span class="hl-3">}</span><span class="hl-4"> would be </span><span class="hl-3">${</span><span class="hl-6">newPercent</span><span class="hl-9">.</span><span class="hl-1">toFixed</span><span class="hl-9">(</span><span class="hl-7">0</span><span class="hl-9">)</span><span class="hl-3">}</span><span class="hl-4">% of portfolio (max </span><span class="hl-3">${</span><span class="hl-8">MAX_PERCENT</span><span class="hl-3">}</span><span class="hl-4">%)`</span><span class="hl-2">);</span><br/><span class="hl-2">    }</span><br/><span class="hl-2">  },</span><br/><span class="hl-2">  </span><span class="hl-10">note</span><span class="hl-2">: </span><span class="hl-4">&quot;No strategy exceeds 50% of portfolio&quot;</span><br/><span class="hl-2">}</span>
</code><button type="button">Copy</button></pre>

<hr>
<a id="multi-risk-profile-pattern" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Multi-Risk Profile Pattern<a href="#multi-risk-profile-pattern" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>Strategies can use multiple risk profiles by specifying <code>riskList</code>:</p>
<pre><code class="typescript"><span class="hl-1">addRisk</span><span class="hl-2">({</span><br/><span class="hl-2">  </span><span class="hl-6">riskName:</span><span class="hl-2"> </span><span class="hl-4">&quot;position-limit&quot;</span><span class="hl-2">,</span><br/><span class="hl-2">  </span><span class="hl-6">validations:</span><span class="hl-2"> [</span><br/><span class="hl-2">    ({ </span><span class="hl-6">activePositionCount</span><span class="hl-2"> }) </span><span class="hl-3">=&gt;</span><span class="hl-2"> {</span><br/><span class="hl-2">      </span><span class="hl-5">if</span><span class="hl-2"> (</span><span class="hl-6">activePositionCount</span><span class="hl-2"> &gt;= </span><span class="hl-7">5</span><span class="hl-2">) {</span><br/><span class="hl-2">        </span><span class="hl-5">throw</span><span class="hl-2"> </span><span class="hl-3">new</span><span class="hl-2"> </span><span class="hl-1">Error</span><span class="hl-2">(</span><span class="hl-4">&quot;Portfolio limit: 5 positions&quot;</span><span class="hl-2">);</span><br/><span class="hl-2">      }</span><br/><span class="hl-2">    }</span><br/><span class="hl-2">  ]</span><br/><span class="hl-2">});</span><br/><br/><span class="hl-1">addRisk</span><span class="hl-2">({</span><br/><span class="hl-2">  </span><span class="hl-6">riskName:</span><span class="hl-2"> </span><span class="hl-4">&quot;risk-reward&quot;</span><span class="hl-2">,</span><br/><span class="hl-2">  </span><span class="hl-6">validations:</span><span class="hl-2"> [</span><br/><span class="hl-2">    ({ </span><span class="hl-6">pendingSignal</span><span class="hl-2">, </span><span class="hl-6">currentPrice</span><span class="hl-2"> }) </span><span class="hl-3">=&gt;</span><span class="hl-2"> {</span><br/><span class="hl-2">      </span><span class="hl-3">const</span><span class="hl-2"> { </span><span class="hl-8">priceOpen</span><span class="hl-2"> = </span><span class="hl-6">currentPrice</span><span class="hl-2">, </span><span class="hl-8">priceTakeProfit</span><span class="hl-2">, </span><span class="hl-8">priceStopLoss</span><span class="hl-2">, </span><span class="hl-8">position</span><span class="hl-2"> } = </span><span class="hl-6">pendingSignal</span><span class="hl-2">;</span><br/><span class="hl-2">      </span><span class="hl-3">const</span><span class="hl-2"> </span><span class="hl-8">reward</span><span class="hl-2"> = </span><span class="hl-6">position</span><span class="hl-2"> === </span><span class="hl-4">&quot;long&quot;</span><span class="hl-2"> ? </span><span class="hl-6">priceTakeProfit</span><span class="hl-2"> - </span><span class="hl-6">priceOpen</span><span class="hl-2"> : </span><span class="hl-6">priceOpen</span><span class="hl-2"> - </span><span class="hl-6">priceTakeProfit</span><span class="hl-2">;</span><br/><span class="hl-2">      </span><span class="hl-3">const</span><span class="hl-2"> </span><span class="hl-8">risk</span><span class="hl-2"> = </span><span class="hl-6">position</span><span class="hl-2"> === </span><span class="hl-4">&quot;long&quot;</span><span class="hl-2"> ? </span><span class="hl-6">priceOpen</span><span class="hl-2"> - </span><span class="hl-6">priceStopLoss</span><span class="hl-2"> : </span><span class="hl-6">priceStopLoss</span><span class="hl-2"> - </span><span class="hl-6">priceOpen</span><span class="hl-2">;</span><br/><span class="hl-2">      </span><br/><span class="hl-2">      </span><span class="hl-5">if</span><span class="hl-2"> (</span><span class="hl-6">reward</span><span class="hl-2"> / </span><span class="hl-6">risk</span><span class="hl-2"> &lt; </span><span class="hl-7">2</span><span class="hl-2">) {</span><br/><span class="hl-2">        </span><span class="hl-5">throw</span><span class="hl-2"> </span><span class="hl-3">new</span><span class="hl-2"> </span><span class="hl-1">Error</span><span class="hl-2">(</span><span class="hl-4">&quot;Minimum 2:1 R/R required&quot;</span><span class="hl-2">);</span><br/><span class="hl-2">      }</span><br/><span class="hl-2">    }</span><br/><span class="hl-2">  ]</span><br/><span class="hl-2">});</span><br/><br/><span class="hl-1">addStrategy</span><span class="hl-2">({</span><br/><span class="hl-2">  </span><span class="hl-6">strategyName:</span><span class="hl-2"> </span><span class="hl-4">&quot;my-strategy&quot;</span><span class="hl-2">,</span><br/><span class="hl-2">  </span><span class="hl-6">interval:</span><span class="hl-2"> </span><span class="hl-4">&quot;5m&quot;</span><span class="hl-2">,</span><br/><span class="hl-2">  </span><span class="hl-6">riskList:</span><span class="hl-2"> [</span><span class="hl-4">&quot;position-limit&quot;</span><span class="hl-2">, </span><span class="hl-4">&quot;risk-reward&quot;</span><span class="hl-2">], </span><span class="hl-0">// Both applied</span><br/><span class="hl-2">  </span><span class="hl-1">getSignal</span><span class="hl-6">:</span><span class="hl-2"> </span><span class="hl-3">async</span><span class="hl-2"> (</span><span class="hl-6">symbol</span><span class="hl-2">, </span><span class="hl-6">when</span><span class="hl-2">) </span><span class="hl-3">=&gt;</span><span class="hl-2"> {</span><br/><span class="hl-2">    </span><span class="hl-0">// ... signal generation ...</span><br/><span class="hl-2">  }</span><br/><span class="hl-2">});</span>
</code><button type="button">Copy</button></pre>

<p><strong>Execution Order</strong>: All risk profiles in <code>riskList</code> are applied sequentially. Signal must pass <strong>all</strong> validations from <strong>all</strong> risk profiles.</p>
<hr>
<a id="performance-considerations" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Performance Considerations<a href="#performance-considerations" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><a id="validation-execution-cost" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Validation Execution Cost<a href="#validation-execution-cost" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Validations execute on <strong>every</strong> signal generation attempt:</p>
<pre><code class="typescript"><span class="hl-0">// BAD: Expensive operation on every validation</span><br/><span class="hl-2">{</span><br/><span class="hl-2">  </span><span class="hl-10">validate</span><span class="hl-2">: </span><span class="hl-3">async</span><span class="hl-2"> ({ </span><span class="hl-6">symbol</span><span class="hl-2"> }) </span><span class="hl-3">=&gt;</span><span class="hl-2"> {</span><br/><span class="hl-2">    </span><span class="hl-0">// This queries database on EVERY signal check!</span><br/><span class="hl-2">    </span><span class="hl-3">const</span><span class="hl-2"> </span><span class="hl-8">marketData</span><span class="hl-2"> = </span><span class="hl-5">await</span><span class="hl-2"> </span><span class="hl-6">database</span><span class="hl-2">.</span><span class="hl-1">query</span><span class="hl-2">(</span><span class="hl-4">`SELECT * FROM market_data WHERE symbol = ?`</span><span class="hl-2">, [</span><span class="hl-6">symbol</span><span class="hl-2">]);</span><br/><span class="hl-2">    </span><span class="hl-0">// ... validation logic ...</span><br/><span class="hl-2">  }</span><br/><span class="hl-2">}</span><br/><br/><span class="hl-0">// GOOD: Cache expensive data</span><br/><span class="hl-3">const</span><span class="hl-2"> </span><span class="hl-8">marketDataCache</span><span class="hl-2"> = </span><span class="hl-3">new</span><span class="hl-2"> </span><span class="hl-1">Map</span><span class="hl-2">();</span><br/><br/><span class="hl-2">{</span><br/><span class="hl-2">  </span><span class="hl-10">validate</span><span class="hl-2">: </span><span class="hl-3">async</span><span class="hl-2"> ({ </span><span class="hl-6">symbol</span><span class="hl-2"> }) </span><span class="hl-3">=&gt;</span><span class="hl-2"> {</span><br/><span class="hl-2">    </span><span class="hl-5">if</span><span class="hl-2"> (!</span><span class="hl-6">marketDataCache</span><span class="hl-2">.</span><span class="hl-1">has</span><span class="hl-2">(</span><span class="hl-6">symbol</span><span class="hl-2">)) {</span><br/><span class="hl-2">      </span><span class="hl-3">const</span><span class="hl-2"> </span><span class="hl-8">data</span><span class="hl-2"> = </span><span class="hl-5">await</span><span class="hl-2"> </span><span class="hl-6">database</span><span class="hl-2">.</span><span class="hl-1">query</span><span class="hl-2">(</span><span class="hl-4">`SELECT * FROM market_data WHERE symbol = ?`</span><span class="hl-2">, [</span><span class="hl-6">symbol</span><span class="hl-2">]);</span><br/><span class="hl-2">      </span><span class="hl-6">marketDataCache</span><span class="hl-2">.</span><span class="hl-1">set</span><span class="hl-2">(</span><span class="hl-6">symbol</span><span class="hl-2">, </span><span class="hl-6">data</span><span class="hl-2">);</span><br/><span class="hl-2">      </span><span class="hl-1">setTimeout</span><span class="hl-2">(() </span><span class="hl-3">=&gt;</span><span class="hl-2"> </span><span class="hl-6">marketDataCache</span><span class="hl-2">.</span><span class="hl-1">delete</span><span class="hl-2">(</span><span class="hl-6">symbol</span><span class="hl-2">), </span><span class="hl-7">60000</span><span class="hl-2">); </span><span class="hl-0">// 1min TTL</span><br/><span class="hl-2">    }</span><br/><span class="hl-2">    </span><br/><span class="hl-2">    </span><span class="hl-3">const</span><span class="hl-2"> </span><span class="hl-8">marketData</span><span class="hl-2"> = </span><span class="hl-6">marketDataCache</span><span class="hl-2">.</span><span class="hl-1">get</span><span class="hl-2">(</span><span class="hl-6">symbol</span><span class="hl-2">);</span><br/><span class="hl-2">    </span><span class="hl-0">// ... validation logic ...</span><br/><span class="hl-2">  }</span><br/><span class="hl-2">}</span>
</code><button type="button">Copy</button></pre>

<a id="validation-ordering" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Validation Ordering<a href="#validation-ordering" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Order validations from cheapest to most expensive:</p>
<pre><code class="typescript"><span class="hl-10">validations</span><span class="hl-2">: [</span><br/><span class="hl-2">  </span><span class="hl-0">// Fast: Simple numeric comparison</span><br/><span class="hl-2">  ({ </span><span class="hl-6">activePositionCount</span><span class="hl-2"> }) </span><span class="hl-3">=&gt;</span><span class="hl-2"> {</span><br/><span class="hl-2">    </span><span class="hl-5">if</span><span class="hl-2"> (</span><span class="hl-6">activePositionCount</span><span class="hl-2"> &gt;= </span><span class="hl-7">10</span><span class="hl-2">) </span><span class="hl-5">throw</span><span class="hl-2"> </span><span class="hl-3">new</span><span class="hl-2"> </span><span class="hl-1">Error</span><span class="hl-2">(</span><span class="hl-4">&quot;Position limit&quot;</span><span class="hl-2">);</span><br/><span class="hl-2">  },</span><br/><span class="hl-2">  </span><br/><span class="hl-2">  </span><span class="hl-0">// Medium: Array iteration</span><br/><span class="hl-2">  ({ </span><span class="hl-6">symbol</span><span class="hl-2">, </span><span class="hl-6">activePositions</span><span class="hl-2"> }) </span><span class="hl-3">=&gt;</span><span class="hl-2"> {</span><br/><span class="hl-2">    </span><span class="hl-3">const</span><span class="hl-2"> </span><span class="hl-8">count</span><span class="hl-2"> = </span><span class="hl-6">activePositions</span><span class="hl-2">.</span><span class="hl-1">filter</span><span class="hl-2">(</span><span class="hl-6">p</span><span class="hl-2"> </span><span class="hl-3">=&gt;</span><span class="hl-2"> </span><span class="hl-6">p</span><span class="hl-2">.</span><span class="hl-6">signal</span><span class="hl-2">.</span><span class="hl-6">symbol</span><span class="hl-2"> === </span><span class="hl-6">symbol</span><span class="hl-2">).</span><span class="hl-6">length</span><span class="hl-2">;</span><br/><span class="hl-2">    </span><span class="hl-5">if</span><span class="hl-2"> (</span><span class="hl-6">count</span><span class="hl-2"> &gt;= </span><span class="hl-7">2</span><span class="hl-2">) </span><span class="hl-5">throw</span><span class="hl-2"> </span><span class="hl-3">new</span><span class="hl-2"> </span><span class="hl-1">Error</span><span class="hl-2">(</span><span class="hl-4">&quot;Symbol limit&quot;</span><span class="hl-2">);</span><br/><span class="hl-2">  },</span><br/><span class="hl-2">  </span><br/><span class="hl-2">  </span><span class="hl-0">// Expensive: Async API call (runs only if previous checks pass)</span><br/><span class="hl-2">  </span><span class="hl-3">async</span><span class="hl-2"> ({ </span><span class="hl-6">symbol</span><span class="hl-2"> }) </span><span class="hl-3">=&gt;</span><span class="hl-2"> {</span><br/><span class="hl-2">    </span><span class="hl-3">const</span><span class="hl-2"> </span><span class="hl-8">data</span><span class="hl-2"> = </span><span class="hl-5">await</span><span class="hl-2"> </span><span class="hl-6">externalAPI</span><span class="hl-2">.</span><span class="hl-1">check</span><span class="hl-2">(</span><span class="hl-6">symbol</span><span class="hl-2">);</span><br/><span class="hl-2">    </span><span class="hl-5">if</span><span class="hl-2"> (!</span><span class="hl-6">data</span><span class="hl-2">.</span><span class="hl-6">allowed</span><span class="hl-2">) </span><span class="hl-5">throw</span><span class="hl-2"> </span><span class="hl-3">new</span><span class="hl-2"> </span><span class="hl-1">Error</span><span class="hl-2">(</span><span class="hl-4">&quot;External validation failed&quot;</span><span class="hl-2">);</span><br/><span class="hl-2">  }</span><br/><span class="hl-2">]</span>
</code><button type="button">Copy</button></pre>

<p><strong>Rationale</strong>: Short-circuit on failure stops execution early, avoiding expensive operations for signals that would fail cheap checks.</p>
<hr>
<a id="validation-state-and-memoization" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Validation State and Memoization<a href="#validation-state-and-memoization" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p><code>ClientRisk</code> instances are memoized per risk profile and execution context:</p>
<pre><code class="typescript"><span class="hl-0">// Internal: StrategyConnectionService</span><br/><span class="hl-3">const</span><span class="hl-2"> </span><span class="hl-8">getStrategy</span><span class="hl-2"> = </span><span class="hl-1">memoize</span><span class="hl-2">((</span><span class="hl-6">symbol</span><span class="hl-2">: </span><span class="hl-11">string</span><span class="hl-2">, </span><span class="hl-6">strategyName</span><span class="hl-2">: </span><span class="hl-11">string</span><span class="hl-2">, </span><span class="hl-6">backtest</span><span class="hl-2">: </span><span class="hl-11">boolean</span><span class="hl-2">) </span><span class="hl-3">=&gt;</span><span class="hl-2"> {</span><br/><span class="hl-2">  </span><span class="hl-0">// Single ClientStrategy instance per (symbol, strategyName, backtest) tuple</span><br/><span class="hl-2">  </span><span class="hl-5">return</span><span class="hl-2"> </span><span class="hl-3">new</span><span class="hl-2"> </span><span class="hl-1">ClientStrategy</span><span class="hl-2">({...});</span><br/><span class="hl-2">});</span><br/><br/><span class="hl-0">// Internal: RiskConnectionService  </span><br/><span class="hl-3">const</span><span class="hl-2"> </span><span class="hl-8">getRisk</span><span class="hl-2"> = </span><span class="hl-1">memoize</span><span class="hl-2">((</span><span class="hl-6">riskName</span><span class="hl-2">: </span><span class="hl-11">string</span><span class="hl-2">, </span><span class="hl-6">backtest</span><span class="hl-2">: </span><span class="hl-11">boolean</span><span class="hl-2">) </span><span class="hl-3">=&gt;</span><span class="hl-2"> {</span><br/><span class="hl-2">  </span><span class="hl-0">// Single ClientRisk instance per (riskName, backtest) tuple</span><br/><span class="hl-2">  </span><span class="hl-5">return</span><span class="hl-2"> </span><span class="hl-3">new</span><span class="hl-2"> </span><span class="hl-1">ClientRisk</span><span class="hl-2">({...});</span><br/><span class="hl-2">});</span>
</code><button type="button">Copy</button></pre>

<p><strong>Implications</strong>:</p>
<ul>
<li>Risk profile validations are <strong>shared</strong> across all strategies using that risk profile</li>
<li><code>_activePositionsMap</code> is <strong>shared</strong> across strategies in same risk profile</li>
<li>Backtest and Live modes have <strong>separate</strong> <code>ClientRisk</code> instances (different <code>backtest</code> flag)</li>
</ul>
<hr>
<a id="debugging-validation-failures" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Debugging Validation Failures<a href="#debugging-validation-failures" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><a id="enable-validation-logging" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Enable Validation Logging<a href="#enable-validation-logging" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Listen to <code>validationSubject</code> for raw validation errors:</p>
<pre><code class="typescript"><span class="hl-5">import</span><span class="hl-2"> { </span><span class="hl-6">listenValidation</span><span class="hl-2"> } </span><span class="hl-5">from</span><span class="hl-2"> </span><span class="hl-4">&quot;backtest-kit&quot;</span><span class="hl-2">;</span><br/><br/><span class="hl-1">listenValidation</span><span class="hl-2">((</span><span class="hl-6">error</span><span class="hl-2">) </span><span class="hl-3">=&gt;</span><span class="hl-2"> {</span><br/><span class="hl-2">  </span><span class="hl-6">console</span><span class="hl-2">.</span><span class="hl-1">error</span><span class="hl-2">(</span><span class="hl-4">&quot;[VALIDATION ERROR]&quot;</span><span class="hl-2">, </span><span class="hl-6">error</span><span class="hl-2">.</span><span class="hl-6">message</span><span class="hl-2">);</span><br/><span class="hl-2">  </span><span class="hl-6">console</span><span class="hl-2">.</span><span class="hl-1">error</span><span class="hl-2">(</span><span class="hl-6">error</span><span class="hl-2">.</span><span class="hl-6">stack</span><span class="hl-2">);</span><br/><span class="hl-2">});</span>
</code><button type="button">Copy</button></pre>

<a id="inspect-rejection-context" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Inspect Rejection Context<a href="#inspect-rejection-context" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Use <code>listenRisk</code> to see full rejection context:</p>
<pre><code class="typescript"><span class="hl-5">import</span><span class="hl-2"> { </span><span class="hl-6">listenRisk</span><span class="hl-2"> } </span><span class="hl-5">from</span><span class="hl-2"> </span><span class="hl-4">&quot;backtest-kit&quot;</span><span class="hl-2">;</span><br/><br/><span class="hl-1">listenRisk</span><span class="hl-2">((</span><span class="hl-6">event</span><span class="hl-2">) </span><span class="hl-3">=&gt;</span><span class="hl-2"> {</span><br/><span class="hl-2">  </span><span class="hl-6">console</span><span class="hl-2">.</span><span class="hl-1">log</span><span class="hl-2">(</span><span class="hl-4">&quot;=== RISK REJECTION ===&quot;</span><span class="hl-2">);</span><br/><span class="hl-2">  </span><span class="hl-6">console</span><span class="hl-2">.</span><span class="hl-1">log</span><span class="hl-2">(</span><span class="hl-4">&quot;Symbol:&quot;</span><span class="hl-2">, </span><span class="hl-6">event</span><span class="hl-2">.</span><span class="hl-6">symbol</span><span class="hl-2">);</span><br/><span class="hl-2">  </span><span class="hl-6">console</span><span class="hl-2">.</span><span class="hl-1">log</span><span class="hl-2">(</span><span class="hl-4">&quot;Strategy:&quot;</span><span class="hl-2">, </span><span class="hl-6">event</span><span class="hl-2">.</span><span class="hl-6">strategyName</span><span class="hl-2">);</span><br/><span class="hl-2">  </span><span class="hl-6">console</span><span class="hl-2">.</span><span class="hl-1">log</span><span class="hl-2">(</span><span class="hl-4">&quot;Position:&quot;</span><span class="hl-2">, </span><span class="hl-6">event</span><span class="hl-2">.</span><span class="hl-6">pendingSignal</span><span class="hl-2">.</span><span class="hl-6">position</span><span class="hl-2">);</span><br/><span class="hl-2">  </span><span class="hl-6">console</span><span class="hl-2">.</span><span class="hl-1">log</span><span class="hl-2">(</span><span class="hl-4">&quot;Current Price:&quot;</span><span class="hl-2">, </span><span class="hl-6">event</span><span class="hl-2">.</span><span class="hl-6">currentPrice</span><span class="hl-2">);</span><br/><span class="hl-2">  </span><span class="hl-6">console</span><span class="hl-2">.</span><span class="hl-1">log</span><span class="hl-2">(</span><span class="hl-4">&quot;Active Positions:&quot;</span><span class="hl-2">, </span><span class="hl-6">event</span><span class="hl-2">.</span><span class="hl-6">activePositionCount</span><span class="hl-2">);</span><br/><span class="hl-2">  </span><span class="hl-6">console</span><span class="hl-2">.</span><span class="hl-1">log</span><span class="hl-2">(</span><span class="hl-4">&quot;Reason:&quot;</span><span class="hl-2">, </span><span class="hl-6">event</span><span class="hl-2">.</span><span class="hl-6">comment</span><span class="hl-2">);</span><br/><span class="hl-2">  </span><span class="hl-6">console</span><span class="hl-2">.</span><span class="hl-1">log</span><span class="hl-2">(</span><span class="hl-4">&quot;Timestamp:&quot;</span><span class="hl-2">, </span><span class="hl-3">new</span><span class="hl-2"> </span><span class="hl-1">Date</span><span class="hl-2">(</span><span class="hl-6">event</span><span class="hl-2">.</span><span class="hl-6">timestamp</span><span class="hl-2">).</span><span class="hl-1">toISOString</span><span class="hl-2">());</span><br/><span class="hl-2">  </span><span class="hl-6">console</span><span class="hl-2">.</span><span class="hl-1">log</span><span class="hl-2">(</span><span class="hl-4">&quot;======================&quot;</span><span class="hl-2">);</span><br/><span class="hl-2">});</span>
</code><button type="button">Copy</button></pre>

<a id="add-diagnostic-notes" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Add Diagnostic Notes<a href="#add-diagnostic-notes" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Include rich error messages with context:</p>
<pre><code class="typescript"><span class="hl-2">{</span><br/><span class="hl-2">  </span><span class="hl-10">validate</span><span class="hl-2">: ({ </span><span class="hl-6">pendingSignal</span><span class="hl-2">, </span><span class="hl-6">currentPrice</span><span class="hl-2">, </span><span class="hl-6">activePositionCount</span><span class="hl-2"> }) </span><span class="hl-3">=&gt;</span><span class="hl-2"> {</span><br/><span class="hl-2">    </span><span class="hl-5">if</span><span class="hl-2"> (</span><span class="hl-6">activePositionCount</span><span class="hl-2"> &gt;= </span><span class="hl-7">5</span><span class="hl-2">) {</span><br/><span class="hl-2">      </span><span class="hl-5">throw</span><span class="hl-2"> </span><span class="hl-3">new</span><span class="hl-2"> </span><span class="hl-1">Error</span><span class="hl-2">(</span><br/><span class="hl-2">        </span><span class="hl-4">`Position limit exceeded:</span><span class="hl-13">\n</span><span class="hl-4">`</span><span class="hl-2"> +</span><br/><span class="hl-2">        </span><span class="hl-4">`  Active: </span><span class="hl-3">${</span><span class="hl-6">activePositionCount</span><span class="hl-3">}</span><span class="hl-13">\n</span><span class="hl-4">`</span><span class="hl-2"> +</span><br/><span class="hl-2">        </span><span class="hl-4">`  Limit: 5</span><span class="hl-13">\n</span><span class="hl-4">`</span><span class="hl-2"> +</span><br/><span class="hl-2">        </span><span class="hl-4">`  Signal: </span><span class="hl-3">${</span><span class="hl-6">pendingSignal</span><span class="hl-9">.</span><span class="hl-6">position</span><span class="hl-3">}</span><span class="hl-4"> on </span><span class="hl-3">${</span><span class="hl-6">pendingSignal</span><span class="hl-9">.</span><span class="hl-6">symbol</span><span class="hl-3">}</span><span class="hl-13">\n</span><span class="hl-4">`</span><span class="hl-2"> +</span><br/><span class="hl-2">        </span><span class="hl-4">`  Price: </span><span class="hl-3">${</span><span class="hl-6">currentPrice</span><span class="hl-3">}</span><span class="hl-4">`</span><br/><span class="hl-2">      );</span><br/><span class="hl-2">    }</span><br/><span class="hl-2">  },</span><br/><span class="hl-2">  </span><span class="hl-10">note</span><span class="hl-2">: </span><span class="hl-4">&quot;Portfolio position limit (5 max)&quot;</span><br/><span class="hl-2">}</span>
</code><button type="button">Copy</button></pre>

<hr>
<a id="validation-vs-callbacks" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Validation vs Callbacks<a href="#validation-vs-callbacks" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p><strong>Risk Validations</strong> and <strong>Strategy Callbacks</strong> serve different purposes:</p>
<table>
<thead>
<tr>
<th>Aspect</th>
<th>Risk Validations</th>
<th>Strategy Callbacks</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Purpose</strong></td>
<td>Gate-keep signal opening</td>
<td>React to lifecycle events</td>
</tr>
<tr>
<td><strong>Timing</strong></td>
<td><strong>Before</strong> position opens</td>
<td><strong>After</strong> state changes</td>
</tr>
<tr>
<td><strong>Control</strong></td>
<td>Can <strong>block</strong> signals (throw)</td>
<td>Cannot block (informational)</td>
</tr>
<tr>
<td><strong>Scope</strong></td>
<td>Portfolio-level (cross-strategy)</td>
<td>Strategy-level (single strategy)</td>
</tr>
<tr>
<td><strong>Return</strong></td>
<td><code>void</code> or <code>throw</code></td>
<td><code>void</code> (no effect on flow)</td>
</tr>
<tr>
<td><strong>Examples</strong></td>
<td>Position limits, R/R checks</td>
<td>Logging, notifications, analytics</td>
</tr>
</tbody>
</table>
<p><strong>When to Use</strong>:</p>
<ul>
<li><strong>Validations</strong>: Enforce business rules that prevent unsafe trades</li>
<li><strong>Callbacks</strong>: Observe and react to events without affecting execution</li>
</ul>
<hr>
<a id="sources" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Sources<a href="#sources" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>This document was informed by the following source files:</p>
<ul>
<li><a href="">types.d.ts:343-426</a> - Core risk interfaces (<code>IRiskCheckArgs</code>, <code>IRiskValidationPayload</code>, <code>IRiskValidation</code>, <code>IRiskSchema</code>)</li>
<li><a href="">README.md:83-100</a> - Basic risk validation examples</li>
<li><a href="">src/client/ClientStrategy.ts:376-387</a> - Risk validation integration in strategy execution</li>
<li><a href="">src/function/event.ts:896-927</a> - Risk rejection event handling (<code>listenRisk</code>, <code>listenRiskOnce</code>)</li>
<li><a href="">test/e2e/defend.test.mjs</a> - Comprehensive validation test cases and edge cases</li>
<li><a href="">src/config/emitters.ts:127-131</a> - <code>riskSubject</code> emitter definition</li>
</ul>
</div></div><div class="col-sidebar"><div class="page-menu"><div class="tsd-navigation settings"><details class="tsd-accordion"><summary class="tsd-accordion-summary"><h3><svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-chevronDown"></use></svg>Settings</h3></summary><div class="tsd-accordion-details"><div class="tsd-filter-visibility"><span class="settings-label">Member Visibility</span><ul id="tsd-filter-options"><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-protected" name="protected"/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Protected</span></label></li><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-inherited" name="inherited" checked/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Inherited</span></label></li><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-external" name="external"/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>External</span></label></li></ul></div><div class="tsd-theme-toggle"><label class="settings-label" for="tsd-theme">Theme</label><select id="tsd-theme"><option value="os">OS</option><option value="light">Light</option><option value="dark">Dark</option></select></div></div></details></div><details open class="tsd-accordion tsd-page-navigation"><summary class="tsd-accordion-summary"><h3><svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-chevronDown"></use></svg>On This Page</h3></summary><div class="tsd-accordion-details"><a href="#custom-risk-validations"><span>Custom <wbr/>Risk <wbr/>Validations</span></a><ul><li><a href="#purpose-and-scope"><span>Purpose and <wbr/>Scope</span></a></li><li><a href="#risk-validation-architecture"><span>Risk <wbr/>Validation <wbr/>Architecture</span></a></li><li><a href="#iriskvalidation-interface"><span>IRisk<wbr/>Validation <wbr/>Interface</span></a></li><li><ul><li><a href="#core-structure"><span>Core <wbr/>Structure</span></a></li></ul></li><li><a href="#iriskvalidationpayload-structure"><span>IRisk<wbr/>Validation<wbr/>Payload <wbr/>Structure</span></a></li><li><ul><li><a href="#payload-properties"><span>Payload <wbr/>Properties</span></a></li><li><ul><li><a href="#from-iriskcheckargs-base-context"><span>From IRisk<wbr/>Check<wbr/>Args (<wbr/>Base <wbr/>Context)</span></a></li><li><a href="#portfolio-state-extensions"><span>Portfolio <wbr/>State <wbr/>Extensions</span></a></li><li><a href="#iriskactiveposition-structure"><span>IRisk<wbr/>Active<wbr/>Position <wbr/>Structure</span></a></li></ul></li></ul></li><li><a href="#validation-function-registration"><span>Validation <wbr/>Function <wbr/>Registration</span></a></li><li><ul><li><a href="#short-form-function-only"><span>Short <wbr/>Form (<wbr/>Function <wbr/>Only)</span></a></li><li><a href="#long-form-iriskvalidation-object"><span>Long <wbr/>Form (IRisk<wbr/>Validation <wbr/>Object)</span></a></li></ul></li><li><a href="#common-validation-patterns"><span>Common <wbr/>Validation <wbr/>Patterns</span></a></li><li><ul><li><a href="#pattern-1-position-count-limits"><span>Pattern 1: <wbr/>Position <wbr/>Count <wbr/>Limits</span></a></li><li><a href="#pattern-2-riskreward-ratio-enforcement"><span>Pattern 2: <wbr/>Risk/<wbr/>Reward <wbr/>Ratio <wbr/>Enforcement</span></a></li><li><a href="#pattern-3-minimum-take-profit-distance"><span>Pattern 3: <wbr/>Minimum <wbr/>Take <wbr/>Profit <wbr/>Distance</span></a></li><li><a href="#pattern-4-symbol-specific-position-limits"><span>Pattern 4: <wbr/>Symbol-<wbr/>Specific <wbr/>Position <wbr/>Limits</span></a></li><li><a href="#pattern-5-strategy-diversification"><span>Pattern 5: <wbr/>Strategy <wbr/>Diversification</span></a></li><li><a href="#pattern-6-position-direction-hedging"><span>Pattern 6: <wbr/>Position <wbr/>Direction <wbr/>Hedging</span></a></li></ul></li><li><a href="#validation-execution-sequence"><span>Validation <wbr/>Execution <wbr/>Sequence</span></a></li><li><a href="#error-handling-and-rejection-events"><span>Error <wbr/>Handling and <wbr/>Rejection <wbr/>Events</span></a></li><li><ul><li><a href="#throwing-errors"><span>Throwing <wbr/>Errors</span></a></li><li><a href="#listening-to-rejection-events"><span>Listening to <wbr/>Rejection <wbr/>Events</span></a></li></ul></li><li><a href="#async-validations"><span>Async <wbr/>Validations</span></a></li><li><a href="#integration-with-position-lifecycle"><span>Integration with <wbr/>Position <wbr/>Lifecycle</span></a></li><li><a href="#testing-custom-validations"><span>Testing <wbr/>Custom <wbr/>Validations</span></a></li><li><ul><li><a href="#unit-testing-validation-logic"><span>Unit <wbr/>Testing <wbr/>Validation <wbr/>Logic</span></a></li><li><a href="#integration-testing-with-backtest"><span>Integration <wbr/>Testing with <wbr/>Backtest</span></a></li></ul></li><li><a href="#advanced-validation-examples"><span>Advanced <wbr/>Validation <wbr/>Examples</span></a></li><li><ul><li><a href="#time-based-trading-windows"><span>Time-<wbr/>Based <wbr/>Trading <wbr/>Windows</span></a></li><li><a href="#correlation-based-position-limits"><span>Correlation-<wbr/>Based <wbr/>Position <wbr/>Limits</span></a></li><li><a href="#dynamic-stop-loss-validation"><span>Dynamic <wbr/>Stop <wbr/>Loss <wbr/>Validation</span></a></li><li><a href="#cross-strategy-position-balance"><span>Cross-<wbr/>Strategy <wbr/>Position <wbr/>Balance</span></a></li></ul></li><li><a href="#multi-risk-profile-pattern"><span>Multi-<wbr/>Risk <wbr/>Profile <wbr/>Pattern</span></a></li><li><a href="#performance-considerations"><span>Performance <wbr/>Considerations</span></a></li><li><ul><li><a href="#validation-execution-cost"><span>Validation <wbr/>Execution <wbr/>Cost</span></a></li><li><a href="#validation-ordering"><span>Validation <wbr/>Ordering</span></a></li></ul></li><li><a href="#validation-state-and-memoization"><span>Validation <wbr/>State and <wbr/>Memoization</span></a></li><li><a href="#debugging-validation-failures"><span>Debugging <wbr/>Validation <wbr/>Failures</span></a></li><li><ul><li><a href="#enable-validation-logging"><span>Enable <wbr/>Validation <wbr/>Logging</span></a></li><li><a href="#inspect-rejection-context"><span>Inspect <wbr/>Rejection <wbr/>Context</span></a></li><li><a href="#add-diagnostic-notes"><span>Add <wbr/>Diagnostic <wbr/>Notes</span></a></li></ul></li><li><a href="#validation-vs-callbacks"><span>Validation vs <wbr/>Callbacks</span></a></li><li><a href="#sources"><span>Sources</span></a></li></ul></div></details></div><div class="site-menu"><nav class="tsd-navigation"><a href="../modules.html">backtest-kit</a><ul class="tsd-small-nested-navigation" id="tsd-nav-container"><li>Loading...</li></ul></nav></div></div></div><footer><p class="tsd-generator">Generated using <a href="https://typedoc.org/" target="_blank">TypeDoc</a></p></footer><div class="overlay"></div></body></html>

<!-- Yandex.Metrika counter -->
<script type="text/javascript">
    (function(m,e,t,r,i,k,a){
        m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
        m[i].l=1*new Date();
        for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }}
        k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)
    })(window, document,'script','https://mc.yandex.ru/metrika/tag.js?id=105455585', 'ym');

    ym(105455585, 'init', {ssr:true, webvisor:true, clickmap:true, ecommerce:"dataLayer", accurateTrackBounce:true, trackLinks:true});
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/105455585" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
<!-- /Yandex.Metrika counter -->

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-3MQZEBBDDR"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-3MQZEBBDDR');
</script>
